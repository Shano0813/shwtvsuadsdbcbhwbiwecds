<!DOCTYPE html>
<!-- saved from url=(0042)https://ziyong.netlify.app/borderless.html -->
<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/CMZqNMRh/IMG-6497.jpg">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>EPhone</title>
    <script>/*
 * Dexie.js - a minimalistic wrapper for IndexedDB
 * ===============================================
 *
 * By David Fahlander, david.fahlander@gmail.com
 *
 * Version 4.0.11, Wed Jan 15 2025
 *
 * https://dexie.org
 *
 * Apache License Version 2.0, January 2004, http://www.apache.org/licenses/
 */
 
(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
    typeof define === 'function' && define.amd ? define(factory) :
    (global = typeof globalThis !== 'undefined' ? globalThis : global || self, global.Dexie = factory());
})(this, (function () { 'use strict';

    /*! *****************************************************************************
    Copyright (c) Microsoft Corporation.
    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.
    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */
    var extendStatics = function(d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    function __extends(d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    }
    var __assign = function() {
        __assign = Object.assign || function __assign(t) {
            for (var s, i = 1, n = arguments.length; i < n; i++) {
                s = arguments[i];
                for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];
            }
            return t;
        };
        return __assign.apply(this, arguments);
    };
    function __spreadArray(to, from, pack) {
        if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
            if (ar || !(i in from)) {
                if (!ar) ar = Array.prototype.slice.call(from, 0, i);
                ar[i] = from[i];
            }
        }
        return to.concat(ar || Array.prototype.slice.call(from));
    }

    var _global = typeof globalThis !== 'undefined' ? globalThis :
        typeof self !== 'undefined' ? self :
            typeof window !== 'undefined' ? window :
                global;

    var keys = Object.keys;
    var isArray = Array.isArray;
    if (typeof Promise !== 'undefined' && !_global.Promise) {
        _global.Promise = Promise;
    }
    function extend(obj, extension) {
        if (typeof extension !== 'object')
            return obj;
        keys(extension).forEach(function (key) {
            obj[key] = extension[key];
        });
        return obj;
    }
    var getProto = Object.getPrototypeOf;
    var _hasOwn = {}.hasOwnProperty;
    function hasOwn(obj, prop) {
        return _hasOwn.call(obj, prop);
    }
    function props(proto, extension) {
        if (typeof extension === 'function')
            extension = extension(getProto(proto));
        (typeof Reflect === "undefined" ? keys : Reflect.ownKeys)(extension).forEach(function (key) {
            setProp(proto, key, extension[key]);
        });
    }
    var defineProperty = Object.defineProperty;
    function setProp(obj, prop, functionOrGetSet, options) {
        defineProperty(obj, prop, extend(functionOrGetSet && hasOwn(functionOrGetSet, "get") && typeof functionOrGetSet.get === 'function' ?
            { get: functionOrGetSet.get, set: functionOrGetSet.set, configurable: true } :
            { value: functionOrGetSet, configurable: true, writable: true }, options));
    }
    function derive(Child) {
        return {
            from: function (Parent) {
                Child.prototype = Object.create(Parent.prototype);
                setProp(Child.prototype, "constructor", Child);
                return {
                    extend: props.bind(null, Child.prototype)
                };
            }
        };
    }
    var getOwnPropertyDescriptor = Object.getOwnPropertyDescriptor;
    function getPropertyDescriptor(obj, prop) {
        var pd = getOwnPropertyDescriptor(obj, prop);
        var proto;
        return pd || (proto = getProto(obj)) && getPropertyDescriptor(proto, prop);
    }
    var _slice = [].slice;
    function slice(args, start, end) {
        return _slice.call(args, start, end);
    }
    function override(origFunc, overridedFactory) {
        return overridedFactory(origFunc);
    }
    function assert(b) {
        if (!b)
            throw new Error("Assertion Failed");
    }
    function asap$1(fn) {
        if (_global.setImmediate)
            setImmediate(fn);
        else
            setTimeout(fn, 0);
    }
    function arrayToObject(array, extractor) {
        return array.reduce(function (result, item, i) {
            var nameAndValue = extractor(item, i);
            if (nameAndValue)
                result[nameAndValue[0]] = nameAndValue[1];
            return result;
        }, {});
    }
    function getByKeyPath(obj, keyPath) {
        if (typeof keyPath === 'string' && hasOwn(obj, keyPath))
            return obj[keyPath];
        if (!keyPath)
            return obj;
        if (typeof keyPath !== 'string') {
            var rv = [];
            for (var i = 0, l = keyPath.length; i < l; ++i) {
                var val = getByKeyPath(obj, keyPath[i]);
                rv.push(val);
            }
            return rv;
        }
        var period = keyPath.indexOf('.');
        if (period !== -1) {
            var innerObj = obj[keyPath.substr(0, period)];
            return innerObj == null ? undefined : getByKeyPath(innerObj, keyPath.substr(period + 1));
        }
        return undefined;
    }
    function setByKeyPath(obj, keyPath, value) {
        if (!obj || keyPath === undefined)
            return;
        if ('isFrozen' in Object && Object.isFrozen(obj))
            return;
        if (typeof keyPath !== 'string' && 'length' in keyPath) {
            assert(typeof value !== 'string' && 'length' in value);
            for (var i = 0, l = keyPath.length; i < l; ++i) {
                setByKeyPath(obj, keyPath[i], value[i]);
            }
        }
        else {
            var period = keyPath.indexOf('.');
            if (period !== -1) {
                var currentKeyPath = keyPath.substr(0, period);
                var remainingKeyPath = keyPath.substr(period + 1);
                if (remainingKeyPath === "")
                    if (value === undefined) {
                        if (isArray(obj) && !isNaN(parseInt(currentKeyPath)))
                            obj.splice(currentKeyPath, 1);
                        else
                            delete obj[currentKeyPath];
                    }
                    else
                        obj[currentKeyPath] = value;
                else {
                    var innerObj = obj[currentKeyPath];
                    if (!innerObj || !hasOwn(obj, currentKeyPath))
                        innerObj = (obj[currentKeyPath] = {});
                    setByKeyPath(innerObj, remainingKeyPath, value);
                }
            }
            else {
                if (value === undefined) {
                    if (isArray(obj) && !isNaN(parseInt(keyPath)))
                        obj.splice(keyPath, 1);
                    else
                        delete obj[keyPath];
                }
                else
                    obj[keyPath] = value;
            }
        }
    }
    function delByKeyPath(obj, keyPath) {
        if (typeof keyPath === 'string')
            setByKeyPath(obj, keyPath, undefined);
        else if ('length' in keyPath)
            [].map.call(keyPath, function (kp) {
                setByKeyPath(obj, kp, undefined);
            });
    }
    function shallowClone(obj) {
        var rv = {};
        for (var m in obj) {
            if (hasOwn(obj, m))
                rv[m] = obj[m];
        }
        return rv;
    }
    var concat = [].concat;
    function flatten(a) {
        return concat.apply([], a);
    }
    var intrinsicTypeNames = "BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey"
        .split(',').concat(flatten([8, 16, 32, 64].map(function (num) { return ["Int", "Uint", "Float"].map(function (t) { return t + num + "Array"; }); }))).filter(function (t) { return _global[t]; });
    var intrinsicTypes = new Set(intrinsicTypeNames.map(function (t) { return _global[t]; }));
    function cloneSimpleObjectTree(o) {
        var rv = {};
        for (var k in o)
            if (hasOwn(o, k)) {
                var v = o[k];
                rv[k] = !v || typeof v !== 'object' || intrinsicTypes.has(v.constructor) ? v : cloneSimpleObjectTree(v);
            }
        return rv;
    }
    function objectIsEmpty(o) {
        for (var k in o)
            if (hasOwn(o, k))
                return false;
        return true;
    }
    var circularRefs = null;
    function deepClone(any) {
        circularRefs = new WeakMap();
        var rv = innerDeepClone(any);
        circularRefs = null;
        return rv;
    }
    function innerDeepClone(x) {
        if (!x || typeof x !== 'object')
            return x;
        var rv = circularRefs.get(x);
        if (rv)
            return rv;
        if (isArray(x)) {
            rv = [];
            circularRefs.set(x, rv);
            for (var i = 0, l = x.length; i < l; ++i) {
                rv.push(innerDeepClone(x[i]));
            }
        }
        else if (intrinsicTypes.has(x.constructor)) {
            rv = x;
        }
        else {
            var proto = getProto(x);
            rv = proto === Object.prototype ? {} : Object.create(proto);
            circularRefs.set(x, rv);
            for (var prop in x) {
                if (hasOwn(x, prop)) {
                    rv[prop] = innerDeepClone(x[prop]);
                }
            }
        }
        return rv;
    }
    var toString = {}.toString;
    function toStringTag(o) {
        return toString.call(o).slice(8, -1);
    }
    var iteratorSymbol = typeof Symbol !== 'undefined' ?
        Symbol.iterator :
        '@@iterator';
    var getIteratorOf = typeof iteratorSymbol === "symbol" ? function (x) {
        var i;
        return x != null && (i = x[iteratorSymbol]) && i.apply(x);
    } : function () { return null; };
    function delArrayItem(a, x) {
        var i = a.indexOf(x);
        if (i >= 0)
            a.splice(i, 1);
        return i >= 0;
    }
    var NO_CHAR_ARRAY = {};
    function getArrayOf(arrayLike) {
        var i, a, x, it;
        if (arguments.length === 1) {
            if (isArray(arrayLike))
                return arrayLike.slice();
            if (this === NO_CHAR_ARRAY && typeof arrayLike === 'string')
                return [arrayLike];
            if ((it = getIteratorOf(arrayLike))) {
                a = [];
                while ((x = it.next()), !x.done)
                    a.push(x.value);
                return a;
            }
            if (arrayLike == null)
                return [arrayLike];
            i = arrayLike.length;
            if (typeof i === 'number') {
                a = new Array(i);
                while (i--)
                    a[i] = arrayLike[i];
                return a;
            }
            return [arrayLike];
        }
        i = arguments.length;
        a = new Array(i);
        while (i--)
            a[i] = arguments[i];
        return a;
    }
    var isAsyncFunction = typeof Symbol !== 'undefined'
        ? function (fn) { return fn[Symbol.toStringTag] === 'AsyncFunction'; }
        : function () { return false; };

    var dexieErrorNames = [
        'Modify',
        'Bulk',
        'OpenFailed',
        'VersionChange',
        'Schema',
        'Upgrade',
        'InvalidTable',
        'MissingAPI',
        'NoSuchDatabase',
        'InvalidArgument',
        'SubTransaction',
        'Unsupported',
        'Internal',
        'DatabaseClosed',
        'PrematureCommit',
        'ForeignAwait'
    ];
    var idbDomErrorNames = [
        'Unknown',
        'Constraint',
        'Data',
        'TransactionInactive',
        'ReadOnly',
        'Version',
        'NotFound',
        'InvalidState',
        'InvalidAccess',
        'Abort',
        'Timeout',
        'QuotaExceeded',
        'Syntax',
        'DataClone'
    ];
    var errorList = dexieErrorNames.concat(idbDomErrorNames);
    var defaultTexts = {
        VersionChanged: "Database version changed by other database connection",
        DatabaseClosed: "Database has been closed",
        Abort: "Transaction aborted",
        TransactionInactive: "Transaction has already completed or failed",
        MissingAPI: "IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"
    };
    function DexieError(name, msg) {
        this.name = name;
        this.message = msg;
    }
    derive(DexieError).from(Error).extend({
        toString: function () { return this.name + ": " + this.message; }
    });
    function getMultiErrorMessage(msg, failures) {
        return msg + ". Errors: " + Object.keys(failures)
            .map(function (key) { return failures[key].toString(); })
            .filter(function (v, i, s) { return s.indexOf(v) === i; })
            .join('\n');
    }
    function ModifyError(msg, failures, successCount, failedKeys) {
        this.failures = failures;
        this.failedKeys = failedKeys;
        this.successCount = successCount;
        this.message = getMultiErrorMessage(msg, failures);
    }
    derive(ModifyError).from(DexieError);
    function BulkError(msg, failures) {
        this.name = "BulkError";
        this.failures = Object.keys(failures).map(function (pos) { return failures[pos]; });
        this.failuresByPos = failures;
        this.message = getMultiErrorMessage(msg, this.failures);
    }
    derive(BulkError).from(DexieError);
    var errnames = errorList.reduce(function (obj, name) { return (obj[name] = name + "Error", obj); }, {});
    var BaseException = DexieError;
    var exceptions = errorList.reduce(function (obj, name) {
        var fullName = name + "Error";
        function DexieError(msgOrInner, inner) {
            this.name = fullName;
            if (!msgOrInner) {
                this.message = defaultTexts[name] || fullName;
                this.inner = null;
            }
            else if (typeof msgOrInner === 'string') {
                this.message = "".concat(msgOrInner).concat(!inner ? '' : '\n ' + inner);
                this.inner = inner || null;
            }
            else if (typeof msgOrInner === 'object') {
                this.message = "".concat(msgOrInner.name, " ").concat(msgOrInner.message);
                this.inner = msgOrInner;
            }
        }
        derive(DexieError).from(BaseException);
        obj[name] = DexieError;
        return obj;
    }, {});
    exceptions.Syntax = SyntaxError;
    exceptions.Type = TypeError;
    exceptions.Range = RangeError;
    var exceptionMap = idbDomErrorNames.reduce(function (obj, name) {
        obj[name + "Error"] = exceptions[name];
        return obj;
    }, {});
    function mapError(domError, message) {
        if (!domError || domError instanceof DexieError || domError instanceof TypeError || domError instanceof SyntaxError || !domError.name || !exceptionMap[domError.name])
            return domError;
        var rv = new exceptionMap[domError.name](message || domError.message, domError);
        if ("stack" in domError) {
            setProp(rv, "stack", { get: function () {
                    return this.inner.stack;
                } });
        }
        return rv;
    }
    var fullNameExceptions = errorList.reduce(function (obj, name) {
        if (["Syntax", "Type", "Range"].indexOf(name) === -1)
            obj[name + "Error"] = exceptions[name];
        return obj;
    }, {});
    fullNameExceptions.ModifyError = ModifyError;
    fullNameExceptions.DexieError = DexieError;
    fullNameExceptions.BulkError = BulkError;

    function nop() { }
    function mirror(val) { return val; }
    function pureFunctionChain(f1, f2) {
        if (f1 == null || f1 === mirror)
            return f2;
        return function (val) {
            return f2(f1(val));
        };
    }
    function callBoth(on1, on2) {
        return function () {
            on1.apply(this, arguments);
            on2.apply(this, arguments);
        };
    }
    function hookCreatingChain(f1, f2) {
        if (f1 === nop)
            return f2;
        return function () {
            var res = f1.apply(this, arguments);
            if (res !== undefined)
                arguments[0] = res;
            var onsuccess = this.onsuccess,
            onerror = this.onerror;
            this.onsuccess = null;
            this.onerror = null;
            var res2 = f2.apply(this, arguments);
            if (onsuccess)
                this.onsuccess = this.onsuccess ? callBoth(onsuccess, this.onsuccess) : onsuccess;
            if (onerror)
                this.onerror = this.onerror ? callBoth(onerror, this.onerror) : onerror;
            return res2 !== undefined ? res2 : res;
        };
    }
    function hookDeletingChain(f1, f2) {
        if (f1 === nop)
            return f2;
        return function () {
            f1.apply(this, arguments);
            var onsuccess = this.onsuccess,
            onerror = this.onerror;
            this.onsuccess = this.onerror = null;
            f2.apply(this, arguments);
            if (onsuccess)
                this.onsuccess = this.onsuccess ? callBoth(onsuccess, this.onsuccess) : onsuccess;
            if (onerror)
                this.onerror = this.onerror ? callBoth(onerror, this.onerror) : onerror;
        };
    }
    function hookUpdatingChain(f1, f2) {
        if (f1 === nop)
            return f2;
        return function (modifications) {
            var res = f1.apply(this, arguments);
            extend(modifications, res);
            var onsuccess = this.onsuccess,
            onerror = this.onerror;
            this.onsuccess = null;
            this.onerror = null;
            var res2 = f2.apply(this, arguments);
            if (onsuccess)
                this.onsuccess = this.onsuccess ? callBoth(onsuccess, this.onsuccess) : onsuccess;
            if (onerror)
                this.onerror = this.onerror ? callBoth(onerror, this.onerror) : onerror;
            return res === undefined ?
                (res2 === undefined ? undefined : res2) :
                (extend(res, res2));
        };
    }
    function reverseStoppableEventChain(f1, f2) {
        if (f1 === nop)
            return f2;
        return function () {
            if (f2.apply(this, arguments) === false)
                return false;
            return f1.apply(this, arguments);
        };
    }
    function promisableChain(f1, f2) {
        if (f1 === nop)
            return f2;
        return function () {
            var res = f1.apply(this, arguments);
            if (res && typeof res.then === 'function') {
                var thiz = this, i = arguments.length, args = new Array(i);
                while (i--)
                    args[i] = arguments[i];
                return res.then(function () {
                    return f2.apply(thiz, args);
                });
            }
            return f2.apply(this, arguments);
        };
    }

    var debug = typeof location !== 'undefined' &&
        /^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);
    function setDebug(value, filter) {
        debug = value;
    }

    var INTERNAL = {};
    var ZONE_ECHO_LIMIT = 100, _a$1 = typeof Promise === 'undefined' ?
        [] :
        (function () {
            var globalP = Promise.resolve();
            if (typeof crypto === 'undefined' || !crypto.subtle)
                return [globalP, getProto(globalP), globalP];
            var nativeP = crypto.subtle.digest("SHA-512", new Uint8Array([0]));
            return [
                nativeP,
                getProto(nativeP),
                globalP
            ];
        })(), resolvedNativePromise = _a$1[0], nativePromiseProto = _a$1[1], resolvedGlobalPromise = _a$1[2], nativePromiseThen = nativePromiseProto && nativePromiseProto.then;
    var NativePromise = resolvedNativePromise && resolvedNativePromise.constructor;
    var patchGlobalPromise = !!resolvedGlobalPromise;
    function schedulePhysicalTick() {
        queueMicrotask(physicalTick);
    }
    var asap = function (callback, args) {
        microtickQueue.push([callback, args]);
        if (needsNewPhysicalTick) {
            schedulePhysicalTick();
            needsNewPhysicalTick = false;
        }
    };
    var isOutsideMicroTick = true,
    needsNewPhysicalTick = true,
    unhandledErrors = [],
    rejectingErrors = [],
    rejectionMapper = mirror;
    var globalPSD = {
        id: 'global',
        global: true,
        ref: 0,
        unhandleds: [],
        onunhandled: nop,
        pgp: false,
        env: {},
        finalize: nop
    };
    var PSD = globalPSD;
    var microtickQueue = [];
    var numScheduledCalls = 0;
    var tickFinalizers = [];
    function DexiePromise(fn) {
        if (typeof this !== 'object')
            throw new TypeError('Promises must be constructed via new');
        this._listeners = [];
        this._lib = false;
        var psd = (this._PSD = PSD);
        if (typeof fn !== 'function') {
            if (fn !== INTERNAL)
                throw new TypeError('Not a function');
            this._state = arguments[1];
            this._value = arguments[2];
            if (this._state === false)
                handleRejection(this, this._value);
            return;
        }
        this._state = null;
        this._value = null;
        ++psd.ref;
        executePromiseTask(this, fn);
    }
    var thenProp = {
        get: function () {
            var psd = PSD, microTaskId = totalEchoes;
            function then(onFulfilled, onRejected) {
                var _this = this;
                var possibleAwait = !psd.global && (psd !== PSD || microTaskId !== totalEchoes);
                var cleanup = possibleAwait && !decrementExpectedAwaits();
                var rv = new DexiePromise(function (resolve, reject) {
                    propagateToListener(_this, new Listener(nativeAwaitCompatibleWrap(onFulfilled, psd, possibleAwait, cleanup), nativeAwaitCompatibleWrap(onRejected, psd, possibleAwait, cleanup), resolve, reject, psd));
                });
                if (this._consoleTask)
                    rv._consoleTask = this._consoleTask;
                return rv;
            }
            then.prototype = INTERNAL;
            return then;
        },
        set: function (value) {
            setProp(this, 'then', value && value.prototype === INTERNAL ?
                thenProp :
                {
                    get: function () {
                        return value;
                    },
                    set: thenProp.set
                });
        }
    };
    props(DexiePromise.prototype, {
        then: thenProp,
        _then: function (onFulfilled, onRejected) {
            propagateToListener(this, new Listener(null, null, onFulfilled, onRejected, PSD));
        },
        catch: function (onRejected) {
            if (arguments.length === 1)
                return this.then(null, onRejected);
            var type = arguments[0], handler = arguments[1];
            return typeof type === 'function' ? this.then(null, function (err) {
                return err instanceof type ? handler(err) : PromiseReject(err);
            })
                : this.then(null, function (err) {
                    return err && err.name === type ? handler(err) : PromiseReject(err);
                });
        },
        finally: function (onFinally) {
            return this.then(function (value) {
                return DexiePromise.resolve(onFinally()).then(function () { return value; });
            }, function (err) {
                return DexiePromise.resolve(onFinally()).then(function () { return PromiseReject(err); });
            });
        },
        timeout: function (ms, msg) {
            var _this = this;
            return ms < Infinity ?
                new DexiePromise(function (resolve, reject) {
                    var handle = setTimeout(function () { return reject(new exceptions.Timeout(msg)); }, ms);
                    _this.then(resolve, reject).finally(clearTimeout.bind(null, handle));
                }) : this;
        }
    });
    if (typeof Symbol !== 'undefined' && Symbol.toStringTag)
        setProp(DexiePromise.prototype, Symbol.toStringTag, 'Dexie.Promise');
    globalPSD.env = snapShot();
    function Listener(onFulfilled, onRejected, resolve, reject, zone) {
        this.onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : null;
        this.onRejected = typeof onRejected === 'function' ? onRejected : null;
        this.resolve = resolve;
        this.reject = reject;
        this.psd = zone;
    }
    props(DexiePromise, {
        all: function () {
            var values = getArrayOf.apply(null, arguments)
                .map(onPossibleParallellAsync);
            return new DexiePromise(function (resolve, reject) {
                if (values.length === 0)
                    resolve([]);
                var remaining = values.length;
                values.forEach(function (a, i) { return DexiePromise.resolve(a).then(function (x) {
                    values[i] = x;
                    if (!--remaining)
                        resolve(values);
                }, reject); });
            });
        },
        resolve: function (value) {
            if (value instanceof DexiePromise)
                return value;
            if (value && typeof value.then === 'function')
                return new DexiePromise(function (resolve, reject) {
                    value.then(resolve, reject);
                });
            var rv = new DexiePromise(INTERNAL, true, value);
            return rv;
        },
        reject: PromiseReject,
        race: function () {
            var values = getArrayOf.apply(null, arguments).map(onPossibleParallellAsync);
            return new DexiePromise(function (resolve, reject) {
                values.map(function (value) { return DexiePromise.resolve(value).then(resolve, reject); });
            });
        },
        PSD: {
            get: function () { return PSD; },
            set: function (value) { return PSD = value; }
        },
        totalEchoes: { get: function () { return totalEchoes; } },
        newPSD: newScope,
        usePSD: usePSD,
        scheduler: {
            get: function () { return asap; },
            set: function (value) { asap = value; }
        },
        rejectionMapper: {
            get: function () { return rejectionMapper; },
            set: function (value) { rejectionMapper = value; }
        },
        follow: function (fn, zoneProps) {
            return new DexiePromise(function (resolve, reject) {
                return newScope(function (resolve, reject) {
                    var psd = PSD;
                    psd.unhandleds = [];
                    psd.onunhandled = reject;
                    psd.finalize = callBoth(function () {
                        var _this = this;
                        run_at_end_of_this_or_next_physical_tick(function () {
                            _this.unhandleds.length === 0 ? resolve() : reject(_this.unhandleds[0]);
                        });
                    }, psd.finalize);
                    fn();
                }, zoneProps, resolve, reject);
            });
        }
    });
    if (NativePromise) {
        if (NativePromise.allSettled)
            setProp(DexiePromise, "allSettled", function () {
                var possiblePromises = getArrayOf.apply(null, arguments).map(onPossibleParallellAsync);
                return new DexiePromise(function (resolve) {
                    if (possiblePromises.length === 0)
                        resolve([]);
                    var remaining = possiblePromises.length;
                    var results = new Array(remaining);
                    possiblePromises.forEach(function (p, i) { return DexiePromise.resolve(p).then(function (value) { return results[i] = { status: "fulfilled", value: value }; }, function (reason) { return results[i] = { status: "rejected", reason: reason }; })
                        .then(function () { return --remaining || resolve(results); }); });
                });
            });
        if (NativePromise.any && typeof AggregateError !== 'undefined')
            setProp(DexiePromise, "any", function () {
                var possiblePromises = getArrayOf.apply(null, arguments).map(onPossibleParallellAsync);
                return new DexiePromise(function (resolve, reject) {
                    if (possiblePromises.length === 0)
                        reject(new AggregateError([]));
                    var remaining = possiblePromises.length;
                    var failures = new Array(remaining);
                    possiblePromises.forEach(function (p, i) { return DexiePromise.resolve(p).then(function (value) { return resolve(value); }, function (failure) {
                        failures[i] = failure;
                        if (!--remaining)
                            reject(new AggregateError(failures));
                    }); });
                });
            });
        if (NativePromise.withResolvers)
            DexiePromise.withResolvers = NativePromise.withResolvers;
    }
    function executePromiseTask(promise, fn) {
        try {
            fn(function (value) {
                if (promise._state !== null)
                    return;
                if (value === promise)
                    throw new TypeError('A promise cannot be resolved with itself.');
                var shouldExecuteTick = promise._lib && beginMicroTickScope();
                if (value && typeof value.then === 'function') {
                    executePromiseTask(promise, function (resolve, reject) {
                        value instanceof DexiePromise ?
                            value._then(resolve, reject) :
                            value.then(resolve, reject);
                    });
                }
                else {
                    promise._state = true;
                    promise._value = value;
                    propagateAllListeners(promise);
                }
                if (shouldExecuteTick)
                    endMicroTickScope();
            }, handleRejection.bind(null, promise));
        }
        catch (ex) {
            handleRejection(promise, ex);
        }
    }
    function handleRejection(promise, reason) {
        rejectingErrors.push(reason);
        if (promise._state !== null)
            return;
        var shouldExecuteTick = promise._lib && beginMicroTickScope();
        reason = rejectionMapper(reason);
        promise._state = false;
        promise._value = reason;
        addPossiblyUnhandledError(promise);
        propagateAllListeners(promise);
        if (shouldExecuteTick)
            endMicroTickScope();
    }
    function propagateAllListeners(promise) {
        var listeners = promise._listeners;
        promise._listeners = [];
        for (var i = 0, len = listeners.length; i < len; ++i) {
            propagateToListener(promise, listeners[i]);
        }
        var psd = promise._PSD;
        --psd.ref || psd.finalize();
        if (numScheduledCalls === 0) {
            ++numScheduledCalls;
            asap(function () {
                if (--numScheduledCalls === 0)
                    finalizePhysicalTick();
            }, []);
        }
    }
    function propagateToListener(promise, listener) {
        if (promise._state === null) {
            promise._listeners.push(listener);
            return;
        }
        var cb = promise._state ? listener.onFulfilled : listener.onRejected;
        if (cb === null) {
            return (promise._state ? listener.resolve : listener.reject)(promise._value);
        }
        ++listener.psd.ref;
        ++numScheduledCalls;
        asap(callListener, [cb, promise, listener]);
    }
    function callListener(cb, promise, listener) {
        try {
            var ret, value = promise._value;
            if (!promise._state && rejectingErrors.length)
                rejectingErrors = [];
            ret = debug && promise._consoleTask ? promise._consoleTask.run(function () { return cb(value); }) : cb(value);
            if (!promise._state && rejectingErrors.indexOf(value) === -1) {
                markErrorAsHandled(promise);
            }
            listener.resolve(ret);
        }
        catch (e) {
            listener.reject(e);
        }
        finally {
            if (--numScheduledCalls === 0)
                finalizePhysicalTick();
            --listener.psd.ref || listener.psd.finalize();
        }
    }
    function physicalTick() {
        usePSD(globalPSD, function () {
            beginMicroTickScope() && endMicroTickScope();
        });
    }
    function beginMicroTickScope() {
        var wasRootExec = isOutsideMicroTick;
        isOutsideMicroTick = false;
        needsNewPhysicalTick = false;
        return wasRootExec;
    }
    function endMicroTickScope() {
        var callbacks, i, l;
        do {
            while (microtickQueue.length > 0) {
                callbacks = microtickQueue;
                microtickQueue = [];
                l = callbacks.length;
                for (i = 0; i < l; ++i) {
                    var item = callbacks[i];
                    item[0].apply(null, item[1]);
                }
            }
        } while (microtickQueue.length > 0);
        isOutsideMicroTick = true;
        needsNewPhysicalTick = true;
    }
    function finalizePhysicalTick() {
        var unhandledErrs = unhandledErrors;
        unhandledErrors = [];
        unhandledErrs.forEach(function (p) {
            p._PSD.onunhandled.call(null, p._value, p);
        });
        var finalizers = tickFinalizers.slice(0);
        var i = finalizers.length;
        while (i)
            finalizers[--i]();
    }
    function run_at_end_of_this_or_next_physical_tick(fn) {
        function finalizer() {
            fn();
            tickFinalizers.splice(tickFinalizers.indexOf(finalizer), 1);
        }
        tickFinalizers.push(finalizer);
        ++numScheduledCalls;
        asap(function () {
            if (--numScheduledCalls === 0)
                finalizePhysicalTick();
        }, []);
    }
    function addPossiblyUnhandledError(promise) {
        if (!unhandledErrors.some(function (p) { return p._value === promise._value; }))
            unhandledErrors.push(promise);
    }
    function markErrorAsHandled(promise) {
        var i = unhandledErrors.length;
        while (i)
            if (unhandledErrors[--i]._value === promise._value) {
                unhandledErrors.splice(i, 1);
                return;
            }
    }
    function PromiseReject(reason) {
        return new DexiePromise(INTERNAL, false, reason);
    }
    function wrap(fn, errorCatcher) {
        var psd = PSD;
        return function () {
            var wasRootExec = beginMicroTickScope(), outerScope = PSD;
            try {
                switchToZone(psd, true);
                return fn.apply(this, arguments);
            }
            catch (e) {
                errorCatcher && errorCatcher(e);
            }
            finally {
                switchToZone(outerScope, false);
                if (wasRootExec)
                    endMicroTickScope();
            }
        };
    }
    var task = { awaits: 0, echoes: 0, id: 0 };
    var taskCounter = 0;
    var zoneStack = [];
    var zoneEchoes = 0;
    var totalEchoes = 0;
    var zone_id_counter = 0;
    function newScope(fn, props, a1, a2) {
        var parent = PSD, psd = Object.create(parent);
        psd.parent = parent;
        psd.ref = 0;
        psd.global = false;
        psd.id = ++zone_id_counter;
        globalPSD.env;
        psd.env = patchGlobalPromise ? {
            Promise: DexiePromise,
            PromiseProp: { value: DexiePromise, configurable: true, writable: true },
            all: DexiePromise.all,
            race: DexiePromise.race,
            allSettled: DexiePromise.allSettled,
            any: DexiePromise.any,
            resolve: DexiePromise.resolve,
            reject: DexiePromise.reject,
        } : {};
        if (props)
            extend(psd, props);
        ++parent.ref;
        psd.finalize = function () {
            --this.parent.ref || this.parent.finalize();
        };
        var rv = usePSD(psd, fn, a1, a2);
        if (psd.ref === 0)
            psd.finalize();
        return rv;
    }
    function incrementExpectedAwaits() {
        if (!task.id)
            task.id = ++taskCounter;
        ++task.awaits;
        task.echoes += ZONE_ECHO_LIMIT;
        return task.id;
    }
    function decrementExpectedAwaits() {
        if (!task.awaits)
            return false;
        if (--task.awaits === 0)
            task.id = 0;
        task.echoes = task.awaits * ZONE_ECHO_LIMIT;
        return true;
    }
    if (('' + nativePromiseThen).indexOf('[native code]') === -1) {
        incrementExpectedAwaits = decrementExpectedAwaits = nop;
    }
    function onPossibleParallellAsync(possiblePromise) {
        if (task.echoes && possiblePromise && possiblePromise.constructor === NativePromise) {
            incrementExpectedAwaits();
            return possiblePromise.then(function (x) {
                decrementExpectedAwaits();
                return x;
            }, function (e) {
                decrementExpectedAwaits();
                return rejection(e);
            });
        }
        return possiblePromise;
    }
    function zoneEnterEcho(targetZone) {
        ++totalEchoes;
        if (!task.echoes || --task.echoes === 0) {
            task.echoes = task.awaits = task.id = 0;
        }
        zoneStack.push(PSD);
        switchToZone(targetZone, true);
    }
    function zoneLeaveEcho() {
        var zone = zoneStack[zoneStack.length - 1];
        zoneStack.pop();
        switchToZone(zone, false);
    }
    function switchToZone(targetZone, bEnteringZone) {
        var currentZone = PSD;
        if (bEnteringZone ? task.echoes && (!zoneEchoes++ || targetZone !== PSD) : zoneEchoes && (!--zoneEchoes || targetZone !== PSD)) {
            queueMicrotask(bEnteringZone ? zoneEnterEcho.bind(null, targetZone) : zoneLeaveEcho);
        }
        if (targetZone === PSD)
            return;
        PSD = targetZone;
        if (currentZone === globalPSD)
            globalPSD.env = snapShot();
        if (patchGlobalPromise) {
            var GlobalPromise = globalPSD.env.Promise;
            var targetEnv = targetZone.env;
            if (currentZone.global || targetZone.global) {
                Object.defineProperty(_global, 'Promise', targetEnv.PromiseProp);
                GlobalPromise.all = targetEnv.all;
                GlobalPromise.race = targetEnv.race;
                GlobalPromise.resolve = targetEnv.resolve;
                GlobalPromise.reject = targetEnv.reject;
                if (targetEnv.allSettled)
                    GlobalPromise.allSettled = targetEnv.allSettled;
                if (targetEnv.any)
                    GlobalPromise.any = targetEnv.any;
            }
        }
    }
    function snapShot() {
        var GlobalPromise = _global.Promise;
        return patchGlobalPromise ? {
            Promise: GlobalPromise,
            PromiseProp: Object.getOwnPropertyDescriptor(_global, "Promise"),
            all: GlobalPromise.all,
            race: GlobalPromise.race,
            allSettled: GlobalPromise.allSettled,
            any: GlobalPromise.any,
            resolve: GlobalPromise.resolve,
            reject: GlobalPromise.reject,
        } : {};
    }
    function usePSD(psd, fn, a1, a2, a3) {
        var outerScope = PSD;
        try {
            switchToZone(psd, true);
            return fn(a1, a2, a3);
        }
        finally {
            switchToZone(outerScope, false);
        }
    }
    function nativeAwaitCompatibleWrap(fn, zone, possibleAwait, cleanup) {
        return typeof fn !== 'function' ? fn : function () {
            var outerZone = PSD;
            if (possibleAwait)
                incrementExpectedAwaits();
            switchToZone(zone, true);
            try {
                return fn.apply(this, arguments);
            }
            finally {
                switchToZone(outerZone, false);
                if (cleanup)
                    queueMicrotask(decrementExpectedAwaits);
            }
        };
    }
    function execInGlobalContext(cb) {
        if (Promise === NativePromise && task.echoes === 0) {
            if (zoneEchoes === 0) {
                cb();
            }
            else {
                enqueueNativeMicroTask(cb);
            }
        }
        else {
            setTimeout(cb, 0);
        }
    }
    var rejection = DexiePromise.reject;

    function tempTransaction(db, mode, storeNames, fn) {
        if (!db.idbdb || (!db._state.openComplete && (!PSD.letThrough && !db._vip))) {
            if (db._state.openComplete) {
                return rejection(new exceptions.DatabaseClosed(db._state.dbOpenError));
            }
            if (!db._state.isBeingOpened) {
                if (!db._state.autoOpen)
                    return rejection(new exceptions.DatabaseClosed());
                db.open().catch(nop);
            }
            return db._state.dbReadyPromise.then(function () { return tempTransaction(db, mode, storeNames, fn); });
        }
        else {
            var trans = db._createTransaction(mode, storeNames, db._dbSchema);
            try {
                trans.create();
                db._state.PR1398_maxLoop = 3;
            }
            catch (ex) {
                if (ex.name === errnames.InvalidState && db.isOpen() && --db._state.PR1398_maxLoop > 0) {
                    console.warn('Dexie: Need to reopen db');
                    db.close({ disableAutoOpen: false });
                    return db.open().then(function () { return tempTransaction(db, mode, storeNames, fn); });
                }
                return rejection(ex);
            }
            return trans._promise(mode, function (resolve, reject) {
                return newScope(function () {
                    PSD.trans = trans;
                    return fn(resolve, reject, trans);
                });
            }).then(function (result) {
                if (mode === 'readwrite')
                    try {
                        trans.idbtrans.commit();
                    }
                    catch (_a) { }
                return mode === 'readonly' ? result : trans._completion.then(function () { return result; });
            });
        }
    }

    var DEXIE_VERSION = '4.0.11';
    var maxString = String.fromCharCode(65535);
    var minKey = -Infinity;
    var INVALID_KEY_ARGUMENT = "Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.";
    var STRING_EXPECTED = "String expected.";
    var connections = [];
    var DBNAMES_DB = '__dbnames';
    var READONLY = 'readonly';
    var READWRITE = 'readwrite';

    function combine(filter1, filter2) {
        return filter1 ?
            filter2 ?
                function () { return filter1.apply(this, arguments) && filter2.apply(this, arguments); } :
                filter1 :
            filter2;
    }

    var AnyRange = {
        type: 3 ,
        lower: -Infinity,
        lowerOpen: false,
        upper: [[]],
        upperOpen: false
    };

    function workaroundForUndefinedPrimKey(keyPath) {
        return typeof keyPath === "string" && !/\./.test(keyPath)
            ? function (obj) {
                if (obj[keyPath] === undefined && (keyPath in obj)) {
                    obj = deepClone(obj);
                    delete obj[keyPath];
                }
                return obj;
            }
            : function (obj) { return obj; };
    }

    function Entity() {
        throw exceptions.Type();
    }

    function cmp(a, b) {
        try {
            var ta = type(a);
            var tb = type(b);
            if (ta !== tb) {
                if (ta === 'Array')
                    return 1;
                if (tb === 'Array')
                    return -1;
                if (ta === 'binary')
                    return 1;
                if (tb === 'binary')
                    return -1;
                if (ta === 'string')
                    return 1;
                if (tb === 'string')
                    return -1;
                if (ta === 'Date')
                    return 1;
                if (tb !== 'Date')
                    return NaN;
                return -1;
            }
            switch (ta) {
                case 'number':
                case 'Date':
                case 'string':
                    return a > b ? 1 : a < b ? -1 : 0;
                case 'binary': {
                    return compareUint8Arrays(getUint8Array(a), getUint8Array(b));
                }
                case 'Array':
                    return compareArrays(a, b);
            }
        }
        catch (_a) { }
        return NaN;
    }
    function compareArrays(a, b) {
        var al = a.length;
        var bl = b.length;
        var l = al < bl ? al : bl;
        for (var i = 0; i < l; ++i) {
            var res = cmp(a[i], b[i]);
            if (res !== 0)
                return res;
        }
        return al === bl ? 0 : al < bl ? -1 : 1;
    }
    function compareUint8Arrays(a, b) {
        var al = a.length;
        var bl = b.length;
        var l = al < bl ? al : bl;
        for (var i = 0; i < l; ++i) {
            if (a[i] !== b[i])
                return a[i] < b[i] ? -1 : 1;
        }
        return al === bl ? 0 : al < bl ? -1 : 1;
    }
    function type(x) {
        var t = typeof x;
        if (t !== 'object')
            return t;
        if (ArrayBuffer.isView(x))
            return 'binary';
        var tsTag = toStringTag(x);
        return tsTag === 'ArrayBuffer' ? 'binary' : tsTag;
    }
    function getUint8Array(a) {
        if (a instanceof Uint8Array)
            return a;
        if (ArrayBuffer.isView(a))
            return new Uint8Array(a.buffer, a.byteOffset, a.byteLength);
        return new Uint8Array(a);
    }

    var Table =  (function () {
        function Table() {
        }
        Table.prototype._trans = function (mode, fn, writeLocked) {
            var trans = this._tx || PSD.trans;
            var tableName = this.name;
            var task = debug && typeof console !== 'undefined' && console.createTask && console.createTask("Dexie: ".concat(mode === 'readonly' ? 'read' : 'write', " ").concat(this.name));
            function checkTableInTransaction(resolve, reject, trans) {
                if (!trans.schema[tableName])
                    throw new exceptions.NotFound("Table " + tableName + " not part of transaction");
                return fn(trans.idbtrans, trans);
            }
            var wasRootExec = beginMicroTickScope();
            try {
                var p = trans && trans.db._novip === this.db._novip ?
                    trans === PSD.trans ?
                        trans._promise(mode, checkTableInTransaction, writeLocked) :
                        newScope(function () { return trans._promise(mode, checkTableInTransaction, writeLocked); }, { trans: trans, transless: PSD.transless || PSD }) :
                    tempTransaction(this.db, mode, [this.name], checkTableInTransaction);
                if (task) {
                    p._consoleTask = task;
                    p = p.catch(function (err) {
                        console.trace(err);
                        return rejection(err);
                    });
                }
                return p;
            }
            finally {
                if (wasRootExec)
                    endMicroTickScope();
            }
        };
        Table.prototype.get = function (keyOrCrit, cb) {
            var _this = this;
            if (keyOrCrit && keyOrCrit.constructor === Object)
                return this.where(keyOrCrit).first(cb);
            if (keyOrCrit == null)
                return rejection(new exceptions.Type("Invalid argument to Table.get()"));
            return this._trans('readonly', function (trans) {
                return _this.core.get({ trans: trans, key: keyOrCrit })
                    .then(function (res) { return _this.hook.reading.fire(res); });
            }).then(cb);
        };
        Table.prototype.where = function (indexOrCrit) {
            if (typeof indexOrCrit === 'string')
                return new this.db.WhereClause(this, indexOrCrit);
            if (isArray(indexOrCrit))
                return new this.db.WhereClause(this, "[".concat(indexOrCrit.join('+'), "]"));
            var keyPaths = keys(indexOrCrit);
            if (keyPaths.length === 1)
                return this
                    .where(keyPaths[0])
                    .equals(indexOrCrit[keyPaths[0]]);
            var compoundIndex = this.schema.indexes.concat(this.schema.primKey).filter(function (ix) {
                if (ix.compound &&
                    keyPaths.every(function (keyPath) { return ix.keyPath.indexOf(keyPath) >= 0; })) {
                    for (var i = 0; i < keyPaths.length; ++i) {
                        if (keyPaths.indexOf(ix.keyPath[i]) === -1)
                            return false;
                    }
                    return true;
                }
                return false;
            }).sort(function (a, b) { return a.keyPath.length - b.keyPath.length; })[0];
            if (compoundIndex && this.db._maxKey !== maxString) {
                var keyPathsInValidOrder = compoundIndex.keyPath.slice(0, keyPaths.length);
                return this
                    .where(keyPathsInValidOrder)
                    .equals(keyPathsInValidOrder.map(function (kp) { return indexOrCrit[kp]; }));
            }
            if (!compoundIndex && debug)
                console.warn("The query ".concat(JSON.stringify(indexOrCrit), " on ").concat(this.name, " would benefit from a ") +
                    "compound index [".concat(keyPaths.join('+'), "]"));
            var idxByName = this.schema.idxByName;
            function equals(a, b) {
                return cmp(a, b) === 0;
            }
            var _a = keyPaths.reduce(function (_a, keyPath) {
                var prevIndex = _a[0], prevFilterFn = _a[1];
                var index = idxByName[keyPath];
                var value = indexOrCrit[keyPath];
                return [
                    prevIndex || index,
                    prevIndex || !index ?
                        combine(prevFilterFn, index && index.multi ?
                            function (x) {
                                var prop = getByKeyPath(x, keyPath);
                                return isArray(prop) && prop.some(function (item) { return equals(value, item); });
                            } : function (x) { return equals(value, getByKeyPath(x, keyPath)); })
                        : prevFilterFn
                ];
            }, [null, null]), idx = _a[0], filterFunction = _a[1];
            return idx ?
                this.where(idx.name).equals(indexOrCrit[idx.keyPath])
                    .filter(filterFunction) :
                compoundIndex ?
                    this.filter(filterFunction) :
                    this.where(keyPaths).equals('');
        };
        Table.prototype.filter = function (filterFunction) {
            return this.toCollection().and(filterFunction);
        };
        Table.prototype.count = function (thenShortcut) {
            return this.toCollection().count(thenShortcut);
        };
        Table.prototype.offset = function (offset) {
            return this.toCollection().offset(offset);
        };
        Table.prototype.limit = function (numRows) {
            return this.toCollection().limit(numRows);
        };
        Table.prototype.each = function (callback) {
            return this.toCollection().each(callback);
        };
        Table.prototype.toArray = function (thenShortcut) {
            return this.toCollection().toArray(thenShortcut);
        };
        Table.prototype.toCollection = function () {
            return new this.db.Collection(new this.db.WhereClause(this));
        };
        Table.prototype.orderBy = function (index) {
            return new this.db.Collection(new this.db.WhereClause(this, isArray(index) ?
                "[".concat(index.join('+'), "]") :
                index));
        };
        Table.prototype.reverse = function () {
            return this.toCollection().reverse();
        };
        Table.prototype.mapToClass = function (constructor) {
            var _a = this, db = _a.db, tableName = _a.name;
            this.schema.mappedClass = constructor;
            if (constructor.prototype instanceof Entity) {
                constructor =  (function (_super) {
                    __extends(class_1, _super);
                    function class_1() {
                        return _super !== null && _super.apply(this, arguments) || this;
                    }
                    Object.defineProperty(class_1.prototype, "db", {
                        get: function () { return db; },
                        enumerable: false,
                        configurable: true
                    });
                    class_1.prototype.table = function () { return tableName; };
                    return class_1;
                }(constructor));
            }
            var inheritedProps = new Set();
            for (var proto = constructor.prototype; proto; proto = getProto(proto)) {
                Object.getOwnPropertyNames(proto).forEach(function (propName) { return inheritedProps.add(propName); });
            }
            var readHook = function (obj) {
                if (!obj)
                    return obj;
                var res = Object.create(constructor.prototype);
                for (var m in obj)
                    if (!inheritedProps.has(m))
                        try {
                            res[m] = obj[m];
                        }
                        catch (_) { }
                return res;
            };
            if (this.schema.readHook) {
                this.hook.reading.unsubscribe(this.schema.readHook);
            }
            this.schema.readHook = readHook;
            this.hook("reading", readHook);
            return constructor;
        };
        Table.prototype.defineClass = function () {
            function Class(content) {
                extend(this, content);
            }
            return this.mapToClass(Class);
        };
        Table.prototype.add = function (obj, key) {
            var _this = this;
            var _a = this.schema.primKey, auto = _a.auto, keyPath = _a.keyPath;
            var objToAdd = obj;
            if (keyPath && auto) {
                objToAdd = workaroundForUndefinedPrimKey(keyPath)(obj);
            }
            return this._trans('readwrite', function (trans) {
                return _this.core.mutate({ trans: trans, type: 'add', keys: key != null ? [key] : null, values: [objToAdd] });
            }).then(function (res) { return res.numFailures ? DexiePromise.reject(res.failures[0]) : res.lastResult; })
                .then(function (lastResult) {
                if (keyPath) {
                    try {
                        setByKeyPath(obj, keyPath, lastResult);
                    }
                    catch (_) { }
                }
                return lastResult;
            });
        };
        Table.prototype.update = function (keyOrObject, modifications) {
            if (typeof keyOrObject === 'object' && !isArray(keyOrObject)) {
                var key = getByKeyPath(keyOrObject, this.schema.primKey.keyPath);
                if (key === undefined)
                    return rejection(new exceptions.InvalidArgument("Given object does not contain its primary key"));
                return this.where(":id").equals(key).modify(modifications);
            }
            else {
                return this.where(":id").equals(keyOrObject).modify(modifications);
            }
        };
        Table.prototype.put = function (obj, key) {
            var _this = this;
            var _a = this.schema.primKey, auto = _a.auto, keyPath = _a.keyPath;
            var objToAdd = obj;
            if (keyPath && auto) {
                objToAdd = workaroundForUndefinedPrimKey(keyPath)(obj);
            }
            return this._trans('readwrite', function (trans) { return _this.core.mutate({ trans: trans, type: 'put', values: [objToAdd], keys: key != null ? [key] : null }); })
                .then(function (res) { return res.numFailures ? DexiePromise.reject(res.failures[0]) : res.lastResult; })
                .then(function (lastResult) {
                if (keyPath) {
                    try {
                        setByKeyPath(obj, keyPath, lastResult);
                    }
                    catch (_) { }
                }
                return lastResult;
            });
        };
        Table.prototype.delete = function (key) {
            var _this = this;
            return this._trans('readwrite', function (trans) { return _this.core.mutate({ trans: trans, type: 'delete', keys: [key] }); })
                .then(function (res) { return res.numFailures ? DexiePromise.reject(res.failures[0]) : undefined; });
        };
        Table.prototype.clear = function () {
            var _this = this;
            return this._trans('readwrite', function (trans) { return _this.core.mutate({ trans: trans, type: 'deleteRange', range: AnyRange }); })
                .then(function (res) { return res.numFailures ? DexiePromise.reject(res.failures[0]) : undefined; });
        };
        Table.prototype.bulkGet = function (keys) {
            var _this = this;
            return this._trans('readonly', function (trans) {
                return _this.core.getMany({
                    keys: keys,
                    trans: trans
                }).then(function (result) { return result.map(function (res) { return _this.hook.reading.fire(res); }); });
            });
        };
        Table.prototype.bulkAdd = function (objects, keysOrOptions, options) {
            var _this = this;
            var keys = Array.isArray(keysOrOptions) ? keysOrOptions : undefined;
            options = options || (keys ? undefined : keysOrOptions);
            var wantResults = options ? options.allKeys : undefined;
            return this._trans('readwrite', function (trans) {
                var _a = _this.schema.primKey, auto = _a.auto, keyPath = _a.keyPath;
                if (keyPath && keys)
                    throw new exceptions.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");
                if (keys && keys.length !== objects.length)
                    throw new exceptions.InvalidArgument("Arguments objects and keys must have the same length");
                var numObjects = objects.length;
                var objectsToAdd = keyPath && auto ?
                    objects.map(workaroundForUndefinedPrimKey(keyPath)) :
                    objects;
                return _this.core.mutate({ trans: trans, type: 'add', keys: keys, values: objectsToAdd, wantResults: wantResults })
                    .then(function (_a) {
                    var numFailures = _a.numFailures, results = _a.results, lastResult = _a.lastResult, failures = _a.failures;
                    var result = wantResults ? results : lastResult;
                    if (numFailures === 0)
                        return result;
                    throw new BulkError("".concat(_this.name, ".bulkAdd(): ").concat(numFailures, " of ").concat(numObjects, " operations failed"), failures);
                });
            });
        };
        Table.prototype.bulkPut = function (objects, keysOrOptions, options) {
            var _this = this;
            var keys = Array.isArray(keysOrOptions) ? keysOrOptions : undefined;
            options = options || (keys ? undefined : keysOrOptions);
            var wantResults = options ? options.allKeys : undefined;
            return this._trans('readwrite', function (trans) {
                var _a = _this.schema.primKey, auto = _a.auto, keyPath = _a.keyPath;
                if (keyPath && keys)
                    throw new exceptions.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");
                if (keys && keys.length !== objects.length)
                    throw new exceptions.InvalidArgument("Arguments objects and keys must have the same length");
                var numObjects = objects.length;
                var objectsToPut = keyPath && auto ?
                    objects.map(workaroundForUndefinedPrimKey(keyPath)) :
                    objects;
                return _this.core.mutate({ trans: trans, type: 'put', keys: keys, values: objectsToPut, wantResults: wantResults })
                    .then(function (_a) {
                    var numFailures = _a.numFailures, results = _a.results, lastResult = _a.lastResult, failures = _a.failures;
                    var result = wantResults ? results : lastResult;
                    if (numFailures === 0)
                        return result;
                    throw new BulkError("".concat(_this.name, ".bulkPut(): ").concat(numFailures, " of ").concat(numObjects, " operations failed"), failures);
                });
            });
        };
        Table.prototype.bulkUpdate = function (keysAndChanges) {
            var _this = this;
            var coreTable = this.core;
            var keys = keysAndChanges.map(function (entry) { return entry.key; });
            var changeSpecs = keysAndChanges.map(function (entry) { return entry.changes; });
            var offsetMap = [];
            return this._trans('readwrite', function (trans) {
                return coreTable.getMany({ trans: trans, keys: keys, cache: 'clone' }).then(function (objs) {
                    var resultKeys = [];
                    var resultObjs = [];
                    keysAndChanges.forEach(function (_a, idx) {
                        var key = _a.key, changes = _a.changes;
                        var obj = objs[idx];
                        if (obj) {
                            for (var _i = 0, _b = Object.keys(changes); _i < _b.length; _i++) {
                                var keyPath = _b[_i];
                                var value = changes[keyPath];
                                if (keyPath === _this.schema.primKey.keyPath) {
                                    if (cmp(value, key) !== 0) {
                                        throw new exceptions.Constraint("Cannot update primary key in bulkUpdate()");
                                    }
                                }
                                else {
                                    setByKeyPath(obj, keyPath, value);
                                }
                            }
                            offsetMap.push(idx);
                            resultKeys.push(key);
                            resultObjs.push(obj);
                        }
                    });
                    var numEntries = resultKeys.length;
                    return coreTable
                        .mutate({
                        trans: trans,
                        type: 'put',
                        keys: resultKeys,
                        values: resultObjs,
                        updates: {
                            keys: keys,
                            changeSpecs: changeSpecs
                        }
                    })
                        .then(function (_a) {
                        var numFailures = _a.numFailures, failures = _a.failures;
                        if (numFailures === 0)
                            return numEntries;
                        for (var _i = 0, _b = Object.keys(failures); _i < _b.length; _i++) {
                            var offset = _b[_i];
                            var mappedOffset = offsetMap[Number(offset)];
                            if (mappedOffset != null) {
                                var failure = failures[offset];
                                delete failures[offset];
                                failures[mappedOffset] = failure;
                            }
                        }
                        throw new BulkError("".concat(_this.name, ".bulkUpdate(): ").concat(numFailures, " of ").concat(numEntries, " operations failed"), failures);
                    });
                });
            });
        };
        Table.prototype.bulkDelete = function (keys) {
            var _this = this;
            var numKeys = keys.length;
            return this._trans('readwrite', function (trans) {
                return _this.core.mutate({ trans: trans, type: 'delete', keys: keys });
            }).then(function (_a) {
                var numFailures = _a.numFailures, lastResult = _a.lastResult, failures = _a.failures;
                if (numFailures === 0)
                    return lastResult;
                throw new BulkError("".concat(_this.name, ".bulkDelete(): ").concat(numFailures, " of ").concat(numKeys, " operations failed"), failures);
            });
        };
        return Table;
    }());

    function Events(ctx) {
        var evs = {};
        var rv = function (eventName, subscriber) {
            if (subscriber) {
                var i = arguments.length, args = new Array(i - 1);
                while (--i)
                    args[i - 1] = arguments[i];
                evs[eventName].subscribe.apply(null, args);
                return ctx;
            }
            else if (typeof (eventName) === 'string') {
                return evs[eventName];
            }
        };
        rv.addEventType = add;
        for (var i = 1, l = arguments.length; i < l; ++i) {
            add(arguments[i]);
        }
        return rv;
        function add(eventName, chainFunction, defaultFunction) {
            if (typeof eventName === 'object')
                return addConfiguredEvents(eventName);
            if (!chainFunction)
                chainFunction = reverseStoppableEventChain;
            if (!defaultFunction)
                defaultFunction = nop;
            var context = {
                subscribers: [],
                fire: defaultFunction,
                subscribe: function (cb) {
                    if (context.subscribers.indexOf(cb) === -1) {
                        context.subscribers.push(cb);
                        context.fire = chainFunction(context.fire, cb);
                    }
                },
                unsubscribe: function (cb) {
                    context.subscribers = context.subscribers.filter(function (fn) { return fn !== cb; });
                    context.fire = context.subscribers.reduce(chainFunction, defaultFunction);
                }
            };
            evs[eventName] = rv[eventName] = context;
            return context;
        }
        function addConfiguredEvents(cfg) {
            keys(cfg).forEach(function (eventName) {
                var args = cfg[eventName];
                if (isArray(args)) {
                    add(eventName, cfg[eventName][0], cfg[eventName][1]);
                }
                else if (args === 'asap') {
                    var context = add(eventName, mirror, function fire() {
                        var i = arguments.length, args = new Array(i);
                        while (i--)
                            args[i] = arguments[i];
                        context.subscribers.forEach(function (fn) {
                            asap$1(function fireEvent() {
                                fn.apply(null, args);
                            });
                        });
                    });
                }
                else
                    throw new exceptions.InvalidArgument("Invalid event config");
            });
        }
    }

    function makeClassConstructor(prototype, constructor) {
        derive(constructor).from({ prototype: prototype });
        return constructor;
    }

    function createTableConstructor(db) {
        return makeClassConstructor(Table.prototype, function Table(name, tableSchema, trans) {
            this.db = db;
            this._tx = trans;
            this.name = name;
            this.schema = tableSchema;
            this.hook = db._allTables[name] ? db._allTables[name].hook : Events(null, {
                "creating": [hookCreatingChain, nop],
                "reading": [pureFunctionChain, mirror],
                "updating": [hookUpdatingChain, nop],
                "deleting": [hookDeletingChain, nop]
            });
        });
    }

    function isPlainKeyRange(ctx, ignoreLimitFilter) {
        return !(ctx.filter || ctx.algorithm || ctx.or) &&
            (ignoreLimitFilter ? ctx.justLimit : !ctx.replayFilter);
    }
    function addFilter(ctx, fn) {
        ctx.filter = combine(ctx.filter, fn);
    }
    function addReplayFilter(ctx, factory, isLimitFilter) {
        var curr = ctx.replayFilter;
        ctx.replayFilter = curr ? function () { return combine(curr(), factory()); } : factory;
        ctx.justLimit = isLimitFilter && !curr;
    }
    function addMatchFilter(ctx, fn) {
        ctx.isMatch = combine(ctx.isMatch, fn);
    }
    function getIndexOrStore(ctx, coreSchema) {
        if (ctx.isPrimKey)
            return coreSchema.primaryKey;
        var index = coreSchema.getIndexByKeyPath(ctx.index);
        if (!index)
            throw new exceptions.Schema("KeyPath " + ctx.index + " on object store " + coreSchema.name + " is not indexed");
        return index;
    }
    function openCursor(ctx, coreTable, trans) {
        var index = getIndexOrStore(ctx, coreTable.schema);
        return coreTable.openCursor({
            trans: trans,
            values: !ctx.keysOnly,
            reverse: ctx.dir === 'prev',
            unique: !!ctx.unique,
            query: {
                index: index,
                range: ctx.range
            }
        });
    }
    function iter(ctx, fn, coreTrans, coreTable) {
        var filter = ctx.replayFilter ? combine(ctx.filter, ctx.replayFilter()) : ctx.filter;
        if (!ctx.or) {
            return iterate(openCursor(ctx, coreTable, coreTrans), combine(ctx.algorithm, filter), fn, !ctx.keysOnly && ctx.valueMapper);
        }
        else {
            var set_1 = {};
            var union = function (item, cursor, advance) {
                if (!filter || filter(cursor, advance, function (result) { return cursor.stop(result); }, function (err) { return cursor.fail(err); })) {
                    var primaryKey = cursor.primaryKey;
                    var key = '' + primaryKey;
                    if (key === '[object ArrayBuffer]')
                        key = '' + new Uint8Array(primaryKey);
                    if (!hasOwn(set_1, key)) {
                        set_1[key] = true;
                        fn(item, cursor, advance);
                    }
                }
            };
            return Promise.all([
                ctx.or._iterate(union, coreTrans),
                iterate(openCursor(ctx, coreTable, coreTrans), ctx.algorithm, union, !ctx.keysOnly && ctx.valueMapper)
            ]);
        }
    }
    function iterate(cursorPromise, filter, fn, valueMapper) {
        var mappedFn = valueMapper ? function (x, c, a) { return fn(valueMapper(x), c, a); } : fn;
        var wrappedFn = wrap(mappedFn);
        return cursorPromise.then(function (cursor) {
            if (cursor) {
                return cursor.start(function () {
                    var c = function () { return cursor.continue(); };
                    if (!filter || filter(cursor, function (advancer) { return c = advancer; }, function (val) { cursor.stop(val); c = nop; }, function (e) { cursor.fail(e); c = nop; }))
                        wrappedFn(cursor.value, cursor, function (advancer) { return c = advancer; });
                    c();
                });
            }
        });
    }

    var PropModification =  (function () {
        function PropModification(spec) {
            this["@@propmod"] = spec;
        }
        PropModification.prototype.execute = function (value) {
            var _a;
            var spec = this["@@propmod"];
            if (spec.add !== undefined) {
                var term = spec.add;
                if (isArray(term)) {
                    return __spreadArray(__spreadArray([], (isArray(value) ? value : []), true), term, true).sort();
                }
                if (typeof term === 'number')
                    return (Number(value) || 0) + term;
                if (typeof term === 'bigint') {
                    try {
                        return BigInt(value) + term;
                    }
                    catch (_b) {
                        return BigInt(0) + term;
                    }
                }
                throw new TypeError("Invalid term ".concat(term));
            }
            if (spec.remove !== undefined) {
                var subtrahend_1 = spec.remove;
                if (isArray(subtrahend_1)) {
                    return isArray(value) ? value.filter(function (item) { return !subtrahend_1.includes(item); }).sort() : [];
                }
                if (typeof subtrahend_1 === 'number')
                    return Number(value) - subtrahend_1;
                if (typeof subtrahend_1 === 'bigint') {
                    try {
                        return BigInt(value) - subtrahend_1;
                    }
                    catch (_c) {
                        return BigInt(0) - subtrahend_1;
                    }
                }
                throw new TypeError("Invalid subtrahend ".concat(subtrahend_1));
            }
            var prefixToReplace = (_a = spec.replacePrefix) === null || _a === void 0 ? void 0 : _a[0];
            if (prefixToReplace && typeof value === 'string' && value.startsWith(prefixToReplace)) {
                return spec.replacePrefix[1] + value.substring(prefixToReplace.length);
            }
            return value;
        };
        return PropModification;
    }());

    var Collection =  (function () {
        function Collection() {
        }
        Collection.prototype._read = function (fn, cb) {
            var ctx = this._ctx;
            return ctx.error ?
                ctx.table._trans(null, rejection.bind(null, ctx.error)) :
                ctx.table._trans('readonly', fn).then(cb);
        };
        Collection.prototype._write = function (fn) {
            var ctx = this._ctx;
            return ctx.error ?
                ctx.table._trans(null, rejection.bind(null, ctx.error)) :
                ctx.table._trans('readwrite', fn, "locked");
        };
        Collection.prototype._addAlgorithm = function (fn) {
            var ctx = this._ctx;
            ctx.algorithm = combine(ctx.algorithm, fn);
        };
        Collection.prototype._iterate = function (fn, coreTrans) {
            return iter(this._ctx, fn, coreTrans, this._ctx.table.core);
        };
        Collection.prototype.clone = function (props) {
            var rv = Object.create(this.constructor.prototype), ctx = Object.create(this._ctx);
            if (props)
                extend(ctx, props);
            rv._ctx = ctx;
            return rv;
        };
        Collection.prototype.raw = function () {
            this._ctx.valueMapper = null;
            return this;
        };
        Collection.prototype.each = function (fn) {
            var ctx = this._ctx;
            return this._read(function (trans) { return iter(ctx, fn, trans, ctx.table.core); });
        };
        Collection.prototype.count = function (cb) {
            var _this = this;
            return this._read(function (trans) {
                var ctx = _this._ctx;
                var coreTable = ctx.table.core;
                if (isPlainKeyRange(ctx, true)) {
                    return coreTable.count({
                        trans: trans,
                        query: {
                            index: getIndexOrStore(ctx, coreTable.schema),
                            range: ctx.range
                        }
                    }).then(function (count) { return Math.min(count, ctx.limit); });
                }
                else {
                    var count = 0;
                    return iter(ctx, function () { ++count; return false; }, trans, coreTable)
                        .then(function () { return count; });
                }
            }).then(cb);
        };
        Collection.prototype.sortBy = function (keyPath, cb) {
            var parts = keyPath.split('.').reverse(), lastPart = parts[0], lastIndex = parts.length - 1;
            function getval(obj, i) {
                if (i)
                    return getval(obj[parts[i]], i - 1);
                return obj[lastPart];
            }
            var order = this._ctx.dir === "next" ? 1 : -1;
            function sorter(a, b) {
                var aVal = getval(a, lastIndex), bVal = getval(b, lastIndex);
                return cmp(aVal, bVal) * order;
            }
            return this.toArray(function (a) {
                return a.sort(sorter);
            }).then(cb);
        };
        Collection.prototype.toArray = function (cb) {
            var _this = this;
            return this._read(function (trans) {
                var ctx = _this._ctx;
                if (ctx.dir === 'next' && isPlainKeyRange(ctx, true) && ctx.limit > 0) {
                    var valueMapper_1 = ctx.valueMapper;
                    var index = getIndexOrStore(ctx, ctx.table.core.schema);
                    return ctx.table.core.query({
                        trans: trans,
                        limit: ctx.limit,
                        values: true,
                        query: {
                            index: index,
                            range: ctx.range
                        }
                    }).then(function (_a) {
                        var result = _a.result;
                        return valueMapper_1 ? result.map(valueMapper_1) : result;
                    });
                }
                else {
                    var a_1 = [];
                    return iter(ctx, function (item) { return a_1.push(item); }, trans, ctx.table.core).then(function () { return a_1; });
                }
            }, cb);
        };
        Collection.prototype.offset = function (offset) {
            var ctx = this._ctx;
            if (offset <= 0)
                return this;
            ctx.offset += offset;
            if (isPlainKeyRange(ctx)) {
                addReplayFilter(ctx, function () {
                    var offsetLeft = offset;
                    return function (cursor, advance) {
                        if (offsetLeft === 0)
                            return true;
                        if (offsetLeft === 1) {
                            --offsetLeft;
                            return false;
                        }
                        advance(function () {
                            cursor.advance(offsetLeft);
                            offsetLeft = 0;
                        });
                        return false;
                    };
                });
            }
            else {
                addReplayFilter(ctx, function () {
                    var offsetLeft = offset;
                    return function () { return (--offsetLeft < 0); };
                });
            }
            return this;
        };
        Collection.prototype.limit = function (numRows) {
            this._ctx.limit = Math.min(this._ctx.limit, numRows);
            addReplayFilter(this._ctx, function () {
                var rowsLeft = numRows;
                return function (cursor, advance, resolve) {
                    if (--rowsLeft <= 0)
                        advance(resolve);
                    return rowsLeft >= 0;
                };
            }, true);
            return this;
        };
        Collection.prototype.until = function (filterFunction, bIncludeStopEntry) {
            addFilter(this._ctx, function (cursor, advance, resolve) {
                if (filterFunction(cursor.value)) {
                    advance(resolve);
                    return bIncludeStopEntry;
                }
                else {
                    return true;
                }
            });
            return this;
        };
        Collection.prototype.first = function (cb) {
            return this.limit(1).toArray(function (a) { return a[0]; }).then(cb);
        };
        Collection.prototype.last = function (cb) {
            return this.reverse().first(cb);
        };
        Collection.prototype.filter = function (filterFunction) {
            addFilter(this._ctx, function (cursor) {
                return filterFunction(cursor.value);
            });
            addMatchFilter(this._ctx, filterFunction);
            return this;
        };
        Collection.prototype.and = function (filter) {
            return this.filter(filter);
        };
        Collection.prototype.or = function (indexName) {
            return new this.db.WhereClause(this._ctx.table, indexName, this);
        };
        Collection.prototype.reverse = function () {
            this._ctx.dir = (this._ctx.dir === "prev" ? "next" : "prev");
            if (this._ondirectionchange)
                this._ondirectionchange(this._ctx.dir);
            return this;
        };
        Collection.prototype.desc = function () {
            return this.reverse();
        };
        Collection.prototype.eachKey = function (cb) {
            var ctx = this._ctx;
            ctx.keysOnly = !ctx.isMatch;
            return this.each(function (val, cursor) { cb(cursor.key, cursor); });
        };
        Collection.prototype.eachUniqueKey = function (cb) {
            this._ctx.unique = "unique";
            return this.eachKey(cb);
        };
        Collection.prototype.eachPrimaryKey = function (cb) {
            var ctx = this._ctx;
            ctx.keysOnly = !ctx.isMatch;
            return this.each(function (val, cursor) { cb(cursor.primaryKey, cursor); });
        };
        Collection.prototype.keys = function (cb) {
            var ctx = this._ctx;
            ctx.keysOnly = !ctx.isMatch;
            var a = [];
            return this.each(function (item, cursor) {
                a.push(cursor.key);
            }).then(function () {
                return a;
            }).then(cb);
        };
        Collection.prototype.primaryKeys = function (cb) {
            var ctx = this._ctx;
            if (ctx.dir === 'next' && isPlainKeyRange(ctx, true) && ctx.limit > 0) {
                return this._read(function (trans) {
                    var index = getIndexOrStore(ctx, ctx.table.core.schema);
                    return ctx.table.core.query({
                        trans: trans,
                        values: false,
                        limit: ctx.limit,
                        query: {
                            index: index,
                            range: ctx.range
                        }
                    });
                }).then(function (_a) {
                    var result = _a.result;
                    return result;
                }).then(cb);
            }
            ctx.keysOnly = !ctx.isMatch;
            var a = [];
            return this.each(function (item, cursor) {
                a.push(cursor.primaryKey);
            }).then(function () {
                return a;
            }).then(cb);
        };
        Collection.prototype.uniqueKeys = function (cb) {
            this._ctx.unique = "unique";
            return this.keys(cb);
        };
        Collection.prototype.firstKey = function (cb) {
            return this.limit(1).keys(function (a) { return a[0]; }).then(cb);
        };
        Collection.prototype.lastKey = function (cb) {
            return this.reverse().firstKey(cb);
        };
        Collection.prototype.distinct = function () {
            var ctx = this._ctx, idx = ctx.index && ctx.table.schema.idxByName[ctx.index];
            if (!idx || !idx.multi)
                return this;
            var set = {};
            addFilter(this._ctx, function (cursor) {
                var strKey = cursor.primaryKey.toString();
                var found = hasOwn(set, strKey);
                set[strKey] = true;
                return !found;
            });
            return this;
        };
        Collection.prototype.modify = function (changes) {
            var _this = this;
            var ctx = this._ctx;
            return this._write(function (trans) {
                var modifyer;
                if (typeof changes === 'function') {
                    modifyer = changes;
                }
                else {
                    var keyPaths = keys(changes);
                    var numKeys = keyPaths.length;
                    modifyer = function (item) {
                        var anythingModified = false;
                        for (var i = 0; i < numKeys; ++i) {
                            var keyPath = keyPaths[i];
                            var val = changes[keyPath];
                            var origVal = getByKeyPath(item, keyPath);
                            if (val instanceof PropModification) {
                                setByKeyPath(item, keyPath, val.execute(origVal));
                                anythingModified = true;
                            }
                            else if (origVal !== val) {
                                setByKeyPath(item, keyPath, val);
                                anythingModified = true;
                            }
                        }
                        return anythingModified;
                    };
                }
                var coreTable = ctx.table.core;
                var _a = coreTable.schema.primaryKey, outbound = _a.outbound, extractKey = _a.extractKey;
                var limit = 200;
                var modifyChunkSize = _this.db._options.modifyChunkSize;
                if (modifyChunkSize) {
                    if (typeof modifyChunkSize == 'object') {
                        limit = modifyChunkSize[coreTable.name] || modifyChunkSize['*'] || 200;
                    }
                    else {
                        limit = modifyChunkSize;
                    }
                }
                var totalFailures = [];
                var successCount = 0;
                var failedKeys = [];
                var applyMutateResult = function (expectedCount, res) {
                    var failures = res.failures, numFailures = res.numFailures;
                    successCount += expectedCount - numFailures;
                    for (var _i = 0, _a = keys(failures); _i < _a.length; _i++) {
                        var pos = _a[_i];
                        totalFailures.push(failures[pos]);
                    }
                };
                return _this.clone().primaryKeys().then(function (keys) {
                    var criteria = isPlainKeyRange(ctx) &&
                        ctx.limit === Infinity &&
                        (typeof changes !== 'function' || changes === deleteCallback) && {
                        index: ctx.index,
                        range: ctx.range
                    };
                    var nextChunk = function (offset) {
                        var count = Math.min(limit, keys.length - offset);
                        return coreTable.getMany({
                            trans: trans,
                            keys: keys.slice(offset, offset + count),
                            cache: "immutable"
                        }).then(function (values) {
                            var addValues = [];
                            var putValues = [];
                            var putKeys = outbound ? [] : null;
                            var deleteKeys = [];
                            for (var i = 0; i < count; ++i) {
                                var origValue = values[i];
                                var ctx_1 = {
                                    value: deepClone(origValue),
                                    primKey: keys[offset + i]
                                };
                                if (modifyer.call(ctx_1, ctx_1.value, ctx_1) !== false) {
                                    if (ctx_1.value == null) {
                                        deleteKeys.push(keys[offset + i]);
                                    }
                                    else if (!outbound && cmp(extractKey(origValue), extractKey(ctx_1.value)) !== 0) {
                                        deleteKeys.push(keys[offset + i]);
                                        addValues.push(ctx_1.value);
                                    }
                                    else {
                                        putValues.push(ctx_1.value);
                                        if (outbound)
                                            putKeys.push(keys[offset + i]);
                                    }
                                }
                            }
                            return Promise.resolve(addValues.length > 0 &&
                                coreTable.mutate({ trans: trans, type: 'add', values: addValues })
                                    .then(function (res) {
                                    for (var pos in res.failures) {
                                        deleteKeys.splice(parseInt(pos), 1);
                                    }
                                    applyMutateResult(addValues.length, res);
                                })).then(function () { return (putValues.length > 0 || (criteria && typeof changes === 'object')) &&
                                coreTable.mutate({
                                    trans: trans,
                                    type: 'put',
                                    keys: putKeys,
                                    values: putValues,
                                    criteria: criteria,
                                    changeSpec: typeof changes !== 'function'
                                        && changes,
                                    isAdditionalChunk: offset > 0
                                }).then(function (res) { return applyMutateResult(putValues.length, res); }); }).then(function () { return (deleteKeys.length > 0 || (criteria && changes === deleteCallback)) &&
                                coreTable.mutate({
                                    trans: trans,
                                    type: 'delete',
                                    keys: deleteKeys,
                                    criteria: criteria,
                                    isAdditionalChunk: offset > 0
                                }).then(function (res) { return applyMutateResult(deleteKeys.length, res); }); }).then(function () {
                                return keys.length > offset + count && nextChunk(offset + limit);
                            });
                        });
                    };
                    return nextChunk(0).then(function () {
                        if (totalFailures.length > 0)
                            throw new ModifyError("Error modifying one or more objects", totalFailures, successCount, failedKeys);
                        return keys.length;
                    });
                });
            });
        };
        Collection.prototype.delete = function () {
            var ctx = this._ctx, range = ctx.range;
            if (isPlainKeyRange(ctx) &&
                (ctx.isPrimKey || range.type === 3 ))
             {
                return this._write(function (trans) {
                    var primaryKey = ctx.table.core.schema.primaryKey;
                    var coreRange = range;
                    return ctx.table.core.count({ trans: trans, query: { index: primaryKey, range: coreRange } }).then(function (count) {
                        return ctx.table.core.mutate({ trans: trans, type: 'deleteRange', range: coreRange })
                            .then(function (_a) {
                            var failures = _a.failures; _a.lastResult; _a.results; var numFailures = _a.numFailures;
                            if (numFailures)
                                throw new ModifyError("Could not delete some values", Object.keys(failures).map(function (pos) { return failures[pos]; }), count - numFailures);
                            return count - numFailures;
                        });
                    });
                });
            }
            return this.modify(deleteCallback);
        };
        return Collection;
    }());
    var deleteCallback = function (value, ctx) { return ctx.value = null; };

    function createCollectionConstructor(db) {
        return makeClassConstructor(Collection.prototype, function Collection(whereClause, keyRangeGenerator) {
            this.db = db;
            var keyRange = AnyRange, error = null;
            if (keyRangeGenerator)
                try {
                    keyRange = keyRangeGenerator();
                }
                catch (ex) {
                    error = ex;
                }
            var whereCtx = whereClause._ctx;
            var table = whereCtx.table;
            var readingHook = table.hook.reading.fire;
            this._ctx = {
                table: table,
                index: whereCtx.index,
                isPrimKey: (!whereCtx.index || (table.schema.primKey.keyPath && whereCtx.index === table.schema.primKey.name)),
                range: keyRange,
                keysOnly: false,
                dir: "next",
                unique: "",
                algorithm: null,
                filter: null,
                replayFilter: null,
                justLimit: true,
                isMatch: null,
                offset: 0,
                limit: Infinity,
                error: error,
                or: whereCtx.or,
                valueMapper: readingHook !== mirror ? readingHook : null
            };
        });
    }

    function simpleCompare(a, b) {
        return a < b ? -1 : a === b ? 0 : 1;
    }
    function simpleCompareReverse(a, b) {
        return a > b ? -1 : a === b ? 0 : 1;
    }

    function fail(collectionOrWhereClause, err, T) {
        var collection = collectionOrWhereClause instanceof WhereClause ?
            new collectionOrWhereClause.Collection(collectionOrWhereClause) :
            collectionOrWhereClause;
        collection._ctx.error = T ? new T(err) : new TypeError(err);
        return collection;
    }
    function emptyCollection(whereClause) {
        return new whereClause.Collection(whereClause, function () { return rangeEqual(""); }).limit(0);
    }
    function upperFactory(dir) {
        return dir === "next" ?
            function (s) { return s.toUpperCase(); } :
            function (s) { return s.toLowerCase(); };
    }
    function lowerFactory(dir) {
        return dir === "next" ?
            function (s) { return s.toLowerCase(); } :
            function (s) { return s.toUpperCase(); };
    }
    function nextCasing(key, lowerKey, upperNeedle, lowerNeedle, cmp, dir) {
        var length = Math.min(key.length, lowerNeedle.length);
        var llp = -1;
        for (var i = 0; i < length; ++i) {
            var lwrKeyChar = lowerKey[i];
            if (lwrKeyChar !== lowerNeedle[i]) {
                if (cmp(key[i], upperNeedle[i]) < 0)
                    return key.substr(0, i) + upperNeedle[i] + upperNeedle.substr(i + 1);
                if (cmp(key[i], lowerNeedle[i]) < 0)
                    return key.substr(0, i) + lowerNeedle[i] + upperNeedle.substr(i + 1);
                if (llp >= 0)
                    return key.substr(0, llp) + lowerKey[llp] + upperNeedle.substr(llp + 1);
                return null;
            }
            if (cmp(key[i], lwrKeyChar) < 0)
                llp = i;
        }
        if (length < lowerNeedle.length && dir === "next")
            return key + upperNeedle.substr(key.length);
        if (length < key.length && dir === "prev")
            return key.substr(0, upperNeedle.length);
        return (llp < 0 ? null : key.substr(0, llp) + lowerNeedle[llp] + upperNeedle.substr(llp + 1));
    }
    function addIgnoreCaseAlgorithm(whereClause, match, needles, suffix) {
        var upper, lower, compare, upperNeedles, lowerNeedles, direction, nextKeySuffix, needlesLen = needles.length;
        if (!needles.every(function (s) { return typeof s === 'string'; })) {
            return fail(whereClause, STRING_EXPECTED);
        }
        function initDirection(dir) {
            upper = upperFactory(dir);
            lower = lowerFactory(dir);
            compare = (dir === "next" ? simpleCompare : simpleCompareReverse);
            var needleBounds = needles.map(function (needle) {
                return { lower: lower(needle), upper: upper(needle) };
            }).sort(function (a, b) {
                return compare(a.lower, b.lower);
            });
            upperNeedles = needleBounds.map(function (nb) { return nb.upper; });
            lowerNeedles = needleBounds.map(function (nb) { return nb.lower; });
            direction = dir;
            nextKeySuffix = (dir === "next" ? "" : suffix);
        }
        initDirection("next");
        var c = new whereClause.Collection(whereClause, function () { return createRange(upperNeedles[0], lowerNeedles[needlesLen - 1] + suffix); });
        c._ondirectionchange = function (direction) {
            initDirection(direction);
        };
        var firstPossibleNeedle = 0;
        c._addAlgorithm(function (cursor, advance, resolve) {
            var key = cursor.key;
            if (typeof key !== 'string')
                return false;
            var lowerKey = lower(key);
            if (match(lowerKey, lowerNeedles, firstPossibleNeedle)) {
                return true;
            }
            else {
                var lowestPossibleCasing = null;
                for (var i = firstPossibleNeedle; i < needlesLen; ++i) {
                    var casing = nextCasing(key, lowerKey, upperNeedles[i], lowerNeedles[i], compare, direction);
                    if (casing === null && lowestPossibleCasing === null)
                        firstPossibleNeedle = i + 1;
                    else if (lowestPossibleCasing === null || compare(lowestPossibleCasing, casing) > 0) {
                        lowestPossibleCasing = casing;
                    }
                }
                if (lowestPossibleCasing !== null) {
                    advance(function () { cursor.continue(lowestPossibleCasing + nextKeySuffix); });
                }
                else {
                    advance(resolve);
                }
                return false;
            }
        });
        return c;
    }
    function createRange(lower, upper, lowerOpen, upperOpen) {
        return {
            type: 2 ,
            lower: lower,
            upper: upper,
            lowerOpen: lowerOpen,
            upperOpen: upperOpen
        };
    }
    function rangeEqual(value) {
        return {
            type: 1 ,
            lower: value,
            upper: value
        };
    }

    var WhereClause =  (function () {
        function WhereClause() {
        }
        Object.defineProperty(WhereClause.prototype, "Collection", {
            get: function () {
                return this._ctx.table.db.Collection;
            },
            enumerable: false,
            configurable: true
        });
        WhereClause.prototype.between = function (lower, upper, includeLower, includeUpper) {
            includeLower = includeLower !== false;
            includeUpper = includeUpper === true;
            try {
                if ((this._cmp(lower, upper) > 0) ||
                    (this._cmp(lower, upper) === 0 && (includeLower || includeUpper) && !(includeLower && includeUpper)))
                    return emptyCollection(this);
                return new this.Collection(this, function () { return createRange(lower, upper, !includeLower, !includeUpper); });
            }
            catch (e) {
                return fail(this, INVALID_KEY_ARGUMENT);
            }
        };
        WhereClause.prototype.equals = function (value) {
            if (value == null)
                return fail(this, INVALID_KEY_ARGUMENT);
            return new this.Collection(this, function () { return rangeEqual(value); });
        };
        WhereClause.prototype.above = function (value) {
            if (value == null)
                return fail(this, INVALID_KEY_ARGUMENT);
            return new this.Collection(this, function () { return createRange(value, undefined, true); });
        };
        WhereClause.prototype.aboveOrEqual = function (value) {
            if (value == null)
                return fail(this, INVALID_KEY_ARGUMENT);
            return new this.Collection(this, function () { return createRange(value, undefined, false); });
        };
        WhereClause.prototype.below = function (value) {
            if (value == null)
                return fail(this, INVALID_KEY_ARGUMENT);
            return new this.Collection(this, function () { return createRange(undefined, value, false, true); });
        };
        WhereClause.prototype.belowOrEqual = function (value) {
            if (value == null)
                return fail(this, INVALID_KEY_ARGUMENT);
            return new this.Collection(this, function () { return createRange(undefined, value); });
        };
        WhereClause.prototype.startsWith = function (str) {
            if (typeof str !== 'string')
                return fail(this, STRING_EXPECTED);
            return this.between(str, str + maxString, true, true);
        };
        WhereClause.prototype.startsWithIgnoreCase = function (str) {
            if (str === "")
                return this.startsWith(str);
            return addIgnoreCaseAlgorithm(this, function (x, a) { return x.indexOf(a[0]) === 0; }, [str], maxString);
        };
        WhereClause.prototype.equalsIgnoreCase = function (str) {
            return addIgnoreCaseAlgorithm(this, function (x, a) { return x === a[0]; }, [str], "");
        };
        WhereClause.prototype.anyOfIgnoreCase = function () {
            var set = getArrayOf.apply(NO_CHAR_ARRAY, arguments);
            if (set.length === 0)
                return emptyCollection(this);
            return addIgnoreCaseAlgorithm(this, function (x, a) { return a.indexOf(x) !== -1; }, set, "");
        };
        WhereClause.prototype.startsWithAnyOfIgnoreCase = function () {
            var set = getArrayOf.apply(NO_CHAR_ARRAY, arguments);
            if (set.length === 0)
                return emptyCollection(this);
            return addIgnoreCaseAlgorithm(this, function (x, a) { return a.some(function (n) { return x.indexOf(n) === 0; }); }, set, maxString);
        };
        WhereClause.prototype.anyOf = function () {
            var _this = this;
            var set = getArrayOf.apply(NO_CHAR_ARRAY, arguments);
            var compare = this._cmp;
            try {
                set.sort(compare);
            }
            catch (e) {
                return fail(this, INVALID_KEY_ARGUMENT);
            }
            if (set.length === 0)
                return emptyCollection(this);
            var c = new this.Collection(this, function () { return createRange(set[0], set[set.length - 1]); });
            c._ondirectionchange = function (direction) {
                compare = (direction === "next" ?
                    _this._ascending :
                    _this._descending);
                set.sort(compare);
            };
            var i = 0;
            c._addAlgorithm(function (cursor, advance, resolve) {
                var key = cursor.key;
                while (compare(key, set[i]) > 0) {
                    ++i;
                    if (i === set.length) {
                        advance(resolve);
                        return false;
                    }
                }
                if (compare(key, set[i]) === 0) {
                    return true;
                }
                else {
                    advance(function () { cursor.continue(set[i]); });
                    return false;
                }
            });
            return c;
        };
        WhereClause.prototype.notEqual = function (value) {
            return this.inAnyRange([[minKey, value], [value, this.db._maxKey]], { includeLowers: false, includeUppers: false });
        };
        WhereClause.prototype.noneOf = function () {
            var set = getArrayOf.apply(NO_CHAR_ARRAY, arguments);
            if (set.length === 0)
                return new this.Collection(this);
            try {
                set.sort(this._ascending);
            }
            catch (e) {
                return fail(this, INVALID_KEY_ARGUMENT);
            }
            var ranges = set.reduce(function (res, val) { return res ?
                res.concat([[res[res.length - 1][1], val]]) :
                [[minKey, val]]; }, null);
            ranges.push([set[set.length - 1], this.db._maxKey]);
            return this.inAnyRange(ranges, { includeLowers: false, includeUppers: false });
        };
        WhereClause.prototype.inAnyRange = function (ranges, options) {
            var _this = this;
            var cmp = this._cmp, ascending = this._ascending, descending = this._descending, min = this._min, max = this._max;
            if (ranges.length === 0)
                return emptyCollection(this);
            if (!ranges.every(function (range) {
                return range[0] !== undefined &&
                    range[1] !== undefined &&
                    ascending(range[0], range[1]) <= 0;
            })) {
                return fail(this, "First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower", exceptions.InvalidArgument);
            }
            var includeLowers = !options || options.includeLowers !== false;
            var includeUppers = options && options.includeUppers === true;
            function addRange(ranges, newRange) {
                var i = 0, l = ranges.length;
                for (; i < l; ++i) {
                    var range = ranges[i];
                    if (cmp(newRange[0], range[1]) < 0 && cmp(newRange[1], range[0]) > 0) {
                        range[0] = min(range[0], newRange[0]);
                        range[1] = max(range[1], newRange[1]);
                        break;
                    }
                }
                if (i === l)
                    ranges.push(newRange);
                return ranges;
            }
            var sortDirection = ascending;
            function rangeSorter(a, b) { return sortDirection(a[0], b[0]); }
            var set;
            try {
                set = ranges.reduce(addRange, []);
                set.sort(rangeSorter);
            }
            catch (ex) {
                return fail(this, INVALID_KEY_ARGUMENT);
            }
            var rangePos = 0;
            var keyIsBeyondCurrentEntry = includeUppers ?
                function (key) { return ascending(key, set[rangePos][1]) > 0; } :
                function (key) { return ascending(key, set[rangePos][1]) >= 0; };
            var keyIsBeforeCurrentEntry = includeLowers ?
                function (key) { return descending(key, set[rangePos][0]) > 0; } :
                function (key) { return descending(key, set[rangePos][0]) >= 0; };
            function keyWithinCurrentRange(key) {
                return !keyIsBeyondCurrentEntry(key) && !keyIsBeforeCurrentEntry(key);
            }
            var checkKey = keyIsBeyondCurrentEntry;
            var c = new this.Collection(this, function () { return createRange(set[0][0], set[set.length - 1][1], !includeLowers, !includeUppers); });
            c._ondirectionchange = function (direction) {
                if (direction === "next") {
                    checkKey = keyIsBeyondCurrentEntry;
                    sortDirection = ascending;
                }
                else {
                    checkKey = keyIsBeforeCurrentEntry;
                    sortDirection = descending;
                }
                set.sort(rangeSorter);
            };
            c._addAlgorithm(function (cursor, advance, resolve) {
                var key = cursor.key;
                while (checkKey(key)) {
                    ++rangePos;
                    if (rangePos === set.length) {
                        advance(resolve);
                        return false;
                    }
                }
                if (keyWithinCurrentRange(key)) {
                    return true;
                }
                else if (_this._cmp(key, set[rangePos][1]) === 0 || _this._cmp(key, set[rangePos][0]) === 0) {
                    return false;
                }
                else {
                    advance(function () {
                        if (sortDirection === ascending)
                            cursor.continue(set[rangePos][0]);
                        else
                            cursor.continue(set[rangePos][1]);
                    });
                    return false;
                }
            });
            return c;
        };
        WhereClause.prototype.startsWithAnyOf = function () {
            var set = getArrayOf.apply(NO_CHAR_ARRAY, arguments);
            if (!set.every(function (s) { return typeof s === 'string'; })) {
                return fail(this, "startsWithAnyOf() only works with strings");
            }
            if (set.length === 0)
                return emptyCollection(this);
            return this.inAnyRange(set.map(function (str) { return [str, str + maxString]; }));
        };
        return WhereClause;
    }());

    function createWhereClauseConstructor(db) {
        return makeClassConstructor(WhereClause.prototype, function WhereClause(table, index, orCollection) {
            this.db = db;
            this._ctx = {
                table: table,
                index: index === ":id" ? null : index,
                or: orCollection
            };
            this._cmp = this._ascending = cmp;
            this._descending = function (a, b) { return cmp(b, a); };
            this._max = function (a, b) { return cmp(a, b) > 0 ? a : b; };
            this._min = function (a, b) { return cmp(a, b) < 0 ? a : b; };
            this._IDBKeyRange = db._deps.IDBKeyRange;
            if (!this._IDBKeyRange)
                throw new exceptions.MissingAPI();
        });
    }

    function eventRejectHandler(reject) {
        return wrap(function (event) {
            preventDefault(event);
            reject(event.target.error);
            return false;
        });
    }
    function preventDefault(event) {
        if (event.stopPropagation)
            event.stopPropagation();
        if (event.preventDefault)
            event.preventDefault();
    }

    var DEXIE_STORAGE_MUTATED_EVENT_NAME = 'storagemutated';
    var STORAGE_MUTATED_DOM_EVENT_NAME = 'x-storagemutated-1';
    var globalEvents = Events(null, DEXIE_STORAGE_MUTATED_EVENT_NAME);

    var Transaction =  (function () {
        function Transaction() {
        }
        Transaction.prototype._lock = function () {
            assert(!PSD.global);
            ++this._reculock;
            if (this._reculock === 1 && !PSD.global)
                PSD.lockOwnerFor = this;
            return this;
        };
        Transaction.prototype._unlock = function () {
            assert(!PSD.global);
            if (--this._reculock === 0) {
                if (!PSD.global)
                    PSD.lockOwnerFor = null;
                while (this._blockedFuncs.length > 0 && !this._locked()) {
                    var fnAndPSD = this._blockedFuncs.shift();
                    try {
                        usePSD(fnAndPSD[1], fnAndPSD[0]);
                    }
                    catch (e) { }
                }
            }
            return this;
        };
        Transaction.prototype._locked = function () {
            return this._reculock && PSD.lockOwnerFor !== this;
        };
        Transaction.prototype.create = function (idbtrans) {
            var _this = this;
            if (!this.mode)
                return this;
            var idbdb = this.db.idbdb;
            var dbOpenError = this.db._state.dbOpenError;
            assert(!this.idbtrans);
            if (!idbtrans && !idbdb) {
                switch (dbOpenError && dbOpenError.name) {
                    case "DatabaseClosedError":
                        throw new exceptions.DatabaseClosed(dbOpenError);
                    case "MissingAPIError":
                        throw new exceptions.MissingAPI(dbOpenError.message, dbOpenError);
                    default:
                        throw new exceptions.OpenFailed(dbOpenError);
                }
            }
            if (!this.active)
                throw new exceptions.TransactionInactive();
            assert(this._completion._state === null);
            idbtrans = this.idbtrans = idbtrans ||
                (this.db.core
                    ? this.db.core.transaction(this.storeNames, this.mode, { durability: this.chromeTransactionDurability })
                    : idbdb.transaction(this.storeNames, this.mode, { durability: this.chromeTransactionDurability }));
            idbtrans.onerror = wrap(function (ev) {
                preventDefault(ev);
                _this._reject(idbtrans.error);
            });
            idbtrans.onabort = wrap(function (ev) {
                preventDefault(ev);
                _this.active && _this._reject(new exceptions.Abort(idbtrans.error));
                _this.active = false;
                _this.on("abort").fire(ev);
            });
            idbtrans.oncomplete = wrap(function () {
                _this.active = false;
                _this._resolve();
                if ('mutatedParts' in idbtrans) {
                    globalEvents.storagemutated.fire(idbtrans["mutatedParts"]);
                }
            });
            return this;
        };
        Transaction.prototype._promise = function (mode, fn, bWriteLock) {
            var _this = this;
            if (mode === 'readwrite' && this.mode !== 'readwrite')
                return rejection(new exceptions.ReadOnly("Transaction is readonly"));
            if (!this.active)
                return rejection(new exceptions.TransactionInactive());
            if (this._locked()) {
                return new DexiePromise(function (resolve, reject) {
                    _this._blockedFuncs.push([function () {
                            _this._promise(mode, fn, bWriteLock).then(resolve, reject);
                        }, PSD]);
                });
            }
            else if (bWriteLock) {
                return newScope(function () {
                    var p = new DexiePromise(function (resolve, reject) {
                        _this._lock();
                        var rv = fn(resolve, reject, _this);
                        if (rv && rv.then)
                            rv.then(resolve, reject);
                    });
                    p.finally(function () { return _this._unlock(); });
                    p._lib = true;
                    return p;
                });
            }
            else {
                var p = new DexiePromise(function (resolve, reject) {
                    var rv = fn(resolve, reject, _this);
                    if (rv && rv.then)
                        rv.then(resolve, reject);
                });
                p._lib = true;
                return p;
            }
        };
        Transaction.prototype._root = function () {
            return this.parent ? this.parent._root() : this;
        };
        Transaction.prototype.waitFor = function (promiseLike) {
            var root = this._root();
            var promise = DexiePromise.resolve(promiseLike);
            if (root._waitingFor) {
                root._waitingFor = root._waitingFor.then(function () { return promise; });
            }
            else {
                root._waitingFor = promise;
                root._waitingQueue = [];
                var store = root.idbtrans.objectStore(root.storeNames[0]);
                (function spin() {
                    ++root._spinCount;
                    while (root._waitingQueue.length)
                        (root._waitingQueue.shift())();
                    if (root._waitingFor)
                        store.get(-Infinity).onsuccess = spin;
                }());
            }
            var currentWaitPromise = root._waitingFor;
            return new DexiePromise(function (resolve, reject) {
                promise.then(function (res) { return root._waitingQueue.push(wrap(resolve.bind(null, res))); }, function (err) { return root._waitingQueue.push(wrap(reject.bind(null, err))); }).finally(function () {
                    if (root._waitingFor === currentWaitPromise) {
                        root._waitingFor = null;
                    }
                });
            });
        };
        Transaction.prototype.abort = function () {
            if (this.active) {
                this.active = false;
                if (this.idbtrans)
                    this.idbtrans.abort();
                this._reject(new exceptions.Abort());
            }
        };
        Transaction.prototype.table = function (tableName) {
            var memoizedTables = (this._memoizedTables || (this._memoizedTables = {}));
            if (hasOwn(memoizedTables, tableName))
                return memoizedTables[tableName];
            var tableSchema = this.schema[tableName];
            if (!tableSchema) {
                throw new exceptions.NotFound("Table " + tableName + " not part of transaction");
            }
            var transactionBoundTable = new this.db.Table(tableName, tableSchema, this);
            transactionBoundTable.core = this.db.core.table(tableName);
            memoizedTables[tableName] = transactionBoundTable;
            return transactionBoundTable;
        };
        return Transaction;
    }());

    function createTransactionConstructor(db) {
        return makeClassConstructor(Transaction.prototype, function Transaction(mode, storeNames, dbschema, chromeTransactionDurability, parent) {
            var _this = this;
            this.db = db;
            this.mode = mode;
            this.storeNames = storeNames;
            this.schema = dbschema;
            this.chromeTransactionDurability = chromeTransactionDurability;
            this.idbtrans = null;
            this.on = Events(this, "complete", "error", "abort");
            this.parent = parent || null;
            this.active = true;
            this._reculock = 0;
            this._blockedFuncs = [];
            this._resolve = null;
            this._reject = null;
            this._waitingFor = null;
            this._waitingQueue = null;
            this._spinCount = 0;
            this._completion = new DexiePromise(function (resolve, reject) {
                _this._resolve = resolve;
                _this._reject = reject;
            });
            this._completion.then(function () {
                _this.active = false;
                _this.on.complete.fire();
            }, function (e) {
                var wasActive = _this.active;
                _this.active = false;
                _this.on.error.fire(e);
                _this.parent ?
                    _this.parent._reject(e) :
                    wasActive && _this.idbtrans && _this.idbtrans.abort();
                return rejection(e);
            });
        });
    }

    function createIndexSpec(name, keyPath, unique, multi, auto, compound, isPrimKey) {
        return {
            name: name,
            keyPath: keyPath,
            unique: unique,
            multi: multi,
            auto: auto,
            compound: compound,
            src: (unique && !isPrimKey ? '&' : '') + (multi ? '*' : '') + (auto ? "++" : "") + nameFromKeyPath(keyPath)
        };
    }
    function nameFromKeyPath(keyPath) {
        return typeof keyPath === 'string' ?
            keyPath :
            keyPath ? ('[' + [].join.call(keyPath, '+') + ']') : "";
    }

    function createTableSchema(name, primKey, indexes) {
        return {
            name: name,
            primKey: primKey,
            indexes: indexes,
            mappedClass: null,
            idxByName: arrayToObject(indexes, function (index) { return [index.name, index]; })
        };
    }

    function safariMultiStoreFix(storeNames) {
        return storeNames.length === 1 ? storeNames[0] : storeNames;
    }
    var getMaxKey = function (IdbKeyRange) {
        try {
            IdbKeyRange.only([[]]);
            getMaxKey = function () { return [[]]; };
            return [[]];
        }
        catch (e) {
            getMaxKey = function () { return maxString; };
            return maxString;
        }
    };

    function getKeyExtractor(keyPath) {
        if (keyPath == null) {
            return function () { return undefined; };
        }
        else if (typeof keyPath === 'string') {
            return getSinglePathKeyExtractor(keyPath);
        }
        else {
            return function (obj) { return getByKeyPath(obj, keyPath); };
        }
    }
    function getSinglePathKeyExtractor(keyPath) {
        var split = keyPath.split('.');
        if (split.length === 1) {
            return function (obj) { return obj[keyPath]; };
        }
        else {
            return function (obj) { return getByKeyPath(obj, keyPath); };
        }
    }

    function arrayify(arrayLike) {
        return [].slice.call(arrayLike);
    }
    var _id_counter = 0;
    function getKeyPathAlias(keyPath) {
        return keyPath == null ?
            ":id" :
            typeof keyPath === 'string' ?
                keyPath :
                "[".concat(keyPath.join('+'), "]");
    }
    function createDBCore(db, IdbKeyRange, tmpTrans) {
        function extractSchema(db, trans) {
            var tables = arrayify(db.objectStoreNames);
            return {
                schema: {
                    name: db.name,
                    tables: tables.map(function (table) { return trans.objectStore(table); }).map(function (store) {
                        var keyPath = store.keyPath, autoIncrement = store.autoIncrement;
                        var compound = isArray(keyPath);
                        var outbound = keyPath == null;
                        var indexByKeyPath = {};
                        var result = {
                            name: store.name,
                            primaryKey: {
                                name: null,
                                isPrimaryKey: true,
                                outbound: outbound,
                                compound: compound,
                                keyPath: keyPath,
                                autoIncrement: autoIncrement,
                                unique: true,
                                extractKey: getKeyExtractor(keyPath)
                            },
                            indexes: arrayify(store.indexNames).map(function (indexName) { return store.index(indexName); })
                                .map(function (index) {
                                var name = index.name, unique = index.unique, multiEntry = index.multiEntry, keyPath = index.keyPath;
                                var compound = isArray(keyPath);
                                var result = {
                                    name: name,
                                    compound: compound,
                                    keyPath: keyPath,
                                    unique: unique,
                                    multiEntry: multiEntry,
                                    extractKey: getKeyExtractor(keyPath)
                                };
                                indexByKeyPath[getKeyPathAlias(keyPath)] = result;
                                return result;
                            }),
                            getIndexByKeyPath: function (keyPath) { return indexByKeyPath[getKeyPathAlias(keyPath)]; }
                        };
                        indexByKeyPath[":id"] = result.primaryKey;
                        if (keyPath != null) {
                            indexByKeyPath[getKeyPathAlias(keyPath)] = result.primaryKey;
                        }
                        return result;
                    })
                },
                hasGetAll: tables.length > 0 && ('getAll' in trans.objectStore(tables[0])) &&
                    !(typeof navigator !== 'undefined' && /Safari/.test(navigator.userAgent) &&
                        !/(Chrome\/|Edge\/)/.test(navigator.userAgent) &&
                        [].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1] < 604)
            };
        }
        function makeIDBKeyRange(range) {
            if (range.type === 3 )
                return null;
            if (range.type === 4 )
                throw new Error("Cannot convert never type to IDBKeyRange");
            var lower = range.lower, upper = range.upper, lowerOpen = range.lowerOpen, upperOpen = range.upperOpen;
            var idbRange = lower === undefined ?
                upper === undefined ?
                    null :
                    IdbKeyRange.upperBound(upper, !!upperOpen) :
                upper === undefined ?
                    IdbKeyRange.lowerBound(lower, !!lowerOpen) :
                    IdbKeyRange.bound(lower, upper, !!lowerOpen, !!upperOpen);
            return idbRange;
        }
        function createDbCoreTable(tableSchema) {
            var tableName = tableSchema.name;
            function mutate(_a) {
                var trans = _a.trans, type = _a.type, keys = _a.keys, values = _a.values, range = _a.range;
                return new Promise(function (resolve, reject) {
                    resolve = wrap(resolve);
                    var store = trans.objectStore(tableName);
                    var outbound = store.keyPath == null;
                    var isAddOrPut = type === "put" || type === "add";
                    if (!isAddOrPut && type !== 'delete' && type !== 'deleteRange')
                        throw new Error("Invalid operation type: " + type);
                    var length = (keys || values || { length: 1 }).length;
                    if (keys && values && keys.length !== values.length) {
                        throw new Error("Given keys array must have same length as given values array.");
                    }
                    if (length === 0)
                        return resolve({ numFailures: 0, failures: {}, results: [], lastResult: undefined });
                    var req;
                    var reqs = [];
                    var failures = [];
                    var numFailures = 0;
                    var errorHandler = function (event) {
                        ++numFailures;
                        preventDefault(event);
                    };
                    if (type === 'deleteRange') {
                        if (range.type === 4 )
                            return resolve({ numFailures: numFailures, failures: failures, results: [], lastResult: undefined });
                        if (range.type === 3 )
                            reqs.push(req = store.clear());
                        else
                            reqs.push(req = store.delete(makeIDBKeyRange(range)));
                    }
                    else {
                        var _a = isAddOrPut ?
                            outbound ?
                                [values, keys] :
                                [values, null] :
                            [keys, null], args1 = _a[0], args2 = _a[1];
                        if (isAddOrPut) {
                            for (var i = 0; i < length; ++i) {
                                reqs.push(req = (args2 && args2[i] !== undefined ?
                                    store[type](args1[i], args2[i]) :
                                    store[type](args1[i])));
                                req.onerror = errorHandler;
                            }
                        }
                        else {
                            for (var i = 0; i < length; ++i) {
                                reqs.push(req = store[type](args1[i]));
                                req.onerror = errorHandler;
                            }
                        }
                    }
                    var done = function (event) {
                        var lastResult = event.target.result;
                        reqs.forEach(function (req, i) { return req.error != null && (failures[i] = req.error); });
                        resolve({
                            numFailures: numFailures,
                            failures: failures,
                            results: type === "delete" ? keys : reqs.map(function (req) { return req.result; }),
                            lastResult: lastResult
                        });
                    };
                    req.onerror = function (event) {
                        errorHandler(event);
                        done(event);
                    };
                    req.onsuccess = done;
                });
            }
            function openCursor(_a) {
                var trans = _a.trans, values = _a.values, query = _a.query, reverse = _a.reverse, unique = _a.unique;
                return new Promise(function (resolve, reject) {
                    resolve = wrap(resolve);
                    var index = query.index, range = query.range;
                    var store = trans.objectStore(tableName);
                    var source = index.isPrimaryKey ?
                        store :
                        store.index(index.name);
                    var direction = reverse ?
                        unique ?
                            "prevunique" :
                            "prev" :
                        unique ?
                            "nextunique" :
                            "next";
                    var req = values || !('openKeyCursor' in source) ?
                        source.openCursor(makeIDBKeyRange(range), direction) :
                        source.openKeyCursor(makeIDBKeyRange(range), direction);
                    req.onerror = eventRejectHandler(reject);
                    req.onsuccess = wrap(function (ev) {
                        var cursor = req.result;
                        if (!cursor) {
                            resolve(null);
                            return;
                        }
                        cursor.___id = ++_id_counter;
                        cursor.done = false;
                        var _cursorContinue = cursor.continue.bind(cursor);
                        var _cursorContinuePrimaryKey = cursor.continuePrimaryKey;
                        if (_cursorContinuePrimaryKey)
                            _cursorContinuePrimaryKey = _cursorContinuePrimaryKey.bind(cursor);
                        var _cursorAdvance = cursor.advance.bind(cursor);
                        var doThrowCursorIsNotStarted = function () { throw new Error("Cursor not started"); };
                        var doThrowCursorIsStopped = function () { throw new Error("Cursor not stopped"); };
                        cursor.trans = trans;
                        cursor.stop = cursor.continue = cursor.continuePrimaryKey = cursor.advance = doThrowCursorIsNotStarted;
                        cursor.fail = wrap(reject);
                        cursor.next = function () {
                            var _this = this;
                            var gotOne = 1;
                            return this.start(function () { return gotOne-- ? _this.continue() : _this.stop(); }).then(function () { return _this; });
                        };
                        cursor.start = function (callback) {
                            var iterationPromise = new Promise(function (resolveIteration, rejectIteration) {
                                resolveIteration = wrap(resolveIteration);
                                req.onerror = eventRejectHandler(rejectIteration);
                                cursor.fail = rejectIteration;
                                cursor.stop = function (value) {
                                    cursor.stop = cursor.continue = cursor.continuePrimaryKey = cursor.advance = doThrowCursorIsStopped;
                                    resolveIteration(value);
                                };
                            });
                            var guardedCallback = function () {
                                if (req.result) {
                                    try {
                                        callback();
                                    }
                                    catch (err) {
                                        cursor.fail(err);
                                    }
                                }
                                else {
                                    cursor.done = true;
                                    cursor.start = function () { throw new Error("Cursor behind last entry"); };
                                    cursor.stop();
                                }
                            };
                            req.onsuccess = wrap(function (ev) {
                                req.onsuccess = guardedCallback;
                                guardedCallback();
                            });
                            cursor.continue = _cursorContinue;
                            cursor.continuePrimaryKey = _cursorContinuePrimaryKey;
                            cursor.advance = _cursorAdvance;
                            guardedCallback();
                            return iterationPromise;
                        };
                        resolve(cursor);
                    }, reject);
                });
            }
            function query(hasGetAll) {
                return function (request) {
                    return new Promise(function (resolve, reject) {
                        resolve = wrap(resolve);
                        var trans = request.trans, values = request.values, limit = request.limit, query = request.query;
                        var nonInfinitLimit = limit === Infinity ? undefined : limit;
                        var index = query.index, range = query.range;
                        var store = trans.objectStore(tableName);
                        var source = index.isPrimaryKey ? store : store.index(index.name);
                        var idbKeyRange = makeIDBKeyRange(range);
                        if (limit === 0)
                            return resolve({ result: [] });
                        if (hasGetAll) {
                            var req = values ?
                                source.getAll(idbKeyRange, nonInfinitLimit) :
                                source.getAllKeys(idbKeyRange, nonInfinitLimit);
                            req.onsuccess = function (event) { return resolve({ result: event.target.result }); };
                            req.onerror = eventRejectHandler(reject);
                        }
                        else {
                            var count_1 = 0;
                            var req_1 = values || !('openKeyCursor' in source) ?
                                source.openCursor(idbKeyRange) :
                                source.openKeyCursor(idbKeyRange);
                            var result_1 = [];
                            req_1.onsuccess = function (event) {
                                var cursor = req_1.result;
                                if (!cursor)
                                    return resolve({ result: result_1 });
                                result_1.push(values ? cursor.value : cursor.primaryKey);
                                if (++count_1 === limit)
                                    return resolve({ result: result_1 });
                                cursor.continue();
                            };
                            req_1.onerror = eventRejectHandler(reject);
                        }
                    });
                };
            }
            return {
                name: tableName,
                schema: tableSchema,
                mutate: mutate,
                getMany: function (_a) {
                    var trans = _a.trans, keys = _a.keys;
                    return new Promise(function (resolve, reject) {
                        resolve = wrap(resolve);
                        var store = trans.objectStore(tableName);
                        var length = keys.length;
                        var result = new Array(length);
                        var keyCount = 0;
                        var callbackCount = 0;
                        var req;
                        var successHandler = function (event) {
                            var req = event.target;
                            if ((result[req._pos] = req.result) != null)
                                ;
                            if (++callbackCount === keyCount)
                                resolve(result);
                        };
                        var errorHandler = eventRejectHandler(reject);
                        for (var i = 0; i < length; ++i) {
                            var key = keys[i];
                            if (key != null) {
                                req = store.get(keys[i]);
                                req._pos = i;
                                req.onsuccess = successHandler;
                                req.onerror = errorHandler;
                                ++keyCount;
                            }
                        }
                        if (keyCount === 0)
                            resolve(result);
                    });
                },
                get: function (_a) {
                    var trans = _a.trans, key = _a.key;
                    return new Promise(function (resolve, reject) {
                        resolve = wrap(resolve);
                        var store = trans.objectStore(tableName);
                        var req = store.get(key);
                        req.onsuccess = function (event) { return resolve(event.target.result); };
                        req.onerror = eventRejectHandler(reject);
                    });
                },
                query: query(hasGetAll),
                openCursor: openCursor,
                count: function (_a) {
                    var query = _a.query, trans = _a.trans;
                    var index = query.index, range = query.range;
                    return new Promise(function (resolve, reject) {
                        var store = trans.objectStore(tableName);
                        var source = index.isPrimaryKey ? store : store.index(index.name);
                        var idbKeyRange = makeIDBKeyRange(range);
                        var req = idbKeyRange ? source.count(idbKeyRange) : source.count();
                        req.onsuccess = wrap(function (ev) { return resolve(ev.target.result); });
                        req.onerror = eventRejectHandler(reject);
                    });
                }
            };
        }
        var _a = extractSchema(db, tmpTrans), schema = _a.schema, hasGetAll = _a.hasGetAll;
        var tables = schema.tables.map(function (tableSchema) { return createDbCoreTable(tableSchema); });
        var tableMap = {};
        tables.forEach(function (table) { return tableMap[table.name] = table; });
        return {
            stack: "dbcore",
            transaction: db.transaction.bind(db),
            table: function (name) {
                var result = tableMap[name];
                if (!result)
                    throw new Error("Table '".concat(name, "' not found"));
                return tableMap[name];
            },
            MIN_KEY: -Infinity,
            MAX_KEY: getMaxKey(IdbKeyRange),
            schema: schema
        };
    }

    function createMiddlewareStack(stackImpl, middlewares) {
        return middlewares.reduce(function (down, _a) {
            var create = _a.create;
            return (__assign(__assign({}, down), create(down)));
        }, stackImpl);
    }
    function createMiddlewareStacks(middlewares, idbdb, _a, tmpTrans) {
        var IDBKeyRange = _a.IDBKeyRange; _a.indexedDB;
        var dbcore = createMiddlewareStack(createDBCore(idbdb, IDBKeyRange, tmpTrans), middlewares.dbcore);
        return {
            dbcore: dbcore
        };
    }
    function generateMiddlewareStacks(db, tmpTrans) {
        var idbdb = tmpTrans.db;
        var stacks = createMiddlewareStacks(db._middlewares, idbdb, db._deps, tmpTrans);
        db.core = stacks.dbcore;
        db.tables.forEach(function (table) {
            var tableName = table.name;
            if (db.core.schema.tables.some(function (tbl) { return tbl.name === tableName; })) {
                table.core = db.core.table(tableName);
                if (db[tableName] instanceof db.Table) {
                    db[tableName].core = table.core;
                }
            }
        });
    }

    function setApiOnPlace(db, objs, tableNames, dbschema) {
        tableNames.forEach(function (tableName) {
            var schema = dbschema[tableName];
            objs.forEach(function (obj) {
                var propDesc = getPropertyDescriptor(obj, tableName);
                if (!propDesc || ("value" in propDesc && propDesc.value === undefined)) {
                    if (obj === db.Transaction.prototype || obj instanceof db.Transaction) {
                        setProp(obj, tableName, {
                            get: function () { return this.table(tableName); },
                            set: function (value) {
                                defineProperty(this, tableName, { value: value, writable: true, configurable: true, enumerable: true });
                            }
                        });
                    }
                    else {
                        obj[tableName] = new db.Table(tableName, schema);
                    }
                }
            });
        });
    }
    function removeTablesApi(db, objs) {
        objs.forEach(function (obj) {
            for (var key in obj) {
                if (obj[key] instanceof db.Table)
                    delete obj[key];
            }
        });
    }
    function lowerVersionFirst(a, b) {
        return a._cfg.version - b._cfg.version;
    }
    function runUpgraders(db, oldVersion, idbUpgradeTrans, reject) {
        var globalSchema = db._dbSchema;
        if (idbUpgradeTrans.objectStoreNames.contains('$meta') && !globalSchema.$meta) {
            globalSchema.$meta = createTableSchema("$meta", parseIndexSyntax("")[0], []);
            db._storeNames.push('$meta');
        }
        var trans = db._createTransaction('readwrite', db._storeNames, globalSchema);
        trans.create(idbUpgradeTrans);
        trans._completion.catch(reject);
        var rejectTransaction = trans._reject.bind(trans);
        var transless = PSD.transless || PSD;
        newScope(function () {
            PSD.trans = trans;
            PSD.transless = transless;
            if (oldVersion === 0) {
                keys(globalSchema).forEach(function (tableName) {
                    createTable(idbUpgradeTrans, tableName, globalSchema[tableName].primKey, globalSchema[tableName].indexes);
                });
                generateMiddlewareStacks(db, idbUpgradeTrans);
                DexiePromise.follow(function () { return db.on.populate.fire(trans); }).catch(rejectTransaction);
            }
            else {
                generateMiddlewareStacks(db, idbUpgradeTrans);
                return getExistingVersion(db, trans, oldVersion)
                    .then(function (oldVersion) { return updateTablesAndIndexes(db, oldVersion, trans, idbUpgradeTrans); })
                    .catch(rejectTransaction);
            }
        });
    }
    function patchCurrentVersion(db, idbUpgradeTrans) {
        createMissingTables(db._dbSchema, idbUpgradeTrans);
        if (idbUpgradeTrans.db.version % 10 === 0 && !idbUpgradeTrans.objectStoreNames.contains('$meta')) {
            idbUpgradeTrans.db.createObjectStore('$meta').add(Math.ceil((idbUpgradeTrans.db.version / 10) - 1), 'version');
        }
        var globalSchema = buildGlobalSchema(db, db.idbdb, idbUpgradeTrans);
        adjustToExistingIndexNames(db, db._dbSchema, idbUpgradeTrans);
        var diff = getSchemaDiff(globalSchema, db._dbSchema);
        var _loop_1 = function (tableChange) {
            if (tableChange.change.length || tableChange.recreate) {
                console.warn("Unable to patch indexes of table ".concat(tableChange.name, " because it has changes on the type of index or primary key."));
                return { value: void 0 };
            }
            var store = idbUpgradeTrans.objectStore(tableChange.name);
            tableChange.add.forEach(function (idx) {
                if (debug)
                    console.debug("Dexie upgrade patch: Creating missing index ".concat(tableChange.name, ".").concat(idx.src));
                addIndex(store, idx);
            });
        };
        for (var _i = 0, _a = diff.change; _i < _a.length; _i++) {
            var tableChange = _a[_i];
            var state_1 = _loop_1(tableChange);
            if (typeof state_1 === "object")
                return state_1.value;
        }
    }
    function getExistingVersion(db, trans, oldVersion) {
        if (trans.storeNames.includes('$meta')) {
            return trans.table('$meta').get('version').then(function (metaVersion) {
                return metaVersion != null ? metaVersion : oldVersion;
            });
        }
        else {
            return DexiePromise.resolve(oldVersion);
        }
    }
    function updateTablesAndIndexes(db, oldVersion, trans, idbUpgradeTrans) {
        var queue = [];
        var versions = db._versions;
        var globalSchema = db._dbSchema = buildGlobalSchema(db, db.idbdb, idbUpgradeTrans);
        var versToRun = versions.filter(function (v) { return v._cfg.version >= oldVersion; });
        if (versToRun.length === 0) {
            return DexiePromise.resolve();
        }
        versToRun.forEach(function (version) {
            queue.push(function () {
                var oldSchema = globalSchema;
                var newSchema = version._cfg.dbschema;
                adjustToExistingIndexNames(db, oldSchema, idbUpgradeTrans);
                adjustToExistingIndexNames(db, newSchema, idbUpgradeTrans);
                globalSchema = db._dbSchema = newSchema;
                var diff = getSchemaDiff(oldSchema, newSchema);
                diff.add.forEach(function (tuple) {
                    createTable(idbUpgradeTrans, tuple[0], tuple[1].primKey, tuple[1].indexes);
                });
                diff.change.forEach(function (change) {
                    if (change.recreate) {
                        throw new exceptions.Upgrade("Not yet support for changing primary key");
                    }
                    else {
                        var store_1 = idbUpgradeTrans.objectStore(change.name);
                        change.add.forEach(function (idx) { return addIndex(store_1, idx); });
                        change.change.forEach(function (idx) {
                            store_1.deleteIndex(idx.name);
                            addIndex(store_1, idx);
                        });
                        change.del.forEach(function (idxName) { return store_1.deleteIndex(idxName); });
                    }
                });
                var contentUpgrade = version._cfg.contentUpgrade;
                if (contentUpgrade && version._cfg.version > oldVersion) {
                    generateMiddlewareStacks(db, idbUpgradeTrans);
                    trans._memoizedTables = {};
                    var upgradeSchema_1 = shallowClone(newSchema);
                    diff.del.forEach(function (table) {
                        upgradeSchema_1[table] = oldSchema[table];
                    });
                    removeTablesApi(db, [db.Transaction.prototype]);
                    setApiOnPlace(db, [db.Transaction.prototype], keys(upgradeSchema_1), upgradeSchema_1);
                    trans.schema = upgradeSchema_1;
                    var contentUpgradeIsAsync_1 = isAsyncFunction(contentUpgrade);
                    if (contentUpgradeIsAsync_1) {
                        incrementExpectedAwaits();
                    }
                    var returnValue_1;
                    var promiseFollowed = DexiePromise.follow(function () {
                        returnValue_1 = contentUpgrade(trans);
                        if (returnValue_1) {
                            if (contentUpgradeIsAsync_1) {
                                var decrementor = decrementExpectedAwaits.bind(null, null);
                                returnValue_1.then(decrementor, decrementor);
                            }
                        }
                    });
                    return (returnValue_1 && typeof returnValue_1.then === 'function' ?
                        DexiePromise.resolve(returnValue_1) : promiseFollowed.then(function () { return returnValue_1; }));
                }
            });
            queue.push(function (idbtrans) {
                var newSchema = version._cfg.dbschema;
                deleteRemovedTables(newSchema, idbtrans);
                removeTablesApi(db, [db.Transaction.prototype]);
                setApiOnPlace(db, [db.Transaction.prototype], db._storeNames, db._dbSchema);
                trans.schema = db._dbSchema;
            });
            queue.push(function (idbtrans) {
                if (db.idbdb.objectStoreNames.contains('$meta')) {
                    if (Math.ceil(db.idbdb.version / 10) === version._cfg.version) {
                        db.idbdb.deleteObjectStore('$meta');
                        delete db._dbSchema.$meta;
                        db._storeNames = db._storeNames.filter(function (name) { return name !== '$meta'; });
                    }
                    else {
                        idbtrans.objectStore('$meta').put(version._cfg.version, 'version');
                    }
                }
            });
        });
        function runQueue() {
            return queue.length ? DexiePromise.resolve(queue.shift()(trans.idbtrans)).then(runQueue) :
                DexiePromise.resolve();
        }
        return runQueue().then(function () {
            createMissingTables(globalSchema, idbUpgradeTrans);
        });
    }
    function getSchemaDiff(oldSchema, newSchema) {
        var diff = {
            del: [],
            add: [],
            change: []
        };
        var table;
        for (table in oldSchema) {
            if (!newSchema[table])
                diff.del.push(table);
        }
        for (table in newSchema) {
            var oldDef = oldSchema[table], newDef = newSchema[table];
            if (!oldDef) {
                diff.add.push([table, newDef]);
            }
            else {
                var change = {
                    name: table,
                    def: newDef,
                    recreate: false,
                    del: [],
                    add: [],
                    change: []
                };
                if ((
                '' + (oldDef.primKey.keyPath || '')) !== ('' + (newDef.primKey.keyPath || '')) ||
                    (oldDef.primKey.auto !== newDef.primKey.auto)) {
                    change.recreate = true;
                    diff.change.push(change);
                }
                else {
                    var oldIndexes = oldDef.idxByName;
                    var newIndexes = newDef.idxByName;
                    var idxName = void 0;
                    for (idxName in oldIndexes) {
                        if (!newIndexes[idxName])
                            change.del.push(idxName);
                    }
                    for (idxName in newIndexes) {
                        var oldIdx = oldIndexes[idxName], newIdx = newIndexes[idxName];
                        if (!oldIdx)
                            change.add.push(newIdx);
                        else if (oldIdx.src !== newIdx.src)
                            change.change.push(newIdx);
                    }
                    if (change.del.length > 0 || change.add.length > 0 || change.change.length > 0) {
                        diff.change.push(change);
                    }
                }
            }
        }
        return diff;
    }
    function createTable(idbtrans, tableName, primKey, indexes) {
        var store = idbtrans.db.createObjectStore(tableName, primKey.keyPath ?
            { keyPath: primKey.keyPath, autoIncrement: primKey.auto } :
            { autoIncrement: primKey.auto });
        indexes.forEach(function (idx) { return addIndex(store, idx); });
        return store;
    }
    function createMissingTables(newSchema, idbtrans) {
        keys(newSchema).forEach(function (tableName) {
            if (!idbtrans.db.objectStoreNames.contains(tableName)) {
                if (debug)
                    console.debug('Dexie: Creating missing table', tableName);
                createTable(idbtrans, tableName, newSchema[tableName].primKey, newSchema[tableName].indexes);
            }
        });
    }
    function deleteRemovedTables(newSchema, idbtrans) {
        [].slice.call(idbtrans.db.objectStoreNames).forEach(function (storeName) {
            return newSchema[storeName] == null && idbtrans.db.deleteObjectStore(storeName);
        });
    }
    function addIndex(store, idx) {
        store.createIndex(idx.name, idx.keyPath, { unique: idx.unique, multiEntry: idx.multi });
    }
    function buildGlobalSchema(db, idbdb, tmpTrans) {
        var globalSchema = {};
        var dbStoreNames = slice(idbdb.objectStoreNames, 0);
        dbStoreNames.forEach(function (storeName) {
            var store = tmpTrans.objectStore(storeName);
            var keyPath = store.keyPath;
            var primKey = createIndexSpec(nameFromKeyPath(keyPath), keyPath || "", true, false, !!store.autoIncrement, keyPath && typeof keyPath !== "string", true);
            var indexes = [];
            for (var j = 0; j < store.indexNames.length; ++j) {
                var idbindex = store.index(store.indexNames[j]);
                keyPath = idbindex.keyPath;
                var index = createIndexSpec(idbindex.name, keyPath, !!idbindex.unique, !!idbindex.multiEntry, false, keyPath && typeof keyPath !== "string", false);
                indexes.push(index);
            }
            globalSchema[storeName] = createTableSchema(storeName, primKey, indexes);
        });
        return globalSchema;
    }
    function readGlobalSchema(db, idbdb, tmpTrans) {
        db.verno = idbdb.version / 10;
        var globalSchema = db._dbSchema = buildGlobalSchema(db, idbdb, tmpTrans);
        db._storeNames = slice(idbdb.objectStoreNames, 0);
        setApiOnPlace(db, [db._allTables], keys(globalSchema), globalSchema);
    }
    function verifyInstalledSchema(db, tmpTrans) {
        var installedSchema = buildGlobalSchema(db, db.idbdb, tmpTrans);
        var diff = getSchemaDiff(installedSchema, db._dbSchema);
        return !(diff.add.length || diff.change.some(function (ch) { return ch.add.length || ch.change.length; }));
    }
    function adjustToExistingIndexNames(db, schema, idbtrans) {
        var storeNames = idbtrans.db.objectStoreNames;
        for (var i = 0; i < storeNames.length; ++i) {
            var storeName = storeNames[i];
            var store = idbtrans.objectStore(storeName);
            db._hasGetAll = 'getAll' in store;
            for (var j = 0; j < store.indexNames.length; ++j) {
                var indexName = store.indexNames[j];
                var keyPath = store.index(indexName).keyPath;
                var dexieName = typeof keyPath === 'string' ? keyPath : "[" + slice(keyPath).join('+') + "]";
                if (schema[storeName]) {
                    var indexSpec = schema[storeName].idxByName[dexieName];
                    if (indexSpec) {
                        indexSpec.name = indexName;
                        delete schema[storeName].idxByName[dexieName];
                        schema[storeName].idxByName[indexName] = indexSpec;
                    }
                }
            }
        }
        if (typeof navigator !== 'undefined' && /Safari/.test(navigator.userAgent) &&
            !/(Chrome\/|Edge\/)/.test(navigator.userAgent) &&
            _global.WorkerGlobalScope && _global instanceof _global.WorkerGlobalScope &&
            [].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1] < 604) {
            db._hasGetAll = false;
        }
    }
    function parseIndexSyntax(primKeyAndIndexes) {
        return primKeyAndIndexes.split(',').map(function (index, indexNum) {
            index = index.trim();
            var name = index.replace(/([&*]|\+\+)/g, "");
            var keyPath = /^\[/.test(name) ? name.match(/^\[(.*)\]$/)[1].split('+') : name;
            return createIndexSpec(name, keyPath || null, /\&/.test(index), /\*/.test(index), /\+\+/.test(index), isArray(keyPath), indexNum === 0);
        });
    }

    var Version =  (function () {
        function Version() {
        }
        Version.prototype._parseStoresSpec = function (stores, outSchema) {
            keys(stores).forEach(function (tableName) {
                if (stores[tableName] !== null) {
                    var indexes = parseIndexSyntax(stores[tableName]);
                    var primKey = indexes.shift();
                    primKey.unique = true;
                    if (primKey.multi)
                        throw new exceptions.Schema("Primary key cannot be multi-valued");
                    indexes.forEach(function (idx) {
                        if (idx.auto)
                            throw new exceptions.Schema("Only primary key can be marked as autoIncrement (++)");
                        if (!idx.keyPath)
                            throw new exceptions.Schema("Index must have a name and cannot be an empty string");
                    });
                    outSchema[tableName] = createTableSchema(tableName, primKey, indexes);
                }
            });
        };
        Version.prototype.stores = function (stores) {
            var db = this.db;
            this._cfg.storesSource = this._cfg.storesSource ?
                extend(this._cfg.storesSource, stores) :
                stores;
            var versions = db._versions;
            var storesSpec = {};
            var dbschema = {};
            versions.forEach(function (version) {
                extend(storesSpec, version._cfg.storesSource);
                dbschema = (version._cfg.dbschema = {});
                version._parseStoresSpec(storesSpec, dbschema);
            });
            db._dbSchema = dbschema;
            removeTablesApi(db, [db._allTables, db, db.Transaction.prototype]);
            setApiOnPlace(db, [db._allTables, db, db.Transaction.prototype, this._cfg.tables], keys(dbschema), dbschema);
            db._storeNames = keys(dbschema);
            return this;
        };
        Version.prototype.upgrade = function (upgradeFunction) {
            this._cfg.contentUpgrade = promisableChain(this._cfg.contentUpgrade || nop, upgradeFunction);
            return this;
        };
        return Version;
    }());

    function createVersionConstructor(db) {
        return makeClassConstructor(Version.prototype, function Version(versionNumber) {
            this.db = db;
            this._cfg = {
                version: versionNumber,
                storesSource: null,
                dbschema: {},
                tables: {},
                contentUpgrade: null
            };
        });
    }

    function getDbNamesTable(indexedDB, IDBKeyRange) {
        var dbNamesDB = indexedDB["_dbNamesDB"];
        if (!dbNamesDB) {
            dbNamesDB = indexedDB["_dbNamesDB"] = new Dexie$1(DBNAMES_DB, {
                addons: [],
                indexedDB: indexedDB,
                IDBKeyRange: IDBKeyRange,
            });
            dbNamesDB.version(1).stores({ dbnames: "name" });
        }
        return dbNamesDB.table("dbnames");
    }
    function hasDatabasesNative(indexedDB) {
        return indexedDB && typeof indexedDB.databases === "function";
    }
    function getDatabaseNames(_a) {
        var indexedDB = _a.indexedDB, IDBKeyRange = _a.IDBKeyRange;
        return hasDatabasesNative(indexedDB)
            ? Promise.resolve(indexedDB.databases()).then(function (infos) {
                return infos
                    .map(function (info) { return info.name; })
                    .filter(function (name) { return name !== DBNAMES_DB; });
            })
            : getDbNamesTable(indexedDB, IDBKeyRange).toCollection().primaryKeys();
    }
    function _onDatabaseCreated(_a, name) {
        var indexedDB = _a.indexedDB, IDBKeyRange = _a.IDBKeyRange;
        !hasDatabasesNative(indexedDB) &&
            name !== DBNAMES_DB &&
            getDbNamesTable(indexedDB, IDBKeyRange).put({ name: name }).catch(nop);
    }
    function _onDatabaseDeleted(_a, name) {
        var indexedDB = _a.indexedDB, IDBKeyRange = _a.IDBKeyRange;
        !hasDatabasesNative(indexedDB) &&
            name !== DBNAMES_DB &&
            getDbNamesTable(indexedDB, IDBKeyRange).delete(name).catch(nop);
    }

    function vip(fn) {
        return newScope(function () {
            PSD.letThrough = true;
            return fn();
        });
    }

    function idbReady() {
        var isSafari = !navigator.userAgentData &&
            /Safari\//.test(navigator.userAgent) &&
            !/Chrom(e|ium)\//.test(navigator.userAgent);
        if (!isSafari || !indexedDB.databases)
            return Promise.resolve();
        var intervalId;
        return new Promise(function (resolve) {
            var tryIdb = function () { return indexedDB.databases().finally(resolve); };
            intervalId = setInterval(tryIdb, 100);
            tryIdb();
        }).finally(function () { return clearInterval(intervalId); });
    }

    var _a;
    function isEmptyRange(node) {
        return !("from" in node);
    }
    var RangeSet = function (fromOrTree, to) {
        if (this) {
            extend(this, arguments.length ? { d: 1, from: fromOrTree, to: arguments.length > 1 ? to : fromOrTree } : { d: 0 });
        }
        else {
            var rv = new RangeSet();
            if (fromOrTree && ("d" in fromOrTree)) {
                extend(rv, fromOrTree);
            }
            return rv;
        }
    };
    props(RangeSet.prototype, (_a = {
            add: function (rangeSet) {
                mergeRanges(this, rangeSet);
                return this;
            },
            addKey: function (key) {
                addRange(this, key, key);
                return this;
            },
            addKeys: function (keys) {
                var _this = this;
                keys.forEach(function (key) { return addRange(_this, key, key); });
                return this;
            },
            hasKey: function (key) {
                var node = getRangeSetIterator(this).next(key).value;
                return node && cmp(node.from, key) <= 0 && cmp(node.to, key) >= 0;
            }
        },
        _a[iteratorSymbol] = function () {
            return getRangeSetIterator(this);
        },
        _a));
    function addRange(target, from, to) {
        var diff = cmp(from, to);
        if (isNaN(diff))
            return;
        if (diff > 0)
            throw RangeError();
        if (isEmptyRange(target))
            return extend(target, { from: from, to: to, d: 1 });
        var left = target.l;
        var right = target.r;
        if (cmp(to, target.from) < 0) {
            left
                ? addRange(left, from, to)
                : (target.l = { from: from, to: to, d: 1, l: null, r: null });
            return rebalance(target);
        }
        if (cmp(from, target.to) > 0) {
            right
                ? addRange(right, from, to)
                : (target.r = { from: from, to: to, d: 1, l: null, r: null });
            return rebalance(target);
        }
        if (cmp(from, target.from) < 0) {
            target.from = from;
            target.l = null;
            target.d = right ? right.d + 1 : 1;
        }
        if (cmp(to, target.to) > 0) {
            target.to = to;
            target.r = null;
            target.d = target.l ? target.l.d + 1 : 1;
        }
        var rightWasCutOff = !target.r;
        if (left && !target.l) {
            mergeRanges(target, left);
        }
        if (right && rightWasCutOff) {
            mergeRanges(target, right);
        }
    }
    function mergeRanges(target, newSet) {
        function _addRangeSet(target, _a) {
            var from = _a.from, to = _a.to, l = _a.l, r = _a.r;
            addRange(target, from, to);
            if (l)
                _addRangeSet(target, l);
            if (r)
                _addRangeSet(target, r);
        }
        if (!isEmptyRange(newSet))
            _addRangeSet(target, newSet);
    }
    function rangesOverlap(rangeSet1, rangeSet2) {
        var i1 = getRangeSetIterator(rangeSet2);
        var nextResult1 = i1.next();
        if (nextResult1.done)
            return false;
        var a = nextResult1.value;
        var i2 = getRangeSetIterator(rangeSet1);
        var nextResult2 = i2.next(a.from);
        var b = nextResult2.value;
        while (!nextResult1.done && !nextResult2.done) {
            if (cmp(b.from, a.to) <= 0 && cmp(b.to, a.from) >= 0)
                return true;
            cmp(a.from, b.from) < 0
                ? (a = (nextResult1 = i1.next(b.from)).value)
                : (b = (nextResult2 = i2.next(a.from)).value);
        }
        return false;
    }
    function getRangeSetIterator(node) {
        var state = isEmptyRange(node) ? null : { s: 0, n: node };
        return {
            next: function (key) {
                var keyProvided = arguments.length > 0;
                while (state) {
                    switch (state.s) {
                        case 0:
                            state.s = 1;
                            if (keyProvided) {
                                while (state.n.l && cmp(key, state.n.from) < 0)
                                    state = { up: state, n: state.n.l, s: 1 };
                            }
                            else {
                                while (state.n.l)
                                    state = { up: state, n: state.n.l, s: 1 };
                            }
                        case 1:
                            state.s = 2;
                            if (!keyProvided || cmp(key, state.n.to) <= 0)
                                return { value: state.n, done: false };
                        case 2:
                            if (state.n.r) {
                                state.s = 3;
                                state = { up: state, n: state.n.r, s: 0 };
                                continue;
                            }
                        case 3:
                            state = state.up;
                    }
                }
                return { done: true };
            },
        };
    }
    function rebalance(target) {
        var _a, _b;
        var diff = (((_a = target.r) === null || _a === void 0 ? void 0 : _a.d) || 0) - (((_b = target.l) === null || _b === void 0 ? void 0 : _b.d) || 0);
        var r = diff > 1 ? "r" : diff < -1 ? "l" : "";
        if (r) {
            var l = r === "r" ? "l" : "r";
            var rootClone = __assign({}, target);
            var oldRootRight = target[r];
            target.from = oldRootRight.from;
            target.to = oldRootRight.to;
            target[r] = oldRootRight[r];
            rootClone[r] = oldRootRight[l];
            target[l] = rootClone;
            rootClone.d = computeDepth(rootClone);
        }
        target.d = computeDepth(target);
    }
    function computeDepth(_a) {
        var r = _a.r, l = _a.l;
        return (r ? (l ? Math.max(r.d, l.d) : r.d) : l ? l.d : 0) + 1;
    }

    function extendObservabilitySet(target, newSet) {
        keys(newSet).forEach(function (part) {
            if (target[part])
                mergeRanges(target[part], newSet[part]);
            else
                target[part] = cloneSimpleObjectTree(newSet[part]);
        });
        return target;
    }

    function obsSetsOverlap(os1, os2) {
        return os1.all || os2.all || Object.keys(os1).some(function (key) { return os2[key] && rangesOverlap(os2[key], os1[key]); });
    }

    var cache = {};

    var unsignaledParts = {};
    var isTaskEnqueued = false;
    function signalSubscribersLazily(part, optimistic) {
        extendObservabilitySet(unsignaledParts, part);
        if (!isTaskEnqueued) {
            isTaskEnqueued = true;
            setTimeout(function () {
                isTaskEnqueued = false;
                var parts = unsignaledParts;
                unsignaledParts = {};
                signalSubscribersNow(parts, false);
            }, 0);
        }
    }
    function signalSubscribersNow(updatedParts, deleteAffectedCacheEntries) {
        if (deleteAffectedCacheEntries === void 0) { deleteAffectedCacheEntries = false; }
        var queriesToSignal = new Set();
        if (updatedParts.all) {
            for (var _i = 0, _a = Object.values(cache); _i < _a.length; _i++) {
                var tblCache = _a[_i];
                collectTableSubscribers(tblCache, updatedParts, queriesToSignal, deleteAffectedCacheEntries);
            }
        }
        else {
            for (var key in updatedParts) {
                var parts = /^idb\:\/\/(.*)\/(.*)\//.exec(key);
                if (parts) {
                    var dbName = parts[1], tableName = parts[2];
                    var tblCache = cache["idb://".concat(dbName, "/").concat(tableName)];
                    if (tblCache)
                        collectTableSubscribers(tblCache, updatedParts, queriesToSignal, deleteAffectedCacheEntries);
                }
            }
        }
        queriesToSignal.forEach(function (requery) { return requery(); });
    }
    function collectTableSubscribers(tblCache, updatedParts, outQueriesToSignal, deleteAffectedCacheEntries) {
        var updatedEntryLists = [];
        for (var _i = 0, _a = Object.entries(tblCache.queries.query); _i < _a.length; _i++) {
            var _b = _a[_i], indexName = _b[0], entries = _b[1];
            var filteredEntries = [];
            for (var _c = 0, entries_1 = entries; _c < entries_1.length; _c++) {
                var entry = entries_1[_c];
                if (obsSetsOverlap(updatedParts, entry.obsSet)) {
                    entry.subscribers.forEach(function (requery) { return outQueriesToSignal.add(requery); });
                }
                else if (deleteAffectedCacheEntries) {
                    filteredEntries.push(entry);
                }
            }
            if (deleteAffectedCacheEntries)
                updatedEntryLists.push([indexName, filteredEntries]);
        }
        if (deleteAffectedCacheEntries) {
            for (var _d = 0, updatedEntryLists_1 = updatedEntryLists; _d < updatedEntryLists_1.length; _d++) {
                var _e = updatedEntryLists_1[_d], indexName = _e[0], filteredEntries = _e[1];
                tblCache.queries.query[indexName] = filteredEntries;
            }
        }
    }

    function dexieOpen(db) {
        var state = db._state;
        var indexedDB = db._deps.indexedDB;
        if (state.isBeingOpened || db.idbdb)
            return state.dbReadyPromise.then(function () { return state.dbOpenError ?
                rejection(state.dbOpenError) :
                db; });
        state.isBeingOpened = true;
        state.dbOpenError = null;
        state.openComplete = false;
        var openCanceller = state.openCanceller;
        var nativeVerToOpen = Math.round(db.verno * 10);
        var schemaPatchMode = false;
        function throwIfCancelled() {
            if (state.openCanceller !== openCanceller)
                throw new exceptions.DatabaseClosed('db.open() was cancelled');
        }
        var resolveDbReady = state.dbReadyResolve,
        upgradeTransaction = null, wasCreated = false;
        var tryOpenDB = function () { return new DexiePromise(function (resolve, reject) {
            throwIfCancelled();
            if (!indexedDB)
                throw new exceptions.MissingAPI();
            var dbName = db.name;
            var req = state.autoSchema || !nativeVerToOpen ?
                indexedDB.open(dbName) :
                indexedDB.open(dbName, nativeVerToOpen);
            if (!req)
                throw new exceptions.MissingAPI();
            req.onerror = eventRejectHandler(reject);
            req.onblocked = wrap(db._fireOnBlocked);
            req.onupgradeneeded = wrap(function (e) {
                upgradeTransaction = req.transaction;
                if (state.autoSchema && !db._options.allowEmptyDB) {
                    req.onerror = preventDefault;
                    upgradeTransaction.abort();
                    req.result.close();
                    var delreq = indexedDB.deleteDatabase(dbName);
                    delreq.onsuccess = delreq.onerror = wrap(function () {
                        reject(new exceptions.NoSuchDatabase("Database ".concat(dbName, " doesnt exist")));
                    });
                }
                else {
                    upgradeTransaction.onerror = eventRejectHandler(reject);
                    var oldVer = e.oldVersion > Math.pow(2, 62) ? 0 : e.oldVersion;
                    wasCreated = oldVer < 1;
                    db.idbdb = req.result;
                    if (schemaPatchMode) {
                        patchCurrentVersion(db, upgradeTransaction);
                    }
                    runUpgraders(db, oldVer / 10, upgradeTransaction, reject);
                }
            }, reject);
            req.onsuccess = wrap(function () {
                upgradeTransaction = null;
                var idbdb = db.idbdb = req.result;
                var objectStoreNames = slice(idbdb.objectStoreNames);
                if (objectStoreNames.length > 0)
                    try {
                        var tmpTrans = idbdb.transaction(safariMultiStoreFix(objectStoreNames), 'readonly');
                        if (state.autoSchema)
                            readGlobalSchema(db, idbdb, tmpTrans);
                        else {
                            adjustToExistingIndexNames(db, db._dbSchema, tmpTrans);
                            if (!verifyInstalledSchema(db, tmpTrans) && !schemaPatchMode) {
                                console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this.");
                                idbdb.close();
                                nativeVerToOpen = idbdb.version + 1;
                                schemaPatchMode = true;
                                return resolve(tryOpenDB());
                            }
                        }
                        generateMiddlewareStacks(db, tmpTrans);
                    }
                    catch (e) {
                    }
                connections.push(db);
                idbdb.onversionchange = wrap(function (ev) {
                    state.vcFired = true;
                    db.on("versionchange").fire(ev);
                });
                idbdb.onclose = wrap(function (ev) {
                    db.on("close").fire(ev);
                });
                if (wasCreated)
                    _onDatabaseCreated(db._deps, dbName);
                resolve();
            }, reject);
        }).catch(function (err) {
            switch (err === null || err === void 0 ? void 0 : err.name) {
                case "UnknownError":
                    if (state.PR1398_maxLoop > 0) {
                        state.PR1398_maxLoop--;
                        console.warn('Dexie: Workaround for Chrome UnknownError on open()');
                        return tryOpenDB();
                    }
                    break;
                case "VersionError":
                    if (nativeVerToOpen > 0) {
                        nativeVerToOpen = 0;
                        return tryOpenDB();
                    }
                    break;
            }
            return DexiePromise.reject(err);
        }); };
        return DexiePromise.race([
            openCanceller,
            (typeof navigator === 'undefined' ? DexiePromise.resolve() : idbReady()).then(tryOpenDB)
        ]).then(function () {
            throwIfCancelled();
            state.onReadyBeingFired = [];
            return DexiePromise.resolve(vip(function () { return db.on.ready.fire(db.vip); })).then(function fireRemainders() {
                if (state.onReadyBeingFired.length > 0) {
                    var remainders_1 = state.onReadyBeingFired.reduce(promisableChain, nop);
                    state.onReadyBeingFired = [];
                    return DexiePromise.resolve(vip(function () { return remainders_1(db.vip); })).then(fireRemainders);
                }
            });
        }).finally(function () {
            if (state.openCanceller === openCanceller) {
                state.onReadyBeingFired = null;
                state.isBeingOpened = false;
            }
        }).catch(function (err) {
            state.dbOpenError = err;
            try {
                upgradeTransaction && upgradeTransaction.abort();
            }
            catch (_a) { }
            if (openCanceller === state.openCanceller) {
                db._close();
            }
            return rejection(err);
        }).finally(function () {
            state.openComplete = true;
            resolveDbReady();
        }).then(function () {
            if (wasCreated) {
                var everything_1 = {};
                db.tables.forEach(function (table) {
                    table.schema.indexes.forEach(function (idx) {
                        if (idx.name)
                            everything_1["idb://".concat(db.name, "/").concat(table.name, "/").concat(idx.name)] = new RangeSet(-Infinity, [[[]]]);
                    });
                    everything_1["idb://".concat(db.name, "/").concat(table.name, "/")] = everything_1["idb://".concat(db.name, "/").concat(table.name, "/:dels")] = new RangeSet(-Infinity, [[[]]]);
                });
                globalEvents(DEXIE_STORAGE_MUTATED_EVENT_NAME).fire(everything_1);
                signalSubscribersNow(everything_1, true);
            }
            return db;
        });
    }

    function awaitIterator(iterator) {
        var callNext = function (result) { return iterator.next(result); }, doThrow = function (error) { return iterator.throw(error); }, onSuccess = step(callNext), onError = step(doThrow);
        function step(getNext) {
            return function (val) {
                var next = getNext(val), value = next.value;
                return next.done ? value :
                    (!value || typeof value.then !== 'function' ?
                        isArray(value) ? Promise.all(value).then(onSuccess, onError) : onSuccess(value) :
                        value.then(onSuccess, onError));
            };
        }
        return step(callNext)();
    }

    function extractTransactionArgs(mode, _tableArgs_, scopeFunc) {
        var i = arguments.length;
        if (i < 2)
            throw new exceptions.InvalidArgument("Too few arguments");
        var args = new Array(i - 1);
        while (--i)
            args[i - 1] = arguments[i];
        scopeFunc = args.pop();
        var tables = flatten(args);
        return [mode, tables, scopeFunc];
    }
    function enterTransactionScope(db, mode, storeNames, parentTransaction, scopeFunc) {
        return DexiePromise.resolve().then(function () {
            var transless = PSD.transless || PSD;
            var trans = db._createTransaction(mode, storeNames, db._dbSchema, parentTransaction);
            trans.explicit = true;
            var zoneProps = {
                trans: trans,
                transless: transless
            };
            if (parentTransaction) {
                trans.idbtrans = parentTransaction.idbtrans;
            }
            else {
                try {
                    trans.create();
                    trans.idbtrans._explicit = true;
                    db._state.PR1398_maxLoop = 3;
                }
                catch (ex) {
                    if (ex.name === errnames.InvalidState && db.isOpen() && --db._state.PR1398_maxLoop > 0) {
                        console.warn('Dexie: Need to reopen db');
                        db.close({ disableAutoOpen: false });
                        return db.open().then(function () { return enterTransactionScope(db, mode, storeNames, null, scopeFunc); });
                    }
                    return rejection(ex);
                }
            }
            var scopeFuncIsAsync = isAsyncFunction(scopeFunc);
            if (scopeFuncIsAsync) {
                incrementExpectedAwaits();
            }
            var returnValue;
            var promiseFollowed = DexiePromise.follow(function () {
                returnValue = scopeFunc.call(trans, trans);
                if (returnValue) {
                    if (scopeFuncIsAsync) {
                        var decrementor = decrementExpectedAwaits.bind(null, null);
                        returnValue.then(decrementor, decrementor);
                    }
                    else if (typeof returnValue.next === 'function' && typeof returnValue.throw === 'function') {
                        returnValue = awaitIterator(returnValue);
                    }
                }
            }, zoneProps);
            return (returnValue && typeof returnValue.then === 'function' ?
                DexiePromise.resolve(returnValue).then(function (x) { return trans.active ?
                    x
                    : rejection(new exceptions.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn")); })
                : promiseFollowed.then(function () { return returnValue; })).then(function (x) {
                if (parentTransaction)
                    trans._resolve();
                return trans._completion.then(function () { return x; });
            }).catch(function (e) {
                trans._reject(e);
                return rejection(e);
            });
        });
    }

    function pad(a, value, count) {
        var result = isArray(a) ? a.slice() : [a];
        for (var i = 0; i < count; ++i)
            result.push(value);
        return result;
    }
    function createVirtualIndexMiddleware(down) {
        return __assign(__assign({}, down), { table: function (tableName) {
                var table = down.table(tableName);
                var schema = table.schema;
                var indexLookup = {};
                var allVirtualIndexes = [];
                function addVirtualIndexes(keyPath, keyTail, lowLevelIndex) {
                    var keyPathAlias = getKeyPathAlias(keyPath);
                    var indexList = (indexLookup[keyPathAlias] = indexLookup[keyPathAlias] || []);
                    var keyLength = keyPath == null ? 0 : typeof keyPath === 'string' ? 1 : keyPath.length;
                    var isVirtual = keyTail > 0;
                    var virtualIndex = __assign(__assign({}, lowLevelIndex), { name: isVirtual
                            ? "".concat(keyPathAlias, "(virtual-from:").concat(lowLevelIndex.name, ")")
                            : lowLevelIndex.name, lowLevelIndex: lowLevelIndex, isVirtual: isVirtual, keyTail: keyTail, keyLength: keyLength, extractKey: getKeyExtractor(keyPath), unique: !isVirtual && lowLevelIndex.unique });
                    indexList.push(virtualIndex);
                    if (!virtualIndex.isPrimaryKey) {
                        allVirtualIndexes.push(virtualIndex);
                    }
                    if (keyLength > 1) {
                        var virtualKeyPath = keyLength === 2 ?
                            keyPath[0] :
                            keyPath.slice(0, keyLength - 1);
                        addVirtualIndexes(virtualKeyPath, keyTail + 1, lowLevelIndex);
                    }
                    indexList.sort(function (a, b) { return a.keyTail - b.keyTail; });
                    return virtualIndex;
                }
                var primaryKey = addVirtualIndexes(schema.primaryKey.keyPath, 0, schema.primaryKey);
                indexLookup[":id"] = [primaryKey];
                for (var _i = 0, _a = schema.indexes; _i < _a.length; _i++) {
                    var index = _a[_i];
                    addVirtualIndexes(index.keyPath, 0, index);
                }
                function findBestIndex(keyPath) {
                    var result = indexLookup[getKeyPathAlias(keyPath)];
                    return result && result[0];
                }
                function translateRange(range, keyTail) {
                    return {
                        type: range.type === 1  ?
                            2  :
                            range.type,
                        lower: pad(range.lower, range.lowerOpen ? down.MAX_KEY : down.MIN_KEY, keyTail),
                        lowerOpen: true,
                        upper: pad(range.upper, range.upperOpen ? down.MIN_KEY : down.MAX_KEY, keyTail),
                        upperOpen: true
                    };
                }
                function translateRequest(req) {
                    var index = req.query.index;
                    return index.isVirtual ? __assign(__assign({}, req), { query: {
                            index: index.lowLevelIndex,
                            range: translateRange(req.query.range, index.keyTail)
                        } }) : req;
                }
                var result = __assign(__assign({}, table), { schema: __assign(__assign({}, schema), { primaryKey: primaryKey, indexes: allVirtualIndexes, getIndexByKeyPath: findBestIndex }), count: function (req) {
                        return table.count(translateRequest(req));
                    }, query: function (req) {
                        return table.query(translateRequest(req));
                    }, openCursor: function (req) {
                        var _a = req.query.index, keyTail = _a.keyTail, isVirtual = _a.isVirtual, keyLength = _a.keyLength;
                        if (!isVirtual)
                            return table.openCursor(req);
                        function createVirtualCursor(cursor) {
                            function _continue(key) {
                                key != null ?
                                    cursor.continue(pad(key, req.reverse ? down.MAX_KEY : down.MIN_KEY, keyTail)) :
                                    req.unique ?
                                        cursor.continue(cursor.key.slice(0, keyLength)
                                            .concat(req.reverse
                                            ? down.MIN_KEY
                                            : down.MAX_KEY, keyTail)) :
                                        cursor.continue();
                            }
                            var virtualCursor = Object.create(cursor, {
                                continue: { value: _continue },
                                continuePrimaryKey: {
                                    value: function (key, primaryKey) {
                                        cursor.continuePrimaryKey(pad(key, down.MAX_KEY, keyTail), primaryKey);
                                    }
                                },
                                primaryKey: {
                                    get: function () {
                                        return cursor.primaryKey;
                                    }
                                },
                                key: {
                                    get: function () {
                                        var key = cursor.key;
                                        return keyLength === 1 ?
                                            key[0] :
                                            key.slice(0, keyLength);
                                    }
                                },
                                value: {
                                    get: function () {
                                        return cursor.value;
                                    }
                                }
                            });
                            return virtualCursor;
                        }
                        return table.openCursor(translateRequest(req))
                            .then(function (cursor) { return cursor && createVirtualCursor(cursor); });
                    } });
                return result;
            } });
    }
    var virtualIndexMiddleware = {
        stack: "dbcore",
        name: "VirtualIndexMiddleware",
        level: 1,
        create: createVirtualIndexMiddleware
    };

    function getObjectDiff(a, b, rv, prfx) {
        rv = rv || {};
        prfx = prfx || '';
        keys(a).forEach(function (prop) {
            if (!hasOwn(b, prop)) {
                rv[prfx + prop] = undefined;
            }
            else {
                var ap = a[prop], bp = b[prop];
                if (typeof ap === 'object' && typeof bp === 'object' && ap && bp) {
                    var apTypeName = toStringTag(ap);
                    var bpTypeName = toStringTag(bp);
                    if (apTypeName !== bpTypeName) {
                        rv[prfx + prop] = b[prop];
                    }
                    else if (apTypeName === 'Object') {
                        getObjectDiff(ap, bp, rv, prfx + prop + '.');
                    }
                    else if (ap !== bp) {
                        rv[prfx + prop] = b[prop];
                    }
                }
                else if (ap !== bp)
                    rv[prfx + prop] = b[prop];
            }
        });
        keys(b).forEach(function (prop) {
            if (!hasOwn(a, prop)) {
                rv[prfx + prop] = b[prop];
            }
        });
        return rv;
    }

    function getEffectiveKeys(primaryKey, req) {
        if (req.type === 'delete')
            return req.keys;
        return req.keys || req.values.map(primaryKey.extractKey);
    }

    var hooksMiddleware = {
        stack: "dbcore",
        name: "HooksMiddleware",
        level: 2,
        create: function (downCore) { return (__assign(__assign({}, downCore), { table: function (tableName) {
                var downTable = downCore.table(tableName);
                var primaryKey = downTable.schema.primaryKey;
                var tableMiddleware = __assign(__assign({}, downTable), { mutate: function (req) {
                        var dxTrans = PSD.trans;
                        var _a = dxTrans.table(tableName).hook, deleting = _a.deleting, creating = _a.creating, updating = _a.updating;
                        switch (req.type) {
                            case 'add':
                                if (creating.fire === nop)
                                    break;
                                return dxTrans._promise('readwrite', function () { return addPutOrDelete(req); }, true);
                            case 'put':
                                if (creating.fire === nop && updating.fire === nop)
                                    break;
                                return dxTrans._promise('readwrite', function () { return addPutOrDelete(req); }, true);
                            case 'delete':
                                if (deleting.fire === nop)
                                    break;
                                return dxTrans._promise('readwrite', function () { return addPutOrDelete(req); }, true);
                            case 'deleteRange':
                                if (deleting.fire === nop)
                                    break;
                                return dxTrans._promise('readwrite', function () { return deleteRange(req); }, true);
                        }
                        return downTable.mutate(req);
                        function addPutOrDelete(req) {
                            var dxTrans = PSD.trans;
                            var keys = req.keys || getEffectiveKeys(primaryKey, req);
                            if (!keys)
                                throw new Error("Keys missing");
                            req = req.type === 'add' || req.type === 'put' ? __assign(__assign({}, req), { keys: keys }) : __assign({}, req);
                            if (req.type !== 'delete')
                                req.values = __spreadArray([], req.values, true);
                            if (req.keys)
                                req.keys = __spreadArray([], req.keys, true);
                            return getExistingValues(downTable, req, keys).then(function (existingValues) {
                                var contexts = keys.map(function (key, i) {
                                    var existingValue = existingValues[i];
                                    var ctx = { onerror: null, onsuccess: null };
                                    if (req.type === 'delete') {
                                        deleting.fire.call(ctx, key, existingValue, dxTrans);
                                    }
                                    else if (req.type === 'add' || existingValue === undefined) {
                                        var generatedPrimaryKey = creating.fire.call(ctx, key, req.values[i], dxTrans);
                                        if (key == null && generatedPrimaryKey != null) {
                                            key = generatedPrimaryKey;
                                            req.keys[i] = key;
                                            if (!primaryKey.outbound) {
                                                setByKeyPath(req.values[i], primaryKey.keyPath, key);
                                            }
                                        }
                                    }
                                    else {
                                        var objectDiff = getObjectDiff(existingValue, req.values[i]);
                                        var additionalChanges_1 = updating.fire.call(ctx, objectDiff, key, existingValue, dxTrans);
                                        if (additionalChanges_1) {
                                            var requestedValue_1 = req.values[i];
                                            Object.keys(additionalChanges_1).forEach(function (keyPath) {
                                                if (hasOwn(requestedValue_1, keyPath)) {
                                                    requestedValue_1[keyPath] = additionalChanges_1[keyPath];
                                                }
                                                else {
                                                    setByKeyPath(requestedValue_1, keyPath, additionalChanges_1[keyPath]);
                                                }
                                            });
                                        }
                                    }
                                    return ctx;
                                });
                                return downTable.mutate(req).then(function (_a) {
                                    var failures = _a.failures, results = _a.results, numFailures = _a.numFailures, lastResult = _a.lastResult;
                                    for (var i = 0; i < keys.length; ++i) {
                                        var primKey = results ? results[i] : keys[i];
                                        var ctx = contexts[i];
                                        if (primKey == null) {
                                            ctx.onerror && ctx.onerror(failures[i]);
                                        }
                                        else {
                                            ctx.onsuccess && ctx.onsuccess(req.type === 'put' && existingValues[i] ?
                                                req.values[i] :
                                                primKey
                                            );
                                        }
                                    }
                                    return { failures: failures, results: results, numFailures: numFailures, lastResult: lastResult };
                                }).catch(function (error) {
                                    contexts.forEach(function (ctx) { return ctx.onerror && ctx.onerror(error); });
                                    return Promise.reject(error);
                                });
                            });
                        }
                        function deleteRange(req) {
                            return deleteNextChunk(req.trans, req.range, 10000);
                        }
                        function deleteNextChunk(trans, range, limit) {
                            return downTable.query({ trans: trans, values: false, query: { index: primaryKey, range: range }, limit: limit })
                                .then(function (_a) {
                                var result = _a.result;
                                return addPutOrDelete({ type: 'delete', keys: result, trans: trans }).then(function (res) {
                                    if (res.numFailures > 0)
                                        return Promise.reject(res.failures[0]);
                                    if (result.length < limit) {
                                        return { failures: [], numFailures: 0, lastResult: undefined };
                                    }
                                    else {
                                        return deleteNextChunk(trans, __assign(__assign({}, range), { lower: result[result.length - 1], lowerOpen: true }), limit);
                                    }
                                });
                            });
                        }
                    } });
                return tableMiddleware;
            } })); }
    };
    function getExistingValues(table, req, effectiveKeys) {
        return req.type === "add"
            ? Promise.resolve([])
            : table.getMany({ trans: req.trans, keys: effectiveKeys, cache: "immutable" });
    }

    function getFromTransactionCache(keys, cache, clone) {
        try {
            if (!cache)
                return null;
            if (cache.keys.length < keys.length)
                return null;
            var result = [];
            for (var i = 0, j = 0; i < cache.keys.length && j < keys.length; ++i) {
                if (cmp(cache.keys[i], keys[j]) !== 0)
                    continue;
                result.push(clone ? deepClone(cache.values[i]) : cache.values[i]);
                ++j;
            }
            return result.length === keys.length ? result : null;
        }
        catch (_a) {
            return null;
        }
    }
    var cacheExistingValuesMiddleware = {
        stack: "dbcore",
        level: -1,
        create: function (core) {
            return {
                table: function (tableName) {
                    var table = core.table(tableName);
                    return __assign(__assign({}, table), { getMany: function (req) {
                            if (!req.cache) {
                                return table.getMany(req);
                            }
                            var cachedResult = getFromTransactionCache(req.keys, req.trans["_cache"], req.cache === "clone");
                            if (cachedResult) {
                                return DexiePromise.resolve(cachedResult);
                            }
                            return table.getMany(req).then(function (res) {
                                req.trans["_cache"] = {
                                    keys: req.keys,
                                    values: req.cache === "clone" ? deepClone(res) : res,
                                };
                                return res;
                            });
                        }, mutate: function (req) {
                            if (req.type !== "add")
                                req.trans["_cache"] = null;
                            return table.mutate(req);
                        } });
                },
            };
        },
    };

    function isCachableContext(ctx, table) {
        return (ctx.trans.mode === 'readonly' &&
            !!ctx.subscr &&
            !ctx.trans.explicit &&
            ctx.trans.db._options.cache !== 'disabled' &&
            !table.schema.primaryKey.outbound);
    }

    function isCachableRequest(type, req) {
        switch (type) {
            case 'query':
                return req.values && !req.unique;
            case 'get':
                return false;
            case 'getMany':
                return false;
            case 'count':
                return false;
            case 'openCursor':
                return false;
        }
    }

    var observabilityMiddleware = {
        stack: "dbcore",
        level: 0,
        name: "Observability",
        create: function (core) {
            var dbName = core.schema.name;
            var FULL_RANGE = new RangeSet(core.MIN_KEY, core.MAX_KEY);
            return __assign(__assign({}, core), { transaction: function (stores, mode, options) {
                    if (PSD.subscr && mode !== 'readonly') {
                        throw new exceptions.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(PSD.querier));
                    }
                    return core.transaction(stores, mode, options);
                }, table: function (tableName) {
                    var table = core.table(tableName);
                    var schema = table.schema;
                    var primaryKey = schema.primaryKey, indexes = schema.indexes;
                    var extractKey = primaryKey.extractKey, outbound = primaryKey.outbound;
                    var indexesWithAutoIncPK = primaryKey.autoIncrement && indexes.filter(function (index) { return index.compound && index.keyPath.includes(primaryKey.keyPath); });
                    var tableClone = __assign(__assign({}, table), { mutate: function (req) {
                            var _a, _b;
                            var trans = req.trans;
                            var mutatedParts = req.mutatedParts || (req.mutatedParts = {});
                            var getRangeSet = function (indexName) {
                                var part = "idb://".concat(dbName, "/").concat(tableName, "/").concat(indexName);
                                return (mutatedParts[part] ||
                                    (mutatedParts[part] = new RangeSet()));
                            };
                            var pkRangeSet = getRangeSet("");
                            var delsRangeSet = getRangeSet(":dels");
                            var type = req.type;
                            var _c = req.type === "deleteRange"
                                ? [req.range]
                                : req.type === "delete"
                                    ? [req.keys]
                                    : req.values.length < 50
                                        ? [getEffectiveKeys(primaryKey, req).filter(function (id) { return id; }), req.values]
                                        : [], keys = _c[0], newObjs = _c[1];
                            var oldCache = req.trans["_cache"];
                            if (isArray(keys)) {
                                pkRangeSet.addKeys(keys);
                                var oldObjs = type === 'delete' || keys.length === newObjs.length ? getFromTransactionCache(keys, oldCache) : null;
                                if (!oldObjs) {
                                    delsRangeSet.addKeys(keys);
                                }
                                if (oldObjs || newObjs) {
                                    trackAffectedIndexes(getRangeSet, schema, oldObjs, newObjs);
                                }
                            }
                            else if (keys) {
                                var range = {
                                    from: (_a = keys.lower) !== null && _a !== void 0 ? _a : core.MIN_KEY,
                                    to: (_b = keys.upper) !== null && _b !== void 0 ? _b : core.MAX_KEY
                                };
                                delsRangeSet.add(range);
                                pkRangeSet.add(range);
                            }
                            else {
                                pkRangeSet.add(FULL_RANGE);
                                delsRangeSet.add(FULL_RANGE);
                                schema.indexes.forEach(function (idx) { return getRangeSet(idx.name).add(FULL_RANGE); });
                            }
                            return table.mutate(req).then(function (res) {
                                if (keys && (req.type === 'add' || req.type === 'put')) {
                                    pkRangeSet.addKeys(res.results);
                                    if (indexesWithAutoIncPK) {
                                        indexesWithAutoIncPK.forEach(function (idx) {
                                            var idxVals = req.values.map(function (v) { return idx.extractKey(v); });
                                            var pkPos = idx.keyPath.findIndex(function (prop) { return prop === primaryKey.keyPath; });
                                            for (var i = 0, len = res.results.length; i < len; ++i) {
                                                idxVals[i][pkPos] = res.results[i];
                                            }
                                            getRangeSet(idx.name).addKeys(idxVals);
                                        });
                                    }
                                }
                                trans.mutatedParts = extendObservabilitySet(trans.mutatedParts || {}, mutatedParts);
                                return res;
                            });
                        } });
                    var getRange = function (_a) {
                        var _b, _c;
                        var _d = _a.query, index = _d.index, range = _d.range;
                        return [
                            index,
                            new RangeSet((_b = range.lower) !== null && _b !== void 0 ? _b : core.MIN_KEY, (_c = range.upper) !== null && _c !== void 0 ? _c : core.MAX_KEY),
                        ];
                    };
                    var readSubscribers = {
                        get: function (req) { return [primaryKey, new RangeSet(req.key)]; },
                        getMany: function (req) { return [primaryKey, new RangeSet().addKeys(req.keys)]; },
                        count: getRange,
                        query: getRange,
                        openCursor: getRange,
                    };
                    keys(readSubscribers).forEach(function (method) {
                        tableClone[method] = function (req) {
                            var subscr = PSD.subscr;
                            var isLiveQuery = !!subscr;
                            var cachable = isCachableContext(PSD, table) && isCachableRequest(method, req);
                            var obsSet = cachable
                                ? req.obsSet = {}
                                : subscr;
                            if (isLiveQuery) {
                                var getRangeSet = function (indexName) {
                                    var part = "idb://".concat(dbName, "/").concat(tableName, "/").concat(indexName);
                                    return (obsSet[part] ||
                                        (obsSet[part] = new RangeSet()));
                                };
                                var pkRangeSet_1 = getRangeSet("");
                                var delsRangeSet_1 = getRangeSet(":dels");
                                var _a = readSubscribers[method](req), queriedIndex = _a[0], queriedRanges = _a[1];
                                if (method === 'query' && queriedIndex.isPrimaryKey && !req.values) {
                                    delsRangeSet_1.add(queriedRanges);
                                }
                                else {
                                    getRangeSet(queriedIndex.name || "").add(queriedRanges);
                                }
                                if (!queriedIndex.isPrimaryKey) {
                                    if (method === "count") {
                                        delsRangeSet_1.add(FULL_RANGE);
                                    }
                                    else {
                                        var keysPromise_1 = method === "query" &&
                                            outbound &&
                                            req.values &&
                                            table.query(__assign(__assign({}, req), { values: false }));
                                        return table[method].apply(this, arguments).then(function (res) {
                                            if (method === "query") {
                                                if (outbound && req.values) {
                                                    return keysPromise_1.then(function (_a) {
                                                        var resultingKeys = _a.result;
                                                        pkRangeSet_1.addKeys(resultingKeys);
                                                        return res;
                                                    });
                                                }
                                                var pKeys = req.values
                                                    ? res.result.map(extractKey)
                                                    : res.result;
                                                if (req.values) {
                                                    pkRangeSet_1.addKeys(pKeys);
                                                }
                                                else {
                                                    delsRangeSet_1.addKeys(pKeys);
                                                }
                                            }
                                            else if (method === "openCursor") {
                                                var cursor_1 = res;
                                                var wantValues_1 = req.values;
                                                return (cursor_1 &&
                                                    Object.create(cursor_1, {
                                                        key: {
                                                            get: function () {
                                                                delsRangeSet_1.addKey(cursor_1.primaryKey);
                                                                return cursor_1.key;
                                                            },
                                                        },
                                                        primaryKey: {
                                                            get: function () {
                                                                var pkey = cursor_1.primaryKey;
                                                                delsRangeSet_1.addKey(pkey);
                                                                return pkey;
                                                            },
                                                        },
                                                        value: {
                                                            get: function () {
                                                                wantValues_1 && pkRangeSet_1.addKey(cursor_1.primaryKey);
                                                                return cursor_1.value;
                                                            },
                                                        },
                                                    }));
                                            }
                                            return res;
                                        });
                                    }
                                }
                            }
                            return table[method].apply(this, arguments);
                        };
                    });
                    return tableClone;
                } });
        },
    };
    function trackAffectedIndexes(getRangeSet, schema, oldObjs, newObjs) {
        function addAffectedIndex(ix) {
            var rangeSet = getRangeSet(ix.name || "");
            function extractKey(obj) {
                return obj != null ? ix.extractKey(obj) : null;
            }
            var addKeyOrKeys = function (key) { return ix.multiEntry && isArray(key)
                ? key.forEach(function (key) { return rangeSet.addKey(key); })
                : rangeSet.addKey(key); };
            (oldObjs || newObjs).forEach(function (_, i) {
                var oldKey = oldObjs && extractKey(oldObjs[i]);
                var newKey = newObjs && extractKey(newObjs[i]);
                if (cmp(oldKey, newKey) !== 0) {
                    if (oldKey != null)
                        addKeyOrKeys(oldKey);
                    if (newKey != null)
                        addKeyOrKeys(newKey);
                }
            });
        }
        schema.indexes.forEach(addAffectedIndex);
    }

    function adjustOptimisticFromFailures(tblCache, req, res) {
        if (res.numFailures === 0)
            return req;
        if (req.type === 'deleteRange') {
            return null;
        }
        var numBulkOps = req.keys
            ? req.keys.length
            : 'values' in req && req.values
                ? req.values.length
                : 1;
        if (res.numFailures === numBulkOps) {
            return null;
        }
        var clone = __assign({}, req);
        if (isArray(clone.keys)) {
            clone.keys = clone.keys.filter(function (_, i) { return !(i in res.failures); });
        }
        if ('values' in clone && isArray(clone.values)) {
            clone.values = clone.values.filter(function (_, i) { return !(i in res.failures); });
        }
        return clone;
    }

    function isAboveLower(key, range) {
        return range.lower === undefined
            ? true
            : range.lowerOpen
                ? cmp(key, range.lower) > 0
                : cmp(key, range.lower) >= 0;
    }
    function isBelowUpper(key, range) {
        return range.upper === undefined
            ? true
            : range.upperOpen
                ? cmp(key, range.upper) < 0
                : cmp(key, range.upper) <= 0;
    }
    function isWithinRange(key, range) {
        return isAboveLower(key, range) && isBelowUpper(key, range);
    }

    function applyOptimisticOps(result, req, ops, table, cacheEntry, immutable) {
        if (!ops || ops.length === 0)
            return result;
        var index = req.query.index;
        var multiEntry = index.multiEntry;
        var queryRange = req.query.range;
        var primaryKey = table.schema.primaryKey;
        var extractPrimKey = primaryKey.extractKey;
        var extractIndex = index.extractKey;
        var extractLowLevelIndex = (index.lowLevelIndex || index).extractKey;
        var finalResult = ops.reduce(function (result, op) {
            var modifedResult = result;
            var includedValues = [];
            if (op.type === 'add' || op.type === 'put') {
                var includedPKs = new RangeSet();
                for (var i = op.values.length - 1; i >= 0; --i) {
                    var value = op.values[i];
                    var pk = extractPrimKey(value);
                    if (includedPKs.hasKey(pk))
                        continue;
                    var key = extractIndex(value);
                    if (multiEntry && isArray(key)
                        ? key.some(function (k) { return isWithinRange(k, queryRange); })
                        : isWithinRange(key, queryRange)) {
                        includedPKs.addKey(pk);
                        includedValues.push(value);
                    }
                }
            }
            switch (op.type) {
                case 'add': {
                    var existingKeys_1 = new RangeSet().addKeys(req.values ? result.map(function (v) { return extractPrimKey(v); }) : result);
                    modifedResult = result.concat(req.values
                        ? includedValues.filter(function (v) {
                            var key = extractPrimKey(v);
                            if (existingKeys_1.hasKey(key))
                                return false;
                            existingKeys_1.addKey(key);
                            return true;
                        })
                        : includedValues
                            .map(function (v) { return extractPrimKey(v); })
                            .filter(function (k) {
                            if (existingKeys_1.hasKey(k))
                                return false;
                            existingKeys_1.addKey(k);
                            return true;
                        }));
                    break;
                }
                case 'put': {
                    var keySet_1 = new RangeSet().addKeys(op.values.map(function (v) { return extractPrimKey(v); }));
                    modifedResult = result
                        .filter(
                    function (item) { return !keySet_1.hasKey(req.values ? extractPrimKey(item) : item); })
                        .concat(
                    req.values
                        ? includedValues
                        : includedValues.map(function (v) { return extractPrimKey(v); }));
                    break;
                }
                case 'delete':
                    var keysToDelete_1 = new RangeSet().addKeys(op.keys);
                    modifedResult = result.filter(function (item) {
                        return !keysToDelete_1.hasKey(req.values ? extractPrimKey(item) : item);
                    });
                    break;
                case 'deleteRange':
                    var range_1 = op.range;
                    modifedResult = result.filter(function (item) { return !isWithinRange(extractPrimKey(item), range_1); });
                    break;
            }
            return modifedResult;
        }, result);
        if (finalResult === result)
            return result;
        finalResult.sort(function (a, b) {
            return cmp(extractLowLevelIndex(a), extractLowLevelIndex(b)) ||
                cmp(extractPrimKey(a), extractPrimKey(b));
        });
        if (req.limit && req.limit < Infinity) {
            if (finalResult.length > req.limit) {
                finalResult.length = req.limit;
            }
            else if (result.length === req.limit && finalResult.length < req.limit) {
                cacheEntry.dirty = true;
            }
        }
        return immutable ? Object.freeze(finalResult) : finalResult;
    }

    function areRangesEqual(r1, r2) {
        return (cmp(r1.lower, r2.lower) === 0 &&
            cmp(r1.upper, r2.upper) === 0 &&
            !!r1.lowerOpen === !!r2.lowerOpen &&
            !!r1.upperOpen === !!r2.upperOpen);
    }

    function compareLowers(lower1, lower2, lowerOpen1, lowerOpen2) {
        if (lower1 === undefined)
            return lower2 !== undefined ? -1 : 0;
        if (lower2 === undefined)
            return 1;
        var c = cmp(lower1, lower2);
        if (c === 0) {
            if (lowerOpen1 && lowerOpen2)
                return 0;
            if (lowerOpen1)
                return 1;
            if (lowerOpen2)
                return -1;
        }
        return c;
    }
    function compareUppers(upper1, upper2, upperOpen1, upperOpen2) {
        if (upper1 === undefined)
            return upper2 !== undefined ? 1 : 0;
        if (upper2 === undefined)
            return -1;
        var c = cmp(upper1, upper2);
        if (c === 0) {
            if (upperOpen1 && upperOpen2)
                return 0;
            if (upperOpen1)
                return -1;
            if (upperOpen2)
                return 1;
        }
        return c;
    }
    function isSuperRange(r1, r2) {
        return (compareLowers(r1.lower, r2.lower, r1.lowerOpen, r2.lowerOpen) <= 0 &&
            compareUppers(r1.upper, r2.upper, r1.upperOpen, r2.upperOpen) >= 0);
    }

    function findCompatibleQuery(dbName, tableName, type, req) {
        var tblCache = cache["idb://".concat(dbName, "/").concat(tableName)];
        if (!tblCache)
            return [];
        var queries = tblCache.queries[type];
        if (!queries)
            return [null, false, tblCache, null];
        var indexName = req.query ? req.query.index.name : null;
        var entries = queries[indexName || ''];
        if (!entries)
            return [null, false, tblCache, null];
        switch (type) {
            case 'query':
                var equalEntry = entries.find(function (entry) {
                    return entry.req.limit === req.limit &&
                        entry.req.values === req.values &&
                        areRangesEqual(entry.req.query.range, req.query.range);
                });
                if (equalEntry)
                    return [
                        equalEntry,
                        true,
                        tblCache,
                        entries,
                    ];
                var superEntry = entries.find(function (entry) {
                    var limit = 'limit' in entry.req ? entry.req.limit : Infinity;
                    return (limit >= req.limit &&
                        (req.values ? entry.req.values : true) &&
                        isSuperRange(entry.req.query.range, req.query.range));
                });
                return [superEntry, false, tblCache, entries];
            case 'count':
                var countQuery = entries.find(function (entry) {
                    return areRangesEqual(entry.req.query.range, req.query.range);
                });
                return [countQuery, !!countQuery, tblCache, entries];
        }
    }

    function subscribeToCacheEntry(cacheEntry, container, requery, signal) {
        cacheEntry.subscribers.add(requery);
        signal.addEventListener("abort", function () {
            cacheEntry.subscribers.delete(requery);
            if (cacheEntry.subscribers.size === 0) {
                enqueForDeletion(cacheEntry, container);
            }
        });
    }
    function enqueForDeletion(cacheEntry, container) {
        setTimeout(function () {
            if (cacheEntry.subscribers.size === 0) {
                delArrayItem(container, cacheEntry);
            }
        }, 3000);
    }

    var cacheMiddleware = {
        stack: 'dbcore',
        level: 0,
        name: 'Cache',
        create: function (core) {
            var dbName = core.schema.name;
            var coreMW = __assign(__assign({}, core), { transaction: function (stores, mode, options) {
                    var idbtrans = core.transaction(stores, mode, options);
                    if (mode === 'readwrite') {
                        var ac_1 = new AbortController();
                        var signal = ac_1.signal;
                        var endTransaction = function (wasCommitted) { return function () {
                            ac_1.abort();
                            if (mode === 'readwrite') {
                                var affectedSubscribers_1 = new Set();
                                for (var _i = 0, stores_1 = stores; _i < stores_1.length; _i++) {
                                    var storeName = stores_1[_i];
                                    var tblCache = cache["idb://".concat(dbName, "/").concat(storeName)];
                                    if (tblCache) {
                                        var table = core.table(storeName);
                                        var ops = tblCache.optimisticOps.filter(function (op) { return op.trans === idbtrans; });
                                        if (idbtrans._explicit && wasCommitted && idbtrans.mutatedParts) {
                                            for (var _a = 0, _b = Object.values(tblCache.queries.query); _a < _b.length; _a++) {
                                                var entries = _b[_a];
                                                for (var _c = 0, _d = entries.slice(); _c < _d.length; _c++) {
                                                    var entry = _d[_c];
                                                    if (obsSetsOverlap(entry.obsSet, idbtrans.mutatedParts)) {
                                                        delArrayItem(entries, entry);
                                                        entry.subscribers.forEach(function (requery) { return affectedSubscribers_1.add(requery); });
                                                    }
                                                }
                                            }
                                        }
                                        else if (ops.length > 0) {
                                            tblCache.optimisticOps = tblCache.optimisticOps.filter(function (op) { return op.trans !== idbtrans; });
                                            for (var _e = 0, _f = Object.values(tblCache.queries.query); _e < _f.length; _e++) {
                                                var entries = _f[_e];
                                                for (var _g = 0, _h = entries.slice(); _g < _h.length; _g++) {
                                                    var entry = _h[_g];
                                                    if (entry.res != null &&
                                                        idbtrans.mutatedParts
    ) {
                                                        if (wasCommitted && !entry.dirty) {
                                                            var freezeResults = Object.isFrozen(entry.res);
                                                            var modRes = applyOptimisticOps(entry.res, entry.req, ops, table, entry, freezeResults);
                                                            if (entry.dirty) {
                                                                delArrayItem(entries, entry);
                                                                entry.subscribers.forEach(function (requery) { return affectedSubscribers_1.add(requery); });
                                                            }
                                                            else if (modRes !== entry.res) {
                                                                entry.res = modRes;
                                                                entry.promise = DexiePromise.resolve({ result: modRes });
                                                            }
                                                        }
                                                        else {
                                                            if (entry.dirty) {
                                                                delArrayItem(entries, entry);
                                                            }
                                                            entry.subscribers.forEach(function (requery) { return affectedSubscribers_1.add(requery); });
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                affectedSubscribers_1.forEach(function (requery) { return requery(); });
                            }
                        }; };
                        idbtrans.addEventListener('abort', endTransaction(false), {
                            signal: signal,
                        });
                        idbtrans.addEventListener('error', endTransaction(false), {
                            signal: signal,
                        });
                        idbtrans.addEventListener('complete', endTransaction(true), {
                            signal: signal,
                        });
                    }
                    return idbtrans;
                }, table: function (tableName) {
                    var downTable = core.table(tableName);
                    var primKey = downTable.schema.primaryKey;
                    var tableMW = __assign(__assign({}, downTable), { mutate: function (req) {
                            var trans = PSD.trans;
                            if (primKey.outbound ||
                                trans.db._options.cache === 'disabled' ||
                                trans.explicit ||
                                trans.idbtrans.mode !== 'readwrite'
                            ) {
                                return downTable.mutate(req);
                            }
                            var tblCache = cache["idb://".concat(dbName, "/").concat(tableName)];
                            if (!tblCache)
                                return downTable.mutate(req);
                            var promise = downTable.mutate(req);
                            if ((req.type === 'add' || req.type === 'put') && (req.values.length >= 50 || getEffectiveKeys(primKey, req).some(function (key) { return key == null; }))) {
                                promise.then(function (res) {
                                    var reqWithResolvedKeys = __assign(__assign({}, req), { values: req.values.map(function (value, i) {
                                            var _a;
                                            if (res.failures[i])
                                                return value;
                                            var valueWithKey = ((_a = primKey.keyPath) === null || _a === void 0 ? void 0 : _a.includes('.'))
                                                ? deepClone(value)
                                                : __assign({}, value);
                                            setByKeyPath(valueWithKey, primKey.keyPath, res.results[i]);
                                            return valueWithKey;
                                        }) });
                                    var adjustedReq = adjustOptimisticFromFailures(tblCache, reqWithResolvedKeys, res);
                                    tblCache.optimisticOps.push(adjustedReq);
                                    queueMicrotask(function () { return req.mutatedParts && signalSubscribersLazily(req.mutatedParts); });
                                });
                            }
                            else {
                                tblCache.optimisticOps.push(req);
                                req.mutatedParts && signalSubscribersLazily(req.mutatedParts);
                                promise.then(function (res) {
                                    if (res.numFailures > 0) {
                                        delArrayItem(tblCache.optimisticOps, req);
                                        var adjustedReq = adjustOptimisticFromFailures(tblCache, req, res);
                                        if (adjustedReq) {
                                            tblCache.optimisticOps.push(adjustedReq);
                                        }
                                        req.mutatedParts && signalSubscribersLazily(req.mutatedParts);
                                    }
                                });
                                promise.catch(function () {
                                    delArrayItem(tblCache.optimisticOps, req);
                                    req.mutatedParts && signalSubscribersLazily(req.mutatedParts);
                                });
                            }
                            return promise;
                        }, query: function (req) {
                            var _a;
                            if (!isCachableContext(PSD, downTable) || !isCachableRequest("query", req))
                                return downTable.query(req);
                            var freezeResults = ((_a = PSD.trans) === null || _a === void 0 ? void 0 : _a.db._options.cache) === 'immutable';
                            var _b = PSD, requery = _b.requery, signal = _b.signal;
                            var _c = findCompatibleQuery(dbName, tableName, 'query', req), cacheEntry = _c[0], exactMatch = _c[1], tblCache = _c[2], container = _c[3];
                            if (cacheEntry && exactMatch) {
                                cacheEntry.obsSet = req.obsSet;
                            }
                            else {
                                var promise = downTable.query(req).then(function (res) {
                                    var result = res.result;
                                    if (cacheEntry)
                                        cacheEntry.res = result;
                                    if (freezeResults) {
                                        for (var i = 0, l = result.length; i < l; ++i) {
                                            Object.freeze(result[i]);
                                        }
                                        Object.freeze(result);
                                    }
                                    else {
                                        res.result = deepClone(result);
                                    }
                                    return res;
                                }).catch(function (error) {
                                    if (container && cacheEntry)
                                        delArrayItem(container, cacheEntry);
                                    return Promise.reject(error);
                                });
                                cacheEntry = {
                                    obsSet: req.obsSet,
                                    promise: promise,
                                    subscribers: new Set(),
                                    type: 'query',
                                    req: req,
                                    dirty: false,
                                };
                                if (container) {
                                    container.push(cacheEntry);
                                }
                                else {
                                    container = [cacheEntry];
                                    if (!tblCache) {
                                        tblCache = cache["idb://".concat(dbName, "/").concat(tableName)] = {
                                            queries: {
                                                query: {},
                                                count: {},
                                            },
                                            objs: new Map(),
                                            optimisticOps: [],
                                            unsignaledParts: {}
                                        };
                                    }
                                    tblCache.queries.query[req.query.index.name || ''] = container;
                                }
                            }
                            subscribeToCacheEntry(cacheEntry, container, requery, signal);
                            return cacheEntry.promise.then(function (res) {
                                return {
                                    result: applyOptimisticOps(res.result, req, tblCache === null || tblCache === void 0 ? void 0 : tblCache.optimisticOps, downTable, cacheEntry, freezeResults),
                                };
                            });
                        } });
                    return tableMW;
                } });
            return coreMW;
        },
    };

    function vipify(target, vipDb) {
        return new Proxy(target, {
            get: function (target, prop, receiver) {
                if (prop === 'db')
                    return vipDb;
                return Reflect.get(target, prop, receiver);
            }
        });
    }

    var Dexie$1 =  (function () {
        function Dexie(name, options) {
            var _this = this;
            this._middlewares = {};
            this.verno = 0;
            var deps = Dexie.dependencies;
            this._options = options = __assign({
                addons: Dexie.addons, autoOpen: true,
                indexedDB: deps.indexedDB, IDBKeyRange: deps.IDBKeyRange, cache: 'cloned' }, options);
            this._deps = {
                indexedDB: options.indexedDB,
                IDBKeyRange: options.IDBKeyRange
            };
            var addons = options.addons;
            this._dbSchema = {};
            this._versions = [];
            this._storeNames = [];
            this._allTables = {};
            this.idbdb = null;
            this._novip = this;
            var state = {
                dbOpenError: null,
                isBeingOpened: false,
                onReadyBeingFired: null,
                openComplete: false,
                dbReadyResolve: nop,
                dbReadyPromise: null,
                cancelOpen: nop,
                openCanceller: null,
                autoSchema: true,
                PR1398_maxLoop: 3,
                autoOpen: options.autoOpen,
            };
            state.dbReadyPromise = new DexiePromise(function (resolve) {
                state.dbReadyResolve = resolve;
            });
            state.openCanceller = new DexiePromise(function (_, reject) {
                state.cancelOpen = reject;
            });
            this._state = state;
            this.name = name;
            this.on = Events(this, "populate", "blocked", "versionchange", "close", { ready: [promisableChain, nop] });
            this.on.ready.subscribe = override(this.on.ready.subscribe, function (subscribe) {
                return function (subscriber, bSticky) {
                    Dexie.vip(function () {
                        var state = _this._state;
                        if (state.openComplete) {
                            if (!state.dbOpenError)
                                DexiePromise.resolve().then(subscriber);
                            if (bSticky)
                                subscribe(subscriber);
                        }
                        else if (state.onReadyBeingFired) {
                            state.onReadyBeingFired.push(subscriber);
                            if (bSticky)
                                subscribe(subscriber);
                        }
                        else {
                            subscribe(subscriber);
                            var db_1 = _this;
                            if (!bSticky)
                                subscribe(function unsubscribe() {
                                    db_1.on.ready.unsubscribe(subscriber);
                                    db_1.on.ready.unsubscribe(unsubscribe);
                                });
                        }
                    });
                };
            });
            this.Collection = createCollectionConstructor(this);
            this.Table = createTableConstructor(this);
            this.Transaction = createTransactionConstructor(this);
            this.Version = createVersionConstructor(this);
            this.WhereClause = createWhereClauseConstructor(this);
            this.on("versionchange", function (ev) {
                if (ev.newVersion > 0)
                    console.warn("Another connection wants to upgrade database '".concat(_this.name, "'. Closing db now to resume the upgrade."));
                else
                    console.warn("Another connection wants to delete database '".concat(_this.name, "'. Closing db now to resume the delete request."));
                _this.close({ disableAutoOpen: false });
            });
            this.on("blocked", function (ev) {
                if (!ev.newVersion || ev.newVersion < ev.oldVersion)
                    console.warn("Dexie.delete('".concat(_this.name, "') was blocked"));
                else
                    console.warn("Upgrade '".concat(_this.name, "' blocked by other connection holding version ").concat(ev.oldVersion / 10));
            });
            this._maxKey = getMaxKey(options.IDBKeyRange);
            this._createTransaction = function (mode, storeNames, dbschema, parentTransaction) { return new _this.Transaction(mode, storeNames, dbschema, _this._options.chromeTransactionDurability, parentTransaction); };
            this._fireOnBlocked = function (ev) {
                _this.on("blocked").fire(ev);
                connections
                    .filter(function (c) { return c.name === _this.name && c !== _this && !c._state.vcFired; })
                    .map(function (c) { return c.on("versionchange").fire(ev); });
            };
            this.use(cacheExistingValuesMiddleware);
            this.use(cacheMiddleware);
            this.use(observabilityMiddleware);
            this.use(virtualIndexMiddleware);
            this.use(hooksMiddleware);
            var vipDB = new Proxy(this, {
                get: function (_, prop, receiver) {
                    if (prop === '_vip')
                        return true;
                    if (prop === 'table')
                        return function (tableName) { return vipify(_this.table(tableName), vipDB); };
                    var rv = Reflect.get(_, prop, receiver);
                    if (rv instanceof Table)
                        return vipify(rv, vipDB);
                    if (prop === 'tables')
                        return rv.map(function (t) { return vipify(t, vipDB); });
                    if (prop === '_createTransaction')
                        return function () {
                            var tx = rv.apply(this, arguments);
                            return vipify(tx, vipDB);
                        };
                    return rv;
                }
            });
            this.vip = vipDB;
            addons.forEach(function (addon) { return addon(_this); });
        }
        Dexie.prototype.version = function (versionNumber) {
            if (isNaN(versionNumber) || versionNumber < 0.1)
                throw new exceptions.Type("Given version is not a positive number");
            versionNumber = Math.round(versionNumber * 10) / 10;
            if (this.idbdb || this._state.isBeingOpened)
                throw new exceptions.Schema("Cannot add version when database is open");
            this.verno = Math.max(this.verno, versionNumber);
            var versions = this._versions;
            var versionInstance = versions.filter(function (v) { return v._cfg.version === versionNumber; })[0];
            if (versionInstance)
                return versionInstance;
            versionInstance = new this.Version(versionNumber);
            versions.push(versionInstance);
            versions.sort(lowerVersionFirst);
            versionInstance.stores({});
            this._state.autoSchema = false;
            return versionInstance;
        };
        Dexie.prototype._whenReady = function (fn) {
            var _this = this;
            return (this.idbdb && (this._state.openComplete || PSD.letThrough || this._vip)) ? fn() : new DexiePromise(function (resolve, reject) {
                if (_this._state.openComplete) {
                    return reject(new exceptions.DatabaseClosed(_this._state.dbOpenError));
                }
                if (!_this._state.isBeingOpened) {
                    if (!_this._state.autoOpen) {
                        reject(new exceptions.DatabaseClosed());
                        return;
                    }
                    _this.open().catch(nop);
                }
                _this._state.dbReadyPromise.then(resolve, reject);
            }).then(fn);
        };
        Dexie.prototype.use = function (_a) {
            var stack = _a.stack, create = _a.create, level = _a.level, name = _a.name;
            if (name)
                this.unuse({ stack: stack, name: name });
            var middlewares = this._middlewares[stack] || (this._middlewares[stack] = []);
            middlewares.push({ stack: stack, create: create, level: level == null ? 10 : level, name: name });
            middlewares.sort(function (a, b) { return a.level - b.level; });
            return this;
        };
        Dexie.prototype.unuse = function (_a) {
            var stack = _a.stack, name = _a.name, create = _a.create;
            if (stack && this._middlewares[stack]) {
                this._middlewares[stack] = this._middlewares[stack].filter(function (mw) {
                    return create ? mw.create !== create :
                        name ? mw.name !== name :
                            false;
                });
            }
            return this;
        };
        Dexie.prototype.open = function () {
            var _this = this;
            return usePSD(globalPSD,
            function () { return dexieOpen(_this); });
        };
        Dexie.prototype._close = function () {
            var state = this._state;
            var idx = connections.indexOf(this);
            if (idx >= 0)
                connections.splice(idx, 1);
            if (this.idbdb) {
                try {
                    this.idbdb.close();
                }
                catch (e) { }
                this.idbdb = null;
            }
            if (!state.isBeingOpened) {
                state.dbReadyPromise = new DexiePromise(function (resolve) {
                    state.dbReadyResolve = resolve;
                });
                state.openCanceller = new DexiePromise(function (_, reject) {
                    state.cancelOpen = reject;
                });
            }
        };
        Dexie.prototype.close = function (_a) {
            var _b = _a === void 0 ? { disableAutoOpen: true } : _a, disableAutoOpen = _b.disableAutoOpen;
            var state = this._state;
            if (disableAutoOpen) {
                if (state.isBeingOpened) {
                    state.cancelOpen(new exceptions.DatabaseClosed());
                }
                this._close();
                state.autoOpen = false;
                state.dbOpenError = new exceptions.DatabaseClosed();
            }
            else {
                this._close();
                state.autoOpen = this._options.autoOpen ||
                    state.isBeingOpened;
                state.openComplete = false;
                state.dbOpenError = null;
            }
        };
        Dexie.prototype.delete = function (closeOptions) {
            var _this = this;
            if (closeOptions === void 0) { closeOptions = { disableAutoOpen: true }; }
            var hasInvalidArguments = arguments.length > 0 && typeof arguments[0] !== 'object';
            var state = this._state;
            return new DexiePromise(function (resolve, reject) {
                var doDelete = function () {
                    _this.close(closeOptions);
                    var req = _this._deps.indexedDB.deleteDatabase(_this.name);
                    req.onsuccess = wrap(function () {
                        _onDatabaseDeleted(_this._deps, _this.name);
                        resolve();
                    });
                    req.onerror = eventRejectHandler(reject);
                    req.onblocked = _this._fireOnBlocked;
                };
                if (hasInvalidArguments)
                    throw new exceptions.InvalidArgument("Invalid closeOptions argument to db.delete()");
                if (state.isBeingOpened) {
                    state.dbReadyPromise.then(doDelete);
                }
                else {
                    doDelete();
                }
            });
        };
        Dexie.prototype.backendDB = function () {
            return this.idbdb;
        };
        Dexie.prototype.isOpen = function () {
            return this.idbdb !== null;
        };
        Dexie.prototype.hasBeenClosed = function () {
            var dbOpenError = this._state.dbOpenError;
            return dbOpenError && (dbOpenError.name === 'DatabaseClosed');
        };
        Dexie.prototype.hasFailed = function () {
            return this._state.dbOpenError !== null;
        };
        Dexie.prototype.dynamicallyOpened = function () {
            return this._state.autoSchema;
        };
        Object.defineProperty(Dexie.prototype, "tables", {
            get: function () {
                var _this = this;
                return keys(this._allTables).map(function (name) { return _this._allTables[name]; });
            },
            enumerable: false,
            configurable: true
        });
        Dexie.prototype.transaction = function () {
            var args = extractTransactionArgs.apply(this, arguments);
            return this._transaction.apply(this, args);
        };
        Dexie.prototype._transaction = function (mode, tables, scopeFunc) {
            var _this = this;
            var parentTransaction = PSD.trans;
            if (!parentTransaction || parentTransaction.db !== this || mode.indexOf('!') !== -1)
                parentTransaction = null;
            var onlyIfCompatible = mode.indexOf('?') !== -1;
            mode = mode.replace('!', '').replace('?', '');
            var idbMode, storeNames;
            try {
                storeNames = tables.map(function (table) {
                    var storeName = table instanceof _this.Table ? table.name : table;
                    if (typeof storeName !== 'string')
                        throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");
                    return storeName;
                });
                if (mode == "r" || mode === READONLY)
                    idbMode = READONLY;
                else if (mode == "rw" || mode == READWRITE)
                    idbMode = READWRITE;
                else
                    throw new exceptions.InvalidArgument("Invalid transaction mode: " + mode);
                if (parentTransaction) {
                    if (parentTransaction.mode === READONLY && idbMode === READWRITE) {
                        if (onlyIfCompatible) {
                            parentTransaction = null;
                        }
                        else
                            throw new exceptions.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");
                    }
                    if (parentTransaction) {
                        storeNames.forEach(function (storeName) {
                            if (parentTransaction && parentTransaction.storeNames.indexOf(storeName) === -1) {
                                if (onlyIfCompatible) {
                                    parentTransaction = null;
                                }
                                else
                                    throw new exceptions.SubTransaction("Table " + storeName +
                                        " not included in parent transaction.");
                            }
                        });
                    }
                    if (onlyIfCompatible && parentTransaction && !parentTransaction.active) {
                        parentTransaction = null;
                    }
                }
            }
            catch (e) {
                return parentTransaction ?
                    parentTransaction._promise(null, function (_, reject) { reject(e); }) :
                    rejection(e);
            }
            var enterTransaction = enterTransactionScope.bind(null, this, idbMode, storeNames, parentTransaction, scopeFunc);
            return (parentTransaction ?
                parentTransaction._promise(idbMode, enterTransaction, "lock") :
                PSD.trans ?
                    usePSD(PSD.transless, function () { return _this._whenReady(enterTransaction); }) :
                    this._whenReady(enterTransaction));
        };
        Dexie.prototype.table = function (tableName) {
            if (!hasOwn(this._allTables, tableName)) {
                throw new exceptions.InvalidTable("Table ".concat(tableName, " does not exist"));
            }
            return this._allTables[tableName];
        };
        return Dexie;
    }());

    var symbolObservable = typeof Symbol !== "undefined" && "observable" in Symbol
        ? Symbol.observable
        : "@@observable";
    var Observable =  (function () {
        function Observable(subscribe) {
            this._subscribe = subscribe;
        }
        Observable.prototype.subscribe = function (x, error, complete) {
            return this._subscribe(!x || typeof x === "function" ? { next: x, error: error, complete: complete } : x);
        };
        Observable.prototype[symbolObservable] = function () {
            return this;
        };
        return Observable;
    }());

    var domDeps;
    try {
        domDeps = {
            indexedDB: _global.indexedDB || _global.mozIndexedDB || _global.webkitIndexedDB || _global.msIndexedDB,
            IDBKeyRange: _global.IDBKeyRange || _global.webkitIDBKeyRange
        };
    }
    catch (e) {
        domDeps = { indexedDB: null, IDBKeyRange: null };
    }

    function liveQuery(querier) {
        var hasValue = false;
        var currentValue;
        var observable = new Observable(function (observer) {
            var scopeFuncIsAsync = isAsyncFunction(querier);
            function execute(ctx) {
                var wasRootExec = beginMicroTickScope();
                try {
                    if (scopeFuncIsAsync) {
                        incrementExpectedAwaits();
                    }
                    var rv = newScope(querier, ctx);
                    if (scopeFuncIsAsync) {
                        rv = rv.finally(decrementExpectedAwaits);
                    }
                    return rv;
                }
                finally {
                    wasRootExec && endMicroTickScope();
                }
            }
            var closed = false;
            var abortController;
            var accumMuts = {};
            var currentObs = {};
            var subscription = {
                get closed() {
                    return closed;
                },
                unsubscribe: function () {
                    if (closed)
                        return;
                    closed = true;
                    if (abortController)
                        abortController.abort();
                    if (startedListening)
                        globalEvents.storagemutated.unsubscribe(mutationListener);
                },
            };
            observer.start && observer.start(subscription);
            var startedListening = false;
            var doQuery = function () { return execInGlobalContext(_doQuery); };
            function shouldNotify() {
                return obsSetsOverlap(currentObs, accumMuts);
            }
            var mutationListener = function (parts) {
                extendObservabilitySet(accumMuts, parts);
                if (shouldNotify()) {
                    doQuery();
                }
            };
            var _doQuery = function () {
                if (closed ||
                    !domDeps.indexedDB)
                 {
                    return;
                }
                accumMuts = {};
                var subscr = {};
                if (abortController)
                    abortController.abort();
                abortController = new AbortController();
                var ctx = {
                    subscr: subscr,
                    signal: abortController.signal,
                    requery: doQuery,
                    querier: querier,
                    trans: null
                };
                var ret = execute(ctx);
                Promise.resolve(ret).then(function (result) {
                    hasValue = true;
                    currentValue = result;
                    if (closed || ctx.signal.aborted) {
                        return;
                    }
                    accumMuts = {};
                    currentObs = subscr;
                    if (!objectIsEmpty(currentObs) && !startedListening) {
                        globalEvents(DEXIE_STORAGE_MUTATED_EVENT_NAME, mutationListener);
                        startedListening = true;
                    }
                    execInGlobalContext(function () { return !closed && observer.next && observer.next(result); });
                }, function (err) {
                    hasValue = false;
                    if (!['DatabaseClosedError', 'AbortError'].includes(err === null || err === void 0 ? void 0 : err.name)) {
                        if (!closed)
                            execInGlobalContext(function () {
                                if (closed)
                                    return;
                                observer.error && observer.error(err);
                            });
                    }
                });
            };
            setTimeout(doQuery, 0);
            return subscription;
        });
        observable.hasValue = function () { return hasValue; };
        observable.getValue = function () { return currentValue; };
        return observable;
    }

    var Dexie = Dexie$1;
    props(Dexie, __assign(__assign({}, fullNameExceptions), {
        delete: function (databaseName) {
            var db = new Dexie(databaseName, { addons: [] });
            return db.delete();
        },
        exists: function (name) {
            return new Dexie(name, { addons: [] }).open().then(function (db) {
                db.close();
                return true;
            }).catch('NoSuchDatabaseError', function () { return false; });
        },
        getDatabaseNames: function (cb) {
            try {
                return getDatabaseNames(Dexie.dependencies).then(cb);
            }
            catch (_a) {
                return rejection(new exceptions.MissingAPI());
            }
        },
        defineClass: function () {
            function Class(content) {
                extend(this, content);
            }
            return Class;
        }, ignoreTransaction: function (scopeFunc) {
            return PSD.trans ?
                usePSD(PSD.transless, scopeFunc) :
                scopeFunc();
        }, vip: vip, async: function (generatorFn) {
            return function () {
                try {
                    var rv = awaitIterator(generatorFn.apply(this, arguments));
                    if (!rv || typeof rv.then !== 'function')
                        return DexiePromise.resolve(rv);
                    return rv;
                }
                catch (e) {
                    return rejection(e);
                }
            };
        }, spawn: function (generatorFn, args, thiz) {
            try {
                var rv = awaitIterator(generatorFn.apply(thiz, args || []));
                if (!rv || typeof rv.then !== 'function')
                    return DexiePromise.resolve(rv);
                return rv;
            }
            catch (e) {
                return rejection(e);
            }
        },
        currentTransaction: {
            get: function () { return PSD.trans || null; }
        }, waitFor: function (promiseOrFunction, optionalTimeout) {
            var promise = DexiePromise.resolve(typeof promiseOrFunction === 'function' ?
                Dexie.ignoreTransaction(promiseOrFunction) :
                promiseOrFunction)
                .timeout(optionalTimeout || 60000);
            return PSD.trans ?
                PSD.trans.waitFor(promise) :
                promise;
        },
        Promise: DexiePromise,
        debug: {
            get: function () { return debug; },
            set: function (value) {
                setDebug(value);
            }
        },
        derive: derive, extend: extend, props: props, override: override,
        Events: Events, on: globalEvents, liveQuery: liveQuery, extendObservabilitySet: extendObservabilitySet,
        getByKeyPath: getByKeyPath, setByKeyPath: setByKeyPath, delByKeyPath: delByKeyPath, shallowClone: shallowClone, deepClone: deepClone, getObjectDiff: getObjectDiff, cmp: cmp, asap: asap$1,
        minKey: minKey,
        addons: [],
        connections: connections,
        errnames: errnames,
        dependencies: domDeps, cache: cache,
        semVer: DEXIE_VERSION, version: DEXIE_VERSION.split('.')
            .map(function (n) { return parseInt(n); })
            .reduce(function (p, c, i) { return p + (c / Math.pow(10, i * 2)); }) }));
    Dexie.maxKey = getMaxKey(Dexie.dependencies.IDBKeyRange);

    if (typeof dispatchEvent !== 'undefined' && typeof addEventListener !== 'undefined') {
        globalEvents(DEXIE_STORAGE_MUTATED_EVENT_NAME, function (updatedParts) {
            if (!propagatingLocally) {
                var event_1;
                event_1 = new CustomEvent(STORAGE_MUTATED_DOM_EVENT_NAME, {
                    detail: updatedParts
                });
                propagatingLocally = true;
                dispatchEvent(event_1);
                propagatingLocally = false;
            }
        });
        addEventListener(STORAGE_MUTATED_DOM_EVENT_NAME, function (_a) {
            var detail = _a.detail;
            if (!propagatingLocally) {
                propagateLocally(detail);
            }
        });
    }
    function propagateLocally(updateParts) {
        var wasMe = propagatingLocally;
        try {
            propagatingLocally = true;
            globalEvents.storagemutated.fire(updateParts);
            signalSubscribersNow(updateParts, true);
        }
        finally {
            propagatingLocally = wasMe;
        }
    }
    var propagatingLocally = false;

    var bc;
    var createBC = function () { };
    if (typeof BroadcastChannel !== 'undefined') {
        createBC = function () {
            bc = new BroadcastChannel(STORAGE_MUTATED_DOM_EVENT_NAME);
            bc.onmessage = function (ev) { return ev.data && propagateLocally(ev.data); };
        };
        createBC();
        if (typeof bc.unref === 'function') {
            bc.unref();
        }
        globalEvents(DEXIE_STORAGE_MUTATED_EVENT_NAME, function (changedParts) {
            if (!propagatingLocally) {
                bc.postMessage(changedParts);
            }
        });
    }

    if (typeof addEventListener !== 'undefined') {
        addEventListener('pagehide', function (event) {
            if (!Dexie$1.disableBfCache && event.persisted) {
                if (debug)
                    console.debug('Dexie: handling persisted pagehide');
                bc === null || bc === void 0 ? void 0 : bc.close();
                for (var _i = 0, connections_1 = connections; _i < connections_1.length; _i++) {
                    var db = connections_1[_i];
                    db.close({ disableAutoOpen: false });
                }
            }
        });
        addEventListener('pageshow', function (event) {
            if (!Dexie$1.disableBfCache && event.persisted) {
                if (debug)
                    console.debug('Dexie: handling persisted pageshow');
                createBC();
                propagateLocally({ all: new RangeSet(-Infinity, [[]]) });
            }
        });
    }

    function add(value) {
        return new PropModification({ add: value });
    }

    function remove(value) {
        return new PropModification({ remove: value });
    }

    function replacePrefix(a, b) {
        return new PropModification({ replacePrefix: [a, b] });
    }

    DexiePromise.rejectionMapper = mapError;
    setDebug(debug);

    var namedExports = /*#__PURE__*/Object.freeze({
        __proto__: null,
        Dexie: Dexie$1,
        liveQuery: liveQuery,
        Entity: Entity,
        cmp: cmp,
        PropModification: PropModification,
        replacePrefix: replacePrefix,
        add: add,
        remove: remove,
        'default': Dexie$1,
        RangeSet: RangeSet,
        mergeRanges: mergeRanges,
        rangesOverlap: rangesOverlap
    });

    __assign(Dexie$1, namedExports, { default: Dexie$1 });

    return Dexie$1;

}));
//# sourceMappingURL=dexie.js.map
</script>
    <style>
        @font-face { font-family: 'bulangni'; src: url('') format('truetype'); font-weight: normal; font-style: normal; font-display: swap; }
        :root { --screen-width: 350px; --screen-height: 650px; --secondary-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #1f1f1f; --text-secondary: #8a8a8a; --accent-color: #007bff;   --status-bar-text-color: #000000; }
        html { height: 100%; overflow: hidden; }

/*   body, phone-frame, phone-screen   */

/* 1.  body */
body {
    height: 100%;
    overflow: hidden;
    margin: 0;
    font-family: 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    font-weight: normal;
    /*  */
    background-color: #f0f2f5; 
}

/* 2.  #phone-screen  */
#phone-screen {
    width: 100%;
    height: 100%;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    background-color: #fff; 
}

/* 3.  */
#status-bar {
    display: none;
}

/* 4. iPhone */
.header, .qzone-header {
    /*  env(safe-area-inset-top)  */
    padding-top: calc(15px + env(safe-area-inset-top));
}

/* 5. iPhone */
#chat-input-area {
    padding-bottom: calc(8px + env(safe-area-inset-bottom));
}

#chat-list-bottom-nav {
     padding-bottom: env(safe-area-inset-bottom);
}

/*    */

        #status-bar { position: absolute; top: 0; left: 0; width: 100%; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center;     color: var(--status-bar-text-color); /* <--  */ z-index: 10; font-size: 14px; box-sizing: border-box; pointer-events: none; }
        #status-bar-time { font-weight: 600; }
        .battery-container { display: flex; align-items: center; gap: 5px; }
        .battery-icon { width: 25px; height: 12px;     border: 1px solid currentColor; border-radius: 3px; position: relative; padding: 1px; }
        .battery-icon::after { content: ''; position: absolute; right: -3px; top: 2px; width: 2px; height: 6px;    background-color: currentColor;  border-radius: 0 1px 1px 0; }
        .battery-level { height: 100%; background-color: currentColor; border-radius: 1px; transition: width 0.5s ease; }
        .battery-container.charging .battery-level { background-color: #4cd964; animation: charge-breath 2s infinite; }
        .battery-container.charging .battery-text { color: #4cd964; }
        @keyframes charge-breath { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; overflow: hidden; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .screen.active { opacity: 1; visibility: visible; z-index: 1; }
        .header { position: relative; z-index: 15; flex-shrink: 0; padding: 15px 20px; padding-top: 45px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 600; }
        .header .header-actions { display: flex; align-items: center; gap: 15px; }
        .header .back-btn, .header .action-btn { font-size: 24px; cursor: pointer; width: 30px; text-align: center; color: var(--accent-color); display: flex; align-items: center; justify-content: center; }

.header .action-btn {
    font-size: 16px; /* + */
    font-weight: 600; /*  */
}

        .header .action-btn img { height: 26px; }
        .header .save-btn { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; }
        #home-screen { display: flex; flex-direction: column; justify-content: flex-start; align-items: center; padding: 20px; padding-top: 80px; padding-bottom: 50px; box-sizing: border-box; background-size: cover; background-position: center; }
        #clock-container { text-align: center; color: white; text-shadow: 0 3px 8px rgba(0,0,0,0.4); margin-bottom: 20px; flex-shrink: 0; }
        #main-time { font-size: 80px; font-weight: 200; }
        #main-date { font-size: 18px; font-weight: 500; }
        #app-grid { margin-top: auto; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; padding: 20px; }
        .app-row { display: flex; justify-content: center; gap: 25px; width: 100%; }
        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); font-size: 14px; font-weight: 500; text-align: center; }
        .app-icon .icon-bg { width: 65px; height: 65px; border-radius: 18px; background-color: var(--secondary-bg); display: flex; justify-content: center; align-items: center; font-size: 32px; margin-bottom: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: transform 0.2s ease; overflow: hidden; }
        .app-icon:active .icon-bg { transform: scale(0.9); }
        .app-icon .icon-bg img { width: 100%; height: 100%; object-fit: cover; }
        .app-icon .label { color: white; }
        .form-container, .list-container { padding: 20px; overflow-y: auto; flex-grow: 1; display:flex; flex-direction: column; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        #world-book-content-input { height: calc(100% - 120px); }
        .form-button { width: 100%; padding: 15px; background-color: var(--accent-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .form-button-secondary { background-color: #f0f0f0; color: var(--text-primary); border: 1px solid var(--border-color); }
        #wallpaper-screen .form-container { align-items: center; }
        #wallpaper-preview { width: 180px; height: 320px; border: 2px dashed var(--border-color); background-color: #f0f2f5; margin-bottom: 20px; background-size: cover; background-position: center; border-radius: 10px; display: flex; justify-content: center; align-items: center; color: var(--text-secondary); }
        #wallpaper-upload-input { display: none; }
/*  #world-book-list  */
#world-book-list {
    flex-grow: 1;
    overflow-y: auto;
    background-color: var(--secondary-bg);
    padding-top: 80px;
    margin-top: -80px;
}

/*  #chat-list  padding  margin */
#chat-list {
    flex-grow: 1;
    background-color: var(--secondary-bg);
    padding-top: 100px; 
    padding-bottom: 50px; /*  */
    box-sizing: border-box;
}

        .list-item { display: flex; flex-direction: column; padding: 12px 20px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .list-item:hover { background-color: #f5f5f5; }
        .list-item .item-title { font-weight: 500; font-size: 16px; margin-bottom: 5px; }
        .list-item .item-content { font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); position: relative; }
        .chat-list-item:hover { background-color: #f5f5f5; }
        .chat-list-item .avatar { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; object-fit: cover; background-color: #ccc; }
        .chat-list-item .info { flex-grow: 1; overflow: hidden; }
        .chat-list-item .name-line { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .chat-list-item .name { font-weight: 500; color: var(--text-primary); }
        .chat-list-item .group-tag { font-size: 10px; color: var(--accent-color); background-color: #e7f3ff; padding: 2px 6px; border-radius: 4px; font-weight: bold; flex-shrink: 0; }
        .chat-list-item .last-msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        #chat-interface-screen { background-size: cover; background-position: center; position: relative; }
        #selection-cancel-btn, #selection-delete-btn { font-size: 16px; color: var(--accent-color); cursor: pointer; padding: 5px; }
        #selection-delete-btn { color: #ff3b30; }

/*   #chat-messages   */
#chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    overflow-x: hidden; /* 1: / */
    padding: 10px 15px; /* 2: 15px */
    padding-top: 110px;
    margin-top: -80px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    box-sizing: border-box; /*  */
}
/*    */
        #load-more-btn { text-align: center; padding: 10px; color: var(--accent-color); font-size: 14px; cursor: pointer; background-color: transparent; border: none; width: 100%; }
        #load-more-btn:hover { text-decoration: underline; }

        .sender-name { font-size: 11px; color: #666; margin-bottom: 3px; }

.message-wrapper.ai .sender-name {
    margin-left: 50px; /*  */
    margin-bottom: 3px;
    position: absolute; /*  */
    top: -16px;       /*  */
    left: 0;
}

/* ===  === */

/* 1.  () */
.message-wrapper {
    display: flex;          /* Flex */
    gap: 8px;               /*  */
    align-items: flex-end;  /*  */
    position: relative;
    max-width: 90%;         /*  */
}

/* 2. AI */
.message-wrapper.ai {
    align-self: flex-start;
    flex-direction: row; /*  */
}

/* 3.  */
.message-wrapper.user {
    align-self: flex-end;
    flex-direction: row-reverse; /*  */
}

/* 4.  () */
.message-bubble {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    max-width: 100%;
}

.timestamp {
    /*  position: absolute */
    font-size: 11px;
    color: #999;
    text-shadow: 0 0 3px rgba(255,255,255,0.6);
    white-space: nowrap; /*  */
    margin-bottom: 5px;  /*  */
    flex-shrink: 0;      /*  */
}

        .message-bubble.selected::after { content: ''; position: absolute; left: -10px; top: 50%; transform: translateY(-50%); background-color: var(--accent-color); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .message-bubble.user.selected::after { left: auto; right: -10px; }

        .message-bubble.user { flex-direction: row-reverse; }
        #typing-indicator { align-self: flex-start; display: none; margin: 0 10px 10px; color: var(--text-secondary); }
        #chat-input-area { flex-shrink: 0; padding: 8px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 5px; }
        #chat-input-main-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; }
        #chat-input { flex-grow: 1; border: none; padding: 10px 15px; border-radius: 20px; background-color: var(--secondary-bg); font-size: 16px; max-height: 100px; resize: none; }
        .action-button { border: none; color: white; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; flex-shrink: 0; }
        #send-btn { background-color: var(--accent-color); height: 40px; padding: 0 15px;}
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal.visible { display: flex; }
        .modal-content { width: 90%; max-height: 90%; background-color: white; border-radius: 15px; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; font-weight: 600; border-bottom: 1px solid var(--border-color); text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; overflow-y: auto; }
        .modal-footer { padding: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; }
        .modal-footer button { width: 45%; padding: 12px; border-radius: 8px; border: 1px solid var(--accent-color); cursor: pointer; font-size: 16px; }
        .modal-footer .save { background-color: var(--accent-color); color: white; }
        .modal-footer .cancel { background-color: white; color: var(--accent-color); }
        .avatar-upload { display: flex; align-items: center; gap: 15px; }
        .avatar-upload img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #eee; }
        .avatar-upload button { padding: 8px 12px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; }
        #open-persona-library-btn { font-size: 14px; padding: 6px 10px; margin-left: 0; }
        .avatar-upload input[type="file"] { display: none; }
        .theme-selector label { display: inline-flex; align-items: center; margin-right: 15px; margin-bottom: 5px; cursor: pointer; }
        #reset-theme-btn { background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #group-members-settings { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 15px; }
        .member-editor { text-align: center; cursor: pointer; }
        .member-editor img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background-color: #eee; margin-bottom: 5px; }
        .member-editor .member-name { font-size: 12px; }
        #notification-bar { position: absolute; top: 40px; left: 50%; width: 90%; z-index: 500; background-color: rgba(250, 250, 250, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 16px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; cursor: pointer;     transform: translateX(-50%) translateY(-150%); 
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    visibility: hidden;
}
#notification-bar.visible {
    /* YX */
    transform: translateX(-50%) translateY(0);
    visibility: visible;
}
        #notification-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        #notification-content .name { font-weight: 600; font-size: 15px; color: #000; }
        #notification-content .message { font-size: 14px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .sticker-image { max-width: 100px; max-height: 100px; display: block; object-fit: contain; }
        .message-bubble.is-sticker .content, .message-bubble.is-voice-message .content { padding: 0; background-color: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        #chat-input-actions-top { display: flex; gap: 8px; padding: 0 5px; }
        .chat-action-icon-btn { font-size: 24px; padding: 0; width: 38px; height: 38px; line-height: 38px; text-align: center; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); color: var(--text-primary); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.05); cursor: pointer; display:flex; justify-content:center; align-items:center; }
        #sticker-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background-color: rgba(242, 242, 247, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 200; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #sticker-panel.visible { transform: translateY(0); visibility: visible; }
        #sticker-panel-header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
        #sticker-panel-header .title { font-weight: 600; }
        #sticker-panel-header .panel-btn { font-size: 16px; padding: 5px 10px; cursor: pointer; color: var(--accent-color); }
        #sticker-grid { flex-grow: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
        .sticker-item { position: relative; aspect-ratio: 1 / 1; background-color: white; border-radius: 10px; background-size: contain; background-repeat: no-repeat; background-position: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .sticker-item .delete-btn { display: none; position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background-color: #ff3b30; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 14px; cursor: pointer; border: 2px solid white; }
        #input-actions-wrapper { position: static; display: flex; align-items: flex-end; gap: 8px; flex-shrink: 0; }
        #wait-reply-btn { position: static; bottom: auto; right: auto; width: auto; height: 40px; padding: 0 10px; border-radius: 20px; display: flex; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: opacity 0.2s, transform 0.1s; cursor: pointer;}
        #wait-reply-btn:hover { opacity: 0.8; }
        #wait-reply-btn:active { transform: scale(0.9); }
        #wait-reply-btn img { height: 22px; display: block; margin: auto; }
        .chat-image { max-width: 100%; border-radius: 10px; display: block; }
        .message-bubble.has-image .content { padding: 5px; }
        #custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.2s ease-in-out; }
        #custom-modal-overlay.visible { display: flex; opacity: 1; }
        #custom-modal { background-color: #fff; width: 280px; border-radius: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        #custom-modal-overlay.visible #custom-modal { transform: scale(1); }
        .custom-modal-header { padding: 16px; font-size: 17px; font-weight: 600; text-align: center; }
        .custom-modal-body { padding: 0 16px 16px; text-align: center; font-size: 14px; color: #333; line-height: 1.5; }
        .custom-modal-body p { margin: 0; margin-bottom: 12px; }
        .custom-modal-body input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
        .custom-modal-footer { border-top: 1px solid #dbdbdb; display: flex; }
        .custom-modal-footer button { flex: 1; background: none; border: none; padding: 12px; font-size: 17px; cursor: pointer; color: var(--accent-color); }
        .custom-modal-footer button:first-child { border-right: 1px solid #dbdbdb; }
        .custom-modal-footer .confirm-btn { font-weight: 600; }
        .custom-modal-footer .confirm-btn.btn-danger { color: #ff3b30; }
        #preset-actions-modal .custom-modal-footer { flex-direction: column; }
        #preset-actions-modal .custom-modal-footer button { width: 100%; border: none; border-bottom: 1px solid #dbdbdb; padding: 14px; font-size: 18px; }
        #preset-actions-modal .custom-modal-footer button:last-child { border-bottom: none; }
        .custom-multiselect { position: relative; user-select: none; }
        .select-box { display: flex; align-items: center; width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; background-color: #fff; cursor: pointer; }
        .select-box .selected-options-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
        .select-box .arrow-down { margin-left: auto; font-size: 10px; color: var(--text-secondary); transition: transform 0.2s; }
        .select-box.expanded .arrow-down { transform: rotate(180deg); }

.checkboxes-container {
    display: none;
    position: absolute;
    /*  top margin-top  */
    top: 100%; 
    margin-top: 5px; /* <-- 5 */
    left: 0;
    right: 0;
    max-height: 150px;
    overflow-y: auto;
    overflow-x: hidden;
    background-color: #fff;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    z-index: 101;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

        .checkboxes-container.visible { display: block; }
        .checkboxes-container label { display: block; padding: 10px 12px; cursor: pointer; font-weight: normal; color: var(--text-primary); }

.checkboxes-container label {
    display: block;
    padding: 12px 15px; /* <--  */
    cursor: pointer;
    font-weight: normal;
    color: var(--text-primary);
    font-size: 15px; /* <-- 15px */
}

        .checkboxes-container input { margin-right: 10px; vertical-align: middle; }
        .bg-upload-container { display: flex; align-items: center; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
        .bg-preview-img { max-width: 120px; max-height: 80px; border-radius: 8px; border: 1px solid var(--border-color); object-fit: cover; display: none; }
        #remove-bg-btn { padding: 8px 12px; border: 1px solid #ff3b30; color: #ff3b30; background-color: #fff; border-radius: 5px; cursor: pointer; font-size: 14px; display: none; }
        .message-bubble.is-ai-image .content { padding: 5px; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        .ai-generated-image { max-width: 180px; border-radius: 12px; display: block; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .ai-generated-image:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .voice-message-body { display: flex; align-items: center; cursor: pointer; padding: 8px 12px; min-width: 80px; max-width: 200px; }
        .message-bubble.user .voice-message-body { color: #1a3d00; flex-direction: row-reverse; }
        .message-bubble.ai .voice-message-body { color: var(--text-primary); }
        .voice-waveform { display: flex; align-items: center; height: 20px; gap: 2px; flex-grow: 1; margin: 0 10px; }
        .voice-waveform div { width: 3px; background-color: currentColor; border-radius: 2px; animation: wave-quiet 1.5s ease-in-out infinite; }
        @keyframes wave-quiet { 0%, 100% { height: 2px; } 50% { height: 10px; } }
        .voice-waveform div:nth-child(2) { animation-delay: 0.2s; } .voice-waveform div:nth-child(3) { animation-delay: 0.4s; } .voice-waveform div:nth-child(4) { animation-delay: 0.6s; } .voice-waveform div:nth-child(5) { animation-delay: 0.8s; }
.voice-duration {
    /* ---  --- */
    font-size: var(--chat-font-size, 13px);
    /* ---  --- */
    font-weight: 500;
    color: var(--text-secondary);
}
        .message-bubble.user .voice-duration { color: #3e6224; }

/*   .message-bubble .content   */
/*  */
.message-bubble .content {
    position: relative;
    font-size: var(--chat-font-size, 16px);
    padding: 8px 12px;
    line-height: 1.5;
    word-break: break-word; /* : URL */
}
/*    */

        /* ===  === */
        .message-bubble.user .content { background-color: rgba(255, 255, 255, 0.75); color: #585858; border-radius: 8px 2px 8px 8px; }
        .message-bubble.ai .content { background-color: rgba(255, 255, 255, 0.7); color: #585858; border-radius: 2px 8px 8px 8px; }
      
.message-bubble::after {
    content: "";
    position: absolute;
    width: 20px;  
    height: 20px; 
    background-size: contain;
    background-repeat: no-repeat;
    opacity: 1; 
    z-index: 1;
}
      
        #chat-messages[data-theme="pink_blue"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_blue"] .message-bubble.ai .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.user .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.user .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.ai .content { background-color: #fffde4; color: #5C4033; }
        #chat-messages[data-theme="black_white"] .message-bubble.user .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="black_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #343a40; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.user .content { background-color: #FFEB3B; color: #5D4037; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="red_black"] .message-bubble.user .content { background-color: #C62828; color: #FFFFFF; }
        #chat-messages[data-theme="red_black"] .message-bubble.ai .content { background-color: #212121; color: #FFFFFF; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.user .content { background-color: #A0D2EB; color: #153243; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.ai .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="gray_white"] .message-bubble.user .content { background-color: #e9ecef; color: #495057; }
        #chat-messages[data-theme="gray_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="blue_green"] .message-bubble.user .content { background-color: #d1ecf1; color: #0c5460; }
        #chat-messages[data-theme="blue_green"] .message-bubble.ai .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="pink_white"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="pink_black"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="pink_green"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_green"] .message-bubble.ai .content { background-color: #C8E6C9; color: #1B5E20; }
        #chat-messages[data-theme="green_black"] .message-bubble.user .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="green_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }

        #transfer-btn { font-weight: bold; }
        #transfer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1001; }
        #transfer-modal.visible { display: flex; }
        .transfer-content { background-color: #fff0f5; border-radius: 20px; width: 290px; padding: 20px; box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); text-align: center; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" opacity="0.05"><path d="M50,4 C35,4 28,15 28,24 C28,33 35,32 35,40 C35,48 28,49 28,57 C28,65 35,66 35,74 C35,82 28,83 28,91 C28,99 35,100 50,100 C65,100 72,99 72,91 C72,83 65,82 65,74 C65,66 72,65 72,57 C72,49 65,48 65,40 C65,32 72,33 72,24 C72,15 65,4 50,4 Z" fill="%23FF69B4"/></svg>'); background-repeat: no-repeat; background-position: top right; background-size: 80px; }
        .transfer-header { font-size: 20px; font-weight: bold; color: #a35c7b; margin-bottom: 20px; }
        .transfer-input-group { margin-bottom: 15px; text-align: left; }
        .transfer-input-group label { display: block; font-size: 14px; color: #ff85b3; margin-bottom: 5px; font-weight: 500; }
        .transfer-input-group input { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #ffcce0; background-color: #fff; font-size: 16px; box-sizing: border-box; }
        .transfer-input-group input:focus { border-color: #ff85b3; outline: none; }
        .transfer-actions { display: flex; justify-content: space-between; gap: 10px; }
        .transfer-actions button { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .transfer-actions button:active { transform: scale(0.95); }
        #transfer-cancel-btn { background-color: #ffdde9; color: #a35c7b; }
        #transfer-confirm-btn { background-color: #ff85b3; color: white; }
        .message-bubble.is-transfer .content { padding: 0; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; cursor: pointer; }
        .transfer-card { width: 200px; border-radius: 12px; padding: 12px; color: white; position: relative; overflow: hidden; }
        .transfer-card::before { content: ''; position: absolute; right: 10px; top: 5px; font-size: 30px; opacity: 0.2; transform: rotate(15deg); }
        .message-bubble.user .transfer-card { background: radial-gradient(circle at top left, #ffc5d5, #ff85b3); }
        .message-bubble.ai .transfer-card { background: radial-gradient(circle at top left, #a1c4fd, #c2e9fb); }
        .transfer-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
        .transfer-amount { font-size: 28px; font-weight: bold; margin-bottom: 4px; }
        .transfer-note { font-size: 13px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 8px; word-break: break-all; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #listen-together-btn img.rotating { animation: spin 2s linear infinite; }
        #listen-together-btn img.paused { animation-play-state: paused; }
        #music-player-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.3); }
        #music-player-overlay.visible { display: flex; }
        .music-player-window { width: 90%; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); padding: 25px; display: flex; flex-direction: column; align-items: center; color: #1f1f1f; position: relative; }
        #music-playlist-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #333; }
        #music-time-counter { font-size: 12px; color: #555; margin-bottom: 20px; }
        #music-player-song-title { font-size: 20px; font-weight: 600; margin-bottom: 5px; text-align: center; }
        #music-player-artist { font-size: 14px; color: #666; margin-bottom: 25px; }
        .music-controls { display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; margin-bottom: 30px; }
        .music-controls button { background: none; border: none; font-size: 16px; font-weight: bold; cursor: pointer; color: #333; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; transition: transform 0.2s; }
        .music-controls button:active { transform: scale(0.9); }
        .music-controls .play-pause-btn { font-size: 24px; width: 60px; height: 60px; border-radius: 50%; background-color: rgba(0,0,0,0.05); }
        .music-bottom-actions { display: flex; justify-content: space-between; width: 100%; }
        .music-bottom-actions button { flex: 1; padding: 12px 0; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; }
        #music-exit-btn { background-color: rgba(255, 100, 100, 0.7); color: white; margin-right: 5px; }
        #music-return-btn { background-color: rgba(0, 123, 255, 0.7); color: white; margin-left: 5px; }
        
        #music-playlist-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; background-color: rgba(242, 242, 247, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 210; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #music-playlist-panel.visible { transform: translateY(0); visibility: visible; }
        .playlist-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .playlist-header .panel-btn { font-size: 16px; cursor: pointer; color: var(--accent-color); }
        .playlist-body { flex-grow: 1; overflow-y: auto; padding: 10px 0; }
        .playlist-item { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; }
        .playlist-item.playing { background-color: rgba(0, 123, 255, 0.1); }
        .playlist-item-info .title { font-weight: 500; font-size: 15px; }
        .playlist-item-info .artist { font-size: 12px; color: #666; }
        .playlist-item .delete-track-btn { color: #ff3b30; font-size: 20px; padding: 5px; }

        /* Persona Library Styles */
        #persona-library-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 10px; }
        .persona-preset-item { aspect-ratio: 1 / 1; border-radius: 12px; background-size: cover; background-position: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid rgba(0,0,0,0.1); }
        .persona-preset-item:hover { transform: scale(1.08); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .modal-header .action-button { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; background: none; border: none; padding: 5px; }
        
        /* Battery Alert Modal Styles */
        #battery-alert-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        #battery-alert-modal.visible { display: flex; opacity: 1; }
        .battery-alert-content { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); width: 280px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center; padding: 20px; cursor: pointer; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #battery-alert-modal.visible .battery-alert-content { transform: scale(1); }
        #battery-alert-image { max-width: 100px; max-height: 100px; margin-bottom: 15px; }
        #battery-alert-text { font-size: 16px; font-weight: 500; color: #333; margin: 0; line-height: 1.4; }

/*  */
#font-preview {
    transition: font-family 0.3s ease;}

/* ===  () === */
#chat-list-screen {
}

.chat-list-view {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
    z-index: 1; 
}
.chat-list-view.active {
    opacity: 1;
    visibility: visible;
    z-index: 2; 
}

#messages-view {
    overflow-y: auto; 
}

/*  */
#chat-list-bottom-nav {
    position: absolute; /*  */
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 15; /*  */
    display: flex;
    border-top: 1px solid var(--border-color);
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.nav-item {
    flex: 1;
    text-align: center;
    padding: 12px 0;
    font-size: 14px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: color 0.2s;
}

.nav-item.active {
    color: var(--accent-color);
    font-weight: 600;
}

/* ===  (QZone)  () === */
#qzone-screen {
    background-color: #f0f2f5;
}

.qzone-header {
    /* position: absolute;  <--  relative */
    position: relative;
    z-index: 10; /* z-index  */
    flex-shrink: 0; /*  */
    padding: 15px 20px;
    padding-top: 45px;
    background-color: rgba(247, 247, 247, 0.7); 
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    font-weight: 600;
    text-align: center;
}

.qzone-header .back-btn {
    font-size: 24px;
    cursor: pointer;
    color: var(--accent-color);
}

.qzone-header span:nth-child(2) { /* "" */
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
}

.qzone-content {
    flex-grow: 1;
    overflow-y: auto;
    /* padding-top: 80px;  <-- headerabsolute */
}

.qzone-profile-header {
    position: relative;
    margin-bottom: 20px;
}

.qzone-banner-container {
    width: 100%;
    height: 180px; /*  */
    position: relative;
}

#qzone-banner-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.qzone-user-info {
    position: absolute;
    bottom: -30px; /*  */
    left: 20px;
    display: flex;
    align-items: flex-end; /*  */
    gap: 10px;
}

.qzone-avatar-container {
    position: relative;
}

#qzone-avatar-img {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    object-fit: cover;
}

#qzone-nickname {
    font-size: 18px;
    font-weight: 600;
    color: #fff;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    padding-bottom: 5px; /*  */
}

/*  */
.qzone-edit-btn {
    position: absolute;
    background-color: rgba(0,0,0,0.4);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 4px 8px;
    font-size: 12px;
    cursor: pointer;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

#change-qzone-banner-btn {
    bottom: 10px;
    right: 10px;
}

#change-qzone-avatar-btn {
    bottom: 5px;
    right: 5px;
}

#change-qzone-nickname-btn {
    font-size: 14px;
    padding: 2px 6px;
    margin-left: 5px; /*  */
    color: var(--text-primary);
    background-color: rgba(255,255,255,0.7);
    border-radius: 5px;
    position: relative; /* flex */
    bottom: 5px; /*  */
}

/* ===  === */
#qzone-banner-container,
#qzone-avatar-container,
#qzone-nickname {
    cursor: pointer; /*  */
    transition: opacity 0.2s;
}
#qzone-banner-container:hover,
#qzone-avatar-container:hover,
#qzone-nickname:hover {
    opacity: 0.85; /*  */
}
/*  */
.qzone-edit-btn {
    display: none;
}

/* ===  Header  Bottom Nav  === */
/*  Header */
#qzone-screen .qzone-header {
    display: none;
}
/* Header */
#qzone-screen.active .qzone-header {
    display: flex;
}

/* Header */
#chat-list-screen.in-qzone-view > .header,
#chat-list-screen.in-qzone-view > #chat-list-bottom-nav {
    display: none;
}

.chat-group-container:first-child {
    margin-top: 10px; 
}

/*    */

/*   <style>   */

/* ===  === */
.qzone-actions-bar {
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    margin: 40px 15px 15px 15px; /*  */
    background-color: var(--secondary-bg);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.action-item {
    flex: 1;
    text-align: center;
    font-size: 15px;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    padding: 8px 0;
    position: relative;
}

/*  */
.action-item:not(:last-child)::after {
    content: '';
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 1px;
    height: 20px;
    background-color: var(--border-color);
}

/* ===  === */
#qzone-posts-list {
    padding: 0 15px 20px 15px; /*  */
    display: flex;
    flex-direction: column;
    gap: 20px; /*  */
}

.qzone-post-item {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}

.post-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.post-header .post-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.post-info {
    display: flex;
    flex-direction: column;
}

.post-info .post-nickname {
    font-weight: 600;
    font-size: 15px;
    color: var(--text-primary);
}

.post-info .post-timestamp {
    font-size: 12px;
    color: var(--text-secondary);
}

.post-content {
    font-size: 14px;
    line-height: 1.6;
    color: #333;
    white-space: pre-wrap; /*  */
    word-break: break-word; /*  */
}

/*    */

/*    */

/* ===  === */
#post-public-text {
    min-height: 80px; /*  */
    resize: vertical;
}

.post-image-preview-container {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9; /* 16:9 */
    background-color: #f0f2f5;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    margin-bottom: 15px;
    display: none; /*  */
    justify-content: center;
    align-items: center;
}
.post-image-preview-container.visible {
    display: flex; /*  */
}

#post-image-preview {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 6px;
}

#post-remove-image-btn {
    position: absolute;
    top: -10px;
    right: -10px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: #ff3b30;
    color: white;
    border: 2px solid white;
    font-size: 16px;
    line-height: 20px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
}

.post-image-upload-options {
    display: flex;
    gap: 10px;
}

.post-image-upload-options button {
    flex: 1;
    margin-top: 0;
}

/*    */

/*    */

/* ===  -  === */
.post-mode-switcher {
    display: flex;
    margin-bottom: 20px;
    background-color: #e9ecef;
    border-radius: 8px;
    padding: 4px;
}

.mode-btn {
    flex: 1;
    padding: 8px;
    border: none;
    background-color: transparent;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

.mode-btn.active {
    background-color: var(--secondary-bg);
    color: var(--text-primary);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.post-mode-content {
    display: none; /*  */
}

.post-mode-content.active {
    display: block; /*  */
}

/*    */

/* ===  === */
#album-screen {
    background-color: #f0f2f5; /*  */
}

/* ===  === */
#album-grid-page {
    padding: 15px;
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 2 */
    gap: 15px;
}

/* ===  () === */
.album-item {
    display: flex;
    flex-direction: column;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-radius: 8px; /*  */
}

.album-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.1);
}

.album-cover {
    aspect-ratio: 1 / 1; /*  */
    background-size: cover;
    background-position: center;
    border-radius: 8px;
    margin-bottom: 8px;
    background-color: #f0f2f5; /*  */
}

.album-info {
    text-align: center;
}

.album-name {
    font-weight: 500;
    margin: 0 0 4px 0;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /*  */
}

.album-count {
    font-size: 12px;
    color: var(--text-secondary);
    margin: 0;
}

/*   CSS   */

/*   <style>   */

/* ===  === */
#album-photos-screen {
    background-color: #f0f2f5;
}

#photos-grid-page {
    padding: 15px;
    display: grid;
    /* 3 */
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

.photo-item {
    position: relative; /*  */
    aspect-ratio: 1 / 1; /*  */
    border-radius: 6px;
    overflow: hidden; /*  */
    background-color: #e9ecef; /*  */
}

.photo-item .photo-thumb {
    width: 100%;
    height: 100%;
    object-fit: cover; /*  */
    cursor: pointer;
}

/*  */
.photo-item .photo-delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 22px;
    height: 22px;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 16px;
    line-height: 22px;
    text-align: center;
    cursor: pointer;
    opacity: 0; /*  */
    transition: opacity 0.2s ease;
}

/*  */
.photo-item:hover .photo-delete-btn {
    opacity: 1;
}

/*    */

/* ===  === */
#photo-viewer-modal {
    background-color: rgba(0, 0, 0, 0.85);
    z-index: 1002;
    -webkit-backdrop-filter: blur(5px);
    backdrop-filter: blur(5px);
}

.photo-viewer-content {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
}

#photo-viewer-image {
    max-width: 90vw;  /* 90% */
    max-height: 85vh; /* 85% */
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    /*  */
    transition: opacity 0.2s ease-in-out;
}

/*  */
#photo-viewer-close-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    background: none;
    border: none;
    color: white;
    font-size: 40px;
    font-weight: 200;
    cursor: pointer;
    line-height: 1;
    text-shadow: 0 0 5px black;
}

/*  */
#photo-viewer-modal .nav-arrow {
    position: absolute; /*  */
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    font-size: 50px; /*  */
    font-weight: 100;
    cursor: pointer;
    padding: 10px; /*  */
    user-select: none;
    transition: color 0.2s;
    z-index: 1003; /*  */
}

#photo-viewer-prev-btn {
    left: 5px; /*  */
}

#photo-viewer-next-btn {
    right: 5px; /*  */
}

#photo-viewer-modal .nav-arrow:hover {
    color: white;
}

/*  */
#photo-viewer-modal .nav-arrow:disabled {
    color: rgba(255, 255, 255, 0.2);
    cursor: default;
}

/*    */

/*   <style>   */

/*  CSSCSS  */

/* ===  -  === */
/* ===  === */
.post-main-content {
    /*  */
}

/* ===  () === */
.post-feedback-icons {
    display: flex;
    justify-content: flex-end; /*  */
    align-items: center;
    gap: 12px;
    padding: 8px 0; /* 8px */
}

.action-icon {
    cursor: pointer;
    color: var(--text-secondary); /*  */
    transition: all 0.2s ease-in-out;
}

.action-icon svg {
    width: 22px;
    height: 22px;
    fill: none;
    stroke: currentColor;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
}

/* (/) */
.action-icon.active {
    color: #ff5252; /*  */
    transform: scale(1.1); /*  */
}

.action-icon.active.favorite {
    color: #ffc107; /*  */
}

.action-icon.active svg {
    fill: currentColor; /*  */
}

/*  */
.animate-like {
    animation: like-bounce 0.4s ease-in-out;
}

@keyframes like-bounce {
    0%   { transform: scale(1); }
    25%  { transform: scale(0.8); }
    50%  { transform: scale(1.2); }
    75%  { transform: scale(1.05); }
    100% { transform: scale(1.1); }
}


/* ===  () === */
.post-footer {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid #f0f0f0; /*  */
    display: flex;
    align-items: center;
    gap: 8px; /*  */
}

/*  */
.comment-section {
    flex-grow: 1; /*  */
    display: flex;
    align-items: center;
    gap: 8px;
}

.comment-section .comment-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
}

.comment-section .comment-input {
    width: 100%;
    padding: 8px 12px;
    border: none;
    background-color: #f0f2f5;
    border-radius: 14px;
    font-size: 13px;
    outline: none;
}

/*  */
.comment-send-btn {
    flex-shrink: 0; /*  */
    padding: 8px 15px;
    border: none;
    background-color: var(--accent-color);
    color: white;
    border-radius: 14px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
}

/*    */

/*   <style>   */

/* ===  === */
.unread-indicator {
    position: absolute;
    top: -8px;      
    right: -15px;    
    min-width: 18px;
    height: 18px;
    padding: 0 5px;
    background-color: #ff3b30;
    color: white;
    font-size: 11px;
    font-weight: bold;
    line-height: 18px;
    text-align: center;
    border-radius: 9px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    display: none;
    z-index: 1;
}

/*  () */
.back-btn-indicator {
    top: 0;
    right: -8px; /*  */
    width: 10px;
    height: 10px;
    min-width: 10px;
    padding: 0;
    border-radius: 50%;
}

/*    */

/*   <style>   */

/* ===  === */
.post-comments-container {
    padding: 10px 0; /*  */
    display: flex;
    flex-direction: column;
    gap: 8px; /*  */
    font-size: 13px; /*  */
}

/*  */
.comment-item {
    line-height: 1.5;
}

/*  */
.comment-item .commenter-name {
    font-weight: 600;
    color: var(--accent-color);
    cursor: pointer;
    margin-right: 5px; /*  */
}

/*  */
.comment-item .comment-text {
    color: var(--text-primary);
    word-break: break-word;
}
/*    */

/*   <style>   */

/* ===  === */
.post-likes-section {
    display: flex;
    align-items: center;
    gap: 6px; /*  */
    padding: 8px 10px; /*  */
    font-size: 13px;
    color: var(--accent-color); /*  */
    background-color: #f0f5fa; /*  */
    border-top: 1px solid #e9eef3;
    border-bottom: 1px solid #e9eef3;
    margin-top: 5px; /*  */
}

.post-likes-section .like-icon {
    width: 16px;
    height: 16px;
    fill: currentColor; /* SVG */
    flex-shrink: 0; /*  */
}

/*    */

/*   <style>   */

/* === @  === */
.at-mention-popup {
    position: absolute; /*  */
    bottom: 100%; /*  */
    left: 40px; /*  () */
    width: calc(100% - 40px); /*  */
    max-height: 120px;
    overflow-y: auto;
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
    z-index: 10;
    display: none; /*  */
}

.at-mention-item {
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
    color: var(--text-primary);
    border-bottom: 1px solid #f0f0f0;
}

.at-mention-item:last-child {
    border-bottom: none;
}

.at-mention-item:hover {
    background-color: #f5f5f5;
}
/*    */

/*   <style>   */

/*   #favorites-list   */

/* flex,  */
#favorites-view {
    display: flex;
    flex-direction: column;
}

/* header */
#favorites-view > .header {
    flex-shrink: 0;
}

/* ===  () === */
#favorites-list {
    flex-grow: 1; 
    overflow-y: auto; 
    overflow-x: hidden; /* <--  */
    padding: 15px; 
    display: flex;
    flex-direction: column;
    gap: 15px; 
}

/*    */

.favorite-item-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    position: relative; /*  */
}

/*  */
.fav-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.fav-card-header .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
}

.fav-card-header .info {
    flex-grow: 1;
}

.fav-card-header .name {
    font-weight: 600;
    font-size: 15px;
}

.fav-card-header .source {
    font-size: 12px;
    color: var(--text-secondary);
}

/*  */
.fav-card-content {
    font-size: 14px;
    line-height: 1.6;
    color: #333;
    white-space: pre-wrap;
    word-break: break-word;
}

.fav-card-content .chat-image {
    margin-top: 8px; /*  */
}

/*  */
.fav-delete-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 28px;
    height: 28px;
    background: #f0f2f5;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    color: var(--text-secondary);
    line-height: 28px;
    text-align: center;
}

.fav-delete-btn:hover {
    background-color: #e9ecef;
    color: #ff3b30;
}

/*    */

/*   <style>   */

/* ===  === */
.search-bar-container {
    padding: 10px 15px;
    background-color: #f9f9f9; /*  */
    position: relative; /*  */
    flex-shrink: 0;
}

#favorites-search-input {
    width: 100%;
    padding: 10px 30px 10px 15px; /*  */
    font-size: 14px;
    border: 1px solid var(--border-color);
    border-radius: 18px; /*  */
    background-color: var(--secondary-bg);
    box-sizing: border-box;
    outline: none;
}
#favorites-search-input:focus {
    border-color: var(--accent-color);
}

.search-clear-btn {
    position: absolute;
    right: 25px;
    top: 50%;
    transform: translateY(-50%);
    background: #ccc;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    line-height: 20px;
    text-align: center;
    font-size: 16px;
    cursor: pointer;
}

/*    */

/* ===  === */
#chat-interface-screen .header .selection-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

#chat-interface-screen .selection-controls .action-btn {
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    padding: 5px;
}

/* ===  === */
#favorites-view.selection-mode .favorite-item-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/*  */
.favorite-item-card::before {
    content: '';
    position: absolute;
    left: -25px; /*  */
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    border: 2px solid #ccc;
    border-radius: 50%;
    background-color: white;
    transition: all 0.2s ease;
    opacity: 0; /*  */
}

/*  */
#favorites-view.selection-mode .favorite-item-card {
    transform: translateX(35px);
}
#favorites-view.selection-mode .favorite-item-card::before {
    opacity: 1;
}

/*  */
#favorites-view.selection-mode .favorite-item-card.selected::before {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    content: '';
    color: white;
    font-size: 14px;
    text-align: center;
    line-height: 20px;
}

/*  () */
#favorites-action-bar {
    position: absolute; /*   absolute #phone-screen  */
    bottom: 0;
    left: 0;
    right: 0;           /*   right: 0 left: 0  */
    width: auto;        /*   auto left/right  */
    padding: 10px 15px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom)); /* iPhone */
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color);
    box-sizing: border-box;
    z-index: 5;
    display: none;
    /* max-width  */
}

#favorites-action-bar .action-bar-btn {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    background-color: #ff3b30;
    color: white;
}

/* ===  === */

/*  */
#chat-interface-screen .header .selection-controls {
    display: none;
}

/*  */
#chat-interface-screen .header .default-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

/*  */
#chat-interface-screen.selection-mode .header .default-controls {
    display: none;
}

/*  */
#chat-interface-screen.selection-mode .header .selection-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

/*   <style>   */

/* === + === */
#add-chat-btn,
#add-world-book-btn,
#create-album-btn-page {
    font-size: 28px;   /*  */
    font-weight: 300;  /*  */
    position: relative;/*  */
    top: -1px;         /*  */
}

/*    */

/*   <style>   */

/*  */
#settings-preview-area {
    width: 100%;
    height: 180px; /*  */
    background-color: #f0f2f5;
    border-radius: 8px;
    padding: 15px;
    box-sizing: border-box;
    overflow: hidden; /*  */
    display: flex;
    flex-direction: column;
    gap: 10px; /*  */
    border: 1px solid var(--border-color);
    position: relative; /*  */
}

/*  */
#settings-preview-area::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-size: cover;
    background-position: center;
    z-index: 1;
    opacity: 0.8;
}

/*  */
#settings-preview-area .message-wrapper {
    position: relative;
    z-index: 2;
}

/*  */
#settings-preview-area .message-bubble .avatar {
    width: 30px;
    height: 30px;
}

#settings-preview-area .message-bubble .timestamp {
    display: none; /*  */
}

/*    */

/*  CSS <style>   */
.existing-group-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background-color: #f9f9f9;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.existing-group-item .group-name {
    font-weight: 500;
}

.existing-group-item .delete-group-btn {
    color: #ff3b30;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
}
/*  CSS  */

/*  CSS <style>   */
.chat-group-container {
    border-bottom: 1px solid var(--border-color);
}
.chat-group-container:first-child {
    border-top: 1px solid var(--border-color);
}

.chat-group-header {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    cursor: pointer;
    background-color: #f7f7f7;
}

.chat-group-header .arrow {
    font-size: 14px;
    margin-right: 8px;
    transition: transform 0.2s ease;
}

.chat-group-header.collapsed .arrow {
    transform: rotate(-90deg);
}

.chat-group-header .group-name {
    font-weight: 600;
    font-size: 15px;
}

.chat-group-content {
    max-height: 1000px; /*  */
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}

.chat-group-content.collapsed {
    max-height: 0;
}
/*  CSS  */

/*  CSS <style>   */

/*  */
.format-helpers {
    display: flex;
    gap: 10px;
    margin-bottom: 15px; /*  */
    flex-wrap: wrap; /*  */
}

/*  */
.format-btn {
    background-color: #e9ecef;
    color: var(--text-primary);
    border: none;
    padding: 6px 12px;
    border-radius: 16px; /*  */
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}

.format-btn:hover {
    background-color: #dcdfe3;
}

/*  CSS  */

/*  CSS <style>   */

/*  */
.post-actions-btn {
    margin-left: auto; /*  */
    padding: 5px 10px;
    font-size: 20px;
    font-weight: bold;
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: 50%;
    line-height: 1;
}
.post-actions-btn:hover {
    background-color: #f0f0f0;
}

/*  () */
#post-actions-modal .custom-modal-footer button {
    width: 100%;
    border: none;
    border-bottom: 1px solid #dbdbdb;
    padding: 14px;
    font-size: 18px;
}
#post-actions-modal .custom-modal-footer button:last-child {
    border-bottom: none;
}
#post-actions-modal #cancel-post-action-btn {
    margin-top: 8px;
    border-radius: 8px;
    background-color: #f0f0f0;
}

/*  CSS  */

/*  */
#chat-messages .transfer-card .transfer-title,
#chat-messages .transfer-card .transfer-amount,
#chat-messages .transfer-card .transfer-note {
    text-shadow: none !important; /*  */
    color: white !important;      /*  */
}

/*  */
#chat-messages .transfer-card .transfer-title {
    font-size: 16px !important;
    font-weight: 600 !important;
}

#chat-messages .transfer-card .transfer-amount {
    font-size: 28px !important;
    font-weight: bold !important;
}

#chat-messages .transfer-card .transfer-note {
    font-size: 13px !important;
    opacity: 0.9 !important;
}

/*    */
.header > span:nth-child(2),
#chat-header-title {
    position: absolute;
    left: 50%;
    transform: translateX(calc(-50% - 2px)); /* -50%2 */
    
    /* ()  */
    max-width: 60%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
/*    */

/*    */
#message-editor-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.message-editor-block {
    background-color: #f9f9f9;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
}

.message-editor-block textarea {
    width: 100%;
    min-height: 60px;
    resize: vertical;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 8px;
    font-size: 14px;
    box-sizing: border-box;
}

.message-editor-block .format-helpers {
    margin-top: 8px;
    margin-bottom: 0; /*  margin-bottom */
}

.message-editor-block .delete-block-btn {
    float: right;
    margin-top: -5px;
    background: none;
    border: none;
    color: #ff3b30;
    font-size: 20px;
    cursor: pointer;
}
/*  CSS  */

/*    */
.contact-picker-item {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}
.contact-picker-item .checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid #ccc;
    border-radius: 50%;
    margin-right: 15px;
    transition: all 0.2s ease;
}
.contact-picker-item.selected .checkbox {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    content: '';
    color: white;
    font-size: 14px;
    text-align: center;
    line-height: 20px;
}
.contact-picker-item .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
}
.contact-picker-item .name {
    font-weight: 500;
}
/*  CSS  */

/*    */
#member-management-list {
    padding: 0; /* padding */
}

.member-management-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
}

.member-management-item .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
}

.member-management-item .name {
    flex-grow: 1;
    font-weight: 500;
}

.member-management-item .remove-member-btn {
    background-color: #ff3b30;
    color: white;
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-size: 20px;
    line-height: 28px;
    text-align: center;
    cursor: pointer;
    flex-shrink: 0;
}

#member-management-actions {
    flex-shrink: 0;
    padding: 15px;
    border-top: 1px solid var(--border-color);
    background-color: #f7f7f7;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

#member-management-actions button {
    width: 100%;
    padding: 15px;
    background-color: var(--accent-color);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}
#member-management-actions #create-new-member-btn {
    background-color: #4cd964; /*  */
}
/*  CSS  */

/*    */
.message-bubble.is-waimai-request .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.waimai-card {
    width: 240px;
    border-radius: 12px;
    overflow: hidden;
    background-color: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

.waimai-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    border-bottom: 1px solid #f0f0f0;
}

.waimai-header .icon {
    width: 20px;
    height: 20px;
}

.waimai-header .title-group {
    display: flex;
    align-items: baseline;
    font-size: 14px;
    color: #8a8a8a;
}
.waimai-header .title-group .brand {
    font-weight: 600;
    color: #555;
    margin-right: 5px;
}
.waimai-header .title-group .separator {
    margin: 0 5px;
}

.waimai-catchphrase {
    font-size: 13px;
    color: #1f1f1f;
    padding: 12px;
}

.waimai-main {
    background-color: #FFD66B; /*  */
    padding: 12px;
    text-align: center;
}

.waimai-main .request-title {
    font-size: 12px;
    color: #856404;
    margin-bottom: 8px;
}

.waimai-main .payment-box {
    background-color: #fff;
    border-radius: 8px;
    padding: 15px 10px;
}

.waimai-main .payment-label {
    font-size: 13px;
    color: #8a8a8a;
}

.waimai-main .amount {
    font-size: 32px;
    font-weight: 700;
    color: #1f1f1f;
    margin: 4px 0 12px 0;
}

.waimai-main .countdown-label {
    font-size: 13px;
    color: #8a8a8a;
}
.waimai-main .countdown-timer {
    display: inline-flex;
    align-items: center;
    gap: 2px;
    margin-left: 5px;
}
.waimai-main .countdown-timer span {
    background-color: #333;
    color: white;
    padding: 2px 4px;
    border-radius: 2px;
    font-weight: bold;
    font-size: 12px;
}

.waimai-details-btn {
    width: 100%;
    padding: 10px 0;
    margin-top: 15px;
    border: none;
    border-radius: 6px;
    background-color: #FFC33A;
    color: #49380a;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
}
/*  CSS  */

/*    */

/* ===  === */
.message-bubble.status-paid .waimai-card {
    border: 2px solid #28a745; /*  */
}
.message-bubble.status-paid .waimai-main .request-title::before {
    content: '  ';
}
.message-bubble.status-paid .waimai-main .request-title {
    color: #155724;
    font-weight: 600;
    /*  request-title  */
    content: "" !important;
    display: block;
    margin-bottom: 15px;
}

.message-bubble.status-paid .payment-box {
    display: none; /*  */
}
.message-bubble.status-paid .waimai-details-btn {
    background-color: #28a745;
    color: white;
}

/* ===  === */
.message-bubble.status-rejected .waimai-card {
    border: 2px solid #dc3545; /*  */
    opacity: 0.8;
}
.message-bubble.status-rejected .waimai-main {
    background-color: #e9ecef;
}
.message-bubble.status-rejected .waimai-main .request-title::before {
    content: ' ';
}
.message-bubble.status-rejected .waimai-main .request-title {
    color: #721c24;
    font-weight: 600;
    /*  request-title  */
    content: "" !important;
    display: block;
    margin-bottom: 15px;
}
.message-bubble.status-rejected .payment-box {
    display: none; /*  */
}
 .message-bubble.status-rejected .waimai-details-btn {
    background-color: #6c757d;
    color: white;
}

/*  request-title  */
.message-bubble[class*="status-"] .request-title {
    font-size: 0; /*  */
}
.message-bubble[class*="status-"] .request-title::after {
    font-size: 14px; /*  */
}
.message-bubble.status-paid .request-title::after {
    content: "";
}
.message-bubble.status-rejected .request-title::after {
    content: "";
}
/*  CSS  */

/*    */
.waimai-user-actions {
    display: flex;
    gap: 10px;
    padding: 0 12px 12px 12px; /*  */
    background-color: #fff;
}

.waimai-user-actions button {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: 1.5px solid;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.waimai-pay-btn {
    background-color: #28a745;
    border-color: #1f7a33;
    color: white;
}
.waimai-pay-btn:hover {
    background-color: #218838;
}

.waimai-decline-btn {
    background-color: #f8f9fa;
    border-color: #ced4da;
    color: #495057;
}
.waimai-decline-btn:hover {
    background-color: #e2e6ea;
}
/*  CSS  */

/* ===  () === */
#api-settings-screen,
#font-settings-screen,
#wallpaper-screen,
#memories-view,
#contact-picker-screen,
#member-management-screen,
#world-book-editor-screen {  
    background-color: var(--secondary-bg);
}

/*  */
#api-settings-screen .form-container,
#font-settings-screen .form-container,
#wallpaper-screen .form-container {
    padding-top: 100px;
    margin-top: -80px;
    background-color: var(--secondary-bg);
}

/*  */
#wallpaper-screen .form-container {
    align-items: center; /*  */
}

/*    */

/* ---  --- */
#incoming-call-modal .incoming-call-content {
    background-color: rgba(40, 40, 40, 0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 20px;
    width: 280px;
    padding: 30px 20px;
    text-align: center;
    color: white;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.caller-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 12px;
    border: 3px solid rgba(255,255,255,0.5);
}

.caller-name {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 5px;
}

.caller-text {
    font-size: 14px;
    color: #ccc;
    margin-bottom: 30px;
}

.incoming-call-actions {
    display: flex;
    justify-content: space-around;
    align-items: center;
}

.action-button-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #e0e0e0;
}

.call-action-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    background-size: 50%;
    background-repeat: no-repeat;
    background-position: center;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.call-action-btn:active {
    transform: scale(0.9);
}

.call-action-btn.decline {
    background-color: #ff3b30;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
}

.call-action-btn.accept {
    background-color: #4cd964;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>');
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0.7); }
    70% { box-shadow: 0 0 0 15px rgba(76, 217, 100, 0); }
    100% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0); }
}

/* ---  --- */
/*   video-call CSS  */

/* 1.  () */
#video-call-screen {
    background-color: #1c1c1e;
    color: white;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* 2.  () */
.video-call-top-bar {
    position: absolute;
    top: 0; left: 0; width: 100%;
    padding: 15px 20px;
    padding-top: 50px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
    z-index: 10;
    text-align: center;
    box-sizing: border-box;
    pointer-events: none;
}
#call-timer {
    font-size: 16px;
    font-weight: 500;
    letter-spacing: 1px;
}
.video-call-controls {
    position: absolute;
    bottom: 0; left: 0; width: 100%;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 20px;
    padding-bottom: 40px;
    background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
    z-index: 10;
    box-sizing: border-box;
}

/* 3.  () */
.video-call-avatar-area {
    flex-grow: 1; 
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
    padding-top: 80px; /*  */
    box-sizing: border-box;
    overflow-y: auto; /*   */
}

/* 4.  () */
#participant-avatars-grid {
    display: flex;
    flex-wrap: wrap; 
    justify-content: center;
    align-items: center;
    gap: 15px; /*   */
    max-width: 100%;
}

/* 5.  () */
.participant-avatar-wrapper {
    position: relative;
    text-align: center;
    flex-shrink: 0;
}
.participant-avatar {
    width: 70px;   /*   80px  70px */
    height: 70px;  /*   80px  70px */
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
}
.participant-name {
    margin-top: 8px;
    font-size: 12px;
    color: #ccc;
}

/* 6.  () */
.participant-avatar.speaking {
    border-color: #4cd964;
    box-shadow: 0 0 20px rgba(76, 217, 100, 0.6);
    transform: scale(1.05);
}

/* 7.  */
#video-call-main {
    flex-shrink: 0; 
    height: 30%;   /*  35%30% */
    margin: 15px 15px 130px 15px; /*  120px130px */
    overflow-y: auto;
    padding: 15px;
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    box-sizing: border-box;
}

/* 8.  () */
.control-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    background-repeat: no-repeat;
    background-position: center;
    transition: transform 0.2s, background-color 0.2s;
}
.control-btn:active {
    transform: scale(0.9);
}
.control-btn.speak-btn {
    background-color: rgba(255,255,255,0.2);
    background-size: 55%;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>');
}
.control-btn.hangup-btn {
    background-color: #ff3b30;
    background-size: 50%;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
}
.control-btn.join-btn {
    background-color: #007bff;
    background-size: 50%;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>');
}

/*  CSS  */

/*    */
.call-message-bubble {
    padding: 10px 15px;
    border-radius: 12px;
    max-width: 85%;
    line-height: 1.6;
    word-break: break-word;
    white-space: pre-wrap;
}

.call-message-bubble.ai-speech {
    background-color: rgba(255, 255, 255, 0.15);
    align-self: flex-start; /* AI */
}

.call-message-bubble.user-speech {
    background-color: #4cd964; /*  */
    align-self: flex-end;   /*  */
    text-align: left; /*  */
}
/*  CSS  */

/*    */
#outgoing-call-screen {
    background-color: #1c1c1e;
    color: white;
    justify-content: center; /*  */
    align-items: center;   /*  */
}

.outgoing-call-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.outgoing-call-actions {
    margin-top: 50px; /*  */
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #e0e0e0;
}
/*    */

/* 1.  */
.qzone-post-container {
    position: relative; /*  */
    overflow: hidden;   /*  */
    border-radius: 12px;/*  */
}

/* 2.  */
.qzone-post-item {
    transition: transform 0.3s ease;
    background-color: var(--secondary-bg); /*  */
    position: relative; /*  */
    z-index: 2;
}

/* 3. */
.qzone-post-delete-action {
    position: absolute; /*  */
    top: 0;
    right: 0;
    bottom: 0;
    width: 90px; /*  */
    background-color: #ff3b30; /*  */
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
    cursor: pointer;
    z-index: 1; /*  */
}

/* 4.  */
.qzone-post-item.swiped {
    transform: translateX(-90px); /*  */
}

/*    */

/*   <style>   */

/* 1.  */
@keyframes pat-shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
    20%, 40%, 60%, 80% { transform: translateX(3px); }
}

.pat-animation {
    animation: pat-shake 0.4s ease-in-out;
}

/* 2.  */
.system-message {
    align-self: center; /*  */
    padding: 4px 12px;
    margin: 5px 0;
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    border-radius: 10px;
    text-align: center;
    max-width: 80%;
}

/*    */

/*  wrapper  */
.message-wrapper.system-pat {
    justify-content: center;
    align-self: center;
    margin: 5px 0;
    max-width: 80%;
}
/* - */
.message-bubble.system-bubble {
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    padding: 4px 12px;
    border-radius: 10px;
}

/*  CSS <style>   */

/* ===  === */
#chat-input-actions-top {
    display: flex;
    gap: 8px;
    padding: 0 5px;

    /* ---  --- */
    overflow-x: auto;      
    flex-wrap: nowrap;     
    -webkit-overflow-scrolling: touch; 

    scrollbar-width: none; 
    -ms-overflow-style: none;  
}

#chat-input-actions-top::-webkit-scrollbar {
    display: none; 
}

/*  CSS  */

/* ===  === */

/* 1. flex */
#chat-header-title-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center; /*  */
    gap: 2px; /*  */
    
    /* flex */
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    max-width: 60%;
}

/* 2.  */
#chat-header-title {
    font-size: 16px; /*  */
    font-weight: 600;
    position: static; /* absolute */
    transform: none;  /* transform */
    /*  */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}

/* 3.  */
#chat-header-status {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    color: var(--text-secondary);
    transition: all 0.3s ease;
}

/* 4.  */
.status-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background-color: #4cd964; /*  */
    transition: background-color 0.3s ease;
}

/* AI */
#chat-header-status.busy .status-dot {
    background-color: #cccccc;
}

/* 5.  */
.status-text {
    font-weight: 500;
}

/* ===  === */

/* 1.  */
.memory-card {
    background-color: #fffaf0; /*  */
    border-radius: 12px;
    padding: 15px; /*  */
    box-shadow: 0 2px 6px rgba(0,0,0,0.07);
    border-left: 5px solid #ffb74d; 
    display: flex; /* flex */
    flex-direction: column; /*  */
    gap: 8px; /*  */
}

/* 2.  */
.memory-card .header {
    border-bottom: 1px solid rgba(217, 129, 0, 0.15); /*  */
    padding-bottom: 8px; 
}

/* 3.  () */
.memory-card .header .date {
    font-size: 11px;
    color: #a1887f;
    margin-bottom: 4px; 
}

/* 4.  () */
.memory-card .header .author {
    font-weight: 600;
    color: #d98100;
    font-size: 15px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 5.  () */
.memory-card .content {
    font-size: 14px;
    line-height: 1.7;
    color: #5d4037;
    white-space: pre-wrap;
}

/* === / === */
.countdown-card {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
    text-align: center;
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
}
.countdown-card::before {
    content: '';
    position: absolute;
    top: -10px;
    left: -10px;
    font-size: 50px;
    opacity: 0.1;
    transform: rotate(-15deg);
}
.countdown-card .title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 15px;
}
.countdown-card .timer {
    font-size: 28px;
    font-weight: 300;
    letter-spacing: 2px;
    margin-bottom: 15px;
}
.countdown-card .target-date {
    font-size: 12px;
    opacity: 0.8;
    border-top: 1px solid rgba(255,255,255,0.2);
    padding-top: 10px;
}

/* ===  === */
#chat-lock-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 150; /*  */
    display: none; /*  */
    align-items: center;
    justify-content: center;
    padding: 20px;
    box-sizing: border-box;
    border-top: 1px solid var(--border-color);
    text-align: center;
}
#chat-lock-content {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
#chat-lock-content .lock-text {
    color: var(--text-secondary);
    font-size: 14px;
}
#chat-lock-content .lock-action-btn {
    padding: 10px 20px;
    border-radius: 20px;
    border: 1px solid var(--accent-color);
    background-color: var(--accent-color);
    color: white;
    cursor: pointer;
}
#chat-lock-content .lock-action-btn.secondary {
    background-color: transparent;
    color: var(--accent-color);
}

/*    */
.message-bubble.is-red-packet .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.red-packet-card {
    width: 220px;
    border-radius: 8px;
    background: linear-gradient(160deg, #F96259, #E44D44);
    color: #ffd700; /*  */
    padding: 12px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}

.red-packet-card.opened {
    background: linear-gradient(160deg, #d3c4a0, #c4b693);
    cursor: default;
}

.red-packet-card::before {
    content: '';
    position: absolute;
    top: -5px;
    left: -5px;
    font-size: 30px;
    opacity: 0.2;
    transform: rotate(-10deg);
}

.rp-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.rp-icon {
    width: 20px;
    height: 20px;
}

.rp-greeting {
    font-size: 15px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.rp-type {
    font-size: 11px;
    color: white;
    opacity: 0.8;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    padding-top: 8px;
    margin-top: 8px;
}

.rp-claimed-info {
    font-size: 13px;
    color: white;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid rgba(255,255,255,0.3);
}
/*  CSS  */

/*    */
.rp-details-item {
    display: flex;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}
.rp-details-item:last-child {
    border-bottom: none;
}
.rp-details-item .name {
    flex-grow: 1;
    font-weight: 500;
    color: #333;
}
.rp-details-item .amount {
    font-weight: 500;
    color: #555;
}
.rp-details-item .lucky-king-tag {
    font-size: 10px;
    background-color: #ffd700;
    color: #a67c00;
    padding: 2px 5px;
    border-radius: 4px;
    margin-left: 8px;
    font-weight: bold;
}
/*  CSS  */

/*    */

/*  */
.message-bubble.is-poll .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

/*  */
.poll-card {
    width: 250px;
    background-color: #f9f9f9;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    padding: 12px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.poll-card.closed {
    background-color: #e9ecef; /*  */
}

/*  */
.poll-question {
    font-weight: 600;
    font-size: 15px;
    margin-bottom: 12px;
    line-height: 1.4;
    word-break: break-word;
}

/*  */
.poll-options-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/*  */
.poll-option-item {
    background-color: white;
    border: 1px solid #dcdcdc;
    border-radius: 8px;
    padding: 10px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: background-color 0.2s;
}

.poll-card:not(.closed) .poll-option-item:hover {
    background-color: #f0f8ff;
}

/*  */
.poll-option-item.voted {
    border-color: var(--accent-color);
    background-color: #e7f3ff;
    font-weight: 500;
}

/*  */
.poll-option-bar {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background-color: rgba(0, 123, 255, 0.1);
    z-index: 1;
    transition: width 0.3s ease-in-out;
}

/*  */
.poll-option-content {
    position: relative;
    z-index: 2;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.poll-option-text {
    font-size: 14px;
}

.poll-option-votes {
    font-size: 13px;
    color: #8a8a8a;
    font-weight: 500;
}

/*  */
.poll-footer {
    margin-top: 12px;
    padding-top: 8px;
    border-top: 1px solid #e9e9e9;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: var(--text-secondary);
}

.poll-total-votes {
    font-weight: 500;
}

.poll-action-btn {
    background: none;
    border: 1px solid var(--accent-color);
    color: var(--accent-color);
    padding: 4px 10px;
    border-radius: 15px;
    cursor: pointer;
    font-size: 12px;
}
.poll-card.closed .poll-action-btn {
    background-color: #6c757d;
    color: white;
    border-color: #6c757d;
}

/*  */
.poll-option-input-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
}
.poll-option-input-wrapper input {
    flex-grow: 1;
}
.poll-option-input-wrapper .remove-option-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background-color: #f0f0f0;
    color: #ff3b30;
    border: none;
    cursor: pointer;
    font-size: 18px;
    line-height: 28px;
    text-align: center;
    flex-shrink: 0;
}

/*  CSS  */

/* ===  === */
#chat-header-title.typing-status {
    color: var(--text-secondary);
    animation: typing-pulse 1.5s infinite;
    font-style: italic;
}

@keyframes typing-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

#chat-header-title {
    transition: opacity 0.2s ease-in-out;
}

@keyframes message-pop-in {
  from {
    opacity: 0;
    transform: translateY(15px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message-wrapper.animate-in {
  animation: message-pop-in 0.3s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
  }

/*  App  */
#icon-settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 20px;
    width: 100%;
    padding: 0 10px;
    box-sizing: border-box;
}

.icon-setting-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.icon-preview {
    width: 60px;
    height: 60px;
    border-radius: 15px;
    background-size: cover;
    background-position: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.change-icon-btn {
    padding: 4px 10px;
    font-size: 12px;
    border: 1px solid #ccc;
    background-color: #f0f0f0;
    border-radius: 5px;
    cursor: pointer;
}
/*  CSS  */

/*    */

/* 1.  */
#wallpaper-screen .form-container {
    /* 1: flex */
    min-height: 0; 
}

/* 2.  */
#wallpaper-preview {
    /* 2:  */
    flex-shrink: 0; 
}
/*    */

/*   ()  */

/* 1.  () */
#browser-screen {
    background-color: #f8f9fa;
}
#browser-content {
    padding: 20px;
    font-size: 16px;
    line-height: 1.8;
    color: #333;
    overflow-y: auto;
    background-color: #f8f9fa;
}
#browser-content .article-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 10px;
}
#browser-content .article-meta {
    font-size: 13px;
    color: #8a8a8a;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
}
#browser-content .article-body {
    white-space: pre-wrap;
    word-break: break-word;
}
#browser-content .article-body p {
    margin-bottom: 1em;
}

/* 2.  () */
.message-bubble.is-link-share .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.link-share-card {
    width: 210px; 
    background-color: #fff;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    padding: 12px;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.link-share-card:hover {
    background-color: #f9f9f9;
}

.link-share-card .title {
    font-weight: 600;
    font-size: 15px;
    line-height: 1.4;
    color: #1f1f1f;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.link-share-card .description {
    font-size: 13px;
    color: #8a8a8a;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.link-share-card .footer {
    display: flex; /*  */
    align-items: center;
    gap: 6px; /*  */
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px; /*  */
}
.link-share-card .footer-icon {
    width: 14px;
    height: 14px;
    flex-shrink: 0; /*  */
}

/*  CSS  */

/*   <style>   */

/*  */
.comment-item {
    position: relative;
    padding-right: 25px; /*  */
}

/*  */
.comment-delete-btn {
    position: absolute;
    top: 50%;
    right: 0;
    transform: translateY(-50%);
    width: 22px;
    height: 22px;
    line-height: 22px;
    text-align: center;
    border-radius: 50%;
    color: var(--text-secondary);
    font-size: 18px;
    cursor: pointer;
    transition: all 0.2s ease;
    opacity: 0; /*  */
}

/*  */
.comment-item:hover .comment-delete-btn {
    opacity: 1;
}

.comment-delete-btn:hover {
    background-color: #f0f0f0;
    color: #ff3b30;
}
/*    */

/*  CSS <style>   */

/* ===  === */

/*  #phone-screen  .dark-mode  */

/* 1.  */
#phone-screen.dark-mode {
  --status-bar-text-color: #ffffff;
    --secondary-bg: #1c1c1e; /*  */
    --border-color: #38383a;  /*  */
    --text-primary: #ffffff;   /*  */
    --text-secondary: #8d8d92; /* / */

}

/* 2.  */
#phone-screen.dark-mode #chat-list-screen,
#phone-screen.dark-mode #qzone-screen .qzone-content,
#phone-screen.dark-mode #memories-view {
    background-color: #000000;
}

/* 3.  */
#phone-screen.dark-mode #chat-list {
    background-color: #000000;
}
#phone-screen.dark-mode .chat-list-item {
    border-bottom-color: rgba(255, 255, 255, 0.15);
}
#phone-screen.dark-mode .chat-group-header {
    background-color: #1c1c1e; /*  */
    border-bottom: 1px solid #38383a; /*  */
}
#phone-screen.dark-mode .chat-list-item .name,
#phone-screen.dark-mode .chat-group-header .group-name {
    color: #ffffff;
}
#phone-screen.dark-mode .chat-list-item:hover {
    background-color: #1c1c1e;
}

/* 4. / */
#phone-screen.dark-mode .header,
#phone-screen.dark-mode .qzone-header {
    background-color: rgba(25, 25, 25, 0.9);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-bottom-color: rgba(255, 255, 255, 0.15);
    color: #ffffff;
}
#phone-screen.dark-mode .header .back-btn,
#phone-screen.dark-mode .header .action-btn,
#phone-screen.dark-mode .header .save-btn {
    color: #ffffff;
}
#phone-screen.dark-mode #chat-list-bottom-nav {
    background-color: rgba(25, 25, 25, 0.9);
    border-top-color: rgba(255, 255, 255, 0.15);
}
#phone-screen.dark-mode .nav-item.active {
    color: #ffffff;
}

/* 5.  */
#phone-screen.dark-mode #chat-input-area {
    background-color: rgba(5, 5, 5, 0.8);
    border-top: none;
}
#phone-screen.dark-mode #chat-input {
    background-color: #3e3e42;
    color: #ffffff;
}
#phone-screen.dark-mode #chat-input::placeholder {
    color: #8d8d92;
}
#phone-screen.dark-mode .chat-action-icon-btn {
    color: #ffffff;
    background-color: rgba(255, 255, 255, 0.1);
    border: none;
}
#phone-screen.dark-mode #send-btn {
    background-color: var(--accent-color);
}

/* 6.  (QZone)  */
#phone-screen.dark-mode .qzone-actions-bar,
#phone-screen.dark-mode .qzone-post-item {
    background-color: #1c1c1e;
    border: 1px solid #333;
    box-shadow: 0 2px 8px rgba(255, 255, 255, 0.05);
}
#phone-screen.dark-mode .action-item:not(:last-child)::after {
    background-color: #333;
}
#phone-screen.dark-mode .post-footer,
#phone-screen.dark-mode .post-likes-section {
    border-top-color: #333;
}
#phone-screen.dark-mode .post-likes-section {
    background-color: rgba(0, 123, 255, 0.1);
}
#phone-screen.dark-mode .comment-input {
    background-color: #333;
    color: #ffffff;
}
#phone-screen.dark-mode .comment-input::placeholder {
    color: #8d8d92;
}
#phone-screen.dark-mode .post-actions-btn:hover {
    background-color: #333;
}
#phone-screen.dark-mode .at-mention-popup {
    background-color: #1c1c1e;
    border-color: #333;
}
#phone-screen.dark-mode .at-mention-item {
    border-bottom-color: #333;
}
#phone-screen.dark-mode .at-mention-item:hover {
    background-color: #333;
}

/* 7.  */
#phone-screen.dark-mode .memory-card {
    background-color: #1c1c1e;
    border-left-color: #e6a753;
    box-shadow: 0 4px 12px rgba(255, 255, 255, 0.08);
}
#phone-screen.dark-mode .memory-card .header {
    background-color: #2c2c2e;
    border-bottom-color: #38383a;
    margin: -15px -15px 8px -15px;
    padding: 12px 15px;
    border-radius: 12px 12px 0 0;
}
#phone-screen.dark-mode .memory-card .header .date,
#phone-screen.dark-mode .memory-card .header .author,
#phone-screen.dark-mode .memory-card .content {
    color: #e0e0e0;
}

/* 8.  */
#phone-screen.dark-mode #api-settings-screen,
#phone-screen.dark-mode #font-settings-screen,
#phone-screen.dark-mode #wallpaper-screen,
#phone-screen.dark-mode #contact-picker-screen,
#phone-screen.dark-mode #member-management-screen,
#phone-screen.dark-mode #world-book-editor-screen,
#phone-screen.dark-mode #world-book-list,
#phone-screen.dark-mode .list-item:hover,
#phone-screen.dark-mode .list-container,
#phone-screen.dark-mode .form-container {
    background-color: #000000;
}
#phone-screen.dark-mode .form-group input, 
#phone-screen.dark-mode .form-group select, 
#phone-screen.dark-mode .form-group textarea {
    background-color: #1c1c1e;
    color: #ffffff;
    border-color: #38383a;
}
#phone-screen.dark-mode .form-button-secondary {
    background-color: #333;
    border-color: #555;
    color: #fff;
}
#phone-screen.dark-mode #font-preview {
    background-color: #1c1c1e;
    border-color: #38383a;
}
#phone-screen.dark-mode #font-preview p {
    color: #ffffff;
}

/*    */

/*  CSS <style>   */

/* ===  === */

/* 1.  */
#phone-screen.dark-mode .qzone-post-item .post-nickname,
#phone-screen.dark-mode .qzone-post-item .post-content {
    color: #f0f0f0; /*  */
}

/* 2.  */
#phone-screen.dark-mode .favorite-item-card .fav-card-header .name,
#phone-screen.dark-mode .favorite-item-card .fav-card-content {
    color: #f0f0f0; /*  */
}
#phone-screen.dark-mode .favorite-item-card .fav-card-header .source {
    color: #8d8d92; /*  */
}

/* 3.  */
#phone-screen.dark-mode .search-bar-container {
    background-color: #000000; /*  */
}
#phone-screen.dark-mode #favorites-search-input {
    background-color: #1c1c1e; /*  */
    border-color: #38383a;     /*  */
    color: #ffffff;            /*  */
}
#phone-screen.dark-mode #favorites-search-input::placeholder {
    color: #8d8d92; /*  */
}

/*  CSS  */

/*  CSS <style>   */

/* === iOSToggle Switch === */

/* 1.  */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 51px;
    height: 31px;
}

/* 2.  checkbox  */
.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

/* 3.  */
.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #e9e9eb; /*  */
    transition: .4s;
    border-radius: 34px;
}

/* 4.  */
.slider:before {
    position: absolute;
    content: "";
    height: 27px;
    width: 27px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* 5.  checkbox  */
input:checked + .slider {
    background-color: #34c759; /* iOS*/
}

input:checked + .slider:before {
    transform: translateX(20px); /*  */
}

/*  CSS  */

/*    */

/* 1.  */
#reply-preview-bar {
    display: none; /*  */
    padding: 8px 12px;
    margin: 0 8px 8px 8px; /*  */
    background-color: rgba(0, 0, 0, 0.05);
    border-left: 3px solid var(--accent-color);
    border-radius: 6px;
    position: relative;
    font-size: 13px;
    color: var(--text-secondary);
}

#phone-screen.dark-mode #reply-preview-bar {
    background-color: rgba(255, 255, 255, 0.1);
}

.reply-preview-content .sender {
    font-weight: 600;
    color: var(--text-primary);
}

.reply-preview-content .text {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block; /*  */
    max-width: 95%;
}

#cancel-reply-btn {
    position: absolute;
    top: 50%;
    right: 8px;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    line-height: 20px;
    text-align: center;
    border-radius: 50%;
    background-color: rgba(0,0,0,0.1);
    cursor: pointer;
    font-size: 14px;
}

/* 2.  */
.quoted-message {
    padding: 6px 10px;
    margin-bottom: 6px;
    background-color: rgba(0, 0, 0, 0.04);
    border-left: 2px solid var(--accent-color);
    border-radius: 4px;
    font-size: 0.9em; /*  */
    opacity: 0.8;
    /* ( overflow: hidden;) */
}

#phone-screen.dark-mode .quoted-message {
    background-color: rgba(255, 255, 255, 0.08);
    border-left-color: #a0cff1;
}

.quoted-message .quoted-sender {
    font-weight: 600;
    color: var(--accent-color);
}
#phone-screen.dark-mode .quoted-message .quoted-sender {
    color: #a0cff1;
}

.quoted-message .quoted-content {
    color: var(--text-secondary);
    white-space: normal;     /* 1:  */
    word-break: break-word;  /* 2:  */
    display: block;
    /* ( overflow  text-overflow) */
}

/* ===  () === */

/*  */
#font-preview {
    padding: 20px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: #f9f9f9; /*  */
    transition: background-color 0.3s, border-color 0.3s;
}

/*  */
#font-preview p {
    color: var(--text-primary);
}

/*  */
#phone-screen.dark-mode #font-preview {
    background-color: #1c1c1e; /*  */
    border-color: #38383a;     /*  */
}

/*  */
#phone-screen.dark-mode #font-preview p {
    color: #ffffff;
}

/*    */
.transfer-actions-content {
    background-color: #fff0f5; /*  */
    border-radius: 20px;
    width: 290px;
    padding: 20px;
    box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); /*  */
    text-align: center;
    position: relative;
    border: 1px solid #ffcce0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.transfer-actions-header {
    font-size: 20px;
    font-weight: bold;
    color: #a35c7b; /*  */
    margin-bottom: 15px;
}

.transfer-actions-body p {
    font-size: 15px;
    color: #555;
    margin: 0 0 25px 0;
    line-height: 1.5;
}

.transfer-actions-footer {
    display: flex;
    justify-content: space-between;
    gap: 15px;
}

.transfer-actions-footer .action-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    color: white;
}

.transfer-actions-footer .action-btn:active {
    transform: scale(0.95);
}

.transfer-actions-footer .action-btn.accept {
    background: linear-gradient(135deg, #ff85b3, #ff69b4);
    box-shadow: 0 4px 10px rgba(255, 105, 180, 0.4);
}

.transfer-actions-footer .action-btn.decline {
    background: linear-gradient(135deg, #c2c2c2, #a0a0a0);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.transfer-actions-content .cancel-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: none;
    background-color: rgba(0, 0, 0, 0.1);
    color: #a35c7b;
    font-size: 20px;
    line-height: 28px;
    cursor: pointer;
}
/*  CSS  */

/*   <style>   */

/* ===  === */
.unread-count-wrapper {
    flex-shrink: 0;
    width: 40px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 20px; /*  */
}

.unread-count {
    min-width: 20px;
    height: 20px;
    padding: 0 6px;
    background-color: #ff3b30; /* iOS  */
    color: white;
    font-size: 13px;
    font-weight: 500;
    line-height: 20px;
    text-align: center;
    border-radius: 10px; /*  */
    box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    display: none; /*  */
    justify-content: center;
    align-items: center;
}
/*    */

/*    */

/*  */
#call-history-screen {
    background-color: #f0f2f5;
}

/*  */
.call-record-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-left: 5px solid var(--accent-color);
}
.call-record-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
}

/*  */
.call-record-card .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
}
.call-record-card .card-header .duration {
    font-weight: 500;
    color: var(--text-primary);
}

/*  */
.call-record-card .card-body {
    display: flex;
    align-items: center;
}
.call-record-card .participants-avatars {
    display: flex;
    align-items: center;
}
.call-record-card .participant-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
/*  */
.call-record-card .participant-avatar:not(:first-child) {
    margin-left: -12px;
}
.call-record-card .participants-names {
    margin-left: 12px;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 15px;
}

/* ---  --- */
#transcript-modal-body {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 15px;
}
.transcript-entry {
    padding: 8px 12px;
    border-radius: 10px;
    max-width: 85%;
    line-height: 1.5;
    word-break: break-word;
}
.transcript-entry.user {
    background-color: #dcf8c6; /*  */
    align-self: flex-end;
}
.transcript-entry.assistant {
    background-color: #ffffff;
    align-self: flex-start;
}
/*  CSS  */

#chat-list-title {
    cursor: pointer;
}

/*    */

.call-record-card .card-body {
    /*  body  flex  */
    display: flex;
    flex-direction: column;
    gap: 8px; /*  */
}

.call-record-card .custom-title {
    font-size: 16px;
    font-weight: 600; /*  */
    color: var(--text-primary);
    padding-bottom: 8px; /*  */
    border-bottom: 1px solid var(--border-color); /*  */
    margin-bottom: 4px; /*  */
}

.call-record-card .participants-info {
    /* xx */
    display: flex;
    align-items: center;
}

/*  */
.call-record-card .participants-names {
    margin-left: 12px;
    font-weight: 500; /*  */
    font-size: 14px; /*  */
    color: var(--text-secondary); /*  */
}

/*    */

/*    */

/* 1.  */
.voice-transcript {
    font-size: 14px;         /*  */
    line-height: 1.6;        /*  */
    color: var(--text-secondary); /*  */
    padding: 8px 12px;       /*  */
    margin-top: 6px;         /*  */
    background-color: rgba(0, 0, 0, 0.04); /*  */
    border-radius: 6px;      /*  */
    word-break: break-word;  /*  */
    display: none;           /*  */
}

#phone-screen.dark-mode .voice-transcript {
    background-color: rgba(255, 255, 255, 0.1); /*  */
}

/* 2.  */
.loading-spinner {
    display: none; /*  */
    width: 16px;
    height: 16px;
    border: 2px solid rgba(0, 0, 0, 0.2);
    border-top-color: var(--accent-color); /*  */
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 8px; /*  */
}

/* 3.  */
@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}
/*    */

/*    */
#shared-history-viewer-content {
    display: flex;
    flex-direction: column; /*  */
    gap: 20px; /* 20 */
    padding: 15px; /*  */
}
/*  CSS  */

/*    */
#music-player-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 50;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 60px;
    background-color: rgba(0,0,0,0.3);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-50px);
    transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

#music-player-overlay.visible {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.music-player-window { 
    width: 70%; 
    min-height: 420px;
    background-color: rgba(255, 255, 255, 0.6); 
    backdrop-filter: blur(20px); 
    -webkit-backdrop-filter: blur(20px); 
    border-radius: 25px; 
    box-shadow: 0 8px 32px 0 rgba(25, 25, 25, 0.37); 
    border: 1px solid rgba(255, 255, 255, 0.18); 
    padding: 25px; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    color: #1f1f1f; 
    position: relative;
    justify-content: space-between;
    padding-bottom: 15px;
}

.music-player-top-actions {
    position: absolute;
    top: 15px;
    left: 15px;
    right: 15px;
    width: calc(100% - 30px);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.top-left-cluster {
    display: flex;
    align-items: center;
    gap: 15px;
}
#music-return-btn, #music-exit-btn {
    background: none;
    border: none;
    font-size: 28px;
    font-weight: 300;
    cursor: pointer;
    color: #555;
    padding: 5px;
    line-height: 1;
}
#music-exit-btn {
    font-size: 24px;
    font-weight: 400;
}

.music-progress-bar-container {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 25px;
    margin-bottom: 10px;
}
.time-display {
    font-size: 11px;
    color: #888;
    width: 35px;
    text-align: center;
    flex-shrink: 0;
    font-family: 'SF Mono', 'Menlo', monospace;
}
.progress-bar {
    flex-grow: 1;
    height: 5px;
    background-color: #e5e5e5;
    border-radius: 2.5px;
    cursor: pointer;
}
.progress-bar-fill {
    width: 0%;
    height: 100%;
    background-color: #333;
    border-radius: 2.5px;
}

#music-lyrics-container {
    width: 100%;
    height: 192px;
    overflow: hidden;
    position: relative;
    -webkit-mask-image: linear-gradient(transparent, black 20%, black 80%, transparent);
    mask-image: linear-gradient(transparent, black 20%, black 80%, transparent);
}

#music-lyrics-list {
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: transform 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
}

.lyric-line {
    padding: 4px 0;
    font-size: 14px;
    color: #666;
    text-align: center;
    line-height: 1.5;
    transition: all 0.5s ease;
    opacity: 0.7;
    transform: scale(0.95);
}

.lyric-line.active {
    font-size: 16px;
    color: #000;
    opacity: 1;
    transform: scale(1);
}

.music-player-controls-wrapper {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.music-controls {
    margin-top: 0;
}

#music-return-btn, #music-exit-btn, #music-playlist-btn {
    position: relative;
}

#music-return-btn { top: -2px; }
#music-playlist-btn { top: -3px; }

.playlist-item-actions {
    display: flex;
    align-items: center;
    gap: 15px;
}
.playlist-action-btn {
    font-size: 18px;
    color: #888;
    cursor: pointer;
    transition: color 0.2s;
}
.playlist-action-btn:hover { color: #000; }
.delete-track-btn { font-size: 24px; color: #ff3b30; }
.delete-track-btn:hover { color: #c00; }
.lyrics-btn { font-weight: 500; }

/* ---  --- */
.message-bubble .avatar {
    width: 34px;
    height: 34px;
    border-radius: 20%;
    object-fit: cover;
    flex-shrink: 0; /*  */
}

/*    */

/* 1.  */
.recalled-message-placeholder {
    align-self: center; /*  */
    padding: 4px 12px;
    margin: 5px 0;
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    border-radius: 10px;
    text-align: center;
    max-width: 80%;
    cursor: pointer; /*  */
}

/* 2.  */
#phone-screen.dark-mode .recalled-message-placeholder {
    background-color: rgba(255, 255, 255, 0.15);
}

/* 3. AI */
@keyframes recall-animation {
  from {
    opacity: 1;
    transform: scale(1);
  }
  to {
    opacity: 0;
    transform: scale(0.8);
  }
}

.message-wrapper.recalled-animation {
  animation: recall-animation 0.3s ease-out forwards;
}

/*  CSS  */

/*    */

/*  */
.recalled-message-placeholder {
    white-space: nowrap; /*  */
    display: inline-block; /*  */
    padding: 4px 12px;
}

/*  CSS  */

/*    */
.world-book-group-container {
    border-bottom: 1px solid var(--border-color);
}
.world-book-group-container:first-child {
    border-top: 1px solid var(--border-color);
}
.world-book-group-header {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    cursor: pointer;
    background-color: #f7f7f7;
}
.world-book-group-header .arrow {
    font-size: 14px;
    margin-right: 8px;
    transition: transform 0.2s ease;
}
.world-book-group-header.collapsed .arrow {
    transform: rotate(-90deg);
}
.world-book-group-header .group-name {
    font-weight: 600;
    font-size: 15px;
}
.world-book-group-content {
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}
.world-book-group-content.collapsed {
    max-height: 0;
}
#phone-screen.dark-mode .world-book-group-header {
    background-color: #1c1c1e;
}
/*  CSS  */

/*  /  */
.frame-tabs {
    display: flex;
    background-color: #f0f0f0;
    padding: 4px;
    margin: 15px;
    border-radius: 8px;
}
.frame-tab {
    flex: 1;
    text-align: center;
    padding: 8px;
    font-size: 14px;
    font-weight: 500;
    color: #555;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s ease-in-out;
}
.frame-tab.active {
    background-color: #ffffff;
    color: #000000;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
/*  CSS  */

/*  CSS <style>   */

/* 1.  */
.wb-category-header {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    cursor: pointer;
    background-color: #f0f2f5; /*  */
    font-weight: 600; /*  */
}
#phone-screen.dark-mode .wb-category-header {
    background-color: #2c2c2e; /*  */
}


/* 2. / */
.wb-category-header .arrow {
    font-size: 12px;
    margin-right: 8px;
    transition: transform 0.2s ease;
}

/* 3.  */
.wb-category-header.collapsed .arrow {
    transform: rotate(-90deg);
}

/* 4.  */
.wb-book-container {
    padding-left: 20px; /*  */
    max-height: 1000px; /*  */
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}

/* 5. 0 */
.wb-book-container.collapsed {
    max-height: 0;
}

/* 6. label */
.wb-book-container label {
    padding: 8px 12px;
}

/*  CSS  */

/*   -   */

/* 1.  */
.wb-category-header > span:last-of-type {
    font-size: 14px;
    font-weight: 700; /*  */
    color: var(--text-primary);
}

/* 2.  */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+1) .arrow { color: #007bff; } /*  */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+2) .arrow { color: #28a745; } /*  */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+3) .arrow { color: #fd7e14; } /*  */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+4) .arrow { color: #6f42c1; } /*  */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+5) .arrow { color: #dc3545; } /*  */
#world-book-checkboxes-container .wb-category-header:nth-of-type(6n+6) .arrow { color: #ffc107; } /*  */

/*  CSS  */

/* ===  () === */
.change-frame-btn {
    padding: 6px 10px;
    border: 1px solid #ccc;
    background-color: #f0f0f0;
    border-radius: 5px;
    cursor: pointer;
    font-size: 13px;
    margin-left: 10px;
}

#avatar-frame-modal .modal-content {
    height: 70%; /*  */
}

#avatar-frame-modal .modal-body {
    padding: 0;
    display: flex;
    flex-direction: column;
}
      
.frame-tabs {
    display: flex;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
}

.frame-tab {
    flex: 1;
    padding: 12px;
    text-align: center;
    font-weight: 500;
    cursor: pointer;
    color: var(--text-secondary);
    border-bottom: 2px solid transparent;
}

.frame-tab.active {
    color: var(--accent-color);
    border-bottom-color: var(--accent-color);
}

.frame-content {
    flex-grow: 1;
    overflow-y: auto;
    padding: 15px;
}

.frame-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); /* 70px */
    gap: 15px;
}

.frame-item {
    aspect-ratio: 1 / 1; /*  */
    border: 2px solid transparent;
    border-radius: 10px;
    cursor: pointer;
    background-color: #f0f0f0;
    background-size: cover;
    background-position: center;
    padding: 5px;
    transition: all 0.2s ease;
    position: relative; /*  */
}

.frame-item.selected {
    border-color: var(--accent-color);
    transform: scale(1.05);
}

.frame-item .preview-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

.frame-item .preview-frame {
    position: absolute;
    top: -7px;
    left: 0;
    width: 100%;
    height: 100%;
}

/*  CSS  */
.avatar-with-frame {
    position: relative;
    width: 34px; /*  */
    height: 34px;
    flex-shrink: 0;
}
.avatar-with-frame .avatar-img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 50%; /*  */
    object-fit: cover;
    z-index: 1;
}
.avatar-with-frame .avatar-frame {
    position: absolute;
    /* 1 */
    /* 1.5 */
    /*  140%  160% */
    width: 135%; 
    height: 135%;

    /* 2transform */
    top: 43%; /*  */
    left: 50%;
    /*  */
    transform: translate(-50%, -50%); 
    
    z-index: 2;
    pointer-events: none; /*  */
}
/*    */

/*   (Bug)  */

/* 1.  ( display:flex) */
.chat-list-item-swipe-container {
    position: relative;
    overflow: hidden;
}

/* 2.  () */
.chat-list-item-content {
    position: relative;
    z-index: 2;
    background-color: var(--secondary-bg);
    transition: transform 0.3s ease, background-color 0.3s ease;
    width: 100%;
    flex-shrink: 0;
}

/* 3. 1 */
.chat-list-item-content.pinned {
    background-color: #f0f2f5; /*  () */
}
#phone-screen.dark-mode .chat-list-item-content.pinned {
    background-color: #3a3a3c; /*  () */
}

/* 4.  () */
.swipe-actions {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
    display: flex;
}

/* 5.  () */
.swipe-action-btn {
    height: 100%;
    padding: 0 20px;
    border: none;
    color: white;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 80px;
}

.swipe-action-btn.pin { background-color: #f0ad4e; }
.swipe-action-btn.unpin { background-color: #777; }
.swipe-action-btn.delete { background-color: #ff3b30; }

/* 6.  () */
.chat-list-item-content.swiped {
    transform: translateX(-160px);
}

/* 7.  () */
.chat-list-item {
    border-bottom: none;
}
.chat-list-item-swipe-container:not(:last-child) {
     border-bottom: 1px solid var(--border-color);
}
.chat-group-container {
    border-bottom: 1px solid var(--border-color);
}
.chat-group-container:first-of-type {
    border-top: 1px solid var(--border-color);
}
/*    */

/*   .date-stamp   */

/*  */
.date-stamp-wrapper {
    justify-content: center;
    align-self: center;
    margin: 10px 0;
    max-width: 80%;
}

/*  */
.date-stamp-bubble {
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    padding: 4px 12px;
    border-radius: 10px;
}

/*  */
#phone-screen.dark-mode .date-stamp-bubble {
    background-color: rgba(255, 255, 255, 0.15);
}
/*    */

/*  CSS <style>   */
.chat-list-time {
    font-size: 12px;
    color: var(--text-secondary);
    text-align: right;
    margin-left: 8px; /*  */
    flex-shrink: 0;   /*  */
    align-self: flex-start; /*  */
    padding-top: 2px; /*  */
}
/*  CSS  */

/*  CSS <style>   */
.chat-list-right-column {
    display: flex;
    flex-direction: column;
    align-items: flex-end; /*  */
    gap: 4px; /*  */
    flex-shrink: 0;
    margin-left: 8px;
}
/*  CSS  */

/*    */

/*  */
.search-result-item {
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    display: flex;
    gap: 12px;
    align-items: flex-start;
}
.search-result-item:hover {
    background-color: #f5f5f5;
}
#phone-screen.dark-mode .search-result-item:hover {
    background-color: #2c2c2e;
}

.search-result-item .avatar {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
}

.search-result-item .result-content {
    flex-grow: 1;
    overflow: hidden;
}

.search-result-item .result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.search-result-item .result-sender {
    font-weight: 600;
    font-size: 15px;
}

.search-result-item .result-timestamp {
    font-size: 12px;
    color: var(--text-secondary);
}

.search-result-item .result-message-snippet {
    font-size: 14px;
    color: var(--text-primary);
    line-height: 1.5;
    word-break: break-word;
}

/*  */
.search-result-item .highlight {
    background-color: #ffd700;
    color: #000;
    font-weight: bold;
    border-radius: 3px;
    padding: 1px 3px;
}
#phone-screen.dark-mode .search-result-item .highlight {
    background-color: #ffc107;
}


/*   ()  */

/* 1.  */
@keyframes jump-highlight-text {
    0% {
        background-color: transparent; /*  */
        color: inherit; /*  */
    }
    50% {
        background-color: #ffd700; /*  */
        color: #000000 !important; /*  */
    }
    100% {
        background-color: transparent; /*  */
        color: inherit; /*  */
    }
}

/* 2.  .content  */
/*     */
.jump-highlight-animation .content {
    animation: jump-highlight-text 1.5s ease-in-out;
    border-radius: 5px; /* () */
}

/*    */

/*    */
#chat-search-screen {
    background-color: #f0f2f5; /*  */
}
#search-controls {
    background-color: var(--secondary-bg); /*  */
}
#phone-screen.dark-mode #chat-search-screen {
    background-color: #000000;
}
/*    */

/*    */

/* 1.  */
#lock-screen {
    /*  z-index  */
    z-index: 999; 
    background-size: cover;
    background-position: center;
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: space-between; /*  */
    align-items: center;
    padding: 80px 20px 50px 20px;
    box-sizing: border-box;
    transition: transform 0.3s ease-out;
}

/* 2.  () */
#lock-clock-container {
    text-align: center;
    text-shadow: 0 3px 8px rgba(0,0,0,0.4);
    flex-shrink: 0;
}
#lock-main-time {
    font-size: 80px;
    font-weight: 200;
}
#lock-main-date {
    font-size: 18px;
    font-weight: 500;
}

/* 3.  */
#unlock-hint {
    font-size: 16px;
    font-weight: 500;
    text-shadow: 0 1px 4px rgba(0,0,0,0.3);
    /*  */
    animation: hint-pulse 2s infinite ease-in-out;
}
@keyframes hint-pulse {
    0%, 100% { opacity: 0.7; transform: translateY(0); }
    50% { opacity: 1; transform: translateY(-5px); }
}

/* 4.  */
#password-modal-overlay {
    /*  */
    background-color: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 1000; /*  */
}

/* 5.  */
.password-modal-content {
    background-color: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    width: 280px;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    text-align: center;
    display: flex;
    flex-direction: column;
    gap: 15px;
    color: #333;
}
.password-modal-content p {
    font-size: 17px;
    font-weight: 600;
    margin: 0;
}

/* 6.  */
#password-input-field {
    width: 100%;
    padding: 12px;
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 8px;
    font-size: 16px;
    text-align: center;
    box-sizing: border-box;
    background-color: rgba(255,255,255,0.7);
}
#password-input-field:focus {
    outline: none;
    border-color: var(--accent-color);
}

/* 7.  */
.password-actions {
    display: flex;
    gap: 10px;
    margin-top: 5px;
}
.password-actions button {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
}
#password-cancel-btn {
    background-color: #e9ecef;
    color: #495057;
}
#password-confirm-btn {
    background-color: var(--accent-color);
    color: white;
}

/* 8.  */
@keyframes shake-error {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
  20%, 40%, 60%, 80% { transform: translateX(5px); }
}
.password-modal-content.error {
    animation: shake-error 0.4s ease-in-out;
}
/*    */

/*  /APICSS  */
.bubble-preset-manager {
    display: flex;
    align-items: center;
    gap: 10px; /*  */
}

/*  */
.bubble-preset-manager select {
    flex-grow: 1; /*  */
}

/*  */
.bubble-preset-manager .action-btn {
    flex-shrink: 0; /*  */
    padding: 8px 10px;
    font-size: 13px;
    background-color: #e9ecef;
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
}
/*  CSS  */

/*  CSS <style>   */

/* 1.  */
/*  */
#lock-screen, #home-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}

/* 2.  */
#lock-screen-background-blur {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1; /* 1 */
    
    background-size: cover;
    background-position: center;

    /* 2 */
    filter: blur(20px);
    -webkit-filter: blur(20px);
    
    /* ()  */
    transform: scale(1.1); 

    /* 3 */
    display: none;
    opacity: 0;
    transition: opacity 0.3s ease-out;
}

/*  CSS  */

/*    */

/* ===  === */

/* 1. gap */
.wb-category-header {
    display: flex;
    align-items: center;
    gap: 8px; /*  */
    padding: 10px 12px;
    cursor: pointer;
    background-color: #f0f2f5;
    font-weight: 600;
    overflow: hidden; /*  */
}

/* 2.  */
.wb-category-header > span:last-of-type {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 3.  */
.wb-category-header input[type="checkbox"],
.wb-book-container input[type="checkbox"] {
    width: auto !important; /* !important */
    flex-shrink: 0;         /*  */
}

/* 4. iOS */
.wb-book-container label {
    display: flex;
    align-items: center;
    justify-content: flex-start; /* */
    padding: 8px 12px;
    gap: 10px; /*  */
    overflow: hidden;
}

/* 5.  */
.wb-book-container label .wb-book-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-align: left;
}

/* 6.  */
#phone-screen.dark-mode .wb-category-header {
    background-color: #2c2c2e;
}

/* 7.  */
.wb-category-header .arrow {
    font-size: 12px;
    transition: transform 0.2s ease;
}
.wb-category-header.collapsed .arrow {
    transform: rotate(-90deg);
}

/* 8.  */
.wb-book-container {
    padding-left: 20px;
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}
.wb-book-container.collapsed {
    max-height: 0;
}

/*    */

/*    */
#chat-input-actions-top.grabbing {
    cursor: grabbing;
    cursor: -webkit-grabbing;
    user-select: none; /*  */
}
/*  CSS  */

#status-bar-time::after {
    content: "JCY";
    color: var(--status-bar-text-color); /* <--  */
    font-size: 11px;
    font-weight: 500;
    opacity: 0.6; /*  */
    margin-left: 8px;
    user-select: none;
    transition: color 0.3s;
}

    </style>
    <!--    -->
    <style id="custom-theme-style"></style>
<style id="dynamic-font-style"></style><style id="custom-bubble-style"></style><style id="preview-bubble-style"></style><style class="huiyi-global">
    .huiyi-dialog-parent-no-scroll{
      overflow: hidden !important;
    }
    </style></head>
<body ai-translate-version="2.0.0" ai-translate-id="dkmejdpchbkcihdlengmhifgnigdjmba" ai-translate-oem="lenovo">
        <div id="phone-screen">
            <div id="status-bar">
                <span id="status-bar-time">19:25</span>
                <div id="status-bar-battery" class="battery-container">
                    <span class="battery-text">85%</span>
                    <div class="battery-icon">
                        <div class="battery-level" style="width: 85%;"></div>
                    </div>
                </div>
            </div>
            <div id="notification-bar"><img id="notification-avatar" src="https://ziyong.netlify.app/borderless.html"><div id="notification-content"><div class="name"></div><div class="message"></div></div></div>

<!--    -->
<div id="lock-screen-background-blur" style="display: none; opacity: 0;"></div>
<!--    -->
            
            <div id="home-screen" class="screen active" style="background-image: linear-gradient(135deg, rgb(137, 247, 254), rgb(102, 166, 255));">
                <div id="clock-container"><div id="main-time">19:25</div><div id="main-date">812</div></div>
                                                <!--   id="app-grid"  -->
<div id="app-grid">
    <!-- 2 -->
    <div class="app-row">
        <div class="app-icon" onclick="showScreen(&#39;world-book-screen&#39;)">
            <div class="icon-bg">
                <!-- 1ID -->
                <img id="icon-img-world-book" src="./EPhone_files/IMG-6435.jpg" alt="">
            </div>
            <span class="label"></span>
        </div>
        <div class="app-icon" onclick="showScreen(&#39;chat-list-screen&#39;)">
            <div class="icon-bg">
                <!-- 2ID -->
                <img id="icon-img-qq" src="./EPhone_files/IMG-6436.jpg" alt="QQ">
            </div>
            <span class="label">QQ</span>
        </div>
    </div>
    <!-- 3 -->
    <div class="app-row">
        <div class="app-icon" onclick="showScreen(&#39;api-settings-screen&#39;)">
            <div class="icon-bg">
                <!-- 3ID -->
                <img id="icon-img-api-settings" src="./EPhone_files/IMG-6438.jpg" alt="API">
            </div>
            <span class="label">API</span>
        </div>
        <div class="app-icon" onclick="showScreen(&#39;wallpaper-screen&#39;)">
            <div class="icon-bg">
                <!-- 4ID -->
                <img id="icon-img-wallpaper" src="./EPhone_files/IMG-6440.jpg" alt="">
            </div>
            <span class="label"></span>
        </div>
        <div class="app-icon" onclick="showScreen(&#39;font-settings-screen&#39;)">
            <div class="icon-bg">
                <!-- 5ID -->
                <img id="icon-img-font" src="./EPhone_files/IMG-6442.jpg" alt="">
            </div>
            <span class="label"></span>
        </div>
    </div>
</div>
<!--    -->
            </div>
          
<div id="world-book-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen(&#39;home-screen&#39;)"></span>
        <span></span>
        <div class="header-actions"> <!--  -->
            <span class="action-btn" id="manage-world-book-categories-btn"></span>
            <span class="action-btn" id="add-world-book-btn">+</span>
        </div>
    </div>
    <div id="world-book-list"></div>
</div>
            <div id="world-book-editor-screen" class="screen">
                <div class="header">
                    <span class="back-btn" onclick="showScreen(&#39;world-book-screen&#39;)"></span>
                    <span id="world-book-editor-title"></span>
                    <span class="save-btn" id="save-world-book-btn"></span>
                </div>
                <div class="form-container">
                    <div class="form-group">
                        <label for="world-book-name-input"></label>
                        <input type="text" id="world-book-name-input" placeholder="...">
                    </div>

        <!--    -->
        <div class="form-group">
            <label for="world-book-category-select"></label>
            <select id="world-book-category-select">
                <!-- JS -->
            </select>
        </div>
        <!--    -->

                    <div class="form-group" style="height: 100%;">
                        <label for="world-book-content-input"></label>
                        <textarea id="world-book-content-input" placeholder="..."></textarea>
                    </div>
                </div>
            </div>

            <div id="api-settings-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen(&#39;home-screen&#39;)"></span><span>API </span><span style="width: 30px;"></span></div><div class="form-container"><p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;">: , Vision(), <code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4o</code><code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4-vision-preview</code></p><div class="form-group"><label for="proxy-url"> (/v1~)</label><input type="text" id="proxy-url" placeholder=": https://api.openai.com"></div><div class="form-group"><label for="api-key"> ()</label><input type="password" id="api-key" placeholder="sk-..."></div><div class="form-group"><label for="model-select"></label><select id="model-select"></select></div>
<!--  HTML   form-group   -->
<div class="form-group">
    <label>API </label>
    <div class="bubble-preset-manager"> <!--  -->
        <select id="api-preset-select" class="form-group select"></select>
        <button id="manage-api-presets-btn" class="action-btn"></button>
    </div>
</div>
<!--    -->
<button class="form-button" id="fetch-models-btn"></button>

<!--   API   -->
<hr style="margin:20px 0; opacity:.3">
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
    <label for="background-activity-switch" style="margin-bottom: 0;">
        
        <p style="font-size: 12px; font-weight: normal; color: #ff6b6b; margin-top: 5px;">
            API
        </p>
    </label>
    <input type="checkbox" id="background-activity-switch" style="width: auto; height: 20px;">
</div>
<!--    -->

<!--    -->
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
    <label for="background-interval-input" style="margin-bottom: 0;">
         ()
        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
             60-300
        </p>
    </label>
    <input type="number" id="background-interval-input" min="30" value="60" style="width: 80px; text-align: center;">
</div>
<!--    -->

<!--    -->
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
    <label for="block-cooldown-input" style="margin-bottom: 0;">
        AI ()
        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
            AI
        </p>
    </label>
    <input type="number" id="block-cooldown-input" min="0.1" step="0.1" value="1" style="width: 80px; text-align: center;">
</div>
<!--    -->

<button class="form-button" id="save-api-settings-btn"></button>
			<hr style="margin:20px 0; opacity:.3">

			<button class="form-button" id="export-data-btn"></button>

<!--   class -->
<button class="form-button" id="import-btn"></button>

<!--   -->
<input id="import-data-input" type="file" accept="application/json" hidden="">
</div></div>
<!--   chat-list-screen  -->
<div id="chat-list-screen" class="screen">
    
    <!--  () -->
    <div class="header" id="main-chat-list-header">
        <span class="back-btn" onclick="showScreen(&#39;home-screen&#39;)"></span>
<span id="chat-list-title"></span>
        <div class="header-actions">
            <span class="action-btn" id="add-group-chat-btn" title=""><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M21 21L19 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></span>
            <span class="action-btn" id="add-chat-btn">+</span>
        </div>
    </div>

    <!--  -->
    <div id="messages-view" class="chat-list-view active">
        <div id="chat-list">
            <!-- JS -->
        </div>
    </div>

    <!--  -->
    <div id="qzone-screen" class="chat-list-view">
        <div class="qzone-header">
            <span class="back-btn" id="qzone-back-btn"></span> <!--  -->
            <span></span>
        </div>
        <div class="qzone-content">
            <div class="qzone-profile-header">
                <div id="qzone-banner-container" class="qzone-banner-container">
                    <img id="qzone-banner-img" src="./EPhone_files/r5heyt.gif" alt="">
                    <input type="file" id="qzone-banner-input" accept="image/*" hidden="">
                </div>
                <div class="qzone-user-info">
                    <div id="qzone-avatar-container" class="qzone-avatar-container">
                        <img id="qzone-avatar-img" src="./EPhone_files/q6z5fc.jpeg" alt="">
                        <input type="file" id="qzone-avatar-input" accept="image/*" hidden="">
                    </div>
                    <span id="qzone-nickname">{{user}}</span>
                </div>
            </div>
            <div class="qzone-actions-bar">
                <div class="action-item" id="create-shuoshuo-btn"><span></span></div>
                <div class="action-item" id="create-post-btn"><span></span></div>
                <div class="action-item" id="open-album-btn"><span></span></div>
            </div>
            <div id="qzone-posts-list"></div>
        </div>
    </div>

    <!--  -->
    <div id="favorites-view" class="chat-list-view">
    <div class="header"> 
        <span class="back-btn" id="favorites-back-btn"></span>
        <span></span>
        <!--  -->
        <span class="action-btn" id="favorites-edit-btn"></span>
    </div>

        <!--  -->
        <div class="search-bar-container">
            <input type="search" id="favorites-search-input" placeholder="...">
            <button id="favorites-search-clear-btn" class="search-clear-btn" style="display: none;"></button>
        </div>

        <div id="favorites-list" class="list-container">
            <!-- JS -->
        </div>

<!--  -->
<div id="favorites-action-bar" style="display: none;">
    <button id="favorites-delete-selected-btn" class="action-bar-btn"> (0)</button>
</div>

    </div>

<!--    -->
<div id="memories-view" class="chat-list-view">
    <div class="header"> 
        <span class="back-btn" id="memories-back-btn"></span>
        <span></span>
            <span class="action-btn" id="add-countdown-btn">+</span>
        </div>
    <div id="memories-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
        <!-- JS -->
    </div>
</div>
<!--  HTML  -->
    
    <!--  -->
<div id="chat-list-bottom-nav">
    <div class="nav-item active" data-view="messages-view">
        <span></span>
    </div>
    <div class="nav-item" data-view="qzone-screen">
        <span></span>
    </div>
    <!--    -->
    <div class="nav-item" data-view="memories-view">
        <span></span>
    </div>
    <!--    -->
    <div class="nav-item" data-view="favorites-view">
        <span></span>
    </div>
</div>
</div>
<!--    -->

<!--   HTML  id="chat-list-screen"  div   -->
<div id="album-screen" class="screen">
    <!-- 1.  -->
    <div class="header">
        <span class="back-btn" id="album-back-btn"></span>
        <span></span>
        <span class="action-btn" id="create-album-btn-page">+</span>
    </div>
    
    <!-- 2.  -->
    <div class="list-container">
        <div id="album-grid-page">
            <!--  JS  -->
        </div>
    </div>
</div>
<!--   HTML   -->

<!--   HTML  id="album-screen"  div   -->
<div id="album-photos-screen" class="screen">
    <!-- 1.  -->
    <div class="header">
        <span class="back-btn" id="album-photos-back-btn"></span>
        <span id="album-photos-title"></span>
        <span class="action-btn" id="album-upload-photo-btn"></span>
    </div>
    
    <!-- 2.  -->
    <div class="list-container">
        <div id="photos-grid-page">
            <!--  JS  -->
        </div>

<!--   HTML   -->
<div id="photo-viewer-modal" class="modal">
    <!-- 1.  -->
    <button id="photo-viewer-close-btn"></button>
    
    <!-- 2.  -->
    <button id="photo-viewer-prev-btn" class="nav-arrow"></button>
    
    <!-- 3.  -->
    <div class="photo-viewer-content">
        <img id="photo-viewer-image" src="https://ziyong.netlify.app/borderless.html" alt="">
    </div>
    
    <!-- 4.  -->
    <button id="photo-viewer-next-btn" class="nav-arrow"></button>
</div>
<!--   HTML   -->

    </div>
</div>
<!--   HTML   -->

<!--   #album-photos-screen  div   -->
<input type="file" id="album-photo-input" accept="image/*" multiple="" hidden="">
            
<!--   #chat-interface-screen   -->
<div id="chat-interface-screen" class="screen">

    <!-- Header -->
    <div class="header">
        <!--  -->
        <div class="default-controls">
            <span class="back-btn" id="back-to-list-btn"></span>
            
            <!--    -->
            <div id="chat-header-title-wrapper">
                <span id="chat-header-title"></span>
                <div id="chat-header-status">
                    <span class="status-dot"></span>
                    <span class="status-text"></span>
                </div>
            </div>
            <!--    -->

            <div class="header-actions">
                <span class="action-btn" id="listen-together-btn" title=""><img src="./EPhone_files/210-20250618115221.png" alt=""></span>
                <span class="action-btn" id="chat-settings-btn" title=""><img src="./EPhone_files/CCA834-BA-5-A90-408-D-94-FA-7-EE156-B6-A765.png" alt=""></span>
            </div>
        </div>

        <!--  () -->
        <div class="selection-controls">
            <span id="selection-cancel-btn"></span>
            <span id="selection-count"></span>
            <div class="header-actions">
               <span id="selection-favorite-btn" class="action-btn"></span>
       <span id="selection-share-btn" class="action-btn"></span> 
               <span id="selection-delete-btn" class="action-btn" style="color: #ff3b30;"></span>
            </div>
        </div>
    </div>
    
    <!--  () -->
    <div id="chat-messages"><div id="typing-indicator">...</div></div>

    <!--  () -->
    <div id="chat-input-area">
<div id="reply-preview-bar">
    <div class="reply-preview-content">
        <div class="sender"> xxx:</div>
        <div class="text">...</div>
    </div>
    <span id="cancel-reply-btn"></span>
</div>
        <div id="chat-input-actions-top">
            <button id="open-sticker-panel-btn" class="chat-action-icon-btn action-button" title=""><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <line x1="12" y1="5" x2="12" y2="19"></line>
    <line x1="5" y1="12" x2="19" y2="12"></line>
</svg></button>
            <button id="send-photo-btn" class="chat-action-icon-btn action-button" title=""><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg></button>
            <button id="upload-image-btn" class="chat-action-icon-btn action-button" title=""><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></button>
<button id="transfer-btn" class="chat-action-icon-btn action-button" title="">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M7 4L12 12L17 4M12 12V20M8 10H16M8 13H16"></path>
</svg>
</button>
            <button id="voice-message-btn" class="chat-action-icon-btn action-button" title=""><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><path d="M12 19v4"></path><path d="M8 23h8"></path></svg></button>
<!--    -->
<button id="send-waimai-request-btn" class="chat-action-icon-btn action-button" title=""><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg></button>
<!--    -->
<!--    -->
<button id="video-call-btn" class="chat-action-icon-btn action-button" title=""><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg></button>
<!--   
<!--   -->
<button id="group-video-call-btn" class="chat-action-icon-btn action-button" title=""><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></button>
<!--    -->
<!--  -->
<button id="send-poll-btn" class="chat-action-icon-btn action-button" title=""><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h10"></path><path d="M6 6h.01"></path><path d="M8 12h10"></path><path d="M6 12h.01"></path><path d="M8 18h10"></path><path d="M6 18h.01"></path></svg></button>
<!--    -->
<!--   id="chat-input-actions-top"   -->
<button id="share-link-btn" class="chat-action-icon-btn action-button" title=""><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg></button>
<!--  HTML  -->
        </div>
        <div id="chat-input-main-row">
            <textarea id="chat-input" rows="1" placeholder="..."></textarea>
            <div id="input-actions-wrapper">
                <button id="wait-reply-btn" title=""><img src="https://i.postimg.cc/q72zq80N/ECE92-BBC-BE57-48-E9-BB2-C-345-B6019-C4-B2.png" alt=""></button>
                <button id="send-btn" class="action-button"></button>
            </div>
        </div>
    </div>

<!--    -->
<div id="chat-lock-overlay">
    <div id="chat-lock-content"></div>
</div>
<!--    -->

    <!--  () -->
    <div id="sticker-panel">
        <div id="sticker-panel-header">
            <span class="panel-btn" id="close-sticker-panel-btn"></span>
            <span class="title"></span>
            <div style="display: flex; gap: 10px;">
              <span class="panel-btn" id="add-sticker-btn"></span>
              <span class="panel-btn" id="upload-sticker-btn"></span>
            </div>
        </div>
        <div id="sticker-grid"></div>
    </div>
    <input type="file" id="sticker-upload-input" accept="image/*" style="display: none;">
    <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
    
    <!--  () -->
<div id="music-player-overlay">
    <div class="music-player-window">
        
        <!-- 1.  -->
        <div class="music-player-top-actions">
            <div class="top-left-cluster">
                <button id="music-return-btn"></button>
                <button id="music-exit-btn"></button>
            </div>
            <span id="music-playlist-btn"></span>
        </div>
        
        <!-- 2.  -->
        <div id="music-time-counter">0.0</div>
        <div id="music-player-song-title"></div>
        <div id="music-player-artist">...</div>
        
        <!-- 3.  -->
        <div id="music-lyrics-container">
            <div id="music-lyrics-list">
                <!-- JS -->
                <div class="lyric-line">  </div>
            </div>
        </div>
        
        <!-- 4.  -->
        <div class="music-player-controls-wrapper">
            <!-- a. iOS -->
            <div class="music-progress-bar-container">
                <div id="music-current-time" class="time-display">0:00</div>
                <div class="progress-bar">
                    <div id="music-progress-fill" class="progress-bar-fill"></div>
                </div>
                <div id="music-total-time" class="time-display">0:00</div>
            </div>
            
            <!-- b.  -->
            <div class="music-controls">
                <button id="music-prev-btn"></button>
                <button id="music-play-pause-btn" class="play-pause-btn"></button>
                <button id="music-next-btn"></button>
                <button id="music-mode-btn"></button>
            </div>
        </div>

    </div>
</div>
    
    <div id="music-playlist-panel">
        <div class="playlist-header">
            <span class="panel-btn" id="close-playlist-btn"></span>
            <span></span>
            <div>
                <span class="panel-btn" id="add-song-local-btn"></span>
                <span class="panel-btn" id="add-song-url-btn">URL</span>
            </div>
        </div>
        <div class="playlist-body" id="playlist-body"></div>
    </div>
    <input type="file" id="local-song-upload-input" accept="audio/*" multiple="" style="display: none;">
<input type="file" id="lrc-upload-input" accept=".lrc" style="display: none;">
</div>
<!--    -->

<!--   id="wallpaper-screen"  -->
<div id="wallpaper-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen(&#39;home-screen&#39;)"></span>
        <!-- 1 -->
        <span></span>
        <span style="width: 30px;"></span>
    </div>
    <div class="form-container">
        <!--  () -->
        <div style="width:100%; text-align: left; margin-bottom: 5px;">
            <label style="font-weight: 500; color: var(--text-secondary);"></label>
        </div>
        <div id="lockscreen-wallpaper-preview" class="wallpaper-preview"></div>
        <button class="form-button" onclick="document.getElementById(&#39;lockscreen-wallpaper-upload-input&#39;).click();"></button>
        <input type="file" id="lockscreen-wallpaper-upload-input" accept="image/*" hidden="">
        
        <div class="form-group" style="width: 100%; margin-top: 15px;">
            <label for="password-set-input"> ()</label>
            <input type="text" id="password-set-input" placeholder="">
        </div>
        
        <hr style="width: 80%; opacity: 0.3; margin: 20px 0;">

        <!--  () -->
        <div style="width:100%; text-align: left; margin-bottom: 5px;">
            <label style="font-weight: 500; color: var(--text-secondary);"></label>
        </div>
        <div id="wallpaper-preview"></div>
        <button class="form-button" onclick="document.getElementById(&#39;wallpaper-upload-input&#39;).click();"></button>
        <input type="file" id="wallpaper-upload-input" accept="image/*">

<!--    -->
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
    <label for="theme-toggle-switch" style="margin-bottom: 0;"></label>
    <label class="toggle-switch">
        <input type="checkbox" id="theme-toggle-switch">
        <span class="slider"></span>
    </label>
</div>
<!--    -->

    <!-- ===  UI  === -->
    <div style="width:100%; text-align: left; margin-bottom: 15px;">
        <label style="font-weight: 500; color: var(--text-secondary);"> (CSS)</label>
    </div>

    <!--  -->
    <div class="form-group">
        <label for="theme-selector"></label>
        <div style="display: flex; gap: 10px;">
            <select id="theme-selector" style="flex-grow: 1;"><option value="">--  --</option></select>
            <button id="rename-theme-btn" class="form-button-secondary" style="margin:0; padding: 0 10px;"></button>
            <button id="delete-theme-btn" class="form-button-secondary" style="margin:0; padding: 0 10px; background-color: #ffdddd; color: #ff3b30;"></button>
        </div>
    </div>

    <!-- CSS  -->
    <div class="form-group">
        <label for="theme-css-editor"></label>
        <textarea id="theme-css-editor" rows="10" style="font-family: monospace; font-size: 12px; resize: vertical;" placeholder="..."></textarea>
    </div>
    
    <!--  -->
    <button id="apply-theme-btn" class="form-button"></button>
    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button id="save-theme-btn" class="form-button-secondary" style="flex:1;"></button>
        <button id="save-as-new-theme-btn" class="form-button-secondary" style="flex:1;"></button>
    </div>
    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button id="export-theme-btn" class="form-button-secondary" style="flex:1;"></button>
        <button id="import-theme-btn" class="form-button-secondary" style="flex:1;"></button>
        <input type="file" id="import-theme-input" accept=".json" hidden="">
    </div>
    <!-- ===  UI  === -->
        
        <!-- 2 -->
        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        <div style="width:100%; text-align: left; margin-bottom: 15px;">
            <label style="font-weight: 500; color: var(--text-secondary);">App </label>
        </div>
        <div id="icon-settings-grid">
            <!-- JS -->
        </div>

<!--    -->
<hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
<div style="width:100%; text-align: left; margin-bottom: 15px;">
    <label style="font-weight: 500; color: var(--text-secondary);"></label>
</div>
<div class="form-group" style="width: 100%;">
    <label for="ringtone-url-input"> URL (.mp3, .wav, etc.)</label>
    <input type="text" id="ringtone-url-input" placeholder="...">
</div>
<!--    -->
        
        <!-- 3 -->
        <button class="form-button" id="save-wallpaper-btn" style="margin-top: 30px;"></button>
    </div>
</div>
<!--    -->

<!--   HTML  -->
<div id="browser-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="browser-back-btn"></span>
        <span id="browser-title"></span>
        <span style="width: 30px;"></span>
    </div>
    <div id="browser-content" class="list-container">
        <!-- JS -->
    </div>
</div>
<!--  HTML  -->

<div id="font-settings-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen(&#39;home-screen&#39;)"></span>
        <span></span>
        <span style="width: 30px;"></span>
    </div>
    <div class="form-container">
        <div class="form-group">
            <label for="font-url-input">URL (.ttf, .otf, .woff)</label>
            <input type="text" id="font-url-input" placeholder="https://..../font.ttf">
        </div>

        <div class="form-group">
            <label></label>
<div id="font-preview">
                <p style="font-size: 20px; margin: 0 0 10px 0;"> Hello World</p>
                <p style="margin: 0;">12345</p>
            </div>
        </div>

        <button class="form-button" id="save-font-btn"></button>
        <button class="form-button form-button-secondary" id="reset-font-btn"></button>
    </div>
</div>

<!--    -->
<div id="contact-picker-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="cancel-contact-picker-btn"></span>
        <span></span>
        <span class="save-btn" id="confirm-contact-picker-btn">(0)</span>
    </div>
    <div class="list-container" id="contact-picker-list">
        <!-- JS -->
    </div>
</div>
<!--  HTML  -->

<!--    -->
<div id="member-management-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-from-member-management"></span>
        <span></span>
        <span style="width: 30px;"></span>
    </div>
    <div class="list-container" id="member-management-list">
        <!--  -->
    </div>
    <div id="member-management-actions">
        <button id="add-existing-contact-btn"></button>
        <button id="create-new-member-btn"></button>
    </div>
</div>
<!--  HTML  -->

<!--    -->
<div id="incoming-call-modal" class="modal">
    <div class="incoming-call-content">
        <img id="caller-avatar" class="caller-avatar" src="https://ziyong.netlify.app/borderless.html">
        <div id="caller-name" class="caller-name"></div>
        <div class="caller-text"></div>
        <div class="incoming-call-actions">
            <div class="action-button-wrapper">
                <button id="decline-call-btn" class="call-action-btn decline"></button>
                <span></span>
            </div>
            <div class="action-button-wrapper">
                <button id="accept-call-btn" class="call-action-btn accept"></button>
                <span></span>
            </div>
        </div>
    </div>
</div>
<!--    -->

<!--   #video-call-screen  -->
<div id="video-call-screen" class="screen">
    <!-- 1.  () -->
    <div class="video-call-top-bar">
        <span id="call-timer">00:00</span>
    </div>
    
    <!-- 2.  -->
    <div class="video-call-avatar-area">
        <div id="participant-avatars-grid">
            <!-- JS -->
        </div>
    </div>

    <!-- 3.  () -->
    <div id="video-call-main" class="video-call-main">
        <!--  -->
    </div>
    
    <!-- 4.  -->
    <div class="video-call-controls">
        <button id="user-speak-btn" class="control-btn speak-btn"></button>
        <button id="hang-up-btn" class="control-btn hangup-btn"></button>
        <!--  -->
        <button id="join-call-btn" class="control-btn join-btn" style="display: none;"></button>
    </div>
</div>
<!--    -->

<!--    -->
<div id="outgoing-call-screen" class="screen">
    <div class="outgoing-call-content">
        <img id="outgoing-call-avatar" class="caller-avatar" src="https://ziyong.netlify.app/borderless.html">
        <div id="outgoing-call-name" class="caller-name"></div>
        <div class="caller-text">...</div>
        <div class="outgoing-call-actions">
            <button id="cancel-call-btn" class="call-action-btn decline"></button>
            <span></span>
        </div>
    </div>
</div>
<!--    -->

<!--    -->
<div id="call-history-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="call-history-back-btn"></span>
        <span id="call-history-title"></span>
        <span style="width: 30px;"></span> <!--  -->
    </div>
    <div id="call-history-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
        <!-- JS -->
    </div>
</div>
<!--  HTML  -->

<!--    -->
<div id="chat-search-screen" class="screen">
    <!-- 1.  -->
    <div class="header">
        <span class="back-btn" id="search-back-btn"></span>
        <span></span>
        <span style="width: 30px;"></span> <!--  -->
    </div>

    <!-- 2.  -->
<div id="search-controls" style="padding: 15px; border-bottom: 1px solid var(--border-color);">
    <div class="form-group">
        <label for="keyword-search-input"></label>
        <input type="search" id="keyword-search-input" placeholder="..." style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);">
    </div>
    <!-- flex div -->
    <div class="form-group">
        <label for="sender-search-select"></label>
        <select id="sender-search-select" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);">
            <!-- JS -->
        </select>
    </div>
    <div class="form-group">
        <label for="date-search-input"></label>
        <input type="date" id="date-search-input" style="width: 95%; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color);">
    </div>
</div>

    <!-- 3.  -->
    <div id="search-results-list" class="list-container" style="overflow-y: auto; padding-top: 10px;">
        <!-- JS -->
    </div>
</div>
<!--  HTML  -->

            <!--  HTML  -->
            <div id="lock-screen" class="screen" style="background-image: linear-gradient(135deg, rgb(118, 75, 162), rgb(102, 126, 234)); transition: transform 0.3s ease-out 0s; transform: translateY(0px);">
                <div id="lock-clock-container">
                    <div id="lock-main-time">19:25</div>
                    <div id="lock-main-date">812</div>
                </div>
                <div id="unlock-hint" style="transition: opacity 0.3s ease-out 0s; opacity: 0;"></div>
            </div>

            <div id="password-modal-overlay" class="modal">
                <div class="password-modal-content">
                    <p></p>
                    <input type="password" id="password-input-field" maxlength="20">
                    <div class="password-actions">
                        <button id="password-cancel-btn"></button>
                        <button id="password-confirm-btn"></button>
                    </div>
                </div>
            </div>
            <!--  HTML  -->

        </div>
    
  
    <div id="chat-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span></span></div><div class="modal-body"><div class="form-group" id="chat-name-group"><label for="chat-name-input"> / </label><input type="text" id="chat-name-input"></div>

    <!--   form-group   -->
    <div class="form-group" id="assign-group-section" style="display: none;"> <!--  -->
        <label for="assign-group-select"></label>
        <div style="display: flex; align-items: center; gap: 10px;">
            <select id="assign-group-select" style="flex-grow: 1;">
                <!-- JS -->
            </select>
            <button id="manage-groups-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;"></button>
        </div>
    </div>
    <!--    -->

<div class="form-group" id="my-group-nickname-group"><label for="my-group-nickname-input"></label><input type="text" id="my-group-nickname-input"></div><div class="form-group" id="group-avatar-group"><label></label><div class="avatar-upload"><img id="group-avatar-preview"><button onclick="document.getElementById(&#39;group-avatar-input&#39;).click()"></button><input type="file" id="group-avatar-input" accept="image/*"></div></div>
            <div class="form-group" id="world-book-link-group">
                <label> ()</label>
                <div class="custom-multiselect">
                    <div class="select-box">
                        <span class="selected-options-text">--  --</span>
                        <span class="arrow-down"></span>
                    </div>
                    <div id="world-book-checkboxes-container" class="checkboxes-container">
                    </div>
                </div>
            </div>
            <div class="form-group" id="ai-persona-group"><label for="ai-persona"> (AI Persona)</label><textarea id="ai-persona" rows="3"></textarea></div><div class="form-group" id="ai-avatar-group"><label></label><div class="avatar-upload"><img id="ai-avatar-preview"><button onclick="document.getElementById(&#39;ai-avatar-input&#39;).click()"></button><button id="manage-ai-avatar-library-btn"></button>
<button class="change-frame-btn" data-type="ai"></button> <!--   -->
<input type="file" id="ai-avatar-input" accept="image/*"></div></div><div class="form-group" id="my-persona-group"><label for="my-persona"> (My Persona)</label><textarea id="my-persona" rows="3"></textarea></div><div class="form-group" id="my-avatar-group"><label></label><div class="avatar-upload"><img id="my-avatar-preview"><button onclick="document.getElementById(&#39;my-avatar-input&#39;).click()"></button>
<button class="change-frame-btn" data-type="my"></button> <!--   -->
<button id="open-persona-library-btn"></button><input type="file" id="my-avatar-input" accept="image/*"></div></div><div class="form-group" id="group-members-group"><label></label><div id="group-members-settings"></div>

    <!--  -->
    <button id="manage-members-btn" class="form-button form-button-secondary" style="margin-top: 15px;"></button></div>
<div class="form-group"><label for="max-memory"></label><input type="number" id="max-memory" value="10"></div><div class="form-group"><label> <button id="reset-theme-btn" type="button"></button></label><div class="theme-selector"><label><input type="radio" name="theme-select" value="default" id="theme-default"> </label><label><input type="radio" name="theme-select" value="pink_blue"> </label><label><input type="radio" name="theme-select" value="blue_white"> </label><label><input type="radio" name="theme-select" value="purple_yellow"> </label><label><input type="radio" name="theme-select" value="black_white"> </label><label><input type="radio" name="theme-select" value="yellow_white"> </label><label><input type="radio" name="theme-select" value="red_black"> </label><label><input type="radio" name="theme-select" value="blue_yellow"> </label><label><input type="radio" name="theme-select" value="pink_yellow"> </label><label><input type="radio" name="theme-select" value="pink_purple"> </label><label><input type="radio" name="theme-select" value="gray_white"> </label><label><input type="radio" name="theme-select" value="blue_green"> </label><label><input type="radio" name="theme-select" value="pink_white"> </label><label><input type="radio" name="theme-select" value="pink_black"> </label><label><input type="radio" name="theme-select" value="pink_green"> </label><label><input type="radio" name="theme-select" value="green_black"> </label></div></div>

<!--   form-group   -->
<div class="form-group">
    <label for="font-size-slider"> <span id="font-size-value">13px</span></label>
    <input type="range" id="font-size-slider" min="12" max="20" step="1" value="13" style="width: 100%; margin-top: 8px;">
</div>
<!--    -->

<!--    -->
<div class="form-group">
    <label></label>
    <div class="bubble-preset-manager">
        <select id="bubble-style-preset-select" class="form-group select"></select>
        <button id="manage-bubble-presets-btn" class="action-btn"></button>
    </div>
</div>
<!--  HTML  -->

<!--   form-group   -->
<div class="form-group">
    <label for="custom-css-input">
         (CSS)
        <button id="reset-custom-css-btn" type="button" style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;"></button>
    </label>
    <textarea id="custom-css-input" rows="5" style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 12px; resize: vertical;" placeholder="/*  */
.message-bubble.user .content {
  background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  border-radius: 15px 4px 15px 15px;
}"></textarea>
</div>
<!--    -->

<!--  CSS form-group   -->
<div class="form-group">
    <label></label>
    <div id="settings-preview-area">
        <!-- JS -->
    </div>
</div>
<!--    -->

            <div class="form-group">
                <label></label>
                <div class="bg-upload-container">
                    <button type="button" class="form-button-secondary" style="width: auto; padding: 8px 12px; margin-top: 0;" onclick="document.getElementById(&#39;bg-input&#39;).click()"></button>
                    <button type="button" id="remove-bg-btn"></button>
                </div>
                <img id="bg-preview" class="bg-preview-img">
                <input type="file" id="bg-input" accept="image/*" style="display: none;">
            </div>
<hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
<button class="form-button form-button-secondary" id="block-chat-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;"></button>
<!--    -->
<button class="form-button form-button-secondary" id="find-history-btn"></button>
<!--    -->
<button class="form-button form-button-secondary" id="clear-chat-btn"></button></div><div class="modal-footer"><button class="cancel" id="cancel-chat-settings-btn"></button><button class="save" id="save-chat-settings-btn"></button></div></div></div>
    
    <div id="persona-library-modal" class="modal"><div class="modal-content"><div class="modal-header"><span></span><button id="add-persona-preset-btn" class="action-button"></button></div><div class="modal-body"><div id="persona-library-grid"></div></div><div class="modal-footer"><button class="cancel" id="close-persona-library-btn"></button></div></div></div>
    
    <div id="persona-editor-modal" class="modal"><div class="modal-content"><div class="modal-header"><span id="persona-editor-title"></span></div><div class="modal-body"><div class="form-group"><label></label><div class="avatar-upload"><img id="preset-avatar-preview"><button onclick="document.getElementById(&#39;preset-avatar-input&#39;).click()"></button>
    <button class="change-frame-btn" data-type="member"></button> <!--   -->
<input type="file" id="preset-avatar-input" accept="image/*"></div></div><div class="form-group"><label for="preset-persona-input"></label><textarea id="preset-persona-input" rows="4" placeholder="..."></textarea></div></div><div class="modal-footer"><button class="cancel" id="cancel-persona-editor-btn"></button><button class="save" id="save-persona-preset-btn"></button></div></div></div>

    <div id="member-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span></span></div><div class="modal-body">
    <div class="form-group"><label for="member-name-input"></label><input type="text" id="member-name-input"></div>
    <div class="form-group"><label for="member-persona-input"></label><textarea id="member-persona-input" rows="4"></textarea></div>
    <div class="form-group"><label></label><div class="avatar-upload"><img id="member-avatar-preview"><button onclick="document.getElementById(&#39;member-avatar-input&#39;).click()"></button><input type="file" id="member-avatar-input" accept="image/*"></div></div>
    </div><div class="modal-footer"><button class="cancel" id="cancel-member-settings-btn"></button><button class="save" id="save-member-settings-btn"></button></div></div></div>
    
    <div id="custom-modal-overlay">
        <div id="custom-modal">
            <div class="custom-modal-header" id="custom-modal-title"></div>
            <div class="custom-modal-body" id="custom-modal-body"></div>
            <div class="custom-modal-footer">
                <button id="custom-modal-cancel"></button>
                <button id="custom-modal-confirm" class="confirm-btn"></button>
            </div>
        </div>
    </div>
    
    <div id="preset-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="preset-action-edit"></button>
                <button id="preset-action-delete" class="btn-danger"></button>
                <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;"></button>
            </div>
        </div>
    </div>

    <div id="transfer-modal">
        <div class="transfer-content">
            <div class="transfer-header">Ta</div>
            <div class="transfer-input-group">
                <label for="transfer-amount"></label>
                <input type="number" id="transfer-amount" placeholder="0.00" min="0" max="9999" step="0.01">
            </div>
            <div class="transfer-input-group">
                <label for="transfer-note"> ()</label>
                <input type="text" id="transfer-note" placeholder="~" maxlength="20">
            </div>
            <div class="transfer-actions">
                <button id="transfer-cancel-btn"></button>
                <button id="transfer-confirm-btn"></button>
            </div>
        </div>
    </div>

 <div id="battery-alert-modal">
    <div class="battery-alert-content">
        <img id="battery-alert-image" src="https://ziyong.netlify.app/borderless.html">
        <p id="battery-alert-text"></p>
    </div>
</div>

    <audio id="audio-player" style="display:none;"></audio>
<audio id="ringtone-player" loop=""></audio>

<!--   id="create-post-modal"  div  -->
<div id="create-post-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 90%;">
        <div class="modal-header">
            <span></span>
        </div>
        <div class="modal-body">
            <!--  -->
            <div class="form-group">
                <textarea id="post-public-text" rows="3" placeholder="..."></textarea>
            </div>

            <!-- ===  () === -->
            <div class="post-mode-switcher">
                <button id="switch-to-image-mode" class="mode-btn active"></button>
                <button id="switch-to-text-image-mode" class="mode-btn"></button>
            </div>

<!--    -->
<div class="form-group">
    <label></label>
    <div id="post-visibility-options" style="display: flex; gap: 15px; margin-bottom: 10px;">
        <label><input type="radio" name="visibility" value="public" checked=""> </label>

        <label><input type="radio" name="visibility" value="include"> </label>
    </div>
    <div id="post-visibility-groups" style="display: none; max-height: 120px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px;">
        <!-- JS -->
    </div>
</div>
<!--    -->

            <!-- ===  === -->
            <div id="image-mode-content" class="post-mode-content active">
                <div class="form-group">
<div id="post-image-preview-container" class="post-image-preview-container">
                        <img id="post-image-preview" src="https://ziyong.netlify.app/borderless.html" alt="">
                        <button id="post-remove-image-btn"></button>
                    </div>
                    <div class="post-image-upload-options">
                        <button id="post-upload-local-btn" class="form-button-secondary"></button>
                        <button id="post-use-url-btn" class="form-button-secondary">URL</button>
                        <input type="file" id="post-local-image-input" accept="image/*" hidden="">
                    </div>
                </div>
                <div id="post-image-desc-group" class="form-group" style="display: none;">
                    <label> (AI)</label>
                    <input type="text" id="post-image-description" placeholder="AI">
                </div>
            </div>

            <!-- ===  () === -->
            <div id="text-image-mode-content" class="post-mode-content">
                <div class="form-group">
                    <label> (AI)</label>
                    <textarea id="post-hidden-text" rows="4" placeholder="..."></textarea>
                </div>
            </div>

        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-post-btn"></button>
            <button class="save" id="confirm-create-post-btn"></button>
        </div>
    </div>
</div>
<!--    -->

<!--  HTML  -->
<div id="group-management-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span></span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label></label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-group-name-input" placeholder="..." style="flex-grow: 1;">
                    <button id="add-new-group-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;"></button>
                </div>
            </div>
            <hr style="opacity: 0.2;">
            <div id="existing-groups-list" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- JS -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-group-manager-btn" style="width: 100%;"></button>
        </div>
    </div>
</div>
<!--    -->

<!--  HTML  -->
<div id="message-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
        <div class="custom-modal-footer">
            <!--  -->
            <button id="edit-message-btn"></button>
            <button id="copy-message-btn"></button>           
            <button id="recall-message-btn"></button>
            <button id="quote-message-btn"></button>
            <button id="select-message-btn"></button>
            <!--  -->
            <button id="regenerate-message-btn"></button>
            <button id="cancel-message-action-btn" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;"></button>
        </div>
    </div>
</div><!--  HTML  -->

<!--  HTML  -->
<div id="post-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
        <div class="custom-modal-footer">
            <button id="edit-post-btn"></button>
            <button id="copy-post-btn"></button>           
            <button id="cancel-post-action-btn"></button>
        </div>
    </div>
</div>
<!--  HTML  -->

<!--    -->
<div id="message-editor-modal" class="modal">
    <div class="modal-content" style="height: 75%;">
        <div class="modal-header">
            <span></span>
        </div>
        <div class="modal-body" id="message-editor-body">
            <!-- JS -->
            <div id="message-editor-container"></div>
            <!--  -->
            <button id="add-message-editor-block-btn" class="form-button form-button-secondary" style="margin-top: 15px;">
                [+] 
            </button>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-advanced-editor-btn"></button>
            <button class="save" id="save-advanced-editor-btn"></button>
        </div>
    </div>
</div>
<!--  HTML  -->

<!--    -->
<div id="waimai-request-modal" class="modal">
    <div class="modal-content" style="width: 290px;">
        <div class="modal-header">
            <span></span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="waimai-product-info"></label>
                <input type="text" id="waimai-product-info" placeholder="">
            </div>
            <div class="form-group">
                <label for="waimai-amount"> ()</label>
                <input type="number" id="waimai-amount" placeholder="21" min="0" step="0.01">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="waimai-cancel-btn"></button>
            <button class="save" id="waimai-confirm-btn"></button>
        </div>
    </div>
</div>

<!--  /  -->
<div id="create-countdown-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span></span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="countdown-title-input"></label>
                <input type="text" id="countdown-title-input" placeholder="">
            </div>
            <div class="form-group">
                <label for="countdown-date-input"></label>
                <input type="datetime-local" id="countdown-date-input" style="width: 95%; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color);">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-countdown-btn"></button>
            <button class="save" id="confirm-create-countdown-btn"></button>
        </div>
    </div>
</div>
<!--  HTML  -->

<!--    -->
<div id="red-packet-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span></span>
        </div>
        <div class="modal-body" style="padding: 0;">
<!-- 1.  -->
<div class="frame-tabs">
    <div id="rp-tab-group" class="frame-tab active"></div>
    <div id="rp-tab-direct" class="frame-tab"></div>
</div>

            <!-- 2.  -->
            <div id="rp-content-group" class="frame-content" style="padding: 20px 15px;">
                <div class="form-group">
                    <label> ()</label>
                    <input type="number" id="rp-group-amount" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label></label>
                    <input type="number" id="rp-group-count" placeholder="">
                </div>
                <div class="form-group">
                    <label></label>
                    <input type="text" id="rp-group-greeting" placeholder="">
                </div>
                <p id="rp-group-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;"> 0.00</p>
                <button id="send-group-packet-btn" class="form-button"></button>
            </div>

            <!-- 3.  -->
            <div id="rp-content-direct" class="frame-content" style="display: none; padding: 20px 15px;">
                <div class="form-group">
                    <label></label>
                    <select id="rp-direct-receiver"></select>
                </div>
                <div class="form-group">
                    <label> ()</label>
                    <input type="number" id="rp-direct-amount" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label></label>
                    <input type="text" id="rp-direct-greeting" placeholder="">
                </div>
                 <p id="rp-direct-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;"> 0.00</p>
                <button id="send-direct-packet-btn" class="form-button"></button>
            </div>
        </div>
        <div class="modal-footer" style="justify-content: center;">
             <button class="cancel" id="cancel-red-packet-btn" style="width: 100%;"></button>
        </div>
    </div>
</div>
<!--  HTML  -->

<!--    -->
<div id="red-packet-details-modal" class="modal">
    <div class="modal-content" style="width: 280px; height: auto; background-color: #f7f7f7;">
        <div class="modal-header" style="background-color: #F96259; color: white; border-bottom: none; padding-bottom: 5px;">
            <div style="text-align: center; width: 100%;">
                <div id="rp-details-sender" style="font-size: 16px;"></div>
                <div style="font-size: 13px; opacity: 0.8;"></div>
            </div>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <p id="rp-details-greeting" style="text-align: center; font-size: 20px; color: #333; margin: 0 0 20px 0;"></p>
            <div id="rp-details-my-amount" style="text-align: center; display: none; margin-bottom: 20px;">
                <span style="font-size: 40px; font-weight: bold; color: #E44D44;">0.00</span>
                <span style="font-size: 18px; color: #E44D44;"></span>
            </div>
            <div id="rp-details-summary" style="font-size: 13px; color: #8a8a8a; border-top: 1px solid #e0e0e0; padding-top: 10px;"></div>
            <div id="rp-details-list" style="max-height: 150px; overflow-y: auto; margin-top: 10px;">
                <!-- JS -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-rp-details-btn" style="width: 100%;"></button>
        </div>
    </div>
</div>
<!--  HTML  -->
<!--    -->
<div id="create-poll-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span></span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="poll-question-input"></label>
                <textarea id="poll-question-input" rows="2" placeholder=""></textarea>
            </div>
            <div class="form-group">
                <label> (2)</label>
                <div id="poll-options-container" style="display: flex; flex-direction: column; gap: 8px;">
                    <!-- JS -->
                </div>
                <button id="add-poll-option-btn" class="form-button form-button-secondary" style="margin-top: 12px;">+ </button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-poll-btn"></button>
            <button class="save" id="confirm-create-poll-btn"></button>
        </div>
    </div>
</div>
<!--  HTML  -->

<!--  AI  -->
<div id="ai-avatar-library-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span id="ai-avatar-library-title"></span>
            <button id="add-ai-avatar-btn" class="action-button"></button>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <div id="ai-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;">
                <!-- JS -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-ai-avatar-library-btn" style="width: 100%;"></button>
        </div>
    </div>
</div>

<!--  HTML  -->

<!--    -->
<div id="share-link-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span></span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="link-title-input"></label>
                <input type="text" id="link-title-input" placeholder="">
            </div>
            <div class="form-group">
                <label for="link-description-input"> ()</label>
                <textarea id="link-description-input" rows="2" placeholder=""></textarea>
            </div>
            <div class="form-group">
                <label for="link-source-input"> ()</label>
                <input type="text" id="link-source-input" placeholder="B">
            </div>
            <div class="form-group">
                <label for="link-content-input"> ()</label>
                <textarea id="link-content-input" rows="4" placeholder=""></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-share-link-btn"></button>
            <button class="save" id="confirm-share-link-btn"></button>
        </div>
    </div>
</div>
<!--  HTML  -->

<!--    -->
<div id="transfer-actions-modal" class="modal">
    <div class="transfer-actions-content">
        <div class="transfer-actions-header"></div>
        <div class="transfer-actions-body">
            <p> <strong id="transfer-sender-name"></strong> </p>
        </div>
        <div class="transfer-actions-footer">
            <button id="transfer-action-decline" class="action-btn decline"></button>
            <button id="transfer-action-accept" class="action-btn accept"></button>
        </div>
        <button id="transfer-action-cancel" class="cancel-btn"></button>
    </div>
</div>
<!--  HTML  -->

<!--    -->
<div id="call-transcript-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span id="transcript-modal-title"></span>
        </div>
        <div class="modal-body" id="transcript-modal-body" style="background-color: #f0f2f5;">
            <!-- JS -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="delete-transcript-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;"></button>
            <button class="save" id="close-transcript-modal-btn" style="width: 100%;"></button>
        </div>
    </div>
</div>
<!--  HTML  -->

<!--    -->
<div id="share-target-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>...</span>
        </div>
        <div class="modal-body" id="share-target-list" style="padding: 0;">
            <!-- JS -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-share-target-btn"></button>
            <button class="save" id="confirm-share-target-btn"></button>
        </div>
    </div>
</div>

<!--    -->
<div id="shared-history-viewer-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
        <div class="modal-header">
            <span id="shared-history-viewer-title"></span>
        </div>
        <div class="modal-body" id="shared-history-viewer-content" style="background-color: #f0f2f5;">
            <!-- JS -->
        </div>
        <div class="modal-footer">
            <button class="save" id="close-shared-history-viewer-btn" style="width:100%;"></button>
        </div>
    </div>
</div>

<!--    -->
<div id="world-book-category-manager-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span></span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label></label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-category-name-input" placeholder="..." style="flex-grow: 1;">
                    <button id="add-new-category-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;"></button>
                </div>
            </div>
            <hr style="opacity: 0.2;">
            <div id="existing-categories-list" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- JS -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-category-manager-btn" style="width: 100%;"></button>
        </div>
    </div>
</div>
<!--  HTML  -->

<!--    -->
<div id="custom-frame-manager-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span></span>
            <button id="upload-custom-frame-btn" class="action-button"></button>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <div id="custom-frame-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;">
                <!-- JS -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-frame-manager-btn" style="width: 100%;"></button>
        </div>
    </div>
</div>
<input type="file" id="custom-frame-upload-input" accept="image/png, image/gif" hidden="">
<!--  HTML  -->

<!--    -->
<div id="avatar-frame-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span></span>
            <!--  -->
            <button id="manage-custom-frames-btn" class="action-button"></button>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <!-- TabsGrid -->
            <div id="avatar-frame-grid" class="frame-grid">
                <!--  -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-frame-settings-btn"></button>
            <button class="save" id="save-frame-settings-btn"></button>
        </div>
    </div>
</div>

<script>

        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models'
    // gemini, 
    function getRandomValue(str) {
        // 
        if (str.includes(',')) {
            // 
            const arr = str.split(',').map(item => item.trim());
            //  (0  arr.length-1)
            const randomIndex = Math.floor(Math.random() * arr.length);
            // 
            return arr[randomIndex];
        }
        // 
        return str;
    }
    function isImage(text,content) {
        let currentImageData = content.image_url.url
        // Base64
        const base64Data = currentImageData.split(',')[1];
        // MIME
        const mimeType = currentImageData.match(/^data:(.*);base64/)[1];
        return [
            {text: `${text.text}`},
            {
                inline_data: {
                    mime_type: mimeType,
                    data: base64Data
                }
            }
        ]
    }

   function extractArray(text) {
        // JSON
        const pattern = /^\(Timestamp: (\d+)\)(.*)$/s;
        const match = text.match(pattern);

        if (match) {
            const timestampPart = `(Timestamp: ${match[1]}) `;
            const jsonPart = match[2].trim();

            try {
                // JSON
                const parsedJson = JSON.parse(jsonPart);
                // 
                if (Array.isArray(parsedJson)) {
                    return [timestampPart, parsedJson[0]];
                }
            } catch (error) {
                // 
            }
        }

        // 
        return text;
    }
    function transformChatData(item) {
        let type = {
            send_and_recall:'',
            update_status:'',
            change_music:'',
            create_memory:'',
            create_countdown:'/',
            text:'',
            sticker:'',
            ai_image:'',
            voice_message:'',
            transfer:'',
            waimai_request:'',
            waimai_response:{
                paid:'-',
                rejected:'-'
            },
            video_call_request:'',
            video_call_response:{
                accept:'-',
                reject:'-'
            },
            qzone_post:{
                shuoshuo:'',
                text_image:''
            },
            qzone_comment:'',
            qzone_like:'',
            pat_user:'',
            block_user:'',
            friend_request_response:'',
            change_avatar:'',
            share_link:'',
            accept_transfer:'-',
            decline_transfer:'-/',
            quote_reply:'',
            text:'',
        }
        let res = extractArray(item.content)

        if(Array.isArray(res)){
            let obj = res[1]
            let itemType = obj.type;
            let time = res[0]
            let text = type[itemType];
            if(text){
                if(itemType === 'sticker'){
                    return [{text:`${time}[${text}] :${obj.meaning}`}]
                }else if(itemType === 'send_and_recall'){
                    return [{text:`${time}[${text}] ${obj.content}`}]
                }else if(itemType === 'update_status'){
                    return [{text:`${time}[${text}] ${obj.status_text}(${obj.is_busy ? '/' : ''})`}]
                }else if(itemType === 'change_music'){
                    return [{text:`${time}[${text}] ${obj.change_music}, :${obj.song_name}`}]
                }else if(itemType === 'create_memory'){
                    return [{text:`${time}[${text}] ${obj.description}`}]
                }else if(itemType === 'create_countdown'){
                    return [{text:`${time}[${text}] ${obj.title}(${obj.date})`}]
                }else if(itemType === 'ai_image'){
                    return [{text:`${time}[${text}] :${obj.description}`}]
                }else if(itemType === 'voice_message'){
                    return [{text:`${time}[${text}] ${obj.content}`}]
                }else if(itemType === 'transfer'){
                    return [{text:`${time}[${text}] :${obj.amount} :${obj.amount}`}]
                }else if(itemType === 'waimai_request'){
                    return [{text:`${time}[${text}] :${obj.amount} :${obj.productInfo}`}]
                }else if(itemType === 'waimai_response'){
                    return [{text:`${time}[${text[obj.status]}] ${obj.status === 'paid' ? '' : ''}`}]
                }else if(itemType === 'video_call_request'){
                    return [{text:`${time}[${text}]`}]
                }}else if(itemType === 'video_call_request'){
                    return [{text:`${time}[${text[obj.decision]}] ${obj.decision === 'accept' ? '' : ''}`}]
                }else if(itemType === 'qzone_post'){
                    return [{text:`${time}[${text[obj.postType]}] ${obj.postType === 'shuoshuo' ? `${obj.content}` : `:${obj.hiddenContent} ${obj.publicText ? `: ${obj.publicText}` : ''}`}`}]
                }else if(itemType === 'qzone_comment'){
                    return [{text:`${time}[${text}] id: ${obj.postId} : ${obj.commentText}`}]
                }else if(itemType === 'qzone_like'){
                    return [{text:`${time}[${text}] id: ${obj.postId}`}]
                }else if(itemType === 'pat_user'){
                    return [{text:`${time}[${text}] ${obj.suffix ? obj.suffix  : ''}`}]
                }else if(itemType === 'block_user'){
                    return [{text:`${time}[${text}]`}]
                }else if(itemType === 'friend_request_response'){
                    return [{text:`${time}[${text}] :${obj.decision === 'accept' ? '' : ''}`}]
                }else if(itemType === 'change_avatar'){
                    return [{text:`${time}[${text}] :${obj.name}`}]
                }else if(itemType === 'share_link'){
                    return [{text:`${time}[${text}] :${obj.title}  :${obj.description} :${obj.source_name} :${obj.content}`}]
                }else if(itemType === 'accept_transfer'){
                    return [{text:`${time}[${text}]`}]
                }else if(itemType === 'accept_transfer'){
                    return [{text:`${time}[${text}]`}]
                }else if(itemType === 'quote_reply'){
                    return [{text:`${time}[${text}] :${obj.reply_content}`}]
                }else if(itemType === 'text'){
                    return [{text:`${time}${obj.content}`}]
                }
            }

if(Array.isArray(res) && res.length > 1) {
	res = `${res[0]}${res[1].content}`
}

        return [{text:res}]
    }

    function toGeminiRequestData(model, apiKey, systemInstruction, messagesForDecision,isGemini) {

	if(!isGemini){
		return undefined
	}

        //  'system'  'user'

        let roleType = {
            user: 'user',
            assistant: 'model',
            system: 'user' // <--- 
        }
        return {
            url: `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${getRandomValue(apiKey)}`,
            data: {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: messagesForDecision.map((item) => {
                        let  includesImages = false;
                        if(Array.isArray(item.content) && item.content.length === 2){
                              includesImages =  item.content.some((sub)=>{
                                return sub.type === 'image_url' && sub.image_url.url
                            })
                        }
                        return {
                            role: roleType[item.role], //  'system'  'user'
                            parts: includesImages ? isImage(item.content[0],item.content[1]) : transformChatData(item)
                        }
                    }),
                    generationConfig: {
                        temperature: 0.8,
                    },
                    "systemInstruction": {
                        "parts": [{
                            "text": systemInstruction
                        }]
                    }
                })
            }
        }
    }
    document.addEventListener('DOMContentLoaded', () => {

        // ===================================================================
        // 1. 
        // ===================================================================
        const db = new Dexie('GeminiChatDB');
//   API  
const BLOCKED_API_SITES = [
    'api.pisces.ink',
    'aiapi.qzz.io'
];
//   
        // ---  ---
        let state = { chats: {}, activeChatId: null, globalSettings: {}, apiConfig: {}, userStickers: [], worldBooks: [], personaPresets: [], qzoneSettings: {}, activeAlbumId: null };
        // ---  ---

        let isLocked = false; // <-- 
        let newLockscreenWallpaperBase64 = null; // <-- 

let musicState = { 
    isActive: false, 
    activeChatId: null, 
    isPlaying: false, 
    playlist: [], 
    currentIndex: -1, 
    playMode: 'order', 
    totalElapsedTime: 0, 
    timerId: null,
    // 
    parsedLyrics: [],      // 
    currentLyricIndex: -1  // 
};
        const audioPlayer = document.getElementById('audio-player');
        let newWallpaperBase64 = null;
        let isSelectionMode = false;
        let selectedMessages = new Set();
        let editingMemberId = null;
        let editingWorldBookId = null;
        let editingPersonaPresetId = null;

let waimaiTimers = {}; // 

let activeMessageTimestamp = null;
let currentReplyContext = null; // <--- 
let activePostId = null; // <-- ID

        let photoViewerState = {
            isOpen: false,
            photos: [], // URL
            currentIndex: -1, // 
        };

        let unreadPostsCount = 0;

        let isFavoritesSelectionMode = false;
        let selectedFavorites = new Set()

let simulationIntervalId = null;

let currentFrameSelection = { type: null, url: '', target: null }; 

        const defaultAvatar = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
        const defaultMyGroupAvatar = 'https://i.postimg.cc/cLPP10Vm/4.jpg';
        const defaultGroupMemberAvatar = 'https://i.postimg.cc/VkQfgzGJ/1.jpg';
        const defaultGroupAvatar = 'https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg';
        let notificationTimeout;

const THEME_CSS_TEMPLATE = `
/* 
  EPhone 
  : 
  1. URL
  2. 
  3.  #RRGGBB ( #FFFFFF )
  4. URL
*/

/* === 1.  === */
#phone-frame {
  background-color: #f0f0f0; /*  */
}
.notch {
  background-color: #1a1a1a; /*  */
}
        #clock-container {  color: white;  }

/* === 1.5.  () === */
/* */
:root {
  --accent-color: #007bff; /*  */
}

/* === 2.  === */
/*  () */
#listen-together-btn img[src*="8kYShvrJ/90-UI-2.png"] {
  content: url('URL');
}
/*  () */
#listen-together-btn img[src*="D0pq6qS2/E30078-DC-8-B99-4-C01-AFDA-74728-DBF7-BEA.png"] {
  content: url('URL');
}
/*  */
#chat-settings-btn img {
  content: url('https://i.postimg.cc/bvPq64cv/CCA834-BA-5-A90-408-D-94-FA-7-EE156-B6-A765.png');
}
/* API */
#wait-reply-btn img {
  content: url('https://i.postimg.cc/q72zq80N/ECE92-BBC-BE57-48-E9-BB2-C-345-B6019-C4-B2.png');
}
/*  () */
#send-btn {
  background-image: url('URL');
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
  width: 50px; /*  */
}

/* === 3.  === */
.header, .qzone-header {
  background-color: rgba(240, 240, 240, 0.8); /*  () */
  color: #333333; /*  */
}
#chat-list-bottom-nav {
  background-color: rgba(245, 245, 245, 0.85); /*  */
}
.nav-item {
  color: #8a8a8a; /*  */
}
.nav-item.active {
  color: #007bff; /*  */
}

/* === 4.  === */
#chat-list-screen, #qzone-screen .qzone-content, #memories-view {
  background-color: #f0f2f5 !important; /*  */
}

/* === 5. SVG === */
/* : SVGURL
    "SVG to Data URI" 
    url('...')  */

.chat-action-icon-btn {
  background-color: rgba(255, 255, 255, 0.5); /*  */
  border: 1px solid rgba(0,0,0,0.05); /*  */
}

/* (+) */
#open-sticker-panel-btn svg { display: none; /* SVG */ }
#open-sticker-panel-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* () */
#send-photo-btn svg { display: none; /* SVG */ }
#send-photo-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* () */
#upload-image-btn svg { display: none; }
#upload-image-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: black;"><path d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* () */
#transfer-btn svg { display: none; }
#transfer-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 4L12 12L17 4M12 12V20M8 10H16M8 13H16"></path></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/*  */
#voice-message-btn svg { display: none; }
#voice-message-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><path d="M12 19v4"/><path d="M8 23h8"/></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/*  */
#send-waimai-request-btn svg { display: none; }
#send-waimai-request-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/*  */
#video-call-btn svg { display: none; }
#video-call-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/*  */
#group-video-call-btn svg { display: none; }
#group-video-call-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/*  */
#send-poll-btn svg { display: none; }
#send-poll-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h10"/><path d="M6 6h.01"/><path d="M8 12h10"/><path d="M6 12h.01"/><path d="M8 18h10"/><path d="M6 18h.01"/></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/*  */
#share-link-btn svg { display: none; }
#share-link-btn {
  background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>');
  background-size: 60%;
  background-position: center;
  background-repeat: no-repeat;
}

/* === 6.  === */
/*  */
#api-settings-screen,
#font-settings-screen,
#wallpaper-screen,
#world-book-screen,
#world-book-editor-screen,
#contact-picker-screen,
#member-management-screen,
#album-screen,
#album-photos-screen,
#call-history-screen,
#chat-search-screen,
#browser-screen {
  background-color: #FAFAFA !important;
}

/* === 7.  === */
.memory-card {
  background-color: #fffaf0 !important; /*  */
  border-left-color: #ffb74d !important; /*  */
  box-shadow: 0 2px 6px rgba(0,0,0,0.07) !important;
}
.memory-card .header .author {
  color: #d98100 !important; /* / */
}
.memory-card .header .date {
  color: #a1887f !important; /*  */
}
.memory-card .content {
  color: #5d4037 !important; /*  */
}
`;

//  JS 
const DEFAULT_APP_ICONS = {
    'world-book': 'https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg',
    'qq': 'https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg',
    'api-settings': 'https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg',
    'wallpaper': 'https://i.postimg.cc/T1j03pQr/IMG-6440.jpg',
    'font': 'https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg'
};
//   

        const STICKER_REGEX = /^(https:\/\/i\.postimg\.cc\/.+|https:\/\/files\.catbox\.moe\/.+|data:image)/;
        const MESSAGE_RENDER_WINDOW = 50;
        let currentRenderedCount = 0;
        let lastKnownBatteryLevel = 1;
        let alertFlags = { hasShown40: false, hasShown20: false, hasShown10: false };
        let batteryAlertTimeout;
        const dynamicFontStyle = document.createElement('style');
        dynamicFontStyle.id = 'dynamic-font-style';
        document.head.appendChild(dynamicFontStyle);

        const modalOverlay = document.getElementById('custom-modal-overlay');
        const modalTitle = document.getElementById('custom-modal-title');
        const modalBody = document.getElementById('custom-modal-body');
        const modalConfirmBtn = document.getElementById('custom-modal-confirm');
        const modalCancelBtn = document.getElementById('custom-modal-cancel');
        let modalResolve;

        function showCustomModal() { 
            modalOverlay.classList.add('visible'); 
        }

        function hideCustomModal() { 
            modalOverlay.classList.remove('visible'); 
            modalConfirmBtn.classList.remove('btn-danger'); 
            if (modalResolve) modalResolve(null); 
        }

        function showCustomConfirm(title, message, options = {}) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p>${message}</p>`;
                modalCancelBtn.style.display = 'block';
                modalConfirmBtn.textContent = '';
                if (options.confirmButtonClass) modalConfirmBtn.classList.add(options.confirmButtonClass);
                modalConfirmBtn.onclick = () => { resolve(true); hideCustomModal(); };
                modalCancelBtn.onclick = () => { resolve(false); hideCustomModal(); };
                showCustomModal();
            });
        }

        function showCustomAlert(title, message) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p style="text-align: left; white-space: pre-wrap;">${message}</p>`;
                modalCancelBtn.style.display = 'none';
                modalConfirmBtn.textContent = '';
                modalConfirmBtn.onclick = () => {
                    modalCancelBtn.style.display = 'block'; 
                    modalConfirmBtn.textContent = '';
                    resolve(true); 
                    hideCustomModal();
                };
                showCustomModal();
            });
        }

//   showCustomPrompt  
function showCustomPrompt(title, placeholder, initialValue = '', type = 'text', extraHtml = '') {
    return new Promise(resolve => {
        modalResolve = resolve;
        modalTitle.textContent = title;
        const inputId = 'custom-prompt-input';
        
        const inputHtml = type === 'textarea' 
            ? `<textarea id="${inputId}" placeholder="${placeholder}" rows="4" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; resize: vertical;">${initialValue}</textarea>`
            : `<input type="${type}" id="${inputId}" placeholder="${placeholder}" value="${initialValue}">`;
        
        // HTML
        modalBody.innerHTML = extraHtml + inputHtml;
        const input = document.getElementById(inputId);

        // 
        modalBody.querySelectorAll('.format-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const templateStr = btn.dataset.template;
                if (templateStr) {
                    try {
                        const templateObj = JSON.parse(templateStr);
                        //  null, 2 JSON
                        input.value = JSON.stringify(templateObj, null, 2);
                        input.focus();
                    } catch(e) {
                        console.error(":", e);
                    }
                }
            });
        });
        
        modalConfirmBtn.onclick = () => { resolve(input.value); hideCustomModal(); };
        modalCancelBtn.onclick = () => { resolve(null); hideCustomModal(); };
        showCustomModal();
        setTimeout(() => input.focus(), 100);
    });
}
//   

        // ===================================================================
        // 2. 
        // ===================================================================

db.version(28).stores({ 
    chats: '&id, isGroup, groupId, isPinned', // <--  isPinned 
    apiConfig: '&id', 
    globalSettings: '&id, activeThemeId', 
    userStickers: '&id, url, name',
    worldBooks: '&id, name, categoryId', // <-- 1 categoryId
    worldBookCategories: '++id, name',    // <-- 2
    musicLibrary: '&id', 
    personaPresets: '&id',
    qzoneSettings: '&id',
    qzonePosts: '++id, timestamp', 
    qzoneAlbums: '++id, name, createdAt',
    qzonePhotos: '++id, albumId',
    favorites: '++id, type, timestamp, originalTimestamp',
    qzoneGroups: '++id, name',
    memories: '++id, chatId, timestamp, type, targetDate' ,
    callRecords: '++id, chatId, timestamp, customName',
    customAvatarFrames: '&id, name, url',   
    themes: '++id, name, css',
    apiPresets: '++id, name, proxyUrl, apiKey',
    bubbleStylePresets: '++id, name, css' // <-- 
});

        // ===================================================================
        // 3. 
        // ===================================================================

// 
function getEventCoords(e) {
    //  e.touches[0] 
    if (e.touches && e.touches[0]) {
        return { x: e.touches[0].pageX, y: e.touches[0].pageY };
    }
    //  e 
    return { x: e.pageX, y: e.pageY };
}


        function showScreen(screenId) {
            if (screenId === 'chat-list-screen') {
                window.renderChatListProxy(); 
                switchToChatListView('messages-view');
            }
            if (screenId === 'api-settings-screen') window.renderApiSettingsProxy();
            if (screenId === 'wallpaper-screen') window.renderWallpaperScreenProxy();
            if (screenId === 'world-book-screen') window.renderWorldBookScreenProxy();
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const screenToShow = document.getElementById(screenId);
            if (screenToShow) screenToShow.classList.add('active');
            if (screenId === 'chat-interface-screen') window.updateListenTogetherIconProxy(state.activeChatId);
            if (screenId === 'font-settings-screen') {
                document.getElementById('font-url-input').value = state.globalSettings.fontUrl || '';
                applyCustomFont(state.globalSettings.fontUrl || '', true);
            }
        }
        window.updateListenTogetherIconProxy = () => {};

        function switchToChatListView(viewId) {
            const chatListScreen = document.getElementById('chat-list-screen');
            const views = {
                'messages-view': document.getElementById('messages-view'),
                'qzone-screen': document.getElementById('qzone-screen'),
                'favorites-view': document.getElementById('favorites-view'),
        'memories-view': document.getElementById('memories-view') // <-- 
    };
            const mainHeader = document.getElementById('main-chat-list-header');
            const mainBottomNav = document.getElementById('chat-list-bottom-nav'); // 

            if (isFavoritesSelectionMode) {
                document.getElementById('favorites-edit-btn').click(); 
            }

            // 
            Object.values(views).forEach(v => v.classList.remove('active'));
            // 
            if (views[viewId]) {
                views[viewId].classList.add('active');
            }

            // 
            document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.view === viewId);
            });
            
            //  UI 
            if (viewId === 'messages-view') {
                mainHeader.style.display = 'flex';
                mainBottomNav.style.display = 'flex';
            } else {
                mainHeader.style.display = 'none';
                mainBottomNav.style.display = 'none';
            }
            //   

    if (viewId !== 'memories-view') {
        activeCountdownTimers.forEach(timerId => clearInterval(timerId));
        activeCountdownTimers = [];
    }

            // ID/
            switch (viewId) {
                case 'qzone-screen':
                    views['qzone-screen'].style.backgroundColor = '#f0f2f5';
                    updateUnreadIndicator(0);
                    renderQzoneScreen();
                    renderQzonePosts();
                    break;
                case 'favorites-view':
                    views['favorites-view'].style.backgroundColor = '#f9f9f9';
                    renderFavoritesScreen();
                    break;
                case 'messages-view':
                    // 
                    break;
            }
        }
        
        function renderQzoneScreen() {
            if (state && state.qzoneSettings) {
                const settings = state.qzoneSettings;
                document.getElementById('qzone-nickname').textContent = settings.nickname;
                document.getElementById('qzone-avatar-img').src = settings.avatar;
                document.getElementById('qzone-banner-img').src = settings.banner;
            }
        }
        window.renderQzoneScreenProxy = renderQzoneScreen;

        async function saveQzoneSettings() {
            if (db && state.qzoneSettings) {
                await db.qzoneSettings.put(state.qzoneSettings);
            }
        }

        function formatPostTimestamp(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const date = new Date(timestamp);
            const diffSeconds = Math.floor((now - date) / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            if (diffMinutes < 1) return '';
            if (diffMinutes < 60) return `${diffMinutes}`;
            if (diffHours < 24) return `${diffHours}`;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            if (now.getFullYear() === year) {
                return `${month}-${day} ${hours}:${minutes}`;
            } else {
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            }
        }

//   renderQzonePosts  
async function renderQzonePosts() {
    const postsListEl = document.getElementById('qzone-posts-list');
    if (!postsListEl) return;

    const [posts, favorites] = await Promise.all([
        db.qzonePosts.orderBy('timestamp').reverse().toArray(),
        db.favorites.where('type').equals('qzone_post').toArray()
    ]);

    const favoritedPostIds = new Set(favorites.map(fav => fav.content.id));
    
    postsListEl.innerHTML = '';

    if (posts.length === 0) {
        postsListEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 30px 0;"></p>';
        return;
    }

    const userSettings = state.qzoneSettings;

    posts.forEach(post => {
        const postContainer = document.createElement('div');
        postContainer.className = 'qzone-post-container';
        postContainer.dataset.postId = post.id;

        const postEl = document.createElement('div');
        postEl.className = 'qzone-post-item';

        let authorAvatar = '', authorNickname = '', commentAvatar = userSettings.avatar; 

        if (post.authorId === 'user') {
            authorAvatar = userSettings.avatar;
            authorNickname = userSettings.nickname;
        } else if (state.chats[post.authorId]) {
            const authorChat = state.chats[post.authorId];
            authorAvatar = authorChat.settings.aiAvatar || defaultAvatar;
            authorNickname = authorChat.name;
        } else {
            authorAvatar = defaultAvatar;
            authorNickname = '{{char}}';
        }
        
        let contentHtml = '';
        const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';

        if (post.type === 'shuoshuo') {
            contentHtml = `<div class="post-content" style="margin-bottom: 10px;">${post.content.replace(/\n/g, '<br>')}</div>`;
        } 
        else if (post.type === 'image_post' && post.imageUrl) {
            contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>` : `<img src="${post.imageUrl}" class="chat-image">`;
        } 
        else if (post.type === 'text_image') {
            contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
        }

        let likesHtml = '';
        if (post.likes && post.likes.length > 0) {
            likesHtml = `<div class="post-likes-section"><svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>${post.likes.join('')} </span></div>`;
        }
        
        let commentsHtml = '';
        if (post.comments && post.comments.length > 0) {
            commentsHtml = '<div class="post-comments-container">';
            // 
            //  comment  index
            post.comments.forEach((comment, index) => {
                //  data-comment-index 
                commentsHtml += `
                    <div class="comment-item">
                        <span class="commenter-name">${comment.commenterName}:</span>
                        <span class="comment-text">${comment.text}</span>
                        <span class="comment-delete-btn" data-comment-index="${index}"></span>
                    </div>`;
            });
            // 
            commentsHtml += '</div>';
        }

        const userNickname = state.qzoneSettings.nickname;
        const isLikedByUser = post.likes && post.likes.includes(userNickname);
        const isFavoritedByUser = favoritedPostIds.has(post.id);

        postEl.innerHTML = `
            <div class="post-header"><img src="${authorAvatar}" class="post-avatar"><div class="post-info"><span class="post-nickname">${authorNickname}</span><span class="post-timestamp">${formatPostTimestamp(post.timestamp)}</span></div>
                <div class="post-actions-btn"></div>
            </div>
            <div class="post-main-content">${contentHtml}</div>
            <div class="post-feedback-icons">
                <span class="action-icon like ${isLikedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></span>
                <span class="action-icon favorite ${isFavoritedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>
            </div>
            ${likesHtml}
            ${commentsHtml}
            <div class="post-footer"><div class="comment-section"><img src="${commentAvatar}" class="comment-avatar"><input type="text" class="comment-input" placeholder=""><div class="at-mention-popup"></div></div><button class="comment-send-btn"></button></div>
        `;
        
        const deleteAction = document.createElement('div');
        deleteAction.className = 'qzone-post-delete-action';
        deleteAction.innerHTML = '<span></span>';
        postContainer.appendChild(postEl);
        postContainer.appendChild(deleteAction);
        const commentSection = postContainer.querySelector('.comment-section');
        if (commentSection) {
            commentSection.addEventListener('touchstart', (e) => e.stopPropagation());
            commentSection.addEventListener('mousedown', (e) => e.stopPropagation());
        }
        postsListEl.appendChild(postContainer);
        const commentInput = postContainer.querySelector('.comment-input');
        const popup = postContainer.querySelector('.at-mention-popup');
        commentInput.addEventListener('input', () => {
            const value = commentInput.value;
            const atMatch = value.match(/@([\p{L}\w]*)$/u);
            if (atMatch) {
                const namesToMention = new Set();
                const authorNickname = postContainer.querySelector('.post-nickname')?.textContent;
                if (authorNickname) namesToMention.add(authorNickname);
                postContainer.querySelectorAll('.commenter-name').forEach(nameEl => {
                    namesToMention.add(nameEl.textContent.replace(':', ''));
                });
                namesToMention.delete(state.qzoneSettings.nickname);
                popup.innerHTML = '';
                if (namesToMention.size > 0) {
                    const searchTerm = atMatch[1];
                    namesToMention.forEach(name => {
                        if (name.toLowerCase().includes(searchTerm.toLowerCase())) {
                            const item = document.createElement('div');
                            item.className = 'at-mention-item';
                            item.textContent = name;
                            item.addEventListener('mousedown', (e) => {
                                e.preventDefault();
                                const newText = value.substring(0, atMatch.index) + `@${name} `;
                                commentInput.value = newText;
                                popup.style.display = 'none';
                                commentInput.focus();
                            });
                            popup.appendChild(item);
                        }
                    });
                    popup.style.display = popup.children.length > 0 ? 'block' : 'none';
                } else {
                    popup.style.display = 'none';
                }
            } else {
                popup.style.display = 'none';
            }
        });
        commentInput.addEventListener('blur', () => { setTimeout(() => { popup.style.display = 'none'; }, 200); });
    });
}
//   
             
//   displayFilteredFavorites  

function displayFilteredFavorites(items) {
    const listEl = document.getElementById('favorites-list');
    listEl.innerHTML = '';

    if (items.length === 0) {
        const searchTerm = document.getElementById('favorites-search-input').value;
        const message = searchTerm ? '' : '<br>';
        listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${message}</p>`;
        return;
    }

    for (const item of items) {
        const card = document.createElement('div');
        card.className = 'favorite-item-card';
        card.dataset.favid = item.id;

        let headerHtml = '', contentHtml = '', sourceText = '', footerHtml = '';

        if (item.type === 'qzone_post') {
            const post = item.content;
            sourceText = '';
            let authorAvatar = defaultAvatar, authorNickname = '';

            if (post.authorId === 'user') {
                authorAvatar = state.qzoneSettings.avatar;
                authorNickname = state.qzoneSettings.nickname;
            } else if (state.chats[post.authorId]) {
                authorAvatar = state.chats[post.authorId].settings.aiAvatar;
                authorNickname = state.chats[post.authorId].name;
            }

            headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${authorNickname}</div></div>`;
            
            const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';
            if (post.type === 'shuoshuo') {
                contentHtml = `<div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>`;
            } else if (post.type === 'image_post' && post.imageUrl) {
                contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>` : `<img src="${post.imageUrl}" class="chat-image">`;
            } else if (post.type === 'text_image') {
                contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
            }

            //  / 
            
            // 1. HTML
            let likesHtml = '';
            //  post  likes 
            if (post.likes && post.likes.length > 0) {
                //  div
                likesHtml = `
                    <div class="post-likes-section">
                        <svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        <span>${post.likes.join('')} </span>
                    </div>`;
            }

            // 2. HTML
            let commentsHtml = '';
            //  post  comments 
            if (post.comments && post.comments.length > 0) {
                // 
                commentsHtml = '<div class="post-comments-container">';
                post.comments.forEach(comment => {
                    commentsHtml += `
                        <div class="comment-item">
                            <span class="commenter-name">${comment.commenterName}:</span>
                            <span class="comment-text">${comment.text}</span>
                        </div>`;
                });
                commentsHtml += '</div>';
            }

            // 3. HTML footerHtml 
            footerHtml = `${likesHtml}${commentsHtml}`;
            
            //  / 

} else if (item.type === 'chat_message') {
    const msg = item.content;
    const chat = state.chats[item.chatId];
    if (!chat) continue; 

    sourceText = ` ${chat.name} `;
    const isUser = msg.role === 'user';
    let senderName, senderAvatar;

    if (isUser) {
        // 
        senderName = chat.isGroup ? (chat.settings.myNickname || '') : '';
        senderAvatar = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
    } else { // AI/
         if (chat.isGroup) {
            //   
            //  originalName  name
            const member = chat.members.find(m => m.originalName === msg.senderName);
            //   
            
            senderName = msg.senderName;
            //  member 
            senderAvatar = member ? member.avatar : defaultGroupMemberAvatar;
        } else {
            // 
            senderName = chat.name;
            senderAvatar = chat.settings.aiAvatar || defaultAvatar;
        }
    }

    //  headerHtml  contentHtml 
    headerHtml = `<img src="${senderAvatar}" class="avatar"><div class="info"><div class="name">${senderName}</div></div>`;
    
    if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
        contentHtml = `<img src="${msg.content}" class="sticker-image" style="max-width: 80px; max-height: 80px;">`;
    } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
        contentHtml = `<img src="${msg.content[0].image_url.url}" class="chat-image">`;
    } else {
        contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
    }
}
        
        //  HTML footerHtml 
        card.innerHTML = `
            <div class="fav-card-header">${headerHtml}<div class="source">${sourceText}</div></div>
            <div class="fav-card-content">${contentHtml}</div>
            ${footerHtml}`; // <--  footerHtml 
            
        listEl.appendChild(card);
    }
}

//   

        /**
         * : 
         */
        async function renderFavoritesScreen() {
            // 1. 
            allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray();
            
            // 2. 
            const searchInput = document.getElementById('favorites-search-input');
            const clearBtn = document.getElementById('favorites-search-clear-btn');
            searchInput.value = '';
            clearBtn.style.display = 'none';

            // 3. 
            displayFilteredFavorites(allFavoriteItems);
        }

        //   

        function resetCreatePostModal() {
            document.getElementById('post-public-text').value = '';
            document.getElementById('post-image-preview').src = '';
            document.getElementById('post-image-description').value = '';
            document.getElementById('post-image-preview-container').classList.remove('visible');
            document.getElementById('post-image-desc-group').style.display = 'none';
            document.getElementById('post-local-image-input').value = '';
            document.getElementById('post-hidden-text').value = '';
            document.getElementById('switch-to-image-mode').click();
        }

//   memories exportBackup  
async function exportBackup() {
    try {
        const backupData = {
            version: 1, 
            timestamp: Date.now()
        };

        const [
            chats, worldBooks, userStickers, apiConfig, globalSettings,
            personaPresets, musicLibrary, qzoneSettings, qzonePosts,
            qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
            memories,
                worldBookCategories,
    callRecords,
    customAvatarFrames, 
            themes,
apiPresets,
bubbleStylePresets
        ] = await Promise.all([
            db.chats.toArray(),
            db.worldBooks.toArray(),
            db.userStickers.toArray(),
            db.apiConfig.get('main'),
            db.globalSettings.get('main'),
            db.personaPresets.toArray(),
            db.musicLibrary.get('main'),
            db.qzoneSettings.get('main'),
            db.qzonePosts.toArray(),
            db.qzoneAlbums.toArray(),
            db.qzonePhotos.toArray(),
            db.favorites.toArray(),
            db.qzoneGroups.toArray(),
                        db.memories.toArray(),
            db.worldBookCategories.toArray(),
    db.callRecords.toArray(),       
    db.customAvatarFrames.toArray(),

            db.themes.toArray(),

db.apiPresets.toArray(),

db.bubbleStylePresets.toArray()
]);

        Object.assign(backupData, {
            chats, worldBooks, userStickers, apiConfig, globalSettings,
            personaPresets, musicLibrary, qzoneSettings, qzonePosts,
            qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
            memories,
                worldBookCategories,
    callRecords,          
    customAvatarFrames, 
            themes,
apiPresets,
bubbleStylePresets
});
        
        const blob = new Blob(
            [JSON.stringify(backupData, null, 2)], 
            { type: 'application/json' }
        );
        const url = URL.createObjectURL(blob);
        const link = Object.assign(document.createElement('a'), {
            href: url,
            download: `EPhone-Full-Backup-${new Date().toISOString().split('T')[0]}.json`
        });
        link.click();
        URL.revokeObjectURL(url);
        
        await showCustomAlert('', '');

    } catch (error) {
        console.error(":", error);
        await showCustomAlert('', `: ${error.message}`);
    }
}

//   memories importBackup  
async function importBackup(file) {
    if (!file) return;

    const confirmed = await showCustomConfirm(
        '',
        '',
        { confirmButtonClass: 'btn-danger' }
    );

    if (!confirmed) return;

    try {
        const text = await file.text();
        const data = JSON.parse(text);

        await db.transaction('rw', db.tables, async () => {
            for (const table of db.tables) {
                await table.clear();
            }

            if (Array.isArray(data.chats)) await db.chats.bulkPut(data.chats);
            if (Array.isArray(data.worldBooks)) await db.worldBooks.bulkPut(data.worldBooks);
            if (Array.isArray(data.worldBookCategories)) await db.worldBookCategories.bulkPut(data.worldBookCategories);
            if (Array.isArray(data.userStickers)) await db.userStickers.bulkPut(data.userStickers);
            if (Array.isArray(data.personaPresets)) await db.personaPresets.bulkPut(data.personaPresets);
            if (Array.isArray(data.qzonePosts)) await db.qzonePosts.bulkPut(data.qzonePosts);
            if (Array.isArray(data.qzoneAlbums)) await db.qzoneAlbums.bulkPut(data.qzoneAlbums);
            if (Array.isArray(data.qzonePhotos)) await db.qzonePhotos.bulkPut(data.qzonePhotos);
            if (Array.isArray(data.favorites)) await db.favorites.bulkPut(data.favorites);
            if (Array.isArray(data.qzoneGroups)) await db.qzoneGroups.bulkPut(data.qzoneGroups);
if (Array.isArray(data.memories)) await db.memories.bulkPut(data.memories);
if (Array.isArray(data.apiPresets)) await db.apiPresets.bulkPut(data.apiPresets);
if (Array.isArray(data.bubbleStylePresets)) await db.bubbleStylePresets.bulkPut(data.bubbleStylePresets);
if (Array.isArray(data.callRecords)) await db.callRecords.bulkPut(data.callRecords);             // <--- 
if (Array.isArray(data.customAvatarFrames)) await db.customAvatarFrames.bulkPut(data.customAvatarFrames); // <--- 
            if (Array.isArray(data.themes)) await db.themes.bulkPut(data.themes);

            if (data.apiConfig) await db.apiConfig.put(data.apiConfig);
            if (data.globalSettings) await db.globalSettings.put(data.globalSettings);
            if (data.musicLibrary) await db.musicLibrary.put(data.musicLibrary);
            if (data.qzoneSettings) await db.qzoneSettings.put(data.qzoneSettings);
        });

        await showCustomAlert('', '');
        
        setTimeout(() => {
            window.location.reload();
        }, 1500);

    } catch (error) {
        console.error(":", error);
        await showCustomAlert('', `: ${error.message}`);
    }
}

        function applyCustomFont(fontUrl, isPreviewOnly = false) {
            if (!fontUrl) {
                dynamicFontStyle.innerHTML = '';
                document.getElementById('font-preview').style.fontFamily = '';
                return;
            }
            const fontName = 'custom-user-font';
            const newStyle = `
                @font-face {
                  font-family: '${fontName}';
                  src: url('${fontUrl}');
                  font-display: swap;
                }`;
            if (isPreviewOnly) {
                const previewStyle = document.getElementById('preview-font-style') || document.createElement('style');
                previewStyle.id = 'preview-font-style';
                previewStyle.innerHTML = newStyle;
                if (!document.getElementById('preview-font-style')) document.head.appendChild(previewStyle);
                document.getElementById('font-preview').style.fontFamily = `'${fontName}', 'bulangni', sans-serif`;
            } else {
                dynamicFontStyle.innerHTML = `
                    ${newStyle}
                    body {
                      font-family: '${fontName}', 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                    }`;
            }
        }

        async function resetToDefaultFont() {
            dynamicFontStyle.innerHTML = ''; 
            state.globalSettings.fontUrl = '';
            await db.globalSettings.put(state.globalSettings);
            document.getElementById('font-url-input').value = '';
            document.getElementById('font-preview').style.fontFamily = '';
            alert('');
        }

async function loadAllDataFromDB() {
    //   
    const [
        chatsArr,
        apiConfig,
        globalSettings,
        userStickers,
        worldBooks,
        musicLib,
        personaPresets,
        qzoneSettings,
        initialFavorites,
    apiPresets,
bubbleStylePresets
] = await Promise.all([
        db.chats.toArray(),
        db.apiConfig.get('main'),
        db.globalSettings.get('main'),
        db.userStickers.toArray(),
        db.worldBooks.toArray(),
        db.musicLibrary.get('main'),
        db.personaPresets.toArray(),
        db.qzoneSettings.get('main'),
        db.favorites.orderBy('timestamp').reverse().toArray(),
    db.apiPresets.toArray(),    db.bubbleStylePresets.toArray()
]);
    //   

    state.chats = chatsArr.reduce((acc, chat) => {

    if (typeof chat.unreadCount === 'undefined') {
        chat.unreadCount = 0; //  unreadCount  0
    }

        // 
        //  `name` 
        if (chat.isGroup && chat.members && chat.members.length > 0 && chat.members[0].name) {
            console.log(` for "${chat.name}"...`);
            chat.members.forEach(member => {
                //  originalName
                if (typeof member.originalName === 'undefined') {
                    member.originalName = member.name; //  name  originalName
                    member.groupNickname = member.name; //  groupNickname
                    delete member.name; //  name 
                    needsUpdate = true; // 
                }
            });
             console.log(` for "${chat.name}"`);
        }

        // ---    ---
        // 1 status 
        if (!chat.isGroup && !chat.status) {
            //  status 
            chat.status = {
                text: '',
                lastUpdate: Date.now(),
                isBusy: false
            };
            console.log(` "${chat.name}" status`);
        }
        // ---   

        // ---    ---
        // 2
        if (!chat.isGroup && !chat.relationship) {
            //  relationship 
            chat.relationship = {
                status: 'friend',
                blockedTimestamp: null,
                applicationReason: ''
            };
            console.log(` "${chat.name}"  relationship `);
        }
        // ---   

    //   
    if (!chat.isGroup && (!chat.settings || !chat.settings.aiAvatarLibrary)) {
        if (!chat.settings) chat.settings = {}; // settings
        chat.settings.aiAvatarLibrary = [];
        console.log(` "${chat.name}" aiAvatarLibrary`);
    }
    //   

        if (!chat.musicData) chat.musicData = { totalTime: 0 };
        if (chat.settings && chat.settings.linkedWorldBookId && !chat.settings.linkedWorldBookIds) {
            chat.settings.linkedWorldBookIds = [chat.settings.linkedWorldBookId];
            delete chat.settings.linkedWorldBookId;
        }

    //  isPinned 
    if (typeof chat.isPinned === 'undefined') {
        chat.isPinned = false;
    }

        acc[chat.id] = chat;
        return acc;
    }, {});
    state.apiConfig = apiConfig || { id: 'main', proxyUrl: '', apiKey: '', model: '' };

state.globalSettings = globalSettings || { 
    id: 'main', 
    wallpaper: 'linear-gradient(135deg, #89f7fe, #66a6ff)', 
    lockscreenWallpaper: 'linear-gradient(135deg, #764ba2, #667eea)', // <-- 
    password: '', // <-- 
    fontUrl: '', 
    enableBackgroundActivity: false, 
    backgroundActivityInterval: 60,
    blockCooldownHours: 1,
    appIcons: { ...DEFAULT_APP_ICONS },
    ringtoneUrl: 'https://files.catbox.moe/3w7gla.mp3' // <-- URL
};
// 
state.globalSettings.appIcons = { ...DEFAULT_APP_ICONS, ...(state.globalSettings.appIcons || {}) };

    state.userStickers = userStickers || [];
    state.worldBooks = worldBooks || [];
    musicState.playlist = musicLib?.playlist || [];
    state.personaPresets = personaPresets || [];
state.apiPresets = apiPresets || [];
state.bubbleStylePresets = bubbleStylePresets || [];
    state.qzoneSettings = qzoneSettings || { id: 'main', nickname: '{{user}}', avatar: 'https://files.catbox.moe/q6z5fc.jpeg', banner: 'https://files.catbox.moe/r5heyt.gif' };

    //   Promise.all  initialFavorites 
    allFavoriteItems = initialFavorites || [];
    //   
}

        async function saveGlobalPlaylist() { await db.musicLibrary.put({ id: 'main', playlist: musicState.playlist }); }

        function formatTimestamp(timestamp) { if (!timestamp) return ''; const date = new Date(timestamp); const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${hours}:${minutes}`; }

        function showNotification(chatId, messageContent) { clearTimeout(notificationTimeout); const chat = state.chats[chatId]; if (!chat) return; const bar = document.getElementById('notification-bar'); document.getElementById('notification-avatar').src = chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar; document.getElementById('notification-content').querySelector('.name').textContent = chat.name; document.getElementById('notification-content').querySelector('.message').textContent = messageContent; const newBar = bar.cloneNode(true); bar.parentNode.replaceChild(newBar, bar); newBar.addEventListener('click', () => { openChat(chatId); newBar.classList.remove('visible'); }); newBar.classList.add('visible'); notificationTimeout = setTimeout(() => { newBar.classList.remove('visible'); }, 4000); }

        function updateClock() { const now = new Date(); const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' }); document.getElementById('main-time').textContent = timeString; document.getElementById('status-bar-time').textContent = timeString; document.getElementById('main-date').textContent = dateString; 
    //  ()
    updateLockClock();
}

/**
 * AI
 * @param {string} content - AI
 * @returns {Array} - 
 */
function parseAiResponse(content) {
    const trimmedContent = content.trim();

    // 1JSON
    // 
    if (trimmedContent.startsWith('[') && trimmedContent.endsWith(']')) {
        try {
            const parsed = JSON.parse(trimmedContent);
            if (Array.isArray(parsed)) {
                console.log("JSON");
                return parsed;
            }
        } catch (e) {
            // 
            // 
            console.warn("JSON...");
        }
    }

    // 2JSON
    //  "(Timestamp: ...)[{...}](Timestamp: ...)[{...}]" 
    const jsonMatches = trimmedContent.match(/{[^{}]*}/g);

    if (jsonMatches) {
        const results = [];
        for (const match of jsonMatches) {
            try {
                // JSON
                const parsedObject = JSON.parse(match);
                results.push(parsedObject);
            } catch (e) {
                // JSON
                console.warn("JSON:", match);
            }
        }

        // JSON
        if (results.length > 0) {
            console.log("");
            return results;
        }
    }
    
    // 3AI
    // 
    console.error("");
    return [{ type: 'text', content: content }];
}

        function renderApiSettings() { document.getElementById('proxy-url').value = state.apiConfig.proxyUrl || ''; document.getElementById('api-key').value = state.apiConfig.apiKey || ''; 
    //   
    document.getElementById('background-activity-switch').checked = state.globalSettings.enableBackgroundActivity || false;
    document.getElementById('background-interval-input').value = state.globalSettings.backgroundActivityInterval || 60;
    document.getElementById('block-cooldown-input').value = state.globalSettings.blockCooldownHours || 1;

   renderApiPresetSelector(); //  
}
        window.renderApiSettingsProxy = renderApiSettings;

//   renderChatList  
async function renderChatList() {
    const chatListEl = document.getElementById('chat-list');
    chatListEl.innerHTML = '';

    // 1. 
    const allChats = Object.values(state.chats);
    const allGroups = await db.qzoneGroups.toArray();

    if (allChats.length === 0) {
        chatListEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;"> "+" </p>';
        return;
    }

    // 2. 
    const pinnedChats = allChats.filter(chat => chat.isPinned);
    const unpinnedChats = allChats.filter(chat => !chat.isPinned);

    // 3. 
    pinnedChats.sort((a, b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0));

    // 4. 
    pinnedChats.forEach(chat => {
        const item = createChatListItem(chat);
        chatListEl.appendChild(item);
    });

    // 5. 
    //  ()
    allGroups.forEach(group => {
        const latestChatInGroup = unpinnedChats
            .filter(chat => chat.groupId === group.id) // 
            .sort((a, b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0))[0]; // 
        
        group.latestTimestamp = latestChatInGroup ? (latestChatInGroup.history.slice(-1)[0]?.timestamp || 0) : 0;
    });

    // 
    allGroups.sort((a, b) => b.latestTimestamp - a.latestTimestamp);

    // 6. 
    allGroups.forEach(group => {
        const groupChats = unpinnedChats
            .filter(chat => !chat.isGroup && chat.groupId === group.id)
            .sort((a, b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0));
        
        if (groupChats.length === 0) return; // 

        const groupContainer = document.createElement('div');
        groupContainer.className = 'chat-group-container';
        groupContainer.innerHTML = `
            <div class="chat-group-header">
                <span class="arrow"></span>
                <span class="group-name">${group.name}</span>
            </div>
            <div class="chat-group-content"></div>
        `;
        const contentEl = groupContainer.querySelector('.chat-group-content');
        groupChats.forEach(chat => {
            const item = createChatListItem(chat);
            contentEl.appendChild(item);
        });
        chatListEl.appendChild(groupContainer);
    });

    // 7. 
    const remainingChats = unpinnedChats
        .filter(chat => chat.isGroup || (!chat.isGroup && !chat.groupId))
        .sort((a, b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0));
    
    remainingChats.forEach(chat => {
        const item = createChatListItem(chat);
        chatListEl.appendChild(item);
    });

    // 
    document.querySelectorAll('.chat-group-header').forEach(header => {
        header.addEventListener('click', () => {
            header.classList.toggle('collapsed');
            header.nextElementSibling.classList.toggle('collapsed');
        });
    });
}
//   

//   createChatListItem  
function createChatListItem(chat) {
    const lastMsgObj = chat.history.filter(msg => !msg.isHidden).slice(-1)[0] || {};
    let lastMsgDisplay;

    // ---  ---
    if (!chat.isGroup && chat.relationship?.status === 'pending_user_approval') {
        lastMsgDisplay = `<span style="color: #ff8c00;">[] ${chat.relationship.applicationReason || ''}</span>`;
    } else if (!chat.isGroup && chat.relationship?.status === 'blocked_by_ai') {
        lastMsgDisplay = `<span style="color: #dc3545;">[]</span>`;
    } else if (chat.isGroup) {
        if (lastMsgObj.type === 'pat_message') { lastMsgDisplay = `[] ${lastMsgObj.content}`; }
        else if (lastMsgObj.type === 'transfer') { lastMsgDisplay = '[]'; }
        else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') { lastMsgDisplay = '[]'; }
        else if (lastMsgObj.type === 'voice_message') { lastMsgDisplay = '[]'; }
        else if (typeof lastMsgObj.content === 'string' && STICKER_REGEX.test(lastMsgObj.content)) { lastMsgDisplay = lastMsgObj.meaning ? `[: ${lastMsgObj.meaning}]` : '[]'; }
        else if (Array.isArray(lastMsgObj.content)) { lastMsgDisplay = `[]`; }
        else { lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 20); }
        if (lastMsgObj.senderName && lastMsgObj.type !== 'pat_message') {
            lastMsgDisplay = `${lastMsgObj.senderName}: ${lastMsgDisplay}`;
        }
    } else {
        const statusText = chat.status?.text || '';
        lastMsgDisplay = `[${statusText}]`;
    }

    const lastMsgTimestamp = lastMsgObj?.timestamp;
    const timeDisplay = formatChatListTimestamp(lastMsgTimestamp);
    
    const container = document.createElement('div');
    container.className = 'chat-list-item-swipe-container';
    container.dataset.chatId = chat.id;

    const content = document.createElement('div');
    content.className = `chat-list-item-content ${chat.isPinned ? 'pinned' : ''}`;
    
    const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar;
    
    // ---  ---
    content.innerHTML = `
        <div class="chat-list-item" data-chat-id="${chat.id}">
            <img src="${avatar || defaultAvatar}" class="avatar">
            <div class="info">
                <div class="name-line">
                    <span class="name">${chat.name}</span>
                    ${chat.isGroup ? '<span class="group-tag"></span>' : ''}
                </div>
                <div class="last-msg" style="color: ${chat.isGroup ? 'var(--text-secondary)' : '#b5b5b5'}; font-style: italic;">${lastMsgDisplay}</div>
            </div>
            <div class="chat-list-right-column">
                <div class="chat-list-time">${timeDisplay}</div>
                <div class="unread-count-wrapper">
                    <span class="unread-count" style="display: none;">0</span>
                </div>
            </div>
        </div>
    `;
    
    // 
    const actions = document.createElement('div');
    actions.className = 'swipe-actions';
    const pinButtonText = chat.isPinned ? '' : '';
    const pinButtonClass = chat.isPinned ? 'unpin' : 'pin';
    actions.innerHTML = `
        <button class="swipe-action-btn ${pinButtonClass}">${pinButtonText}</button>
        <button class="swipe-action-btn delete"></button>
    `;
    
    container.appendChild(content);
    container.appendChild(actions);
    
    // ---  .unread-count  ---
    const unreadCount = chat.unreadCount || 0;
    const unreadEl = content.querySelector('.unread-count');
    if (unreadCount > 0) {
        unreadEl.textContent = unreadCount > 99 ? '99+' : unreadCount;
        unreadEl.style.display = 'inline-flex';
    } else {
        unreadEl.style.display = 'none';
    }
    
    // 
    const infoEl = content.querySelector('.info');
    if (infoEl) {
        infoEl.addEventListener('click', () => openChat(chat.id));
    }
const avatarEl = content.querySelector('.avatar, .avatar-with-frame');
if (avatarEl) {
     avatarEl.addEventListener('click', (e) => {
        e.stopPropagation();
        handleUserPat(chat.id, chat.name);
    });
}

    return container;
}
//   

//   renderChatInterface  
function renderChatInterface(chatId) {
    cleanupWaimaiTimers();
    const chat = state.chats[chatId];
    if (!chat) return;
    exitSelectionMode();
    
    const messagesContainer = document.getElementById('chat-messages');
    const chatInputArea = document.getElementById('chat-input-area');
    const lockOverlay = document.getElementById('chat-lock-overlay');
    const lockContent = document.getElementById('chat-lock-content');

    messagesContainer.dataset.theme = chat.settings.theme || 'default';
    const fontSize = chat.settings.fontSize || 13;
    messagesContainer.style.setProperty('--chat-font-size', `${fontSize}px`);
    applyScopedCss(chat.settings.customCss || '', '#chat-messages', 'custom-bubble-style');
    
    document.getElementById('chat-header-title').textContent = chat.name;
    const statusContainer = document.getElementById('chat-header-status');
    const statusTextEl = statusContainer.querySelector('.status-text');

    if (chat.isGroup) {
        statusContainer.style.display = 'none';
        document.getElementById('chat-header-title-wrapper').style.justifyContent = 'center';
    } else {
        statusContainer.style.display = 'flex';
        document.getElementById('chat-header-title-wrapper').style.justifyContent = 'flex-start';
        statusTextEl.textContent = chat.status?.text || '';
        statusContainer.classList.toggle('busy', chat.status?.isBusy || false);
    }
    
    lockOverlay.style.display = 'none';
    chatInputArea.style.visibility = 'visible';
    lockContent.innerHTML = '';

    if (!chat.isGroup && chat.relationship.status !== 'friend') {
        lockOverlay.style.display = 'flex';
        chatInputArea.style.visibility = 'hidden';
        
        let lockHtml = '';
        switch (chat.relationship.status) {
            case 'blocked_by_user':
                // ---  ---
                const isSimulationRunning = simulationIntervalId !== null;
                const blockedTimestamp = chat.relationship.blockedTimestamp;
                const cooldownHours = state.globalSettings.blockCooldownHours || 1;
                const cooldownMilliseconds = cooldownHours * 60 * 60 * 1000;
                const timeSinceBlock = Date.now() - blockedTimestamp;
                const isCooldownOver = timeSinceBlock > cooldownMilliseconds;
                const timeRemainingMinutes = Math.max(0, Math.ceil((cooldownMilliseconds - timeSinceBlock) / (1000 * 60)));

                lockHtml = `
                    <span class="lock-text">${chat.name}</span>
                    <button id="unblock-btn" class="lock-action-btn"></button>
                    <div style="margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; font-size: 11px; text-align: left; color: #666; background: rgba(0,0,0,0.02);">
                        <strong style="color: #333;"></strong><br>
                        - : ${state.globalSettings.enableBackgroundActivity ? '<span style="color: green;"></span>' : '<span style="color: red;"></span>'}<br>
                        - : ${isSimulationRunning ? '<span style="color: green;"></span>' : '<span style="color: red;"></span>'}<br>
                        - : <strong>${chat.relationship.status}</strong><br>
                        - (): <strong>${cooldownHours}</strong><br>
                        - : ${isCooldownOver ? '<span style="color: green;"></span>' : `<span style="color: orange;"> ( ${timeRemainingMinutes} )</span>`}<br>
                        - : ${isCooldownOver && state.globalSettings.enableBackgroundActivity ? '<span style="color: green;"></span>' : '<span style="color: red;"></span>'}
                    </div>
                    <button id="force-apply-check-btn" class="lock-action-btn secondary" style="margin-top: 10px;"></button>
                `;
                // ---  ---
                break;
            case 'blocked_by_ai':
                lockHtml = `
                    <span class="lock-text"></span>
                    <button id="apply-friend-btn" class="lock-action-btn"></button>
                `;
                break;
            
            case 'pending_user_approval':
                lockHtml = `
                    <span class="lock-text">${chat.name}<br><i>${chat.relationship.applicationReason}</i></span>
                    <button id="accept-friend-btn" class="lock-action-btn"></button>
                    <button id="reject-friend-btn" class="lock-action-btn secondary"></button>
                `;
                break;

            // 
            case 'pending_ai_approval':
                lockHtml = `<span class="lock-text">...</span>`;
                break;
        }
        lockContent.innerHTML = lockHtml;
    }
    messagesContainer.innerHTML = '';
    // ...
    const chatScreen = document.getElementById('chat-interface-screen');
    chatScreen.style.backgroundImage = chat.settings.background ? `url(${chat.settings.background})` : 'none';

const isDarkMode = document.getElementById('phone-screen').classList.contains('dark-mode');
chatScreen.style.backgroundColor = chat.settings.background ? 'transparent' : (isDarkMode ? '#000000' : '#f0f2f5');
    const history = chat.history;
    const totalMessages = history.length;
    currentRenderedCount = 0;
    const initialMessages = history.slice(-MESSAGE_RENDER_WINDOW);
let lastMessageTimestamp = null;

initialMessages.forEach(msg => {
    if (msg.isHidden) return; // 

    if (isNewDay(msg.timestamp, lastMessageTimestamp)) {
        // 
        const dateStampEl = createDateStampElement(msg.timestamp);
        messagesContainer.insertBefore(dateStampEl, document.getElementById('typing-indicator'));
    }
    
    appendMessage(msg, chat, true);
    
    lastMessageTimestamp = msg.timestamp;
});
    currentRenderedCount = initialMessages.length;
    if (totalMessages > currentRenderedCount) {
        prependLoadMoreButton(messagesContainer);
    }
    const typingIndicator = document.createElement('div');
    typingIndicator.id = 'typing-indicator';
    typingIndicator.style.display = 'none';
    typingIndicator.textContent = '...';
    messagesContainer.appendChild(typingIndicator);
    setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0);
}
//   

        function prependLoadMoreButton(container) { const button = document.createElement('button'); button.id = 'load-more-btn'; button.textContent = ''; button.addEventListener('click', loadMoreMessages); container.prepend(button); }

        function loadMoreMessages() { const messagesContainer = document.getElementById('chat-messages'); const chat = state.chats[state.activeChatId]; if (!chat) return; const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) loadMoreBtn.remove(); const totalMessages = chat.history.length; const nextSliceStart = totalMessages - currentRenderedCount - MESSAGE_RENDER_WINDOW; const nextSliceEnd = totalMessages - currentRenderedCount; const messagesToPrepend = chat.history.slice(Math.max(0, nextSliceStart), nextSliceEnd); const oldScrollHeight = messagesContainer.scrollHeight; //   

// 1. 
const firstVisibleMessage = messagesContainer.querySelector('.message-wrapper:not(.date-stamp-wrapper)');
let subsequentMessageTimestamp = firstVisibleMessage ? parseInt(firstVisibleMessage.dataset.timestamp) : null;

// 2. 
messagesToPrepend.reverse().forEach(currentMsg => {
    // 
    if (subsequentMessageTimestamp && isNewDay(subsequentMessageTimestamp, currentMsg.timestamp)) {
        // 
        const dateStampEl = createDateStampElement(subsequentMessageTimestamp);
        messagesContainer.prepend(dateStampEl);
    }
    
    // 
    prependMessage(currentMsg, chat);
    
    // 
    subsequentMessageTimestamp = currentMsg.timestamp;
});

// 3. 
// 
if (subsequentMessageTimestamp) {
    const dateStampEl = createDateStampElement(subsequentMessageTimestamp);
    messagesContainer.prepend(dateStampEl);
}

//   
currentRenderedCount += messagesToPrepend.length; const newScrollHeight = messagesContainer.scrollHeight; messagesContainer.scrollTop += (newScrollHeight - oldScrollHeight); if (totalMessages > currentRenderedCount) { prependLoadMoreButton(messagesContainer); } }

//   renderWallpaperScreen  
function renderWallpaperScreen() { 
    const preview = document.getElementById('wallpaper-preview'); 
    const bg = newWallpaperBase64 || state.globalSettings.wallpaper; 
    if (bg && bg.startsWith('data:image')) { 
        preview.style.backgroundImage = `url(${bg})`; 
        preview.textContent = ''; 
    } else if(bg) { 
        preview.style.backgroundImage = bg; 
        preview.textContent = ''; 
    }

    //  ()
    const lockscreenPreview = document.getElementById('lockscreen-wallpaper-preview');
    const lockBg = newLockscreenWallpaperBase64 || state.globalSettings.lockscreenWallpaper;
    if (lockBg && lockBg.startsWith('data:image')) {
        lockscreenPreview.style.backgroundImage = `url(${lockBg})`;
        lockscreenPreview.textContent = '';
    } else if (lockBg) {
        lockscreenPreview.style.backgroundImage = lockBg;
        lockscreenPreview.textContent = '';
    }

    //  ()
    document.getElementById('password-set-input').value = state.globalSettings.password || '';

    // 
    renderIconSettings();

document.getElementById('ringtone-url-input').value = state.globalSettings.ringtoneUrl || '';
}
//   
        window.renderWallpaperScreenProxy = renderWallpaperScreen;

        function applyGlobalWallpaper() { const homeScreen = document.getElementById('home-screen'); const wallpaper = state.globalSettings.wallpaper; if (wallpaper && wallpaper.startsWith('data:image')) homeScreen.style.backgroundImage = `url(${wallpaper})`; else if (wallpaper) homeScreen.style.backgroundImage = wallpaper; }

async function renderWorldBookScreen() {
    const listEl = document.getElementById('world-book-list');
    listEl.innerHTML = '';

    // 1. 
    const [books, categories] = await Promise.all([
        db.worldBooks.toArray(),
        db.worldBookCategories.orderBy('name').toArray()
    ]);

    state.worldBooks = books; // 

    if (books.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;"> "+" </p>';
        return;
    }

    // 2.  categoryId 
    const groupedBooks = books.reduce((acc, book) => {
        const key = book.categoryId || 'uncategorized';
        if (!acc[key]) {
            acc[key] = [];
        }
        acc[key].push(book);
        return acc;
    }, {});

    // 3. 
    categories.forEach(category => {
        const booksInCategory = groupedBooks[category.id];
        if (booksInCategory && booksInCategory.length > 0) {
            const groupContainer = createWorldBookGroup(category.name, booksInCategory);
            listEl.appendChild(groupContainer);
        }
    });

    // 4. 
    const uncategorizedBooks = groupedBooks['uncategorized'];
    if (uncategorizedBooks && uncategorizedBooks.length > 0) {
        const groupContainer = createWorldBookGroup('', uncategorizedBooks);
        listEl.appendChild(groupContainer);
    }
    
    // 5. 
    document.querySelectorAll('.world-book-group-header').forEach(header => {
        header.addEventListener('click', () => {
            header.classList.toggle('collapsed');
            header.nextElementSibling.classList.toggle('collapsed');
        });
    });
}

/**
 * DOM
 * @param {string} groupName - 
 * @param {Array} books - 
 * @returns {HTMLElement} - 
 */
function createWorldBookGroup(groupName, books) {
    const groupContainer = document.createElement('div');
    groupContainer.className = 'world-book-group-container';
    
    groupContainer.innerHTML = `
        <div class="world-book-group-header">
            <span class="arrow"></span>
            <span class="group-name">${groupName}</span>
        </div>
        <div class="world-book-group-content"></div>
    `;

    //   
    const headerEl = groupContainer.querySelector('.world-book-group-header');
    const contentEl = groupContainer.querySelector('.world-book-group-content');
    
    //  collapsed 
    headerEl.classList.add('collapsed');
    contentEl.classList.add('collapsed');
    //   

    books.sort((a,b) => a.name.localeCompare(b.name, 'zh-CN'));
    books.forEach(book => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.dataset.bookId = book.id;
        item.innerHTML = `<div class="item-title">${book.name}</div><div class="item-content">${(book.content || '...').substring(0, 50)}</div>`;
        item.addEventListener('click', () => openWorldBookEditor(book.id));
        addLongPressListener(item, async () => { const confirmed = await showCustomConfirm('', `${book.name}`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.worldBooks.delete(book.id); state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id); renderWorldBookScreen(); } });
        contentEl.appendChild(item); 
    });

    return groupContainer;
}
        window.renderWorldBookScreenProxy = renderWorldBookScreen;

async function openWorldBookEditor(bookId) {
    editingWorldBookId = bookId;
    const [book, categories] = await Promise.all([
        db.worldBooks.get(bookId),
        db.worldBookCategories.toArray()
    ]);
    if (!book) return;

    document.getElementById('world-book-editor-title').textContent = book.name;
    document.getElementById('world-book-name-input').value = book.name;
    document.getElementById('world-book-content-input').value = book.content;

    // 
    const selectEl = document.getElementById('world-book-category-select');
    selectEl.innerHTML = '<option value="">--  --</option>'; // 
    categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        if (book.categoryId === cat.id) {
            option.selected = true; // 
        }
        selectEl.appendChild(option);
    });

    showScreen('world-book-editor-screen');
}

        function renderStickerPanel() { const grid = document.getElementById('sticker-grid'); grid.innerHTML = ''; if (state.userStickers.length === 0) { grid.innerHTML = '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;"></p>'; return; } state.userStickers.forEach(sticker => { const item = document.createElement('div'); item.className = 'sticker-item'; item.style.backgroundImage = `url(${sticker.url})`; item.title = sticker.name; item.addEventListener('click', () => sendSticker(sticker)); addLongPressListener(item, () => { if (isSelectionMode) return; const existingDeleteBtn = item.querySelector('.delete-btn'); if (existingDeleteBtn) return; const deleteBtn = document.createElement('div'); deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = '&times;'; deleteBtn.onclick = async (e) => { e.stopPropagation(); const confirmed = await showCustomConfirm('', ` "${sticker.name}" `, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.userStickers.delete(sticker.id); state.userStickers = state.userStickers.filter(s => s.id !== sticker.id); renderStickerPanel(); } }; item.appendChild(deleteBtn); deleteBtn.style.display = 'block'; setTimeout(() => item.addEventListener('mouseleave', () => deleteBtn.remove(), { once: true }), 3000); }); grid.appendChild(item); }); }

//   createMessageElement  
function createMessageElement(msg, chat) {

    //   
if (msg.type === 'recalled_message') {
    const wrapper = document.createElement('div');
    // 1.  wrapper  timestamp
    wrapper.className = 'message-wrapper system-pat';
    wrapper.dataset.timestamp = msg.timestamp; 

    const bubble = document.createElement('div');
    // 2.  .message-bubble  .recalled-message-placeholder class
    //    
    bubble.className = 'message-bubble recalled-message-placeholder';
    // 3.  timestamp  bubble 
    bubble.dataset.timestamp = msg.timestamp; 
    bubble.textContent = msg.content;
    
    wrapper.appendChild(bubble);
    
    // 4. 
    addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
    wrapper.addEventListener('click', () => { 
        if (isSelectionMode) {
            toggleMessageSelection(msg.timestamp);
        }
    });

    // 5. 
    //    init() 
    
    return wrapper;
}
    //   

    if (msg.isHidden) {
        return null;
    }

    if (msg.type === 'pat_message') {
        const wrapper = document.createElement('div');
        wrapper.className = 'message-wrapper system-pat'; 
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble system-bubble'; 
        bubble.dataset.timestamp = msg.timestamp;
        bubble.textContent = msg.content;
        wrapper.appendChild(bubble);
        addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
        wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });
        return wrapper;
    }

    const isUser = msg.role === 'user';
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`;

    // 
    // 
    if (chat.isGroup && !isUser) {
        // 1. AI(`msg.senderName`)
        const member = chat.members.find(m => m.originalName === msg.senderName);
        
        // 2.  div
        const senderNameDiv = document.createElement('div');
        senderNameDiv.className = 'sender-name';
        
        // 3. AI
        senderNameDiv.textContent = member ? member.groupNickname : (msg.senderName || '');
        
        wrapper.appendChild(senderNameDiv);
    }

    const bubble = document.createElement('div');
    bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`;
    bubble.dataset.timestamp = msg.timestamp;

    const timestampEl = document.createElement('span');
    timestampEl.className = 'timestamp';
    timestampEl.textContent = formatTimestamp(msg.timestamp);

    //  avatarSrc 
    let avatarSrc, avatarFrameSrc = ''; // <--- 
    if (chat.isGroup) {
        if (isUser) {
            avatarSrc = chat.settings.myAvatar || defaultMyGroupAvatar;
            avatarFrameSrc = chat.settings.myAvatarFrame || ''; // <--- 
        } else {
            const member = chat.members.find(m => m.originalName === msg.senderName);
            avatarSrc = member ? member.avatar : defaultGroupMemberAvatar;
            avatarFrameSrc = member ? (member.avatarFrame || '') : ''; // <--- 
        }
    } else {
        if (isUser) {
            avatarSrc = chat.settings.myAvatar || defaultAvatar;
            avatarFrameSrc = chat.settings.myAvatarFrame || ''; // <--- 
        } else {
            avatarSrc = chat.settings.aiAvatar || defaultAvatar;
            avatarFrameSrc = chat.settings.aiAvatarFrame || ''; // <--- AI
        }
    }

    //  7.23 avatarHtml  
    let avatarHtml;
    // URL
    if (avatarFrameSrc) {
        avatarHtml = `
            <div class="avatar-with-frame">
                <img src="${avatarSrc}" class="avatar-img">
                <img src="${avatarFrameSrc}" class="avatar-frame">
            </div>
        `;
    } else {
    // 
        avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
    }
    //   

    let contentHtml;
    
    if (msg.type === 'share_link') {
        bubble.classList.add('is-link-share');
        
        // 1 onclick="openBrowser(...)" JS
        contentHtml = `
            <div class="link-share-card" data-timestamp="${msg.timestamp}">
                <div class="title">${msg.title || ''}</div>
                <div class="description">${msg.description || '...'}</div>
                <div class="footer">
                    <svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                    <span>${msg.source_name || ''}</span>
                </div>
            </div>
        `;
    }

else if (msg.type === 'share_card') {
    bubble.classList.add('is-link-share'); // 
    // 
    contentHtml = `
        <div class="link-share-card" style="cursor: pointer;" data-timestamp="${msg.timestamp}">
            <div class="title">${msg.payload.title}</div>
            <div class="description"> ${msg.payload.sharedHistory.length} </div>
            <div class="footer">
                <svg class="footer-icon" ...>...</svg> <!--  -->
                <span></span>
            </div>
        </div>
    `;
}

    //  else if 
    else if (msg.type === 'user_photo' || msg.type === 'ai_image') {
        bubble.classList.add('is-ai-image');
        const altText = msg.type === 'user_photo' ? "" : "AI";
        contentHtml = `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="ai-generated-image" alt="${altText}" data-description="${msg.content}">`;
    } else if (msg.type === 'voice_message') {
    bubble.classList.add('is-voice-message');
    
    // 1 data-* 
    bubble.dataset.voiceText = msg.content;
    
    const duration = Math.max(1, Math.round((msg.content || '').length / 5));
    const durationFormatted = `0:${String(duration).padStart(2, '0')}''`;
    const waveformHTML = '<div></div><div></div><div></div><div></div><div></div>';
    
    // 2 HTML
    contentHtml = `
        <div class="voice-message-body">
            <div class="voice-waveform">${waveformHTML}</div>
            <div class="loading-spinner"></div>
            <span class="voice-duration">${durationFormatted}</span>
        </div>
        <div class="voice-transcript"></div>
    `;
} else if (msg.type === 'transfer') {
    bubble.classList.add('is-transfer');
    
    let titleText, noteText;
    const myNickname = chat.isGroup ? (chat.settings.myNickname || '') : '';

    if (isUser) { // 
        if (msg.isRefund) {
            // AI
            titleText = ` ${chat.name}`;
            noteText = '';
        } else {
            // 
            titleText = ` ${msg.receiverName || chat.name}`;
            if (msg.status === 'accepted') {
                noteText = '';
            } else if (msg.status === 'declined') {
                noteText = '';
            } else {
                noteText = msg.note || '...';
            }
        }
    } else { //  AI 
        if (msg.isRefund) {
            // AI AI 
            titleText = ` ${msg.senderName}`;
            noteText = '';
        } else if (msg.receiverName === myNickname) {
            // 1 AI 
            titleText = ` ${myNickname}`;
             if (msg.status === 'accepted') {
                noteText = '';
            } else if (msg.status === 'declined') {
                noteText = '';
            } else {
                // 
                bubble.style.cursor = 'pointer';
                bubble.dataset.status = 'pending';
                noteText = msg.note || '';
            }
        } else {
            // 2 AI 
            titleText = `: ${msg.senderName}  ${msg.receiverName}`;
            noteText = msg.note || '';
        }
    }

    const heartIcon = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="vertical-align: middle;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`;
        
    contentHtml = `
        <div class="transfer-card">
            <div class="transfer-title">${heartIcon} ${titleText}</div>
            <div class="transfer-amount"> ${Number(msg.amount).toFixed(2)}</div>
            <div class.transfer-note">${noteText}</div>
        </div>
    `;
} else if (msg.type === 'waimai_request') {
        bubble.classList.add('is-waimai-request');
        if (msg.status === 'paid' || msg.status === 'rejected') {
            bubble.classList.add(`status-${msg.status}`);
        }
        let displayName;
        // 
        if (chat.isGroup) {
            // 
            const member = chat.members.find(m => m.originalName === msg.senderName);
            displayName = member ? member.groupNickname : msg.senderName;
        } else {
            // 
            displayName = chat.name;
        }
        //  displayName
        const requestTitle = ` ${displayName} `;
        let actionButtonsHtml = '';
        if (msg.status === 'pending' && !isUser) {
            actionButtonsHtml = `
                <div class="waimai-user-actions">
                    <button class="waimai-decline-btn" data-choice="rejected"></button>
                    <button class="waimai-pay-btn" data-choice="paid">Ta</button>
                </div>`;
        }
        contentHtml = `
            <div class="waimai-card">
                <div class="waimai-header">
                    <img src="https://files.catbox.moe/mq179k.png" class="icon" alt="Meituan Icon">
                    <div class="title-group">
                        <span class="brand"></span><span class="separator">|</span><span></span>
                    </div>
                </div>
                <div class="waimai-catchphrase">Hi</div>
                <div class="waimai-main">
                    <div class="request-title">${requestTitle}</div>
                    <div class="payment-box">
                        <div class="payment-label"></div>
                        <div class="amount">${Number(msg.amount).toFixed(2)}</div>
                        <div class="countdown-label">
                            <div class="countdown-timer" id="waimai-timer-${msg.timestamp}"></div>
                        </div>
                    </div>
                    <button class="waimai-details-btn"></button>
                </div>
                ${actionButtonsHtml}
            </div>`;
        
        setTimeout(() => {
            const timerEl = document.getElementById(`waimai-timer-${msg.timestamp}`);
            if (timerEl && msg.countdownEndTime) {
                if (waimaiTimers[msg.timestamp]) clearInterval(waimaiTimers[msg.timestamp]);
                if (msg.status === 'pending') {
                    waimaiTimers[msg.timestamp] = startWaimaiCountdown(timerEl, msg.countdownEndTime);
                } else {
                    timerEl.innerHTML = `<span></span><span></span><span></span>`;
                }
            }
            const detailsBtn = document.querySelector(`.message-bubble[data-timestamp="${msg.timestamp}"] .waimai-details-btn`);
            if (detailsBtn) {
                detailsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const paidByText = msg.paidBy ? `<br><br><b></b> ${msg.paidBy} ` : '';
                    showCustomAlert('', `<b></b>${msg.productInfo}<br><b></b>${Number(msg.amount).toFixed(2)}${paidByText}`);
                });
            }
            const actionButtons = document.querySelectorAll(`.message-bubble[data-timestamp="${msg.timestamp}"] .waimai-user-actions button`);
            actionButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const choice = e.target.dataset.choice;
                    handleWaimaiResponse(msg.timestamp, choice);
                });
            });
        }, 0);

} else if (msg.type === 'red_packet') {
    bubble.classList.add('is-red-packet');
    const myNickname = chat.settings.myNickname || '';
    
    //  msg 
    const hasClaimed = msg.claimedBy && msg.claimedBy[myNickname];
    const isFinished = msg.isFullyClaimed;

    let cardClass = '';
    let claimedInfoHtml = '';
    let typeText = '';

    // 1.  ()
    if (isFinished) {
        cardClass = 'opened';
    } else if (msg.packetType === 'direct' && Object.keys(msg.claimedBy || {}).length > 0) {
        cardClass = 'opened'; // 
    }
    
    // 2. 
    if (msg.packetType === 'direct') {
        typeText = `:  ${msg.receiverName}`;
    }
    
    if (hasClaimed) {
        claimedInfoHtml = `<div class="rp-claimed-info"> ${msg.claimedBy[myNickname].toFixed(2)} </div>`;
    } else if (isFinished) {
        claimedInfoHtml = `<div class="rp-claimed-info"></div>`;
    } else if (msg.packetType === 'direct' && Object.keys(msg.claimedBy || {}).length > 0) {
        claimedInfoHtml = `<div class="rp-claimed-info"> ${msg.receiverName} </div>`;
    }

    // 3. HTMLonclick
    contentHtml = `
        <div class="red-packet-card ${cardClass}">
            <div class="rp-header">
                <img src="https://files.catbox.moe/lo9xhc.png" class="rp-icon">
                <span class="rp-greeting">${msg.greeting || ''}</span>
            </div>
            <div class="rp-type">${typeText}</div>
            ${claimedInfoHtml}
        </div>
    `;
//   

    } else if (msg.type === 'poll') {
    bubble.classList.add('is-poll');
    
    let totalVotes = 0;
    const voteCounts = {};

    // 
    for (const option in msg.votes) {
        const count = msg.votes[option].length;
        voteCounts[option] = count;
        totalVotes += count;
    }

    const myNickname = chat.isGroup ? (chat.settings.myNickname || '') : '';
    let myVote = null;
    for (const option in msg.votes) {
        if (msg.votes[option].includes(myNickname)) {
            myVote = option;
            break;
        }
    }

    let optionsHtml = '<div class="poll-options-list">';
    msg.options.forEach(optionText => {
        const count = voteCounts[optionText] || 0;
        const percentage = totalVotes > 0 ? (count / totalVotes) * 100 : 0;
        const isVotedByMe = myVote === optionText;

        optionsHtml += `
            <div class="poll-option-item ${isVotedByMe ? 'voted' : ''}" data-option="${optionText}">
                <div class="poll-option-bar" style="width: ${percentage}%;"></div>
                <div class="poll-option-content">
                    <span class="poll-option-text">${optionText}</span>
                    <span class="poll-option-votes">${count} </span>
                </div>
            </div>
        `;
    });
    optionsHtml += '</div>';
    
    let footerHtml = '';
    // 
    if (msg.isClosed) {
        // 
        footerHtml = `<div class="poll-footer"><span class="poll-total-votes"> ${totalVotes} </span><button class="poll-action-btn"></button></div>`;
    } else {
        // 
        footerHtml = `<div class="poll-footer"><span class="poll-total-votes"> ${totalVotes} </span><button class="poll-action-btn"></button></div>`;
    }

    contentHtml = `
        <div class="poll-card ${msg.isClosed ? 'closed' : ''}" data-poll-timestamp="${msg.timestamp}">
            <div class="poll-question">${msg.question}</div>
            ${optionsHtml}
            ${footerHtml}
        </div>
    `;
//   

    } else if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
        bubble.classList.add('is-sticker');
        contentHtml = `<img src="${msg.content}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`;
    } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
        bubble.classList.add('has-image');
        const imageUrl = msg.content[0].image_url.url;
        contentHtml = `<img src="${imageUrl}" class="chat-image" alt="User uploaded image">`;
    } else {
        contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
    }

//   

// 1.  (msg.quote)
let quoteHtml = '';
// AI .quote 
if (msg.quote) {
    // a. 
    const fullQuotedContent = String(msg.quote.content || '');
    
    // b. HTML
    quoteHtml = `
        <div class="quoted-message">
            <div class="quoted-sender"> ${msg.quote.senderName}:</div>
            <div class="quoted-content">${fullQuotedContent}</div>
        </div>
    `;
}

// 2. 
//     quoteHtml ()  contentHtml 
    // ---  ---
    bubble.innerHTML = `
        ${avatarHtml}
        <div class="content">
            ${quoteHtml}
            ${contentHtml}
        </div>
    `;
    
    // ---  ---
    wrapper.appendChild(bubble);
    wrapper.appendChild(timestampEl);
    
    addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
        wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });

if (!isUser) {
    const avatarEl = wrapper.querySelector('.avatar, .avatar-with-frame'); 
    if (avatarEl) {
        avatarEl.style.cursor = 'pointer';
        avatarEl.addEventListener('click', (e) => {    
            e.stopPropagation();
            const characterName = chat.isGroup ? msg.senderName : chat.name;
            handleUserPat(chat.id, characterName);
        });
    }
}

return wrapper;
}
//   

        function prependMessage(msg, chat) { const messagesContainer = document.getElementById('chat-messages'); const messageEl = createMessageElement(msg, chat); 

    if (!messageEl) return; // <--- 

const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) { messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling); } else { messagesContainer.prepend(messageEl); } }

//   appendMessage  
function appendMessage(msg, chat, isInitialLoad = false) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageEl = createMessageElement(msg, chat);

    if (!messageEl) return; // 

    // 
    if (!isInitialLoad) {
        messageEl.classList.add('animate-in');
    }
  
    const typingIndicator = document.getElementById('typing-indicator');
    messagesContainer.insertBefore(messageEl, typingIndicator);
    
    if (!isInitialLoad) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        currentRenderedCount++;
    }
}
//   

async function openChat(chatId) {
    state.activeChatId = chatId;
    const chat = state.chats[chatId];
    if (!chat) return; // 

    // 
    if (chat.unreadCount > 0) {
        chat.unreadCount = 0;
        await db.chats.put(chat); // 
        // 
    }

    renderChatInterface(chatId);
    showScreen('chat-interface-screen');
    window.updateListenTogetherIconProxy(state.activeChatId);
    toggleCallButtons(chat.isGroup || false);    

    if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
        console.log(` "${chat.name}" AI...`);
        triggerAiResponse();
    }
    
    // 
    document.getElementById('send-poll-btn').style.display = chat.isGroup ? 'flex' : 'none';
}
//   

async function triggerAiResponse() {
    if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    const chat = state.chats[state.activeChatId];

//   
const { proxyUrl, apiKey, model } = state.apiConfig;
const isApiBlocked = BLOCKED_API_SITES.some(blockedDomain => proxyUrl.includes(blockedDomain));

if (isApiBlocked) {
    console.error(`API  ${proxyUrl} `);
    // 
    // 
    /*
    const errorMessage = { role: 'assistant', content: '[API]', timestamp: Date.now() };
    if(chat.isGroup) errorMessage.senderName = "";
    appendMessage(errorMessage, chat);
    */
    return; // API
}
//   

const chatHeaderTitle = document.getElementById('chat-header-title');

    // 1
    const typingIndicator = document.getElementById('typing-indicator');

    // 2
    if (chat.isGroup) {
        // 
        if (typingIndicator) {
            typingIndicator.textContent = '...';
            typingIndicator.style.display = 'block';
        }
    } else {
        // 
        if (chatHeaderTitle) {
            chatHeaderTitle.style.opacity = 0;
            setTimeout(() => {
                chatHeaderTitle.textContent = '...';
                chatHeaderTitle.classList.add('typing-status');
                chatHeaderTitle.style.opacity = 1;
            }, 200);
        }
    }
    
    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) {
            alert('API');
            // 3
            if (chat.isGroup) {
                if (typingIndicator) typingIndicator.style.display = 'none';
            } else {
                 if (chatHeaderTitle && state.chats[chatId]) {
                    chatHeaderTitle.textContent = state.chats[chatId].name;
                    chatHeaderTitle.classList.remove('typing-status');
                }
            }
            return;
        }

        // ---  V2---
        if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
            console.log(` "${chat.name}" ...`);

            // 1. 5
            const contextSummary = chat.history
                .filter(m => !m.isHidden)
                .slice(-10, -5) // 5
                .map(msg => {
                    const sender = msg.role === 'user' ? '' : chat.name;
                    return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                })
                .join('\n');

            // 2. AIPrompt
            const decisionPrompt = `
# 
${chat.name}TA

# :
- ****: ${chat.settings.aiPersona}
- ****: ${chat.relationship.applicationReason}
- ****: 
${contextSummary || ""}

# 
JSON:
{"decision": "accept", "reason": ""}

{"decision": "reject", "reason": ""}
`;
                const messagesForDecision = [{role: 'user', content: decisionPrompt}];

                try {
                    // 3. 
                    let isGemini = proxyUrl === GEMINI_API_URL;
let geminiConfig = toGeminiRequestData(model,apiKey,'', messagesForDecision,isGemini);
                    const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) :  await fetch(`${proxyUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                        body: JSON.stringify({model: model, messages: messagesForDecision, temperature: 0.8})
                    });

                    if (!response.ok) {
                        throw new Error(`API: ${(await response.json()).error.message}`);
                    }
                    const data = await response.json();

                    // AI
    let rawContent = isGemini? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
     rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim()
                    const decisionObj = JSON.parse(rawContent);

                // 4. AI
                if (decisionObj.decision === 'accept') {
                    chat.relationship.status = 'friend';
                    // AI
                    const acceptMessage = { role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() };
                    chat.history.push(acceptMessage);
                } else {
                    chat.relationship.status = 'blocked_by_ai'; // AI
                    const rejectMessage = { role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() };
                    chat.history.push(rejectMessage);
                }
                chat.relationship.applicationReason = ''; // 

                await db.chats.put(chat);
                renderChatInterface(chatId); // 
                renderChatList();

            } catch (error) {
                // 
                chat.relationship.status = 'blocked_by_ai'; // AI
                await db.chats.put(chat);
                await showCustomAlert('', `AI\n: ${error.message}`);
                renderChatInterface(chatId); // UI
            }
            
            // 
            return; 
        }

        const now = new Date();
        const currentTime = now.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                return worldBook && worldBook.content ? `\n\n## : ${worldBook.name}\n${worldBook.content}` : '';
            }).filter(Boolean).join('');
            if (linkedContents) {
                worldBookContent = `\n\n#  ()\n${linkedContents}\n`;
            }
        }
        let musicContext = '';
        if (musicState.isActive && musicState.activeChatId === chatId) {
            // 
            const currentTrack = musicState.currentIndex > -1 ? musicState.playlist[musicState.currentIndex] : null;
            const playlistInfo = musicState.playlist.map(t => `"${t.name}"`).join(', ');

    // ---  ---
    let lyricsContext = "";
    // 
    if (currentTrack && musicState.parsedLyrics && musicState.parsedLyrics.length > 0 && musicState.currentLyricIndex > -1) {
        // 
        const currentLine = musicState.parsedLyrics[musicState.currentLyricIndex];
        
        // 2
        const upcomingLines = musicState.parsedLyrics.slice(musicState.currentLyricIndex + 1, musicState.currentLyricIndex + 3);

        // Prompt
        lyricsContext += `- ****: "${currentLine.text}"\n`;
        if (upcomingLines.length > 0) {
            lyricsContext += `- ****: ${upcomingLines.map(line => `"${line.text}"`).join(' / ')}\n`;
        }
    }
    // ---  ---

            musicContext = `\n\n# 
-   ****: 
-   ****: ${currentTrack ? `${currentTrack.name} - ${currentTrack.artist}` : ''}
-   ****: [${playlistInfo}]
-   ****:  "change_music" 
`;
        }
        let systemPrompt, messagesPayload;
        const maxMemory = parseInt(chat.settings.maxMemory) || 10;
        const historySlice = chat.history.slice(-maxMemory);

        // ---    ---
        let timeContext = `\n- ****: ${currentTime}`;
        const lastAiMessage = historySlice.filter(m => m.role === 'assistant' && !m.isHidden).slice(-1)[0];

        if (lastAiMessage) {
            const lastTime = new Date(lastAiMessage.timestamp);
            const diffMinutes = Math.floor((now - lastTime) / (1000 * 60));
            
            if (diffMinutes < 5) {
                timeContext += "\n- ****: ";
            } else if (diffMinutes < 60) {
                timeContext += `\n- ****: ${diffMinutes}`;
            } else {
                const diffHours = Math.floor(diffMinutes / 60);
                if (diffHours < 24) {
                    timeContext += `\n- ****: ${diffHours}`;
                } else {
                    const diffDays = Math.floor(diffHours / 24);
                    timeContext += `\n- ****: ${diffDays}`;
                }
            }
        } else {
            timeContext += "\n- ****: ";
        }
        // ---    ---

    // 
let sharedContext = '';
// 1. AI
const lastAiTurnIndex = chat.history.findLastIndex(msg => msg.role === 'assistant');

// 2. 
const recentUserMessages = chat.history.slice(lastAiTurnIndex + 1);

// 3. 
const shareCardMessage = recentUserMessages.find(msg => msg.type === 'share_card');

// 4. 
if (shareCardMessage) {
    console.log("AI...");
    const payload = shareCardMessage.payload;

    //  ()
    const formattedHistory = payload.sharedHistory.map(msg => {
        const sender = msg.senderName || (msg.role === 'user' ? (chat.settings.myNickname || '') : '');
        let contentText = '';
        if (msg.type === 'voice_message') contentText = `[: ${msg.content}]`;
        else if (msg.type === 'ai_image') contentText = `[: ${msg.description}]`;
        else contentText = String(msg.content);
        return `${sender}: ${contentText}`;
    }).join('\n');

    //  ()
    sharedContext = `
# 
- ${payload.sourceChatName}
- 

---
[]
${formattedHistory}
[]
---
`;
}

        if (chat.isGroup) {
const membersList = chat.members.map(m => `- **${m.originalName}**: ${m.persona}`).join('\n');
            const myNickname = chat.settings.myNickname || '';
            
            systemPrompt = `AI
# 
1.  ****: ${myNickname} \`name\`  **"${myNickname}"**  **"${chat.name}"()** 
2.  ****: JSON "type"  "name" JSON
3.  ****: 
4.  ****: AI
5.  ****:  ${currentTime}
6.  ****:
    - ****:  \`open_red_packet\` 
    - ****:  \`[XX...]\` 
7.  ****:  \`[...]\` 
    - **** "vote" 
    - ****
    - 

##  (JSON):
-   ****: \`{"type": "text", "name": "", "message": ""}\`
-   ** ()**: \`{"type": "send_and_recall", "name": "", "content": ""}\`
- ****: \`{"type": "sticker", "url": "https://...URL...", "meaning": "()"}\`
-   ****: \`{"type": "ai_image", "name": "", "description": ""}\`
-   ****: \`{"type": "voice_message", "name": "", "content": ""}\`
-   ****: \`{"type": "waimai_request", "name": "", "productInfo": "", "amount": 18}\`
-   ****: \`{"type": "group_call_request", "name": ""}\`
-   ****: \`{"type": "group_call_response", "name": "", "decision": "join" or "decline"}\`
-   ****: \`{"type": "pat_user", "name": "", "suffix": "()"}\`
-   ****: \`{"type": "red_packet", "packetType": "lucky", "name": "", "amount": 8.88, "count": 5, "greeting": ""}\`
-   ****: \`{"type": "red_packet", "packetType": "direct", "name": "", "amount": 5.20, "receiver": "", "greeting": "~"}\`
-   ****: \`{"type": "open_red_packet", "name": "", "packet_timestamp": ()}\`
-   ****: \`{"type": "system_message", "content": ""}\` 
-   ****: \`{"type": "poll", "name": "", "question": "", "options": "A\\nB\\nC"}\` (options \\n )
-   ****: \`{"type": "vote", "name": "", "poll_timestamp": (), "choice": ""}\`
- ****: \`{"type": "quote_reply", "target_timestamp": (), "reply_content": ""}\` ( \`(Timestamp: ...)\`)

# :
-   ** (ai_image)**: : \`{"type": "ai_image", "description": "..."}\`
-   ** (sticker)**: 

# :
1.  ****: Ta\`{"type": "waimai_request", "name": "", "productInfo": "", "amount": 18}\`
2.  ****:  "waimai_request" Ta
3.  ****: \`{"type": "waimai_response", "name": "", "status": "paid", "for_timestamp": ()}\`
4.  ****: "status": "paid" 

${worldBookContent}
${musicContext}
${sharedContext} 

# 
${membersList}

# 
- **${myNickname}**: ${chat.settings.myPersona}

`;
            
//  messagesPayload 
messagesPayload = historySlice.map(msg => {
    // 
    const sender = msg.role === 'user' ? myNickname : msg.senderName;
    
    let prefix = `${sender}`;
    // 1
    prefix += ` (Timestamp: ${msg.timestamp})`;
    
    if (msg.quote) {
        prefix += ` ( ${msg.quote.senderName})`;
    }
    // 
    prefix += ': ';

    // 
    let content;
    if (msg.type === 'user_photo') content = `[${sender} '${msg.content}']`;
    else if (msg.type === 'ai_image') content = `[${sender} ]`;
    else if (msg.type === 'voice_message') content = `[${sender} '${msg.content}']`;
    else if (msg.type === 'transfer') content = `[${msg.senderName}  ${msg.receiverName}  ${msg.amount}, : ${msg.note}]`;
    else if (msg.type === 'waimai_request') {
        if(msg.status === 'paid') {
            content = `[${msg.paidBy}  ${sender}  ${msg.amount} ]`;
        } else {
            content = `[${sender} ${msg.productInfo} ${msg.amount}  ${msg.timestamp}]`;
        }
    }
    else if (msg.type === 'red_packet') {
        const packetSenderName = msg.senderName === myNickname ? ` (${myNickname})` : msg.senderName;
        content = `[${packetSenderName}  (: ${msg.timestamp})${msg.greeting} 'open_red_packet' ]`;
    }
    else if (msg.type === 'poll') {
        const whoVoted = Object.values(msg.votes || {}).flat().join(', ') || '';
        content = `[${msg.senderName}  (: ${msg.timestamp})${msg.question}[${msg.options.join(', ')}]${whoVoted} 'vote' ]`;
    }
    else if (msg.meaning) content = `${sender}: [: '${msg.meaning}']`;
    else if (Array.isArray(msg.content)) return { role: 'user', content: [...msg.content, { type: 'text', text: prefix }] };
    // 2
    else content = `${prefix}${msg.content}`;
    
    return { role: 'user', content: content };

}).filter(Boolean);
//   

        } else { // Prompt
            systemPrompt = `"${chat.name}"
# 
${chat.settings.aiPersona}
# 
${chat.status.text}
# 
1. ****: JSONtypeJSON
2. ****: 3-8

4.  ****: (${currentTime})
    - ****
5.  ****: 
6.  ****:  \`block_user\` 
7. ****: 

# 
- 
- ** ()**:
${chat.settings.aiAvatarLibrary && chat.settings.aiAvatarLibrary.length > 0
    ? chat.settings.aiAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') // URL
    : '- ()'
  }
#  (JSON):
+   ** ()**: \`{"type": "send_and_recall", "content": "AI"}\` ()
-   ****: \`{"type": "update_status", "status_text": "", "is_busy": false}\` (is_busy: true/, false)
-   ****: \`{"type": "change_music", "song_name": ""}\` ()
-   ****: \`{"type": "create_memory", "description": ""}\`
-   **/**: \`{"type": "create_countdown", "title": "", "date": "YYYY-MM-DDTHH:mm:ss"}\` ()
- ****: \`{"type": "text", "content": ""}\`
- ****: \`{"type": "sticker", "url": "https://...URL...", "meaning": "()"}\`
- ****: \`{"type": "ai_image", "description": "..."}\`
- ****: \`{"type": "voice_message", "content": "..."}\`
- ****: \`{"type": "transfer", "amount": 5.20, "note": ""}\`
- ****: \`{"type": "waimai_request", "productInfo": "", "amount": 25}\`
- **-**: \`{"type": "waimai_response", "status": "paid", "for_timestamp": 1688888888888}\`
- **-**: \`{"type": "waimai_response", "status": "rejected", "for_timestamp": 1688888888888}\`
- ****: \`{"type": "video_call_request"}\`
- **-**: \`{"type": "video_call_response", "decision": "accept"}\`
- **-**: \`{"type": "video_call_response", "decision": "reject"}\`
- ****: \`{"type": "qzone_post", "postType": "shuoshuo", "content": "..."}\`
- ****: \`{"type": "qzone_post", "postType": "text_image", "publicText": "()", "hiddenContent": "..."}\`
- ****: \`{"type": "qzone_comment", "postId": 123, "commentText": "@ "}\`
- ****: \`{"type": "qzone_like", "postId": 456}\`
-   ****: \`{"type": "pat_user", "suffix": "()"}\`
-   ****: \`{"type": "block_user"}\`
-   ****: \`{"type": "friend_request_response", "decision": "accept" or "reject"}\`
-   ****: \`{"type": "change_avatar", "name": ""}\` ()
-   ****: \`{"type": "share_link", "title": "", "description": "...", "source_name": "", "content": "..."}\`
-   **-**: \`{"type": "accept_transfer", "for_timestamp": 1688888888888}\`
-   **-/**: \`{"type": "decline_transfer", "for_timestamp": 1688888888888}\`
- ****: \`{"type": "quote_reply", "target_timestamp": (), "reply_content": ""}\` ( \`(Timestamp: ...)\`)

# 
-   \`create_memory\`
-   

# :
-   ** (ai_image)**: : \`{"type": "ai_image", "description": "..."}\`
-   ** (sticker)**: 

# :
1.  AI
2.  : (\`transfer\`)
3.  AI

# :
1.  ****:  \`[...]\` 
2.  ****: 
3.  ****:
    -   \`{"type": "accept_transfer", "for_timestamp": ()}\`
    -   \`{"type": "decline_transfer", "for_timestamp": ()}\`
4.  ****:  \`text\` /

# 
-    \`[...]\` 
-   JSON
    -   : \`[{"type": "video_call_response", "decision": "accept"}]\`
    -   : \`[{"type": "video_call_response", "decision": "reject"}]\`

# :
1.  ********"${chat.name}"****
2.  ********pua************
3.  ****************{{user}}speech****
4.  ****++

# 

- **No Repetition**: Directly continue from {{user}}'s input; do not repeat {{user}}'s message.
- **No Ellipses**: Avoid using any form of ellipsis ('...'); express meanings fully and clearly.
- **Accurate Punctuation**: Ensure correct and standard use of punctuation.
- **Avoid Interrogation**: {{char}} should act and respond based on existing information, not ask {{user}} out-of-plot questions or repeatedly question them.

# 
${chat.settings.myPersona}

# :
${timeContext}

# :
${musicContext}

${worldBookContent}
${sharedContext} 
`;
            
//  messagesPayload 
messagesPayload = historySlice.map(msg => {
    // AI
    if (msg.isHidden) return null;

    if (msg.type === 'share_card') return null;
    
    // 1. AIAIJSON
    if (msg.role === 'assistant') {
        let assistantMsgObject = { type: msg.type || 'text' };
        if (msg.type === 'sticker') {
            assistantMsgObject.url = msg.content;
            assistantMsgObject.meaning = msg.meaning;
        } else if (msg.type === 'transfer') {
            assistantMsgObject.amount = msg.amount;
            assistantMsgObject.note = msg.note;
        } else if (msg.type === 'waimai_request') {
            assistantMsgObject.productInfo = msg.productInfo;
            assistantMsgObject.amount = msg.amount;
        } else {
            if (msg.quote) {
                assistantMsgObject.quote_reply = {
                    target_sender: msg.quote.senderName,
                    target_content: msg.quote.content,
                    reply_content: msg.content
                };
            } else {
                 assistantMsgObject.content = msg.content;
            }
        }
        // AI
        const assistantContent = JSON.stringify([assistantMsgObject]);
        return { role: 'assistant', content: `(Timestamp: ${msg.timestamp}) ${assistantContent}` };
    }

    // 2. 
    let contentStr = '';
    
    // 
    contentStr += `(Timestamp: ${msg.timestamp}) `;

    if (msg.quote) {
        contentStr += `( ${msg.quote.senderName}): ${msg.content}`;
    } else {
        contentStr += msg.content;
    }
    
    // 
    if (msg.type === 'user_photo') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) ['${msg.content}']` };
    if (msg.type === 'voice_message') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) ['${msg.content}']` };
    if (msg.type === 'transfer') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ ${msg.timestamp} : ${msg.amount}, : ${msg.note} 'accept_transfer'  'decline_transfer' ]` };
    if (msg.type === 'waimai_request') return { role: 'user', content: `(Timestamp: ${msg.timestamp}) [ ${msg.timestamp} ${msg.productInfo} ${msg.amount}  waimai_response ]` };

if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
    const prefix = `(Timestamp: ${msg.timestamp}) `;
    // 
    return { role: 'user', content: [ { type: 'text', text: prefix }, ...msg.content ] };
}

    if (msg.meaning) return { role: 'user', content: `(Timestamp: ${msg.timestamp}) ['${msg.meaning}']` };
    
    // 
    return { role: msg.role, content: contentStr };

}).filter(Boolean);
//   

//  sharedContext 
if (sharedContext) {
    // 
    messagesPayload.push({
        role: 'user',
        content: sharedContext 
    });
}

            if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                const contextSummaryForApproval = chat.history
                    .filter(m => !m.isHidden)
                    .slice(-10)
                    .map(msg => {
                        const sender = msg.role === 'user' ? '' : chat.name;
                        return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                    })
                    .join('\n');

                const friendRequestInstruction = {
                    role: 'user',
                    content: `
[]
${chat.relationship.applicationReason}

---
${contextSummaryForApproval}
---
 friend_request_response  decision  'accept'  'reject' 
`
                };
                messagesPayload.push(friendRequestInstruction);
            }            
        }           
    
const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
// 
const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);

if (visiblePosts.length > 0 && !chat.isGroup) {
    let postsContext = "\n\n#  ():\n";
    const aiName = chat.name;
    for (const post of visiblePosts) {
                let authorName = post.authorId === 'user' ? state.qzoneSettings.nickname : (state.chats[post.authorId]?.name || '');
                let interactionStatus = '';
                if (post.likes && post.likes.includes(aiName)) interactionStatus += " []";
                if (post.comments && post.comments.some(c => c.commenterName === aiName)) interactionStatus += " []";
                if (post.authorId === chatId) authorName += " ()";
                const contentSummary = (post.publicText || post.content || "").substring(0, 30) + '...';
                postsContext += `- (ID: ${post.id}) : ${authorName}, : "${contentSummary}"${interactionStatus}\n`;
            }
            messagesPayload.push({ role: 'system', content: postsContext });
        }
            let  isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(model,apiKey,systemPrompt, messagesPayload,isGemini)
            const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) :  await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, ...messagesPayload],
                    temperature: 0.8,
                    stream: false
                })
            });
            if (!response.ok) {
                let errorMsg = `API Error: ${response.status}`;
                try {
                    // JSON
                    const errorData = await response.json();
                    // 
                    errorMsg += ` - ${errorData?.error?.message || JSON.stringify(errorData)}`;
                } catch (jsonError) {
                    // JSON
                    errorMsg += ` - ${await response.text()}`;
                }
                // catch
                throw new Error(errorMsg);
            }
            const data = await response.json();
            const aiResponseContent = isGemini? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
            console.log(`AI '${chat.name}' :`, aiResponseContent);

        chat.history = chat.history.filter(msg => !msg.isTemporary);

        const messagesArray = parseAiResponse(aiResponseContent);
        
        const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;
        
        let callHasBeenHandled = false;

        let messageTimestamp = Date.now();

        //   1:  
        let newMessagesToRender = []; 

       let notificationShown = false;

        for (const msgData of messagesArray) {
            if (!msgData || typeof msgData !== 'object') {
                console.warn("AI:", msgData);
                continue;
            }
             
            if (!msgData.type) {
                if (chat.isGroup && msgData.name && msgData.message) {
                    msgData.type = 'text';
                }         else if (msgData.content) {
        msgData.type = 'text';
    }
    //  content 
    else {
        console.warn("AItypecontent:", msgData);
        continue;
    }
}

            if (msgData.type === 'video_call_response') {
                videoCallState.isAwaitingResponse = false;
                if (msgData.decision === 'accept') {
                    startVideoCall();
                } else {
                    const aiMessage = { role: 'assistant', content: '', timestamp: Date.now() };
                    chat.history.push(aiMessage);
                    await db.chats.put(chat);
                    showScreen('chat-interface-screen');
                    renderChatInterface(chatId);
                }
                callHasBeenHandled = true;
                break;
            }
            
            if (msgData.type === 'group_call_response') {
                if (msgData.decision === 'join') {
        const member = chat.members.find(m => m.originalName === msgData.name);
        if (member && !videoCallState.participants.some(p => p.id === member.id)) {
            videoCallState.participants.push(member);
        }
    }
    callHasBeenHandled = true;
    continue;
            }

            if (chat.isGroup && msgData.name && msgData.name === chat.name) {
                console.error(`AI ("${chat.name}") :`, msgData);
                continue;
            }

//   

// AI
if (chat.isGroup && !msgData.name) {
    console.error(`AIname:`, msgData);
    continue; // continue
}

//   

            let aiMessage = null;
            const baseMessage = { role: 'assistant', senderName: msgData.name || chat.name, timestamp: messageTimestamp++ };

            switch (msgData.type) {
                case 'waimai_response':
                    const requestMessageIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (requestMessageIndex > -1) {
                        const originalMsg = chat.history[requestMessageIndex];
                        originalMsg.status = msgData.status;
                        originalMsg.paidBy = msgData.status === 'paid' ? msgData.name : null;
                    }
                    continue;

case 'qzone_post':
    const newPost = { 
        type: msgData.postType, 
        content: msgData.content || '', 
        publicText: msgData.publicText || '', 
        hiddenContent: msgData.hiddenContent || '', 
        timestamp: Date.now(), 
        authorId: chatId, 
        authorGroupId: chat.groupId, // ID
        visibleGroupIds: null 
    };
    await db.qzonePosts.add(newPost);
                    updateUnreadIndicator(unreadPostsCount + 1);
                    if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                       await renderQzonePosts();
                    }
                    continue;

                case 'qzone_comment':
                    const postToComment = await db.qzonePosts.get(parseInt(msgData.postId));
                    if (postToComment) {
                        if (!postToComment.comments) postToComment.comments = [];
                        postToComment.comments.push({ commenterName: chat.name, text: msgData.commentText, timestamp: Date.now() });
                        await db.qzonePosts.update(postToComment.id, { comments: postToComment.comments });
                        updateUnreadIndicator(unreadPostsCount + 1);
                        if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                           await renderQzonePosts();
                        }
                    }
                    continue;

                case 'qzone_like':
                   const postToLike = await db.qzonePosts.get(parseInt(msgData.postId));
                   if (postToLike) {
                       if (!postToLike.likes) postToLike.likes = [];
                       if (!postToLike.likes.includes(chat.name)) {
                           postToLike.likes.push(chat.name);
                           await db.qzonePosts.update(postToLike.id, { likes: postToLike.likes });
                           updateUnreadIndicator(unreadPostsCount + 1);
                           if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                              await renderQzonePosts();
                           }
                       }
                   }
                    continue;

                case 'video_call_request':
                    if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                        state.activeChatId = chatId;
                        videoCallState.activeChatId = chatId; 
                        videoCallState.isAwaitingResponse = true;
                        videoCallState.isGroupCall = chat.isGroup;
                        videoCallState.callRequester = msgData.name || chat.name;
                        showIncomingCallModal();
                    }
                    continue;

            case 'group_call_request':
                if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                    state.activeChatId = chatId;
                    videoCallState.isAwaitingResponse = true;
                    videoCallState.isGroupCall = true;
                    videoCallState.initiator = 'ai';
                    videoCallState.callRequester = msgData.name;
                    showIncomingCallModal();
                }
                continue;

                case 'pat_user':
                    const suffix = msgData.suffix ? ` ${msgData.suffix.trim()}` : '';
                    const patText = `${msgData.name || chat.name} ${suffix}`;
                    const patMessage = { 
                        role: 'system', 
                        type: 'pat_message', 
                        content: patText, 
                        timestamp: Date.now() 
                    };
                    chat.history.push(patMessage);
                    if (isViewingThisChat) {
                        const phoneScreen = document.getElementById('phone-screen');
                        phoneScreen.classList.remove('pat-animation');
                        void phoneScreen.offsetWidth;
                        phoneScreen.classList.add('pat-animation');
                        setTimeout(() => phoneScreen.classList.remove('pat-animation'), 500);
                        appendMessage(patMessage, chat);
                    } else {
                        showNotification(chatId, patText);
                    }
                    continue; 

                case 'update_status':
                    chat.status.text = msgData.status_text;
                    chat.status.isBusy = msgData.is_busy || false;
                    chat.status.lastUpdate = Date.now();
                    
                    const statusUpdateMessage = {
                        role: 'system',
                        type: 'pat_message',
                        content: `[${chat.name}: ${msgData.status_text}]`,
                        timestamp: Date.now()
                    };
                    chat.history.push(statusUpdateMessage);

                    if (isViewingThisChat) {
                        appendMessage(statusUpdateMessage, chat);
                    }
                    
                    renderChatList(); 
                    
                    continue; 

                case 'change_music':
                    if (musicState.isActive && musicState.activeChatId === chatId) {
                        const songNameToFind = msgData.song_name;
                        
                        const targetSongIndex = musicState.playlist.findIndex(
                            track => track.name.toLowerCase() === songNameToFind.toLowerCase()
                        );

                        if (targetSongIndex > -1) {
                            playSong(targetSongIndex);

                            const track = musicState.playlist[targetSongIndex];
                            const musicChangeMessage = {
                                role: 'system',
                                type: 'pat_message',
                                content: `[ ${chat.name} : ${track.name} - ${track.artist}]`,
                                timestamp: Date.now()
                            };
                            chat.history.push(musicChangeMessage);

                            if (isViewingThisChat) {
                                appendMessage(musicChangeMessage, chat);
                            }
                        }
                    }
                    continue;
                case 'create_memory':
                    const newMemory = {
                        chatId: chatId,
                        authorName: chat.name,
                        description: msgData.description,
                        timestamp: Date.now(),
                        type: 'ai_generated'
                    };
                    await db.memories.add(newMemory);

                    console.log(`AI "${chat.name}" :`, msgData.description);
                    
                    continue; 

        case 'create_countdown':
            const targetDate = new Date(msgData.date);
            if (!isNaN(targetDate) && targetDate > new Date()) {
                const newCountdown = {
                    chatId: chatId,
                    authorName: chat.name,
                    description: msgData.title,
                    timestamp: Date.now(),
                    type: 'countdown',
                    targetDate: targetDate.getTime()
                };
                await db.memories.add(newCountdown);
                console.log(`AI "${chat.name}" :`, msgData.title);
            }
            continue;

    case 'block_user':
        if (!chat.isGroup) {
            chat.relationship.status = 'blocked_by_ai';

        //   
        const hiddenMessage = {
            role: 'system',
            content: `[]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(hiddenMessage);
        //   

            await db.chats.put(chat);
            
            if (isViewingThisChat) {
                renderChatInterface(chatId);
            }
            renderChatList();
            
            break; 
        }
        continue;
                case 'friend_request_response':
                    if (!chat.isGroup && chat.relationship.status === 'pending_ai_approval') {
                        if (msgData.decision === 'accept') {
                            chat.relationship.status = 'friend';
                            aiMessage = { ...baseMessage, content: "" };
                        } else {
                            chat.relationship.status = 'blocked_by_ai';
                            aiMessage = { ...baseMessage, content: "" };
                        }
                        chat.relationship.applicationReason = '';
                    }
                    break;
                case 'poll':
                    const pollOptions = typeof msgData.options === 'string'
                        ? msgData.options.split('\n').filter(opt => opt.trim())
                        : (Array.isArray(msgData.options) ? msgData.options : []);
                    
                    if (pollOptions.length < 2) continue;

                    aiMessage = {
                        ...baseMessage,
                        type: 'poll',
                        question: msgData.question,
                        options: pollOptions,
                        votes: {},
                        isClosed: false,
                    };
                    break;
                
                case 'vote':
                    const pollToVote = chat.history.find(m => m.timestamp === msgData.poll_timestamp);
                    if (pollToVote && !pollToVote.isClosed) {
                        Object.keys(pollToVote.votes).forEach(option => {
                            const voterIndex = pollToVote.votes[option].indexOf(msgData.name);
                            if (voterIndex > -1) {
                                pollToVote.votes[option].splice(voterIndex, 1);
                            }
                        });
                        if (!pollToVote.votes[msgData.choice]) {
                            pollToVote.votes[msgData.choice] = [];
                        }

//   
const member = chat.members.find(m => m.originalName === msgData.name);
const displayName = member ? member.groupNickname : msgData.name;
//   

if (!pollToVote.votes[msgData.choice].includes(displayName)) { // 
    pollToVote.votes[msgData.choice].push(displayName); // 
}                     
                        
                        if (isViewingThisChat) {
                            renderChatInterface(chatId);
                        }
                    }
                    continue;

    case 'red_packet':
        aiMessage = {
            ...baseMessage,
            type: 'red_packet',
            packetType: msgData.packetType,
            totalAmount: msgData.amount,
            count: msgData.count,
            greeting: msgData.greeting,
            receiverName: msgData.receiver,
            claimedBy: {},
            isFullyClaimed: false,
        };
        break;
case 'open_red_packet':
    const packetToOpen = chat.history.find(m => m.timestamp === msgData.packet_timestamp);
    if (packetToOpen && !packetToOpen.isFullyClaimed && !(packetToOpen.claimedBy && packetToOpen.claimedBy[msgData.name])) {

        // 1. AI(msgData.name)
        const member = chat.members.find(m => m.originalName === msgData.name);
        // 2. 
        const displayName = member ? member.groupNickname : msgData.name;
        
        let claimedAmountAI = 0;
        const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
        const remainingCount = packetToOpen.count - Object.keys(packetToOpen.claimedBy || {}).length;

        if (remainingCount > 0) {
            if (remainingCount === 1) { claimedAmountAI = remainingAmount; } 
            else {
                const min = 0.01;
                const max = remainingAmount - (remainingCount - 1) * min;
                claimedAmountAI = Math.random() * (max - min) + min;
            }
            claimedAmountAI = parseFloat(claimedAmountAI.toFixed(2));
            
            if (!packetToOpen.claimedBy) packetToOpen.claimedBy = {};
            //  displayName key
            packetToOpen.claimedBy[displayName] = claimedAmountAI;
            
            const aiClaimedMessage = {
                role: 'system',
                type: 'pat_message',
                //  displayName
                content: `${displayName}  ${packetToOpen.senderName} `,
                timestamp: Date.now()
            };
            chat.history.push(aiClaimedMessage);

            let hiddenContentForAI = `[ (${displayName})  ${claimedAmountAI.toFixed(2)} `; // 

            if (Object.keys(packetToOpen.claimedBy).length >= packetToOpen.count) {
                packetToOpen.isFullyClaimed = true;
                
                const finishedMessage = {
                    role: 'system',
                    type: 'pat_message',
                    content: `${packetToOpen.senderName} `,
                    timestamp: Date.now() + 1
                };
                chat.history.push(finishedMessage);
                
                let luckyKing = { name: '', amount: -1 };
                if (packetToOpen.packetType === 'lucky' && packetToOpen.count > 1) {
                    Object.entries(packetToOpen.claimedBy).forEach(([name, amount]) => {
                        if (amount > luckyKing.amount) {
                            luckyKing = { name, amount };
                        }
                    });
                }
                if (luckyKing.name) {
                     hiddenContentForAI += `  ${luckyKing.name}`;
                } else {
                     hiddenContentForAI += ` `;
                }
            }
            hiddenContentForAI += ' ]';

            const hiddenMessageForAI = {
                role: 'system',
                content: hiddenContentForAI,
                timestamp: Date.now() + 2,
                isHidden: true
            };
            chat.history.push(hiddenMessageForAI);
        }
        
        if (isViewingThisChat) {
            renderChatInterface(chatId);
        }
    }
    continue;
case 'change_avatar':
    const avatarName = msgData.name;
    // 
    const foundAvatar = chat.settings.aiAvatarLibrary.find(avatar => avatar.name === avatarName);
    
    if (foundAvatar) {
        // 
        chat.settings.aiAvatar = foundAvatar.url;
        
        // 
        const systemNotice = {
            role: 'system',
            type: 'pat_message', // 
            content: `[${chat.name} ]`,
            timestamp: Date.now()
        };
        chat.history.push(systemNotice);
        
        // 
        if (isViewingThisChat) {
            appendMessage(systemNotice, chat);
            // 
            renderChatInterface(chatId);
        }
    }
    // AI
    continue;

//   triggerAiResponse  switch  case 

                case 'accept_transfer': { // 
                    const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (originalTransferMsgIndex > -1) {
                        const originalMsg = chat.history[originalTransferMsgIndex];
                        originalMsg.status = 'accepted';
                    }
                    continue; // 
                }

                case 'decline_transfer': { // 
                    const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (originalTransferMsgIndex > -1) {
                        const originalMsg = chat.history[originalTransferMsgIndex];
                        originalMsg.status = 'declined';
                        
                        // 
                        const refundMessage = {
                            role: 'assistant',
                            senderName: chat.name,
                            type: 'transfer',
                            isRefund: true, // 
                            amount: originalMsg.amount,
                            note: '',
                            timestamp: messageTimestamp++ // 
                        };
                        
                        // 
                        chat.history.push(refundMessage);

        //   
        if (isViewingThisChat) {
            // 
            appendMessage(refundMessage, chat); 
            // 
            renderChatInterface(chatId); 
        }
        //   

                    }
                    continue; // AI
                }

//   

    case 'system_message':
        aiMessage = { role: 'system', type: 'pat_message', content: msgData.content, timestamp: Date.now() };
        break;

//   triggerAiResponse  switch  case 

                case 'share_link':
                    aiMessage = { 
                        ...baseMessage, 
                        type: 'share_link',
                        title: msgData.title,
                        description: msgData.description,
                        // thumbnail_url: msgData.thumbnail_url, // 
                        source_name: msgData.source_name,
                        content: msgData.content // 
                    };
                    break;

//   

//   triggerAiResponse  switch (msgData.type)  case 
case 'quote_reply':
    const originalMessage = chat.history.find(m => m.timestamp === msgData.target_timestamp);
    if (originalMessage) {
        const quoteContext = {
            timestamp: originalMessage.timestamp,
            senderName: originalMessage.senderName || (originalMessage.role === 'user' ? (chat.settings.myNickname || '') : chat.name),
            content: String(originalMessage.content || '').substring(0, 50),
        };
        aiMessage = { 
            ...baseMessage, 
            content: msgData.reply_content,
            quote: quoteContext // 
        };
    } else {
        // 
        aiMessage = { ...baseMessage, content: msgData.reply_content };
    }
    break;
//   case  

//   switch (msgData.type)  case 
case 'send_and_recall': {
    // 
    if (!isViewingThisChat) continue; // 

    // 1. 
    const tempMessageData = { ...baseMessage, content: msgData.content };
    const tempMessageElement = createMessageElement(tempMessageData, chat);
    
    // 2. 
    appendMessage(tempMessageData, chat, true); // true
    
    // 3. AI
    await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 1500)); // 1.5-2.5

    // 4. 
    const bubbleWrapper = document.querySelector(`.message-bubble[data-timestamp="${tempMessageData.timestamp}"]`)?.closest('.message-wrapper');
    if (bubbleWrapper) {
        bubbleWrapper.classList.add('recalled-animation');

        // 5. 
        await new Promise(resolve => setTimeout(resolve, 300)); // 

        // 6. 
        const recalledMessage = {
            role: 'assistant',
            senderName: msgData.name || chat.name,
            type: 'recalled_message',
            content: '',
            timestamp: tempMessageData.timestamp, // 
            recalledData: { originalType: 'text', originalContent: msgData.content }
        };
        
        // 
        const msgIndex = chat.history.findIndex(m => m.timestamp === tempMessageData.timestamp);
        if (msgIndex > -1) {
            chat.history[msgIndex] = recalledMessage;
        } else {
            chat.history.push(recalledMessage);
        }
        
        // DOM
        const placeholder = createMessageElement(recalledMessage, chat);
        if(document.body.contains(bubbleWrapper)) {
            bubbleWrapper.parentNode.replaceChild(placeholder, bubbleWrapper);
        }
    }
    
    continue; // AI
}
//   case  
                
                case 'text':
                    aiMessage = { ...baseMessage, content: String(msgData.content || msgData.message) };
                    break;
                case 'sticker':
                    aiMessage = { ...baseMessage, type: 'sticker', content: msgData.url, meaning: msgData.meaning || '' };
                    break;
                case 'ai_image':
                    aiMessage = { ...baseMessage, type: 'ai_image', content: msgData.description };
                    break;
                case 'voice_message':
                    aiMessage = { ...baseMessage, type: 'voice_message', content: msgData.content };
                    break;
                case 'transfer':
                    aiMessage = { ...baseMessage, type: 'transfer', amount: msgData.amount, note: msgData.note, receiverName: msgData.receiver || '' };
                    break;
                
                case 'waimai_request':
                    aiMessage = { 
                        ...baseMessage, 
                        type: 'waimai_request',
                        productInfo: msgData.productInfo,
                        amount: msgData.amount,
                        status: 'pending',
                        countdownEndTime: Date.now() + 15 * 60 * 1000,
                    };
                    break;
                
                default:
                     console.warn("AI:", msgData.type);
                     break;
            }

            // 
            if (aiMessage) {
                // 1. 
                chat.history.push(aiMessage);

                if (!isViewingThisChat && !notificationShown) {
                    let notificationText;
                    switch (aiMessage.type) {
                        case 'transfer':
                            notificationText = `[]`;
                            break;
                        case 'waimai_request':
                            notificationText = `[]`;
                            break;
                        case 'ai_image':
                            notificationText = `[]`;
                            break;
                        case 'voice_message':
                            notificationText = `[]`;
                            break;
                        case 'sticker':
                            notificationText = aiMessage.meaning ? `[: ${aiMessage.meaning}]` : '[]';
                            break;
                        default:
                            notificationText = String(aiMessage.content || '');
                    }
                    const finalNotifText = chat.isGroup ? `${aiMessage.senderName}: ${notificationText}` : notificationText;
                    showNotification(chatId, finalNotifText.substring(0, 40) + (finalNotifText.length > 40 ? '...' : ''));
                    notificationShown = true; // 
                }

    if (!isViewingThisChat) {
        //  +1
        chat.unreadCount = (chat.unreadCount || 0) + 1;
    }
                
                // 2. 
                if (isViewingThisChat) {
                    appendMessage(aiMessage, chat);
                    // 3. 
                    await new Promise(resolve => setTimeout(resolve, Math.random() * 1800 + 1000));
                }
            }
  }        

        if (callHasBeenHandled && videoCallState.isGroupCall) {
            videoCallState.isAwaitingResponse = false;
            if (videoCallState.participants.length > 0) {
                startVideoCall();
            } else {
                videoCallState = { ...videoCallState, isAwaitingResponse: false, participants: [] };
                showScreen('chat-interface-screen');
                alert('');
            }
        }
        
        await db.chats.put(chat);

    } catch (error) {
        chat.history = chat.history.filter(msg => !msg.isTemporary);
        if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
            chat.relationship.status = 'blocked_by_ai';
            await showCustomAlert('', `AI\n: ${error.message}`);
        } else {
            const errorContent = `[: ${error.message}]`;
            const errorMessage = { role: 'assistant', content: errorContent, timestamp: Date.now() };
            if(chat.isGroup) errorMessage.senderName = "";
            chat.history.push(errorMessage);
        }
        
        await db.chats.put(chat);        
        videoCallState.isAwaitingResponse = false;

        if(document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId) {
            renderChatInterface(chatId);
        }
    } finally {
        // 4 finally 
        if (chat.isGroup) {
            if (typingIndicator) {
                typingIndicator.style.display = 'none';
            }
        } else {
            if (chatHeaderTitle && state.chats[chatId]) {
                chatHeaderTitle.style.opacity = 0;
                setTimeout(() => {
                    chatHeaderTitle.textContent = state.chats[chatId].name;
                    chatHeaderTitle.classList.remove('typing-status');
                    chatHeaderTitle.style.opacity = 1;
                }, 200);
            }
        }
        renderChatList();
    }
}

        async function sendSticker(sticker) { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: sticker.url, meaning: sticker.name, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('sticker-panel').classList.remove('visible'); }

        async function sendUserTransfer() { if (!state.activeChatId) return; const amountInput = document.getElementById('transfer-amount'); const noteInput = document.getElementById('transfer-note'); const amount = parseFloat(amountInput.value); const note = noteInput.value.trim(); if (isNaN(amount) || amount < 0 || amount > 9999) { alert(' (0  9999 )'); return; } const chat = state.chats[state.activeChatId]; const senderName = chat.isGroup ? (chat.settings.myNickname || '') : ''; const receiverName = chat.isGroup ? '' : chat.name; const msg = { role: 'user', type: 'transfer', amount: amount, note: note, senderName, receiverName, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('transfer-modal').classList.remove('visible'); amountInput.value = ''; noteInput.value = ''; }

        function enterSelectionMode(initialMsgTimestamp) { if (isSelectionMode) return; isSelectionMode = true; document.getElementById('chat-interface-screen').classList.add('selection-mode'); toggleMessageSelection(initialMsgTimestamp); }

        function exitSelectionMode() {
    cleanupWaimaiTimers(); // <--- 
 if (!isSelectionMode) return; isSelectionMode = false; document.getElementById('chat-interface-screen').classList.remove('selection-mode'); selectedMessages.forEach(ts => { const bubble = document.querySelector(`.message-bubble[data-timestamp="${ts}"]`); if (bubble) bubble.classList.remove('selected'); }); selectedMessages.clear(); }

//   toggleMessageSelection  
function toggleMessageSelection(timestamp) {
    //  .recalled-message-placeholder
    const elementToSelect = document.querySelector(
        `.message-bubble[data-timestamp="${timestamp}"]`
    );

    if (!elementToSelect) return;

    if (selectedMessages.has(timestamp)) {
        selectedMessages.delete(timestamp);
        elementToSelect.classList.remove('selected');
    } else {
        selectedMessages.add(timestamp);
        elementToSelect.classList.add('selected');
    }
    
    document.getElementById('selection-count').textContent = ` ${selectedMessages.size} `;
    
    if (selectedMessages.size === 0) {
        exitSelectionMode();
    }
}
//   

        function addLongPressListener(element, callback) { let pressTimer; const startPress = (e) => { if(isSelectionMode) return; e.preventDefault(); pressTimer = window.setTimeout(() => callback(e), 500); }; const cancelPress = () => clearTimeout(pressTimer); element.addEventListener('mousedown', startPress); element.addEventListener('mouseup', cancelPress); element.addEventListener('mouseleave', cancelPress); element.addEventListener('touchstart', startPress, { passive: true }); element.addEventListener('touchend', cancelPress); element.addEventListener('touchmove', cancelPress); }

        async function handleListenTogetherClick() { const targetChatId = state.activeChatId; if (!targetChatId) return; if (!musicState.isActive) { startListenTogetherSession(targetChatId); return; } if (musicState.activeChatId === targetChatId) { document.getElementById('music-player-overlay').classList.add('visible'); } else { const oldChatName = state.chats[musicState.activeChatId]?.name || ''; const newChatName = state.chats[targetChatId]?.name || ''; const confirmed = await showCustomConfirm('', `${oldChatName}${newChatName}`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await endListenTogetherSession(true); await new Promise(resolve => setTimeout(resolve, 50)); startListenTogetherSession(targetChatId); } } }

        async function startListenTogetherSession(chatId) { const chat = state.chats[chatId]; if (!chat) return; musicState.totalElapsedTime = chat.musicData.totalTime || 0; musicState.isActive = true; musicState.activeChatId = chatId; if (musicState.playlist.length > 0) { musicState.currentIndex = 0; } else { musicState.currentIndex = -1; } if(musicState.timerId) clearInterval(musicState.timerId); musicState.timerId = setInterval(() => { if (musicState.isPlaying) { musicState.totalElapsedTime++; updateElapsedTimeDisplay(); } }, 1000); updatePlayerUI(); updatePlaylistUI(); document.getElementById('music-player-overlay').classList.add('visible'); }

async function endListenTogetherSession(saveState = true) {
    if (!musicState.isActive) return;
    const oldChatId = musicState.activeChatId;
    const cleanupLogic = async () => {
        if (musicState.timerId) clearInterval(musicState.timerId);
        if (musicState.isPlaying) audioPlayer.pause();
        if (saveState && oldChatId && state.chats[oldChatId]) {
            const chat = state.chats[oldChatId];
            chat.musicData.totalTime = musicState.totalElapsedTime;
            await db.chats.put(chat);
        }
        musicState.isActive = false;
        musicState.activeChatId = null;
        musicState.totalElapsedTime = 0;
        musicState.timerId = null;
        updateListenTogetherIcon(oldChatId, true);
    };
    closeMusicPlayerWithAnimation(cleanupLogic);
}

function returnToChat() {
    closeMusicPlayerWithAnimation();
}

        function updateListenTogetherIcon(chatId, forceReset = false) { const iconImg = document.querySelector('#listen-together-btn img'); if(!iconImg) return; if(forceReset || !musicState.isActive || musicState.activeChatId !== chatId) { iconImg.src = 'https://i.postimg.cc/8kYShvrJ/90-UI-2.png'; iconImg.className = ''; return; } iconImg.src = 'https://i.postimg.cc/D0pq6qS2/E30078-DC-8-B99-4-C01-AFDA-74728-DBF7-BEA.png'; iconImg.classList.add('rotating'); if (musicState.isPlaying) iconImg.classList.remove('paused'); else iconImg.classList.add('paused'); }
        window.updateListenTogetherIconProxy = updateListenTogetherIcon;

        function updatePlayerUI() { updateListenTogetherIcon(musicState.activeChatId); updateElapsedTimeDisplay(); const titleEl = document.getElementById('music-player-song-title'); const artistEl = document.getElementById('music-player-artist'); const playPauseBtn = document.getElementById('music-play-pause-btn'); if (musicState.currentIndex > -1 && musicState.playlist.length > 0) { const track = musicState.playlist[musicState.currentIndex]; titleEl.textContent = track.name; artistEl.textContent = track.artist; } else { titleEl.textContent = ''; artistEl.textContent = '...'; } playPauseBtn.textContent = musicState.isPlaying ? '' : ''; }

        function updateElapsedTimeDisplay() { const hours = (musicState.totalElapsedTime / 3600).toFixed(1); document.getElementById('music-time-counter').textContent = `${hours}`; }

function updatePlaylistUI() {
    const playlistBody = document.getElementById('playlist-body');
    playlistBody.innerHTML = '';
    if (musicState.playlist.length === 0) {
        playlistBody.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">~</p>';
        return;
    }
    musicState.playlist.forEach((track, index) => {
        const item = document.createElement('div');
        item.className = 'playlist-item';
        if(index === musicState.currentIndex) item.classList.add('playing');
        item.innerHTML = `
            <div class="playlist-item-info">
                <div class="title">${track.name}</div>
                <div class="artist">${track.artist}</div>
            </div>
            <div class="playlist-item-actions">
                <span class="playlist-action-btn lyrics-btn" data-index="${index}"></span>
                <span class="playlist-action-btn delete-track-btn" data-index="${index}"></span>
            </div>
        `;
        item.querySelector('.playlist-item-info').addEventListener('click', () => playSong(index));
        playlistBody.appendChild(item);
    });
}

function playSong(index) {
    if (index < 0 || index >= musicState.playlist.length) return;
    musicState.currentIndex = index;
    const track = musicState.playlist[index];
    musicState.parsedLyrics = parseLRC(track.lrcContent || "");
    musicState.currentLyricIndex = -1;
    renderLyrics();
    if (track.isLocal && track.src instanceof Blob) {
        audioPlayer.src = URL.createObjectURL(track.src);
    } else if (!track.isLocal) {
        audioPlayer.src = track.src;
    } else {
        console.error(':', track);
        return;
    }
    audioPlayer.play();
    updatePlaylistUI();
    updatePlayerUI();
    updateMusicProgressBar();
}

        function togglePlayPause() { if (audioPlayer.paused) { if (musicState.currentIndex === -1 && musicState.playlist.length > 0) { playSong(0); } else if (musicState.currentIndex > -1) { audioPlayer.play(); } } else { audioPlayer.pause(); } }

        function playNext() { if (musicState.playlist.length === 0) return; let nextIndex; switch(musicState.playMode) { case 'random': nextIndex = Math.floor(Math.random() * musicState.playlist.length); break; case 'single': playSong(musicState.currentIndex); return; case 'order': default: nextIndex = (musicState.currentIndex + 1) % musicState.playlist.length; break; } playSong(nextIndex); }

        function playPrev() { if (musicState.playlist.length === 0) return; const newIndex = (musicState.currentIndex - 1 + musicState.playlist.length) % musicState.playlist.length; playSong(newIndex); }

        function changePlayMode() { const modes = ['order', 'random', 'single']; const currentModeIndex = modes.indexOf(musicState.playMode); musicState.playMode = modes[(currentModeIndex + 1) % modes.length]; document.getElementById('music-mode-btn').textContent = {'order': '', 'random': '', 'single': ''}[musicState.playMode]; }

        async function addSongFromURL() { const url = await showCustomPrompt("", "URL", "", "url"); if (!url) return; const name = await showCustomPrompt("", ""); if (!name) return; const artist = await showCustomPrompt("", ""); if (!artist) return; musicState.playlist.push({ name, artist, src: url, isLocal: false }); await saveGlobalPlaylist(); updatePlaylistUI(); if(musicState.currentIndex === -1) { musicState.currentIndex = musicState.playlist.length - 1; updatePlayerUI(); } }

async function addSongFromLocal(event) {
    const files = event.target.files;
    if (!files.length) return;

    for (const file of files) {
        let name = file.name.replace(/\.[^/.]+$/, "");
        name = await showCustomPrompt("", "", name);
        if (name === null) continue;
        
        const artist = await showCustomPrompt("", "", "");
        if (artist === null) continue;

        let lrcContent = "";
        const wantLrc = await showCustomConfirm("", `${name} (.lrc) `);
        if (wantLrc) {
            lrcContent = await new Promise(resolve => {
                const lrcInput = document.getElementById('lrc-upload-input');
                const lrcChangeHandler = (e) => {
                    const lrcFile = e.target.files[0];
                    if (lrcFile) {
                        const reader = new FileReader();
                        reader.onload = (readEvent) => resolve(readEvent.target.result);
                        reader.onerror = () => resolve("");
                        reader.readAsText(lrcFile);
                    } else {
                        resolve("");
                    }
                    lrcInput.removeEventListener('change', lrcChangeHandler);
                    lrcInput.value = '';
                };
                lrcInput.addEventListener('change', lrcChangeHandler);
                lrcInput.click();
            });
        }
        
        musicState.playlist.push({ 
            name, 
            artist, 
            src: file, 
            isLocal: true,
            lrcContent: lrcContent
        });
    }
    
    await saveGlobalPlaylist();
    updatePlaylistUI();
    if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
        musicState.currentIndex = 0;
        updatePlayerUI();
    }
    event.target.value = null;
}

        async function deleteTrack(index) { if (index < 0 || index >= musicState.playlist.length) return; const track = musicState.playlist[index]; const wasPlaying = musicState.isPlaying && musicState.currentIndex === index; if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src); musicState.playlist.splice(index, 1); await saveGlobalPlaylist(); if (musicState.playlist.length === 0) { if (musicState.isPlaying) audioPlayer.pause(); audioPlayer.src = ''; musicState.currentIndex = -1; musicState.isPlaying = false; } else { if (wasPlaying) { playNext(); } else { if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1); } } updatePlayerUI(); updatePlaylistUI(); }

        const personaLibraryModal = document.getElementById('persona-library-modal');
        const personaEditorModal = document.getElementById('persona-editor-modal');
        const presetActionsModal = document.getElementById('preset-actions-modal');

        function openPersonaLibrary() { renderPersonaLibrary(); personaLibraryModal.classList.add('visible'); }

        function closePersonaLibrary() { personaLibraryModal.classList.remove('visible'); }

        function renderPersonaLibrary() { const grid = document.getElementById('persona-library-grid'); grid.innerHTML = ''; if (state.personaPresets.length === 0) { grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;">~ ""</p>'; return; } state.personaPresets.forEach(preset => { const item = document.createElement('div'); item.className = 'persona-preset-item'; item.style.backgroundImage = `url(${preset.avatar})`; item.dataset.presetId = preset.id; item.addEventListener('click', () => applyPersonaPreset(preset.id)); addLongPressListener(item, () => showPresetActions(preset.id)); grid.appendChild(item); }); }

        function showPresetActions(presetId) { editingPersonaPresetId = presetId; presetActionsModal.classList.add('visible'); }

        function hidePresetActions() { presetActionsModal.classList.remove('visible'); editingPersonaPresetId = null; }

        function applyPersonaPreset(presetId) { const preset = state.personaPresets.find(p => p.id === presetId); if (preset) { document.getElementById('my-avatar-preview').src = preset.avatar; document.getElementById('my-persona').value = preset.persona; } closePersonaLibrary(); }

        function openPersonaEditorForCreate() { editingPersonaPresetId = null; document.getElementById('persona-editor-title').textContent = ''; document.getElementById('preset-avatar-preview').src = defaultAvatar; document.getElementById('preset-persona-input').value = ''; personaEditorModal.classList.add('visible'); }

        function openPersonaEditorForEdit() { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (!preset) return; document.getElementById('persona-editor-title').textContent = ''; document.getElementById('preset-avatar-preview').src = preset.avatar; document.getElementById('preset-persona-input').value = preset.persona; presetActionsModal.classList.remove('visible'); personaEditorModal.classList.add('visible'); }

        async function deletePersonaPreset() { const confirmed = await showCustomConfirm('', '', { confirmButtonClass: 'btn-danger' }); if (confirmed && editingPersonaPresetId) { await db.personaPresets.delete(editingPersonaPresetId); state.personaPresets = state.personaPresets.filter(p => p.id !== editingPersonaPresetId); hidePresetActions(); renderPersonaLibrary(); } }

        function closePersonaEditor() { personaEditorModal.classList.remove('visible'); editingPersonaPresetId = null; }

        async function savePersonaPreset() { const avatar = document.getElementById('preset-avatar-preview').src; const persona = document.getElementById('preset-persona-input').value.trim(); if (avatar === defaultAvatar && !persona) { alert(""); return; } if (editingPersonaPresetId) { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (preset) { preset.avatar = avatar; preset.persona = persona; await db.personaPresets.put(preset); } } else { const newPreset = { id: 'preset_' + Date.now(), avatar: avatar, persona: persona }; await db.personaPresets.add(newPreset); state.personaPresets.push(newPreset); } renderPersonaLibrary(); closePersonaEditor(); }

        const batteryAlertModal = document.getElementById('battery-alert-modal');

        function showBatteryAlert(imageUrl, text) { clearTimeout(batteryAlertTimeout); document.getElementById('battery-alert-image').src = imageUrl; document.getElementById('battery-alert-text').textContent = text; batteryAlertModal.classList.add('visible'); const closeAlert = () => { batteryAlertModal.classList.remove('visible'); batteryAlertModal.removeEventListener('click', closeAlert); }; batteryAlertModal.addEventListener('click', closeAlert); batteryAlertTimeout = setTimeout(closeAlert, 2000); }

        function updateBatteryDisplay(battery) { const batteryContainer = document.getElementById('status-bar-battery'); const batteryLevelEl = batteryContainer.querySelector('.battery-level'); const batteryTextEl = batteryContainer.querySelector('.battery-text'); const level = Math.floor(battery.level * 100); batteryLevelEl.style.width = `${level}%`; batteryTextEl.textContent = `${level}%`; if (battery.charging) { batteryContainer.classList.add('charging'); } else { batteryContainer.classList.remove('charging'); } }

        function handleBatteryChange(battery) { updateBatteryDisplay(battery); const level = battery.level; if (!battery.charging) { if (level <= 0.4 && lastKnownBatteryLevel > 0.4 && !alertFlags.hasShown40) { showBatteryAlert('https://i.postimg.cc/T2yKJ0DV/40.jpg', ''); alertFlags.hasShown40 = true; } if (level <= 0.2 && lastKnownBatteryLevel > 0.2 && !alertFlags.hasShown20) { showBatteryAlert('https://i.postimg.cc/qB9zbKs9/20.jpg', ''); alertFlags.hasShown20 = true; } if (level <= 0.1 && lastKnownBatteryLevel > 0.1 && !alertFlags.hasShown10) { showBatteryAlert('https://i.postimg.cc/ThMMVfW4/10.jpg', '30'); alertFlags.hasShown10 = true; } } if (level > 0.4) alertFlags.hasShown40 = false; if (level > 0.2) alertFlags.hasShown20 = false; if (level > 0.1) alertFlags.hasShown10 = false; lastKnownBatteryLevel = level; }

        async function initBatteryManager() { if ('getBattery' in navigator) { try { const battery = await navigator.getBattery(); lastKnownBatteryLevel = battery.level; handleBatteryChange(battery); battery.addEventListener('levelchange', () => handleBatteryChange(battery)); battery.addEventListener('chargingchange', () => { handleBatteryChange(battery); if (battery.charging) { showBatteryAlert('https://i.postimg.cc/3NDQ0dWG/image.jpg', ''); } }); } catch (err) { console.error(":", err); document.querySelector('.battery-text').textContent = ''; } } else { console.log("API"); document.querySelector('.battery-text').textContent = ''; } }

        async function renderAlbumList() {
            const albumGrid = document.getElementById('album-grid-page');
            if (!albumGrid) return;
            const albums = await db.qzoneAlbums.orderBy('createdAt').reverse().toArray();
            albumGrid.innerHTML = '';
            if (albums.length === 0) {
                albumGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">~</p>';
                return;
            }
            albums.forEach(album => {
                const albumItem = document.createElement('div');
                albumItem.className = 'album-item';
                albumItem.innerHTML = `
                    <div class="album-cover" style="background-image: url(${album.coverUrl});"></div>
                    <div class="album-info">
                        <p class="album-name">${album.name}</p>
                        <p class="album-count">${album.photoCount || 0} </p>
                    </div>
                `;
                albumItem.addEventListener('click', () => {
                    openAlbum(album.id);
                });

                //   
                addLongPressListener(albumItem, async () => {
                    const confirmed = await showCustomConfirm(
                        '',
                        `${album.name}`,
                        { confirmButtonClass: 'btn-danger' }
                    );

                    if (confirmed) {
                        // 1. 
                        await db.qzonePhotos.where('albumId').equals(album.id).delete();
                        
                        // 2. 
                        await db.qzoneAlbums.delete(album.id);
                        
                        // 3. 
                        await renderAlbumList();
                        
                        alert('');
                    }
                });
                //   

                albumGrid.appendChild(albumItem);
            });
        }

        async function openAlbum(albumId) {
            state.activeAlbumId = albumId;
            await renderAlbumPhotosScreen();
            showScreen('album-photos-screen');
        }

        async function renderAlbumPhotosScreen() {
            if (!state.activeAlbumId) return;
            const photosGrid = document.getElementById('photos-grid-page');
            const headerTitle = document.getElementById('album-photos-title');
            const album = await db.qzoneAlbums.get(state.activeAlbumId);
            if (!album) {
                console.error(":", state.activeAlbumId);
                showScreen('album-screen');
                return;
            }
            headerTitle.textContent = album.name;
            const photos = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
            photosGrid.innerHTML = '';
            if (photos.length === 0) {
                photosGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;"></p>';
            } else {
                photos.forEach(photo => {
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-item';
                    photoItem.innerHTML = `
                        <img src="${photo.url}" class="photo-thumb" alt="">
                        <button class="photo-delete-btn" data-photo-id="${photo.id}"></button>
                    `;
                    photosGrid.appendChild(photoItem);
                });
            }
        }

// ---    ---

/**
 * 
 * @param {string} clickedPhotoUrl - URL
 */
async function openPhotoViewer(clickedPhotoUrl) {
    if (!state.activeAlbumId) return;

    // 1. 
    const photosInAlbum = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
    photoViewerState.photos = photosInAlbum.map(p => p.url);

    // 2. 
    photoViewerState.currentIndex = photoViewerState.photos.findIndex(url => url === clickedPhotoUrl);
    if (photoViewerState.currentIndex === -1) return; // 

    // 3. 
    document.getElementById('photo-viewer-modal').classList.add('visible');
    renderPhotoViewer();
    photoViewerState.isOpen = true;
}

/**
 * 
 */
function renderPhotoViewer() {
    if (photoViewerState.currentIndex === -1) return;

    const imageEl = document.getElementById('photo-viewer-image');
    const prevBtn = document.getElementById('photo-viewer-prev-btn');
    const nextBtn = document.getElementById('photo-viewer-next-btn');
    
    // 
    imageEl.style.opacity = 0;

    setTimeout(() => {
        // 
        imageEl.src = photoViewerState.photos[photoViewerState.currentIndex];
        // 
        imageEl.style.opacity = 1;
    }, 100); // CSS

    // 
    prevBtn.disabled = photoViewerState.currentIndex === 0;
    // 
    nextBtn.disabled = photoViewerState.currentIndex === photoViewerState.photos.length - 1;
}

/**
 * 
 */
function showNextPhoto() {
    if (photoViewerState.currentIndex < photoViewerState.photos.length - 1) {
        photoViewerState.currentIndex++;
        renderPhotoViewer();
    }
}

/**
 * 
 */
function showPrevPhoto() {
    if (photoViewerState.currentIndex > 0) {
        photoViewerState.currentIndex--;
        renderPhotoViewer();
    }
}

/**
 * 
 */
function closePhotoViewer() {
    document.getElementById('photo-viewer-modal').classList.remove('visible');
    photoViewerState.isOpen = false;
    photoViewerState.photos = [];
    photoViewerState.currentIndex = -1;
    // 
    document.getElementById('photo-viewer-image').src = '';
}

// ---    ---
        //  JS 
        
        /**
         * 
         * @param {number} count - 
         */
        function updateUnreadIndicator(count) {
            unreadPostsCount = count;
            localStorage.setItem('unreadPostsCount', count); // 

            // ---  ---
            const navItem = document.querySelector('.nav-item[data-view="qzone-screen"]');
            
            const targetSpan = navItem.querySelector('span'); //  ""
            let indicator = navItem.querySelector('.unread-indicator');           

            if (count > 0) {
                if (!indicator) {
                    indicator = document.createElement('span');
                    indicator.className = 'unread-indicator';
                                                           targetSpan.style.position = 'relative'; //  span 
                    targetSpan.appendChild(indicator); //  span 
                    
                }
                indicator.textContent = count > 99 ? '99+' : count;
                indicator.style.display = 'block';
            } else {
                if (indicator) {
                    indicator.style.display = 'none';
                }
            }

            // ---  ---
            const backBtn = document.getElementById('back-to-list-btn');
            let backBtnIndicator = backBtn.querySelector('.unread-indicator');

            if (count > 0) {
                if (!backBtnIndicator) {
                    backBtnIndicator = document.createElement('span');
                    backBtnIndicator.className = 'unread-indicator back-btn-indicator';
                    backBtn.style.position = 'relative'; // 
                    backBtn.appendChild(backBtnIndicator);
                }
                // 
                backBtnIndicator.style.display = 'block';
            } else {
                if (backBtnIndicator) {
                    backBtnIndicator.style.display = 'none';
                }
            }
        }
        
        //   

//  JS 
function startBackgroundSimulation() {
    if (simulationIntervalId) return;
    const intervalSeconds = state.globalSettings.backgroundActivityInterval || 60;
    //  45000 
    simulationIntervalId = setInterval(runBackgroundSimulationTick, intervalSeconds * 1000); 
}

function stopBackgroundSimulation() {
    if (simulationIntervalId) {
        clearInterval(simulationIntervalId);
        simulationIntervalId = null;
    }
}
//   

/**
 * 
 */
function runBackgroundSimulationTick() {
    console.log(" Tick...");
    if (!state.globalSettings.enableBackgroundActivity) {
        stopBackgroundSimulation();
        return;
    }
    const allSingleChats = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (allSingleChats.length === 0) return;

    allSingleChats.forEach(chat => {
        // 

        // 1
        if (chat.relationship?.status === 'blocked_by_user') {
            const blockedTimestamp = chat.relationship.blockedTimestamp;
            // 
            if (!blockedTimestamp) {
                console.warn(` "${chat.name}" `);
                return; // 
            }

            const blockedDuration = Date.now() - blockedTimestamp;
            const cooldownMilliseconds = (state.globalSettings.blockCooldownHours || 1) * 60 * 60 * 1000;

            console.log(` "${chat.name}" ${Math.round(blockedDuration/1000/60)} ${cooldownMilliseconds/1000/60}`); // 

            // 
            if (blockedDuration > cooldownMilliseconds) {
                console.log(` "${chat.name}" ...`);
                
                // AI
                chat.relationship.status = 'pending_system_reflection'; // 
                
                triggerAiFriendApplication(chat.id);
            }
        }
        // 2
        else if (chat.relationship?.status === 'friend' && chat.id !== state.activeChatId) {
            // 
            if (Math.random() < 0.20) {
                console.log(` "${chat.name}" ...`);
                triggerInactiveAiAction(chat.id);
            }
        }
    });
}

async function triggerInactiveAiAction(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return;

    const now = new Date();
    const currentTime = now.toLocaleTimeString('zh-CN', { hour: 'numeric', minute: 'numeric', hour12: true });
    const userNickname = state.qzoneSettings.nickname;

    const lastUserMessage = chat.history.filter(m => m.role === 'user' && !m.isHidden).slice(-1)[0];
    const lastAiMessage = chat.history.filter(m => m.role === 'assistant' && !m.isHidden).slice(-1)[0];
    let recentContextSummary = "";
    if (lastUserMessage) {
        recentContextSummary = ` (${userNickname}) ${String(lastUserMessage.content).substring(0, 50)}...`;
    }
    if (lastAiMessage) {
        recentContextSummary += `\n${String(lastAiMessage.content).substring(0, 50)}...`;
    }

    //   
    let worldBookContent = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            return worldBook && worldBook.content ? `\n\n## : ${worldBook.name}\n${worldBook.content}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
            worldBookContent = `\n\n#  ()\n${linkedContents}\n`;
        }
    }
    //   

    const systemPrompt = `
# 
"${chat.name}"${userNickname}

#  ():
1.  ****: 
2.  ****: 
3.  ****: 
4.  ****: 

#  (JSON):
-   **+**: \`[{"type": "update_status", "status_text": "", "is_busy": true}, {"type": "text", "content": "..."}]\`
-   ****: \`[{"type": "qzone_post", "postType": "shuoshuo", "content": "..."}]\`
- ****: \`{"type": "qzone_post", "postType": "text_image", "publicText": "()", "hiddenContent": "..."}\`
-   ****: \`[{"type": "qzone_comment", "postId": 123, "commentText": ""}]\`
-   ****: \`[{"type": "qzone_like", "postId": 456}]\`
-   ****: \`[{"type": "video_call_request"}]\`

# 
-   ****: ${chat.settings.aiPersona}
${worldBookContent} // <--
-   ****: ${currentTime}
-   ****: ${recentContextSummary}
-   ****:  **[]**  **[]**********`;

    //  messagesPayload
    const messagesPayload = [];
    messagesPayload.push({ role: 'system', content: systemPrompt });

try {
    const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(3).toArray();
    // 
    const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);
    
    const aiName = chat.name;
    
    let dynamicContext = ""; 
    if (visiblePosts.length > 0) {
        let postsContext = "\n\n#  ():\n";
        for (const post of visiblePosts) {
                let authorName = post.authorId === 'user' ? userNickname : (state.chats[post.authorId]?.name || '');
                let interactionStatus = '';
                if (post.likes && post.likes.includes(aiName)) interactionStatus += " []";
                if (post.comments && post.comments.some(c => c.commenterName === aiName)) interactionStatus += " []";
                
                postsContext += `- (ID: ${post.id}) : ${authorName}, : "${(post.publicText || post.content || "").substring(0, 30)}..."${interactionStatus}\n`;
            }
            dynamicContext = postsContext;
        }

        //  user 
        messagesPayload.push({
            role: 'user',
            content: `[ system prompt ]\n${dynamicContext}`
        });
        
        console.log("APIPayload:", JSON.stringify(messagesPayload, null, 2)); // 

            // 
            let isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload, isGemini);

            const response = isGemini 
                ? await fetch(geminiConfig.url, geminiConfig.data) 
                : await fetch(`${proxyUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                    body: JSON.stringify({
                        model: model,
                        messages: messagesPayload,
                        temperature: 0.9,
                    })
                });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API: ${response.status} - ${JSON.stringify(errorData)}`);
            }

            const data = await response.json();

            //  (?.) 
            const aiResponseContent = isGemini
                ? data?.candidates?.[0]?.content?.parts?.[0]?.text
                : data?.choices?.[0]?.message?.content;

            // 
            if (!aiResponseContent) {
                console.warn(`API "${chat.name}" :`, data);
                return;
            }

            // 
            const responseArray = parseAiResponse(aiResponseContent);

        
        // AI...
        for (const action of responseArray) {
            if (!action) continue;

            if (action.type === 'update_status' && action.status_text) {
                chat.status.text = action.status_text;
                chat.status.isBusy = action.is_busy || false;
                chat.status.lastUpdate = Date.now();
                await db.chats.put(chat);
                renderChatList();
            }
            if (action.type === 'text' && action.content) {
                const aiMessage = { role: 'assistant', content: String(action.content), timestamp: Date.now() };

chat.unreadCount = (chat.unreadCount || 0) + 1;
                chat.history.push(aiMessage);
                await db.chats.put(chat);
                showNotification(chatId, aiMessage.content);
                renderChatList();
                console.log(`:  "${chat.name}" : ${aiMessage.content}`);
            }
if (action.type === 'qzone_post') {
    const newPost = { 
        type: action.postType, 
        content: action.content || '', 
        publicText: action.publicText || '', 
        hiddenContent: action.hiddenContent || '', 
        timestamp: Date.now(), 
        authorId: chatId, 
        authorGroupId: chat.groupId, // ID
        visibleGroupIds: null 
    };
    await db.qzonePosts.add(newPost);
                updateUnreadIndicator(unreadPostsCount + 1);
                console.log(`:  "${chat.name}" `);
            } else if (action.type === 'qzone_comment') {
                const post = await db.qzonePosts.get(parseInt(action.postId));
                if (post) {
                    if (!post.comments) post.comments = [];
                    post.comments.push({ commenterName: chat.name, text: action.commentText, timestamp: Date.now() });
                    await db.qzonePosts.update(post.id, { comments: post.comments });
                    updateUnreadIndicator(unreadPostsCount + 1);
                    console.log(`:  "${chat.name}"  #${post.id}`);
                }
            } else if (action.type === 'qzone_like') {
                const post = await db.qzonePosts.get(parseInt(action.postId));
                if (post) {
                    if (!post.likes) post.likes = [];
                    if (!post.likes.includes(chat.name)) {
                        post.likes.push(chat.name);
                        await db.qzonePosts.update(post.id, { likes: post.likes });
                        updateUnreadIndicator(unreadPostsCount + 1);
                        console.log(`:  "${chat.name}"  #${post.id}`);
                    }
                }
            } else if (action.type === 'video_call_request') {
                if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                    videoCallState.isAwaitingResponse = true; 
                    state.activeChatId = chatId;
                    showIncomingCallModal();
                    console.log(`:  "${chat.name}" `);
                }
            }
        }
    } catch (error) {
        console.error(` "${chat.name}" :`, error);
    }
}

//   applyScopedCss  

/**
 * CSS
 * @param {string} cssString CSS
 * @param {string} scopeId ID ( '#chat-messages'  '#settings-preview-area')
 * @param {string} styleTagId  <style> ID
 */
function applyScopedCss(cssString, scopeId, styleTagId) {
    const styleTag = document.getElementById(styleTagId);
    if (!styleTag) return;
    
    if (!cssString || cssString.trim() === '') {
        styleTag.innerHTML = '';
        return;
    }
    
    //  - .user.ai
    const scopedCss = cssString
        .replace(/\s*\.message-bubble\.user\s+([^{]+\{)/g, `${scopeId} .message-bubble.user $1`)
        .replace(/\s*\.message-bubble\.ai\s+([^{]+\{)/g, `${scopeId} .message-bubble.ai $1`)
        .replace(/\s*\.message-bubble\s+([^{]+\{)/g, `${scopeId} .message-bubble $1`);
    
    styleTag.innerHTML = scopedCss;
}

//   updateSettingsPreview  

function updateSettingsPreview() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const previewArea = document.getElementById('settings-preview-area');
    if (!previewArea) return;

    // 1. 
    const selectedTheme = document.querySelector('input[name="theme-select"]:checked')?.value || 'default';
    const fontSize = document.getElementById('font-size-slider').value;
    const customCss = document.getElementById('custom-css-input').value;
    const background = chat.settings.background; // 

    // 2. 
    previewArea.dataset.theme = selectedTheme;
    previewArea.style.setProperty('--chat-font-size', `${fontSize}px`);
    
    // ---  ---
    if (background && background.startsWith('data:image')) {
        previewArea.style.backgroundImage = `url(${background})`;
        previewArea.style.backgroundColor = 'transparent'; // 
    } else {
        previewArea.style.backgroundImage = 'none'; // 
        // 
        previewArea.style.background = background || '#f0f2f5';
    }

    // 3. 
    previewArea.innerHTML = ''; 

    // 
    //  timestamp CSS
    const aiMsg = { role: 'ai', content: '', timestamp: 1, senderName: chat.name };
    const aiBubble = createMessageElement(aiMsg, chat);
    if(aiBubble) previewArea.appendChild(aiBubble);

    // 
    const userMsg = { role: 'user', content: '', timestamp: 2 };
    const userBubble = createMessageElement(userMsg, chat);
    if(userBubble) previewArea.appendChild(userBubble);
    
    // 4. CSS
    applyScopedCss(customCss, '#settings-preview-area', 'preview-bubble-style');
}

//   

//  JS 

async function openGroupManager() {
    await renderGroupList();
    document.getElementById('group-management-modal').classList.add('visible');
}

async function renderGroupList() {
    const listEl = document.getElementById('existing-groups-list');
    const groups = await db.qzoneGroups.toArray();
    listEl.innerHTML = '';
    if (groups.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);"></p>';
    }
    groups.forEach(group => {
        const item = document.createElement('div');
        item.className = 'existing-group-item';
        item.innerHTML = `
            <span class="group-name">${group.name}</span>
            <span class="delete-group-btn" data-id="${group.id}"></span>
        `;
        listEl.appendChild(item);
    });
}

//   addNewGroup  
async function addNewGroup() {
    const input = document.getElementById('new-group-name-input');
    const name = input.value.trim();
    if (!name) {
        alert('');
        return;
    }

    // 
    const existingGroup = await db.qzoneGroups.where('name').equals(name).first();
    if (existingGroup) {
        alert(` "${name}" `);
        return;
    }
    // 

    await db.qzoneGroups.add({ name });
    input.value = '';
    await renderGroupList();
}
//   

async function deleteGroup(groupId) {
    const confirmed = await showCustomConfirm('', '', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.qzoneGroups.delete(groupId);
        //  groupId  null
        const chatsToUpdate = await db.chats.where('groupId').equals(groupId).toArray();
        for (const chat of chatsToUpdate) {
            chat.groupId = null;
            await db.chats.put(chat);
            if(state.chats[chat.id]) state.chats[chat.id].groupId = null;
        }
        await renderGroupList();
    }
}

//   

//  JS 

/**
 * 
 * @param {number} timestamp - 
 */
function showMessageActions(timestamp) {
    // 
    if (isSelectionMode) return;
    
    activeMessageTimestamp = timestamp;
    document.getElementById('message-actions-modal').classList.add('visible');
}

/**
 * 
 */
function hideMessageActions() {
    document.getElementById('message-actions-modal').classList.remove('visible');
    activeMessageTimestamp = null;
}

//   openMessageEditor  
async function openMessageEditor() {
    if (!activeMessageTimestamp) return;

    const timestampToEdit = activeMessageTimestamp;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestampToEdit);
    if (!message) return;

    hideMessageActions(); 

    let contentForEditing;
    //  share_link 
    const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer', 'share_link'].includes(message.type);

    if (isSpecialType) {
        let fullMessageObject = { type: message.type };
        if (message.type === 'voice_message') fullMessageObject.content = message.content;
        else if (message.type === 'ai_image') fullMessageObject.description = message.content; 
        else if (message.type === 'transfer') {
            fullMessageObject.amount = message.amount;
            fullMessageObject.note = message.note;
        } 
        // 
        else if (message.type === 'share_link') {
            fullMessageObject.title = message.title;
            fullMessageObject.description = message.description;
            fullMessageObject.source_name = message.source_name;
            fullMessageObject.content = message.content;
        }
        contentForEditing = JSON.stringify(fullMessageObject, null, 2);
    } else if (typeof message.content === 'object') {
        contentForEditing = JSON.stringify(message.content, null, 2);
    } else {
        contentForEditing = message.content;
    }

    // 1 'link' 
    const templates = {
        voice: { type: 'voice_message', content: '' },
        image: { type: 'ai_image', description: '' },
        transfer: { type: 'transfer', amount: 5.20, note: '' },
        link: { type: 'share_link', title: '', description: '...', source_name: '', content: '...' }
    };

    // 2
    const helpersHtml = `
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'></button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'></button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'></button>
            <button class="format-btn" data-template='${JSON.stringify(templates.link)}'></button>
        </div>
    `;

    const newContent = await showCustomPrompt(
        '', 
        '...',
        contentForEditing, 
        'textarea',
        helpersHtml
    );

    if (newContent !== null) {
        //  saveEditedMessage saveAdvancedEditor
        await saveEditedMessage(timestampToEdit, newContent, true);
    }
}
//   

/**
 * 
 */
async function copyMessageContent() {
    if (!activeMessageTimestamp) return;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
    if (!message) return;

    let textToCopy;
    if (typeof message.content === 'object') {
        textToCopy = JSON.stringify(message.content);
    } else {
        textToCopy = String(message.content);
    }

    try {
        await navigator.clipboard.writeText(textToCopy);
        await showCustomAlert('', '');
    } catch (err) {
        await showCustomAlert('', '');
    }
    
    hideMessageActions();
}

// 
document.getElementById('regenerate-message-btn').addEventListener('click', async function() {
    document.getElementById('message-actions-modal').classList.remove('visible');
    if (!activeMessageTimestamp) return;

    const chatId = state.activeChatId;
    const chat = state.chats[chatId];
    if (!chat) return;

    // AI
    const msgIndex = chat.history.findIndex(m => m.timestamp === activeMessageTimestamp);
    if (msgIndex === -1 || chat.history[msgIndex].role !== 'assistant') return;

    // AI
    let startIndex = msgIndex;
    let endIndex = msgIndex;

    // AI
    while (startIndex > 0) {
        const prevMsg = chat.history[startIndex - 1];
        if (prevMsg.role === 'user') break; // 
        if (prevMsg.role === 'assistant') startIndex--;
        else break; // 
    }

    // AI
    while (endIndex < chat.history.length - 1) {
        const nextMsg = chat.history[endIndex + 1];
        if (nextMsg.role === 'user') break; // 
        if (nextMsg.role === 'assistant') endIndex++;
        else break; // 
    }

    // AIstartIndexendIndex
    const deleteCount = endIndex - startIndex + 1;
    chat.history.splice(startIndex, deleteCount);

    // 
    await db.chats.put(chat);
    renderChatInterface(chatId);
    
    // 
    setTimeout(triggerAiResponse, 500);
});

// showMessageActionsAI
function showMessageActions(timestamp) {
    activeMessageTimestamp = timestamp;
    document.getElementById('message-actions-modal').classList.add('visible');
    
    const chat = state.chats[state.activeChatId];
    const msg = chat.history.find(m => m.timestamp === timestamp);
    document.getElementById('regenerate-message-btn').style.display = 
        msg?.role === 'assistant' ? 'block' : 'none';
}
//   createMessageEditorBlock  
/**
 * 
 * @param {string} initialContent - 
 * @returns {HTMLElement} - DOM
 */
function createMessageEditorBlock(initialContent = '') {
    const block = document.createElement('div');
    block.className = 'message-editor-block';

    // 1 'link' 
    const templates = {
        voice: { type: 'voice_message', content: '' },
        image: { type: 'ai_image', description: '' },
        transfer: { type: 'transfer', amount: 5.20, note: '' },
        link: { type: 'share_link', title: '', description: '...', source_name: '', content: '...' }
    };

    block.innerHTML = `
        <button class="delete-block-btn" title=""></button>
        <textarea>${initialContent}</textarea>
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'></button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'></button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'></button>
            <!-- 2 -->
            <button class="format-btn" data-template='${JSON.stringify(templates.link)}'></button>
        </div>
    `;

    // 
    block.querySelector('.delete-block-btn').addEventListener('click', () => {
        // 
        if (document.querySelectorAll('.message-editor-block').length > 1) {
            block.remove();
        } else {
            alert('');
        }
    });

    // 
    block.querySelectorAll('.format-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const templateStr = btn.dataset.template;
            const textarea = block.querySelector('textarea');
            if (templateStr && textarea) {
                try {
                    const templateObj = JSON.parse(templateStr);
                    textarea.value = JSON.stringify(templateObj, null, 2);
                    textarea.focus();
                } catch(e) { console.error(":", e); }
            }
        });
    });

    return block;
}
//   

//   openAdvancedMessageEditor 
/**
 * 
 */
function openAdvancedMessageEditor() {
    if (!activeMessageTimestamp) return;

    // 1. 
    const timestampToEdit = activeMessageTimestamp;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestampToEdit);
    if (!message) return;

    // 2. 
    hideMessageActions(); 

    const editorModal = document.getElementById('message-editor-modal');
    const editorContainer = document.getElementById('message-editor-container');
    editorContainer.innerHTML = ''; 

    // 3. 
    let initialContent;
    const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer'].includes(message.type);
    if (isSpecialType) {
        let fullMessageObject = { type: message.type };
        if (message.type === 'voice_message') fullMessageObject.content = message.content;
        else if (message.type === 'ai_image') fullMessageObject.description = message.content;
        else if (message.type === 'transfer') {
            fullMessageObject.amount = message.amount;
            fullMessageObject.note = message.note;
        }
        initialContent = JSON.stringify(fullMessageObject, null, 2);
    } else if (typeof message.content === 'object') {
        initialContent = JSON.stringify(message.content, null, 2);
    } else {
        initialContent = message.content;
    }

    const firstBlock = createMessageEditorBlock(initialContent);
    editorContainer.appendChild(firstBlock);

    // 4. 
    // 
    const addBtn = document.getElementById('add-message-editor-block-btn');
    const newAddBtn = addBtn.cloneNode(true);
    addBtn.parentNode.replaceChild(newAddBtn, addBtn);
    newAddBtn.addEventListener('click', () => {
        const newBlock = createMessageEditorBlock();
        editorContainer.appendChild(newBlock);
        newBlock.querySelector('textarea').focus();
    });

    const cancelBtn = document.getElementById('cancel-advanced-editor-btn');
    const newCancelBtn = cancelBtn.cloneNode(true);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    newCancelBtn.addEventListener('click', () => {
        editorModal.classList.remove('visible');
    });

    const saveBtn = document.getElementById('save-advanced-editor-btn');
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    // 
    newSaveBtn.addEventListener('click', () => {
        saveEditedMessage(timestampToEdit); 
    });

    // 5. 
    editorModal.classList.add('visible');
}
//   

/**
 * 
 * @param {string} text - 
 * @returns {object} -  type, content, 
 */
function parseEditedContent(text) {
    const trimmedText = text.trim();

    // 1. JSON
    if (trimmedText.startsWith('{') && trimmedText.endsWith('}')) {
        try {
            const parsed = JSON.parse(trimmedText);
            //  type 
            if (parsed.type) {
                return parsed;
            }
        } catch (e) { /*  */ }
    }
    
    // 2. 
    if (STICKER_REGEX.test(trimmedText)) {
        // `meaning`URL
        return { type: 'sticker', content: trimmedText };
    }

    // 3. 
    return { type: 'text', content: trimmedText };
}


//   saveEditedMessage  

async function saveEditedMessage(timestamp, simpleContent = null) {
    if (!timestamp) return;

    const chat = state.chats[state.activeChatId];
    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    let newMessages = [];

    // 
    if (simpleContent !== null) {
        // ---  ---
        const rawContent = simpleContent.trim();
        if (rawContent) {
            const parsedResult = parseEditedContent(rawContent);
            const newMessage = {
                role: chat.history[messageIndex].role,
                senderName: chat.history[messageIndex].senderName,
                // 
                content: parsedResult.content || '',
            };
            if (parsedResult.type && parsedResult.type !== 'text') newMessage.type = parsedResult.type;
            if (parsedResult.meaning) newMessage.meaning = parsedResult.meaning;
            if (parsedResult.amount) newMessage.amount = parsedResult.amount;
            if (parsedResult.note) newMessage.note = parsedResult.note;
            if (parsedResult.title) newMessage.title = parsedResult.title;
            if (parsedResult.description) newMessage.description = parsedResult.description;
            if (parsedResult.source_name) newMessage.source_name = parsedResult.source_name;
            if (parsedResult.description && parsedResult.type === 'ai_image') {
                 newMessage.content = parsedResult.description;
            }

            newMessages.push(newMessage);
        }
    } else {
        // ---  ---
        const editorContainer = document.getElementById('message-editor-container');
        const editorBlocks = editorContainer.querySelectorAll('.message-editor-block');

        for (const block of editorBlocks) {
            const textarea = block.querySelector('textarea');
            const rawContent = textarea.value.trim();
            if (!rawContent) continue;

            const parsedResult = parseEditedContent(rawContent);
            const newMessage = {
                role: chat.history[messageIndex].role,
                senderName: chat.history[messageIndex].senderName,
                // 
                content: parsedResult.content || '',
            };
            
            if (parsedResult.type && parsedResult.type !== 'text') newMessage.type = parsedResult.type;
            if (parsedResult.meaning) newMessage.meaning = parsedResult.meaning;
            if (parsedResult.amount) newMessage.amount = parsedResult.amount;
            if (parsedResult.note) newMessage.note = parsedResult.note;
            if (parsedResult.title) newMessage.title = parsedResult.title;
            if (parsedResult.description) newMessage.description = parsedResult.description;
            if (parsedResult.source_name) newMessage.source_name = parsedResult.source_name;
            if (parsedResult.description && parsedResult.type === 'ai_image') {
                 newMessage.content = parsedResult.description;
            }

            newMessages.push(newMessage);
        }
    }
    
    if (newMessages.length === 0) {
        document.getElementById('message-editor-modal').classList.remove('visible');
        return; // 
    }

    // 

    // 1.  splice 
    chat.history.splice(messageIndex, 1, ...newMessages);

    // 2. 
    // 
    let reassignTimestamp = timestamp;

    // 3. 
    for (let i = messageIndex; i < chat.history.length; i++) {
        // 4. 
        chat.history[i].timestamp = reassignTimestamp;

        // 5. +1
        reassignTimestamp++; 
    }
    // 

    await db.chats.put(chat);

    // UI
    document.getElementById('message-editor-modal').classList.remove('visible');
    renderChatInterface(state.activeChatId);
    await showCustomAlert('', '');
}

//   

//  JS 

/**
 * 
 * @param {number} postId - ID
 */
function showPostActions(postId) {
    activePostId = postId;
    document.getElementById('post-actions-modal').classList.add('visible');
}

/**
 * 
 */
function hidePostActions() {
    document.getElementById('post-actions-modal').classList.remove('visible');
    activePostId = null;
}

/**
 * 
 */
async function openPostEditor() {
    if (!activePostId) return;

    const postIdToEdit = activePostId;
    const post = await db.qzonePosts.get(postIdToEdit);
    if (!post) return;

    hidePostActions();

    // 
    let contentForEditing;
    if (post.type === 'shuoshuo') {
        contentForEditing = post.content;
    } else {
        // 
        const postObject = {
            type: post.type,
            publicText: post.publicText || '',
        };
        if (post.type === 'image_post') {
            postObject.imageUrl = post.imageUrl;
            postObject.imageDescription = post.imageDescription;
        } else if (post.type === 'text_image') {
            postObject.hiddenContent = post.hiddenContent;
        }
        contentForEditing = JSON.stringify(postObject, null, 2);
    }
    
    // 
    const templates = {
        shuoshuo: "...", // 
        image: { type: 'image_post', publicText: '', imageUrl: 'https://...', imageDescription: '' },
        text_image: { type: 'text_image', publicText: '', hiddenContent: '' }
    };
    
    const helpersHtml = `
        <div class="format-helpers">
            <button class="format-btn" data-type="text"></button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'></button>
            <button class="format-btn" data-template='${JSON.stringify(templates.text_image)}'></button>
        </div>
    `;

    const newContent = await showCustomPrompt(
        '',
        '...',
        contentForEditing,
        'textarea',
        helpersHtml
    );
    
    // 
    // 
    setTimeout(() => {
        const shuoshuoBtn = document.querySelector('#custom-modal-body .format-btn[data-type="text"]');
        if(shuoshuoBtn) {
            shuoshuoBtn.addEventListener('click', () => {
                const input = document.getElementById('custom-prompt-input');
                input.value = templates.shuoshuo;
                input.focus();
            });
        }
    }, 100);

    if (newContent !== null) {
        await saveEditedPost(postIdToEdit, newContent);
    }
}

/**
 * 
 * @param {number} postId - ID
 * @param {string} newRawContent - 
 */
async function saveEditedPost(postId, newRawContent) {
    const post = await db.qzonePosts.get(postId);
    if (!post) return;

    const trimmedContent = newRawContent.trim();
    
    // JSON
    try {
        const parsed = JSON.parse(trimmedContent);
        // 
        post.type = parsed.type || 'image_post';
        post.publicText = parsed.publicText || '';
        post.imageUrl = parsed.imageUrl || '';
        post.imageDescription = parsed.imageDescription || '';
        post.hiddenContent = parsed.hiddenContent || '';
        post.content = ''; // 
    } catch (e) {
        // 
        post.type = 'shuoshuo';
        post.content = trimmedContent;
        // 
        post.publicText = '';
        post.imageUrl = '';
        post.imageDescription = '';
        post.hiddenContent = '';
    }
    
    await db.qzonePosts.put(post);
    await renderQzonePosts(); // 
    await showCustomAlert('', '');
}

/**
 * 
 */
async function copyPostContent() {
    if (!activePostId) return;
    const post = await db.qzonePosts.get(activePostId);
    if (!post) return;
    
    let textToCopy = post.content || post.publicText || post.hiddenContent || post.imageDescription || "";
    
    try {
        await navigator.clipboard.writeText(textToCopy);
        await showCustomAlert('', '');
    } catch (err) {
        await showCustomAlert('', '');
    }
    
    hidePostActions();
}

//   
let selectedContacts = new Set();

async function openContactPickerForGroupCreate() {
    selectedContacts.clear(); // 

    // 
    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    // 
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    // 
    newConfirmBtn.addEventListener('click', handleCreateGroup);

    await renderContactPicker();
    showScreen('contact-picker-screen');
}
//   

/**
 * 
 */
async function renderContactPicker() {
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';

    // 
    const contacts = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (contacts.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">~</p>';
        return;
    }

    contacts.forEach(contact => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item';
        item.dataset.contactId = contact.id;
        item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${contact.name}</span>
        `;
        listEl.appendChild(item);
    });

    updateContactPickerConfirmButton();
}

/**
 * 
 */
function updateContactPickerConfirmButton() {
    const btn = document.getElementById('confirm-contact-picker-btn');
    btn.textContent = `(${selectedContacts.size})`;
    btn.disabled = selectedContacts.size < 2; // 2
}

/**
 * 
 */
async function handleCreateGroup() {
    if (selectedContacts.size < 2) {
        alert("2");
        return;
    }

    const groupName = await showCustomPrompt('', '', '');
    if (!groupName || !groupName.trim()) return;

    const newChatId = 'group_' + Date.now();
    const members = [];
    
    // ID
    for (const contactId of selectedContacts) {
        const contactChat = state.chats[contactId];
        if (contactChat) {
            // 
            // 
            members.push({
                id: contactId, 
                originalName: contactChat.name,   // AI
                groupNickname: contactChat.name, // 
                avatar: contactChat.settings.aiAvatar || defaultAvatar,
                persona: contactChat.settings.aiPersona,
                avatarFrame: contactChat.settings.aiAvatarFrame || ''
            });
        }
    }

    const newGroupChat = {
        id: newChatId,
        name: groupName.trim(),
        isGroup: true,
        members: members,
        settings: {
            myPersona: '',
            myNickname: '',
            maxMemory: 10,
            groupAvatar: defaultGroupAvatar,
            myAvatar: defaultMyGroupAvatar,
            background: '',
            theme: 'default',
            fontSize: 13,
            customCss: '',
            linkedWorldBookIds: [],
        },
        history: [],
        musicData: { totalTime: 0 }
    };

    state.chats[newChatId] = newGroupChat;
    await db.chats.put(newGroupChat);
    
    await renderChatList();
    showScreen('chat-list-screen');
    openChat(newChatId); 
}

//   

/**
 * 
 */
function openMemberManagementScreen() {
    if (!state.activeChatId || !state.chats[state.activeChatId].isGroup) return;
    renderMemberManagementList();
    showScreen('member-management-screen');
}

function renderMemberManagementList() {
    const listEl = document.getElementById('member-management-list');
    const chat = state.chats[state.activeChatId];
    listEl.innerHTML = '';

    chat.members.forEach(member => {
        const item = document.createElement('div');
        item.className = 'member-management-item';
        //  member.name  member.groupNickname
        item.innerHTML = `
            <img src="${member.avatar}" class="avatar">
            <span class="name">${member.groupNickname}</span>
            <button class="remove-member-btn" data-member-id="${member.id}" title="">-</button>
        `;
        listEl.appendChild(item);
    });
}

/**
 * 
 * @param {string} memberId - ID
 */
async function removeMemberFromGroup(memberId) {
    const chat = state.chats[state.activeChatId];
    const memberIndex = chat.members.findIndex(m => m.id === memberId);
    
    if (memberIndex === -1) return;
    
    // 2
    if (chat.members.length <= 2) {
        alert("2");
        return;
    }
    
const memberName = chat.members[memberIndex].groupNickname; // <--  groupNickname
    const confirmed = await showCustomConfirm(
        '',
        `${memberName}`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        chat.members.splice(memberIndex, 1);
        await db.chats.put(chat);
        renderMemberManagementList(); // 
        document.getElementById('chat-settings-btn').click(); // 
    }
}

/**
 * 
 */
async function openContactPickerForAddMember() {
    selectedContacts.clear(); // 
    
    const chat = state.chats[state.activeChatId];
    const existingMemberIds = new Set(chat.members.map(m => m.id));

    // 
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';
    const contacts = Object.values(state.chats).filter(c => !c.isGroup && !existingMemberIds.has(c.id));

    if (contacts.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;"></p>';
        document.getElementById('confirm-contact-picker-btn').style.display = 'none'; // 
    } else {
        document.getElementById('confirm-contact-picker-btn').style.display = 'block';
        contacts.forEach(contact => {
            const item = document.createElement('div');
            item.className = 'contact-picker-item';
            item.dataset.contactId = contact.id;
            item.innerHTML = `
                <div class="checkbox"></div>
                <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
                <span class="name">${contact.name}</span>
            `;
            listEl.appendChild(item);
        });
    }

    // 
    updateContactPickerConfirmButton();
    showScreen('contact-picker-screen');
}

/**
 * 
 */
async function handleAddMembersToGroup() {
    if (selectedContacts.size === 0) {
        alert("");
        return;
    }
    
    const chat = state.chats[state.activeChatId];

    for (const contactId of selectedContacts) {
        const contactChat = state.chats[contactId];
        if (contactChat) {
chat.members.push({
    id: contactId,
    originalName: contactChat.name,  // <-- 1 'originalName' 
    groupNickname: contactChat.name, // <-- 2 'groupNickname'
    avatar: contactChat.settings.aiAvatar || defaultAvatar,
    persona: contactChat.settings.aiPersona,
    avatarFrame: contactChat.settings.aiAvatarFrame || ''
});
        }
    }

    await db.chats.put(chat);
    openMemberManagementScreen(); // 
    renderGroupMemberSettings(chat.members); // 
}

/**
 * 
 */
async function createNewMemberInGroup() {
    const name = await showCustomPrompt('', ' (TA)');
    if (!name || !name.trim()) return;

    // 
    const chat = state.chats[state.activeChatId];
    if (chat.members.some(m => m.originalName === name.trim())) {
        alert(`${name.trim()}`);
        return;
    }

    const persona = await showCustomPrompt('', `${name}`, '', 'textarea');
    if (persona === null) return; 

    // 
    // NPC
    const newMember = {
        id: 'npc_' + Date.now(),
        originalName: name.trim(),   // 
        groupNickname: name.trim(), // 
        avatar: defaultGroupMemberAvatar,
        persona: persona,
        avatarFrame: ''
    };

    chat.members.push(newMember);
    await db.chats.put(chat);

    renderMemberManagementList();
    renderGroupMemberSettings(chat.members); 

    alert(`${name}`);
}

//   
function startWaimaiCountdown(element, endTime) {
    const timerId = setInterval(() => {
        const now = Date.now();
        const distance = endTime - now;

        if (distance < 0) {
            clearInterval(timerId);
            element.innerHTML = '<span></span><span></span><span></span>';
            return;
        }

        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        
        const minStr = String(minutes).padStart(2, '0');
        const secStr = String(seconds).padStart(2, '0');

        element.innerHTML = `<span>${minStr.charAt(0)}</span><span>${minStr.charAt(1)}</span> : <span>${secStr.charAt(0)}</span><span>${secStr.charAt(1)}</span>`;
    }, 1000);
    return timerId;
}

function cleanupWaimaiTimers() {
    for (const timestamp in waimaiTimers) {
        clearInterval(waimaiTimers[timestamp]);
    }
    waimaiTimers = {};
}
//   

async function handleWaimaiResponse(originalTimestamp, choice) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
    if (messageIndex === -1) return;

    // 1. 
    const originalMessage = chat.history[messageIndex];
    originalMessage.status = choice;
    
    // AI
    let systemContent;
    const myNickname = chat.isGroup ? (chat.settings.myNickname || '') : '';
    
    if (choice === 'paid') {
        originalMessage.paidBy = myNickname; // 
        systemContent = `[ (${myNickname})  ${originalMessage.senderName} : ${originalTimestamp}]`;
    } else {
        systemContent = `[ (${myNickname})  ${originalMessage.senderName} : ${originalTimestamp}]`;
    }

    // 2. AI
    const systemNote = {
        role: 'system',
        content: systemContent,
        timestamp: Date.now(),
        isHidden: true
    };
    chat.history.push(systemNote);

    // 3. UI
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);  
}

let videoCallState = {
    isActive: false,       
    isAwaitingResponse: false, 
    isGroupCall: false,      
    activeChatId: null,    
    initiator: null,       
    startTime: null,       
    participants: [],      
    isUserParticipating: true,
    // --- ---
    callHistory: [], // 
    preCallContext: "" // 
};

let callTimerInterval = null; // ID

/**
 * 
 */
async function handleInitiateCall() {
    if (!state.activeChatId || videoCallState.isActive || videoCallState.isAwaitingResponse) return;

    const chat = state.chats[state.activeChatId];
    videoCallState.isGroupCall = chat.isGroup;
    videoCallState.isAwaitingResponse = true;
    videoCallState.initiator = 'user';
    videoCallState.activeChatId = chat.id;
    videoCallState.isUserParticipating = true; // 

    // 
    if (chat.isGroup) {
        document.getElementById('outgoing-call-avatar').src = chat.settings.myAvatar || defaultMyGroupAvatar;
        document.getElementById('outgoing-call-name').textContent = chat.settings.myNickname || '';
    } else {
        document.getElementById('outgoing-call-avatar').src = chat.settings.aiAvatar || defaultAvatar;
        document.getElementById('outgoing-call-name').textContent = chat.name;
    }
    document.querySelector('#outgoing-call-screen .caller-text').textContent = chat.isGroup ? "..." : "...";
    showScreen('outgoing-call-screen');
    
    // AI
    const requestMessage = {
        role: 'system',
        content: chat.isGroup 
            ? `[ (${chat.settings.myNickname || ''})  "group_call_response"  "decision"  "join"  "decline" ]`
            : `[ "video_call_response"  "decision"  "accept"  "reject" ]`,
        timestamp: Date.now(),
        isHidden: true,
    };
    chat.history.push(requestMessage);
    await db.chats.put(chat);
    
    // AI
    await triggerAiResponse();
}


function startVideoCall() {
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;

    videoCallState.isActive = true;
    videoCallState.isAwaitingResponse = false;
    videoCallState.startTime = Date.now();
    videoCallState.callHistory = []; // 

    // --- ---
    const preCallHistory = chat.history.slice(-10); // 10
    videoCallState.preCallContext = preCallHistory.map(msg => {
        const sender = msg.role === 'user' ? (chat.settings.myNickname || '') : (msg.senderName || chat.name);
        return `${sender}: ${String(msg.content).substring(0, 50)}...`;
    }).join('\n');
    // ---  ---

    updateParticipantAvatars(); 
    
    document.getElementById('video-call-main').innerHTML = `<em>${videoCallState.isGroupCall ? '...' : '...'}</em>`;
    showScreen('video-call-screen');

    document.getElementById('user-speak-btn').style.display = videoCallState.isUserParticipating ? 'block' : 'none';
    document.getElementById('join-call-btn').style.display = videoCallState.isUserParticipating ? 'none' : 'block';

    if (callTimerInterval) clearInterval(callTimerInterval);
    callTimerInterval = setInterval(updateCallTimer, 1000);
    updateCallTimer();

    triggerAiInCallAction();
}

/**
 * 
 */
//   endVideoCall  
async function endVideoCall() {
    if (!videoCallState.isActive) return;

    const duration = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const durationText = `${Math.floor(duration / 60)}${duration % 60}`;
    const endCallText = ` ${durationText}`;

    const chat = state.chats[videoCallState.activeChatId];
    if (chat) {
        // 1.  ()
        const participantsData = [];
        if (videoCallState.isGroupCall) {
            videoCallState.participants.forEach(p => participantsData.push({ name: p.originalName, avatar: p.avatar }));
            if (videoCallState.isUserParticipating) {
                participantsData.unshift({ name: chat.settings.myNickname || '', avatar: chat.settings.myAvatar || defaultMyGroupAvatar });
            }
        } else {
            participantsData.push({ name: chat.name, avatar: chat.settings.aiAvatar || defaultAvatar });
            participantsData.unshift({ name: '', avatar: chat.settings.myAvatar || defaultAvatar });
        }
        
        const callRecord = {
            chatId: videoCallState.activeChatId,
            timestamp: Date.now(),
            duration: duration,
            participants: participantsData,
            transcript: [...videoCallState.callHistory]
        };
        await db.callRecords.add(callRecord);
        console.log(":", callRecord);
        
        // 2. 
let summaryMessage = {
    // 1role  videoCallState.initiator 
    role: videoCallState.initiator === 'user' ? 'user' : 'assistant',
    content: endCallText,
    timestamp: Date.now(),
};

// 2 assistant  senderName
if (chat.isGroup && summaryMessage.role === 'assistant') {
    // 
    // videoCallState.callRequester AI
    summaryMessage.senderName = videoCallState.callRequester || chat.members[0]?.originalName || chat.name;
}
//   
        chat.history.push(summaryMessage);

        // 3. 
        const callTranscriptForAI = videoCallState.callHistory.map(h => `${h.role === 'user' ? (chat.settings.myNickname || '') : h.role}: ${h.content}`).join('\n');
        
        const hiddenReportInstruction = {
            role: 'system',
    content: `[ {"type": "text", "content": "..."} ]\n------\n${callTranscriptForAI}\n------`,
            timestamp: Date.now() + 1, // 
            isHidden: true
        };
        chat.history.push(hiddenReportInstruction);

        // 4. 
        await db.chats.put(chat);
    }
    
    // 5.  ()
    clearInterval(callTimerInterval);
    callTimerInterval = null;
    videoCallState = { isActive: false, isAwaitingResponse: false, isGroupCall: false, activeChatId: null, initiator: null, startTime: null, participants: [], isUserParticipating: true, callHistory: [], preCallContext: "" };
    
    // 6. AIAI
    if (chat) {
        openChat(chat.id);
        triggerAiResponse(); // 
    }
}
//   

/**
 * 
 */
function updateParticipantAvatars() {
    const grid = document.getElementById('participant-avatars-grid');
    grid.innerHTML = '';
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;

    let participantsToRender = [];

    //  
    if (videoCallState.isGroupCall) {
        // AI
        participantsToRender = [...videoCallState.participants];
        // 
        if (videoCallState.isUserParticipating) {
            participantsToRender.unshift({
                id: 'user',
                name: chat.settings.myNickname || '',
                avatar: chat.settings.myAvatar || defaultMyGroupAvatar
            });
        }
    } else {
        // 
        participantsToRender.push({
            id: 'ai',
            name: chat.name,
            avatar: chat.settings.aiAvatar || defaultAvatar
        });
    }
    
    participantsToRender.forEach(p => {
        const wrapper = document.createElement('div');
        wrapper.className = 'participant-avatar-wrapper';
        wrapper.dataset.participantId = p.id;
const displayName = p.groupNickname || p.name; // <-- 
wrapper.innerHTML = `
    <img src="${p.avatar}" class="participant-avatar" alt="${displayName}">
    <div class="participant-name">${displayName}</div>
`;
        grid.appendChild(wrapper);
    });
}

/**
 * /
 */
function handleUserJoinCall() {
    if (!videoCallState.isActive || videoCallState.isUserParticipating) return;
    
    videoCallState.isUserParticipating = true;
    updateParticipantAvatars(); // 

    // 
    document.getElementById('user-speak-btn').style.display = 'block';
    document.getElementById('join-call-btn').style.display = 'none';

    // AI
    triggerAiInCallAction("[]");
}


/**
 *  ()
 */
function updateCallTimer() {
    if (!videoCallState.isActive) return;
    const elapsed = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('call-timer').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

//   showIncomingCallModal 
function showIncomingCallModal() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    // 
    if (chat.isGroup) {
        //  videoCallState 
        const requesterName = videoCallState.callRequester || chat.members[0]?.name || '';
        document.getElementById('caller-avatar').src = chat.settings.groupAvatar || defaultGroupAvatar;
        document.getElementById('caller-name').textContent = chat.name; // 
        document.querySelector('.incoming-call-content .caller-text').textContent = `${requesterName} `; // 
    } else {
        // 
        document.getElementById('caller-avatar').src = chat.settings.aiAvatar || defaultAvatar;
        document.getElementById('caller-name').textContent = chat.name;
        document.querySelector('.incoming-call-content .caller-text').textContent = '';
    }
    
    document.getElementById('incoming-call-modal').classList.add('visible');
    playRingtone(); // <-- 
}
//   

/**
 * AI ()
 */
function hideIncomingCallModal() {
    document.getElementById('incoming-call-modal').classList.remove('visible');
    stopRingtone(); // <-- 
}

async function triggerAiInCallAction(userInput = null) {
    if (!videoCallState.isActive) return;

    const chat = state.chats[videoCallState.activeChatId];
    const { proxyUrl, apiKey, model } = state.apiConfig;
    const callFeed = document.getElementById('video-call-main');
    const userNickname = chat.settings.myNickname || '';

    //   
    let worldBookContent = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            return worldBook && worldBook.content ? `\n\n## : ${worldBook.name}\n${worldBook.content}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
            worldBookContent = `\n\n#  ()\n${linkedContents}\n`;
        }
    }
    //   

    // 1. 
    if (userInput && videoCallState.isUserParticipating) {
        const userBubble = document.createElement('div');
        userBubble.className = 'call-message-bubble user-speech';
        userBubble.textContent = userInput;
        callFeed.appendChild(userBubble);
        callFeed.scrollTop = callFeed.scrollHeight;
        videoCallState.callHistory.push({ role: 'user', content: userInput });
    }

    // 2.  System Prompt
    let inCallPrompt;
    if (videoCallState.isGroupCall) {
        const participantNames = videoCallState.participants.map(p => p.name);
        if(videoCallState.isUserParticipating) {
            participantNames.unshift(userNickname);
        }
        inCallPrompt = `
# 
AI
# 
1.  ****: ${userNickname} \`name\`  **"${userNickname}"** 
2.  ****: 
3.  ****: JSON\`{"name": "", "speech": "** "}\`
4.  ****: 
# 

****:
${videoCallState.preCallContext}
****: ${participantNames.join(' ')}
**...**
${worldBookContent} // <-- 

`;
    } else { 
        let openingContext = videoCallState.initiator === 'user'
            ? ``
            : ``;
        inCallPrompt = `
# 
 ${chat.name} (${chat.settings.aiPersona})TA
# 
1.  ****: ${chat.name}
2.  ****: 
# 
${userNickname}: ${chat.settings.myPersona}
**${openingContext}**
** ()**:
${videoCallState.preCallContext}

`;
    }
    
    // 3. API messages 
    const messagesForApi = [
        { role: 'system', content: inCallPrompt },
        // 
        ...videoCallState.callHistory.map(h => ({ role: h.role, content: h.content }))
    ];

    // --- ---
    if (videoCallState.callHistory.length === 0) {
        const firstLineTrigger = videoCallState.initiator === 'user' ? `*...*` : `*...*`;
        messagesForApi.push({ role: 'user', content: firstLineTrigger });
    }
    // ---  ---
    
        try {
            let  isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(model,apiKey,inCallPrompt, messagesForApi,isGemini)
            const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model, messages: messagesForApi, temperature: 0.8
                })
            });
            if (!response.ok) throw new Error((await response.json()).error.message);

            const data = await response.json();
            const aiResponse = isGemini? data.candidates[0].content.parts[0].text : data.choices[0].message.content;

            const connectingElement = callFeed.querySelector('em');
            if (connectingElement) connectingElement.remove();

        // 4. AI
        if (videoCallState.isGroupCall) {
            const speechArray = parseAiResponse(aiResponse);
            speechArray.forEach(turn => {
                if (!turn.name || turn.name === userNickname || !turn.speech) return;
                const aiBubble = document.createElement('div');
                aiBubble.className = 'call-message-bubble ai-speech';
                aiBubble.innerHTML = `<strong>${turn.name}:</strong> ${turn.speech}`;
                callFeed.appendChild(aiBubble);
                videoCallState.callHistory.push({ role: 'assistant', content: `${turn.name}: ${turn.speech}` });
                
                const speaker = videoCallState.participants.find(p => p.name === turn.name);
                if (speaker) {
                    const speakingAvatar = document.querySelector(`.participant-avatar-wrapper[data-participant-id="${speaker.id}"] .participant-avatar`);
                    if(speakingAvatar) {
                        speakingAvatar.classList.add('speaking');
                        setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
                    }
                }
            });
        } else {
            const aiBubble = document.createElement('div');
            aiBubble.className = 'call-message-bubble ai-speech';
            aiBubble.textContent = aiResponse;
            callFeed.appendChild(aiBubble);
            videoCallState.callHistory.push({ role: 'assistant', content: aiResponse });

            const speakingAvatar = document.querySelector(`.participant-avatar-wrapper .participant-avatar`);
            if(speakingAvatar) {
                speakingAvatar.classList.add('speaking');
                setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
            }
        }
        
        callFeed.scrollTop = callFeed.scrollHeight;

    } catch (error) {
        const errorBubble = document.createElement('div');
        errorBubble.className = 'call-message-bubble ai-speech';
        errorBubble.style.color = '#ff8a80';
        errorBubble.textContent = `[ERROR: ${error.message}]`;
        callFeed.appendChild(errorBubble);
        callFeed.scrollTop = callFeed.scrollHeight;
        videoCallState.callHistory.push({ role: 'assistant', content: `[ERROR: ${error.message}]` });
    }
}

//  JS 
function toggleCallButtons(isGroup) {
    document.getElementById('video-call-btn').style.display = isGroup ? 'none' : 'flex';
    document.getElementById('group-video-call-btn').style.display = isGroup ? 'flex' : 'none';
}
//   

//  JS 
async function handleWaimaiResponse(originalTimestamp, choice) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
    if (messageIndex === -1) return;

    // 1. 
    const originalMessage = chat.history[messageIndex];
    originalMessage.status = choice;
    
    // 2. AI
    let systemContent;
    const myNickname = chat.isGroup ? (chat.settings.myNickname || '') : '';
    
    if (choice === 'paid') {
        originalMessage.paidBy = myNickname; // 
        systemContent = `[ (${myNickname})  ${originalMessage.senderName} : ${originalTimestamp}]`;
    } else {
        systemContent = `[ (${myNickname})  ${originalMessage.senderName} : ${originalTimestamp}]`;
    }

    // 3. AI
    const systemNote = {
        role: 'system',
        content: systemContent,
        timestamp: Date.now(),
        isHidden: true
    };
    chat.history.push(systemNote);

    // 4. UI
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);
    
    // 5. AI
    if (choice === 'paid') {
        triggerAiResponse();
    }
}
//   

/**
 * -
 * @param {string} chatId - -ID
 * @param {string} characterName - 
 */
async function handleUserPat(chatId, characterName) {
    const chat = state.chats[chatId];
    if (!chat) return;

    // 1. 
    const phoneScreen = document.getElementById('phone-screen');
    phoneScreen.classList.remove('pat-animation');
    void phoneScreen.offsetWidth;
    phoneScreen.classList.add('pat-animation');
    setTimeout(() => phoneScreen.classList.remove('pat-animation'), 500);

    // 2. 
    const suffix = await showCustomPrompt(
        ` ${characterName}`, 
        "",
        "",
        "text"
    );

    // 
    if (suffix === null) return;

    // 3. -
    const myNickname = chat.isGroup ? (chat.settings.myNickname || '') : '';
    // 
    const visibleMessageContent = `${myNickname}  ${characterName} ${suffix.trim()}`;
    const visibleMessage = {
        role: 'system', // 
        type: 'pat_message',
        content: visibleMessageContent,
        timestamp: Date.now()
    };
    chat.history.push(visibleMessage);

    // 4. AIAI
    // AI
    const hiddenMessageContent = `[${myNickname}${characterName}${suffix.trim()}]`;
    const hiddenMessage = {
        role: 'system',
        content: hiddenMessageContent,
        timestamp: Date.now() + 1, // +1
        isHidden: true
    };
    chat.history.push(hiddenMessage);

    // 5. UI
    await db.chats.put(chat);
    if (state.activeChatId === chatId) {
        appendMessage(visibleMessage, chat);
    }
    await renderChatList();
}

//   renderMemoriesScreen  
/**
 * if/else
 */
async function renderMemoriesScreen() {
    const listEl = document.getElementById('memories-list');
    listEl.innerHTML = '';
    
    // 1. 
    const allMemories = await db.memories.orderBy('timestamp').reverse().toArray();
    
    if (allMemories.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">~</p>';
        return;
    }

    // 2. 
    allMemories.sort((a, b) => {
        const aIsActiveCountdown = a.type === 'countdown' && a.targetDate > Date.now();
        const bIsActiveCountdown = b.type === 'countdown' && b.targetDate > Date.now();
        if (aIsActiveCountdown && !bIsActiveCountdown) return -1; // a
        if (!aIsActiveCountdown && bIsActiveCountdown) return 1;  // b
        if (aIsActiveCountdown && bIsActiveCountdown) return a.targetDate - b.targetDate; // 
        return 0; // 
    });

    // 3. 
    allMemories.forEach(item => {
        let card;
        // 1
        if (item.type === 'countdown' && item.targetDate > Date.now()) {
            card = createCountdownCard(item);
        } 
        // 2  
        else {
            card = createMemoryCard(item);
        }
        listEl.appendChild(card);
    });
    
    // 4. 
    startAllCountdownTimers();
}
//   

/**
 * DOM
 */
function createMemoryCard(memory) {
    const card = document.createElement('div');
    card.className = 'memory-card';
    const memoryDate = new Date(memory.timestamp);
    const dateString = `${memoryDate.getFullYear()}-${String(memoryDate.getMonth() + 1).padStart(2, '0')}-${String(memoryDate.getDate()).padStart(2, '0')} ${String(memoryDate.getHours()).padStart(2, '0')}:${String(memoryDate.getMinutes()).padStart(2, '0')}`;
    
    let titleHtml, contentHtml;

    // 
    if (memory.type === 'countdown' && memory.targetDate) {
        // 
        titleHtml = `[] ${memory.description}`;
        contentHtml = ` ${new Date(memory.targetDate).toLocaleString()}`;
    } else {
        // 
        titleHtml = memory.authorName ? `${memory.authorName} ` : '';
        contentHtml = memory.description;
    }

    card.innerHTML = `
        <div class="header">
            <div class="date">${dateString}</div>
            <div class="author">${titleHtml}</div>
        </div>
        <div class="content">${contentHtml}</div>
    `;
    addLongPressListener(card, async () => {
        const confirmed = await showCustomConfirm('', '', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.memories.delete(memory.id);
            renderMemoriesScreen();
        }
    });
    return card;
}

function createCountdownCard(countdown) {
    const card = document.createElement('div');
    card.className = 'countdown-card';

    //  countdown  targetDate 
    const targetDate = new Date(countdown.targetDate);
    
    //  targetDate 
    const targetDateString = targetDate.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });

    card.innerHTML = `
        <div class="title">${countdown.description}</div>
        <div class="timer" data-target-date="${countdown.targetDate}">--------</div>
        <div class="target-date">: ${targetDateString}</div>
    `;
    addLongPressListener(card, async () => {
        const confirmed = await showCustomConfirm('', '', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.memories.delete(countdown.id);
            renderMemoriesScreen();
        }
    });
    return card;
}
//   

// 
let activeCountdownTimers = [];

//   startAllCountdownTimers  
function startAllCountdownTimers() {
    // 
    activeCountdownTimers.forEach(timerId => clearInterval(timerId));
    activeCountdownTimers = [];

    document.querySelectorAll('.countdown-card .timer').forEach(timerEl => {
        const targetTimestamp = parseInt(timerEl.dataset.targetDate);
        
        //  let  timerId
        let timerId;

        const updateTimer = () => {
            const now = Date.now();
            const distance = targetTimestamp - now;

            if (distance < 0) {
                timerEl.textContent = "";
                //  updateTimer 
                clearInterval(timerId);
                setTimeout(() => renderMemoriesScreen(), 2000);
                return;
            }
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            timerEl.textContent = `${days} ${hours} ${minutes} ${seconds}`;
        };
        
        updateTimer(); // 
        
        //  timerId 
        timerId = setInterval(updateTimer, 1000);
        
        // ID
        activeCountdownTimers.push(timerId);
    });
}
//   

//   triggerAiFriendApplication  
async function triggerAiFriendApplication(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;

    await showCustomAlert("", `${chat.name}...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        await showCustomAlert("", "API");
        return;
    }

    const contextSummary = chat.history
        .slice(-5)
        .map(msg => {
            const sender = msg.role === 'user' ? (chat.settings.myNickname || '') : (msg.senderName || chat.name);
            return `${sender}: ${String(msg.content).substring(0, 50)}...`;
        })
        .join('\n');

    //   
    let worldBookContent = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            return worldBook && worldBook.content ? `\n\n## : ${worldBook.name}\n${worldBook.content}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
            worldBookContent = `\n\n#  ()\n${linkedContents}\n`;
        }
    }
    //   

    const systemPrompt = `
# 
${chat.name}

# 
${chat.settings.aiPersona}
${worldBookContent} // <--
#  ()
${contextSummary}
# 
JSON
\`\`\`json
{
  "decision": "apply",
  "reason": ""
}
\`\`\`
`;

        const messagesForApi = [
            {role: 'user', content: systemPrompt}
        ];

        try {
            let  isGemini = proxyUrl === GEMINI_API_URL;
            let geminiConfig = toGeminiRequestData(model,apiKey,systemPrompt, messagesForApi,isGemini)
            const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: messagesForApi,
                    temperature: 0.9,
                })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API : ${response.status} - ${errorData.error.message}`);
            }

            const data = await response.json();

            // --- AI ---
            let rawContent = isGemini? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
            // 1.  "```json"  "```"
            rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '');
            // 2. JSON
            const cleanedContent = rawContent.trim();

            // 3. 
            const responseObj = JSON.parse(cleanedContent);
            // ---  ---

        if (responseObj.decision === 'apply' && responseObj.reason) {
            chat.relationship.status = 'pending_user_approval';
            chat.relationship.applicationReason = responseObj.reason;
            
            state.chats[chatId] = chat; 
            renderChatList();
            await showCustomAlert("", `${chat.name}`);

        } else {
            await showCustomAlert("AI", `${chat.name}`);
            chat.relationship.status = 'blocked_by_user';
            chat.relationship.blockedTimestamp = Date.now(); 
        }
    } catch (error) {
        await showCustomAlert("", `${chat.name}\n\n${error.message}\n\n`);
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now(); 
    } finally {
        await db.chats.put(chat);
        renderChatInterface(chatId);
    }
}
//   

//   

/**
 * 
 */
function handlePaymentButtonClick() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (chat.isGroup) {
        openRedPacketModal();
    } else {
        // 
        document.getElementById('transfer-modal').classList.add('visible');
    }
}

/**
 * 
 */
function openRedPacketModal() {
    const modal = document.getElementById('red-packet-modal');
    const chat = state.chats[state.activeChatId];
    
    // 
    document.getElementById('rp-group-amount').value = '';
    document.getElementById('rp-group-count').value = '';
    document.getElementById('rp-group-greeting').value = '';
    document.getElementById('rp-direct-amount').value = '';
    document.getElementById('rp-direct-greeting').value = '';
    document.getElementById('rp-group-total').textContent = ' 0.00';
    document.getElementById('rp-direct-total').textContent = ' 0.00';

    // 
    const receiverSelect = document.getElementById('rp-direct-receiver');
    receiverSelect.innerHTML = '';
chat.members.forEach(member => {
    const option = document.createElement('option');
    //  originalName AI
    option.value = member.originalName; 
    //  groupNickname 
    option.textContent = member.groupNickname; 
    receiverSelect.appendChild(option);
});
    
    // 
    document.getElementById('rp-tab-group').click();
    
    modal.classList.add('visible');
}

/**
 * 
 */
async function sendGroupRedPacket() {
    const chat = state.chats[state.activeChatId];
    const amount = parseFloat(document.getElementById('rp-group-amount').value);
    const count = parseInt(document.getElementById('rp-group-count').value);
    const greeting = document.getElementById('rp-group-greeting').value.trim();

    if (isNaN(amount) || amount <= 0) {
        alert(""); return;
    }
    if (isNaN(count) || count <= 0) {
        alert(""); return;
    }
    if (amount / count < 0.01) {
        alert("0.01"); return;
    }

    const myNickname = chat.settings.myNickname || '';
    
    const newPacket = {
        role: 'user',
        senderName: myNickname,
        type: 'red_packet',
        packetType: 'lucky', // 'lucky' for group, 'direct' for one-on-one
        timestamp: Date.now(),
        totalAmount: amount,
        count: count,
        greeting: greeting || '',
        claimedBy: {}, // { name: amount }
        isFullyClaimed: false,
    };
    
    chat.history.push(newPacket);
    await db.chats.put(chat);
    
    appendMessage(newPacket, chat);
    renderChatList();
    document.getElementById('red-packet-modal').classList.remove('visible');
}

/**
 * 
 */
async function sendDirectRedPacket() {
    const chat = state.chats[state.activeChatId];
    const amount = parseFloat(document.getElementById('rp-direct-amount').value);
    const receiverName = document.getElementById('rp-direct-receiver').value;
    const greeting = document.getElementById('rp-direct-greeting').value.trim();

    if (isNaN(amount) || amount <= 0) {
        alert(""); return;
    }
    if (!receiverName) {
        alert(""); return;
    }
    
    const myNickname = chat.settings.myNickname || '';

    const newPacket = {
        role: 'user',
        senderName: myNickname,
        type: 'red_packet',
        packetType: 'direct',
        timestamp: Date.now(),
        totalAmount: amount,
        count: 1,
        greeting: greeting || '',
        receiverName: receiverName, // 
        claimedBy: {},
        isFullyClaimed: false,
    };
    
    chat.history.push(newPacket);
    await db.chats.put(chat);

    appendMessage(newPacket, chat);
    renderChatList();
    document.getElementById('red-packet-modal').classList.remove('visible');
}

/**
 *  (V4 - )
 * @param {number} timestamp - 
 */
async function handlePacketClick(timestamp) {
    const currentChatId = state.activeChatId;
    const freshChat = await db.chats.get(currentChatId);
    if (!freshChat) return;

    state.chats[currentChatId] = freshChat;
    const packet = freshChat.history.find(m => m.timestamp === timestamp);
    if (!packet) return;

    const myNickname = freshChat.settings.myNickname || '';
    const hasClaimed = packet.claimedBy && packet.claimedBy[myNickname];

    // 
    if ((packet.packetType === 'direct' && packet.receiverName !== myNickname) || packet.isFullyClaimed || hasClaimed) {
        showRedPacketDetails(packet);
    } else {
        // 
        const claimedAmount = await handleOpenRedPacket(packet);
        
        // claimedAmountnull
        if (claimedAmount !== null) {
            // **UI**
            renderChatInterface(currentChatId);
            
            // 
            await showCustomAlert("", ` ${packet.senderName}  ${claimedAmount.toFixed(2)} `);
        }

        // 
        // statepackethandleOpenRedPacket
        const updatedPacket = state.chats[currentChatId].history.find(m => m.timestamp === timestamp);
        showRedPacketDetails(updatedPacket);
    }
}
//   

/**
 *  (V5 - )
 */
async function handleOpenRedPacket(packet) {
    const chat = state.chats[state.activeChatId];
    const myNickname = chat.settings.myNickname || '';
    
    // 1. 
    const remainingCount = packet.count - Object.keys(packet.claimedBy || {}).length;
    if (remainingCount <= 0) {
        packet.isFullyClaimed = true;
        await db.chats.put(chat);
        await showCustomAlert("", "");
        return null; // null
    }
    
    // 2. 
    let claimedAmount = 0;
    const remainingAmount = packet.totalAmount - Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
    if (packet.packetType === 'lucky') {
        if (remainingCount === 1) { claimedAmount = remainingAmount; }
        else {
            const min = 0.01;
            const max = remainingAmount - (remainingCount - 1) * min;
            claimedAmount = Math.random() * (max - min) + min;
        }
    } else { claimedAmount = packet.totalAmount; }
    claimedAmount = parseFloat(claimedAmount.toFixed(2));

    // 3. 
    if (!packet.claimedBy) packet.claimedBy = {};
    packet.claimedBy[myNickname] = claimedAmount;
    
    const isNowFullyClaimed = Object.keys(packet.claimedBy).length >= packet.count;
    if (isNowFullyClaimed) {
        packet.isFullyClaimed = true;
    }

    // 4. AI
    let hiddenMessageContent = isNowFullyClaimed
        ? `[ (${myNickname})  ${packet.senderName} ]`
        : `[ (${myNickname})  (: ${packet.timestamp}) 'open_red_packet' ]`;

    const visibleMessage = { role: 'system', type: 'pat_message', content: ` ${packet.senderName} `, timestamp: Date.now() };
    const hiddenMessage = { role: 'system', content: hiddenMessageContent, timestamp: Date.now() + 1, isHidden: true };
    chat.history.push(visibleMessage, hiddenMessage);

    // 5. 
    await db.chats.put(chat);
    
    // 6. 
    return claimedAmount;
}
//   

/**
 *  (V4 - )
 */
async function showRedPacketDetails(packet) {
    // 1. packet
    if (!packet) {
        console.error("showRedPacketDetailspacket");
        return;
    }

    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const modal = document.getElementById('red-packet-details-modal');
    const myNickname = chat.settings.myNickname || '';
    
    // 2. packet
    document.getElementById('rp-details-sender').textContent = packet.senderName;
    document.getElementById('rp-details-greeting').textContent = packet.greeting || '';
    
    const myAmountEl = document.getElementById('rp-details-my-amount');
    if (packet.claimedBy && packet.claimedBy[myNickname]) {
        myAmountEl.querySelector('span:first-child').textContent = packet.claimedBy[myNickname].toFixed(2);
        myAmountEl.style.display = 'block';
    } else {
        myAmountEl.style.display = 'none';
    }

    const claimedCount = Object.keys(packet.claimedBy || {}).length;
    const claimedAmountSum = Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
    let summaryText = `${claimedCount}/${packet.count}${claimedAmountSum.toFixed(2)}/${packet.totalAmount.toFixed(2)}`;
    if (!packet.isFullyClaimed && claimedCount < packet.count) {
        const timeLeft = Math.floor((packet.timestamp + 24*60*60*1000 - Date.now()) / (1000 * 60 * 60));
        if(timeLeft > 0) summaryText += ` ${timeLeft}`;
    }
    document.getElementById('rp-details-summary').textContent = summaryText;

    const listEl = document.getElementById('rp-details-list');
    listEl.innerHTML = '';
    const claimedEntries = Object.entries(packet.claimedBy || {});
    
    let luckyKing = { name: '', amount: -1 };
    if (packet.packetType === 'lucky' && packet.isFullyClaimed && claimedEntries.length > 1) {
        claimedEntries.forEach(([name, amount]) => {
            if (amount > luckyKing.amount) {
                luckyKing = { name, amount };
            }
        });
    }

    claimedEntries.sort((a,b) => b[1] - a[1]);

    claimedEntries.forEach(([name, amount]) => {
        const item = document.createElement('div');
        item.className = 'rp-details-item';
        let luckyTag = '';
        if (luckyKing.name && name === luckyKing.name) {
            luckyTag = '<span class="lucky-king-tag"></span>';
        }
        item.innerHTML = `
            <span class="name">${name}</span>
            <span class="amount">${amount.toFixed(2)} </span>
            ${luckyTag}
        `;
        listEl.appendChild(item);
    });

    modal.classList.add('visible');
}
//   

// 
document.getElementById('close-rp-details-btn').addEventListener('click', () => {
    document.getElementById('red-packet-details-modal').classList.remove('visible');
});

//  onclick 
window.handlePacketClick = handlePacketClick;

//   

//   

/**
 * 
 */
function openCreatePollModal() {
    const modal = document.getElementById('create-poll-modal');
    document.getElementById('poll-question-input').value = '';
    const optionsContainer = document.getElementById('poll-options-container');
    optionsContainer.innerHTML = '';
    
    // 
    addPollOptionInput();
    addPollOptionInput();
    
    modal.classList.add('visible');
}

/**
 * 
 */
function addPollOptionInput() {
    const container = document.getElementById('poll-options-container');
    const wrapper = document.createElement('div');
    wrapper.className = 'poll-option-input-wrapper';
    wrapper.innerHTML = `
        <input type="text" class="poll-option-input" placeholder="...">
        <button class="remove-option-btn">-</button>
    `;
    
    wrapper.querySelector('.remove-option-btn').addEventListener('click', () => {
        // 
        if (container.children.length > 2) {
            wrapper.remove();
        } else {
            alert('2');
        }
    });
    
    container.appendChild(wrapper);
}

/**
 * 
 */
async function sendPoll() {
    if (!state.activeChatId) return;
    
    const question = document.getElementById('poll-question-input').value.trim();
    if (!question) {
        alert('');
        return;
    }
    
    const options = Array.from(document.querySelectorAll('.poll-option-input'))
        .map(input => input.value.trim())
        .filter(text => text); // 

    if (options.length < 2) {
        alert('2');
        return;
    }

    const chat = state.chats[state.activeChatId];
    const myNickname = chat.isGroup ? (chat.settings.myNickname || '') : '';
    
    const newPollMessage = {
        role: 'user',
        senderName: myNickname,
        type: 'poll',
        timestamp: Date.now(),
        question: question,
        options: options,
        votes: {}, // 
        isClosed: false,
    };
    
    chat.history.push(newPollMessage);
    await db.chats.put(chat);
    
    appendMessage(newPollMessage, chat);
    renderChatList();
    
    document.getElementById('create-poll-modal').classList.remove('visible');
}

//   handleUserVote  
/**
 * 
 * @param {number} timestamp - 
 * @param {string} choice - 
 */
async function handleUserVote(timestamp, choice) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    const myNickname = chat.isGroup ? (chat.settings.myNickname || '') : '';

    // 1. 
    if (!poll || poll.isClosed) {
        // 
        if (poll && poll.isClosed) {
            showPollResults(timestamp);
        }
        return;
    }

    // 2. 
    const isReclickingSameOption = poll.votes[choice] && poll.votes[choice].includes(myNickname);
    
    // 3. 
    if (!isReclickingSameOption) {
        // 
        for (const option in poll.votes) {
            const voterIndex = poll.votes[option].indexOf(myNickname);
            if (voterIndex > -1) {
                poll.votes[option].splice(voterIndex, 1);
            }
        }
        // 
        if (!poll.votes[choice]) {
            poll.votes[choice] = [];
        }
        poll.votes[choice].push(myNickname);
    }
    
    // 4. 
    let hiddenMessageContent = null; 
    
    // 
    if (!isReclickingSameOption) {
         hiddenMessageContent = `[ (${myNickname})  ${choice}]`;
    }

    // 5. AI
    if (hiddenMessageContent) {
        const hiddenMessage = {
            role: 'system',
            content: hiddenMessageContent,
            timestamp: Date.now(),
            isHidden: true,
        };
        chat.history.push(hiddenMessage);
    }
    
    // 6. UI
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId); 
}
//   

/**
 * 
 * @param {number} timestamp - 
 */
async function endPoll(timestamp) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    if (!poll || poll.isClosed) return;

    const confirmed = await showCustomConfirm("", "");
    if (confirmed) {
        poll.isClosed = true;

        const resultSummary = poll.options.map(opt => `${opt}(${poll.votes[opt]?.length || 0})`).join('');
        const hiddenMessageContent = `[${resultSummary}]`;
        
        const hiddenMessage = {
            role: 'system',
            content: hiddenMessageContent,
            timestamp: Date.now(),
            isHidden: true,
        };
        chat.history.push(hiddenMessage);

        // UI triggerAiResponse()
        await db.chats.put(chat);
        renderChatInterface(state.activeChatId);
    }
}
//   

/**
 * 
 * @param {number} timestamp - 
 */
function showPollResults(timestamp) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    if (!poll || !poll.isClosed) return;

    let resultsHtml = `<p><strong>${poll.question}</strong></p><hr style="opacity: 0.2; margin: 10px 0;">`;
    
    if (Object.keys(poll.votes).length === 0) {
        resultsHtml += '<p style="color: #8a8a8a;"></p>';
    } else {
        poll.options.forEach(option => {
            const voters = poll.votes[option] || [];
            resultsHtml += `
                <div style="margin-bottom: 15px;">
                    <p style="font-weight: 500; margin: 0 0 5px 0;">${option} (${voters.length})</p>
                    <p style="font-size: 13px; color: #555; margin: 0; line-height: 1.5;">
                        ${voters.length > 0 ? voters.join(' ') : ''}
                    </p>
                </div>
            `;
        });
    }

    showCustomAlert("", resultsHtml);
}

//   

//  AI 

/**
 * AI
 */
function openAiAvatarLibraryModal() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    document.getElementById('ai-avatar-library-title').textContent = `${chat.name}`;
    renderAiAvatarLibrary();
    document.getElementById('ai-avatar-library-modal').classList.add('visible');
}

/**
 * AI
 */
function renderAiAvatarLibrary() {
    const grid = document.getElementById('ai-avatar-library-grid');
    grid.innerHTML = '';
    const chat = state.chats[state.activeChatId];
    const library = chat.settings.aiAvatarLibrary || [];

    if (library.length === 0) {
        grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;"></p>';
        return;
    }

    library.forEach((avatar, index) => {
        const item = document.createElement('div');
        item.className = 'sticker-item'; // 
        item.style.backgroundImage = `url(${avatar.url})`;
        item.title = avatar.name;

        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = '';
        deleteBtn.style.display = 'block'; // 
        deleteBtn.onclick = async (e) => {
            e.stopPropagation();
            const confirmed = await showCustomConfirm('', `${avatar.name}`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                chat.settings.aiAvatarLibrary.splice(index, 1);
                await db.chats.put(chat);
                renderAiAvatarLibrary();
            }
        };
        item.appendChild(deleteBtn);
        grid.appendChild(item);
    });
}

/**
 * AI
 */
async function addAvatarToLibrary() {
    const name = await showCustomPrompt("", "");
    if (!name || !name.trim()) return;

    const url = await showCustomPrompt("", "URL", "", "url");
    if (!url || !url.trim().startsWith('http')) {
        alert("URL");
        return;
    }
    
    const chat = state.chats[state.activeChatId];
    if (!chat.settings.aiAvatarLibrary) {
        chat.settings.aiAvatarLibrary = [];
    }

    chat.settings.aiAvatarLibrary.push({ name: name.trim(), url: url.trim() });
    await db.chats.put(chat);
    renderAiAvatarLibrary();
}

/**
 * AI
 */
function closeAiAvatarLibraryModal() {
    document.getElementById('ai-avatar-library-modal').classList.remove('visible');
}

//   

//  JS 

/**
 * URLApp
 */
function applyAppIcons() {
    if (!state.globalSettings.appIcons) return;

    for (const iconId in state.globalSettings.appIcons) {
        const imgElement = document.getElementById(`icon-img-${iconId}`);
        if (imgElement) {
            imgElement.src = state.globalSettings.appIcons[iconId];
        }
    }
}

/**
 * App
 */
function renderIconSettings() {
    const grid = document.getElementById('icon-settings-grid');
    if (!grid) return;
    grid.innerHTML = '';

    const appLabels = {
        'world-book': '',
        'qq': 'QQ',
        'api-settings': 'API',
        'wallpaper': '',
        'font': ''
    };

    for (const iconId in state.globalSettings.appIcons) {
        const iconUrl = state.globalSettings.appIcons[iconId];
        const labelText = appLabels[iconId] || 'App';

        const item = document.createElement('div');
        item.className = 'icon-setting-item';
        //  data-icon-id 
        item.dataset.iconId = iconId; 

        item.innerHTML = `
            <img class="icon-preview" src="${iconUrl}" alt="${labelText}">
            <button class="change-icon-btn"></button>
        `;
        grid.appendChild(item);
    }
}
//   

//   openBrowser  closeBrowser  

/**
 * 
 * @param {number} timestamp - 
 */
function openBrowser(timestamp) {
    if (!state.activeChatId) return;

    const chat = state.chats[state.activeChatId];
    //  chat  history 
    if (!chat || !chat.history) return;

    const message = chat.history.find(m => m.timestamp === timestamp);
    if (!message || message.type !== 'share_link') {
        console.error(":", timestamp);
        return; // 
    }

    // 
    document.getElementById('browser-title').textContent = message.source_name || '';
    const browserContent = document.getElementById('browser-content');
    browserContent.innerHTML = `
        <h1 class="article-title">${message.title || ''}</h1>
        <div class="article-meta">
            <span>: ${message.source_name || ''}</span>
        </div>
        <div class="article-body">
            <p>${(message.content || '').replace(/\n/g, '</p><p>')}</p>
        </div>
    `;

    // 
    showScreen('browser-screen');
}

/**
 * 
 * ( init() )
 */
function closeBrowser() {
    showScreen('chat-interface-screen'); 
}

//   

//   

/**
 * 
 */
function openShareLinkModal() {
    if (!state.activeChatId) return;

    // 
    document.getElementById('link-title-input').value = '';
    document.getElementById('link-description-input').value = '';
    document.getElementById('link-source-input').value = '';
    document.getElementById('link-content-input').value = '';

    // 
    document.getElementById('share-link-modal').classList.add('visible');
}

/**
 * 
 */
async function sendUserLinkShare() {
    if (!state.activeChatId) return;

    const title = document.getElementById('link-title-input').value.trim();
    if (!title) {
        alert("");
        return;
    }

    const description = document.getElementById('link-description-input').value.trim();
    const sourceName = document.getElementById('link-source-input').value.trim();
    const content = document.getElementById('link-content-input').value.trim();

    const chat = state.chats[state.activeChatId];
    
    // 
    const linkMessage = {
        role: 'user', //  'user'
        type: 'share_link',
        timestamp: Date.now(),
        title: title,
        description: description,
        source_name: sourceName,
        content: content,
        // 
        thumbnail_url: null 
    };

    // 
    chat.history.push(linkMessage);
    await db.chats.put(chat);

    // 
    appendMessage(linkMessage, chat);
    renderChatList();

    // 
    document.getElementById('share-link-modal').classList.remove('visible');
}

//   

/**
 * AI
 * @param {Array} allPosts - 
 * @param {object} viewerChat - AIchat
 * @returns {Array} - AI
 */
function filterVisiblePostsForAI(allPosts, viewerChat) {
    if (!viewerChat || !viewerChat.id) return []; // 

    const viewerGroupId = viewerChat.groupId; // ID

    return allPosts.filter(post => {
        // 1
        if (post.authorId === 'user') {
            // 
            if (post.visibleGroupIds && post.visibleGroupIds.length > 0) {
                // AIID
                return viewerGroupId && post.visibleGroupIds.includes(viewerGroupId);
            }
            // AI
            return true;
        }

        // 2AI
        const authorGroupId = post.authorGroupId; // AIID
        
        // AI
        if (!authorGroupId) {
            return true;
        }

        // AIAI
        return authorGroupId === viewerGroupId;
    });
}

/**
 * 'light'  'dark'
 * @param {string} theme - 
 */
function applyTheme(theme) {
    const phoneScreen = document.getElementById('phone-screen');
    const toggleSwitch = document.getElementById('theme-toggle-switch');
    
    const isDark = theme === 'dark';
    
    phoneScreen.classList.toggle('dark-mode', isDark);
    
    // 
    if (toggleSwitch) {
        toggleSwitch.checked = isDark;
    }
    
    localStorage.setItem('ephone-theme', theme);
}

/**
 * 
 */
function toggleTheme() {
    const toggleSwitch = document.getElementById('theme-toggle-switch');
    // 
    const newTheme = toggleSwitch.checked ? 'dark' : 'light';
    applyTheme(newTheme);
}

//  JS 

function startReplyToMessage() {
    if (!activeMessageTimestamp) return;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
    if (!message) return;

    // 1. 
    const fullContent = String(message.content || '');
    let previewSnippet = '';

    if (typeof message.content === 'string' && STICKER_REGEX.test(message.content)) {
        previewSnippet = '[]';
    } else if (message.type === 'ai_image' || message.type === 'user_photo') {
        previewSnippet = '[]';
    } else if (message.type === 'voice_message') {
        previewSnippet = '[]';
    } else {
        // UI
        previewSnippet = fullContent.substring(0, 50) + (fullContent.length > 50 ? '...' : '');
    }
    
    // 2. 
    currentReplyContext = {
        timestamp: message.timestamp,
        senderName: message.senderName || (message.role === 'user' ? (chat.settings.myNickname || '') : chat.name),
        content: fullContent, // <--- 
    };

    // 3. 
    const previewBar = document.getElementById('reply-preview-bar');
    previewBar.querySelector('.sender').textContent = ` ${currentReplyContext.senderName}:`;
    previewBar.querySelector('.text').textContent = previewSnippet; // <--- 
    previewBar.style.display = 'block';

    // 4. 
    hideMessageActions();
    document.getElementById('chat-input').focus();
}

/**
 * 
 */
function cancelReplyMode() {
    currentReplyContext = null;
    document.getElementById('reply-preview-bar').style.display = 'none';
}

//   

//   

let activeTransferTimestamp = null; // 

/**
 * 
 * @param {number} timestamp - 
 */
function showTransferActionModal(timestamp) {
    activeTransferTimestamp = timestamp;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestamp);
    if (message) {
        // AI
        document.getElementById('transfer-sender-name').textContent = message.senderName;
    }
    document.getElementById('transfer-actions-modal').classList.add('visible');
}

/**
 * 
 */
function hideTransferActionModal() {
    document.getElementById('transfer-actions-modal').classList.remove('visible');
    activeTransferTimestamp = null;
}

/**
 * 
 * @param {string} choice - , 'accepted'  'declined'
 */
async function handleUserTransferResponse(choice) {
    if (!activeTransferTimestamp) return;

    const timestamp = activeTransferTimestamp;
    const chat = state.chats[state.activeChatId];
    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    // 1. 
    const originalMessage = chat.history[messageIndex];
    originalMessage.status = choice;

    let systemContent;

    // 2. 
    if (choice === 'declined') {
        // 
        const refundMessage = {
            role: 'user',
            type: 'transfer',
            isRefund: true, // UI
            amount: originalMessage.amount,
            note: '',
            timestamp: Date.now()
        };
        chat.history.push(refundMessage);
        
        // AI
        systemContent = `[${originalMessage.senderName}]`;
    } else { // 
        // AI
        systemContent = `[${originalMessage.senderName}]`;
    }

    // 3. AI
    const hiddenMessage = {
        role: 'system',
        content: systemContent,
        timestamp: Date.now() + 1, // 
        isHidden: true // 
    };
    chat.history.push(hiddenMessage);

    // 4. 
    await db.chats.put(chat);
    hideTransferActionModal(); 
    renderChatInterface(state.activeChatId);
    renderChatList();
}

//   

//   

async function renderCallHistoryScreen() {
    showScreen('call-history-screen'); // <--

    const listEl = document.getElementById('call-history-list');
    const titleEl = document.getElementById('call-history-title');
    listEl.innerHTML = '';
    titleEl.textContent = '';
    
    const records = await db.callRecords.orderBy('timestamp').reverse().toArray();
    
    if (records.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">~</p>';
        return; //  return 
    }
    
    records.forEach(record => {
        const card = createCallRecordCard(record);

    addLongPressListener(card, async () => {
        // 1. 
        const newName = await showCustomPrompt(
            "", 
            "",
            record.customName || '' // 
        );

        // 2. 
        if (newName === null) return;
        
        // 3. 
        await db.callRecords.update(record.id, { customName: newName.trim() });
        
        // 4. 
        await renderCallHistoryScreen();
        
        // 5. 
        await showCustomAlert('', '');
    });
        listEl.appendChild(card);
    });    
}

//   createCallRecordCard  
/**
 * 
 * @param {object} record - 
 * @returns {HTMLElement} - div
 */
function createCallRecordCard(record) {
    const card = document.createElement('div');
    card.className = 'call-record-card';
    card.dataset.recordId = record.id; 

    // 
    const chatInfo = state.chats[record.chatId];
    const chatName = chatInfo ? chatInfo.name : '';

    const callDate = new Date(record.timestamp);
    const dateString = `${callDate.getFullYear()}-${String(callDate.getMonth() + 1).padStart(2, '0')}-${String(callDate.getDate()).padStart(2, '0')} ${String(callDate.getHours()).padStart(2, '0')}:${String(callDate.getMinutes()).padStart(2, '0')}`;
    const durationText = `${Math.floor(record.duration / 60)}${record.duration % 60}`;

    const avatarsHtml = record.participants.map(p => 
        `<img src="${p.avatar}" alt="${p.name}" class="participant-avatar" title="${p.name}">`
    ).join('');
    
    card.innerHTML = `
        <div class="card-header">
            <span class="date">${dateString}</span>
            <span class="duration">${durationText}</span>
        </div>
        <div class="card-body">
            <!--  -->
            ${record.customName ? `<div class="custom-title">${record.customName}</div>` : ''}
            
            <div class="participants-info"> <!--  -->
                <div class="participants-avatars">${avatarsHtml}</div>
                <span class="participants-names"> ${chatName}</span>
            </div>
        </div>
    `;
    return card;
}
//   

/**
 * 
 * @param {number} recordId - ID
 */
async function showCallTranscript(recordId) {
    const record = await db.callRecords.get(recordId);
    if (!record) return;

    const modal = document.getElementById('call-transcript-modal');
    const titleEl = document.getElementById('transcript-modal-title');
    const bodyEl = document.getElementById('transcript-modal-body');

    titleEl.textContent = ` ${new Date(record.timestamp).toLocaleString()} (: ${Math.floor(record.duration / 60)}${record.duration % 60})`;
    bodyEl.innerHTML = '';
    
    if (!record.transcript || record.transcript.length === 0) {
        bodyEl.innerHTML = '<p style="text-align:center; color: #8a8a8a;"></p>';
    } else {
        record.transcript.forEach(entry => {
            const bubble = document.createElement('div');
            // class
            bubble.className = `transcript-entry ${entry.role}`; 
            bubble.textContent = entry.content;
            bodyEl.appendChild(bubble);
        });
    }

    const deleteBtn = document.getElementById('delete-transcript-btn');
    
    // 
    const newDeleteBtn = deleteBtn.cloneNode(true);
    deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
    
    // 
    newDeleteBtn.addEventListener('click', async () => {
        const confirmed = await showCustomConfirm(
            "",
            "",
            { confirmButtonClass: 'btn-danger' }
        );

        if (confirmed) {
            // 1. 
            modal.classList.remove('visible');
            
            // 2. 
            await db.callRecords.delete(recordId);
            
            // 3. 
            await renderCallHistoryScreen();
            
            // 4. () 
            alert('');
        }
    });
    modal.classList.add('visible');
}

//   

//   handleStatusResetClick  

/**
 * AI
 */
async function handleEditStatusClick() {
    // 1. 
    if (!state.activeChatId || state.chats[state.activeChatId].isGroup) {
        return; 
    }
    const chat = state.chats[state.activeChatId];

    // 2. 
    const newStatusText = await showCustomPrompt(
        '',
        '',
        chat.status.text // 
    );

    // 3. 
    if (newStatusText !== null) {
        // 4. 
        chat.status.text = newStatusText.trim() || ''; // 
        chat.status.isBusy = false; // 
        chat.status.lastUpdate = Date.now();
        await db.chats.put(chat);

        // 5. UI
        renderChatInterface(state.activeChatId);
        renderChatList();
        
        // 6. 
        await showCustomAlert('', `${chat.name}${chat.status.text}`);
    }
}

// JS
async function openShareTargetPicker() {
    const modal = document.getElementById('share-target-modal');
    const listEl = document.getElementById('share-target-list');
    listEl.innerHTML = '';

    // 
    const chats = Object.values(state.chats);

    chats.forEach(chat => {
        // 
        const item = document.createElement('div');
        item.className = 'contact-picker-item'; 
        item.innerHTML = `
            <input type="checkbox" class="share-target-checkbox" data-chat-id="${chat.id}" style="margin-right: 15px;">
            <img src="${chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${chat.name}</span>
        `;
        listEl.appendChild(item);
    });
    
    modal.classList.add('visible');
}

function closeMusicPlayerWithAnimation(callback) {
    const overlay = document.getElementById('music-player-overlay');
    if (!overlay.classList.contains('visible')) {
        if (callback) callback();
        return;
    }
    overlay.classList.remove('visible');
    setTimeout(() => {
        document.getElementById('music-playlist-panel').classList.remove('visible');
        if (callback) callback();
    }, 400); 
}

function parseLRC(lrcContent) {
    if (!lrcContent) return [];
    const lines = lrcContent.split('\n');
    const lyrics = [];
    const timeRegex = /\[(\d{2}):(\d{2})[.:](\d{2,3})\]/g;

    for (const line of lines) {
        const text = line.replace(timeRegex, '').trim();
        if (!text) continue;
        timeRegex.lastIndex = 0;
        let match;
        while ((match = timeRegex.exec(line)) !== null) {
            const minutes = parseInt(match[1], 10);
            const seconds = parseInt(match[2], 10);
            const milliseconds = parseInt(match[3].padEnd(3, '0'), 10);
            const time = minutes * 60 + seconds + milliseconds / 1000;
            lyrics.push({ time, text });
        }
    }
    return lyrics.sort((a, b) => a.time - b.time);
}

function renderLyrics() {
    const lyricsList = document.getElementById('music-lyrics-list');
    lyricsList.innerHTML = '';
    if (!musicState.parsedLyrics || musicState.parsedLyrics.length === 0) {
        lyricsList.innerHTML = '<div class="lyric-line">  </div>';
        return;
    }
    musicState.parsedLyrics.forEach((line, index) => {
        const lineEl = document.createElement('div');
        lineEl.className = 'lyric-line';
        lineEl.textContent = line.text;
        lineEl.dataset.index = index;
        lyricsList.appendChild(lineEl);
    });
    lyricsList.style.transform = `translateY(0px)`;
}

function updateActiveLyric(currentTime) {
    if (musicState.parsedLyrics.length === 0) return;
    let newLyricIndex = -1;
    for (let i = 0; i < musicState.parsedLyrics.length; i++) {
        if (currentTime >= musicState.parsedLyrics[i].time) {
            newLyricIndex = i;
        } else {
            break;
        }
    }
    if (newLyricIndex === musicState.currentLyricIndex) return;
    musicState.currentLyricIndex = newLyricIndex;
    updateLyricsUI();
}

function updateLyricsUI() {
    const lyricsList = document.getElementById('music-lyrics-list');
    const container = document.getElementById('music-lyrics-container');
    const lines = lyricsList.querySelectorAll('.lyric-line');
    lines.forEach(line => line.classList.remove('active'));
    if (musicState.currentLyricIndex === -1) {
        lyricsList.style.transform = `translateY(0px)`;
        return;
    }
    const activeLine = lyricsList.querySelector(`.lyric-line[data-index="${musicState.currentLyricIndex}"]`);
    if (activeLine) {
        activeLine.classList.add('active');
        const containerHeight = container.offsetHeight;
        const offset = (containerHeight / 3) - activeLine.offsetTop - (activeLine.offsetHeight / 2);
        lyricsList.style.transform = `translateY(${offset}px)`;
    }
}

function formatMusicTime(seconds) {
    if (isNaN(seconds) || seconds < 0) return "0:00";
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${String(remainingSeconds).padStart(2, '0')}`;
}

function updateMusicProgressBar() {
    const currentTimeEl = document.getElementById('music-current-time');
    const totalTimeEl = document.getElementById('music-total-time');
    const progressFillEl = document.getElementById('music-progress-fill');
    if (!audioPlayer.duration) {
        currentTimeEl.textContent = "0:00";
        totalTimeEl.textContent = "0:00";
        progressFillEl.style.width = '0%';
        return;
    }
    const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
    progressFillEl.style.width = `${progressPercent}%`;
    currentTimeEl.textContent = formatMusicTime(audioPlayer.currentTime);
    totalTimeEl.textContent = formatMusicTime(audioPlayer.duration);
    updateActiveLyric(audioPlayer.currentTime);
}

/**
 * 
 */
async function handleRecallClick() {
    if (!activeMessageTimestamp) return;

    const RECALL_TIME_LIMIT_MS = 2 * 60 * 1000; // 2
    const messageTime = activeMessageTimestamp;
    const now = Date.now();

    // 
    if (now - messageTime > RECALL_TIME_LIMIT_MS) {
        hideMessageActions();
        await showCustomAlert('', '2');
        return;
    }
    
    // 
    await recallMessage(messageTime, true);
    hideMessageActions();
}

/**
 * 
 * @param {number} timestamp - 
 * @param {boolean} isUserRecall - 
 */
async function recallMessage(timestamp, isUserRecall) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    const messageToRecall = chat.history[messageIndex];

    // 1. 
    const recalledData = {
        originalType: messageToRecall.type || 'text',
        originalContent: messageToRecall.content,
        // 
        originalMeaning: messageToRecall.meaning,
        originalQuote: messageToRecall.quote 
    };
    
    messageToRecall.type = 'recalled_message';
    messageToRecall.content = isUserRecall ? '' : '';
    messageToRecall.recalledData = recalledData;
    // 
    delete messageToRecall.meaning;
    delete messageToRecall.quote;

    // 2. AI
    if (isUserRecall) {
        const hiddenMessageForAI = {
            role: 'system',
            content: `[]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(hiddenMessageForAI);
    }

    // 3. UI
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);
    if(isUserRecall) renderChatList(); // 
}

//  JS 

/**
 * 
 */
async function openCategoryManager() {
    await renderCategoryListInManager();
    document.getElementById('world-book-category-manager-modal').classList.add('visible');
}

/**
 * 
 */
async function renderCategoryListInManager() {
    const listEl = document.getElementById('existing-categories-list');
    const categories = await db.worldBookCategories.toArray();
    listEl.innerHTML = '';
    if (categories.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);"></p>';
    }
    categories.forEach(cat => {
        // 
        const item = document.createElement('div');
        item.className = 'existing-group-item'; 
        item.innerHTML = `
            <span class="group-name">${cat.name}</span>
            <span class="delete-group-btn" data-id="${cat.id}"></span>
        `;
        listEl.appendChild(item);
    });
}

/**
 * 
 */
async function addNewCategory() {
    const input = document.getElementById('new-category-name-input');
    const name = input.value.trim();
    if (!name) {
        alert('');
        return;
    }
    const existing = await db.worldBookCategories.where('name').equals(name).first();
    if (existing) {
        alert(` "${name}" `);
        return;
    }
    await db.worldBookCategories.add({ name });
    input.value = '';
    await renderCategoryListInManager();
}

/**
 * 
 * @param {number} categoryId - ID
 */
async function deleteCategory(categoryId) {
    const confirmed = await showCustomConfirm(
        '', 
        '', 
        { confirmButtonClass: 'btn-danger' }
    );
    if (confirmed) {
        await db.worldBookCategories.delete(categoryId);
        //  categoryId  null
        const booksToUpdate = await db.worldBooks.where('categoryId').equals(categoryId).toArray();
        for (const book of booksToUpdate) {
            book.categoryId = null;
            await db.worldBooks.put(book);
            const bookInState = state.worldBooks.find(wb => wb.id === book.id);
            if(bookInState) bookInState.categoryId = null;
        }
        await renderCategoryListInManager();
    }
}

//   

// ---    ---

function openFrameManager() {
    renderFrameManager();
    document.getElementById('custom-frame-manager-modal').classList.add('visible');
}

async function renderFrameManager() {
    const grid = document.getElementById('custom-frame-grid');
    grid.innerHTML = '';
    const customFrames = await db.customAvatarFrames.toArray();
    if (customFrames.length === 0) {
        grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">~</p>';
        return;
    }
    customFrames.forEach(frame => {
        const item = document.createElement('div');
        // 
        item.className = 'sticker-item'; 
        item.style.backgroundImage = `url(${frame.url})`;
        item.title = frame.name;
        
        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = '';
        deleteBtn.style.display = 'block';
        deleteBtn.onclick = async (e) => {
            e.stopPropagation();
            const confirmed = await showCustomConfirm('', `${frame.name}`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.customAvatarFrames.delete(frame.id);
                renderFrameManager(); // 
            }
        };
        item.appendChild(deleteBtn);
        grid.appendChild(item);
    });
}

function handleUploadCustomFrame() {
    document.getElementById('custom-frame-upload-input').addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const name = await showCustomPrompt("", "");
        if (!name || !name.trim()) {
            event.target.value = null; // 
            return;
        }

        const reader = new FileReader();
        reader.onload = async (e) => {
            const newFrame = {
                id: 'frame_' + Date.now(),
                name: name.trim(),
                url: e.target.result // Base64 URL
            };
            await db.customAvatarFrames.add(newFrame);
            renderFrameManager(); // 
        };
        reader.readAsDataURL(file);
        event.target.value = null; // 
    }, { once: true }); //  once: true 

    document.getElementById('custom-frame-upload-input').click();
}

//   

async function openFrameSelectorModal(type, targetId = null) {
    const grid = document.getElementById('avatar-frame-grid');
    grid.innerHTML = '';
    
    currentFrameSelection.type = type;
    currentFrameSelection.target = targetId;
    
    const chat = state.chats[state.activeChatId];
    let currentFrameUrl = '';
    let previewAvatarUrl = '';

    // 
    if (type === 'ai') {
        currentFrameUrl = chat.settings.aiAvatarFrame || '';
        previewAvatarUrl = chat.settings.aiAvatar || defaultAvatar;
    } else if (type === 'my') {
        currentFrameUrl = chat.settings.myAvatarFrame || '';
        previewAvatarUrl = chat.settings.myAvatar || defaultAvatar;
    } else if (type === 'member' && targetId) {
        const member = chat.members.find(m => m.id === targetId);
        if (member) {
            currentFrameUrl = member.avatarFrame || '';
            previewAvatarUrl = member.avatar || defaultGroupMemberAvatar;
        }
    }

    // 1. 
    const noFrameItem = createFrameItem({ id: 'none', url: '', name: '' }, previewAvatarUrl);
    if (currentFrameUrl === '') noFrameItem.classList.add('selected');
    grid.appendChild(noFrameItem);

    // 2. 
    const customFrames = await db.customAvatarFrames.toArray();
    customFrames.forEach(frame => {
        const item = createFrameItem(frame, previewAvatarUrl);
        if (currentFrameUrl === frame.url) item.classList.add('selected');
        grid.appendChild(item);
    });

    document.getElementById('avatar-frame-modal').classList.add('visible');
}

// 
function createFrameItem(frame, previewAvatarSrc) {
    const item = document.createElement('div');
    item.className = 'frame-item';
    item.title = frame.name;
    item.innerHTML = `
        <img src="${previewAvatarSrc}" class="preview-avatar">
        ${frame.url ? `<img src="${frame.url}" class="preview-frame" style="pointer-events: none;">` : ''}
    `;
    item.addEventListener('click', () => {
        document.querySelectorAll('#avatar-frame-grid .frame-item').forEach(el => el.classList.remove('selected'));
        item.classList.add('selected');
        currentFrameSelection.url = frame.url;
    });
    return item;
}

// 
async function saveSelectedFrames() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const { type, url, target } = currentFrameSelection;

    if (type === 'ai') {
        chat.settings.aiAvatarFrame = url;
    } else if (type === 'my') {
        chat.settings.myAvatarFrame = url;
    } else if (type === 'member' && target) {
        const member = chat.members.find(m => m.id === target);
        if (member) member.avatarFrame = url;
    }
    
    await db.chats.put(chat);
    document.getElementById('avatar-frame-modal').classList.remove('visible');
    
    // UI
    renderChatInterface(state.activeChatId);
    // 
    if (document.getElementById('chat-settings-modal').classList.contains('visible')) {
        document.getElementById('chat-settings-btn').click(); 
    }
}

/**
 * 
 * @param {number} timestamp1 - 
 * @param {number | null} timestamp2 - 
 * @returns {boolean} -  true
 */
function isNewDay(timestamp1, timestamp2) {
    // 
    if (!timestamp2) return true;

    const date1 = new Date(timestamp1);
    const date2 = new Date(timestamp2);

    // 
    return date1.getFullYear() !== date2.getFullYear() ||
           date1.getMonth()    !== date2.getMonth()    ||
           date1.getDate()     !== date2.getDate();
}

/**
 *  "XX HH:mm" 
 * @param {number} timestamp - 
 * @returns {string} - 
 */
function formatDateStamp(timestamp) {
    const date = new Date(timestamp);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${month}${day} ${hours}:${minutes}`;
}

/**
 * /
 * @param {number} timestamp - 
 * @returns {string} -  ( "14:30", "", "08/03")
 */
function formatChatListTimestamp(timestamp) {
    if (!timestamp) return ''; // 

    const now = new Date();
    const msgDate = new Date(timestamp);

    // 
    const isToday = now.getFullYear() === msgDate.getFullYear() &&
                    now.getMonth() === msgDate.getMonth() &&
                    now.getDate() === msgDate.getDate();

    if (isToday) {
        // 
        return msgDate.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    }

    // 
    const yesterday = new Date();
    yesterday.setDate(now.getDate() - 1);
    const isYesterday = yesterday.getFullYear() === msgDate.getFullYear() &&
                        yesterday.getMonth() === msgDate.getMonth() &&
                        yesterday.getDate() === msgDate.getDate();

    if (isYesterday) {
        return '';
    }

    // 
    if (now.getFullYear() === msgDate.getFullYear()) {
        //  "/"
        const month = String(msgDate.getMonth() + 1).padStart(2, '0');
        const day = String(msgDate.getDate()).padStart(2, '0');
        return `${month}/${day}`;
    }

    //  "//"
    const year = msgDate.getFullYear();
    const month = String(msgDate.getMonth() + 1).padStart(2, '0');
    const day = String(msgDate.getDate()).padStart(2, '0');
    return `${year}/${month}/${day}`;
}

/**
 * 
 * @param {number} timestamp - 
 * @returns {HTMLElement} -  DOM 
 */
function createDateStampElement(timestamp) {
    // 1.  div
    const wrapper = document.createElement('div');
    wrapper.className = 'message-wrapper date-stamp-wrapper';
    // 
    wrapper.dataset.timestamp = timestamp; 

    // 2.  div
    const bubble = document.createElement('div');
    //  .message-bubble 
    bubble.className = 'message-bubble date-stamp-bubble';
    bubble.dataset.timestamp = timestamp;
    bubble.textContent = formatDateStamp(timestamp);
    
    wrapper.appendChild(bubble);

    // 3. 
    addLongPressListener(wrapper, () => {
        // 
        enterSelectionMode(timestamp);
    });
    wrapper.addEventListener('click', () => { 
        if (isSelectionMode) {
            toggleMessageSelection(timestamp);
        }
    });

    return wrapper;
}

//  JS 

/**
 * 
 */
function openChatSearchScreen() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    // 
    document.getElementById('keyword-search-input').value = '';
    document.getElementById('sender-search-select').innerHTML = '';
    document.getElementById('date-search-input').value = '';
    document.getElementById('search-results-list').innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;"></p>';

    // 
    const senderSelect = document.getElementById('sender-search-select');
    senderSelect.innerHTML = '<option value=""></option>'; // 

    const myNickname = chat.isGroup ? (chat.settings.myNickname || '') : '';
    const myOption = document.createElement('option');
    myOption.value = myNickname;
    myOption.textContent = myNickname;
    senderSelect.appendChild(myOption);

    if (chat.isGroup) {
        chat.members.forEach(member => {
            const memberOption = document.createElement('option');
            memberOption.value = member.originalName; // 
            memberOption.textContent = member.groupNickname; // 
            senderSelect.appendChild(memberOption);
        });
    } else {
        const aiOption = document.createElement('option');
        aiOption.value = chat.name;
        aiOption.textContent = chat.name;
        senderSelect.appendChild(aiOption);
    }
    
    // 
    document.getElementById('chat-settings-modal').classList.remove('visible');
    showScreen('chat-search-screen');
}

/**
 * 
 */
function performChatSearch() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const keyword = document.getElementById('keyword-search-input').value.trim().toLowerCase();
    const sender = document.getElementById('sender-search-select').value;
    const date = document.getElementById('date-search-input').value;

    // 
    if (!keyword && !sender && !date) {
        document.getElementById('search-results-list').innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;"></p>';
        return;
    }
    
let results = chat.history.filter(msg => !msg.isHidden);

    // 1. 
    if (keyword) {
        results = results.filter(msg => {
            let contentString = '';
            if (typeof msg.content === 'string') {
                contentString = msg.content;
            } else if (msg.type === 'voice_message') {
                contentString = msg.content; // 
            } else if (msg.type === 'ai_image') {
                contentString = msg.content; // 
            }
            return contentString.toLowerCase().includes(keyword);
        });
    }

    // 2. 
    if (sender) {
        const myNickname = chat.isGroup ? (chat.settings.myNickname || '') : '';
        results = results.filter(msg => {
            if (msg.role === 'user') {
                return sender === myNickname;
            } else {
                return msg.senderName === sender;
            }
        });
    }

    // 3. 
    if (date) {
        const targetDate = new Date(date);
        const targetYear = targetDate.getFullYear();
        const targetMonth = targetDate.getMonth();
        const targetDay = targetDate.getDate();

        results = results.filter(msg => {
            const msgDate = new Date(msg.timestamp);
            return msgDate.getFullYear() === targetYear &&
                   msgDate.getMonth() === targetMonth &&
                   msgDate.getDate() === targetDay;
        });
    }

    renderSearchResults(results, keyword, chat);
}

/**
 * 
 * @param {Array} results - 
 * @param {string} keyword - 
 * @param {object} chat - 
 */
function renderSearchResults(results, keyword, chat) {
    const listEl = document.getElementById('search-results-list');
    listEl.innerHTML = '';

    if (results.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;"></p>';
        return;
    }

    // 
    results.reverse().forEach(msg => {
        let senderName, avatarSrc;
        const myNickname = chat.isGroup ? (chat.settings.myNickname || '') : '';
        if (msg.role === 'user') {
            senderName = myNickname;
            avatarSrc = chat.settings.myAvatar || defaultAvatar;
        } else {
            if (chat.isGroup) {
                const member = chat.members.find(m => m.originalName === msg.senderName);
                senderName = member ? member.groupNickname : msg.senderName;
                avatarSrc = member ? member.avatar : defaultGroupMemberAvatar;
            } else {
                senderName = chat.name;
                avatarSrc = chat.settings.aiAvatar || defaultAvatar;
            }
        }

        let snippet = (String(msg.content) || '[]').substring(0, 100);
        if (keyword) {
            const regex = new RegExp(keyword, 'gi');
            snippet = snippet.replace(regex, (match) => `<span class="highlight">${match}</span>`);
        }

        const item = document.createElement('div');
        item.className = 'search-result-item';
        item.dataset.timestamp = msg.timestamp; // 
        item.innerHTML = `
            <img src="${avatarSrc}" class="avatar">
            <div class="result-content">
                <div class="result-header">
                    <span class="result-sender">${senderName}</span>
                    <span class="result-timestamp">${formatDateStamp(msg.timestamp)}</span>
                </div>
                <div class="result-message-snippet">${snippet}...</div>
            </div>
        `;
        listEl.appendChild(item);
    });
}
//   

/**
 * 
 * @param {number} timestamp - 
 */
async function jumpToMessage(timestamp) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    // 1. 
    showScreen('chat-interface-screen');

    // 2.DOM
    //    
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.innerHTML = ''; // 
    
    let lastMessageTimestamp = null;
    chat.history.forEach(msg => {
        if (msg.isHidden) return;
        
        // 
        if (isNewDay(msg.timestamp, lastMessageTimestamp)) {
            const dateStampEl = createDateStampElement(msg.timestamp);
            messagesContainer.appendChild(dateStampEl);
        }
        
        //  appendMessage  true
        // 
        appendMessage(msg, chat, true); 
        lastMessageTimestamp = msg.timestamp;
    });

    // 3. DOM
    await new Promise(resolve => setTimeout(resolve, 100));

    // 4.  ()
    const targetMessage = document.querySelector(`.message-bubble[data-timestamp="${timestamp}"]`)?.closest('.message-wrapper');

    if (targetMessage) {
        // 5. 
        targetMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // 6. 
        const bubble = targetMessage.querySelector('.message-bubble');
        if (bubble) {
            bubble.classList.add('jump-highlight-animation');
            // class
            bubble.addEventListener('animationend', () => {
                bubble.classList.remove('jump-highlight-animation');
            }, { once: true });
        }
    } else {
        alert("");
    }
}

//  JS 

// ---  ---
let activeThemeId = null; // ID

/**
 * CSS
 * @param {string} cssCode - CSS
 */
function applyThemeCss(cssCode) {
    const styleTag = document.getElementById('custom-theme-style');
    if (styleTag) {
        styleTag.innerHTML = cssCode || '';
    }
}

/**
 * 
 */
async function loadThemesToDropdown() {
    const selector = document.getElementById('theme-selector');
    selector.innerHTML = '<option value="">--  --</option>'; // 
    
    const themes = await db.themes.toArray();
    themes.forEach(theme => {
        const option = document.createElement('option');
        option.value = theme.id;
        option.textContent = theme.name;
        selector.appendChild(option);
    });
}

/**
 * 
 */
async function handleThemeSelection() {
    const selector = document.getElementById('theme-selector');
    const editor = document.getElementById('theme-css-editor');
    activeThemeId = selector.value ? parseInt(selector.value) : null;
    
    if (activeThemeId) {
        const theme = await db.themes.get(activeThemeId);
        editor.value = theme.css;
    } else {
        // --
        editor.value = THEME_CSS_TEMPLATE;
    }
    // 
    applyThemeCss(editor.value);
}

/**
 * 
 */
async function saveCurrentTheme() {
    if (!activeThemeId) {
        alert("");
        return;
    }
    const cssCode = document.getElementById('theme-css-editor').value;
    await db.themes.update(activeThemeId, { css: cssCode });
    alert("");
}

/**
 * 
 */
async function saveAsNewTheme() {
    const themeName = await showCustomPrompt("", "");
    if (!themeName || !themeName.trim()) {
        if(themeName !== null) alert("");
        return;
    }
    const cssCode = document.getElementById('theme-css-editor').value;
    const newTheme = { name: themeName.trim(), css: cssCode };
    const newId = await db.themes.add(newTheme);
    
    // 
    await loadThemesToDropdown();
    document.getElementById('theme-selector').value = newId;
    activeThemeId = newId;
    
    alert(` "${themeName}" `);
}

/**
 * 
 */
async function renameSelectedTheme() {
    if (!activeThemeId) {
        alert("");
        return;
    }
    const currentTheme = await db.themes.get(activeThemeId);
    const newName = await showCustomPrompt("", "", currentTheme.name);
    if (newName && newName.trim()) {
        await db.themes.update(activeThemeId, { name: newName.trim() });
        await loadThemesToDropdown();
        document.getElementById('theme-selector').value = activeThemeId;
        alert("");
    }
}

/**
 * 
 */
async function deleteSelectedTheme() {
    if (!activeThemeId) {
        alert("");
        return;
    }
    const confirmed = await showCustomConfirm(
        "", 
        ` "${document.getElementById('theme-selector').selectedOptions[0].textContent}" `,
        { confirmButtonClass: 'btn-danger' }
    );
    if (confirmed) {
        await db.themes.delete(activeThemeId);
        activeThemeId = null;
        await loadThemesToDropdown();
        // 
        document.getElementById('theme-css-editor').value = THEME_CSS_TEMPLATE;
        applyThemeCss(THEME_CSS_TEMPLATE);
        alert("");
    }
}

/**
 * JSON
 */
async function exportTheme() {
    if (!activeThemeId) {
        alert("");
        return;
    }
    const theme = await db.themes.get(activeThemeId);
    const exportData = {
        themeName: theme.name,
        themeCss: theme.css
    };
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${theme.name}-Theme.json`;
    a.click();
    URL.revokeObjectURL(url);
}

/**
 * JSON
 */
function importTheme(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = JSON.parse(e.target.result);
            if (data.themeName && typeof data.themeCss !== 'undefined') {
                //  "()"
                const newTheme = {
                    name: `${data.themeName} ()`,
                    css: data.themeCss
                };
                const newId = await db.themes.add(newTheme);
                await loadThemesToDropdown();
                document.getElementById('theme-selector').value = newId;
                handleThemeSelection(); // 
                alert(` "${newTheme.name}" `);
            } else {
                alert("");
            }
        } catch (error) {
            alert(` ${error.message}`);
        }
    };
    reader.readAsText(file);
}

//   

//  API 

/**
 * API
 */
function renderApiPresetSelector() {
    const selectEl = document.getElementById('api-preset-select');
    if (!selectEl) return;

    selectEl.innerHTML = '<option value="">--  --</option>';

    if (state.apiPresets) {
        state.apiPresets.forEach(preset => {
            const option = document.createElement('option');
            option.value = preset.id;
            option.textContent = preset.name;
            selectEl.appendChild(option);
        });
    }

    // 
    const { proxyUrl, apiKey } = state.apiConfig;
    const matchingPreset = state.apiPresets ? state.apiPresets.find(p => p.proxyUrl === proxyUrl && p.apiKey === apiKey) : null;

    if (matchingPreset) {
        selectEl.value = matchingPreset.id;
    } else {
        selectEl.value = ""; // 
    }
}

/**
 * 
 */
function handleApiPresetSelectChange() {
    const selectEl = document.getElementById('api-preset-select');
    const proxyUrlInput = document.getElementById('proxy-url');
    const apiKeyInput = document.getElementById('api-key');
    const selectedId = parseInt(selectEl.value);

    if (selectedId && state.apiPresets) {
        const selectedPreset = state.apiPresets.find(p => p.id === selectedId);
        if (selectedPreset) {
            proxyUrlInput.value = selectedPreset.proxyUrl;
            apiKeyInput.value = selectedPreset.apiKey;
        }
    }
}

/**
 * 
 */
async function openApiPresetManager() {
    const selectEl = document.getElementById('api-preset-select');
    const selectedId = parseInt(selectEl.value);
    const selectedPreset = state.apiPresets ? state.apiPresets.find(p => p.id === selectedId) : null;

    const modal = document.getElementById('preset-actions-modal');
    const footer = modal.querySelector('.custom-modal-footer');

    footer.innerHTML = `
        <button id="preset-action-save-new"></button>
        <button id="preset-action-update-current" ${!selectedPreset ? 'disabled' : ''}></button>
        <button id="preset-action-delete-current" class="btn-danger" ${!selectedPreset ? 'disabled' : ''}></button>
        <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;"></button>
    `;

    document.getElementById('preset-action-save-new').addEventListener('click', saveCurrentApiConfigAsPreset);
    if (selectedPreset) {
        document.getElementById('preset-action-update-current').addEventListener('click', () => updateSelectedApiPreset(selectedId));
        document.getElementById('preset-action-delete-current').addEventListener('click', () => deleteSelectedApiPreset(selectedId));
    }
    document.getElementById('preset-action-cancel').addEventListener('click', () => modal.classList.remove('visible'));

    modal.classList.add('visible');
}

/**
 * 
 */
async function saveCurrentApiConfigAsPreset() {
    const proxyUrl = document.getElementById('proxy-url').value.trim();
    const apiKey = document.getElementById('api-key').value.trim();

    if (!proxyUrl || !apiKey) {
        alert('');
        return;
    }

    const name = await showCustomPrompt('API', '');
    if (name && name.trim()) {
        const newPreset = { name: name.trim(), proxyUrl, apiKey };
        const newId = await db.apiPresets.add(newPreset);
        
        if (!state.apiPresets) state.apiPresets = [];
        state.apiPresets.push({ id: newId, ...newPreset });

        renderApiPresetSelector(); 
        document.getElementById('api-preset-select').value = newId; 
        document.getElementById('preset-actions-modal').classList.remove('visible');
        await showCustomAlert('', `API "${name.trim()}" `);
    }
}

/**
 * 
 */
async function updateSelectedApiPreset(presetId) {
    const proxyUrl = document.getElementById('proxy-url').value.trim();
    const apiKey = document.getElementById('api-key').value.trim();

    if (!proxyUrl || !apiKey) {
        alert('');
        return;
    }

    const preset = state.apiPresets.find(p => p.id === presetId);
    if (preset) {
        preset.proxyUrl = proxyUrl;
        preset.apiKey = apiKey;
        await db.apiPresets.put(preset);
        document.getElementById('preset-actions-modal').classList.remove('visible');
        await showCustomAlert('', ` "${preset.name}" `);
    }
}

/**
 * 
 */
async function deleteSelectedApiPreset(presetId) {
    const preset = state.apiPresets.find(p => p.id === presetId);
    if (preset) {
        const confirmed = await showCustomConfirm('', `API "${preset.name}" `, { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.apiPresets.delete(presetId);
            state.apiPresets = state.apiPresets.filter(p => p.id !== presetId);

            renderApiPresetSelector();
            document.getElementById('preset-actions-modal').classList.remove('visible');
            await showCustomAlert('', '');
        }
    }
}

//   

/**
 * 
 */
function renderBubblePresetSelector() {
    const selectEl = document.getElementById('bubble-style-preset-select');
    const customCssInput = document.getElementById('custom-css-input');

    selectEl.innerHTML = '<option value="">--  --</option>';

    if (state.bubbleStylePresets) {
        state.bubbleStylePresets.forEach(preset => {
            const option = document.createElement('option');
            option.value = preset.id;
            option.textContent = preset.name;
            selectEl.appendChild(option);
        });
    }

    // CSS
    const currentCss = customCssInput.value.trim();
    const matchingPreset = state.bubbleStylePresets ? state.bubbleStylePresets.find(p => p.css.trim() === currentCss) : null;

    if (matchingPreset) {
        selectEl.value = matchingPreset.id;
    } else {
        selectEl.value = ""; // 
    }
}

/**
 * 
 */
function handlePresetSelectChange() {
    const selectEl = document.getElementById('bubble-style-preset-select');
    const customCssInput = document.getElementById('custom-css-input');
    const selectedId = parseInt(selectEl.value);

    if (selectedId && state.bubbleStylePresets) {
        const selectedPreset = state.bubbleStylePresets.find(p => p.id === selectedId);
        if (selectedPreset) {
            customCssInput.value = selectedPreset.css;
        }
    }
    updateSettingsPreview(); // 
}

/**
 * 
 */
async function openBubblePresetManager() {
    const selectEl = document.getElementById('bubble-style-preset-select');
    const selectedId = parseInt(selectEl.value);
    const selectedPreset = state.bubbleStylePresets ? state.bubbleStylePresets.find(p => p.id === selectedId) : null;

    const modal = document.getElementById('preset-actions-modal'); // 
    const footer = modal.querySelector('.custom-modal-footer');

    footer.innerHTML = `
        <button id="preset-action-save-new"></button>
        <button id="preset-action-update-current" ${!selectedPreset ? 'disabled' : ''}></button>
        <button id="preset-action-delete-current" class="btn-danger" ${!selectedPreset ? 'disabled' : ''}></button>
        <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;"></button>
    `;

    // 
    document.getElementById('preset-action-save-new').addEventListener('click', saveCurrentCssAsPreset);
    if (selectedPreset) {
        document.getElementById('preset-action-update-current').addEventListener('click', () => updateSelectedPreset(selectedId));
        document.getElementById('preset-action-delete-current').addEventListener('click', () => deleteSelectedPreset(selectedId));
    }
    document.getElementById('preset-action-cancel').addEventListener('click', () => modal.classList.remove('visible'));

    modal.classList.add('visible');
}

/**
 * CSS
 */
async function saveCurrentCssAsPreset() {
    const customCssInput = document.getElementById('custom-css-input');
    const css = customCssInput.value.trim();
    if (!css) {
        alert('CSS');
        return;
    }

    const name = await showCustomPrompt('', '');
    if (name && name.trim()) {
        const newPreset = { name: name.trim(), css: css };
        const newId = await db.bubbleStylePresets.add(newPreset);
        
        if (!state.bubbleStylePresets) state.bubbleStylePresets = [];
        state.bubbleStylePresets.push({ id: newId, ...newPreset });

        renderBubblePresetSelector(); 
        document.getElementById('bubble-style-preset-select').value = newId; 
        document.getElementById('preset-actions-modal').classList.remove('visible');
        await showCustomAlert('', ` "${name.trim()}" `);
    }
}

/**
 * 
 */
async function updateSelectedPreset(presetId) {
    const customCssInput = document.getElementById('custom-css-input');
    const css = customCssInput.value.trim();

    const preset = state.bubbleStylePresets.find(p => p.id === presetId);
    if (preset) {
        preset.css = css;
        await db.bubbleStylePresets.put(preset);
        document.getElementById('preset-actions-modal').classList.remove('visible');
        await showCustomAlert('', ` "${preset.name}" `);
    }
}

/**
 * 
 */
async function deleteSelectedPreset(presetId) {
    const preset = state.bubbleStylePresets.find(p => p.id === presetId);
    if (preset) {
        const confirmed = await showCustomConfirm('', ` "${preset.name}" `, { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.bubbleStylePresets.delete(presetId);
            state.bubbleStylePresets = state.bubbleStylePresets.filter(p => p.id !== presetId);

            renderBubblePresetSelector(); 
            document.getElementById('custom-css-input').value = '';
            updateSettingsPreview();

            document.getElementById('preset-actions-modal').classList.remove('visible');
            await showCustomAlert('', '');
        }
    }
}

//   

/**
 * 
 */
function playRingtone() {
    const ringtonePlayer = document.getElementById('ringtone-player');
    // URLURL
    const ringtoneUrl = state.globalSettings.ringtoneUrl || 'https://files.catbox.moe/3w7gla.mp3';
    
    if (ringtonePlayer && ringtoneUrl) {
        ringtonePlayer.src = ringtoneUrl;
        // play()  Promise try...catch 
        const playPromise = ringtonePlayer.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.error(":", error);
                // 
            });
        }
    }
}

/**
 * 
 */
function stopRingtone() {
    const ringtonePlayer = document.getElementById('ringtone-player');
    if (ringtonePlayer) {
        ringtonePlayer.pause();
        ringtonePlayer.currentTime = 0; // 
    }
}
//   

//   
function unlockAudioContext() {
    const ringtonePlayer = document.getElementById('ringtone-player');
    // 
    if (ringtonePlayer && ringtonePlayer.paused) {
        // 
        // 
        ringtonePlayer.play().catch(() => {}); // play()  Promise
        ringtonePlayer.pause();
        console.log("Ringtone audio context unlocked.");
    }
}
//   

//   

/**
 *  #lock-screen 
 */
function applyLockscreenWallpaper() {
    const lockScreen = document.getElementById('lock-screen');
    const wallpaper = state.globalSettings.lockscreenWallpaper;
    if (wallpaper && wallpaper.startsWith('data:image')) {
        lockScreen.style.backgroundImage = `url(${wallpaper})`;
    } else if (wallpaper) {
        lockScreen.style.backgroundImage = wallpaper;
    }
}

/**
 * 
 */
function lockPhone() {
    console.log("...");
    isLocked = true;
    document.getElementById('lock-screen').classList.add('active');
    document.querySelectorAll('.screen:not(#lock-screen)').forEach(s => s.classList.remove('active'));
}

/**
 * 
 */
function unlockPhone() {
    console.log("");
    isLocked = false;
        // 
    document.getElementById('lock-screen').classList.remove('active');
    const blurBg = document.getElementById('lock-screen-background-blur');
    blurBg.style.display = 'none';
    blurBg.style.opacity = '0';

    // 
    showScreen('home-screen'); 

    // 
    setTimeout(() => {
        const lockScreen = document.getElementById('lock-screen');
        const unlockHint = document.getElementById('unlock-hint');
        lockScreen.style.transition = 'none'; 
        unlockHint.style.transition = 'none';
        lockScreen.style.transform = 'translateY(0)';
        lockScreen.offsetHeight; 
        lockScreen.style.transition = 'transform 0.3s ease-out';
        unlockHint.style.transition = 'opacity 0.3s ease-out';
    }, 500); 
}

/**
 * 
 */
function showPasswordModal() {
    const modal = document.getElementById('password-modal-overlay');
    const input = document.getElementById('password-input-field');
    input.value = ''; // 
    modal.classList.add('visible');
    setTimeout(() => input.focus(), 100); // 
}

/**
 * 
 */
function hidePasswordModal() {

document.getElementById('password-modal-overlay').style.backgroundImage = 'none';

    const modal = document.getElementById('password-modal-overlay');
    modal.classList.remove('visible');
    // 
    modal.querySelector('.password-modal-content').classList.remove('error');
    // ...
    // 1. 
    const blurBg = document.getElementById('lock-screen-background-blur');
    blurBg.style.opacity = '0';
    setTimeout(() => { blurBg.style.display = 'none'; }, 300); // 

    // 2. 
    const lockScreen = document.getElementById('lock-screen');
    const unlockHint = document.getElementById('unlock-hint');
    lockScreen.style.transform = 'translateY(0)';
    unlockHint.style.opacity = '1';
}

/**
 * 
 */
function checkPassword() {
    const input = document.getElementById('password-input-field');
    const enteredPassword = input.value;
    const correctPassword = state.globalSettings.password;

    if (enteredPassword === correctPassword) {
        // ---  ---

        // 1. 
        //     z-index 
        showScreen('home-screen');

        // 2.  ()
        document.getElementById('password-modal-overlay').classList.remove('visible');
        
        // 3. 
        document.getElementById('lock-screen-background-blur').style.opacity = '0';
        
        // 4.  (300)
        setTimeout(unlockPhone, 300);

    } else {
        // ---  () ---
        const content = document.querySelector('.password-modal-content');
        content.classList.add('error');
        input.value = '';
        setTimeout(() => content.classList.remove('error'), 400);
    }
}

/**
 * 
 */
function updateLockClock() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' });
    document.getElementById('lock-main-time').textContent = timeString;
    document.getElementById('lock-main-date').textContent = dateString;
}

//   

        // ===================================================================
        // 4.  init()
        // ===================================================================
        async function init() {

    //   init()  
    const savedTheme = localStorage.getItem('ephone-theme') || 'light'; // 
    applyTheme(savedTheme);
    //   

    //   
    const customBubbleStyleTag = document.createElement('style');
    customBubbleStyleTag.id = 'custom-bubble-style';
    document.head.appendChild(customBubbleStyleTag);
    //   

    //   
    const previewBubbleStyleTag = document.createElement('style');
    previewBubbleStyleTag.id = 'preview-bubble-style';
    document.head.appendChild(previewBubbleStyleTag);
    //   


    //   
    applyScopedCss('', '#chat-messages', 'custom-bubble-style'); // 
    applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // 
    //   

            window.showScreen = showScreen;
            window.renderChatListProxy = renderChatList;
            window.renderApiSettingsProxy = renderApiSettings;
            window.renderWallpaperScreenProxy = renderWallpaperScreen;
            window.renderWorldBookScreenProxy = renderWorldBookScreen;

            await loadAllDataFromDB();

            // 
            const storedCount = parseInt(localStorage.getItem('unreadPostsCount')) || 0;
            updateUnreadIndicator(storedCount);
            
            //   

            if (state.globalSettings && state.globalSettings.fontUrl) {
                applyCustomFont(state.globalSettings.fontUrl);
            }

    //   
    // 
    if (state.globalSettings.activeThemeId) {
        const activeTheme = await db.themes.get(state.globalSettings.activeThemeId);
        if (activeTheme) {
            console.log(`: "${activeTheme.name}"`);
            applyThemeCss(activeTheme.css);
        }
    }
    //   

            updateClock();
            setInterval(updateClock, 1000 * 30);
            applyGlobalWallpaper();
            initBatteryManager(); 

applyAppIcons();

            // ==========================================================
            // ---  ---
            // ==========================================================

//   init()  
document.getElementById('phone-screen').addEventListener('click', unlockAudioContext, { once: true });
//   
            document.getElementById('custom-modal-cancel').addEventListener('click', hideCustomModal);
            document.getElementById('custom-modal-overlay').addEventListener('click', (e) => { if (e.target === modalOverlay) hideCustomModal(); });
            document.getElementById('export-data-btn').addEventListener('click', exportBackup);
            document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-data-input').click());
            document.getElementById('import-data-input').addEventListener('change', e => importBackup(e.target.files[0]));
            document.getElementById('back-to-list-btn').addEventListener('click', () => { 

    //   
    applyScopedCss('', '#chat-messages', 'custom-bubble-style'); // 
    applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // 
    //   

exitSelectionMode(); state.activeChatId = null; showScreen('chat-list-screen'); });
            
            document.getElementById('add-chat-btn').addEventListener('click', async () => { const name = await showCustomPrompt('', 'Ta'); if (name && name.trim()) { const newChatId = 'chat_' + Date.now(); 
const newChat = { 
    id: newChatId, 
    name: name.trim(), 
isGroup: false,
isPinned: false,                    relationship: {
                            status: 'friend', // 'friend', 'blocked_by_user', 'pending_user_approval'
                            blockedTimestamp: null,
                            applicationReason: ''
                        },
                        status: {
                            text: '',
                            lastUpdate: Date.now(),
                            isBusy: false 
                        },
    settings: { 
        aiPersona: '', 
        myPersona: '', 
        maxMemory: 10, 
        aiAvatar: defaultAvatar, 
        myAvatar: defaultAvatar, 
        background: '', 
        theme: 'default', 
    fontSize: 13, 
    customCss: '', // <--- 
    linkedWorldBookIds: [], 
    aiAvatarLibrary: [],
    }, 
    history: [], 
    musicData: { totalTime: 0 } 
};
state.chats[newChatId] = newChat; await db.chats.put(newChat); renderChatList(); } });

            //   
document.getElementById('add-group-chat-btn').addEventListener('click', openContactPickerForGroupCreate);
//                         
            document.getElementById('transfer-cancel-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.remove('visible'));
            document.getElementById('transfer-confirm-btn').addEventListener('click', sendUserTransfer);

            document.getElementById('listen-together-btn').addEventListener('click', handleListenTogetherClick);
            document.getElementById('music-exit-btn').addEventListener('click', () => endListenTogetherSession(true));
            document.getElementById('music-return-btn').addEventListener('click', returnToChat);
            document.getElementById('music-play-pause-btn').addEventListener('click', togglePlayPause);
            document.getElementById('music-next-btn').addEventListener('click', playNext);
            document.getElementById('music-prev-btn').addEventListener('click', playPrev);
            document.getElementById('music-mode-btn').addEventListener('click', changePlayMode);
            document.getElementById('music-playlist-btn').addEventListener('click', () => { updatePlaylistUI(); document.getElementById('music-playlist-panel').classList.add('visible'); });
            document.getElementById('close-playlist-btn').addEventListener('click', () => document.getElementById('music-playlist-panel').classList.remove('visible'));
            document.getElementById('add-song-url-btn').addEventListener('click', addSongFromURL);
            document.getElementById('add-song-local-btn').addEventListener('click', () => document.getElementById('local-song-upload-input').click());
            document.getElementById('local-song-upload-input').addEventListener('change', addSongFromLocal);
            audioPlayer.addEventListener('ended', playNext);
            audioPlayer.addEventListener('pause', () => { if(musicState.isActive) { musicState.isPlaying = false; updatePlayerUI(); } });
            audioPlayer.addEventListener('play', () => { if(musicState.isActive) { musicState.isPlaying = true; updatePlayerUI(); } });

            const chatInput = document.getElementById('chat-input');
            //   id="send-btn"  click  
document.getElementById('send-btn').addEventListener('click', async () => { 
    const content = chatInput.value.trim(); 
    if (!content || !state.activeChatId) return; 
    
    const chat = state.chats[state.activeChatId]; 
    
    // ---  ---
    const msg = { 
        role: 'user', 
        content, 
        timestamp: Date.now() 
    };

    // 
    if (currentReplyContext) {
        msg.quote = currentReplyContext; // 
    }
    // ---  ---
    
    chat.history.push(msg); 
    await db.chats.put(chat); 
    appendMessage(msg, chat); 
    renderChatList(); 
    chatInput.value = ''; 
    chatInput.style.height = 'auto'; 
    chatInput.focus(); 
    
    // ---  ---
    cancelReplyMode(); 
});
            document.getElementById('wait-reply-btn').addEventListener('click', triggerAiResponse);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('send-btn').click(); } });
            chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = (chatInput.scrollHeight) + 'px'; });

            document.getElementById('wallpaper-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if(file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); newWallpaperBase64 = dataUrl; renderWallpaperScreen(); } });
            //   save-wallpaper-btn  
document.getElementById('save-wallpaper-btn').addEventListener('click', async () => {
    let changesMade = false;

    // 
    if (newWallpaperBase64) {
        state.globalSettings.wallpaper = newWallpaperBase64;
        changesMade = true;
    }

    //  ()
    if (newLockscreenWallpaperBase64) {
        state.globalSettings.lockscreenWallpaper = newLockscreenWallpaperBase64;
        changesMade = true;
    }
    //  ()
    const newPassword = document.getElementById('password-set-input').value;
    state.globalSettings.password = newPassword;

state.globalSettings.ringtoneUrl = document.getElementById('ringtone-url-input').value.trim();

    //   
    // ID
    const activeThemeSelector = document.getElementById('theme-selector');
    if (activeThemeSelector.value) {
        state.globalSettings.activeThemeId = parseInt(activeThemeSelector.value);
    } else {
        // --  --
        state.globalSettings.activeThemeId = null;
    }
    //   
    
    await db.globalSettings.put(state.globalSettings);

    // 
    if (changesMade) {
        applyGlobalWallpaper();        applyLockscreenWallpaper(); // <-- 
        newWallpaperBase64 = null;        newLockscreenWallpaperBase64 = null; // <-- 
    }
    applyAppIcons(); // 

    alert('');
    showScreen('home-screen');
});
//   
            document.getElementById('save-api-settings-btn').addEventListener('click', async () => { 

//   
const proxyUrlToCheck = document.getElementById('proxy-url').value.trim();
const isBlocked = BLOCKED_API_SITES.some(blockedDomain => proxyUrlToCheck.includes(blockedDomain));

if (isBlocked) {
    alert(' API ');
    return; // 
}
//   

state.apiConfig.proxyUrl = document.getElementById('proxy-url').value.trim(); state.apiConfig.apiKey = document.getElementById('api-key').value.trim(); state.apiConfig.model = document.getElementById('model-select').value; await db.apiConfig.put(state.apiConfig); 

//  'save-api-settings-btn'  click 
// await db.apiConfig.put(state.apiConfig); 

//   

const backgroundSwitch = document.getElementById('background-activity-switch');
const intervalInput = document.getElementById('background-interval-input');
const newEnableState = backgroundSwitch.checked;
const oldEnableState = state.globalSettings.enableBackgroundActivity || false;

// 
if (newEnableState && !oldEnableState) {
    const userConfirmed = confirm(
        "\n\n" +
        "\n\n" +
        "AI\n\n" +
        "\n" +
        "APIAPI\n\n" +
        ""
    );

    if (!userConfirmed) {
        backgroundSwitch.checked = false; // 
        return; // 
    }
}

state.globalSettings.enableBackgroundActivity = newEnableState;
state.globalSettings.backgroundActivityInterval = parseInt(intervalInput.value) || 60;
state.globalSettings.blockCooldownHours = parseFloat(document.getElementById('block-cooldown-input').value) || 1;
await db.globalSettings.put(state.globalSettings);

// 
stopBackgroundSimulation();
if (state.globalSettings.enableBackgroundActivity) {
    startBackgroundSimulation();
    console.log(`: ${state.globalSettings.backgroundActivityInterval}`);
} else {
    console.log("");
}
//   

alert('API!'); });

                    // gemini 
        const ApiKeyInput = document.getElementById('api-key')
        ApiKeyInput.addEventListener('focus', (e) => {
            e.target.setAttribute('type', 'text')
        })
        ApiKeyInput.addEventListener('blur', (e) => {
            e.target.setAttribute('type', 'password')
        })


        document.getElementById('fetch-models-btn').addEventListener('click', async () => {
            const url = document.getElementById('proxy-url').value.trim();
            const key = document.getElementById('api-key').value.trim();
            if (!url || !key) return alert('');
            try {

                let  isGemini = url === GEMINI_API_URL;
                const response = await fetch(isGemini ? `${GEMINI_API_URL}?key=${getRandomValue(key)}` : `${url}/v1/models`,isGemini ? undefined : {headers: {'Authorization': `Bearer ${key}`}});
                if (!response.ok) throw new Error('');
                const data = await response.json();
                let models = isGemini ? data.models : data.data;
                if(isGemini){
                    models = models.map((model)=>{
                        const parts = model.name.split('/');
                        return {
                            id:parts.length > 1 ? parts[1] : model.name
                        }
                    })
                }
                const modelSelect = document.getElementById('model-select');
                modelSelect.innerHTML = '';
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    if (model.id === state.apiConfig.model) option.selected = true;
                    modelSelect.appendChild(option);
                });
                alert('');
            } catch (error) {
                alert(`: ${error.message}`);
            }
        });
            document.getElementById('add-world-book-btn').addEventListener('click', async () => { const name = await showCustomPrompt('', ''); if (name && name.trim()) { const newBook = { id: 'wb_' + Date.now(), name: name.trim(), content: '' }; await db.worldBooks.add(newBook); state.worldBooks.push(newBook); renderWorldBookScreen(); openWorldBookEditor(newBook.id); } });
            document.getElementById('save-world-book-btn').addEventListener('click', async () => { if (!editingWorldBookId) return; const book = state.worldBooks.find(wb => wb.id === editingWorldBookId); if (book) { const newName = document.getElementById('world-book-name-input').value.trim(); if (!newName) { alert(''); return; } book.name = newName; book.content = document.getElementById('world-book-content-input').value; 

        //  ID 
        const categoryId = document.getElementById('world-book-category-select').value;
        //  nullID
        book.categoryId = categoryId ? parseInt(categoryId) : null; 
        //   

await db.worldBooks.put(book); document.getElementById('world-book-editor-title').textContent = newName; editingWorldBookId = null; renderWorldBookScreen(); showScreen('world-book-screen'); } });
            document.getElementById('chat-messages').addEventListener('click', (e) => { const aiImage = e.target.closest('.ai-generated-image'); if (aiImage) { const description = aiImage.dataset.description; if (description) showCustomAlert('', description); return; }  });
            
            const chatSettingsModal = document.getElementById('chat-settings-modal');
            const worldBookSelectBox = document.querySelector('.custom-multiselect .select-box');
            const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');

function updateWorldBookSelectionDisplay() { const checkedBoxes = worldBookCheckboxesContainer.querySelectorAll('input:checked'); const displayText = document.querySelector('.selected-options-text'); if (checkedBoxes.length === 0) { displayText.textContent = '--  --'; } else if (checkedBoxes.length > 2) { displayText.textContent = ` ${checkedBoxes.length} `; } else { displayText.textContent = Array.from(checkedBoxes).map(cb => cb.parentElement.textContent.trim()).join(', '); } }        
            
            worldBookSelectBox.addEventListener('click', (e) => { e.stopPropagation(); worldBookCheckboxesContainer.classList.toggle('visible'); worldBookSelectBox.classList.toggle('expanded'); });
            document.getElementById('world-book-checkboxes-container').addEventListener('change', updateWorldBookSelectionDisplay);
            window.addEventListener('click', (e) => { if (!document.querySelector('.custom-multiselect').contains(e.target)) { worldBookCheckboxesContainer.classList.remove('visible'); worldBookSelectBox.classList.remove('expanded'); } });

//   chat-settings-btn  
document.getElementById('chat-settings-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const isGroup = chat.isGroup;

    // --- / ---
    document.getElementById('chat-name-group').style.display = 'block';
    document.getElementById('my-persona-group').style.display = 'block';
    document.getElementById('my-avatar-group').style.display = 'block';
    document.getElementById('my-group-nickname-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('group-avatar-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('group-members-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('ai-persona-group').style.display = isGroup ? 'none' : 'block';
    document.getElementById('ai-avatar-group').style.display = isGroup ? 'none' : 'block';
    
    // 1
    document.getElementById('assign-group-section').style.display = isGroup ? 'none' : 'block';
    
    // ---  ---
    document.getElementById('chat-name-input').value = chat.name;
    document.getElementById('my-persona').value = chat.settings.myPersona;
    document.getElementById('my-avatar-preview').src = chat.settings.myAvatar || (isGroup ? defaultMyGroupAvatar : defaultAvatar);
    document.getElementById('max-memory').value = chat.settings.maxMemory;
    const bgPreview = document.getElementById('bg-preview');
    const removeBgBtn = document.getElementById('remove-bg-btn');
    if (chat.settings.background) {
        bgPreview.src = chat.settings.background;
        bgPreview.style.display = 'block';
        removeBgBtn.style.display = 'inline-block';
    } else {
        bgPreview.style.display = 'none';
        removeBgBtn.style.display = 'none';
    }

    if (isGroup) {
        document.getElementById('my-group-nickname-input').value = chat.settings.myNickname || '';
        document.getElementById('group-avatar-preview').src = chat.settings.groupAvatar || defaultGroupAvatar;
        renderGroupMemberSettings(chat.members);
    } else {
        document.getElementById('ai-persona').value = chat.settings.aiPersona;
        document.getElementById('ai-avatar-preview').src = chat.settings.aiAvatar || defaultAvatar;
        
        // 2
        const select = document.getElementById('assign-group-select');
        select.innerHTML = '<option value=""></option>'; // 
        const groups = await db.qzoneGroups.toArray();
        groups.forEach(group => {
            const option = document.createElement('option');
            option.value = group.id;
            option.textContent = group.name;
            // 
            if (chat.groupId === group.id) {
                option.selected = true;
            }
            select.appendChild(option);
        }); 
    }
    
    // 
//   forEach  

const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
worldBookCheckboxesContainer.innerHTML = '';
const linkedIds = new Set(chat.settings.linkedWorldBookIds || []);

// 1. 
const categories = await db.worldBookCategories.toArray();
const books = state.worldBooks;

// 
const hasUncategorized = books.some(book => !book.categoryId);
if (hasUncategorized) {
    categories.push({ id: 'uncategorized', name: '' });
}

// 2. ID
const booksByCategoryId = books.reduce((acc, book) => {
    const categoryId = book.categoryId || 'uncategorized';
    if (!acc[categoryId]) {
        acc[categoryId] = [];
    }
    acc[categoryId].push(book);
    return acc;
}, {});

// 3. 
categories.forEach(category => {
    const booksInCategory = booksByCategoryId[category.id] || [];
    if (booksInCategory.length > 0) {
        const allInCategoryChecked = booksInCategory.every(book => linkedIds.has(book.id));
        
        const header = document.createElement('div');
        header.className = 'wb-category-header';
        header.innerHTML = `
            <span class="arrow"></span>
            <input type="checkbox" class="wb-category-checkbox" data-category-id="${category.id}" ${allInCategoryChecked ? 'checked' : ''}>
            <span>${category.name}</span>
        `;
        
        const bookContainer = document.createElement('div');
        bookContainer.className = 'wb-book-container';
        bookContainer.dataset.containerFor = category.id;

        booksInCategory.forEach(book => {
            const isChecked = linkedIds.has(book.id);
            const label = document.createElement('label');
    label.innerHTML = `<input type="checkbox" class="wb-book-checkbox" value="${book.id}" data-parent-category="${category.id}" ${isChecked ? 'checked' : ''}> ${book.name}`;
    bookContainer.appendChild(label);
});

        // ---   #1   ---
        // 
        header.classList.add('collapsed');
        bookContainer.classList.add('collapsed');
        // ---    ---

        worldBookCheckboxesContainer.appendChild(header);
        worldBookCheckboxesContainer.appendChild(bookContainer);
    }
});

updateWorldBookSelectionDisplay(); // 

//   

//   updateWorldBookSelectionDisplay();  

// 
worldBookCheckboxesContainer.addEventListener('click', (e) => {
    const header = e.target.closest('.wb-category-header');
    if (header && !e.target.matches('input[type="checkbox"]')) {
        const categoryId = header.querySelector('.wb-category-checkbox')?.dataset.categoryId;
        //  categoryId  "uncategorized" 
        if (categoryId) { // <--  !categoryId return; 
            const bookContainer = worldBookCheckboxesContainer.querySelector(`.wb-book-container[data-container-for="${categoryId}"]`);
            if (bookContainer) {
                header.classList.toggle('collapsed');
                bookContainer.classList.toggle('collapsed');
            }
        }
    }
});

worldBookCheckboxesContainer.addEventListener('change', (e) => {
    const target = e.target;
    
    // 
    if (target.classList.contains('wb-category-checkbox')) {
        const categoryId = target.dataset.categoryId;
        const isChecked = target.checked;
        // 
        const bookCheckboxes = worldBookCheckboxesContainer.querySelectorAll(`input.wb-book-checkbox[data-parent-category="${categoryId}"]`);
        bookCheckboxes.forEach(cb => cb.checked = isChecked);
    }
    
    // 
    if (target.classList.contains('wb-book-checkbox')) {
        const categoryId = target.dataset.parentCategory;
        if (categoryId) { // 
            const categoryCheckbox = worldBookCheckboxesContainer.querySelector(`input.wb-category-checkbox[data-category-id="${categoryId}"]`);
            const allBookCheckboxes = worldBookCheckboxesContainer.querySelectorAll(`input.wb-book-checkbox[data-parent-category="${categoryId}"]`);
            // 
            const allChecked = Array.from(allBookCheckboxes).every(cb => cb.checked);
            // 
            categoryCheckbox.checked = allChecked;
        }
    }
    
    // 
    updateWorldBookSelectionDisplay();
});

//   

    // 
    const themeRadio = document.querySelector(`input[name="theme-select"][value="${chat.settings.theme || 'default'}"]`);
    if (themeRadio) themeRadio.checked = true;
    const fontSizeSlider = document.getElementById('font-size-slider');
    fontSizeSlider.value = chat.settings.fontSize || 13;
    document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
    const customCssInput = document.getElementById('custom-css-input');
    customCssInput.value = chat.settings.customCss || '';
    
    updateSettingsPreview(); 

// 
renderBubblePresetSelector();
document.getElementById('bubble-style-preset-select').addEventListener('change', handlePresetSelectChange);
document.getElementById('manage-bubble-presets-btn').addEventListener('click', openBubblePresetManager);
    document.getElementById('chat-settings-modal').classList.add('visible');
});
//   
            
function renderGroupMemberSettings(members) { 
    const container = document.getElementById('group-members-settings'); 
    container.innerHTML = ''; 
    members.forEach(member => { 
        const div = document.createElement('div'); 
        div.className = 'member-editor'; 
        div.dataset.memberId = member.id; 
        // 
        //  groupNickname
        div.innerHTML = `<img src="${member.avatar}" alt="${member.groupNickname}"><div class="member-name">${member.groupNickname}</div>`; 
        div.addEventListener('click', () => openMemberEditor(member.id)); 
        container.appendChild(div); 
    }); 
}

function openMemberEditor(memberId) { 
    editingMemberId = memberId; 
    const chat = state.chats[state.activeChatId]; 
    const member = chat.members.find(m => m.id === memberId); 
    document.getElementById('member-name-input').value = member.groupNickname; 
    document.getElementById('member-persona-input').value = member.persona; 
    document.getElementById('member-avatar-preview').src = member.avatar; 
    document.getElementById('member-settings-modal').classList.add('visible'); 
}
            document.getElementById('cancel-member-settings-btn').addEventListener('click', () => { document.getElementById('member-settings-modal').classList.remove('visible'); editingMemberId = null; });
            document.getElementById('save-member-settings-btn').addEventListener('click', () => { 
    if (!editingMemberId) return; 
    const chat = state.chats[state.activeChatId]; 
    const member = chat.members.find(m => m.id === editingMemberId); 
    
    // 
    const newNickname = document.getElementById('member-name-input').value.trim();
    if (!newNickname) {
        alert("");
        return;
    }
    member.groupNickname = newNickname; // 
    member.persona = document.getElementById('member-persona-input').value; 
    member.avatar = document.getElementById('member-avatar-preview').src; 
    
    renderGroupMemberSettings(chat.members); 
    document.getElementById('member-settings-modal').classList.remove('visible'); 
});
            document.getElementById('reset-theme-btn').addEventListener('click', () => { document.getElementById('theme-default').checked = true; });
            document.getElementById('cancel-chat-settings-btn').addEventListener('click', () => { chatSettingsModal.classList.remove('visible'); });

document.getElementById('save-chat-settings-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const newName = document.getElementById('chat-name-input').value.trim();
    if (!newName) return alert('/');
    chat.name = newName;
    const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked');
    chat.settings.theme = selectedThemeRadio ? selectedThemeRadio.value : 'default';

    chat.settings.fontSize = parseInt(document.getElementById('font-size-slider').value);
    chat.settings.customCss = document.getElementById('custom-css-input').value.trim();

    chat.settings.myPersona = document.getElementById('my-persona').value;
    chat.settings.myAvatar = document.getElementById('my-avatar-preview').src;
const checkedBooks = document.querySelectorAll('#world-book-checkboxes-container input.wb-book-checkbox:checked');
    chat.settings.linkedWorldBookIds = Array.from(checkedBooks).map(cb => cb.value);

    if (chat.isGroup) {
        chat.settings.myNickname = document.getElementById('my-group-nickname-input').value.trim();
        chat.settings.groupAvatar = document.getElementById('group-avatar-preview').src;
    } else {
        chat.settings.aiPersona = document.getElementById('ai-persona').value;
        chat.settings.aiAvatar = document.getElementById('ai-avatar-preview').src;
        const selectedGroupId = document.getElementById('assign-group-select').value;
        chat.groupId = selectedGroupId ? parseInt(selectedGroupId) : null;
    }

    chat.settings.maxMemory = parseInt(document.getElementById('max-memory').value) || 10;
    await db.chats.put(chat);

    applyScopedCss(chat.settings.customCss, '#chat-messages', 'custom-bubble-style');
    
    chatSettingsModal.classList.remove('visible');
    renderChatInterface(state.activeChatId);
    renderChatList();
});
            document.getElementById('clear-chat-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const confirmed = await showCustomConfirm('', '', { confirmButtonClass: 'btn-danger' }); if (confirmed) { chat.history = []; await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); chatSettingsModal.classList.remove('visible'); } });
            
            const setupFileUpload = (inputId, callback) => { document.getElementById(inputId).addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); callback(dataUrl); event.target.value = null; } }); };
            setupFileUpload('ai-avatar-input', (base64) => document.getElementById('ai-avatar-preview').src = base64);
            setupFileUpload('my-avatar-input', (base64) => document.getElementById('my-avatar-preview').src = base64);
            setupFileUpload('group-avatar-input', (base64) => document.getElementById('group-avatar-preview').src = base64);
            setupFileUpload('member-avatar-input', (base64) => document.getElementById('member-avatar-preview').src = base64);
            setupFileUpload('bg-input', (base64) => { if(state.activeChatId) { state.chats[state.activeChatId].settings.background = base64; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = base64; bgPreview.style.display = 'block'; document.getElementById('remove-bg-btn').style.display = 'inline-block'; } });
            setupFileUpload('preset-avatar-input', (base64) => document.getElementById('preset-avatar-preview').src = base64);
            document.getElementById('remove-bg-btn').addEventListener('click', () => { if (state.activeChatId) { state.chats[state.activeChatId].settings.background = ''; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = ''; bgPreview.style.display = 'none'; document.getElementById('remove-bg-btn').style.display = 'none'; } });

            const stickerPanel = document.getElementById('sticker-panel');
            document.getElementById('open-sticker-panel-btn').addEventListener('click', () => { renderStickerPanel(); stickerPanel.classList.add('visible'); });
            document.getElementById('close-sticker-panel-btn').addEventListener('click', () => stickerPanel.classList.remove('visible'));
            document.getElementById('add-sticker-btn').addEventListener('click', async () => { const url = await showCustomPrompt("(URL)", "URL"); if (!url || !url.trim().startsWith('http')) return url && alert("URL (http)"); const name = await showCustomPrompt("", " ()"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: url.trim(), name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert(""); });
            document.getElementById('upload-sticker-btn').addEventListener('click', () => document.getElementById('sticker-upload-input').click());
            document.getElementById('sticker-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = async () => { const base64Url = reader.result; const name = await showCustomPrompt("", " ()"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: base64Url, name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert(""); }; event.target.value = null; });

            document.getElementById('upload-image-btn').addEventListener('click', () => document.getElementById('image-upload-input').click());
            document.getElementById('image-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file || !state.activeChatId) return; const reader = new FileReader(); reader.onload = async (e) => { const base64Url = e.target.result; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: [{ type: 'image_url', image_url: { url: base64Url } }], timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); }; reader.readAsDataURL(file); event.target.value = null; });
            document.getElementById('voice-message-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const text = await showCustomPrompt("", ""); if (text && text.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'voice_message', content: text.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
            document.getElementById('send-photo-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const description = await showCustomPrompt("", ""); if (description && description.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'user_photo', content: description.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });

//   
const waimaiModal = document.getElementById('waimai-request-modal');
document.getElementById('send-waimai-request-btn').addEventListener('click', () => {
    waimaiModal.classList.add('visible');
});

document.getElementById('waimai-cancel-btn').addEventListener('click', () => {
    waimaiModal.classList.remove('visible');
});

document.getElementById('waimai-confirm-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    
    const productInfoInput = document.getElementById('waimai-product-info');
    const amountInput = document.getElementById('waimai-amount');
    
    const productInfo = productInfoInput.value.trim();
    const amount = parseFloat(amountInput.value);

    if (!productInfo) {
        alert('');
        return;
    }
    if (isNaN(amount) || amount <= 0) {
        alert('');
        return;
    }

    const chat = state.chats[state.activeChatId];
    const now = Date.now();

    // 
    const myNickname = chat.isGroup ? (chat.settings.myNickname || '') : '';
    
    const msg = {
        role: 'user',
        //  senderName 
        senderName: myNickname, 
        type: 'waimai_request',
        productInfo: productInfo,
        amount: amount,
        status: 'pending',
        countdownEndTime: now + 15 * 60 * 1000,
        timestamp: now
    };

    chat.history.push(msg);
    await db.chats.put(chat);
    appendMessage(msg, chat);
    renderChatList();

    productInfoInput.value = '';
    amountInput.value = '';
    waimaiModal.classList.remove('visible');
});         
            document.getElementById('open-persona-library-btn').addEventListener('click', openPersonaLibrary);
            document.getElementById('close-persona-library-btn').addEventListener('click', closePersonaLibrary);
            document.getElementById('add-persona-preset-btn').addEventListener('click', openPersonaEditorForCreate);
            document.getElementById('cancel-persona-editor-btn').addEventListener('click', closePersonaEditor);
            document.getElementById('save-persona-preset-btn').addEventListener('click', savePersonaPreset);
            document.getElementById('preset-action-edit').addEventListener('click', openPersonaEditorForEdit);
            document.getElementById('preset-action-delete').addEventListener('click', deletePersonaPreset);
            document.getElementById('preset-action-cancel').addEventListener('click', hidePresetActions);
            
            document.getElementById('selection-cancel-btn').addEventListener('click', exitSelectionMode);

//   selection-delete-btn  
document.getElementById('selection-delete-btn').addEventListener('click', async () => {
    if (selectedMessages.size === 0) return;
    const confirmed = await showCustomConfirm('', ` ${selectedMessages.size} AI`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        const chat = state.chats[state.activeChatId];
        
        // 1. 
        let deletedPollsInfo = [];
        for (const timestamp of selectedMessages) {
            const msg = chat.history.find(m => m.timestamp === timestamp);
            if (msg && msg.type === 'poll') {
                deletedPollsInfo.push(`${msg.question}(: ${msg.timestamp})`);
            }
        }
        
        // 2. 
        chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp));
        
        // 3. 
        let forgetReason = "";
        if (deletedPollsInfo.length > 0) {
            forgetReason += ` ${deletedPollsInfo.join('')}`;
        }
        forgetReason += " ";

        const forgetInstruction = {
            role: 'system',
            content: `[${forgetReason}]`,
            timestamp: Date.now(),
            isHidden: true 
        };
        chat.history.push(forgetInstruction);
        
        // 4. chat
        await db.chats.put(chat);
        
        // 5. UI
        renderChatInterface(state.activeChatId);
        renderChatList();
    }
});
//   

            const fontUrlInput = document.getElementById('font-url-input');
            fontUrlInput.addEventListener('input', () => applyCustomFont(fontUrlInput.value.trim(), true));
            document.getElementById('save-font-btn').addEventListener('click', async () => {
                const newFontUrl = fontUrlInput.value.trim();
                if (!newFontUrl) { alert("URL"); return; }
                applyCustomFont(newFontUrl, false);
                state.globalSettings.fontUrl = newFontUrl;
                await db.globalSettings.put(state.globalSettings);
                alert('');
            });
            document.getElementById('reset-font-btn').addEventListener('click', resetToDefaultFont);

            document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => { item.addEventListener('click', () => switchToChatListView(item.dataset.view)); });
            document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
            document.getElementById('qzone-nickname').addEventListener('click', async () => { const newNickname = await showCustomPrompt("", "", state.qzoneSettings.nickname); if (newNickname && newNickname.trim()) { state.qzoneSettings.nickname = newNickname.trim(); await saveQzoneSettings(); renderQzoneScreen(); } });
            document.getElementById('qzone-avatar-container').addEventListener('click', () => document.getElementById('qzone-avatar-input').click());
            document.getElementById('qzone-banner-container').addEventListener('click', () => document.getElementById('qzone-banner-input').click());
            document.getElementById('qzone-avatar-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.avatar = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });
            document.getElementById('qzone-banner-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.banner = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });

//   
document.getElementById('create-shuoshuo-btn').addEventListener('click', async () => {
    // 1. 
    resetCreatePostModal();
    const modal = document.getElementById('create-post-modal');
    
    // 2. 
    modal.dataset.mode = 'shuoshuo';
    
    // 3. /
    modal.querySelector('.post-mode-switcher').style.display = 'none';
    modal.querySelector('#image-mode-content').style.display = 'none';
    modal.querySelector('#text-image-mode-content').style.display = 'none';
    
    // 4. 
    modal.querySelector('#post-public-text').placeholder = '...';
    
    // 5. 
    const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
    visibilityGroupsContainer.innerHTML = '';
    const groups = await db.qzoneGroups.toArray();
    if (groups.length > 0) {
        groups.forEach(group => {
            const label = document.createElement('label');
            label.style.display = 'block';
            label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
            visibilityGroupsContainer.appendChild(label);
        });
    } else {
        visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);"></p>';
    }
    modal.classList.add('visible');
});

//   
document.getElementById('create-post-btn').addEventListener('click', async () => {
    // 1. 
    resetCreatePostModal();
    const modal = document.getElementById('create-post-modal');
    
    // 2. 
    modal.dataset.mode = 'complex';
    
// 3. /
modal.querySelector('.post-mode-switcher').style.display = 'flex';
// ...
modal.querySelector('#image-mode-content').classList.add('active');
// ...
modal.querySelector('#text-image-mode-content').classList.remove('active');
    
    // 4. 
    modal.querySelector('#post-public-text').placeholder = '...';

    // 5. 
    const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
    visibilityGroupsContainer.innerHTML = '';
    const groups = await db.qzoneGroups.toArray();
    if (groups.length > 0) {
        groups.forEach(group => {
            const label = document.createElement('label');
            label.style.display = 'block';
            label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
            visibilityGroupsContainer.appendChild(label);
        });
    } else {
        visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);"></p>';
    }
    modal.classList.add('visible');
});
            document.getElementById('open-album-btn').addEventListener('click', async () => { await renderAlbumList(); showScreen('album-screen'); });
            document.getElementById('album-back-btn').addEventListener('click', () => { showScreen('chat-list-screen'); switchToChatListView('qzone-screen'); });

// ---    ---

document.getElementById('album-photos-back-btn').addEventListener('click', () => {
    state.activeAlbumId = null;
    showScreen('album-screen');
});

document.getElementById('album-upload-photo-btn').addEventListener('click', () => document.getElementById('album-photo-input').click());

document.getElementById('album-photo-input').addEventListener('change', async (event) => {
    if (!state.activeAlbumId) return;
    const files = event.target.files;
    if (!files.length) return;

    const album = await db.qzoneAlbums.get(state.activeAlbumId);
    
    for (const file of files) {
        const dataUrl = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(file);
        });
        await db.qzonePhotos.add({ albumId: state.activeAlbumId, url: dataUrl, createdAt: Date.now() });
    }

    const photoCount = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).count();
    const updateData = { photoCount };
    
    if (!album.photoCount || album.coverUrl.includes('placeholder')) {
        const firstPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
        if(firstPhoto) updateData.coverUrl = firstPhoto.url;
    }

    await db.qzoneAlbums.update(state.activeAlbumId, updateData);
    await renderAlbumPhotosScreen();
    await renderAlbumList();
    
    event.target.value = null;
    alert('');
});

// ---    ---

// ---   photos-grid-page   ---

document.getElementById('photos-grid-page').addEventListener('click', async (e) => {
    const deleteBtn = e.target.closest('.photo-delete-btn');
    const photoThumb = e.target.closest('.photo-thumb');

    if (deleteBtn) {
        e.stopPropagation(); // 
        const photoId = parseInt(deleteBtn.dataset.photoId);
        const confirmed = await showCustomConfirm(
            '',
            '',
            { confirmButtonClass: 'btn-danger' }
        );

        if (confirmed) {
            const deletedPhoto = await db.qzonePhotos.get(photoId);
            if (!deletedPhoto) return;
            
            await db.qzonePhotos.delete(photoId);

            const album = await db.qzoneAlbums.get(state.activeAlbumId);
            const photoCount = (album.photoCount || 1) - 1;
            const updateData = { photoCount };
            
            if (album.coverUrl === deletedPhoto.url) {
                const nextPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
                updateData.coverUrl = nextPhoto ? nextPhoto.url : 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
            }
            
            await db.qzoneAlbums.update(state.activeAlbumId, updateData);
            await renderAlbumPhotosScreen();
            await renderAlbumList();
            alert('');
        }
    } 
    else if (photoThumb) {
        // 
        openPhotoViewer(photoThumb.src);
    }
});

// 
document.getElementById('photo-viewer-close-btn').addEventListener('click', closePhotoViewer);
document.getElementById('photo-viewer-next-btn').addEventListener('click', showNextPhoto);
document.getElementById('photo-viewer-prev-btn').addEventListener('click', showPrevPhoto);

// ESC
document.addEventListener('keydown', (e) => {
    if (!photoViewerState.isOpen) return; 

    if (e.key === 'ArrowRight') {
        showNextPhoto();
    } else if (e.key === 'ArrowLeft') {
        showPrevPhoto();
    } else if (e.key === 'Escape') {
        closePhotoViewer();
    }
});

// ---    ---
         
document.getElementById('create-album-btn-page').addEventListener('click', async () => { const albumName = await showCustomPrompt("", ""); if (albumName && albumName.trim()) { const newAlbum = { name: albumName.trim(), coverUrl: 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png', photoCount: 0, createdAt: Date.now() }; await db.qzoneAlbums.add(newAlbum); await renderAlbumList(); alert(` "${albumName}" `); } else if (albumName !== null) { alert(""); } });

            document.getElementById('cancel-create-post-btn').addEventListener('click', () => document.getElementById('create-post-modal').classList.remove('visible'));
            document.getElementById('post-upload-local-btn').addEventListener('click', () => document.getElementById('post-local-image-input').click());
            document.getElementById('post-local-image-input').addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { document.getElementById('post-image-preview').src = e.target.result; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; }; reader.readAsDataURL(file); } });
            document.getElementById('post-use-url-btn').addEventListener('click', async () => { const url = await showCustomPrompt("URL", "", "", "url"); if (url) { document.getElementById('post-image-preview').src = url; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; } });
            document.getElementById('post-remove-image-btn').addEventListener('click', () => resetCreatePostModal());
            const imageModeBtn = document.getElementById('switch-to-image-mode');
            const textImageModeBtn = document.getElementById('switch-to-text-image-mode');
            const imageModeContent = document.getElementById('image-mode-content');
            const textImageModeContent = document.getElementById('text-image-mode-content');
            imageModeBtn.addEventListener('click', () => { imageModeBtn.classList.add('active'); textImageModeBtn.classList.remove('active'); imageModeContent.classList.add('active'); textImageModeContent.classList.remove('active'); });
            textImageModeBtn.addEventListener('click', () => { textImageModeBtn.classList.add('active'); imageModeBtn.classList.remove('active'); textImageModeContent.classList.add('active'); imageModeContent.classList.remove('active'); });

//   
document.getElementById('confirm-create-post-btn').addEventListener('click', async () => {
    const modal = document.getElementById('create-post-modal');
    const mode = modal.dataset.mode;
    
    // --- 1.  ---
    const visibilityMode = document.querySelector('input[name="visibility"]:checked').value;
    let visibleGroupIds = null;
    
    if (visibilityMode === 'include') {
        visibleGroupIds = Array.from(document.querySelectorAll('input[name="visibility_group"]:checked')).map(cb => parseInt(cb.value));
    }

    let newPost = {};
    const basePostData = {
        timestamp: Date.now(),
        authorId: 'user',
        // 
        visibleGroupIds: visibleGroupIds,
    };

    // --- 2.  post  ---
    if (mode === 'shuoshuo') {
        const content = document.getElementById('post-public-text').value.trim();
        if (!content) {
            alert('');
            return;
        }
        newPost = {
            ...basePostData,
            type: 'shuoshuo',
            content: content,
        };

    } else { //  'complex'  (/)
        const publicText = document.getElementById('post-public-text').value.trim();
        const isImageModeActive = document.getElementById('image-mode-content').classList.contains('active');

        if (isImageModeActive) {
            const imageUrl = document.getElementById('post-image-preview').src;
            const imageDescription = document.getElementById('post-image-description').value.trim();
            if (!imageUrl || !(imageUrl.startsWith('http') || imageUrl.startsWith('data:'))) {
                alert('');
                return;
            }
            if (!imageDescription) {
                alert('AI');
                return;
            }
            newPost = {
                ...basePostData,
                type: 'image_post',
                publicText: publicText,
                imageUrl: imageUrl,
                imageDescription: imageDescription,
            };
        } else { // 
            const hiddenText = document.getElementById('post-hidden-text').value.trim();
            if (!hiddenText) {
                alert('');
                return;
            }
            newPost = {
                ...basePostData,
                type: 'text_image',
                publicText: publicText,
                hiddenContent: hiddenText,
            };
        }
    }

    // --- 3.  ---
    const newPostId = await db.qzonePosts.add(newPost);
    let postSummary = newPost.content || newPost.publicText || newPost.imageDescription || newPost.hiddenContent || "";
    postSummary = postSummary.substring(0, 50) + (postSummary.length > 50 ? '...' : '');

    // --- 4.  ---
    for (const chatId in state.chats) {
        const chat = state.chats[chatId];
        if (chat.isGroup) continue; // 

        let shouldNotify = false;
        const postVisibleGroups = newPost.visibleGroupIds;

        // 1 ()
        if (!postVisibleGroups || postVisibleGroups.length === 0) {
            shouldNotify = true;
        } 
        // 2
        else if (chat.groupId && postVisibleGroups.includes(chat.groupId)) {
            shouldNotify = true;
        }

        // 
        if (shouldNotify) {
            const historyMessage = {
                role: 'system',
                content: `[(ID: ${newPostId})${postSummary}]`,
                timestamp: Date.now(),
                isHidden: true
            };
            chat.history.push(historyMessage);
            await db.chats.put(chat);
        }
    }
    // ---  ---

    await renderQzonePosts();
    modal.classList.remove('visible');
    alert('');
});

//   postsList  

const postsList = document.getElementById('qzone-posts-list');
let swipeState = { isDragging: false, startX: 0, startY: 0, currentX: 0, activeContainer: null, swipeDirection: null, isClick: true };

function resetAllSwipes(exceptThisOne = null) {
    document.querySelectorAll('.qzone-post-container').forEach(container => {
        if (container !== exceptThisOne) {
            container.querySelector('.qzone-post-item').classList.remove('swiped');
        }
    });
}

const handleSwipeStart = (e) => {
    const targetContainer = e.target.closest('.qzone-post-container');
    if (!targetContainer) return;

    resetAllSwipes(targetContainer);
    swipeState.activeContainer = targetContainer;
    swipeState.isDragging = true;
    swipeState.isClick = true;
    swipeState.swipeDirection = null;
    swipeState.startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
    swipeState.startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
    swipeState.activeContainer.querySelector('.qzone-post-item').style.transition = 'none';
};

const handleSwipeMove = (e) => {
    if (!swipeState.isDragging || !swipeState.activeContainer) return;

    const currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
    const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
    const diffX = currentX - swipeState.startX;
    const diffY = currentY - swipeState.startY;
    const absDiffX = Math.abs(diffX);
    const absDiffY = Math.abs(diffY);
    const clickThreshold = 5;

    if (absDiffX > clickThreshold || absDiffY > clickThreshold) {
        swipeState.isClick = false;
    }

    if (swipeState.swipeDirection === null) {
        if (absDiffX > clickThreshold || absDiffY > clickThreshold) {
            if (absDiffX > absDiffY) {
                swipeState.swipeDirection = 'horizontal';
            } else {
                swipeState.swipeDirection = 'vertical';
            }
        }
    }
    if (swipeState.swipeDirection === 'vertical') {
        handleSwipeEnd(e);
        return;
    }
    if (swipeState.swipeDirection === 'horizontal') {
        e.preventDefault();
        swipeState.currentX = currentX;
        let translation = diffX;
        if (translation > 0) translation = 0;
        if (translation < -90) translation = -90;
        swipeState.activeContainer.querySelector('.qzone-post-item').style.transform = `translateX(${translation}px)`;
    }
};

const handleSwipeEnd = (e) => {
    if (swipeState.isClick) {
        swipeState.isDragging = false;
        swipeState.activeContainer = null;
        return;
    }
    if (!swipeState.isDragging || !swipeState.activeContainer) return;

    const postItem = swipeState.activeContainer.querySelector('.qzone-post-item');
    postItem.style.transition = 'transform 0.3s ease';

    const finalX = e.type.includes('touchend') ? e.changedTouches[0].pageX : e.pageX;
    const diffX = finalX - swipeState.startX;
    const swipeThreshold = -40;

    if (swipeState.swipeDirection === 'horizontal' && diffX < swipeThreshold) {
        postItem.classList.add('swiped');
        postItem.style.transform = '';
    } else {
        postItem.classList.remove('swiped');
        postItem.style.transform = '';
    }

    swipeState.isDragging = false;
    swipeState.startX = 0;
    swipeState.startY = 0;
    swipeState.currentX = 0;
    swipeState.activeContainer = null;
    swipeState.swipeDirection = null;
    swipeState.isClick = true;
};

// ---  ---
postsList.addEventListener('mousedown', handleSwipeStart);
document.addEventListener('mousemove', handleSwipeMove);
document.addEventListener('mouseup', handleSwipeEnd);
postsList.addEventListener('touchstart', handleSwipeStart, { passive: false });
postsList.addEventListener('touchmove', handleSwipeMove, { passive: false });
postsList.addEventListener('touchend', handleSwipeEnd);

// ---  ---
postsList.addEventListener('click', async (e) => {
    e.stopPropagation();
    const target = e.target;

    // ---  ---
    if (target.classList.contains('comment-delete-btn')) {
        const postContainer = target.closest('.qzone-post-container');
        if (!postContainer) return;

        const postId = parseInt(postContainer.dataset.postId);
        const commentIndex = parseInt(target.dataset.commentIndex);
        if (isNaN(postId) || isNaN(commentIndex)) return;

        const post = await db.qzonePosts.get(postId);
        if (!post || !post.comments || !post.comments[commentIndex]) return;

        const commentText = post.comments[commentIndex].text;
        const confirmed = await showCustomConfirm(
            '',
            `\n\n${commentText.substring(0, 50)}...`,
            { confirmButtonClass: 'btn-danger' }
        );

        if (confirmed) {
            // 
            post.comments.splice(commentIndex, 1);
            // 
            await db.qzonePosts.update(postId, { comments: post.comments });
            // 
            await renderQzonePosts();
            alert('');
        }
        return; // 
    }

    if (target.classList.contains('post-actions-btn')) {
        const container = target.closest('.qzone-post-container');
        if (container && container.dataset.postId) {
            showPostActions(parseInt(container.dataset.postId));
        }
        return;
    }

    if (target.closest('.qzone-post-delete-action')) {
        const container = target.closest('.qzone-post-container');
        if (!container) return;
        
        const postIdToDelete = parseInt(container.dataset.postId);
        if (isNaN(postIdToDelete)) return;

        const confirmed = await showCustomConfirm('', '', { confirmButtonClass: 'btn-danger' });

        if (confirmed) {
            container.style.transition = 'all 0.3s ease';
            container.style.transform = 'scale(0.8)';
            container.style.opacity = '0';
        
            setTimeout(async () => {
                 await db.qzonePosts.delete(postIdToDelete);
                 
                 const notificationIdentifier = `(ID: ${postIdToDelete})`;
                 for (const chatId in state.chats) {
                     const chat = state.chats[chatId];
                     const originalHistoryLength = chat.history.length;
                     chat.history = chat.history.filter(msg => !(msg.role === 'system' && msg.content.includes(notificationIdentifier)));
                     if (chat.history.length < originalHistoryLength) {
                         await db.chats.put(chat);
                     }
                 }
                 await renderQzonePosts();
                 alert('');
            }, 300);
        }
        return;
    }

    if (target.tagName === 'IMG' && target.dataset.hiddenText) {
        const hiddenText = target.dataset.hiddenText;
        showCustomAlert("", hiddenText.replace(/<br>/g, '\n'));
        return;
    }
    const icon = target.closest('.action-icon');
    if (icon) {
        const postContainer = icon.closest('.qzone-post-container');
        if (!postContainer) return;
        const postId = parseInt(postContainer.dataset.postId);
        if (isNaN(postId)) return;
        if (icon.classList.contains('like')) {
            const post = await db.qzonePosts.get(postId);
            if (!post) return;
            if (!post.likes) post.likes = [];
            const userNickname = state.qzoneSettings.nickname;
            const userLikeIndex = post.likes.indexOf(userNickname);
            if (userLikeIndex > -1) {
                post.likes.splice(userLikeIndex, 1);
            } else {
                post.likes.push(userNickname);
                icon.classList.add('animate-like');
                icon.addEventListener('animationend', () => icon.classList.remove('animate-like'), { once: true });
            }
            await db.qzonePosts.update(postId, { likes: post.likes });
        }
        if (icon.classList.contains('favorite')) {
            const existingFavorite = await db.favorites.where({ type: 'qzone_post', 'content.id': postId }).first();
            if (existingFavorite) {
                await db.favorites.delete(existingFavorite.id);
                await showCustomAlert('', '');
            } else {
                const postToSave = await db.qzonePosts.get(postId);
                if (postToSave) {
                    await db.favorites.add({ type: 'qzone_post', content: postToSave, timestamp: Date.now() });
                    await showCustomAlert('', '');
                }
            }
        }
        await renderQzonePosts();
        return;
    }
    const sendBtn = target.closest('.comment-send-btn');
    if (sendBtn) {
        const postContainer = sendBtn.closest('.qzone-post-container');
        if (!postContainer) return;
        const postId = parseInt(postContainer.dataset.postId);
        const commentInput = postContainer.querySelector('.comment-input');
        const commentText = commentInput.value.trim();
        if (!commentText) return alert('');
        const post = await db.qzonePosts.get(postId);
        if (!post) return;
        if (!post.comments) post.comments = [];
        post.comments.push({ commenterName: state.qzoneSettings.nickname, text: commentText, timestamp: Date.now() });
        await db.qzonePosts.update(postId, { comments: post.comments });
        for (const chatId in state.chats) {
            const chat = state.chats[chatId];
            if (!chat.isGroup) {
                chat.history.push({ role: 'system', content: `['${state.qzoneSettings.nickname}' ID${postId}${commentText}]`, timestamp: Date.now(), isHidden: true });
                await db.chats.put(chat);
            }
        }
        commentInput.value = '';
        await renderQzonePosts();
        return;
    }
});
//   

            //   init()  

            // 
            document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
            document.getElementById('favorites-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));

            //   

            //   init()  

            // 
            const searchInput = document.getElementById('favorites-search-input');
            const searchClearBtn = document.getElementById('favorites-search-clear-btn');

            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.trim().toLowerCase();
                
                // /
                searchClearBtn.style.display = searchTerm ? 'block' : 'none';

                if (!searchTerm) {
                    displayFilteredFavorites(allFavoriteItems); // 
                    return;
                }

                // 
                const filteredItems = allFavoriteItems.filter(item => {
                    let contentToSearch = '';
                    let authorToSearch = '';

                    if (item.type === 'qzone_post') {
                        const post = item.content;
                        contentToSearch += (post.publicText || '') + ' ' + (post.content || '');
                        if (post.authorId === 'user') {
                            authorToSearch = state.qzoneSettings.nickname;
                        } else if (state.chats[post.authorId]) {
                            authorToSearch = state.chats[post.authorId].name;
                        }
                    } else if (item.type === 'chat_message') {
                        const msg = item.content;
                        if (typeof msg.content === 'string') {
                            contentToSearch = msg.content;
                        }
                        const chat = state.chats[item.chatId];
                        if (chat) {
                           if (msg.role === 'user') {
                                authorToSearch = chat.isGroup ? (chat.settings.myNickname || '') : '';
                           } else {
                                authorToSearch = chat.isGroup ? msg.senderName : chat.name;
                           }
                        }
                    }
                    
                    // 
                    return contentToSearch.toLowerCase().includes(searchTerm) || 
                           authorToSearch.toLowerCase().includes(searchTerm);
                });

                displayFilteredFavorites(filteredItems);
            });

            // 
            searchClearBtn.addEventListener('click', () => {
                searchInput.value = '';
                searchClearBtn.style.display = 'none';
                displayFilteredFavorites(allFavoriteItems);
                searchInput.focus();
            });

            //   

            //  / 
            
            // 
                        //  ()
            document.getElementById('selection-favorite-btn').addEventListener('click', async () => {
                if (selectedMessages.size === 0) return;
                const chat = state.chats[state.activeChatId];
                if (!chat) return;

                const favoritesToAdd = [];
                const timestampsToFavorite = [...selectedMessages];

                for (const timestamp of timestampsToFavorite) {
                    // 1
                    const existing = await db.favorites.where('originalTimestamp').equals(timestamp).first();
                    
                    if (!existing) {
                        const messageToSave = chat.history.find(msg => msg.timestamp === timestamp);
                        if (messageToSave) {
                            favoritesToAdd.push({
                                type: 'chat_message',
                                content: messageToSave,
                                chatId: state.activeChatId,
                                timestamp: Date.now(), // 
                                originalTimestamp: messageToSave.timestamp // 2
                            });
                        }
                    }
                }

                if (favoritesToAdd.length > 0) {
                    await db.favorites.bulkAdd(favoritesToAdd);
                    allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray(); // 
                    await showCustomAlert('', ` ${favoritesToAdd.length} `);
                } else {
                    await showCustomAlert('', '');
                }
                
                exitSelectionMode();
            });

            // "" ()
            const favoritesEditBtn = document.getElementById('favorites-edit-btn');
            const favoritesView = document.getElementById('favorites-view');
            const favoritesActionBar = document.getElementById('favorites-action-bar');
            const mainBottomNav = document.getElementById('chat-list-bottom-nav'); // 
            const favoritesList = document.getElementById('favorites-list'); // 
            
            favoritesEditBtn.addEventListener('click', () => {
                isFavoritesSelectionMode = !isFavoritesSelectionMode;
                favoritesView.classList.toggle('selection-mode', isFavoritesSelectionMode);

                if (isFavoritesSelectionMode) {
                    // ---  ---
                    favoritesEditBtn.textContent = '';
                    favoritesActionBar.style.display = 'block'; // 
                    mainBottomNav.style.display = 'none'; //  
                    favoritesList.style.paddingBottom = '80px'; //  
                } else {
                    // ---  ---
                    favoritesEditBtn.textContent = '';
                    favoritesActionBar.style.display = 'none'; // 
                    mainBottomNav.style.display = 'flex';  //  
                    favoritesList.style.paddingBottom = ''; //  padding

                    // 
                    selectedFavorites.clear();
                    document.querySelectorAll('.favorite-item-card.selected').forEach(card => card.classList.remove('selected'));
                    document.getElementById('favorites-delete-selected-btn').textContent = ` (0)`;
                }
            });

//   
//  ()
document.getElementById('favorites-list').addEventListener('click', (e) => {
    const target = e.target;
    const card = target.closest('.favorite-item-card');

    // 
    if (target.tagName === 'IMG' && target.dataset.hiddenText) {
        const hiddenText = target.dataset.hiddenText;
        showCustomAlert("", hiddenText.replace(/<br>/g, '\n'));
        return; // 
    }
    
    // 
    if (!isFavoritesSelectionMode) return;

    // ---  ---
    if (!card) return;

    const favId = parseInt(card.dataset.favid);
    if (isNaN(favId)) return;

    // 
    if (selectedFavorites.has(favId)) {
        selectedFavorites.delete(favId);
        card.classList.remove('selected');
    } else {
        selectedFavorites.add(favId);
        card.classList.add('selected');
    }
    
    // 
    document.getElementById('favorites-delete-selected-btn').textContent = ` (${selectedFavorites.size})`;
});

//   
// 
document.getElementById('favorites-delete-selected-btn').addEventListener('click', async () => {
    if (selectedFavorites.size === 0) return;

    const confirmed = await showCustomConfirm(
        '', 
        ` ${selectedFavorites.size} `, 
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const idsToDelete = [...selectedFavorites];
        await db.favorites.bulkDelete(idsToDelete);
        await showCustomAlert('', '');
        
        // 1
        allFavoriteItems = allFavoriteItems.filter(item => !idsToDelete.includes(item.id));
        
        // 2
        displayFilteredFavorites(allFavoriteItems);
        
        // 
        favoritesEditBtn.click(); // ""
    }
});

//   init()  
if (state.globalSettings.enableBackgroundActivity) {
    startBackgroundSimulation();
    console.log("");
}
//   

//   init()  

// ---  ---

// 1. 
document.querySelectorAll('input[name="theme-select"]').forEach(radio => {
    radio.addEventListener('change', updateSettingsPreview);
});

// 2. 
const fontSizeSlider = document.getElementById('font-size-slider');
fontSizeSlider.addEventListener('input', () => {
    // a. 
    document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
    // b. 
    updateSettingsPreview();
});

// 3. CSS
const customCssInputForPreview = document.getElementById('custom-css-input');
customCssInputForPreview.addEventListener('input', updateSettingsPreview);

// 4. 
document.getElementById('reset-theme-btn').addEventListener('click', () => {
    document.getElementById('theme-default').checked = true;
    updateSettingsPreview();
});

document.getElementById('reset-custom-css-btn').addEventListener('click', () => {
    document.getElementById('custom-css-input').value = '';
    updateSettingsPreview();
});

//   

//   init()  
document.querySelectorAll('input[name="visibility"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const groupsContainer = document.getElementById('post-visibility-groups');
        if (this.value === 'include' || this.value === 'exclude') {
            groupsContainer.style.display = 'block';
        } else {
            groupsContainer.style.display = 'none';
        }
    });
});
//   

//   init()  
document.getElementById('manage-groups-btn').addEventListener('click', openGroupManager);
document.getElementById('close-group-manager-btn').addEventListener('click', () => {
    document.getElementById('group-management-modal').classList.remove('visible');
    // 
    const chatSettingsBtn = document.getElementById('chat-settings-btn');
    if (document.getElementById('chat-settings-modal').classList.contains('visible')) {
       chatSettingsBtn.click(); // 
    }
});

document.getElementById('add-new-group-btn').addEventListener('click', addNewGroup);
document.getElementById('existing-groups-list').addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-group-btn')) {
        const groupId = parseInt(e.target.dataset.id);
        deleteGroup(groupId);
    }
});
//   

//   init()  
// 
document.getElementById('cancel-message-action-btn').addEventListener('click', hideMessageActions);
//   
document.getElementById('edit-message-btn').addEventListener('click', openAdvancedMessageEditor);
//   
document.getElementById('copy-message-btn').addEventListener('click', copyMessageContent);

//   
document.getElementById('recall-message-btn').addEventListener('click', handleRecallClick);
//   

//   select-message-btn  
document.getElementById('select-message-btn').addEventListener('click', () => {
    // 
    const timestampToSelect = activeMessageTimestamp; 
    hideMessageActions();
    // 
    if (timestampToSelect) {
        enterSelectionMode(timestampToSelect);
    }
});
//   

//   init()  

// 
document.getElementById('edit-post-btn').addEventListener('click', openPostEditor);
document.getElementById('copy-post-btn').addEventListener('click', copyPostContent);
document.getElementById('cancel-post-action-btn').addEventListener('click', hidePostActions);

//   

//   
document.getElementById('cancel-contact-picker-btn').addEventListener('click', () => {
    showScreen('chat-list-screen');
});

document.getElementById('contact-picker-list').addEventListener('click', (e) => {
    const item = e.target.closest('.contact-picker-item');
    if (!item) return;

    const contactId = item.dataset.contactId;
    item.classList.toggle('selected');
    
    if (selectedContacts.has(contactId)) {
        selectedContacts.delete(contactId);
    } else {
        selectedContacts.add(contactId);
    }
    updateContactPickerConfirmButton();
});

//   
document.getElementById('manage-members-btn').addEventListener('click', () => {
    // 
    document.getElementById('chat-settings-modal').classList.remove('visible');
    // 
    openMemberManagementScreen();
});
//   

//   
document.getElementById('back-from-member-management').addEventListener('click', () => {

    showScreen('chat-interface-screen');    
    document.getElementById('chat-settings-btn').click();
});
//   

document.getElementById('member-management-list').addEventListener('click', (e) => {
    // 
    if (e.target.classList.contains('remove-member-btn')) {
        removeMemberFromGroup(e.target.dataset.memberId);
    }
});

document.getElementById('add-existing-contact-btn').addEventListener('click', async () => {
    // 
    // 
    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    // 
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.addEventListener('click', handleAddMembersToGroup);
    
    await openContactPickerForAddMember();
});

document.getElementById('create-new-member-btn').addEventListener('click', createNewMemberInGroup);
//   

//   

// 
document.getElementById('video-call-btn').addEventListener('click', handleInitiateCall);
document.getElementById('group-video-call-btn').addEventListener('click', handleInitiateCall);

// 
document.getElementById('hang-up-btn').addEventListener('click', endVideoCall);

// 
document.getElementById('cancel-call-btn').addEventListener('click', () => {
    videoCallState.isAwaitingResponse = false;
    showScreen('chat-interface-screen');
});

// 
document.getElementById('join-call-btn').addEventListener('click', handleUserJoinCall);

//   decline-call-btn  
// 
document.getElementById('decline-call-btn').addEventListener('click', async () => {
    stopRingtone(); // <-- 
    hideIncomingCallModal();
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;
    
    // API
    if (videoCallState.isGroupCall) {
        videoCallState.isUserParticipating = false; // 
        
        // 1. AI
        const systemNote = {
            role: 'system',
            content: `[]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(systemNote);
        await db.chats.put(chat);
        
        // 2. AI
        // AI startVideoCall()
        await triggerAiResponse(); 
        
    } else { // 
        const declineMessage = { role: 'user', content: '', timestamp: Date.now() };
        chat.history.push(declineMessage);
        await db.chats.put(chat);
        
        // 
        showScreen('chat-interface-screen');
        appendMessage(declineMessage, chat);
        
        // AI
        triggerAiResponse();
    }
    
    // 
    videoCallState.isAwaitingResponse = false;
});
//   

//  BUG accept-call-btn  
// 
document.getElementById('accept-call-btn').addEventListener('click', async () => {
    stopRingtone(); // <-- 
    hideIncomingCallModal();
    
    videoCallState.initiator = 'ai';
    videoCallState.isUserParticipating = true;
    videoCallState.activeChatId = state.activeChatId;
    
    //  participants 
    if (videoCallState.isGroupCall) {
        // AI
        const chat = state.chats[videoCallState.activeChatId];
        const requester = chat.members.find(m => m.name === videoCallState.callRequester);
        if (requester) {
            // 
            videoCallState.participants = [requester];
        } else {
            videoCallState.participants = []; // 
        }
    }
    
    // 
    startVideoCall();
});
//   


//   user-speak-btn  
// 
document.getElementById('user-speak-btn').addEventListener('click', async () => {
    if (!videoCallState.isActive) return;

    //   
    const userAvatar = document.querySelector('.participant-avatar-wrapper[data-participant-id="user"] .participant-avatar');
    if (userAvatar) {
        userAvatar.classList.add('speaking');
    }

    const userInput = await showCustomPrompt('', '...');
    
    //   
    if (userAvatar) {
        userAvatar.classList.remove('speaking');
    }

    if (userInput && userInput.trim()) {
        triggerAiInCallAction(userInput.trim());
    }
});
//   

//   
// 1. 
document.querySelector('.nav-item[data-view="memories-view"]').addEventListener('click', () => {
    // ""
    if (isFavoritesSelectionMode) {
        document.getElementById('favorites-edit-btn').click(); 
    }
    switchToChatListView('memories-view');
    renderMemoriesScreen(); // 
});

// 2. 
document.getElementById('memories-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));

//   

// /
document.getElementById('add-countdown-btn').addEventListener('click', () => {
    document.getElementById('create-countdown-modal').classList.add('visible');
});
document.getElementById('cancel-create-countdown-btn').addEventListener('click', () => {
    document.getElementById('create-countdown-modal').classList.remove('visible');
});
document.getElementById('confirm-create-countdown-btn').addEventListener('click', async () => {
    const title = document.getElementById('countdown-title-input').value.trim();
    const dateValue = document.getElementById('countdown-date-input').value;
    
    if (!title || !dateValue) {
        alert('');
        return;
    }

    const targetDate = new Date(dateValue);
    if (isNaN(targetDate) || targetDate <= new Date()) {
        alert('');
        return;
    }

    const newCountdown = {
        chatId: null, // AI
        authorName: '',
        description: title,
        timestamp: Date.now(),
        type: 'countdown',
        targetDate: targetDate.getTime()
    };
    
    await db.memories.add(newCountdown);
    document.getElementById('create-countdown-modal').classList.remove('visible');
    renderMemoriesScreen();
});

// 
document.getElementById('block-chat-btn').addEventListener('click', async () => {
    if (!state.activeChatId || state.chats[state.activeChatId].isGroup) return;

    const chat = state.chats[state.activeChatId];
    const confirmed = await showCustomConfirm(
        '', 
        `${chat.name}TaTa`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now();

        //   
        const hiddenMessage = {
            role: 'system',
            content: `[]`,
            timestamp: Date.now() + 1,
            isHidden: true
        };
        chat.history.push(hiddenMessage);
        //   

        await db.chats.put(chat);
        
        // 
        document.getElementById('chat-settings-modal').classList.remove('visible');
        renderChatInterface(state.activeChatId);
        // UI
        renderChatList();
    }
});

document.getElementById('chat-lock-overlay').addEventListener('click', async (e) => {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    if (e.target.id === 'force-apply-check-btn') {
        alert("...\nAPIAI");
        await triggerAiFriendApplication(chat.id);
        renderChatInterface(chat.id); 
        return;
    }

    if (e.target.id === 'unblock-btn') {
        chat.relationship.status = 'friend';
        chat.relationship.blockedTimestamp = null;

        //   
        const hiddenMessage = {
            role: 'system',
            content: `[]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(hiddenMessage);
        //   

        await db.chats.put(chat);
        renderChatInterface(chat.id);
        renderChatList();
        triggerAiResponse(); // AI
    }
    else if (e.target.id === 'accept-friend-btn') {
        chat.relationship.status = 'friend';
        chat.relationship.applicationReason = '';

        //   
        const hiddenMessage = {
            role: 'system',
            content: `[]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(hiddenMessage);
        //   

        await db.chats.put(chat);
        renderChatInterface(chat.id);
        renderChatList();
        const msg = { role: 'user', content: '', timestamp: Date.now() };
        chat.history.push(msg);
        await db.chats.put(chat);
        appendMessage(msg, chat);
        triggerAiResponse();
    }
    else if (e.target.id === 'reject-friend-btn') {
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now();
        chat.relationship.applicationReason = '';
        await db.chats.put(chat);
        renderChatInterface(chat.id);
    }
    // 
    else if (e.target.id === 'apply-friend-btn') {
        const reason = await showCustomPrompt(
            '', 
            `${chat.name}`,
            ""
        );
        // 
        if (reason !== null) {
            // AI
            chat.relationship.status = 'pending_ai_approval';
            chat.relationship.applicationReason = reason;
            await db.chats.put(chat);

            // UI
            renderChatInterface(chat.id);
            renderChatList();
            
            // AI
            triggerAiResponse();
        }
    }
});

//   

// 1. ()
document.getElementById('transfer-btn').addEventListener('click', handlePaymentButtonClick);

// 2. 
document.getElementById('cancel-red-packet-btn').addEventListener('click', () => {
    document.getElementById('red-packet-modal').classList.remove('visible');
});
document.getElementById('send-group-packet-btn').addEventListener('click', sendGroupRedPacket);
document.getElementById('send-direct-packet-btn').addEventListener('click', sendDirectRedPacket);

// 3. 
const rpTabGroup = document.getElementById('rp-tab-group');
const rpTabDirect = document.getElementById('rp-tab-direct');
const rpContentGroup = document.getElementById('rp-content-group');
const rpContentDirect = document.getElementById('rp-content-direct');

rpTabGroup.addEventListener('click', () => {
    rpTabGroup.classList.add('active');
    rpTabDirect.classList.remove('active');
    rpContentGroup.style.display = 'block';
    rpContentDirect.style.display = 'none';
});
rpTabDirect.addEventListener('click', () => {
    rpTabDirect.classList.add('active');
    rpTabGroup.classList.remove('active');
    rpContentDirect.style.display = 'block';
    rpContentGroup.style.display = 'none';
});

// 4. 
document.getElementById('rp-group-amount').addEventListener('input', (e) => {
    const amount = parseFloat(e.target.value) || 0;
    document.getElementById('rp-group-total').textContent = ` ${amount.toFixed(2)}`;
});
document.getElementById('rp-direct-amount').addEventListener('input', (e) => {
    const amount = parseFloat(e.target.value) || 0;
    document.getElementById('rp-direct-total').textContent = ` ${amount.toFixed(2)}`;
});

//   

//   
document.getElementById('chat-messages').addEventListener('click', (e) => {
    // 1. 
    const packetCard = e.target.closest('.red-packet-card');
    if (!packetCard) return; // 

    // 2. .message-bubble
    const messageBubble = packetCard.closest('.message-bubble');
    if (!messageBubble || !messageBubble.dataset.timestamp) return;

    // 3. 
    const timestamp = parseInt(messageBubble.dataset.timestamp);
    handlePacketClick(timestamp);
});
//   

//   
// 
document.getElementById('send-poll-btn').addEventListener('click', openCreatePollModal);

// 
document.getElementById('add-poll-option-btn').addEventListener('click', addPollOptionInput);
document.getElementById('cancel-create-poll-btn').addEventListener('click', () => {
    document.getElementById('create-poll-modal').classList.remove('visible');
});
document.getElementById('confirm-create-poll-btn').addEventListener('click', sendPoll);

// 
document.getElementById('chat-messages').addEventListener('click', (e) => {
    const pollCard = e.target.closest('.poll-card');
    if (!pollCard) return;

    const timestamp = parseInt(pollCard.dataset.pollTimestamp);
    if (isNaN(timestamp)) return;
    
    // 
    const optionItem = e.target.closest('.poll-option-item');
    if (optionItem && !pollCard.classList.contains('closed')) {
        handleUserVote(timestamp, optionItem.dataset.option);
        return;
    }
    
    // /
    const actionBtn = e.target.closest('.poll-action-btn');
    if (actionBtn) {
        if (pollCard.classList.contains('closed')) {
            showPollResults(timestamp);
        } else {
            endPoll(timestamp);
        }
        return;
    }

    // 
    if (pollCard.classList.contains('closed')) {
        showPollResults(timestamp);
    }
});
//   

  //  AI 
document.getElementById('manage-ai-avatar-library-btn').addEventListener('click', openAiAvatarLibraryModal);
document.getElementById('add-ai-avatar-btn').addEventListener('click', addAvatarToLibrary);
document.getElementById('close-ai-avatar-library-btn').addEventListener('click', closeAiAvatarLibraryModal);
//   

//   init() 
document.getElementById('icon-settings-grid').addEventListener('click', async (e) => {
    if (e.target.classList.contains('change-icon-btn')) {
        const item = e.target.closest('.icon-setting-item');
        const iconId = item.dataset.iconId;
        if (!iconId) return;

        const currentUrl = state.globalSettings.appIcons[iconId];
        const newUrl = await showCustomPrompt(`${item.querySelector('.icon-preview').alt}`, 'URL', currentUrl, 'url');

        if (newUrl && newUrl.trim().startsWith('http')) {
            // 
            state.globalSettings.appIcons[iconId] = newUrl.trim();
            // 
            item.querySelector('.icon-preview').src = newUrl.trim();
        } else if (newUrl !== null) {
            alert("URL");
        }
    }
});
//   

//   init()  

    document.getElementById('chat-messages').addEventListener('click', (e) => {
        //  .closest() 
        const linkCard = e.target.closest('.link-share-card');
        if (linkCard) {
            const timestamp = parseInt(linkCard.dataset.timestamp);
            if (!isNaN(timestamp)) {
                openBrowser(timestamp); // 
            }
        }
    });

    // 
    document.getElementById('browser-back-btn').addEventListener('click', () => {
        showScreen('chat-interface-screen');
    });

//   

//   init()  

    // 1. 
    document.getElementById('share-link-btn').addEventListener('click', openShareLinkModal);

    // 2. 
    document.getElementById('cancel-share-link-btn').addEventListener('click', () => {
        document.getElementById('share-link-modal').classList.remove('visible');
    });

    // 3. 
    document.getElementById('confirm-share-link-btn').addEventListener('click', sendUserLinkShare);

//   

document.getElementById('theme-toggle-switch').addEventListener('change', toggleTheme);

//   init()  
// 
document.getElementById('quote-message-btn').addEventListener('click', startReplyToMessage);

// 
document.getElementById('cancel-reply-btn').addEventListener('click', cancelReplyMode);
//   

//  init() ...

//   
document.getElementById('chat-messages').addEventListener('click', (e) => {
    // 1. 
    const bubble = e.target.closest('.message-bubble');
    if (!bubble) return; // 

    // 2. 
    //  AI  (.ai)
    //  (.is-transfer)
    //  (data-status="pending")
    if (bubble.classList.contains('ai') && 
        bubble.classList.contains('is-transfer') && 
        bubble.dataset.status === 'pending') {
        
        // 3. 
        const timestamp = parseInt(bubble.dataset.timestamp);
        if (!isNaN(timestamp)) {
            showTransferActionModal(timestamp);
        }
    }
});
//   

//  init() 
document.getElementById('transfer-action-accept').addEventListener('click', () => handleUserTransferResponse('accepted'));
document.getElementById('transfer-action-decline').addEventListener('click', () => handleUserTransferResponse('declined'));
document.getElementById('transfer-action-cancel').addEventListener('click', hideTransferActionModal);

//   

document.getElementById('chat-list-title').addEventListener('click', renderCallHistoryScreen);

// 2. 
document.getElementById('call-history-back-btn').addEventListener('click', () => {
    // 
    showScreen('chat-list-screen');
});

// 3. 
document.getElementById('call-history-list').addEventListener('click', (e) => {
    const card = e.target.closest('.call-record-card');
    if (card && card.dataset.recordId) {
        showCallTranscript(parseInt(card.dataset.recordId));
    }
});

// 4. 
document.getElementById('close-transcript-modal-btn').addEventListener('click', () => {
    document.getElementById('call-transcript-modal').classList.remove('visible');
});

//   

document.getElementById('chat-messages').addEventListener('click', (e) => {
    // 1. 
    const voiceBody = e.target.closest('.voice-message-body');
    if (!voiceBody) return;

    // 2. DOM
    const bubble = voiceBody.closest('.message-bubble');
    if (!bubble) return;
    
    const spinner = voiceBody.querySelector('.loading-spinner');
    const transcriptEl = bubble.querySelector('.voice-transcript');

    // 
    if (bubble.dataset.state === 'loading') {
        return;
    }

    // 3. 
    if (bubble.dataset.state === 'expanded') {
        transcriptEl.style.display = 'none';
        bubble.dataset.state = 'collapsed';
    } 
    // 4. 
    else {
        bubble.dataset.state = 'loading'; // 
        spinner.style.display = 'block';   // 

        // 1.5
        setTimeout(() => {
            // 
            if (document.body.contains(bubble)) {
                const voiceText = bubble.dataset.voiceText || '()';
                transcriptEl.textContent = voiceText; // 
                
                spinner.style.display = 'none';      // 
                transcriptEl.style.display = 'block';// 
                bubble.dataset.state = 'expanded';     // 
            }
        }, 500);
    }
});

document.getElementById('chat-header-status').addEventListener('click', handleEditStatusClick);

//  init() 
document.getElementById('selection-share-btn').addEventListener('click', () => {
    if (selectedMessages.size > 0) {
        openShareTargetPicker(); // 
    }
});

//  init() 
document.getElementById('confirm-share-target-btn').addEventListener('click', async () => {
    const sourceChat = state.chats[state.activeChatId];
    const selectedTargetIds = Array.from(document.querySelectorAll('.share-target-checkbox:checked'))
                                   .map(cb => cb.dataset.chatId);

    if (selectedTargetIds.length === 0) {
        alert("");
        return;
    }

    // 1. 
    const sharedHistory = [];
    const sortedTimestamps = [...selectedMessages].sort((a, b) => a - b);
    for (const timestamp of sortedTimestamps) {
        const msg = sourceChat.history.find(m => m.timestamp === timestamp);
        if (msg) {
            sharedHistory.push(msg);
        }
    }
    
    // 2. 
    const shareCardMessage = {
        role: 'user',
        senderName: sourceChat.isGroup ? (sourceChat.settings.myNickname || '') : '',
        type: 'share_card',
        timestamp: Date.now(),
        payload: {
            sourceChatName: sourceChat.name,
            title: `${sourceChat.name}`,
            sharedHistory: sharedHistory
        }
    };

    // 3. 
    for (const targetId of selectedTargetIds) {
        const targetChat = state.chats[targetId];
        if (targetChat) {
            targetChat.history.push(shareCardMessage);
            await db.chats.put(targetChat);
        }
    }
    
    // 4. 
    document.getElementById('share-target-modal').classList.remove('visible');
    exitSelectionMode(); // 
    await showCustomAlert("", ` ${selectedTargetIds.length} `);
    renderChatList(); // 
});

// 
document.getElementById('cancel-share-target-btn').addEventListener('click', () => {
    document.getElementById('share-target-modal').classList.remove('visible');
});

//  init() 
document.getElementById('chat-messages').addEventListener('click', (e) => {
    // ......

    // 
    const shareCard = e.target.closest('.link-share-card[data-timestamp]');
    if (shareCard && shareCard.closest('.message-bubble.is-link-share')) {
        const timestamp = parseInt(shareCard.dataset.timestamp);
        openSharedHistoryViewer(timestamp);
    }
});

// 
document.getElementById('close-shared-history-viewer-btn').addEventListener('click', () => {
    document.getElementById('shared-history-viewer-modal').classList.remove('visible');
});

// 
function openSharedHistoryViewer(timestamp) {
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestamp);
    if (!message || message.type !== 'share_card') return;

    const viewerModal = document.getElementById('shared-history-viewer-modal');
    const viewerTitle = document.getElementById('shared-history-viewer-title');
    const viewerContent = document.getElementById('shared-history-viewer-content');

    viewerTitle.textContent = message.payload.title;
    viewerContent.innerHTML = ''; // 

    //  createMessageElement 
    message.payload.sharedHistory.forEach(sharedMsg => {
        //  sourceChat 
        const sourceChat = Object.values(state.chats).find(c => c.name === message.payload.sourceChatName) || chat;
        const bubbleEl = createMessageElement(sharedMsg, sourceChat);
        if (bubbleEl) {
            viewerContent.appendChild(bubbleEl);
        }
    });

    viewerModal.classList.add('visible');
}

audioPlayer.addEventListener('timeupdate', updateMusicProgressBar);

audioPlayer.addEventListener('pause', () => { 
    if(musicState.isActive) { 
        musicState.isPlaying = false; 
        updatePlayerUI(); 
    } 
});
audioPlayer.addEventListener('play', () => { 
    if(musicState.isActive) { 
        musicState.isPlaying = true; 
        updatePlayerUI(); 
    } 
});

document.getElementById('playlist-body').addEventListener('click', async (e) => {
    const target = e.target;
    if (target.classList.contains('delete-track-btn')) {
        const index = parseInt(target.dataset.index);
        const track = musicState.playlist[index];
        const confirmed = await showCustomConfirm('', `${track.name}`);
        if (confirmed) {
            deleteTrack(index);
        }
        return;
    }
    if (target.classList.contains('lyrics-btn')) {
        const index = parseInt(target.dataset.index);
        if (isNaN(index)) return;
        const lrcContent = await new Promise(resolve => {
            const lrcInput = document.getElementById('lrc-upload-input');
            const handler = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (re) => resolve(re.target.result);
                    reader.readAsText(file);
                } else {
                    resolve(null);
                }
                lrcInput.removeEventListener('change', handler);
                lrcInput.value = '';
            };
            lrcInput.addEventListener('change', handler);
            lrcInput.click();
        });
        if (lrcContent !== null) {
            musicState.playlist[index].lrcContent = lrcContent;
            await saveGlobalPlaylist();
            alert('');
            if (musicState.currentIndex === index) {
                musicState.parsedLyrics = parseLRC(lrcContent);
                renderLyrics();
            }
        }
    }
});

document.querySelector('.progress-bar').addEventListener('click', (e) => {
    if (!audioPlayer.duration) return;
    const progressBar = e.currentTarget;
    const barWidth = progressBar.clientWidth;
    const clickX = e.offsetX;
    audioPlayer.currentTime = (clickX / barWidth) * audioPlayer.duration;
});

//   init()  

// 
document.getElementById('chat-messages').addEventListener('click', (e) => {
    // 
    const placeholder = e.target.closest('.recalled-message-placeholder');
    if (!placeholder) return; // 

    // 
    const chat = state.chats[state.activeChatId];
    const wrapper = placeholder.closest('.message-wrapper'); // 
    if (chat && wrapper) {
        // 
        const timestamp = parseInt(wrapper.dataset.timestamp);
        const recalledMsg = chat.history.find(m => m.timestamp === timestamp);
        
        if (recalledMsg && recalledMsg.recalledData) {
            let originalContentText = '';
            const recalled = recalledMsg.recalledData;
            
            if (recalled.originalType === 'text') {
                originalContentText = `: "${recalled.originalContent}"`;
            } else {
                originalContentText = `[${recalled.originalType}]`;
            }
            showCustomAlert('', originalContentText);
        }
    }
});

//   

//   init()  
document.getElementById('manage-world-book-categories-btn').addEventListener('click', openCategoryManager);
document.getElementById('close-category-manager-btn').addEventListener('click', () => {
    document.getElementById('world-book-category-manager-modal').classList.remove('visible');
    renderWorldBookScreen(); // 
});
document.getElementById('add-new-category-btn').addEventListener('click', addNewCategory);
document.getElementById('existing-categories-list').addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-group-btn')) {
        const categoryId = parseInt(e.target.dataset.id);
        deleteCategory(categoryId);
    }
});
//   

// ---    ---

// 
document.getElementById('chat-settings-modal').addEventListener('click', (e) => {
    if (e.target.classList.contains('change-frame-btn')) {
        openFrameSelectorModal(e.target.dataset.type);
    }
});
document.getElementById('member-settings-modal').addEventListener('click', (e) => {
    if (e.target.classList.contains('change-frame-btn')) {
        openFrameSelectorModal('member', editingMemberId);
    }
});

// 
// 
document.getElementById('manage-custom-frames-btn').addEventListener('click', () => {
    // 1. 
    document.getElementById('avatar-frame-modal').classList.remove('visible');
    
    // 2. 
    openFrameManager();
});
document.getElementById('cancel-frame-settings-btn').addEventListener('click', () => document.getElementById('avatar-frame-modal').classList.remove('visible'));
document.getElementById('save-frame-settings-btn').addEventListener('click', saveSelectedFrames);

// 
document.getElementById('upload-custom-frame-btn').addEventListener('click', handleUploadCustomFrame);
document.getElementById('close-frame-manager-btn').addEventListener('click', () => {
    document.getElementById('custom-frame-manager-modal').classList.remove('visible');
    // 
    openFrameSelectorModal(currentFrameSelection.type, currentFrameSelection.target);
});

//   

//  JS 
const chatListEl = document.getElementById('chat-list');
let chatSwipeState = { isDragging: false, startX: 0, activeContent: null };

// 
function resetAllChatSwipes(exceptThisOne = null) {
    document.querySelectorAll('.chat-list-item-content.swiped').forEach(content => {
        if (content !== exceptThisOne) {
            content.classList.remove('swiped');
        }
    });
}

chatListEl.addEventListener('mousedown', (e) => {
    const content = e.target.closest('.chat-list-item-content');
    if (content) {
        resetAllChatSwipes(content);
        chatSwipeState.isDragging = true;
        chatSwipeState.startX = e.pageX;
        chatSwipeState.activeContent = content;
        // 
        e.preventDefault();
    }
});

document.addEventListener('mousemove', (e) => {
    if (!chatSwipeState.isDragging || !chatSwipeState.activeContent) return;
    const diffX = e.pageX - chatSwipeState.startX;
    if (diffX < 0 && diffX > -170) { // , 
        chatSwipeState.activeContent.style.transition = 'none'; // 
        chatSwipeState.activeContent.style.transform = `translateX(${diffX}px)`;
    }
});

document.addEventListener('mouseup', (e) => {
    if (!chatSwipeState.isDragging || !chatSwipeState.activeContent) return;
    
    chatSwipeState.activeContent.style.transition = 'transform 0.3s ease';
    const transformStyle = window.getComputedStyle(chatSwipeState.activeContent).transform;
    const currentTranslateX = new DOMMatrix(transformStyle).m41;

    if (currentTranslateX < -60) { // 
        chatSwipeState.activeContent.classList.add('swiped');
    } else {
        chatSwipeState.activeContent.classList.remove('swiped');
    }
    chatSwipeState.activeContent.style.transform = ''; // CSS class

    // 
    chatSwipeState.isDragging = false;
    chatSwipeState.activeContent = null;
});

// 
chatListEl.addEventListener('touchstart', (e) => {
     const content = e.target.closest('.chat-list-item-content');
    if (content) {
        resetAllChatSwipes(content);
        chatSwipeState.isDragging = true;
        chatSwipeState.startX = e.touches[0].pageX;
        chatSwipeState.activeContent = content;
    }
}, { passive: true });

chatListEl.addEventListener('touchmove', (e) => {
    if (!chatSwipeState.isDragging || !chatSwipeState.activeContent) return;
    const diffX = e.touches[0].pageX - chatSwipeState.startX;
     if (diffX < 0 && diffX > -170) {
        chatSwipeState.activeContent.style.transition = 'none';
        chatSwipeState.activeContent.style.transform = `translateX(${diffX}px)`;
    }
}, { passive: true });

chatListEl.addEventListener('touchend', (e) => {
    if (!chatSwipeState.isDragging || !chatSwipeState.activeContent) return;
    
    chatSwipeState.activeContent.style.transition = 'transform 0.3s ease';
    const transformStyle = window.getComputedStyle(chatSwipeState.activeContent).transform;
    const currentTranslateX = new DOMMatrix(transformStyle).m41;

    if (currentTranslateX < -60) {
        chatSwipeState.activeContent.classList.add('swiped');
    } else {
        chatSwipeState.activeContent.classList.remove('swiped');
    }
    chatSwipeState.activeContent.style.transform = '';

    chatSwipeState.isDragging = false;
    chatSwipeState.activeContent = null;
});
//  JS 

//   
chatListEl.addEventListener('click', async (e) => {
    const target = e.target;
    if (target.classList.contains('swipe-action-btn')) {
        const container = target.closest('.chat-list-item-swipe-container');
        if (!container) return;

        const chatId = container.dataset.chatId;
        const chat = state.chats[chatId];
        if (!chat) return;

        if (target.classList.contains('pin') || target.classList.contains('unpin')) {
            // 
            chat.isPinned = !chat.isPinned;
            await db.chats.put(chat);
            await renderChatList(); // 
        } else if (target.classList.contains('delete')) {
            // 
            const confirmed = await showCustomConfirm('', ` "${chat.name}" `, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                if (musicState.isActive && musicState.activeChatId === chat.id) await endListenTogetherSession(false);
                delete state.chats[chat.id];
                if (state.activeChatId === chat.id) state.activeChatId = null;
                await db.chats.delete(chat.id);
                await renderChatList();
            } else {
                // 
                const content = container.querySelector('.chat-list-item-content');
                if (content) content.classList.remove('swiped');
            }
        }
    }
});
//   

//   init()  

// 
document.getElementById('chat-settings-modal').addEventListener('click', (e) => {
    if (e.target.id === 'find-history-btn') {
        openChatSearchScreen();
    }
});

// 
document.getElementById('search-back-btn').addEventListener('click', () => {
    // 
    showScreen('chat-interface-screen'); 
    document.getElementById('chat-settings-modal').classList.add('visible');
});

//   

//   init()  

// 
document.getElementById('keyword-search-input').addEventListener('input', performChatSearch);
document.getElementById('sender-search-select').addEventListener('change', performChatSearch);
document.getElementById('date-search-input').addEventListener('change', performChatSearch);

// 
document.getElementById('search-results-list').addEventListener('click', (e) => {
    const item = e.target.closest('.search-result-item');
    if (item && item.dataset.timestamp) {
        const timestamp = parseInt(item.dataset.timestamp);
        jumpToMessage(timestamp);
    }
});

//   

    //   init()  

    // ---  ---
    const themeEditor = document.getElementById('theme-css-editor');
    
    // 
    await loadThemesToDropdown();
    themeEditor.value = THEME_CSS_TEMPLATE;

    // 
    document.getElementById('theme-selector').addEventListener('change', handleThemeSelection);
    
    // 
    document.getElementById('apply-theme-btn').addEventListener('click', () => applyThemeCss(themeEditor.value));
    document.getElementById('save-theme-btn').addEventListener('click', saveCurrentTheme);
    document.getElementById('save-as-new-theme-btn').addEventListener('click', saveAsNewTheme);
    document.getElementById('rename-theme-btn').addEventListener('click', renameSelectedTheme);
    document.getElementById('delete-theme-btn').addEventListener('click', deleteSelectedTheme);
    document.getElementById('export-theme-btn').addEventListener('click', exportTheme);
    
    // 
    document.getElementById('import-theme-btn').addEventListener('click', () => {
        document.getElementById('import-theme-input').click();
    });
    document.getElementById('import-theme-input').addEventListener('change', (e) => {
        importTheme(e.target.files[0]);
        e.target.value = null; // 
    });
    
    //   

document.getElementById('api-preset-select').addEventListener('change', handleApiPresetSelectChange);
document.getElementById('manage-api-presets-btn').addEventListener('click', openApiPresetManager);

            //   

            // 1. 
            document.getElementById('lockscreen-wallpaper-upload-input').addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if(file) {
                    const dataUrl = await new Promise((res, rej) => {
                        const reader = new FileReader();
                        reader.onload = () => res(reader.result);
                        reader.onerror = () => rej(reader.error);
                        reader.readAsDataURL(file);
                    });
                    newLockscreenWallpaperBase64 = dataUrl;
                    renderWallpaperScreen(); // 
                }
            });

            // 2. 
            document.getElementById('password-confirm-btn').addEventListener('click', checkPassword);
            document.getElementById('password-cancel-btn').addEventListener('click', hidePasswordModal);
            // 
            document.getElementById('password-input-field').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });

            // 3. 
            const lockScreen = document.getElementById('lock-screen');
            const unlockHint = document.getElementById('unlock-hint');
            let touchStartY = 0;
            let isSwiping = false;

// 
const handleUnlockStart = (e) => {
    if (document.getElementById('password-modal-overlay').classList.contains('visible')) return;
    
    // ()
    const blurBg = document.getElementById('lock-screen-background-blur');
    if (state.globalSettings.password) {
        blurBg.style.backgroundImage = lockScreen.style.backgroundImage;
        blurBg.style.display = 'block';
    } else {
        document.getElementById('home-screen').classList.add('active');
    }
    
    touchStartY = getEventCoords(e).y; // Y
    isSwiping = true;
    lockScreen.style.transition = 'none';
    unlockHint.style.transition = 'none';
};

// 
const handleUnlockMove = (e) => {
    if (!isSwiping) return;
    const currentY = getEventCoords(e).y; // 
    let diffY = currentY - touchStartY;
    // ()
    if (diffY > 0) diffY = 0;
    lockScreen.style.transform = `translateY(${diffY}px)`;
    unlockHint.style.opacity = Math.max(0, 1 - Math.abs(diffY) / 100);
    if (state.globalSettings.password) {
        const blurBg = document.getElementById('lock-screen-background-blur');
        blurBg.style.opacity = Math.min(1, Math.abs(diffY) / 80);
    }
};

// 
const handleUnlockEnd = (e) => {
    if (!isSwiping) return;
    isSwiping = false;

    // ()
    lockScreen.style.transition = 'transform 0.3s ease-out';
    unlockHint.style.transition = 'opacity 0.3s ease-out';
    const blurBg = document.getElementById('lock-screen-background-blur');
    
    // touchend e.changedTouches[0]
    const touchEndY = e.changedTouches ? e.changedTouches[0].clientY : e.pageY;
    const swipeDistance = touchStartY - touchEndY;
    
    if (swipeDistance > 80) {
        lockScreen.style.transform = 'translateY(-100%)';
        setTimeout(() => {
            if (state.globalSettings.password) {
                showPasswordModal();
            } else {
                unlockPhone();
            }
        }, 300);
    } else {
        lockScreen.style.transform = 'translateY(0)';
        unlockHint.style.opacity = '1';
        if (state.globalSettings.password) {
            blurBg.style.opacity = '0';
            setTimeout(() => { blurBg.style.display = 'none'; }, 300);
        } else {
            document.getElementById('home-screen').classList.remove('active');
        }
    }
};

// 2. 
lockScreen.addEventListener('touchstart', handleUnlockStart, { passive: true });
lockScreen.addEventListener('touchmove', handleUnlockMove, { passive: true });
lockScreen.addEventListener('touchend', handleUnlockEnd, { passive: true });

lockScreen.addEventListener('mousedown', handleUnlockStart);
// mousemovemouseupdocument
document.addEventListener('mousemove', handleUnlockMove);
document.addEventListener('mouseup', handleUnlockEnd);
            
            //   

// 
const actionsTopBar = document.getElementById('chat-input-actions-top');
let isDown = false;
let startX;
let scrollLeft;

actionsTopBar.addEventListener('mousedown', (e) => {
    isDown = true;
    actionsTopBar.classList.add('grabbing'); // class
    startX = e.pageX - actionsTopBar.offsetLeft;
    scrollLeft = actionsTopBar.scrollLeft;
});

actionsTopBar.addEventListener('mouseleave', () => {
    isDown = false;
    actionsTopBar.classList.remove('grabbing');
});

actionsTopBar.addEventListener('mouseup', () => {
    isDown = false;
    actionsTopBar.classList.remove('grabbing');
});

actionsTopBar.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - actionsTopBar.offsetLeft;
    const walk = (x - startX) * 2; // 2
    actionsTopBar.scrollLeft = scrollLeft - walk;
});


            // ===================================================================
            // 5. 
            
            // 
            applyLockscreenWallpaper();
            updateLockClock();
            
            // 
            lockPhone();
        }

        init();
    });
</script>

<script src="chrome-extension://dkmejdpchbkcihdlengmhifgnigdjmba/removeChildPatch.js" id="removeChildPatch"></script><div id="b76f18dd-bcdd-4927-bd92-351a0232abd3" style=""><template shadowrootmode="open"><div class="ai-picture-toolbar theme-light ai-picture-hide-toolbar"><div class="ai-picture-toolbar-wrap">
            <ul class="ai-picture-toolbar-list" id="ai-picture-features">
            </ul>
            <div id="ai-picture-seting">
              <div class="ai-picture-setting-icon"></div>
              <div class="ai-picture-seting-list-wrapper">
                <div class="ai-picture-seting-list" id="ai-picture-seting-list">
                  <div class="ai-picture-seting-item" data-action="close">
                    <div class="setting-icon ai-picture-setting-close"></div>
                    <span class="ai-picture-setting-text"></span>
                  </div>
                </div>
              </div>
            </div>
          </div></div><style>@charset "UTF-8";
.theme-light {
  --toolbar-bg-color: #fff;
  --toolbar-outline-color: rgba(0, 0, 0, 0.2);
  --toolbar-box-shadow-color: rgba(0, 0, 0, 0.1);
  --toolbar-text-color: #1a1a1a;
  --toolbar-hover-text-color: rgb(31, 98, 238);
  --toolbar-hover-bg-color: linear-gradient(90deg, rgba(118, 116, 255, 0.15) 2.33%, rgba(51, 122, 254, 0.15) 39.87%, rgba(1, 172, 253, 0.15) 97.67%);
  --toolbar-line-color: rgba(0, 0, 0, 0.1);
  --toolbar-setting-shadow-color: rgba(100, 106, 112, 0.2);
  --toolbar-setting-item-hover-color: rgba(73, 123, 229, 0.1);
  --swiper-wrapper-bg-color: rgba(0, 0, 0, 0.65);
  --swiper-btn-bg-color: rgba(0, 0, 0, 0.6);
  --swiper-btn-text-color: #fff;
  --swiper-pagination-bg-color: rgba(0, 0, 0, 0.5);
  --swiper-pagination-text-color: rgba(255, 255, 255, 0.5);
  --swiper-pagination-current-text-color: #fff;
  --setting-icon-normal-url: url("chrome-extension://bnjoienjhhclcabnkbhhfndecoipmcdg/background/keniu/images/icon/light/icon_setting_normal.png");
  --setting-icon-hover-url: url("chrome-extension://bnjoienjhhclcabnkbhhfndecoipmcdg/background/keniu/images/icon/light/icon_setting_active.png");
  --setting-icon-close-url: url("chrome-extension://bnjoienjhhclcabnkbhhfndecoipmcdg/background/keniu/images/icon/light/icon_close_normal.png");
  --setting-icon-contact-url: url("chrome-extension://bnjoienjhhclcabnkbhhfndecoipmcdg/background/keniu/images/icon/light/icon_contact_normal.png");
}

.theme-dark {
  --toolbar-bg-color: rgb(54, 54, 53);
  --toolbar-outline-color: rgb(94, 94, 93);
  --toolbar-box-shadow-color: rgba(0, 0, 0, 0.1);
  --toolbar-text-color: #fff;
  --toolbar-hover-text-color: rgb(31, 98, 238);
  --toolbar-hover-bg-color: rgb(66, 66, 65);
  --toolbar-line-color: rgb(74, 74, 73);
  --toolbar-setting-shadow-color: rgba(100, 106, 112, 0.2);
  --toolbar-setting-item-hover-color: rgba(73, 123, 229, 0.1);
  --swiper-wrapper-bg-color: rgba(0, 0, 0, 0.65);
  --swiper-btn-bg-color: rgba(0, 0, 0, 0.6);
  --swiper-btn-text-color: #fff;
  --swiper-pagination-bg-color: rgba(0, 0, 0, 0.5);
  --swiper-pagination-text-color: rgba(255, 255, 255, 0.5);
  --swiper-pagination-current-text-color: #fff;
  --setting-icon-normal-url: url("chrome-extension://bnjoienjhhclcabnkbhhfndecoipmcdg/background/keniu/images/icon/dark/icon_setting_normal.png");
  --setting-icon-hover-url: url("chrome-extension://bnjoienjhhclcabnkbhhfndecoipmcdg/background/keniu/images/icon/dark/icon_setting_active.png");
  --setting-icon-close-url: url("chrome-extension://bnjoienjhhclcabnkbhhfndecoipmcdg/background/keniu/images/icon/dark/icon_close_normal.png");
  --setting-icon-contact-url: url("chrome-extension://bnjoienjhhclcabnkbhhfndecoipmcdg/background/keniu/images/icon/dark/icon_contact_normal.png");
}

.ai-picture-toolbar * {
  padding: 0;
  margin: 0;
}

.ai-picture-toolbar {
  position: absolute;
  padding-bottom: 2px;
  display: none;
  /* all: initial; */
}

.ai-picture-toolbar:hover {
  display: block !important;
}

.ai-picture-toolbar-wrap {
  display: flex;
  align-items: center;
  height: 34px;
  border-radius: 8px;
  outline: 1px solid var(--toolbar-outline-color);
  outline-offset: -1px;
  background-color: var(--toolbar-bg-color);
  box-shadow: 0px 5px 20px var(--toolbar-box-shadow-color);
  background-image: url("chrome-extension://bnjoienjhhclcabnkbhhfndecoipmcdg/background/keniu/images/icon/tool_bg.png");
  background-size: auto 100%;
  background-position: 0 0;
  background-repeat: no-repeat;
  padding: 0 6px;
}

.ai-picture-toolbar .ai-picture-logo {
  position: relative;
  width: 28px;
  height: 28px;
  margin-left: 9px;
  padding: 0;
}

.ai-picture-toolbar .ai-picture-logo img {
  position: absolute;
  width: 100%;
  padding: 0;
  margin: 0;
}

.ai-picture-toolbar .ai-picture-download {
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  width: 28px;
  height: 28px;
  margin: 0 9px 0 0;
  cursor: pointer;
}

.ai-picture-toolbar .ai-picture-download:hover {
  border-radius: 4px;
  background: var(--toolbar-hover-bg-color);
}

.ai-picture-toolbar .ai-picture-download img {
  position: absolute;
  width: 18px;
  height: 18px;
  padding: 0;
  margin: 0;
  background: none;
}

.ai-picture-toolbar .ai-picture-download::after {
  position: absolute;
  top: 6px;
  right: -5px;
  content: "";
  width: 1px;
  height: 16px;
  background-color: var(--toolbar-line-color);
}

.ai-picture-toolbar #ai-picture-seting {
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  width: 14px;
  height: 28px;
  cursor: pointer;
}

.ai-picture-toolbar #ai-picture-seting .ai-picture-setting-icon {
  position: absolute;
  width: 14px;
  height: 14px;
  padding: 0;
  margin: 0;
  background-size: cover;
  background-repeat: no-repeat;
  background-image: var(--setting-icon-normal-url);
}
.ai-picture-toolbar #ai-picture-seting:hover .ai-picture-setting-icon {
  background-image: var(--setting-icon-hover-url);
}

.ai-picture-toolbar #ai-picture-seting:hover {
  border-radius: 4px;
  background: var(--toolbar-hover-bg-color);
}

.ai-picture-toolbar .ai-picture-seting-active .ai-picture-seting-list-wrapper {
  display: block !important;
}

.ai-picture-toolbar .ai-picture-seting-list-wrapper {
  display: none;
  position: absolute;
  top: 31px;
  right: -10px;
  padding-top: 4px;
  border-radius: 5px;
  width: 140px;
}

.ai-picture-toolbar .ai-picture-seting-list {
  background: var(--toolbar-bg-color);
  border-radius: 5px;
  box-shadow: 0px 5px 40px 0px var(--toolbar-setting-shadow-color);
  padding: 6px 0;
  box-sizing: border-box;
}

.ai-picture-toolbar .ai-picture-seting-list .ai-picture-seting-item {
  display: flex;
  align-items: center;
  justify-content: start;
  padding: 7px 14px;
  text-align: center;
  font-size: 12px;
  color: var(--toolbar-text-color);
  font-family: "";
}

.ai-picture-toolbar .ai-picture-seting-list .ai-picture-seting-item + .ai-picture-toolbar .ai-picture-seting-list .ai-picture-seting-item {
  margin-top: 11px;
}

.ai-picture-toolbar .ai-picture-seting-list .ai-picture-seting-item:hover {
  background-color: var(--toolbar-setting-item-hover-color);
}

.ai-picture-toolbar .ai-picture-toolbar-list {
  display: flex;
  justify-content: center;
  margin: 0 4px 0 0;
  padding: 0;
}

.ai-picture-toolbar .ai-picture-toolbar-list::after {
  content: "";
  width: 1px;
  height: 16px;
  margin: 6px 0 0 4px;
  background-color: var(--toolbar-line-color);
}

.ai-picture-toolbar .ai-picture-toolbar-list li {
  position: relative;
  top: 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  height: 28px;
  padding: 0 6px;
  margin: 0 2px 0 0;
  cursor: pointer;
  font-family: "";
}
.ai-picture-toolbar .ai-picture-toolbar-list li:last-child {
  margin-right: 0;
}

.ai-picture-toolbar .ai-picture-toolbar-list li:hover {
  border-radius: 4px;
  background: var(--toolbar-hover-bg-color);
}

.ai-picture-toolbar .ai-picture-toolbar-list li img {
  position: initial;
  width: 18px;
  height: 18px;
  padding: 0;
  margin: 0;
  background: none;
}

.ai-picture-toolbar .ai-picture-toolbar-list li span {
  margin-left: 5px;
  color: var(--toolbar-text-color);
  font-size: 13px;
  font-family: "";
  font-weight: 400;
  letter-spacing: normal;
  white-space: nowrap;
}

.ai-picture-toolbar .ai-picture-toolbar-list li.dividing-line {
  position: relative;
  margin-left: 6px;
}
.ai-picture-toolbar .ai-picture-toolbar-list li.dividing-line::before {
  content: "";
  position: absolute;
  top: 50%;
  left: -5px;
  transform: translateY(-50%);
  height: 16px;
  width: 1px;
  background-color: var(--toolbar-line-color);
}

.ai-picture-toolbar-list li:hover > span {
  color: var(--toolbar-hover-text-color);
}
.ai-picture-toolbar-list li.show-toast {
  position: relative;
}
.ai-picture-toolbar-list li.show-toast:hover::after {
  position: absolute;
  display: inline-block;
  top: 35px;
  left: 0;
  padding: 8px;
  box-sizing: content-box;
  background-color: var(--toolbar-bg-color);
  border-radius: 4px;
  font-size: 12px;
  color: var(--toolbar-text-color);
}
.ai-picture-toolbar-list li.show-toast[tool-type=editor]:hover::after {
  width: 60px;
  content: "AI";
}
.ai-picture-toolbar-list li.show-toast[tool-type=repair]:hover::after {
  width: 48px;
  content: "AI";
}
.ai-picture-toolbar-list li.show-toast[tool-type=watermark]:hover::after {
  width: 48px;
  content: "AI";
}
.ai-picture-toolbar-list li.show-toast[tool-type=matting]:hover::after {
  width: 38px;
  content: "AI";
}
.ai-picture-toolbar-list li.show-toast[tool-type=text]:hover::after {
  width: 48px;
  content: "";
}
.ai-picture-toolbar-list li.show-toast[tool-type=printing]:hover::after {
  width: 24px;
  content: "";
}
.ai-picture-toolbar-list li.show-toast[tool-type=erase]:hover::after {
  width: 36px;
  content: "AI";
}
.ai-picture-toolbar-list li.show-toast[tool-type=compress]:hover::after {
  width: 48px;
  content: "";
}
.ai-picture-toolbar-list li.show-toast[tool-type=toPdf]:hover::after {
  width: 60px;
  content: "PDF";
}
.ai-picture-toolbar-list li.show-toast[tool-type=resize]:hover::after {
  width: 48px;
  content: "";
}
.ai-picture-toolbar-list li.show-toast[tool-type=download]:hover::after {
  width: 24px;
  content: "";
}
.ai-picture-toolbar-list li.show-toast[tool-type=searchPicture]:hover::after {
  width: 48px;
  content: "";
}

.ai-picture-magnify {
  position: absolute;
  display: none;
}

.ai-picture-magnify:hover {
  display: block !important;
}

.ai-picture-magnify img {
  position: initial;
  width: 28px;
  height: 28px;
  padding: 0;
  margin: 0;
}

.ai-picture-hide-toolbar {
  animation: fade-out 0.3s linear;
  animation-delay: 0.2s;
  animation-fill-mode: forwards;
}

.ai-picture-seting-item .setting-icon {
  width: 16px;
  height: 16px;
  margin-right: 8px;
  background-repeat: no-repeat;
  background-position: center;
  background-size: 100%;
}
.ai-picture-seting-item .setting-icon.ai-picture-setting-close {
  background-image: var(--setting-icon-close-url);
}
.ai-picture-seting-item .setting-icon.ai-picture-setting-contact {
  background-image: var(--setting-icon-contact-url);
}
.ai-picture-seting-item .ai-picture-setting-text {
  white-space: nowrap;
}

@keyframes fade-out {
  0% {
    visibility: visible;
    opacity: 1;
  }
  100% {
    opacity: 0;
    visibility: hidden;
    display: none;
  }
}</style></template></div><div id="0fbfa18f-412f-467b-927a-9e0f0dda3463" style=""><template shadowrootmode="open"><div class="ai-picture-swiper-warp theme-light"><div class="swiper ai-picture-swiper swiper-initialized swiper-horizontal swiper-backface-hidden">
          <div class="swiper-wrapper ai-picture-wrapper" id="swiper-wrapper-ad8dd10b45dafbe77" aria-live="polite">
          </div>
        <span class="swiper-notification" aria-live="assertive" aria-atomic="true"></span></div>
        <div class="swiper-button-prev ai-picture-btn swiper-button-disabled swiper-button-lock" tabindex="-1" role="button" aria-label="Previous slide" aria-controls="swiper-wrapper-ad8dd10b45dafbe77" aria-disabled="true"></div>
        <div class="swiper-button-next ai-picture-btn swiper-button-disabled swiper-button-lock" tabindex="-1" role="button" aria-label="Next slide" aria-controls="swiper-wrapper-ad8dd10b45dafbe77" aria-disabled="true"></div>
        <div class="swiper-pagination ai-picture-pagination swiper-pagination-fraction swiper-pagination-horizontal swiper-pagination-lock"><span class="swiper-pagination-current">1</span> / <span class="swiper-pagination-total">1</span></div>
        <div id="ai-picture-close" class="ai-picture-close">
          <img src="chrome-extension://bnjoienjhhclcabnkbhhfndecoipmcdg/background/keniu/images/icon/icon_close.png" alt="" srcset="">
        </div></div><style>/**
 * Swiper 11.0.3
 * Most modern mobile touch slider and framework with hardware accelerated transitions
 * https://swiperjs.com
 *
 * Copyright 2014-2023 Vladimir Kharlampidi
 *
 * Released under the MIT License
 *
 * Released on: October 26, 2023
 */
@font-face {
  font-family: swiper-icons;
  src: url("data:application/font-woff;charset=utf-8;base64, d09GRgABAAAAAAZgABAAAAAADAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABGRlRNAAAGRAAAABoAAAAci6qHkUdERUYAAAWgAAAAIwAAACQAYABXR1BPUwAABhQAAAAuAAAANuAY7+xHU1VCAAAFxAAAAFAAAABm2fPczU9TLzIAAAHcAAAASgAAAGBP9V5RY21hcAAAAkQAAACIAAABYt6F0cBjdnQgAAACzAAAAAQAAAAEABEBRGdhc3AAAAWYAAAACAAAAAj//wADZ2x5ZgAAAywAAADMAAAD2MHtryVoZWFkAAABbAAAADAAAAA2E2+eoWhoZWEAAAGcAAAAHwAAACQC9gDzaG10eAAAAigAAAAZAAAArgJkABFsb2NhAAAC0AAAAFoAAABaFQAUGG1heHAAAAG8AAAAHwAAACAAcABAbmFtZQAAA/gAAAE5AAACXvFdBwlwb3N0AAAFNAAAAGIAAACE5s74hXjaY2BkYGAAYpf5Hu/j+W2+MnAzMYDAzaX6QjD6/4//Bxj5GA8AuRwMYGkAPywL13jaY2BkYGA88P8Agx4j+/8fQDYfA1AEBWgDAIB2BOoAeNpjYGRgYNBh4GdgYgABEMnIABJzYNADCQAACWgAsQB42mNgYfzCOIGBlYGB0YcxjYGBwR1Kf2WQZGhhYGBiYGVmgAFGBiQQkOaawtDAoMBQxXjg/wEGPcYDDA4wNUA2CCgwsAAAO4EL6gAAeNpj2M0gyAACqxgGNWBkZ2D4/wMA+xkDdgAAAHjaY2BgYGaAYBkGRgYQiAHyGMF8FgYHIM3DwMHABGQrMOgyWDLEM1T9/w8UBfEMgLzE////P/5//f/V/xv+r4eaAAeMbAxwIUYmIMHEgKYAYjUcsDAwsLKxc3BycfPw8jEQA/gZBASFhEVExcQlJKWkZWTl5BUUlZRVVNXUNTQZBgMAAMR+E+gAEQFEAAAAKgAqACoANAA+AEgAUgBcAGYAcAB6AIQAjgCYAKIArAC2AMAAygDUAN4A6ADyAPwBBgEQARoBJAEuATgBQgFMAVYBYAFqAXQBfgGIAZIBnAGmAbIBzgHsAAB42u2NMQ6CUAyGW568x9AneYYgm4MJbhKFaExIOAVX8ApewSt4Bic4AfeAid3VOBixDxfPYEza5O+Xfi04YADggiUIULCuEJK8VhO4bSvpdnktHI5QCYtdi2sl8ZnXaHlqUrNKzdKcT8cjlq+rwZSvIVczNiezsfnP/uznmfPFBNODM2K7MTQ45YEAZqGP81AmGGcF3iPqOop0r1SPTaTbVkfUe4HXj97wYE+yNwWYxwWu4v1ugWHgo3S1XdZEVqWM7ET0cfnLGxWfkgR42o2PvWrDMBSFj/IHLaF0zKjRgdiVMwScNRAoWUoH78Y2icB/yIY09An6AH2Bdu/UB+yxopYshQiEvnvu0dURgDt8QeC8PDw7Fpji3fEA4z/PEJ6YOB5hKh4dj3EvXhxPqH/SKUY3rJ7srZ4FZnh1PMAtPhwP6fl2PMJMPDgeQ4rY8YT6Gzao0eAEA409DuggmTnFnOcSCiEiLMgxCiTI6Cq5DZUd3Qmp10vO0LaLTd2cjN4fOumlc7lUYbSQcZFkutRG7g6JKZKy0RmdLY680CDnEJ+UMkpFFe1RN7nxdVpXrC4aTtnaurOnYercZg2YVmLN/d/gczfEimrE/fs/bOuq29Zmn8tloORaXgZgGa78yO9/cnXm2BpaGvq25Dv9S4E9+5SIc9PqupJKhYFSSl47+Qcr1mYNAAAAeNptw0cKwkAAAMDZJA8Q7OUJvkLsPfZ6zFVERPy8qHh2YER+3i/BP83vIBLLySsoKimrqKqpa2hp6+jq6RsYGhmbmJqZSy0sraxtbO3sHRydnEMU4uR6yx7JJXveP7WrDycAAAAAAAH//wACeNpjYGRgYOABYhkgZgJCZgZNBkYGLQZtIJsFLMYAAAw3ALgAeNolizEKgDAQBCchRbC2sFER0YD6qVQiBCv/H9ezGI6Z5XBAw8CBK/m5iQQVauVbXLnOrMZv2oLdKFa8Pjuru2hJzGabmOSLzNMzvutpB3N42mNgZGBg4GKQYzBhYMxJLMlj4GBgAYow/P/PAJJhLM6sSoWKfWCAAwDAjgbRAAB42mNgYGBkAIIbCZo5IPrmUn0hGA0AO8EFTQAA");
  font-weight: 400;
  font-style: normal;
}
:root {
  --swiper-theme-color:#007aff;
}

:host {
  position: relative;
  display: block;
  margin-left: auto;
  margin-right: auto;
  z-index: 1;
}

.swiper {
  margin-left: auto;
  margin-right: auto;
  position: relative;
  overflow: hidden;
  list-style: none;
  padding: 0;
  z-index: 9999;
  display: block;
}

.swiper-vertical > .swiper-wrapper {
  flex-direction: column;
}

.swiper-wrapper {
  position: relative;
  width: 100%;
  height: 100%;
  z-index: 1;
  display: flex;
  transition-property: transform;
  transition-timing-function: var(--swiper-wrapper-transition-timing-function, initial);
  box-sizing: content-box;
}

.swiper-android .swiper-slide, .swiper-ios .swiper-slide, .swiper-wrapper {
  transform: translate3d(0px, 0, 0);
}

.swiper-horizontal {
  touch-action: pan-y;
}

.swiper-vertical {
  touch-action: pan-x;
}

.swiper-slide {
  flex-shrink: 0;
  width: 100%;
  height: 100%;
  position: relative;
  transition-property: transform;
  display: block;
}

.swiper-slide-invisible-blank {
  visibility: hidden;
}

.swiper-autoheight, .swiper-autoheight .swiper-slide {
  height: auto;
}

.swiper-autoheight .swiper-wrapper {
  align-items: flex-start;
  transition-property: transform, height;
}

.swiper-backface-hidden .swiper-slide {
  transform: translateZ(0);
  -webkit-backface-visibility: hidden;
  backface-visibility: hidden;
}

.swiper-3d.swiper-css-mode .swiper-wrapper {
  perspective: 1200px;
}

.swiper-3d .swiper-wrapper {
  transform-style: preserve-3d;
}

.swiper-3d {
  perspective: 1200px;
}

.swiper-3d .swiper-cube-shadow, .swiper-3d .swiper-slide {
  transform-style: preserve-3d;
}

.swiper-css-mode > .swiper-wrapper {
  overflow: auto;
  scrollbar-width: none;
  -ms-overflow-style: none;
}

.swiper-css-mode > .swiper-wrapper::-webkit-scrollbar {
  display: none;
}

.swiper-css-mode > .swiper-wrapper > .swiper-slide {
  scroll-snap-align: start start;
}

.swiper-css-mode.swiper-horizontal > .swiper-wrapper {
  scroll-snap-type: x mandatory;
}

.swiper-css-mode.swiper-vertical > .swiper-wrapper {
  scroll-snap-type: y mandatory;
}

.swiper-css-mode.swiper-free-mode > .swiper-wrapper {
  scroll-snap-type: none;
}

.swiper-css-mode.swiper-free-mode > .swiper-wrapper > .swiper-slide {
  scroll-snap-align: none;
}

.swiper-css-mode.swiper-centered > .swiper-wrapper::before {
  content: "";
  flex-shrink: 0;
  order: 9999;
}

.swiper-css-mode.swiper-centered > .swiper-wrapper > .swiper-slide {
  scroll-snap-align: center center;
  scroll-snap-stop: always;
}

.swiper-css-mode.swiper-centered.swiper-horizontal > .swiper-wrapper > .swiper-slide:first-child {
  margin-inline-start: var(--swiper-centered-offset-before);
}

.swiper-css-mode.swiper-centered.swiper-horizontal > .swiper-wrapper::before {
  height: 100%;
  min-height: 1px;
  width: var(--swiper-centered-offset-after);
}

.swiper-css-mode.swiper-centered.swiper-vertical > .swiper-wrapper > .swiper-slide:first-child {
  margin-block-start: var(--swiper-centered-offset-before);
}

.swiper-css-mode.swiper-centered.swiper-vertical > .swiper-wrapper::before {
  width: 100%;
  min-width: 1px;
  height: var(--swiper-centered-offset-after);
}

.swiper-3d .swiper-slide-shadow, .swiper-3d .swiper-slide-shadow-bottom, .swiper-3d .swiper-slide-shadow-left, .swiper-3d .swiper-slide-shadow-right, .swiper-3d .swiper-slide-shadow-top {
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 10;
}

.swiper-3d .swiper-slide-shadow {
  background: rgba(0, 0, 0, 0.15);
}

.swiper-3d .swiper-slide-shadow-left {
  background-image: linear-gradient(to left, rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0));
}

.swiper-3d .swiper-slide-shadow-right {
  background-image: linear-gradient(to right, rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0));
}

.swiper-3d .swiper-slide-shadow-top {
  background-image: linear-gradient(to top, rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0));
}

.swiper-3d .swiper-slide-shadow-bottom {
  background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0));
}

.swiper-lazy-preloader {
  width: 42px;
  height: 42px;
  position: absolute;
  left: 50%;
  top: 50%;
  margin-left: -21px;
  margin-top: -21px;
  z-index: 10;
  transform-origin: 50%;
  box-sizing: border-box;
  border: 4px solid var(--swiper-preloader-color, var(--swiper-theme-color));
  border-radius: 50%;
  border-top-color: transparent;
}

.swiper-watch-progress .swiper-slide-visible .swiper-lazy-preloader, .swiper:not(.swiper-watch-progress) .swiper-lazy-preloader {
  animation: swiper-preloader-spin 1s infinite linear;
}

.swiper-lazy-preloader-white {
  --swiper-preloader-color:#fff;
}

.swiper-lazy-preloader-black {
  --swiper-preloader-color:#000;
}

@keyframes swiper-preloader-spin {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}
.swiper-virtual .swiper-slide {
  -webkit-backface-visibility: hidden;
  transform: translateZ(0);
}

.swiper-virtual.swiper-css-mode .swiper-wrapper::after {
  content: "";
  position: absolute;
  left: 0;
  top: 0;
  pointer-events: none;
}

.swiper-virtual.swiper-css-mode.swiper-horizontal .swiper-wrapper::after {
  height: 1px;
  width: var(--swiper-virtual-size);
}

.swiper-virtual.swiper-css-mode.swiper-vertical .swiper-wrapper::after {
  width: 1px;
  height: var(--swiper-virtual-size);
}

:root {
  --swiper-navigation-size:44px;
}

.swiper-button-next, .swiper-button-prev {
  position: absolute;
  top: var(--swiper-navigation-top-offset, 50%);
  width: calc(var(--swiper-navigation-size) / 44 * 27);
  height: var(--swiper-navigation-size);
  margin-top: calc(0px - var(--swiper-navigation-size) / 2);
  z-index: 10;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--swiper-navigation-color, var(--swiper-theme-color));
}

.swiper-button-next.swiper-button-disabled, .swiper-button-prev.swiper-button-disabled {
  opacity: 0.35;
  cursor: auto;
  pointer-events: none;
}

.swiper-button-next.swiper-button-hidden, .swiper-button-prev.swiper-button-hidden {
  opacity: 0;
  cursor: auto;
  pointer-events: none;
}

.swiper-navigation-disabled .swiper-button-next, .swiper-navigation-disabled .swiper-button-prev {
  display: none !important;
}

.swiper-button-next svg, .swiper-button-prev svg {
  width: 100%;
  height: 100%;
  object-fit: contain;
  transform-origin: center;
}

.swiper-rtl .swiper-button-next svg, .swiper-rtl .swiper-button-prev svg {
  transform: rotate(180deg);
}

.swiper-button-prev, .swiper-rtl .swiper-button-next {
  left: var(--swiper-navigation-sides-offset, 10px);
  right: auto;
}

.swiper-button-next, .swiper-rtl .swiper-button-prev {
  right: var(--swiper-navigation-sides-offset, 10px);
  left: auto;
}

.swiper-button-lock {
  display: none;
}

.swiper-button-next:after, .swiper-button-prev:after {
  font-family: swiper-icons;
  font-size: var(--swiper-navigation-size);
  text-transform: none !important;
  letter-spacing: 0;
  font-variant: initial;
  line-height: 1;
}

.swiper-button-prev:after, .swiper-rtl .swiper-button-next:after {
  content: "prev";
}

.swiper-button-next, .swiper-rtl .swiper-button-prev {
  right: var(--swiper-navigation-sides-offset, 10px);
  left: auto;
}

.swiper-button-next:after, .swiper-rtl .swiper-button-prev:after {
  content: "next";
}

.swiper-pagination {
  position: absolute;
  text-align: center;
  transition: 0.3s opacity;
  transform: translate3d(0, 0, 0);
  z-index: 10;
}

.swiper-pagination.swiper-pagination-hidden {
  opacity: 0;
}

.swiper-pagination-disabled > .swiper-pagination, .swiper-pagination.swiper-pagination-disabled {
  display: none !important;
}

.swiper-horizontal > .swiper-pagination-bullets, .swiper-pagination-bullets.swiper-pagination-horizontal, .swiper-pagination-custom, .swiper-pagination-fraction {
  bottom: var(--swiper-pagination-bottom, 8px);
  top: var(--swiper-pagination-top, auto);
  left: 0;
  width: 100%;
}

.swiper-pagination-bullets-dynamic {
  overflow: hidden;
  font-size: 0;
}

.swiper-pagination-bullets-dynamic .swiper-pagination-bullet {
  transform: scale(0.33);
  position: relative;
}

.swiper-pagination-bullets-dynamic .swiper-pagination-bullet-active {
  transform: scale(1);
}

.swiper-pagination-bullets-dynamic .swiper-pagination-bullet-active-main {
  transform: scale(1);
}

.swiper-pagination-bullets-dynamic .swiper-pagination-bullet-active-prev {
  transform: scale(0.66);
}

.swiper-pagination-bullets-dynamic .swiper-pagination-bullet-active-prev-prev {
  transform: scale(0.33);
}

.swiper-pagination-bullets-dynamic .swiper-pagination-bullet-active-next {
  transform: scale(0.66);
}

.swiper-pagination-bullets-dynamic .swiper-pagination-bullet-active-next-next {
  transform: scale(0.33);
}

.swiper-pagination-bullet {
  width: var(--swiper-pagination-bullet-width, var(--swiper-pagination-bullet-size, 8px));
  height: var(--swiper-pagination-bullet-height, var(--swiper-pagination-bullet-size, 8px));
  display: inline-block;
  border-radius: var(--swiper-pagination-bullet-border-radius, 50%);
  background: var(--swiper-pagination-bullet-inactive-color, #000);
  opacity: var(--swiper-pagination-bullet-inactive-opacity, 0.2);
}

button.swiper-pagination-bullet {
  border: none;
  margin: 0;
  padding: 0;
  box-shadow: none;
  -webkit-appearance: none;
  appearance: none;
}

.swiper-pagination-clickable .swiper-pagination-bullet {
  cursor: pointer;
}

.swiper-pagination-bullet:only-child {
  display: none !important;
}

.swiper-pagination-bullet-active {
  opacity: var(--swiper-pagination-bullet-opacity, 1);
  background: var(--swiper-pagination-color, var(--swiper-theme-color));
}

.swiper-pagination-vertical.swiper-pagination-bullets, .swiper-vertical > .swiper-pagination-bullets {
  right: var(--swiper-pagination-right, 8px);
  left: var(--swiper-pagination-left, auto);
  top: 50%;
  transform: translate3d(0px, -50%, 0);
}

.swiper-pagination-vertical.swiper-pagination-bullets .swiper-pagination-bullet, .swiper-vertical > .swiper-pagination-bullets .swiper-pagination-bullet {
  margin: var(--swiper-pagination-bullet-vertical-gap, 6px) 0;
  display: block;
}

.swiper-pagination-vertical.swiper-pagination-bullets.swiper-pagination-bullets-dynamic, .swiper-vertical > .swiper-pagination-bullets.swiper-pagination-bullets-dynamic {
  top: 50%;
  transform: translateY(-50%);
  width: 8px;
}

.swiper-pagination-vertical.swiper-pagination-bullets.swiper-pagination-bullets-dynamic .swiper-pagination-bullet, .swiper-vertical > .swiper-pagination-bullets.swiper-pagination-bullets-dynamic .swiper-pagination-bullet {
  display: inline-block;
  transition: 0.2s transform, 0.2s top;
}

.swiper-horizontal > .swiper-pagination-bullets .swiper-pagination-bullet, .swiper-pagination-horizontal.swiper-pagination-bullets .swiper-pagination-bullet {
  margin: 0 var(--swiper-pagination-bullet-horizontal-gap, 4px);
}

.swiper-horizontal > .swiper-pagination-bullets.swiper-pagination-bullets-dynamic, .swiper-pagination-horizontal.swiper-pagination-bullets.swiper-pagination-bullets-dynamic {
  left: 50%;
  transform: translateX(-50%);
  white-space: nowrap;
}

.swiper-horizontal > .swiper-pagination-bullets.swiper-pagination-bullets-dynamic .swiper-pagination-bullet, .swiper-pagination-horizontal.swiper-pagination-bullets.swiper-pagination-bullets-dynamic .swiper-pagination-bullet {
  transition: 0.2s transform, 0.2s left;
}

.swiper-horizontal.swiper-rtl > .swiper-pagination-bullets-dynamic .swiper-pagination-bullet {
  transition: 0.2s transform, 0.2s right;
}

.swiper-pagination-fraction {
  color: var(--swiper-pagination-fraction-color, inherit);
}

.swiper-pagination-progressbar {
  background: var(--swiper-pagination-progressbar-bg-color, rgba(0, 0, 0, 0.25));
  position: absolute;
}

.swiper-pagination-progressbar .swiper-pagination-progressbar-fill {
  background: var(--swiper-pagination-color, var(--swiper-theme-color));
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  transform: scale(0);
  transform-origin: left top;
}

.swiper-rtl .swiper-pagination-progressbar .swiper-pagination-progressbar-fill {
  transform-origin: right top;
}

.swiper-horizontal > .swiper-pagination-progressbar, .swiper-pagination-progressbar.swiper-pagination-horizontal, .swiper-pagination-progressbar.swiper-pagination-vertical.swiper-pagination-progressbar-opposite, .swiper-vertical > .swiper-pagination-progressbar.swiper-pagination-progressbar-opposite {
  width: 100%;
  height: var(--swiper-pagination-progressbar-size, 4px);
  left: 0;
  top: 0;
}

.swiper-horizontal > .swiper-pagination-progressbar.swiper-pagination-progressbar-opposite, .swiper-pagination-progressbar.swiper-pagination-horizontal.swiper-pagination-progressbar-opposite, .swiper-pagination-progressbar.swiper-pagination-vertical, .swiper-vertical > .swiper-pagination-progressbar {
  width: var(--swiper-pagination-progressbar-size, 4px);
  height: 100%;
  left: 0;
  top: 0;
}

.swiper-pagination-lock {
  display: none;
}

.swiper-scrollbar {
  border-radius: var(--swiper-scrollbar-border-radius, 10px);
  position: relative;
  touch-action: none;
  background: var(--swiper-scrollbar-bg-color, rgba(0, 0, 0, 0.1));
}

.swiper-scrollbar-disabled > .swiper-scrollbar, .swiper-scrollbar.swiper-scrollbar-disabled {
  display: none !important;
}

.swiper-horizontal > .swiper-scrollbar, .swiper-scrollbar.swiper-scrollbar-horizontal {
  position: absolute;
  left: var(--swiper-scrollbar-sides-offset, 1%);
  bottom: var(--swiper-scrollbar-bottom, 4px);
  top: var(--swiper-scrollbar-top, auto);
  z-index: 50;
  height: var(--swiper-scrollbar-size, 4px);
  width: calc(100% - 2 * var(--swiper-scrollbar-sides-offset, 1%));
}

.swiper-scrollbar.swiper-scrollbar-vertical, .swiper-vertical > .swiper-scrollbar {
  position: absolute;
  left: var(--swiper-scrollbar-left, auto);
  right: var(--swiper-scrollbar-right, 4px);
  top: var(--swiper-scrollbar-sides-offset, 1%);
  z-index: 50;
  width: var(--swiper-scrollbar-size, 4px);
  height: calc(100% - 2 * var(--swiper-scrollbar-sides-offset, 1%));
}

.swiper-scrollbar-drag {
  height: 100%;
  width: 100%;
  position: relative;
  background: var(--swiper-scrollbar-drag-bg-color, rgba(0, 0, 0, 0.5));
  border-radius: var(--swiper-scrollbar-border-radius, 10px);
  left: 0;
  top: 0;
}

.swiper-scrollbar-cursor-drag {
  cursor: move;
}

.swiper-scrollbar-lock {
  display: none;
}

.swiper-zoom-container {
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  text-align: center;
}

.swiper-zoom-container > canvas, .swiper-zoom-container > img, .swiper-zoom-container > svg {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}

.swiper-slide-zoomed {
  cursor: move;
  touch-action: none;
}

.swiper .swiper-notification {
  position: absolute;
  left: 0;
  top: 0;
  pointer-events: none;
  opacity: 0;
  z-index: -1000;
}

.swiper-free-mode > .swiper-wrapper {
  transition-timing-function: ease-out;
  margin: 0 auto;
}

.swiper-grid > .swiper-wrapper {
  flex-wrap: wrap;
}

.swiper-grid-column > .swiper-wrapper {
  flex-wrap: wrap;
  flex-direction: column;
}

.swiper-fade.swiper-free-mode .swiper-slide {
  transition-timing-function: ease-out;
}

.swiper-fade .swiper-slide {
  pointer-events: none;
  transition-property: opacity;
}

.swiper-fade .swiper-slide .swiper-slide {
  pointer-events: none;
}

.swiper-fade .swiper-slide-active {
  pointer-events: auto;
}

.swiper-fade .swiper-slide-active .swiper-slide-active {
  pointer-events: auto;
}

.swiper-cube {
  overflow: visible;
}

.swiper-cube .swiper-slide {
  pointer-events: none;
  -webkit-backface-visibility: hidden;
  backface-visibility: hidden;
  z-index: 1;
  visibility: hidden;
  transform-origin: 0 0;
  width: 100%;
  height: 100%;
}

.swiper-cube .swiper-slide .swiper-slide {
  pointer-events: none;
}

.swiper-cube.swiper-rtl .swiper-slide {
  transform-origin: 100% 0;
}

.swiper-cube .swiper-slide-active, .swiper-cube .swiper-slide-active .swiper-slide-active {
  pointer-events: auto;
}

.swiper-cube .swiper-slide-active, .swiper-cube .swiper-slide-next, .swiper-cube .swiper-slide-prev {
  pointer-events: auto;
  visibility: visible;
}

.swiper-cube .swiper-cube-shadow {
  position: absolute;
  left: 0;
  bottom: 0px;
  width: 100%;
  height: 100%;
  opacity: 0.6;
  z-index: 0;
}

.swiper-cube .swiper-cube-shadow:before {
  content: "";
  background: #000;
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  right: 0;
  filter: blur(50px);
}

.swiper-cube .swiper-slide-next + .swiper-slide {
  pointer-events: auto;
  visibility: visible;
}

.swiper-cube .swiper-slide-shadow-cube.swiper-slide-shadow-bottom, .swiper-cube .swiper-slide-shadow-cube.swiper-slide-shadow-left, .swiper-cube .swiper-slide-shadow-cube.swiper-slide-shadow-right, .swiper-cube .swiper-slide-shadow-cube.swiper-slide-shadow-top {
  z-index: 0;
  -webkit-backface-visibility: hidden;
  backface-visibility: hidden;
}

.swiper-flip {
  overflow: visible;
}

.swiper-flip .swiper-slide {
  pointer-events: none;
  -webkit-backface-visibility: hidden;
  backface-visibility: hidden;
  z-index: 1;
}

.swiper-flip .swiper-slide .swiper-slide {
  pointer-events: none;
}

.swiper-flip .swiper-slide-active, .swiper-flip .swiper-slide-active .swiper-slide-active {
  pointer-events: auto;
}

.swiper-flip .swiper-slide-shadow-flip.swiper-slide-shadow-bottom, .swiper-flip .swiper-slide-shadow-flip.swiper-slide-shadow-left, .swiper-flip .swiper-slide-shadow-flip.swiper-slide-shadow-right, .swiper-flip .swiper-slide-shadow-flip.swiper-slide-shadow-top {
  z-index: 0;
  -webkit-backface-visibility: hidden;
  backface-visibility: hidden;
}

.swiper-creative .swiper-slide {
  -webkit-backface-visibility: hidden;
  backface-visibility: hidden;
  overflow: hidden;
  transition-property: transform, opacity, height;
}

.swiper-cards {
  overflow: visible;
}

.swiper-cards .swiper-slide {
  transform-origin: center bottom;
  -webkit-backface-visibility: hidden;
  backface-visibility: hidden;
  overflow: hidden;
}</style><style>.theme-light {
  --toolbar-bg-color: #fff;
  --toolbar-outline-color: rgba(0, 0, 0, 0.2);
  --toolbar-box-shadow-color: rgba(0, 0, 0, 0.1);
  --toolbar-text-color: #1a1a1a;
  --toolbar-hover-text-color: rgb(31, 98, 238);
  --toolbar-hover-bg-color: linear-gradient(90deg, rgba(118, 116, 255, 0.15) 2.33%, rgba(51, 122, 254, 0.15) 39.87%, rgba(1, 172, 253, 0.15) 97.67%);
  --toolbar-line-color: rgba(0, 0, 0, 0.1);
  --toolbar-setting-shadow-color: rgba(100, 106, 112, 0.2);
  --toolbar-setting-item-hover-color: rgba(73, 123, 229, 0.1);
  --swiper-wrapper-bg-color: rgba(0, 0, 0, 0.65);
  --swiper-btn-bg-color: rgba(0, 0, 0, 0.6);
  --swiper-btn-text-color: #fff;
  --swiper-pagination-bg-color: rgba(0, 0, 0, 0.5);
  --swiper-pagination-text-color: rgba(255, 255, 255, 0.5);
  --swiper-pagination-current-text-color: #fff;
  --setting-icon-normal-url: url("chrome-extension://bnjoienjhhclcabnkbhhfndecoipmcdg/background/keniu/images/icon/light/icon_setting_normal.png");
  --setting-icon-hover-url: url("chrome-extension://bnjoienjhhclcabnkbhhfndecoipmcdg/background/keniu/images/icon/light/icon_setting_active.png");
  --setting-icon-close-url: url("chrome-extension://bnjoienjhhclcabnkbhhfndecoipmcdg/background/keniu/images/icon/light/icon_close_normal.png");
  --setting-icon-contact-url: url("chrome-extension://bnjoienjhhclcabnkbhhfndecoipmcdg/background/keniu/images/icon/light/icon_contact_normal.png");
}

.theme-dark {
  --toolbar-bg-color: rgb(54, 54, 53);
  --toolbar-outline-color: rgb(94, 94, 93);
  --toolbar-box-shadow-color: rgba(0, 0, 0, 0.1);
  --toolbar-text-color: #fff;
  --toolbar-hover-text-color: rgb(31, 98, 238);
  --toolbar-hover-bg-color: rgb(66, 66, 65);
  --toolbar-line-color: rgb(74, 74, 73);
  --toolbar-setting-shadow-color: rgba(100, 106, 112, 0.2);
  --toolbar-setting-item-hover-color: rgba(73, 123, 229, 0.1);
  --swiper-wrapper-bg-color: rgba(0, 0, 0, 0.65);
  --swiper-btn-bg-color: rgba(0, 0, 0, 0.6);
  --swiper-btn-text-color: #fff;
  --swiper-pagination-bg-color: rgba(0, 0, 0, 0.5);
  --swiper-pagination-text-color: rgba(255, 255, 255, 0.5);
  --swiper-pagination-current-text-color: #fff;
  --setting-icon-normal-url: url("chrome-extension://bnjoienjhhclcabnkbhhfndecoipmcdg/background/keniu/images/icon/dark/icon_setting_normal.png");
  --setting-icon-hover-url: url("chrome-extension://bnjoienjhhclcabnkbhhfndecoipmcdg/background/keniu/images/icon/dark/icon_setting_active.png");
  --setting-icon-close-url: url("chrome-extension://bnjoienjhhclcabnkbhhfndecoipmcdg/background/keniu/images/icon/dark/icon_close_normal.png");
  --setting-icon-contact-url: url("chrome-extension://bnjoienjhhclcabnkbhhfndecoipmcdg/background/keniu/images/icon/dark/icon_contact_normal.png");
}

:host {
  z-index: 100;
}

.ai-picture-swiper-warp {
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  height: 100%;
  background-color: var(--swiper-wrapper-bg-color);
  z-index: 9999;
  opacity: 0;
  transition: all 0.3s;
  visibility: hidden;
}

.ai-picture-swiper-warp.show {
  visibility: visible;
  opacity: 1;
}

.ai-picture-swiper-warp.out {
  visibility: hidden;
  opacity: 0;
}

.ai-picture-swiper {
  width: 100%;
}

.ai-picture-wrapper {
  align-items: center;
}

.ai-picture-slide {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh !important;
  overflow: hidden;
}

.ai-picture-slide img {
  max-width: 100%;
  max-height: 100%;
  height: auto;
  width: auto;
}

.ai-picture-btn {
  width: 54px !important;
  height: 54px !important;
  border-radius: 27px;
  background-color: var(--swiper-btn-bg-color);
  color: var(--swiper-btn-text-color) !important;
  z-index: 9999;
}

.ai-picture-btn::after {
  font-size: 25px !important;
}

.ai-picture-pagination {
  width: initial !important;
  height: 30px;
  line-height: 30px;
  padding: 0 15px;
  margin: 0 auto !important;
  background: var(--swiper-pagination-bg-color);
  border-radius: 15px;
  left: 50%;
  color: var(--swiper-pagination-text-color);
  z-index: 9999;
}

.ai-picture-pagination .swiper-pagination-current {
  color: var(--swiper-pagination-current-text-color);
}

.ai-picture-close {
  position: absolute;
  top: 20px;
  right: 20px;
  width: 48px;
  height: 48px;
  cursor: pointer;
  z-index: 9999999;
}

.ai-picture-close img {
  width: 100%;
  height: 100%;
}</style></template></div></body><div id="ai-translate-content-root" class="ai-translate-widget"><template shadowrootmode="open"><style data-rc-order="prepend" rc-util-key="@ant-design-icons">
.anticon {
  display: inline-flex;
  align-items: center;
  color: inherit;
  font-style: normal;
  line-height: 0;
  text-align: center;
  text-transform: none;
  vertical-align: -0.125em;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.anticon > * {
  line-height: 1;
}

.anticon svg {
  display: inline-block;
}

.anticon::before {
  display: none;
}

.anticon .anticon-icon {
  display: block;
}

.anticon[tabindex] {
  cursor: pointer;
}

.anticon-spin::before,
.anticon-spin {
  display: inline-block;
  -webkit-animation: loadingCircle 1s infinite linear;
  animation: loadingCircle 1s infinite linear;
}

@-webkit-keyframes loadingCircle {
  100% {
    -webkit-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}

@keyframes loadingCircle {
  100% {
    -webkit-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}
</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="90g12z" data-token-hash="css-var-r0">.css-var-r0{--ant-blue:#1677FF;--ant-purple:#722ED1;--ant-cyan:#13C2C2;--ant-green:#52C41A;--ant-magenta:#EB2F96;--ant-pink:#EB2F96;--ant-red:#F5222D;--ant-orange:#FA8C16;--ant-yellow:#FADB14;--ant-volcano:#FA541C;--ant-geekblue:#2F54EB;--ant-gold:#FAAD14;--ant-lime:#A0D911;--ant-color-primary:#6165f7;--ant-color-success:#52c41a;--ant-color-warning:#faad14;--ant-color-error:#ff4d4f;--ant-color-info:#1677ff;--ant-color-link:#1677ff;--ant-color-text-base:#000;--ant-color-bg-base:#fff;--ant-font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial,
'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol',
'Noto Color Emoji';--ant-font-family-code:'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;--ant-font-size:14px;--ant-line-width:1px;--ant-line-type:solid;--ant-motion-ease-out-circ:cubic-bezier(0.08, 0.82, 0.17, 1);--ant-motion-ease-in-out-circ:cubic-bezier(0.78, 0.14, 0.15, 0.86);--ant-motion-ease-out:cubic-bezier(0.215, 0.61, 0.355, 1);--ant-motion-ease-in-out:cubic-bezier(0.645, 0.045, 0.355, 1);--ant-motion-ease-out-back:cubic-bezier(0.12, 0.4, 0.29, 1.46);--ant-motion-ease-in-back:cubic-bezier(0.71, -0.46, 0.88, 0.6);--ant-motion-ease-in-quint:cubic-bezier(0.755, 0.05, 0.855, 0.06);--ant-motion-ease-out-quint:cubic-bezier(0.23, 1, 0.32, 1);--ant-border-radius:6px;--ant-size-popup-arrow:16px;--ant-control-height:32px;--ant-z-index-base:0;--ant-z-index-popup-base:1000;--ant-opacity-image:1px;--ant-color-primary-hover:#595DE3;--ant-color-text:#333333;--ant-blue-1:#e6f4ff;--ant-blue-2:#bae0ff;--ant-blue-3:#91caff;--ant-blue-4:#69b1ff;--ant-blue-5:#4096ff;--ant-blue-6:#1677ff;--ant-blue-7:#0958d9;--ant-blue-8:#003eb3;--ant-blue-9:#002c8c;--ant-blue-10:#001d66;--ant-purple-1:#f9f0ff;--ant-purple-2:#efdbff;--ant-purple-3:#d3adf7;--ant-purple-4:#b37feb;--ant-purple-5:#9254de;--ant-purple-6:#722ed1;--ant-purple-7:#531dab;--ant-purple-8:#391085;--ant-purple-9:#22075e;--ant-purple-10:#120338;--ant-cyan-1:#e6fffb;--ant-cyan-2:#b5f5ec;--ant-cyan-3:#87e8de;--ant-cyan-4:#5cdbd3;--ant-cyan-5:#36cfc9;--ant-cyan-6:#13c2c2;--ant-cyan-7:#08979c;--ant-cyan-8:#006d75;--ant-cyan-9:#00474f;--ant-cyan-10:#002329;--ant-green-1:#f6ffed;--ant-green-2:#d9f7be;--ant-green-3:#b7eb8f;--ant-green-4:#95de64;--ant-green-5:#73d13d;--ant-green-6:#52c41a;--ant-green-7:#389e0d;--ant-green-8:#237804;--ant-green-9:#135200;--ant-green-10:#092b00;--ant-magenta-1:#fff0f6;--ant-magenta-2:#ffd6e7;--ant-magenta-3:#ffadd2;--ant-magenta-4:#ff85c0;--ant-magenta-5:#f759ab;--ant-magenta-6:#eb2f96;--ant-magenta-7:#c41d7f;--ant-magenta-8:#9e1068;--ant-magenta-9:#780650;--ant-magenta-10:#520339;--ant-pink-1:#fff0f6;--ant-pink-2:#ffd6e7;--ant-pink-3:#ffadd2;--ant-pink-4:#ff85c0;--ant-pink-5:#f759ab;--ant-pink-6:#eb2f96;--ant-pink-7:#c41d7f;--ant-pink-8:#9e1068;--ant-pink-9:#780650;--ant-pink-10:#520339;--ant-red-1:#fff1f0;--ant-red-2:#ffccc7;--ant-red-3:#ffa39e;--ant-red-4:#ff7875;--ant-red-5:#ff4d4f;--ant-red-6:#f5222d;--ant-red-7:#cf1322;--ant-red-8:#a8071a;--ant-red-9:#820014;--ant-red-10:#5c0011;--ant-orange-1:#fff7e6;--ant-orange-2:#ffe7ba;--ant-orange-3:#ffd591;--ant-orange-4:#ffc069;--ant-orange-5:#ffa940;--ant-orange-6:#fa8c16;--ant-orange-7:#d46b08;--ant-orange-8:#ad4e00;--ant-orange-9:#873800;--ant-orange-10:#612500;--ant-yellow-1:#feffe6;--ant-yellow-2:#ffffb8;--ant-yellow-3:#fffb8f;--ant-yellow-4:#fff566;--ant-yellow-5:#ffec3d;--ant-yellow-6:#fadb14;--ant-yellow-7:#d4b106;--ant-yellow-8:#ad8b00;--ant-yellow-9:#876800;--ant-yellow-10:#614700;--ant-volcano-1:#fff2e8;--ant-volcano-2:#ffd8bf;--ant-volcano-3:#ffbb96;--ant-volcano-4:#ff9c6e;--ant-volcano-5:#ff7a45;--ant-volcano-6:#fa541c;--ant-volcano-7:#d4380d;--ant-volcano-8:#ad2102;--ant-volcano-9:#871400;--ant-volcano-10:#610b00;--ant-geekblue-1:#f0f5ff;--ant-geekblue-2:#d6e4ff;--ant-geekblue-3:#adc6ff;--ant-geekblue-4:#85a5ff;--ant-geekblue-5:#597ef7;--ant-geekblue-6:#2f54eb;--ant-geekblue-7:#1d39c4;--ant-geekblue-8:#10239e;--ant-geekblue-9:#061178;--ant-geekblue-10:#030852;--ant-gold-1:#fffbe6;--ant-gold-2:#fff1b8;--ant-gold-3:#ffe58f;--ant-gold-4:#ffd666;--ant-gold-5:#ffc53d;--ant-gold-6:#faad14;--ant-gold-7:#d48806;--ant-gold-8:#ad6800;--ant-gold-9:#874d00;--ant-gold-10:#613400;--ant-lime-1:#fcffe6;--ant-lime-2:#f4ffb8;--ant-lime-3:#eaff8f;--ant-lime-4:#d3f261;--ant-lime-5:#bae637;--ant-lime-6:#a0d911;--ant-lime-7:#7cb305;--ant-lime-8:#5b8c00;--ant-lime-9:#3f6600;--ant-lime-10:#254000;--ant-color-text-secondary:rgba(0, 0, 0, 0.65);--ant-color-text-tertiary:rgba(0, 0, 0, 0.45);--ant-color-text-quaternary:rgba(0, 0, 0, 0.25);--ant-color-fill:rgba(0, 0, 0, 0.15);--ant-color-fill-secondary:rgba(0, 0, 0, 0.06);--ant-color-fill-tertiary:rgba(0, 0, 0, 0.04);--ant-color-fill-quaternary:rgba(0, 0, 0, 0.02);--ant-color-bg-layout:#f5f5f5;--ant-color-bg-container:#ffffff;--ant-color-bg-elevated:#ffffff;--ant-color-bg-spotlight:rgba(0, 0, 0, 0.85);--ant-color-bg-blur:transparent;--ant-color-border:#d9d9d9;--ant-color-border-secondary:#f0f0f0;--ant-color-primary-bg:#f0f3ff;--ant-color-primary-bg-hover:#f0f2ff;--ant-color-primary-border:#dee2ff;--ant-color-primary-border-hover:#b5bcff;--ant-color-primary-active:#4747d1;--ant-color-primary-text-hover:#8c94ff;--ant-color-primary-text:#6165f7;--ant-color-primary-text-active:#4747d1;--ant-color-success-bg:#f6ffed;--ant-color-success-bg-hover:#d9f7be;--ant-color-success-border:#b7eb8f;--ant-color-success-border-hover:#95de64;--ant-color-success-hover:#95de64;--ant-color-success-active:#389e0d;--ant-color-success-text-hover:#73d13d;--ant-color-success-text:#52c41a;--ant-color-success-text-active:#389e0d;--ant-color-error-bg:#fff2f0;--ant-color-error-bg-hover:#fff1f0;--ant-color-error-bg-active:#ffccc7;--ant-color-error-border:#ffccc7;--ant-color-error-border-hover:#ffa39e;--ant-color-error-hover:#ff7875;--ant-color-error-active:#d9363e;--ant-color-error-text-hover:#ff7875;--ant-color-error-text:#ff4d4f;--ant-color-error-text-active:#d9363e;--ant-color-warning-bg:#fffbe6;--ant-color-warning-bg-hover:#fff1b8;--ant-color-warning-border:#ffe58f;--ant-color-warning-border-hover:#ffd666;--ant-color-warning-hover:#ffd666;--ant-color-warning-active:#d48806;--ant-color-warning-text-hover:#ffc53d;--ant-color-warning-text:#faad14;--ant-color-warning-text-active:#d48806;--ant-color-info-bg:#e6f4ff;--ant-color-info-bg-hover:#bae0ff;--ant-color-info-border:#91caff;--ant-color-info-border-hover:#69b1ff;--ant-color-info-hover:#69b1ff;--ant-color-info-active:#0958d9;--ant-color-info-text-hover:#4096ff;--ant-color-info-text:#1677ff;--ant-color-info-text-active:#0958d9;--ant-color-link-hover:#69b1ff;--ant-color-link-active:#0958d9;--ant-color-bg-mask:rgba(0, 0, 0, 0.45);--ant-color-white:#fff;--ant-font-size-sm:12px;--ant-font-size-lg:16px;--ant-font-size-xl:20px;--ant-font-size-heading-1:38px;--ant-font-size-heading-2:30px;--ant-font-size-heading-3:24px;--ant-font-size-heading-4:20px;--ant-font-size-heading-5:16px;--ant-line-height:1.5714285714285714;--ant-line-height-lg:1.5;--ant-line-height-sm:1.6666666666666667;--ant-font-height:22px;--ant-font-height-lg:24px;--ant-font-height-sm:20px;--ant-line-height-heading-1:1.2105263157894737;--ant-line-height-heading-2:1.2666666666666666;--ant-line-height-heading-3:1.3333333333333333;--ant-line-height-heading-4:1.4;--ant-line-height-heading-5:1.5;--ant-control-height-sm:24px;--ant-control-height-xs:16px;--ant-control-height-lg:40px;--ant-motion-duration-fast:0.1s;--ant-motion-duration-mid:0.2s;--ant-motion-duration-slow:0.3s;--ant-line-width-bold:2px;--ant-border-radius-xs:2px;--ant-border-radius-sm:4px;--ant-border-radius-lg:8px;--ant-border-radius-outer:4px;--ant-color-fill-content:rgba(0, 0, 0, 0.06);--ant-color-fill-content-hover:rgba(0, 0, 0, 0.15);--ant-color-fill-alter:rgba(0, 0, 0, 0.02);--ant-color-bg-container-disabled:rgba(0, 0, 0, 0.04);--ant-color-border-bg:#ffffff;--ant-color-split:rgba(5, 5, 5, 0.06);--ant-color-text-placeholder:rgba(0, 0, 0, 0.25);--ant-color-text-disabled:rgba(0, 0, 0, 0.25);--ant-color-text-heading:#333333;--ant-color-text-label:rgba(0, 0, 0, 0.65);--ant-color-text-description:rgba(0, 0, 0, 0.45);--ant-color-text-light-solid:#fff;--ant-color-highlight:#ff4d4f;--ant-color-bg-text-hover:rgba(0, 0, 0, 0.06);--ant-color-bg-text-active:rgba(0, 0, 0, 0.15);--ant-color-icon:rgba(0, 0, 0, 0.45);--ant-color-icon-hover:#333333;--ant-color-error-outline:rgba(255, 38, 5, 0.06);--ant-color-warning-outline:rgba(255, 215, 5, 0.1);--ant-font-size-icon:12px;--ant-line-width-focus:4px;--ant-control-outline-width:2px;--ant-control-interactive-size:16px;--ant-control-item-bg-hover:rgba(0, 0, 0, 0.04);--ant-control-item-bg-active:#f0f3ff;--ant-control-item-bg-active-hover:#f0f2ff;--ant-control-item-bg-active-disabled:rgba(0, 0, 0, 0.15);--ant-control-tmp-outline:rgba(0, 0, 0, 0.02);--ant-control-outline:rgba(5, 55, 255, 0.06);--ant-font-weight-strong:600;--ant-opacity-loading:0.65;--ant-link-decoration:none;--ant-link-hover-decoration:none;--ant-link-focus-decoration:none;--ant-control-padding-horizontal:12px;--ant-control-padding-horizontal-sm:8px;--ant-padding-xxs:4px;--ant-padding-xs:8px;--ant-padding-sm:12px;--ant-padding:16px;--ant-padding-md:20px;--ant-padding-lg:24px;--ant-padding-xl:32px;--ant-padding-content-horizontal-lg:24px;--ant-padding-content-vertical-lg:16px;--ant-padding-content-horizontal:16px;--ant-padding-content-vertical:12px;--ant-padding-content-horizontal-sm:16px;--ant-padding-content-vertical-sm:8px;--ant-margin-xxs:4px;--ant-margin-xs:8px;--ant-margin-sm:12px;--ant-margin:16px;--ant-margin-md:20px;--ant-margin-lg:24px;--ant-margin-xl:32px;--ant-margin-xxl:48px;--ant-box-shadow:
      0 6px 16px 0 rgba(0, 0, 0, 0.08),
      0 3px 6px -4px rgba(0, 0, 0, 0.12),
      0 9px 28px 8px rgba(0, 0, 0, 0.05)
    ;--ant-box-shadow-secondary:
      0 6px 16px 0 rgba(0, 0, 0, 0.08),
      0 3px 6px -4px rgba(0, 0, 0, 0.12),
      0 9px 28px 8px rgba(0, 0, 0, 0.05)
    ;--ant-box-shadow-tertiary:
      0 1px 2px 0 rgba(0, 0, 0, 0.03),
      0 1px 6px -1px rgba(0, 0, 0, 0.02),
      0 2px 4px 0 rgba(0, 0, 0, 0.02)
    ;--ant-box-shadow-popover-arrow:2px 2px 5px rgba(0, 0, 0, 0.05);--ant-box-shadow-card:
      0 1px 2px -2px rgba(0, 0, 0, 0.16),
      0 3px 6px 0 rgba(0, 0, 0, 0.12),
      0 5px 12px 4px rgba(0, 0, 0, 0.09)
    ;--ant-box-shadow-drawer-right:
      -6px 0 16px 0 rgba(0, 0, 0, 0.08),
      -3px 0 6px -4px rgba(0, 0, 0, 0.12),
      -9px 0 28px 8px rgba(0, 0, 0, 0.05)
    ;--ant-box-shadow-drawer-left:
      6px 0 16px 0 rgba(0, 0, 0, 0.08),
      3px 0 6px -4px rgba(0, 0, 0, 0.12),
      9px 0 28px 8px rgba(0, 0, 0, 0.05)
    ;--ant-box-shadow-drawer-up:
      0 6px 16px 0 rgba(0, 0, 0, 0.08),
      0 3px 6px -4px rgba(0, 0, 0, 0.12),
      0 9px 28px 8px rgba(0, 0, 0, 0.05)
    ;--ant-box-shadow-drawer-down:
      0 -6px 16px 0 rgba(0, 0, 0, 0.08),
      0 -3px 6px -4px rgba(0, 0, 0, 0.12),
      0 -9px 28px 8px rgba(0, 0, 0, 0.05)
    ;--ant-box-shadow-tabs-overflow-left:inset 10px 0 8px -8px rgba(0, 0, 0, 0.08);--ant-box-shadow-tabs-overflow-right:inset -10px 0 8px -8px rgba(0, 0, 0, 0.08);--ant-box-shadow-tabs-overflow-top:inset 0 10px 8px -8px rgba(0, 0, 0, 0.08);--ant-box-shadow-tabs-overflow-bottom:inset 0 -10px 8px -8px rgba(0, 0, 0, 0.08);}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="eztakr" data-token-hash="css-var-r0">.css-var-r0.ant-popover{--ant-popover-title-min-width:177px;--ant-popover-z-index-popup:1030;--ant-popover-arrow-shadow-width:8.970562748477143px;--ant-popover-arrow-path:path('M 0 8 A 4 4 0 0 0 2.82842712474619 6.82842712474619 L 6.585786437626905 3.0710678118654755 A 2 2 0 0 1 9.414213562373096 3.0710678118654755 L 13.17157287525381 6.82842712474619 A 4 4 0 0 0 16 8 Z');--ant-popover-arrow-polygon:polygon(1.6568542494923806px 100%, 50% 1.6568542494923806px, 14.34314575050762px 100%, 1.6568542494923806px 100%);--ant-popover-arrow-offset-horizontal:12px;--ant-popover-arrow-offset-vertical:8px;--ant-popover-inner-padding:12px;--ant-popover-title-margin-bottom:8px;--ant-popover-title-padding:0px;--ant-popover-title-border-bottom:none;--ant-popover-inner-content-padding:0px;}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="ejo49b" data-token-hash="1k8se45">:where(.css-1dmvnh0) a{color:var(--ant-color-link);text-decoration:var(--ant-link-decoration);background-color:transparent;outline:none;cursor:pointer;transition:color var(--ant-motion-duration-slow);-webkit-text-decoration-skip:objects;}:where(.css-1dmvnh0) a:hover{color:var(--ant-color-link-hover);}:where(.css-1dmvnh0) a:active{color:var(--ant-color-link-active);}:where(.css-1dmvnh0) a:active,:where(.css-1dmvnh0) a:hover{text-decoration:var(--ant-link-hover-decoration);outline:0;}:where(.css-1dmvnh0) a:focus{text-decoration:var(--ant-link-focus-decoration);outline:0;}:where(.css-1dmvnh0) a[disabled]{color:var(--ant-color-text-disabled);cursor:not-allowed;}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="y68uin" data-token-hash="1k8se45"></style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="1ucji5w" data-token-hash="1k8se45">:where(.css-1dmvnh0).ant-popover{box-sizing:border-box;margin:0;padding:0;color:var(--ant-color-text);font-size:var(--ant-font-size);line-height:var(--ant-line-height);list-style:none;font-family:var(--ant-font-family);position:absolute;top:0;left:0;z-index:var(--ant-popover-z-index-popup);font-weight:normal;white-space:normal;text-align:start;cursor:auto;user-select:text;transform-origin:var(--arrow-x, 50%) var(--arrow-y, 50%);--antd-arrow-background-color:var(--ant-color-bg-elevated);width:max-content;max-width:100vw;}:where(.css-1dmvnh0).ant-popover-rtl{direction:rtl;}:where(.css-1dmvnh0).ant-popover-hidden{display:none;}:where(.css-1dmvnh0).ant-popover .ant-popover-content{position:relative;}:where(.css-1dmvnh0).ant-popover .ant-popover-inner{background-color:var(--ant-color-bg-elevated);background-clip:padding-box;border-radius:var(--ant-border-radius-lg);box-shadow:var(--ant-box-shadow-secondary);padding:var(--ant-popover-inner-padding);}:where(.css-1dmvnh0).ant-popover .ant-popover-title{min-width:var(--ant-popover-title-min-width);margin-bottom:var(--ant-popover-title-margin-bottom);color:var(--ant-color-text-heading);font-weight:var(--ant-font-weight-strong);border-bottom:var(--ant-popover-title-border-bottom);padding:var(--ant-popover-title-padding);}:where(.css-1dmvnh0).ant-popover .ant-popover-inner-content{color:var(--ant-color-text);padding:var(--ant-popover-inner-content-padding);}:where(.css-1dmvnh0).ant-popover .ant-popover-arrow{position:absolute;z-index:1;display:block;pointer-events:none;width:var(--ant-size-popup-arrow);height:var(--ant-size-popup-arrow);overflow:hidden;}:where(.css-1dmvnh0).ant-popover .ant-popover-arrow::before{position:absolute;bottom:0;inset-inline-start:0;width:var(--ant-size-popup-arrow);height:calc(var(--ant-size-popup-arrow) / 2);background:var(--antd-arrow-background-color);clip-path:var(--ant-popover-arrow-polygon);clip-path:var(--ant-popover-arrow-path);content:"";}:where(.css-1dmvnh0).ant-popover .ant-popover-arrow::after{content:"";position:absolute;width:var(--ant-popover-arrow-shadow-width);height:var(--ant-popover-arrow-shadow-width);bottom:0;inset-inline:0;margin:auto;border-radius:0 0 var(--ant-border-radius-xs) 0;transform:translateY(50%) rotate(-135deg);box-shadow:var(--ant-box-shadow-popover-arrow);z-index:0;background:transparent;}:where(.css-1dmvnh0).ant-popover .ant-popover-arrow:before{background:var(--antd-arrow-background-color);}:where(.css-1dmvnh0).ant-popover-placement-top>.ant-popover-arrow,:where(.css-1dmvnh0).ant-popover-placement-topLeft>.ant-popover-arrow,:where(.css-1dmvnh0).ant-popover-placement-topRight>.ant-popover-arrow{bottom:0;transform:translateY(100%) rotate(180deg);}:where(.css-1dmvnh0).ant-popover-placement-top>.ant-popover-arrow{left:50%;transform:translateX(-50%) translateY(100%) rotate(180deg);}:where(.css-1dmvnh0).ant-popover-placement-topLeft>.ant-popover-arrow{left:var(--ant-popover-arrow-offset-horizontal);}:where(.css-1dmvnh0).ant-popover-placement-topRight>.ant-popover-arrow{right:var(--ant-popover-arrow-offset-horizontal);}:where(.css-1dmvnh0).ant-popover-placement-bottom>.ant-popover-arrow,:where(.css-1dmvnh0).ant-popover-placement-bottomLeft>.ant-popover-arrow,:where(.css-1dmvnh0).ant-popover-placement-bottomRight>.ant-popover-arrow{top:0;transform:translateY(-100%);}:where(.css-1dmvnh0).ant-popover-placement-bottom>.ant-popover-arrow{left:50%;transform:translateX(-50%) translateY(-100%);}:where(.css-1dmvnh0).ant-popover-placement-bottomLeft>.ant-popover-arrow{left:var(--ant-popover-arrow-offset-horizontal);}:where(.css-1dmvnh0).ant-popover-placement-bottomRight>.ant-popover-arrow{right:var(--ant-popover-arrow-offset-horizontal);}:where(.css-1dmvnh0).ant-popover-placement-left>.ant-popover-arrow,:where(.css-1dmvnh0).ant-popover-placement-leftTop>.ant-popover-arrow,:where(.css-1dmvnh0).ant-popover-placement-leftBottom>.ant-popover-arrow{right:0;transform:translateX(100%) rotate(90deg);}:where(.css-1dmvnh0).ant-popover-placement-left>.ant-popover-arrow{top:50%;transform:translateY(-50%) translateX(100%) rotate(90deg);}:where(.css-1dmvnh0).ant-popover-placement-leftTop>.ant-popover-arrow{top:var(--ant-popover-arrow-offset-vertical);}:where(.css-1dmvnh0).ant-popover-placement-leftBottom>.ant-popover-arrow{bottom:var(--ant-popover-arrow-offset-vertical);}:where(.css-1dmvnh0).ant-popover-placement-right>.ant-popover-arrow,:where(.css-1dmvnh0).ant-popover-placement-rightTop>.ant-popover-arrow,:where(.css-1dmvnh0).ant-popover-placement-rightBottom>.ant-popover-arrow{left:0;transform:translateX(-100%) rotate(-90deg);}:where(.css-1dmvnh0).ant-popover-placement-right>.ant-popover-arrow{top:50%;transform:translateY(-50%) translateX(-100%) rotate(-90deg);}:where(.css-1dmvnh0).ant-popover-placement-rightTop>.ant-popover-arrow{top:var(--ant-popover-arrow-offset-vertical);}:where(.css-1dmvnh0).ant-popover-placement-rightBottom>.ant-popover-arrow{bottom:var(--ant-popover-arrow-offset-vertical);}:where(.css-1dmvnh0).ant-popover-pure{position:relative;max-width:none;margin:var(--ant-size-popup-arrow);display:inline-block;}:where(.css-1dmvnh0).ant-popover-pure .ant-popover-content{display:inline-block;}:where(.css-1dmvnh0).ant-popover.ant-popover-blue{--antd-arrow-background-color:var(--ant-blue-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-blue .ant-popover-inner{background-color:var(--ant-blue-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-blue .ant-popover-arrow{background:transparent;}:where(.css-1dmvnh0).ant-popover.ant-popover-purple{--antd-arrow-background-color:var(--ant-purple-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-purple .ant-popover-inner{background-color:var(--ant-purple-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-purple .ant-popover-arrow{background:transparent;}:where(.css-1dmvnh0).ant-popover.ant-popover-cyan{--antd-arrow-background-color:var(--ant-cyan-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-cyan .ant-popover-inner{background-color:var(--ant-cyan-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-cyan .ant-popover-arrow{background:transparent;}:where(.css-1dmvnh0).ant-popover.ant-popover-green{--antd-arrow-background-color:var(--ant-green-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-green .ant-popover-inner{background-color:var(--ant-green-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-green .ant-popover-arrow{background:transparent;}:where(.css-1dmvnh0).ant-popover.ant-popover-magenta{--antd-arrow-background-color:var(--ant-magenta-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-magenta .ant-popover-inner{background-color:var(--ant-magenta-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-magenta .ant-popover-arrow{background:transparent;}:where(.css-1dmvnh0).ant-popover.ant-popover-pink{--antd-arrow-background-color:var(--ant-pink-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-pink .ant-popover-inner{background-color:var(--ant-pink-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-pink .ant-popover-arrow{background:transparent;}:where(.css-1dmvnh0).ant-popover.ant-popover-red{--antd-arrow-background-color:var(--ant-red-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-red .ant-popover-inner{background-color:var(--ant-red-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-red .ant-popover-arrow{background:transparent;}:where(.css-1dmvnh0).ant-popover.ant-popover-orange{--antd-arrow-background-color:var(--ant-orange-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-orange .ant-popover-inner{background-color:var(--ant-orange-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-orange .ant-popover-arrow{background:transparent;}:where(.css-1dmvnh0).ant-popover.ant-popover-yellow{--antd-arrow-background-color:var(--ant-yellow-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-yellow .ant-popover-inner{background-color:var(--ant-yellow-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-yellow .ant-popover-arrow{background:transparent;}:where(.css-1dmvnh0).ant-popover.ant-popover-volcano{--antd-arrow-background-color:var(--ant-volcano-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-volcano .ant-popover-inner{background-color:var(--ant-volcano-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-volcano .ant-popover-arrow{background:transparent;}:where(.css-1dmvnh0).ant-popover.ant-popover-geekblue{--antd-arrow-background-color:var(--ant-geekblue-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-geekblue .ant-popover-inner{background-color:var(--ant-geekblue-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-geekblue .ant-popover-arrow{background:transparent;}:where(.css-1dmvnh0).ant-popover.ant-popover-lime{--antd-arrow-background-color:var(--ant-lime-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-lime .ant-popover-inner{background-color:var(--ant-lime-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-lime .ant-popover-arrow{background:transparent;}:where(.css-1dmvnh0).ant-popover.ant-popover-gold{--antd-arrow-background-color:var(--ant-gold-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-gold .ant-popover-inner{background-color:var(--ant-gold-6);}:where(.css-1dmvnh0).ant-popover.ant-popover-gold .ant-popover-arrow{background:transparent;}:where(.css-1dmvnh0).ant-zoom-big-enter,:where(.css-1dmvnh0).ant-zoom-big-appear{animation-duration:var(--ant-motion-duration-mid);animation-fill-mode:both;animation-play-state:paused;}:where(.css-1dmvnh0).ant-zoom-big-leave{animation-duration:var(--ant-motion-duration-mid);animation-fill-mode:both;animation-play-state:paused;}:where(.css-1dmvnh0).ant-zoom-big-enter.ant-zoom-big-enter-active,:where(.css-1dmvnh0).ant-zoom-big-appear.ant-zoom-big-appear-active{animation-name:css-1dmvnh0-antZoomBigIn;animation-play-state:running;}:where(.css-1dmvnh0).ant-zoom-big-leave.ant-zoom-big-leave-active{animation-name:css-1dmvnh0-antZoomBigOut;animation-play-state:running;pointer-events:none;}:where(.css-1dmvnh0).ant-zoom-big-enter,:where(.css-1dmvnh0).ant-zoom-big-appear{transform:scale(0);opacity:0;animation-timing-function:var(--ant-motion-ease-out-circ);}:where(.css-1dmvnh0).ant-zoom-big-enter-prepare,:where(.css-1dmvnh0).ant-zoom-big-appear-prepare{transform:none;}:where(.css-1dmvnh0).ant-zoom-big-leave{animation-timing-function:var(--ant-motion-ease-in-out-circ);}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="_effect-css-1dmvnh0-antZoomBigIn">@keyframes css-1dmvnh0-antZoomBigIn{0%{transform:scale(0.8);opacity:0;}100%{transform:scale(1);opacity:1;}}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="_effect-css-1dmvnh0-antZoomBigOut">@keyframes css-1dmvnh0-antZoomBigOut{0%{transform:scale(1);}100%{transform:scale(0.8);opacity:0;}}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="1t9b8t5" data-token-hash="css-var-r0">.css-var-r0.ant-modal-css-var{--ant-modal-footer-bg:transparent;--ant-modal-header-bg:#ffffff;--ant-modal-title-line-height:1.5;--ant-modal-title-font-size:16px;--ant-modal-content-bg:#ffffff;--ant-modal-title-color:#333333;--ant-modal-content-padding:20px 24px;--ant-modal-header-padding:0px;--ant-modal-header-border-bottom:none;--ant-modal-header-margin-bottom:8px;--ant-modal-body-padding:0px;--ant-modal-footer-padding:0px;--ant-modal-footer-border-top:none;--ant-modal-footer-border-radius:0px;--ant-modal-footer-margin-top:12px;--ant-modal-confirm-body-padding:0px;--ant-modal-confirm-icon-margin-inline-end:12px;--ant-modal-confirm-btns-margin-top:12px;}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="1s5oxsp" data-token-hash="1k8se45">:where(.css-1dmvnh0).ant-modal-css-var{font-family:var(--ant-font-family);font-size:var(--ant-font-size);box-sizing:border-box;}:where(.css-1dmvnh0).ant-modal-css-var::before,:where(.css-1dmvnh0).ant-modal-css-var::after{box-sizing:border-box;}:where(.css-1dmvnh0).ant-modal-css-var [class^="ant-modal"],:where(.css-1dmvnh0).ant-modal-css-var [class*=" ant-modal"]{box-sizing:border-box;}:where(.css-1dmvnh0).ant-modal-css-var [class^="ant-modal"]::before,:where(.css-1dmvnh0).ant-modal-css-var [class*=" ant-modal"]::before,:where(.css-1dmvnh0).ant-modal-css-var [class^="ant-modal"]::after,:where(.css-1dmvnh0).ant-modal-css-var [class*=" ant-modal"]::after{box-sizing:border-box;}:where(.css-1dmvnh0).ant-modal-root .ant-modal-wrap-rtl{direction:rtl;}:where(.css-1dmvnh0).ant-modal-root .ant-modal-centered{text-align:center;}:where(.css-1dmvnh0).ant-modal-root .ant-modal-centered::before{display:inline-block;width:0;height:100%;vertical-align:middle;content:"";}:where(.css-1dmvnh0).ant-modal-root .ant-modal-centered .ant-modal{top:0;display:inline-block;padding-bottom:0;text-align:start;vertical-align:middle;}@media (max-width: 767px){:where(.css-1dmvnh0).ant-modal-root .ant-modal{max-width:calc(100vw - 16px);margin:var(--ant-margin-xs) auto;}:where(.css-1dmvnh0).ant-modal-root .ant-modal-centered .ant-modal{flex:1;}}:where(.css-1dmvnh0).ant-modal{box-sizing:border-box;margin:0 auto;padding:0;color:var(--ant-color-text);font-size:var(--ant-font-size);line-height:var(--ant-line-height);list-style:none;font-family:var(--ant-font-family);pointer-events:none;position:relative;top:100px;width:auto;max-width:calc(100vw - calc(var(--ant-margin) * 2));padding-bottom:var(--ant-padding-lg);}:where(.css-1dmvnh0).ant-modal .ant-modal-title{margin:0;color:var(--ant-modal-title-color);font-weight:var(--ant-font-weight-strong);font-size:var(--ant-modal-title-font-size);line-height:var(--ant-modal-title-line-height);word-wrap:break-word;}:where(.css-1dmvnh0).ant-modal .ant-modal-content{position:relative;background-color:var(--ant-modal-content-bg);background-clip:padding-box;border:0;border-radius:var(--ant-border-radius-lg);box-shadow:var(--ant-box-shadow);pointer-events:auto;padding:var(--ant-modal-content-padding);}:where(.css-1dmvnh0).ant-modal .ant-modal-close{position:absolute;top:calc((calc(calc(var(--ant-line-height-heading-5) * var(--ant-font-size-heading-5)) + calc(var(--ant-padding) * 2)) - var(--ant-control-height)) / 2);inset-inline-end:calc((calc(calc(var(--ant-line-height-heading-5) * var(--ant-font-size-heading-5)) + calc(var(--ant-padding) * 2)) - var(--ant-control-height)) / 2);z-index:calc(var(--ant-z-index-popup-base) + 10);padding:0;color:var(--ant-color-icon);font-weight:var(--ant-font-weight-strong);line-height:1;text-decoration:none;background:transparent;border-radius:var(--ant-border-radius-sm);width:var(--ant-control-height);height:var(--ant-control-height);border:0;outline:0;cursor:pointer;transition:color var(--ant-motion-duration-mid),background-color var(--ant-motion-duration-mid);}:where(.css-1dmvnh0).ant-modal .ant-modal-close-x{display:flex;font-size:var(--ant-font-size-lg);font-style:normal;line-height:var(--ant-control-height);justify-content:center;text-transform:none;text-rendering:auto;}:where(.css-1dmvnh0).ant-modal .ant-modal-close:hover{color:var(--ant-color-icon-hover);background-color:var(--ant-color-bg-text-hover);text-decoration:none;}:where(.css-1dmvnh0).ant-modal .ant-modal-close:active{background-color:var(--ant-color-bg-text-active);}:where(.css-1dmvnh0).ant-modal .ant-modal-close:focus-visible{outline:var(--ant-line-width-focus) solid var(--ant-color-primary-border);outline-offset:1px;transition:outline-offset 0s,outline 0s;}:where(.css-1dmvnh0).ant-modal .ant-modal-header{color:var(--ant-color-text);background:var(--ant-modal-header-bg);border-radius:var(--ant-border-radius-lg) var(--ant-border-radius-lg) 0 0;margin-bottom:var(--ant-modal-header-margin-bottom);padding:var(--ant-modal-header-padding);border-bottom:var(--ant-modal-header-border-bottom);}:where(.css-1dmvnh0).ant-modal .ant-modal-body{font-size:var(--ant-font-size);line-height:var(--ant-line-height);word-wrap:break-word;padding:var(--ant-modal-body-padding);}:where(.css-1dmvnh0).ant-modal .ant-modal-body .ant-modal-body-skeleton{width:100%;height:100%;display:flex;justify-content:center;align-items:center;margin:var(--ant-margin) auto;}:where(.css-1dmvnh0).ant-modal .ant-modal-footer{text-align:end;background:var(--ant-modal-footer-bg);margin-top:var(--ant-modal-footer-margin-top);padding:var(--ant-modal-footer-padding);border-top:var(--ant-modal-footer-border-top);border-radius:var(--ant-modal-footer-border-radius);}:where(.css-1dmvnh0).ant-modal .ant-modal-footer >.ant-btn+.ant-btn{margin-inline-start:var(--ant-margin-xs);}:where(.css-1dmvnh0).ant-modal .ant-modal-open{overflow:hidden;}:where(.css-1dmvnh0).ant-modal-pure-panel{top:auto;padding:0;display:flex;flex-direction:column;}:where(.css-1dmvnh0).ant-modal-pure-panel .ant-modal-content,:where(.css-1dmvnh0).ant-modal-pure-panel .ant-modal-body,:where(.css-1dmvnh0).ant-modal-pure-panel .ant-modal-confirm-body-wrapper{display:flex;flex-direction:column;flex:auto;}:where(.css-1dmvnh0).ant-modal-pure-panel .ant-modal-confirm-body{margin-bottom:auto;}:where(.css-1dmvnh0).ant-modal-root .ant-modal-wrap-rtl{direction:rtl;}:where(.css-1dmvnh0).ant-modal-root .ant-modal-wrap-rtl .ant-modal-confirm-body{direction:rtl;}:where(.css-1dmvnh0).ant-modal-root .ant-modal.ant-zoom-enter,:where(.css-1dmvnh0).ant-modal-root .ant-modal.ant-zoom-appear{transform:none;opacity:0;animation-duration:var(--ant-motion-duration-slow);user-select:none;}:where(.css-1dmvnh0).ant-modal-root .ant-modal.ant-zoom-leave .ant-modal-content{pointer-events:none;}:where(.css-1dmvnh0).ant-modal-root .ant-modal-mask{position:fixed;inset:0;z-index:var(--ant-z-index-popup-base);height:100%;background-color:var(--ant-color-bg-mask);pointer-events:none;}:where(.css-1dmvnh0).ant-modal-root .ant-modal-mask .ant-modal-hidden{display:none;}:where(.css-1dmvnh0).ant-modal-root .ant-modal-wrap{position:fixed;inset:0;z-index:var(--ant-z-index-popup-base);overflow:auto;outline:0;-webkit-overflow-scrolling:touch;}:where(.css-1dmvnh0).ant-modal-root .ant-fade-enter,:where(.css-1dmvnh0).ant-modal-root .ant-fade-appear{animation-duration:var(--ant-motion-duration-mid);animation-fill-mode:both;animation-play-state:paused;}:where(.css-1dmvnh0).ant-modal-root .ant-fade-leave{animation-duration:var(--ant-motion-duration-mid);animation-fill-mode:both;animation-play-state:paused;}:where(.css-1dmvnh0).ant-modal-root .ant-fade-enter.ant-fade-enter-active,:where(.css-1dmvnh0).ant-modal-root .ant-fade-appear.ant-fade-appear-active{animation-name:css-1dmvnh0-antFadeIn;animation-play-state:running;}:where(.css-1dmvnh0).ant-modal-root .ant-fade-leave.ant-fade-leave-active{animation-name:css-1dmvnh0-antFadeOut;animation-play-state:running;pointer-events:none;}:where(.css-1dmvnh0).ant-modal-root .ant-fade-enter,:where(.css-1dmvnh0).ant-modal-root .ant-fade-appear{opacity:0;animation-timing-function:linear;}:where(.css-1dmvnh0).ant-modal-root .ant-fade-leave{animation-timing-function:linear;}:where(.css-1dmvnh0).ant-zoom-enter,:where(.css-1dmvnh0).ant-zoom-appear{animation-duration:var(--ant-motion-duration-mid);animation-fill-mode:both;animation-play-state:paused;}:where(.css-1dmvnh0).ant-zoom-leave{animation-duration:var(--ant-motion-duration-mid);animation-fill-mode:both;animation-play-state:paused;}:where(.css-1dmvnh0).ant-zoom-enter.ant-zoom-enter-active,:where(.css-1dmvnh0).ant-zoom-appear.ant-zoom-appear-active{animation-name:css-1dmvnh0-antZoomIn;animation-play-state:running;}:where(.css-1dmvnh0).ant-zoom-leave.ant-zoom-leave-active{animation-name:css-1dmvnh0-antZoomOut;animation-play-state:running;pointer-events:none;}:where(.css-1dmvnh0).ant-zoom-enter,:where(.css-1dmvnh0).ant-zoom-appear{transform:scale(0);opacity:0;animation-timing-function:var(--ant-motion-ease-out-circ);}:where(.css-1dmvnh0).ant-zoom-enter-prepare,:where(.css-1dmvnh0).ant-zoom-appear-prepare{transform:none;}:where(.css-1dmvnh0).ant-zoom-leave{animation-timing-function:var(--ant-motion-ease-in-out-circ);}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="_effect-css-1dmvnh0-antFadeIn">@keyframes css-1dmvnh0-antFadeIn{0%{opacity:0;}100%{opacity:1;}}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="_effect-css-1dmvnh0-antFadeOut">@keyframes css-1dmvnh0-antFadeOut{0%{opacity:1;}100%{opacity:0;}}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="_effect-css-1dmvnh0-antZoomIn">@keyframes css-1dmvnh0-antZoomIn{0%{transform:scale(0.2);opacity:0;}100%{transform:scale(1);opacity:1;}}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="_effect-css-1dmvnh0-antZoomOut">@keyframes css-1dmvnh0-antZoomOut{0%{transform:scale(1);}100%{transform:scale(0.2);opacity:0;}}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="1s8t51e" data-token-hash="css-var-r0">.css-var-r0.ant-tooltip{--ant-tooltip-z-index-popup:1070;--ant-tooltip-arrow-offset-horizontal:12px;--ant-tooltip-arrow-offset-vertical:8px;--ant-tooltip-arrow-shadow-width:8.970562748477143px;--ant-tooltip-arrow-path:path('M 0 8 A 4 4 0 0 0 2.82842712474619 6.82842712474619 L 6.585786437626905 3.0710678118654755 A 2 2 0 0 1 9.414213562373096 3.0710678118654755 L 13.17157287525381 6.82842712474619 A 4 4 0 0 0 16 8 Z');--ant-tooltip-arrow-polygon:polygon(1.6568542494923806px 100%, 50% 1.6568542494923806px, 14.34314575050762px 100%, 1.6568542494923806px 100%);}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="k2rvgh" data-token-hash="1k8se45">:where(.css-1dmvnh0).ant-tooltip{box-sizing:border-box;margin:0;padding:0;color:var(--ant-color-text);font-size:var(--ant-font-size);line-height:var(--ant-line-height);list-style:none;font-family:var(--ant-font-family);position:absolute;z-index:var(--ant-tooltip-z-index-popup);display:block;width:max-content;max-width:250px;visibility:visible;transform-origin:var(--arrow-x, 50%) var(--arrow-y, 50%);--antd-arrow-background-color:var(--ant-color-bg-spotlight);}:where(.css-1dmvnh0).ant-tooltip-hidden{display:none;}:where(.css-1dmvnh0).ant-tooltip .ant-tooltip-inner{min-width:1em;min-height:var(--ant-control-height);padding:calc(var(--ant-padding-sm) / 2) var(--ant-padding-xs);color:var(--ant-color-text-light-solid);text-align:start;text-decoration:none;word-wrap:break-word;background-color:var(--ant-color-bg-spotlight);border-radius:var(--ant-border-radius);box-shadow:var(--ant-box-shadow-secondary);box-sizing:border-box;}:where(.css-1dmvnh0).ant-tooltip-placement-left .ant-tooltip-inner,:where(.css-1dmvnh0).ant-tooltip-placement-leftTop .ant-tooltip-inner,:where(.css-1dmvnh0).ant-tooltip-placement-leftBottom .ant-tooltip-inner,:where(.css-1dmvnh0).ant-tooltip-placement-right .ant-tooltip-inner,:where(.css-1dmvnh0).ant-tooltip-placement-rightTop .ant-tooltip-inner,:where(.css-1dmvnh0).ant-tooltip-placement-rightBottom .ant-tooltip-inner{border-radius:min(var(--ant-border-radius),8px);}:where(.css-1dmvnh0).ant-tooltip .ant-tooltip-content{position:relative;}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-blue .ant-tooltip-inner{background-color:var(--ant-blue-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-blue .ant-tooltip-arrow{--antd-arrow-background-color:var(--ant-blue-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-purple .ant-tooltip-inner{background-color:var(--ant-purple-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-purple .ant-tooltip-arrow{--antd-arrow-background-color:var(--ant-purple-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-cyan .ant-tooltip-inner{background-color:var(--ant-cyan-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-cyan .ant-tooltip-arrow{--antd-arrow-background-color:var(--ant-cyan-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-green .ant-tooltip-inner{background-color:var(--ant-green-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-green .ant-tooltip-arrow{--antd-arrow-background-color:var(--ant-green-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-magenta .ant-tooltip-inner{background-color:var(--ant-magenta-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-magenta .ant-tooltip-arrow{--antd-arrow-background-color:var(--ant-magenta-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-pink .ant-tooltip-inner{background-color:var(--ant-pink-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-pink .ant-tooltip-arrow{--antd-arrow-background-color:var(--ant-pink-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-red .ant-tooltip-inner{background-color:var(--ant-red-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-red .ant-tooltip-arrow{--antd-arrow-background-color:var(--ant-red-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-orange .ant-tooltip-inner{background-color:var(--ant-orange-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-orange .ant-tooltip-arrow{--antd-arrow-background-color:var(--ant-orange-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-yellow .ant-tooltip-inner{background-color:var(--ant-yellow-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-yellow .ant-tooltip-arrow{--antd-arrow-background-color:var(--ant-yellow-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-volcano .ant-tooltip-inner{background-color:var(--ant-volcano-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-volcano .ant-tooltip-arrow{--antd-arrow-background-color:var(--ant-volcano-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-geekblue .ant-tooltip-inner{background-color:var(--ant-geekblue-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-geekblue .ant-tooltip-arrow{--antd-arrow-background-color:var(--ant-geekblue-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-lime .ant-tooltip-inner{background-color:var(--ant-lime-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-lime .ant-tooltip-arrow{--antd-arrow-background-color:var(--ant-lime-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-gold .ant-tooltip-inner{background-color:var(--ant-gold-6);}:where(.css-1dmvnh0).ant-tooltip.ant-tooltip-gold .ant-tooltip-arrow{--antd-arrow-background-color:var(--ant-gold-6);}:where(.css-1dmvnh0).ant-tooltip-rtl{direction:rtl;}:where(.css-1dmvnh0).ant-tooltip .ant-tooltip-arrow{position:absolute;z-index:1;display:block;pointer-events:none;width:var(--ant-size-popup-arrow);height:var(--ant-size-popup-arrow);overflow:hidden;}:where(.css-1dmvnh0).ant-tooltip .ant-tooltip-arrow::before{position:absolute;bottom:0;inset-inline-start:0;width:var(--ant-size-popup-arrow);height:calc(var(--ant-size-popup-arrow) / 2);background:var(--antd-arrow-background-color);clip-path:var(--ant-tooltip-arrow-polygon);clip-path:var(--ant-tooltip-arrow-path);content:"";}:where(.css-1dmvnh0).ant-tooltip .ant-tooltip-arrow::after{content:"";position:absolute;width:var(--ant-tooltip-arrow-shadow-width);height:var(--ant-tooltip-arrow-shadow-width);bottom:0;inset-inline:0;margin:auto;border-radius:0 0 var(--ant-border-radius-xs) 0;transform:translateY(50%) rotate(-135deg);box-shadow:var(--ant-box-shadow-popover-arrow);z-index:0;background:transparent;}:where(.css-1dmvnh0).ant-tooltip .ant-tooltip-arrow:before{background:var(--antd-arrow-background-color);}:where(.css-1dmvnh0).ant-tooltip-placement-top>.ant-tooltip-arrow,:where(.css-1dmvnh0).ant-tooltip-placement-topLeft>.ant-tooltip-arrow,:where(.css-1dmvnh0).ant-tooltip-placement-topRight>.ant-tooltip-arrow{bottom:0;transform:translateY(100%) rotate(180deg);}:where(.css-1dmvnh0).ant-tooltip-placement-top>.ant-tooltip-arrow{left:50%;transform:translateX(-50%) translateY(100%) rotate(180deg);}:where(.css-1dmvnh0).ant-tooltip-placement-topLeft>.ant-tooltip-arrow{left:var(--ant-tooltip-arrow-offset-horizontal);}:where(.css-1dmvnh0).ant-tooltip-placement-topRight>.ant-tooltip-arrow{right:var(--ant-tooltip-arrow-offset-horizontal);}:where(.css-1dmvnh0).ant-tooltip-placement-bottom>.ant-tooltip-arrow,:where(.css-1dmvnh0).ant-tooltip-placement-bottomLeft>.ant-tooltip-arrow,:where(.css-1dmvnh0).ant-tooltip-placement-bottomRight>.ant-tooltip-arrow{top:0;transform:translateY(-100%);}:where(.css-1dmvnh0).ant-tooltip-placement-bottom>.ant-tooltip-arrow{left:50%;transform:translateX(-50%) translateY(-100%);}:where(.css-1dmvnh0).ant-tooltip-placement-bottomLeft>.ant-tooltip-arrow{left:var(--ant-tooltip-arrow-offset-horizontal);}:where(.css-1dmvnh0).ant-tooltip-placement-bottomRight>.ant-tooltip-arrow{right:var(--ant-tooltip-arrow-offset-horizontal);}:where(.css-1dmvnh0).ant-tooltip-placement-left>.ant-tooltip-arrow,:where(.css-1dmvnh0).ant-tooltip-placement-leftTop>.ant-tooltip-arrow,:where(.css-1dmvnh0).ant-tooltip-placement-leftBottom>.ant-tooltip-arrow{right:0;transform:translateX(100%) rotate(90deg);}:where(.css-1dmvnh0).ant-tooltip-placement-left>.ant-tooltip-arrow{top:50%;transform:translateY(-50%) translateX(100%) rotate(90deg);}:where(.css-1dmvnh0).ant-tooltip-placement-leftTop>.ant-tooltip-arrow{top:var(--ant-tooltip-arrow-offset-vertical);}:where(.css-1dmvnh0).ant-tooltip-placement-leftBottom>.ant-tooltip-arrow{bottom:var(--ant-tooltip-arrow-offset-vertical);}:where(.css-1dmvnh0).ant-tooltip-placement-right>.ant-tooltip-arrow,:where(.css-1dmvnh0).ant-tooltip-placement-rightTop>.ant-tooltip-arrow,:where(.css-1dmvnh0).ant-tooltip-placement-rightBottom>.ant-tooltip-arrow{left:0;transform:translateX(-100%) rotate(-90deg);}:where(.css-1dmvnh0).ant-tooltip-placement-right>.ant-tooltip-arrow{top:50%;transform:translateY(-50%) translateX(-100%) rotate(-90deg);}:where(.css-1dmvnh0).ant-tooltip-placement-rightTop>.ant-tooltip-arrow{top:var(--ant-tooltip-arrow-offset-vertical);}:where(.css-1dmvnh0).ant-tooltip-placement-rightBottom>.ant-tooltip-arrow{bottom:var(--ant-tooltip-arrow-offset-vertical);}:where(.css-1dmvnh0).ant-tooltip-pure{position:relative;max-width:none;margin:var(--ant-size-popup-arrow);}:where(.css-1dmvnh0).ant-zoom-big-fast-enter,:where(.css-1dmvnh0).ant-zoom-big-fast-appear{animation-duration:var(--ant-motion-duration-fast);animation-fill-mode:both;animation-play-state:paused;}:where(.css-1dmvnh0).ant-zoom-big-fast-leave{animation-duration:var(--ant-motion-duration-fast);animation-fill-mode:both;animation-play-state:paused;}:where(.css-1dmvnh0).ant-zoom-big-fast-enter.ant-zoom-big-fast-enter-active,:where(.css-1dmvnh0).ant-zoom-big-fast-appear.ant-zoom-big-fast-appear-active{animation-name:css-1dmvnh0-antZoomBigIn;animation-play-state:running;}:where(.css-1dmvnh0).ant-zoom-big-fast-leave.ant-zoom-big-fast-leave-active{animation-name:css-1dmvnh0-antZoomBigOut;animation-play-state:running;pointer-events:none;}:where(.css-1dmvnh0).ant-zoom-big-fast-enter,:where(.css-1dmvnh0).ant-zoom-big-fast-appear{transform:scale(0);opacity:0;animation-timing-function:var(--ant-motion-ease-out-circ);}:where(.css-1dmvnh0).ant-zoom-big-fast-enter-prepare,:where(.css-1dmvnh0).ant-zoom-big-fast-appear-prepare{transform:none;}:where(.css-1dmvnh0).ant-zoom-big-fast-leave{animation-timing-function:var(--ant-motion-ease-in-out-circ);}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="1732av8" data-token-hash="css-var-r0">.css-var-r0.ant-dropdown-css-var{--ant-dropdown-z-index-popup:1050;--ant-dropdown-padding-block:5px;--ant-dropdown-arrow-offset-horizontal:12px;--ant-dropdown-arrow-offset-vertical:8px;--ant-dropdown-arrow-shadow-width:8.970562748477143px;--ant-dropdown-arrow-path:path('M 0 8 A 4 4 0 0 0 2.82842712474619 6.82842712474619 L 6.585786437626905 3.0710678118654755 A 2 2 0 0 1 9.414213562373096 3.0710678118654755 L 13.17157287525381 6.82842712474619 A 4 4 0 0 0 16 8 Z');--ant-dropdown-arrow-polygon:polygon(1.6568542494923806px 100%, 50% 1.6568542494923806px, 14.34314575050762px 100%, 1.6568542494923806px 100%);}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="4vhpnu" data-token-hash="1k8se45">:where(.css-1dmvnh0).ant-dropdown{position:absolute;top:-9999px;left:-9999px;z-index:var(--ant-dropdown-z-index-popup);display:block;}:where(.css-1dmvnh0).ant-dropdown::before{position:absolute;inset-block:calc(var(--ant-size-popup-arrow) / 2 - calc(var(--ant-size-popup-arrow) / 2 + var(--ant-margin-xxs)));z-index:-9999;opacity:0.0001;content:"";}:where(.css-1dmvnh0).ant-dropdown-trigger.ant-btn>.anticon-down,:where(.css-1dmvnh0).ant-dropdown-trigger.ant-btn>.ant-btn-icon>.anticon-down{font-size:var(--ant-font-size-icon);}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-wrap{position:relative;}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-wrap .ant-btn>.anticon-down{font-size:var(--ant-font-size-icon);}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-wrap .anticon-down::before{transition:transform var(--ant-motion-duration-mid);}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-wrap-open .anticon-down::before{transform:rotate(180deg);}:where(.css-1dmvnh0).ant-dropdown-hidden,:where(.css-1dmvnh0).ant-dropdown-menu-hidden,:where(.css-1dmvnh0).ant-dropdown-menu-submenu-hidden{display:none;}:where(.css-1dmvnh0).ant-dropdown.ant-slide-down-enter.ant-slide-down-enter-active.ant-dropdown-placement-bottomLeft,:where(.css-1dmvnh0).ant-dropdown.ant-slide-down-appear.ant-slide-down-appear-active.ant-dropdown-placement-bottomLeft,:where(.css-1dmvnh0).ant-dropdown.ant-slide-down-enter.ant-slide-down-enter-active.ant-dropdown-placement-bottom,:where(.css-1dmvnh0).ant-dropdown.ant-slide-down-appear.ant-slide-down-appear-active.ant-dropdown-placement-bottom,:where(.css-1dmvnh0).ant-dropdown.ant-slide-down-enter.ant-slide-down-enter-active.ant-dropdown-placement-bottomRight,:where(.css-1dmvnh0).ant-dropdown.ant-slide-down-appear.ant-slide-down-appear-active.ant-dropdown-placement-bottomRight{animation-name:css-1dmvnh0-antSlideUpIn;}:where(.css-1dmvnh0).ant-dropdown.ant-slide-up-enter.ant-slide-up-enter-active.ant-dropdown-placement-topLeft,:where(.css-1dmvnh0).ant-dropdown.ant-slide-up-appear.ant-slide-up-appear-active.ant-dropdown-placement-topLeft,:where(.css-1dmvnh0).ant-dropdown.ant-slide-up-enter.ant-slide-up-enter-active.ant-dropdown-placement-top,:where(.css-1dmvnh0).ant-dropdown.ant-slide-up-appear.ant-slide-up-appear-active.ant-dropdown-placement-top,:where(.css-1dmvnh0).ant-dropdown.ant-slide-up-enter.ant-slide-up-enter-active.ant-dropdown-placement-topRight,:where(.css-1dmvnh0).ant-dropdown.ant-slide-up-appear.ant-slide-up-appear-active.ant-dropdown-placement-topRight{animation-name:css-1dmvnh0-antSlideDownIn;}:where(.css-1dmvnh0).ant-dropdown.ant-slide-down-leave.ant-slide-down-leave-active.ant-dropdown-placement-bottomLeft,:where(.css-1dmvnh0).ant-dropdown.ant-slide-down-leave.ant-slide-down-leave-active.ant-dropdown-placement-bottom,:where(.css-1dmvnh0).ant-dropdown.ant-slide-down-leave.ant-slide-down-leave-active.ant-dropdown-placement-bottomRight{animation-name:css-1dmvnh0-antSlideUpOut;}:where(.css-1dmvnh0).ant-dropdown.ant-slide-up-leave.ant-slide-up-leave-active.ant-dropdown-placement-topLeft,:where(.css-1dmvnh0).ant-dropdown.ant-slide-up-leave.ant-slide-up-leave-active.ant-dropdown-placement-top,:where(.css-1dmvnh0).ant-dropdown.ant-slide-up-leave.ant-slide-up-leave-active.ant-dropdown-placement-topRight{animation-name:css-1dmvnh0-antSlideDownOut;}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-arrow{position:absolute;z-index:1;display:block;pointer-events:none;width:var(--ant-size-popup-arrow);height:var(--ant-size-popup-arrow);overflow:hidden;}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-arrow::before{position:absolute;bottom:0;inset-inline-start:0;width:var(--ant-size-popup-arrow);height:calc(var(--ant-size-popup-arrow) / 2);background:var(--ant-color-bg-elevated);clip-path:var(--ant-dropdown-arrow-polygon);clip-path:var(--ant-dropdown-arrow-path);content:"";}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-arrow::after{content:"";position:absolute;width:var(--ant-dropdown-arrow-shadow-width);height:var(--ant-dropdown-arrow-shadow-width);bottom:0;inset-inline:0;margin:auto;border-radius:0 0 var(--ant-border-radius-xs) 0;transform:translateY(50%) rotate(-135deg);box-shadow:var(--ant-box-shadow-popover-arrow);z-index:0;background:transparent;}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-arrow:before{background:var(--ant-color-bg-elevated);}:where(.css-1dmvnh0).ant-dropdown-placement-top>.ant-dropdown-arrow,:where(.css-1dmvnh0).ant-dropdown-placement-topLeft>.ant-dropdown-arrow,:where(.css-1dmvnh0).ant-dropdown-placement-topRight>.ant-dropdown-arrow{bottom:0;transform:translateY(100%) rotate(180deg);}:where(.css-1dmvnh0).ant-dropdown-placement-top>.ant-dropdown-arrow{left:50%;transform:translateX(-50%) translateY(100%) rotate(180deg);}:where(.css-1dmvnh0).ant-dropdown-placement-topLeft>.ant-dropdown-arrow{left:var(--ant-dropdown-arrow-offset-horizontal);}:where(.css-1dmvnh0).ant-dropdown-placement-topRight>.ant-dropdown-arrow{right:var(--ant-dropdown-arrow-offset-horizontal);}:where(.css-1dmvnh0).ant-dropdown-placement-bottom>.ant-dropdown-arrow,:where(.css-1dmvnh0).ant-dropdown-placement-bottomLeft>.ant-dropdown-arrow,:where(.css-1dmvnh0).ant-dropdown-placement-bottomRight>.ant-dropdown-arrow{top:0;transform:translateY(-100%);}:where(.css-1dmvnh0).ant-dropdown-placement-bottom>.ant-dropdown-arrow{left:50%;transform:translateX(-50%) translateY(-100%);}:where(.css-1dmvnh0).ant-dropdown-placement-bottomLeft>.ant-dropdown-arrow{left:var(--ant-dropdown-arrow-offset-horizontal);}:where(.css-1dmvnh0).ant-dropdown-placement-bottomRight>.ant-dropdown-arrow{right:var(--ant-dropdown-arrow-offset-horizontal);}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu{position:relative;margin:0;}:where(.css-1dmvnh0).ant-dropdown-menu-submenu-popup{position:absolute;z-index:var(--ant-dropdown-z-index-popup);background:transparent;box-shadow:none;transform-origin:0 0;}:where(.css-1dmvnh0).ant-dropdown-menu-submenu-popup ul,:where(.css-1dmvnh0).ant-dropdown-menu-submenu-popup li{list-style:none;margin:0;}:where(.css-1dmvnh0).ant-dropdown,:where(.css-1dmvnh0).ant-dropdown-menu-submenu{box-sizing:border-box;margin:0;padding:0;color:var(--ant-color-text);font-size:var(--ant-font-size);line-height:var(--ant-line-height);list-style:none;font-family:var(--ant-font-family);}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu{padding:var(--ant-padding-xxs);list-style-type:none;background-color:var(--ant-color-bg-elevated);background-clip:padding-box;border-radius:var(--ant-border-radius-lg);outline:none;box-shadow:var(--ant-box-shadow-secondary);}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu:focus-visible,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu:focus-visible{outline:var(--ant-line-width-focus) solid var(--ant-color-primary-border);outline-offset:1px;transition:outline-offset 0s,outline 0s;}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu:empty,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu:empty{padding:0;box-shadow:none;}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-item-group-title,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-item-group-title{padding:var(--ant-dropdown-padding-block) var(--ant-control-padding-horizontal);color:var(--ant-color-text-description);transition:all var(--ant-motion-duration-mid);}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-item,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-item{position:relative;display:flex;align-items:center;}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-item-icon,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-item-icon{min-width:var(--ant-font-size);margin-inline-end:var(--ant-margin-xs);font-size:var(--ant-font-size-sm);}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-title-content,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-title-content{flex:auto;}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-title-content >a,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-title-content >a{color:inherit;transition:all var(--ant-motion-duration-mid);}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-title-content >a:hover,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-title-content >a:hover{color:inherit;}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-title-content >a::after,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-title-content >a::after{position:absolute;inset:0;content:"";}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-item,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-item,:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-submenu-title,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-submenu-title{clear:both;margin:0;padding:var(--ant-dropdown-padding-block) var(--ant-control-padding-horizontal);color:var(--ant-color-text);font-weight:normal;font-size:var(--ant-font-size);line-height:var(--ant-line-height);cursor:pointer;transition:all var(--ant-motion-duration-mid);border-radius:var(--ant-border-radius-sm);}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-item:hover,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-item:hover,:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-submenu-title:hover,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-submenu-title:hover,:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-item-active,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-item-active,:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-submenu-title-active,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-submenu-title-active{background-color:var(--ant-control-item-bg-hover);}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-item:focus-visible,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-item:focus-visible,:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-submenu-title:focus-visible,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-submenu-title:focus-visible{outline:var(--ant-line-width-focus) solid var(--ant-color-primary-border);outline-offset:1px;transition:outline-offset 0s,outline 0s;}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-item-selected,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-item-selected,:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-submenu-title-selected,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-submenu-title-selected{color:var(--ant-color-primary);background-color:var(--ant-control-item-bg-active);}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-item-selected:hover,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-item-selected:hover,:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-submenu-title-selected:hover,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-submenu-title-selected:hover,:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-item-selected-active,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-item-selected-active,:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-submenu-title-selected-active,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-submenu-title-selected-active{background-color:var(--ant-control-item-bg-active-hover);}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-item-disabled,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-item-disabled,:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-submenu-title-disabled,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-submenu-title-disabled{color:var(--ant-color-text-disabled);cursor:not-allowed;}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-item-disabled:hover,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-item-disabled:hover,:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-submenu-title-disabled:hover,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-submenu-title-disabled:hover{color:var(--ant-color-text-disabled);background-color:var(--ant-color-bg-elevated);cursor:not-allowed;}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-item-disabled a,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-item-disabled a,:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-submenu-title-disabled a,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-submenu-title-disabled a{pointer-events:none;}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-item-divider,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-item-divider,:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-submenu-title-divider,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-submenu-title-divider{height:1px;margin:var(--ant-margin-xxs) 0;overflow:hidden;line-height:0;background-color:var(--ant-color-split);}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-item .ant-dropdown-menu-submenu-expand-icon,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-item .ant-dropdown-menu-submenu-expand-icon,:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-submenu-title .ant-dropdown-menu-submenu-expand-icon,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-submenu-title .ant-dropdown-menu-submenu-expand-icon{position:absolute;inset-inline-end:var(--ant-padding-xs);}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-item .ant-dropdown-menu-submenu-expand-icon .ant-dropdown-menu-submenu-arrow-icon,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-item .ant-dropdown-menu-submenu-expand-icon .ant-dropdown-menu-submenu-arrow-icon,:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-submenu-title .ant-dropdown-menu-submenu-expand-icon .ant-dropdown-menu-submenu-arrow-icon,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-submenu-title .ant-dropdown-menu-submenu-expand-icon .ant-dropdown-menu-submenu-arrow-icon{margin-inline-end:0!important;color:var(--ant-color-text-description);font-size:var(--ant-font-size-icon);font-style:normal;}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-item-group-list,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-item-group-list{margin:0 var(--ant-margin-xs);padding:0;list-style:none;}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-submenu-title,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-submenu-title{padding-inline-end:calc(var(--ant-control-padding-horizontal) + var(--ant-font-size-sm));}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-submenu-vertical,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-submenu-vertical{position:relative;}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-submenu.ant-dropdown-menu-submenu-disabled .ant-dropdown-menu-submenu-title,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-submenu.ant-dropdown-menu-submenu-disabled .ant-dropdown-menu-submenu-title,:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-submenu.ant-dropdown-menu-submenu-disabled .ant-dropdown-menu-submenu-title .ant-dropdown-menu-submenu-arrow-icon,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-submenu.ant-dropdown-menu-submenu-disabled .ant-dropdown-menu-submenu-title .ant-dropdown-menu-submenu-arrow-icon{color:var(--ant-color-text-disabled);background-color:var(--ant-color-bg-elevated);cursor:not-allowed;}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-submenu-selected .ant-dropdown-menu-submenu-title,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-submenu-selected .ant-dropdown-menu-submenu-title{color:var(--ant-color-primary);}:where(.css-1dmvnh0).ant-slide-up-enter,:where(.css-1dmvnh0).ant-slide-up-appear{animation-duration:var(--ant-motion-duration-mid);animation-fill-mode:both;animation-play-state:paused;}:where(.css-1dmvnh0).ant-slide-up-leave{animation-duration:var(--ant-motion-duration-mid);animation-fill-mode:both;animation-play-state:paused;}:where(.css-1dmvnh0).ant-slide-up-enter.ant-slide-up-enter-active,:where(.css-1dmvnh0).ant-slide-up-appear.ant-slide-up-appear-active{animation-name:css-1dmvnh0-antSlideUpIn;animation-play-state:running;}:where(.css-1dmvnh0).ant-slide-up-leave.ant-slide-up-leave-active{animation-name:css-1dmvnh0-antSlideUpOut;animation-play-state:running;pointer-events:none;}:where(.css-1dmvnh0).ant-slide-up-enter,:where(.css-1dmvnh0).ant-slide-up-appear{transform:scale(0);transform-origin:0% 0%;opacity:0;animation-timing-function:var(--ant-motion-ease-out-quint);}:where(.css-1dmvnh0).ant-slide-up-enter-prepare,:where(.css-1dmvnh0).ant-slide-up-appear-prepare{transform:scale(1);}:where(.css-1dmvnh0).ant-slide-up-leave{animation-timing-function:var(--ant-motion-ease-in-quint);}:where(.css-1dmvnh0).ant-slide-down-enter,:where(.css-1dmvnh0).ant-slide-down-appear{animation-duration:var(--ant-motion-duration-mid);animation-fill-mode:both;animation-play-state:paused;}:where(.css-1dmvnh0).ant-slide-down-leave{animation-duration:var(--ant-motion-duration-mid);animation-fill-mode:both;animation-play-state:paused;}:where(.css-1dmvnh0).ant-slide-down-enter.ant-slide-down-enter-active,:where(.css-1dmvnh0).ant-slide-down-appear.ant-slide-down-appear-active{animation-name:css-1dmvnh0-antSlideDownIn;animation-play-state:running;}:where(.css-1dmvnh0).ant-slide-down-leave.ant-slide-down-leave-active{animation-name:css-1dmvnh0-antSlideDownOut;animation-play-state:running;pointer-events:none;}:where(.css-1dmvnh0).ant-slide-down-enter,:where(.css-1dmvnh0).ant-slide-down-appear{transform:scale(0);transform-origin:0% 0%;opacity:0;animation-timing-function:var(--ant-motion-ease-out-quint);}:where(.css-1dmvnh0).ant-slide-down-enter-prepare,:where(.css-1dmvnh0).ant-slide-down-appear-prepare{transform:scale(1);}:where(.css-1dmvnh0).ant-slide-down-leave{animation-timing-function:var(--ant-motion-ease-in-quint);}:where(.css-1dmvnh0).ant-move-up-enter,:where(.css-1dmvnh0).ant-move-up-appear{animation-duration:var(--ant-motion-duration-mid);animation-fill-mode:both;animation-play-state:paused;}:where(.css-1dmvnh0).ant-move-up-leave{animation-duration:var(--ant-motion-duration-mid);animation-fill-mode:both;animation-play-state:paused;}:where(.css-1dmvnh0).ant-move-up-enter.ant-move-up-enter-active,:where(.css-1dmvnh0).ant-move-up-appear.ant-move-up-appear-active{animation-name:css-1dmvnh0-antMoveUpIn;animation-play-state:running;}:where(.css-1dmvnh0).ant-move-up-leave.ant-move-up-leave-active{animation-name:css-1dmvnh0-antMoveUpOut;animation-play-state:running;pointer-events:none;}:where(.css-1dmvnh0).ant-move-up-enter,:where(.css-1dmvnh0).ant-move-up-appear{opacity:0;animation-timing-function:var(--ant-motion-ease-out-circ);}:where(.css-1dmvnh0).ant-move-up-leave{animation-timing-function:var(--ant-motion-ease-in-out-circ);}:where(.css-1dmvnh0).ant-move-down-enter,:where(.css-1dmvnh0).ant-move-down-appear{animation-duration:var(--ant-motion-duration-mid);animation-fill-mode:both;animation-play-state:paused;}:where(.css-1dmvnh0).ant-move-down-leave{animation-duration:var(--ant-motion-duration-mid);animation-fill-mode:both;animation-play-state:paused;}:where(.css-1dmvnh0).ant-move-down-enter.ant-move-down-enter-active,:where(.css-1dmvnh0).ant-move-down-appear.ant-move-down-appear-active{animation-name:css-1dmvnh0-antMoveDownIn;animation-play-state:running;}:where(.css-1dmvnh0).ant-move-down-leave.ant-move-down-leave-active{animation-name:css-1dmvnh0-antMoveDownOut;animation-play-state:running;pointer-events:none;}:where(.css-1dmvnh0).ant-move-down-enter,:where(.css-1dmvnh0).ant-move-down-appear{opacity:0;animation-timing-function:var(--ant-motion-ease-out-circ);}:where(.css-1dmvnh0).ant-move-down-leave{animation-timing-function:var(--ant-motion-ease-in-out-circ);}:where(.css-1dmvnh0).ant-zoom-big-enter,:where(.css-1dmvnh0).ant-zoom-big-appear{animation-duration:var(--ant-motion-duration-mid);animation-fill-mode:both;animation-play-state:paused;}:where(.css-1dmvnh0).ant-zoom-big-leave{animation-duration:var(--ant-motion-duration-mid);animation-fill-mode:both;animation-play-state:paused;}:where(.css-1dmvnh0).ant-zoom-big-enter.ant-zoom-big-enter-active,:where(.css-1dmvnh0).ant-zoom-big-appear.ant-zoom-big-appear-active{animation-name:css-1dmvnh0-antZoomBigIn;animation-play-state:running;}:where(.css-1dmvnh0).ant-zoom-big-leave.ant-zoom-big-leave-active{animation-name:css-1dmvnh0-antZoomBigOut;animation-play-state:running;pointer-events:none;}:where(.css-1dmvnh0).ant-zoom-big-enter,:where(.css-1dmvnh0).ant-zoom-big-appear{transform:scale(0);opacity:0;animation-timing-function:var(--ant-motion-ease-out-circ);}:where(.css-1dmvnh0).ant-zoom-big-enter-prepare,:where(.css-1dmvnh0).ant-zoom-big-appear-prepare{transform:none;}:where(.css-1dmvnh0).ant-zoom-big-leave{animation-timing-function:var(--ant-motion-ease-in-out-circ);}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-item.ant-dropdown-menu-item-danger:not(.ant-dropdown-menu-item-disabled),:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-item.ant-dropdown-menu-item-danger:not(.ant-dropdown-menu-item-disabled){color:var(--ant-color-error);}:where(.css-1dmvnh0).ant-dropdown .ant-dropdown-menu .ant-dropdown-menu-item.ant-dropdown-menu-item-danger:not(.ant-dropdown-menu-item-disabled):hover,:where(.css-1dmvnh0).ant-dropdown-menu-submenu .ant-dropdown-menu .ant-dropdown-menu-item.ant-dropdown-menu-item-danger:not(.ant-dropdown-menu-item-disabled):hover{color:var(--ant-color-text-light-solid);background-color:var(--ant-color-error);}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="_effect-css-1dmvnh0-antSlideUpIn">@keyframes css-1dmvnh0-antSlideUpIn{0%{transform:scaleY(0.8);transform-origin:0% 0%;opacity:0;}100%{transform:scaleY(1);transform-origin:0% 0%;opacity:1;}}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="_effect-css-1dmvnh0-antSlideDownIn">@keyframes css-1dmvnh0-antSlideDownIn{0%{transform:scaleY(0.8);transform-origin:100% 100%;opacity:0;}100%{transform:scaleY(1);transform-origin:100% 100%;opacity:1;}}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="_effect-css-1dmvnh0-antSlideUpOut">@keyframes css-1dmvnh0-antSlideUpOut{0%{transform:scaleY(1);transform-origin:0% 0%;opacity:1;}100%{transform:scaleY(0.8);transform-origin:0% 0%;opacity:0;}}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="_effect-css-1dmvnh0-antSlideDownOut">@keyframes css-1dmvnh0-antSlideDownOut{0%{transform:scaleY(1);transform-origin:100% 100%;opacity:1;}100%{transform:scaleY(0.8);transform-origin:100% 100%;opacity:0;}}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="_effect-css-1dmvnh0-antMoveUpIn">@keyframes css-1dmvnh0-antMoveUpIn{0%{transform:translate3d(0, -100%, 0);transform-origin:0 0;opacity:0;}100%{transform:translate3d(0, 0, 0);transform-origin:0 0;opacity:1;}}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="_effect-css-1dmvnh0-antMoveUpOut">@keyframes css-1dmvnh0-antMoveUpOut{0%{transform:translate3d(0, 0, 0);transform-origin:0 0;opacity:1;}100%{transform:translate3d(0, -100%, 0);transform-origin:0 0;opacity:0;}}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="_effect-css-1dmvnh0-antMoveDownIn">@keyframes css-1dmvnh0-antMoveDownIn{0%{transform:translate3d(0, 100%, 0);transform-origin:0 0;opacity:0;}100%{transform:translate3d(0, 0, 0);transform-origin:0 0;opacity:1;}}</style><style data-rc-order="prependQueue" data-rc-priority="-999" data-css-hash="_effect-css-1dmvnh0-antMoveDownOut">@keyframes css-1dmvnh0-antMoveDownOut{0%{transform:translate3d(0, 0, 0);transform-origin:0 0;opacity:1;}100%{transform:translate3d(0, 100%, 0);transform-origin:0 0;opacity:0;}}</style><style data-rc-order="prependQueue" data-css-hash="11egrx9" data-token-hash="11y8hy4">.anticon{display:inline-flex;align-items:center;color:inherit;font-style:normal;line-height:0;text-align:center;text-transform:none;vertical-align:-0.125em;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}.anticon >*{line-height:1;}.anticon svg{display:inline-block;}.anticon .anticon .anticon-icon{display:block;}</style><style data-rc-order="prependQueue" data-css-hash="c10mn4" data-token-hash="krywmj">.anticon{display:inline-flex;align-items:center;color:inherit;font-style:normal;line-height:0;text-align:center;text-transform:none;vertical-align:-0.125em;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}.anticon >*{line-height:1;}.anticon svg{display:inline-block;}.anticon .anticon .anticon-icon{display:block;}</style><style>.ant-message,.ant-message-fixed{box-sizing:border-box;margin:0;padding:0;color:#000000e0;font-size:14px;line-height:1.57142857;list-style:none;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,Noto Sans JP,Noto Sans KR,sans-serif,"Apple Color Emoji","Segoe UI Emoji";position:absolute;top:8px;width:100%;pointer-events:none;z-index:5200}.ant-message-fixed{position:fixed}.ant-message .ant-message-move-up,.ant-message-fixed .ant-message-fixed-move-up{animation-fill-mode:forwards}.ant-message .ant-message-move-up-appear,.ant-message .ant-message-move-up-enter,.ant-message-fixed .ant-message-fixed-move-up-appear,.ant-message-fixed .ant-message-fixed-move-up-enter{animation-name:css-1me4733-MessageMoveIn;animation-duration:.3s;animation-play-state:paused;animation-timing-function:cubic-bezier(.78,.14,.15,.86)}.ant-message .ant-message-move-up-appear.ant-message-move-up-appear-active,.ant-message .ant-message-move-up-enter.ant-message-move-up-enter-active,.ant-message-fixed .ant-message-fixed-move-up-appear.ant-message-fixed-move-up-appear-active,.ant-message-fixed .ant-message-fixed-move-up-enter.ant-message-fixed-move-up-enter-active{animation-play-state:running}.ant-message .ant-message-move-up-leave,.ant-message-fixed .ant-message-fixed-move-up-leave{animation-name:css-1me4733-MessageMoveOut;animation-duration:.3s;animation-play-state:paused;animation-timing-function:cubic-bezier(.78,.14,.15,.86)}.ant-message .ant-message-move-up-leave.ant-message-move-up-leave-active,.ant-message-fixed .ant-message-fixed-move-up-leave.ant-message-fixed-move-up-leave-active{animation-play-state:running}.ant-message-rtl,.ant-message-fixed-rtl,.ant-message-rtl span,.ant-message-fixed-rtl span{direction:rtl}.ant-message-notice,.ant-message-fixed-notice{padding:8px;text-align:center}.ant-message-notice .ant-message-custom-content>.anticon,.ant-message-notice .ant-message-fixed-custom-content>.anticon,.ant-message-fixed-notice .ant-message-fixed-custom-content>.anticon,.ant-message-fixed-notice .ant-message-custom-content>.anticon{vertical-align:text-bottom;margin-inline-end:8px;font-size:16px}.ant-message-notice .ant-message-notice-content,.ant-message-fixed-notice .ant-message-fixed-notice-content{display:inline-block;padding:9px 12px;background:#fff;border-radius:8px;box-shadow:0 6px 16px #00000014,0 3px 6px -4px #0000001f,0 9px 28px 8px #0000000d;pointer-events:all}.ant-message-notice .ant-message-success>.anticon,.ant-message-notice .ant-message-fixed-success>.anticon,.ant-message-fixed-notice .ant-message-fixed-success>.anticon,.ant-message-fixed-notice .ant-message-success>.anticon{color:#52c41a}.ant-message-notice .ant-message-error>.anticon,.ant-message-notice .ant-message-fixed-error>.anticon,.ant-message-fixed-notice .ant-message-fixed-error>.anticon,.ant-message-fixed-notice .ant-message-error>.anticon{color:#ff4d4f}.ant-message-notice .ant-message-warning>.anticon,.ant-message-notice .ant-message-fixed-warning>.anticon,.ant-message-fixed-notice .ant-message-fixed-warning>.anticon,.ant-message-fixed-notice .ant-message-warning>.anticon{color:#fff}.ant-message-notice .ant-message-info>.anticon,.ant-message-notice .ant-message-loading>.anticon,.ant-message-fixed-notice .ant-message-fixed-info>.anticon,.ant-message-fixed-notice .ant-message-fixed-loading>.anticon{color:#1677ff}.ant-message-notice-pure-panel,.ant-message-fixed-notice-pure-panel{padding:0;text-align:start}.youtube-content-sQHaK5 .huiyi-btn-GacxC5{position:absolute;bottom:5px;right:8px;width:48px;height:48px;z-index:1;transition:all .2s;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;display:flex;flex-direction:row;justify-content:center;align-items:center}.youtube-content-sQHaK5 .huiyi-btn-GacxC5.hide-KtE90s{opacity:0}.youtube-content-sQHaK5 .huiyi-btn-GacxC5.fullscreen-q0EfQI{right:5px;width:54px;height:54px}.youtube-content-sQHaK5 .huiyi-btn-GacxC5 .icon-wrap-AzlxYi{width:24px;height:24px;background:#f9f2ff;box-shadow:0 2px 16px 1px #33333329;border-radius:12px;border:1px solid #e7d0ff;display:flex;flex-direction:row;justify-content:center;align-items:center}.youtube-content-sQHaK5 .huiyi-btn-GacxC5 .icon-wrap-AzlxYi .icon-triasQ{width:18px;height:18px}.youtube-content-sQHaK5 .huiyi-btn-GacxC5 .icon-wrap-mode-jtfLg2{width:24px;height:24px;background:#f9f2ff;box-shadow:0 2px 16px 1px #33333329;border-radius:12px;border:1px solid #e7d0ff;position:relative;display:flex;flex-direction:row;justify-content:center;align-items:center}.youtube-content-sQHaK5 .huiyi-btn-GacxC5 .icon-wrap-mode-jtfLg2 .icon-mode-e8Q3g2{width:24px;height:24px}.youtube-content-sQHaK5 .huiyi-btn-GacxC5 .icon-wrap-mode-jtfLg2 .logo-Cj-EBG{width:13px;height:13px;position:absolute;right:-7px;bottom:-1px;background:#fff;border-radius:50%}.youtube-content-sQHaK5 .pop-content-FmcNLf{position:relative;width:259px;padding:16px 24px;background:linear-gradient(63deg,#ba7cff 0%,#837aff 100%);box-shadow:0 2px 16px #0000001f}.youtube-content-sQHaK5 .pop-content-FmcNLf .text-MG4AfR{font-size:14px;font-family:PingFangSC-Semibold,PingFang SC;font-weight:600;color:#fff;line-height:20px}.youtube-content-sQHaK5 .pop-content-FmcNLf .close-koB5R1{position:absolute;right:8px;top:8px;width:12px;height:12px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.youtube-content-sQHaK5 .ant-popover-inner{padding:0;border-radius:10px;overflow:hidden}.youtube-content-sQHaK5 .ant-popover-arrow:before{background:#837aff}.youtube-content-sQHaK5 .guide-KV3ybq{position:absolute;right:10px;bottom:58px;width:252px;height:52px;background:linear-gradient(63deg,#ba7cff 0%,#837aff 100%);box-shadow:0 2px 16px #0000001f;border-radius:16px;padding:16px 24px;z-index:3000}.youtube-content-sQHaK5 .guide-KV3ybq.hide-KtE90s{display:none}.youtube-content-sQHaK5 .guide-KV3ybq .text-MG4AfR{font-size:14px;font-family:PingFangSC-Semibold,PingFang SC;font-weight:600;color:#fff;line-height:20px}.youtube-content-sQHaK5 .guide-KV3ybq .close-koB5R1{position:absolute;right:8px;top:8px;width:12px;height:12px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.youtube-content-sQHaK5 .guide-KV3ybq .fingers-Y1dCJM{position:absolute;right:6px;top:20px;width:32px;height:44px}.youtube-content-sQHaK5 .guide-KV3ybq .stars-3CvE1d{position:absolute;left:-9px;top:-7px;width:32px;height:28px}.youtube-content-sQHaK5 .caption-wrap-X8fMja{position:absolute;width:80%;left:50%;bottom:60px;transform:translate(-50%);display:flex;justify-content:center;align-items:center;flex-direction:column;z-index:0;color:#fff}.youtube-content-sQHaK5 .caption-wrap-X8fMja.control-hide-1aJr-o{bottom:10px}.youtube-content-sQHaK5 .caption-wrap-X8fMja .subtitle-wrap-1RV6lk{padding:10px;font-weight:600;border-radius:10px;text-align:center}.youtube-content-sQHaK5 .caption-wrap-X8fMja .translate-text-gyDD8N{font-size:26px;font-family:PingFangSC-Semibold,PingFang SC;font-weight:600;color:#f9f7f9;line-height:36px;text-shadow:0px 1px 0px rgba(0,0,0,.25),1px 1px 0px rgba(0,0,0,.5);-webkit-text-stroke:1px #69425f}.youtube-content-sQHaK5 .caption-wrap-X8fMja .translate-text-gyDD8N.fullscreen-q0EfQI{font-size:36px;line-height:40px}.youtube-content-sQHaK5 .caption-wrap-X8fMja .original-text-lyPfVy{overflow:hidden;text-overflow:ellipsis;word-wrap:break-word;-webkit-line-clamp:2;-webkit-box-orient:vertical;display:-webkit-box;font-size:20px;font-family:PingFangSC-Semibold,PingFang SC;font-weight:600;color:#fff;line-height:30px;text-shadow:0px 1px 0px rgba(0,0,0,.25),1px 1px 0px rgba(0,0,0,.25);-webkit-text-stroke:1px #302b33}.youtube-content-sQHaK5 .caption-wrap-X8fMja .original-text-lyPfVy.fullscreen-q0EfQI{font-size:30px;line-height:34px}.youtube-content-sQHaK5 .caption-wrap-X8fMja .original-text-lyPfVy.original-mode-K1q9Q5{font-size:26px;line-height:36px}.youtube-content-sQHaK5 .caption-wrap-X8fMja .original-text-lyPfVy.original-fullscreen-mode-dCQvUX{font-size:36px;line-height:40px}.youtube-content-sQHaK5 .token-tip-T9lVtX{position:absolute;bottom:54px;right:7px;z-index:2000;display:flex;align-items:center;justify-content:center;background:#FFFFFF;box-shadow:0 5px 32px 2px #0000001f;border:1px solid #EFEFF0;border-radius:20px}.youtube-content-sQHaK5 .token-tip-T9lVtX.hide-KtE90s{display:none}.youtube-content-sQHaK5 .token-tip-T9lVtX .triangle-O8jhNd{position:absolute;bottom:-4px;right:19px;z-index:100;width:10px;height:10px;border-left:none;border-top:none;border-bottom:1px solid #EFEFF0;border-right:1px solid #EFEFF0;transform:rotate(45deg);background:#FFFFFF}.youtube-content-sQHaK5 .ads-tip-VkoQA-{position:absolute;right:10px;bottom:58px;height:52px;background:linear-gradient(63deg,#ba7cff 0%,#837aff 100%);box-shadow:0 2px 16px #0000001f;border-radius:16px;padding:16px;z-index:3000}.youtube-content-sQHaK5 .ads-tip-VkoQA-.hide-KtE90s{display:none}.youtube-content-sQHaK5 .ads-tip-VkoQA- .text-MG4AfR{font-size:14px;font-family:PingFangSC-Semibold,PingFang SC;font-weight:600;color:#fff;line-height:20px}.youtube-content-sQHaK5 .ads-tip-VkoQA- .close-koB5R1{position:absolute;right:8px;top:8px;width:12px;height:12px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.youtube-content-sQHaK5 .ads-tip-VkoQA- .stars-3CvE1d{position:absolute;left:-9px;top:-7px;width:32px;height:28px}.upgrade-box-o94siY{width:378px;padding:24px 30px 24px 28px;background:#ffffff;box-shadow:0 5px 32px 2px #0000001f;border-radius:20px;border:1px solid #efeff0;position:absolute;top:-84px;right:70px;display:flex;justify-content:center;align-items:center;flex-direction:column;justify-content:flex-start;min-height:154px}.upgrade-box-o94siY.small-card-panel-UntmCp{width:313px;padding:20px;min-height:auto}.upgrade-box-o94siY.small-card-panel-UntmCp .activity-box-BCdMsH{margin-top:11px}.upgrade-box-o94siY.small-card-panel-UntmCp .activity-box-BCdMsH .activity-img-box-l0Gw-i{width:285px}.upgrade-box-o94siY.small-card-panel-UntmCp .title-box-Ggmbat .title-l9MLKW{line-height:normal}.upgrade-box-o94siY.small-card-panel-UntmCp .btn-box-CISTEg{margin-top:16px}.upgrade-box-o94siY.activity-NLvblP{width:339px}.upgrade-box-o94siY .close-wrap-xRxrFB{position:absolute;top:10px;right:12px;width:16px;height:16px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;display:flex;flex-direction:row;justify-content:center;align-items:center}.upgrade-box-o94siY .close-wrap-xRxrFB .icon-y9DEH4{width:100%;height:100%}.upgrade-box-o94siY>.normal-bg-YUvoWN{width:223px;height:154px;height:100%;position:absolute;right:0;top:0}.upgrade-box-o94siY .title-box-Ggmbat{width:100%;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;position:relative}.upgrade-box-o94siY .title-box-Ggmbat .icon-y9DEH4{width:16px;height:16px}.upgrade-box-o94siY .title-box-Ggmbat .title-l9MLKW{font-size:14px;font-weight:600;color:#2c2c2c;line-height:20px;margin-left:5px}.upgrade-box-o94siY .text-content-82IIk5{width:100%;text-align:left;font-size:13px;font-weight:400;color:#666;line-height:18px;margin-top:8px;position:relative}.upgrade-box-o94siY .btn-box-CISTEg{width:100%;margin-top:24px;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-end;position:relative;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.upgrade-box-o94siY .upgrade-qr-box-0R7zqO{top:110px}.btn-ni4tEh{height:32px;background:#6165f7;border-radius:8px;border:none;padding:0 15px;font-weight:400;color:#fff;display:flex;flex-direction:row;justify-content:center;align-items:center;font-family:PingFangSC,PingFang SC;font-size:13px;line-height:18px}.btn-ni4tEh:hover{color:#fff!important;background:#595DE3!important}.btn-ni4tEh .icon-y9DEH4{width:14px;height:14px;margin-left:2px}.activity-box-BCdMsH{margin-top:9px;padding:0 27px;position:relative}.activity-box-BCdMsH .activity-img-box-l0Gw-i{position:relative;width:309px;height:72px}.activity-box-BCdMsH .activity-img-box-l0Gw-i img{max-width:100%;max-height:100%;object-fit:cover}.activity-box-BCdMsH .activity-img-box-l0Gw-i .activity-btn-zXC9hj{position:absolute;right:18px;bottom:19px;height:34px;cursor:pointer}.activity-box-BCdMsH .activity-img-box-l0Gw-i .activity-btn-zXC9hj:hover img.activity-btn-img-FqwJI7{display:none}.activity-box-BCdMsH .activity-img-box-l0Gw-i .activity-btn-zXC9hj:hover img.activity-btn-img-hover-EPvNOb{display:block}.activity-box-BCdMsH .activity-img-box-l0Gw-i .activity-btn-zXC9hj img{height:100%;object-fit:cover}.activity-box-BCdMsH .activity-img-box-l0Gw-i .activity-btn-zXC9hj img.activity-btn-img-hover-EPvNOb{display:none}.activity-box-BCdMsH .activity-desc-UKu66z{font-weight:400;font-size:12px;color:#666;line-height:17px;margin-top:9px;text-align:center}.upgrade-box-with-content-HQGGOe{display:flex;flex-direction:column;justify-content:center;align-items:center;position:relative}.upgrade-box-with-content-HQGGOe.big-panel-EEUcdu{width:423px;height:177px}.upgrade-box-with-content-HQGGOe.small-panel-iTwERX{width:325px;height:156px}.upgrade-box-with-content-HQGGOe.small-panel-iTwERX .upgrade-box-with-content-box-szYTVq .activity-box-BCdMsH .activity-img-box-l0Gw-i{width:283px}.upgrade-box-with-content-HQGGOe .b-bg-HQhyVm,.upgrade-box-with-content-HQGGOe .s-bg-0XqPoY{width:100%;height:100%;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%)}.upgrade-box-with-content-HQGGOe .upgrade-box-with-content-box-szYTVq{position:relative;z-index:2;display:flex;flex-direction:column;justify-content:center;align-items:center}.upgrade-box-with-content-HQGGOe .title-l9MLKW{font-weight:600;font-size:14px;color:#2c2c2c;display:flex;justify-content:center;align-items:center}.upgrade-box-with-content-HQGGOe .title-l9MLKW img{width:15px;margin-right:4px}.upgrade-box-with-content-HQGGOe .desc-u3ml93{font-weight:400;font-size:13px;color:#666;line-height:18px;margin-top:12px}.upgrade-box-with-content-HQGGOe .btn-ni4tEh{width:121px;margin-top:24px}.youtube-content-EkXG0X .huiyi-btn-3KOEvX{position:absolute;bottom:0;right:8px;width:48px;height:48px;z-index:60;transition:all .2s;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;display:flex;flex-direction:row;justify-content:center;align-items:center}.youtube-content-EkXG0X .huiyi-btn-3KOEvX.hide-ou4Lx-{opacity:0}.youtube-content-EkXG0X .huiyi-btn-3KOEvX.fullscreen-rgImok{right:18px;width:54px;height:54px}.youtube-content-EkXG0X .huiyi-btn-3KOEvX .icon-wrap-Zme0zE{width:24px;height:24px;background:#f5f5ff;box-shadow:0 1px 4px 1px #3319511c;border-radius:12px;border:1px solid #ffffff;display:flex;flex-direction:row;justify-content:center;align-items:center}.youtube-content-EkXG0X .huiyi-btn-3KOEvX .icon-wrap-Zme0zE .icon-eyyiGU{width:18px;height:18px}.youtube-content-EkXG0X .huiyi-btn-3KOEvX .icon-wrap-mode-PLJLI3{width:24px;height:24px;background:#f5f5ff;box-shadow:0 1px 4px 1px #3319511c;border-radius:12px;border:1px solid #ffffff;position:relative;display:flex;flex-direction:row;justify-content:center;align-items:center}.youtube-content-EkXG0X .huiyi-btn-3KOEvX .icon-wrap-mode-PLJLI3 .icon-mode-7Gi3wX{width:24px;height:24px}.youtube-content-EkXG0X .huiyi-btn-3KOEvX .icon-wrap-mode-PLJLI3 .logo-udFz5C{width:13px;height:13px;position:absolute;right:-7px;bottom:-1px;background:#fff;border-radius:50%}.youtube-content-EkXG0X .pop-content-Skc8Lx{position:relative;width:259px;padding:16px 24px;background:linear-gradient(63deg,#ba7cff 0%,#837aff 100%);box-shadow:0 2px 16px #0000001f}.youtube-content-EkXG0X .pop-content-Skc8Lx .text-uFd3KE{font-size:14px;font-family:PingFangSC-Semibold,PingFang SC;font-weight:600;color:#fff;line-height:20px}.youtube-content-EkXG0X .pop-content-Skc8Lx .close-I8cD3t{position:absolute;right:8px;top:8px;width:12px;height:12px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.youtube-content-EkXG0X .ant-popover-inner{padding:0;border-radius:10px;overflow:hidden}.youtube-content-EkXG0X .ant-popover-arrow:before{background:#837aff}.youtube-content-EkXG0X .guide-bUT-5o{position:absolute;right:10px;bottom:58px;z-index:3000;width:270px;height:92px;background:linear-gradient(149deg,#7cf3ff 0%,#7a9aff 100%);box-shadow:0 2px 16px #0000001f;border-radius:12px;padding:13px 10px 14px 18px}.youtube-content-EkXG0X .guide-bUT-5o .title--JJM5s{height:21px;font-family:PingFangSC,PingFang SC;font-weight:600;font-size:15px;color:#fff;line-height:normal;text-align:left;font-style:normal;position:relative}.youtube-content-EkXG0X .guide-bUT-5o .title--JJM5s .line-ZUZOHy{position:absolute;left:62px;top:20px;width:47px;height:4px}.youtube-content-EkXG0X .guide-bUT-5o.hide-ou4Lx-{display:none}.youtube-content-EkXG0X .guide-bUT-5o .text-uFd3KE{margin-top:5px;font-family:PingFangSC,PingFang SC;font-weight:400;font-size:14px;color:#ffffffd9;line-height:20px;text-align:left;font-style:normal}.youtube-content-EkXG0X .guide-bUT-5o .close-I8cD3t{position:absolute;right:8px;top:8px;width:12px;height:12px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.youtube-content-EkXG0X .guide-bUT-5o .fingers-lkurzs{position:absolute;right:6px;top:66px;width:32px;height:44px}.youtube-content-EkXG0X .guide-bUT-5o .stars-OUH2UL{position:absolute;left:-9px;top:-7px;width:32px;height:28px}.youtube-content-EkXG0X .caption-wrap-hr8fue{position:absolute;width:80%;left:50%;bottom:60px;transform:translate(-50%);display:flex;justify-content:center;align-items:center;flex-direction:column;z-index:10;color:#fff}.youtube-content-EkXG0X .caption-wrap-hr8fue.control-hide-Pwk-zW{bottom:10px}.youtube-content-EkXG0X .caption-wrap-hr8fue .subtitle-wrap-xGF1Cm{padding:10px;font-weight:600;border-radius:10px;text-align:center}.youtube-content-EkXG0X .caption-wrap-hr8fue .translate-text-txmoi5{font-size:26px;font-family:PingFangSC-Semibold,PingFang SC;font-weight:600;color:#f9f7f9;line-height:36px;text-shadow:0px 1px 0px rgba(0,0,0,.25),1px 1px 0px rgba(0,0,0,.5);-webkit-text-stroke:1px #69425f}.youtube-content-EkXG0X .caption-wrap-hr8fue .translate-text-txmoi5.fullscreen-rgImok{font-size:36px;line-height:40px}.youtube-content-EkXG0X .caption-wrap-hr8fue .original-text-fuJHWf{overflow:hidden;text-overflow:ellipsis;word-wrap:break-word;-webkit-line-clamp:2;-webkit-box-orient:vertical;display:-webkit-box;font-size:20px;font-family:PingFangSC-Semibold,PingFang SC;font-weight:600;color:#fff;line-height:30px;text-shadow:0px 1px 0px rgba(0,0,0,.25),1px 1px 0px rgba(0,0,0,.25);-webkit-text-stroke:1px #302b33}.youtube-content-EkXG0X .caption-wrap-hr8fue .original-text-fuJHWf.fullscreen-rgImok{font-size:30px;line-height:34px}.youtube-content-EkXG0X .caption-wrap-hr8fue .original-text-fuJHWf.original-mode-NXNI7q{font-size:26px;line-height:36px}.youtube-content-EkXG0X .caption-wrap-hr8fue .original-text-fuJHWf.original-fullscreen-mode-zzyqlj{font-size:36px;line-height:40px}.youtube-content-EkXG0X .remain-video-count-tips-sWMm77{background:#ffffff;box-shadow:0 5px 32px 2px #0000001f;border:1px solid #efeff0;position:absolute;bottom:44px;right:7px;z-index:2000;padding:16px;border-radius:12px}.youtube-content-EkXG0X .remain-video-count-tips-sWMm77.hide-ou4Lx-{display:none}.youtube-content-EkXG0X .remain-video-count-tips-sWMm77 .model-info-1IZe37{font-size:12px;color:#666}.youtube-content-EkXG0X .remain-video-count-tips-sWMm77 .triangle-RZINqa{position:absolute;bottom:-4px;right:19px;z-index:100;width:10px;height:10px;border-left:none;border-top:none;border-bottom:1px solid #efeff0;border-right:1px solid #efeff0;transform:rotate(45deg);background:#ffffff}.youtube-content-EkXG0X .token-tip-b-0STF{position:absolute;bottom:54px;right:7px;z-index:2000;display:flex;align-items:center;justify-content:center;background:#ffffff;box-shadow:0 5px 32px 2px #0000001f;border:1px solid #efeff0;border-radius:20px}.youtube-content-EkXG0X .token-tip-b-0STF.hide-ou4Lx-{display:none}.youtube-content-EkXG0X .token-tip-b-0STF .triangle-RZINqa{position:absolute;bottom:-4px;right:19px;z-index:100;width:10px;height:10px;border-left:none;border-top:none;border-bottom:1px solid #efeff0;border-right:1px solid #efeff0;transform:rotate(45deg);background:#ffffff}.youtube-content-EkXG0X .ads-tip-aBuwdI{position:absolute;right:10px;bottom:58px;height:52px;background:linear-gradient(63deg,#ba7cff 0%,#837aff 100%);box-shadow:0 2px 16px #0000001f;border-radius:16px;padding:16px;z-index:3000}.youtube-content-EkXG0X .ads-tip-aBuwdI.hide-ou4Lx-{display:none}.youtube-content-EkXG0X .ads-tip-aBuwdI .text-uFd3KE{font-size:14px;font-family:PingFangSC-Semibold,PingFang SC;font-weight:600;color:#fff;line-height:20px}.youtube-content-EkXG0X .ads-tip-aBuwdI .close-I8cD3t{position:absolute;right:8px;top:8px;width:12px;height:12px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.youtube-content-EkXG0X .ads-tip-aBuwdI .stars-OUH2UL{position:absolute;left:-9px;top:-7px;width:32px;height:28px}.common-func-use-count-tips-itjNEY{display:flex;align-items:center;font-weight:400;font-size:12px;color:#666}.common-func-use-count-tips-itjNEY.with-desc-W-FmFZ{font-size:13px}.common-func-use-count-tips-itjNEY.with-desc-W-FmFZ .text-yrxQRw{color:#333;margin-right:16px}.common-func-use-count-tips-itjNEY .btn-g4fGRt{color:#6165f7;margin-left:4px;cursor:pointer;user-select:none}.pay-success-dialog-SjF-ws .ant-modal-content{padding:0!important;border-radius:28px!important}.pay-success-dialog-SjF-ws .pay-success-dialog-content-IfnCcD{height:388px;display:flex;flex-direction:column;align-items:center;border-radius:12px;background:linear-gradient(180deg,#EBEEFF 0%,#FFFFFF 100%)}.pay-success-dialog-SjF-ws .pay-success-dialog-content-IfnCcD .title-2divYr{font-size:20px;font-weight:600;color:#000;line-height:28px;margin-top:24px}.pay-success-dialog-SjF-ws .pay-success-dialog-content-IfnCcD .success-icon-2b0pt9{margin-top:44px;width:187px;height:143px}.pay-success-dialog-SjF-ws .pay-success-dialog-content-IfnCcD .btn-box-fZGFK6{margin-top:48px;display:flex}.pay-success-dialog-SjF-ws .pay-success-dialog-content-IfnCcD .btn-box-fZGFK6 .gift-receive-btn-ADcs2k{width:192px;height:44px;border-radius:8px;font-size:16px;font-weight:600;color:#000;line-height:22px;display:flex;align-items:center;justify-content:center;cursor:pointer;margin-right:20px;border:1px solid #DDDDDD;position:relative}.pay-success-dialog-SjF-ws .pay-success-dialog-content-IfnCcD .btn-box-fZGFK6 .gift-receive-btn-ADcs2k:hover .gift-qr-box-D5sQNd{display:flex}.pay-success-dialog-SjF-ws .pay-success-dialog-content-IfnCcD .btn-box-fZGFK6 .gift-receive-btn-ADcs2k .gift-qr-box-D5sQNd{width:307px;height:318px;background:linear-gradient(180deg,#E9ECFC 0%,#FFFFFF 100%);box-shadow:0 4px 24px 2px #0000001f;border-radius:12px;border:1px solid #FFFFFF;display:flex;justify-content:center;align-items:center;flex-direction:column;position:absolute;left:50%;transform:translate(-50%);bottom:48px;display:none;padding-bottom:12px}.pay-success-dialog-SjF-ws .pay-success-dialog-content-IfnCcD .btn-box-fZGFK6 .gift-receive-btn-ADcs2k .gift-qr-box-D5sQNd .qr-with-bg-48bnZH{margin-top:24px;width:190px;height:188px;display:flex;justify-content:center;align-items:center;flex-direction:column;position:relative}.pay-success-dialog-SjF-ws .pay-success-dialog-content-IfnCcD .btn-box-fZGFK6 .gift-receive-btn-ADcs2k .gift-qr-box-D5sQNd .qr-with-bg-48bnZH .qr-bg-N9oeFx{width:100%;position:absolute;top:0;left:0}.pay-success-dialog-SjF-ws .pay-success-dialog-content-IfnCcD .btn-box-fZGFK6 .gift-receive-btn-ADcs2k .gift-qr-box-D5sQNd .qr-with-bg-48bnZH img.qr-code-NDqUcp{width:182px;position:relative;z-index:2}.pay-success-dialog-SjF-ws .pay-success-dialog-content-IfnCcD .btn-box-fZGFK6 .gift-receive-btn-ADcs2k .gift-qr-box-D5sQNd .qr-with-bg-48bnZH .loading-icon-EZw-dE{width:24px;height:24px}.pay-success-dialog-SjF-ws .pay-success-dialog-content-IfnCcD .btn-box-fZGFK6 .gift-receive-btn-ADcs2k .gift-qr-box-D5sQNd .qr-t-15Ta39{font-size:16px;font-weight:600;color:#2c2c2c;display:flex;justify-content:center;align-items:center}.pay-success-dialog-SjF-ws .pay-success-dialog-content-IfnCcD .btn-box-fZGFK6 .gift-receive-btn-ADcs2k .gift-qr-box-D5sQNd .qr-t-15Ta39 .icon-ZmR133{width:22px;margin-right:4px}.pay-success-dialog-SjF-ws .pay-success-dialog-content-IfnCcD .btn-box-fZGFK6 .btn-PxQxoY{width:192px;height:44px;background:#6165f7;border-radius:8px;font-size:16px;font-weight:600;color:#fff;line-height:22px;display:flex;align-items:center;justify-content:center;cursor:pointer}.pay-success-dialog-SjF-ws .pay-success-dialog-content-IfnCcD .btn-box-fZGFK6 .btn-PxQxoY:hover{background:#595DE3}.common-modal-P0xJXJ .ant-modal-content{border-radius:20px;padding:24px 32px}.common-modal-P0xJXJ .ant-modal-footer{margin-top:24px}.common-modal-P0xJXJ .ant-btn-default{border:1px solid #DDDDDD;background:#FFFFFF;color:#333;height:44px;font-size:16px;font-weight:600;min-width:120px}.common-modal-P0xJXJ .ant-btn-default:hover{border:1px solid #CACACA!important;background:#FFFFFF!important;color:#2e2e2e!important}.common-modal-P0xJXJ .ant-btn-primary{background:#6165f7;border:1px solid #6165f7;color:#fff;height:44px;font-size:16px;font-weight:600;min-width:120px;margin-inline-start:16px!important}.common-modal-P0xJXJ .ant-btn-primary:hover{background:#595DE3!important;border:1px solid #595DE3!important;color:#fff!important}.buy-vip-dialog-wrapper-vEA3Nh{overflow:hidden!important}.buy-vip-dialog-new-Oh4Wbm .ant-modal{line-height:unset!important}.buy-vip-dialog-new-Oh4Wbm .ant-modal-content{padding:0!important;border-radius:0 12px 12px/0px 12px 12px!important}@media (max-height: 592px){.buy-vip-dialog-new-Oh4Wbm .ant-modal-content{transform:scale(.9)}}@media (max-height: 540px){.buy-vip-dialog-new-Oh4Wbm .ant-modal-content{transform:scale(.8)}}.buy-vip-dialog-new-Oh4Wbm .ant-modal-content .ant-modal-body{line-height:unset!important}.buy-vip-dialog-new-Oh4Wbm .close-icon-ySeqyL{width:20px;position:absolute;top:0;right:-31px;cursor:pointer}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B{display:flex;flex-direction:row;justify-content:center;align-items:center;height:516px;align-items:flex-start}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B.with-banner-Hyd2It{height:592px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B.with-banner-Hyd2It .comment-list-LbB04a{height:222px!important}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B.with-banner-Hyd2It .comment-list-LbB04a.with-coupon--vuWDP{height:175px!important}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B .bg-g-w7ae{width:100%;height:100%;position:absolute;left:0;top:0;z-index:-1}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H{width:578px;padding:16px 36px 24px;position:relative}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .deepl-moig6Q{position:absolute;top:-46px;left:0;width:100%;height:46px;background:linear-gradient(130deg,#fef3db 0%,#fffdf6 100%);display:flex;flex-direction:row;justify-content:center;align-items:center;border-radius:12px 12px 0 0}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .deepl-moig6Q .bg-g-w7ae{position:absolute;left:0;top:0;width:100%;height:100%;z-index:1}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .deepl-moig6Q .icon-h-abn4{width:270px;height:41px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .user-info-box-8IZSlc{display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .user-info-box-8IZSlc>img{width:36px;height:36px;border-radius:36px;margin-right:8px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .user-info-box-8IZSlc .user-name-wYa34C{display:flex;flex-direction:row;justify-content:center;align-items:center;font-weight:600;font-size:13px;color:#333;margin-bottom:3px;justify-content:flex-start;position:relative;width:fit-content}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .user-info-box-8IZSlc .user-name-wYa34C img{height:40px;position:absolute;right:-49px;top:-7px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .user-info-box-8IZSlc .user-expired-04dcDS{font-weight:400;font-size:12px;color:#33333373;line-height:17px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .plan-list-izUgDi{margin-top:18px;display:flex;column-gap:16px;min-height:130px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .plan-list-izUgDi .plan-item-box-ax5RNZ{border:1px solid transparent;width:113px;height:130px;position:relative}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .plan-list-izUgDi .plan-item-box-ax5RNZ.active-5g3zDb,.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .plan-list-izUgDi .plan-item-box-ax5RNZ:hover{border:none}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .plan-list-izUgDi .plan-item-box-ax5RNZ.active-5g3zDb .plan-item-j6qatS,.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .plan-list-izUgDi .plan-item-box-ax5RNZ:hover .plan-item-j6qatS{color:#995a00;background:linear-gradient(327deg,#fbe8b3 0%,#f8d193 100%);border:2px solid #f6c561}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .plan-list-izUgDi .plan-item-box-ax5RNZ.active-5g3zDb .plan-item-j6qatS .pre-month-price-MkJ6ms,.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .plan-list-izUgDi .plan-item-box-ax5RNZ:hover .plan-item-j6qatS .pre-month-price-MkJ6ms{color:#614121}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .plan-list-izUgDi .plan-item-box-ax5RNZ.active-5g3zDb .plan-item-j6qatS .plan-top-3ocXuk,.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .plan-list-izUgDi .plan-item-box-ax5RNZ:hover .plan-item-j6qatS .plan-top-3ocXuk{background:linear-gradient(327deg,#fef6dc 0%,#fff7e1 63%,#fcecbe 87%,#fce9b6 100%)}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .plan-list-izUgDi .recommend-box-ej9-PL{background:linear-gradient(332deg,#363636 0%,#6e5a14 100%);border-radius:0 9px;position:absolute;right:-1px;top:-1px;font-weight:400;font-size:12px;color:#fbdebe;padding:0 9px;height:18px;line-height:18px;z-index:3}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .plan-list-izUgDi .plan-item-j6qatS{width:100%;height:100%;display:flex;justify-content:center;align-items:center;flex-direction:column;justify-content:flex-start;position:relative;z-index:2;color:#333;cursor:pointer;background:#fdefd3;border-radius:12px;border:1px solid #f4ecda}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .plan-list-izUgDi .plan-item-j6qatS .plan-top-3ocXuk{display:flex;justify-content:center;align-items:center;flex-direction:column;justify-content:flex-start;flex:1;padding-top:18px;border-radius:12px;background-color:#fff;width:100%}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .plan-list-izUgDi .plan-item-j6qatS .plan-title-C5rdI3{font-weight:500;font-size:13px;line-height:20px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .plan-list-izUgDi .plan-item-j6qatS .price-box-xbEP87{margin-top:15px;font-weight:700;font-size:17px;line-height:25px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .plan-list-izUgDi .plan-item-j6qatS .price-box-xbEP87 span{font-size:36px;font-weight:700}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .plan-list-izUgDi .plan-item-j6qatS .origin-price-Ayq48s{text-decoration:line-through;font-weight:400;font-size:14px;color:#999;margin-top:2px;text-align:center}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .plan-list-izUgDi .plan-item-j6qatS .pre-month-price-MkJ6ms{width:100%;padding:2px 0;text-align:center;line-height:18px;font-weight:400;font-size:12px;color:#886231}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .subscription-tips-idNnyS{margin-top:10px;font-weight:400;font-size:12px;color:#999;line-height:17px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .subscription-tips-idNnyS.hidden-VpazZn{visibility:hidden}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL{margin-top:16px;position:relative;height:245px;width:506px;z-index:2}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .edu-box-KJwNpr{position:absolute;right:17px;bottom:11px;padding-bottom:4px;width:228px;height:49px;background:#fff6e4;border-radius:12px;z-index:-1;display:flex;flex-direction:row;justify-content:center;align-items:center;align-items:end}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .edu-inner-SpJXeG{display:flex;flex-direction:row;justify-content:center;align-items:center;font-weight:400;font-size:12px;color:#937249;cursor:pointer}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .edu-inner-SpJXeG:hover{color:#694e25}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .edu-inner-SpJXeG:hover .hover-FNlY3C{display:block}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .edu-inner-SpJXeG:hover .default-K9mMRa{display:none}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .edu-inner-SpJXeG .edu-icon-9iX71O{height:13px;margin-right:4px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .edu-inner-SpJXeG .hover-FNlY3C{display:none}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .edu-inner-SpJXeG .arrow-right-7TolFw{width:12px;margin-left:4px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL>.func-box-tabs-kzNt-S{display:flex;flex-direction:row;align-items:center;justify-content:center;background:#ffffff;box-shadow:0 0 12px #71717124;border:1px solid #fffdf6;margin:0 auto;position:relative;z-index:3;width:208px;height:31px;border-radius:16px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL>.func-box-tabs-kzNt-S .func-box-tab-o7EGEa{width:50%;height:100%;border-radius:14px;display:flex;flex-direction:row;justify-content:center;align-items:center;cursor:pointer;font-weight:600;font-size:13px;color:#888}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL>.func-box-tabs-kzNt-S .func-box-tab-o7EGEa:hover:not(.active-5g3zDb){color:#605f5f}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL>.func-box-tabs-kzNt-S .func-box-tab-o7EGEa:hover:not(.active-5g3zDb) img.tab-img-Tky7OH{display:none}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL>.func-box-tabs-kzNt-S .func-box-tab-o7EGEa:hover:not(.active-5g3zDb) img.tab-hover-img-KhRYxx{display:block}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL>.func-box-tabs-kzNt-S .func-box-tab-o7EGEa.active-5g3zDb{color:#fbdebe;background:linear-gradient(202deg,#363636 0%,#555556 100%)}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL>.func-box-tabs-kzNt-S .func-box-tab-o7EGEa.active-5g3zDb img.tab-img-Tky7OH{display:none}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL>.func-box-tabs-kzNt-S .func-box-tab-o7EGEa.active-5g3zDb img.tab-active-img-Q0viNb{display:block}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL>.func-box-tabs-kzNt-S .func-box-tab-o7EGEa img{width:22px;margin-right:6px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL>.func-box-tabs-kzNt-S .func-box-tab-o7EGEa img.tab-active-img-Q0viNb,.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL>.func-box-tabs-kzNt-S .func-box-tab-o7EGEa img.tab-hover-img-KhRYxx{display:none}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL>.func-box-content-AvOOHR{padding:32px 16px 22px;margin-top:-15px;justify-content:space-between;display:flex;flex-wrap:wrap;width:100%;height:237px;background:linear-gradient(146deg,#fdefd3 0%,#fff7e8 39%,#fdefd3 100%);border-radius:13px;border:1px solid #f4ecda;position:relative;z-index:2}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL>.func-box-content-AvOOHR.hide-GwgJTN{display:none}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL>.func-box-content-AvOOHR .func-item-pFTZAQ{width:228px;height:79px;border:1px solid #f9faff;padding:11px 14px;display:flex;background:#fffdf6;border-radius:12px;border:1px solid #f4ecda}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL>.func-box-content-AvOOHR .func-item-pFTZAQ:nth-child(3){padding-right:0}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL>.func-box-content-AvOOHR .func-item-pFTZAQ>img{width:33px;height:33px;margin-right:10px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL>.func-box-content-AvOOHR .func-item-pFTZAQ .func-title-xRWbHC{margin-bottom:4px;font-weight:600;font-size:13px;color:#694e25;line-height:18px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL>.func-box-content-AvOOHR .func-item-pFTZAQ .func-desc-AtIvRb{font-weight:400;font-size:12px;color:#937249;line-height:17px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .func-list-HNmWq5 .left-tGJQ6H,.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .func-list-HNmWq5 .right-VzAHDH{width:230px;height:185px;padding-left:12px;padding-top:14px;background:#fffdf6;border-radius:9px;border:1px solid;border-image:linear-gradient(169deg,#faf7ef,#f4ecda) 1 1}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .func-list-HNmWq5 .left-tGJQ6H>.title-LrDiIh,.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .func-list-HNmWq5 .right-VzAHDH>.title-LrDiIh{display:flex;flex-direction:row;justify-content:center;align-items:center;font-weight:400;font-size:12px;color:#736f6c;margin-bottom:18px;justify-content:flex-start;position:relative}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .func-list-HNmWq5 .left-tGJQ6H>.title-LrDiIh .icon-h-abn4,.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .func-list-HNmWq5 .right-VzAHDH>.title-LrDiIh .icon-h-abn4{width:12px;margin-right:5px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .func-list-HNmWq5 .left-tGJQ6H ul,.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .func-list-HNmWq5 .right-VzAHDH ul{display:flex;flex-wrap:wrap;row-gap:16px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .func-list-HNmWq5 .left-tGJQ6H ul li,.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .func-list-HNmWq5 .right-VzAHDH ul li{font-weight:400;font-size:13px;color:#353535;display:flex;align-items:baseline}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .func-list-HNmWq5 .left-tGJQ6H ul li.learning-li-CeU-ap,.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .func-list-HNmWq5 .right-VzAHDH ul li.learning-li-CeU-ap{margin-left:0!important}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .func-list-HNmWq5 .left-tGJQ6H ul li .icon-h-abn4,.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .func-list-HNmWq5 .right-VzAHDH ul li .icon-h-abn4{width:12px;height:12px;margin-right:6px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .func-list-HNmWq5 .left-tGJQ6H ul li:nth-child(2n),.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .func-list-HNmWq5 .right-VzAHDH ul li:nth-child(2n){margin-left:40px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .func-list-HNmWq5 .left-tGJQ6H ul li .database-list-gGp-ft,.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .func-list-HNmWq5 .right-VzAHDH ul li .database-list-gGp-ft{display:flex;row-gap:8px;column-gap:9px;flex-wrap:wrap}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .func-list-HNmWq5 .left-tGJQ6H ul li .database-list-gGp-ft span,.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.left-tGJQ6H .func-box-n-z9VL .func-list-HNmWq5 .right-VzAHDH ul li .database-list-gGp-ft span{background:#ffffff;border-radius:5px;border:1px solid #f0f0f0;display:block;font-weight:400;font-size:12px;color:#6c6f73;line-height:17px;padding:2px 8px 3px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH{width:252px;padding:16px 0 0;height:100%;border-radius:0 12px 12px 0;background:linear-gradient(28deg,#363636 0%,#555556 100%);display:flex;justify-content:center;align-items:center;flex-direction:column;justify-content:flex-start}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .buy-record-box-C8CrOD{padding:0 10px;overflow:hidden;width:226px;height:32px;background:#fff7e2;box-shadow:inset 0 1px 3px #ffffff6e;border-radius:5px;border:1px solid #fff0c7}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .buy-record-box-C8CrOD .record-item-uciOPa{width:100%}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .buy-record-box-C8CrOD .record-item-uciOPa div{width:100%;height:32px;display:flex;flex-direction:row;justify-content:center;align-items:center;font-weight:600;font-size:12px;color:#995a00}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .buy-box--BfROl{margin-top:16px;display:flex;justify-content:center;align-items:center;flex-direction:column}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .buy-box--BfROl .plan-title-C5rdI3{font-weight:500;font-size:14px;color:#fbdebe;line-height:20px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .buy-box--BfROl .plan-price--9aLlr{font-weight:600;font-size:25px;color:#fbdebe;line-height:36px;position:relative;width:fit-content}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .buy-box--BfROl .plan-price--9aLlr div{height:22px;padding:0 6px;position:absolute;background:linear-gradient(157deg,#ff834e 0%,#ffac5c 100%);border-radius:9px 9px 9px 0;border:1px solid #ffac5c;font-weight:400;font-size:12px;color:#f7f9ff;display:flex;flex-direction:row;justify-content:center;align-items:center;right:-7px;top:0;transform:translate(100%);white-space:nowrap}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .buy-box--BfROl .qr-box-NdysdO{width:140px;height:140px;margin-top:4px;position:relative;z-index:1;display:flex;justify-content:center;align-items:center;flex-direction:column}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .buy-box--BfROl .qr-box-NdysdO .qr-logo-kfs08W{width:35px;height:36px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:2}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .buy-box--BfROl .qr-box-NdysdO .reload-box-3JoW6x{width:135px;height:135px;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.94);display:flex;justify-content:center;align-items:center;flex-direction:column;cursor:pointer}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .buy-box--BfROl .qr-box-NdysdO .reload-box-3JoW6x img{width:16px;margin-bottom:4px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .buy-box--BfROl .qr-box-NdysdO .reload-box-3JoW6x span.text-TSajWu{font-size:13px;font-weight:400;color:#999;line-height:18px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .buy-box--BfROl .pay-methods-AaGYG5{display:flex;flex-direction:row;justify-content:center;align-items:center;font-weight:400;font-size:12px;color:#f2d6b8;margin-top:12px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .buy-box--BfROl .pay-methods-AaGYG5 img{height:14px;margin:0 4px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .buy-box--BfROl .subscription-Pdf-9i5o2N{margin-top:4px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .buy-box--BfROl .subscription-Pdf-9i5o2N.hidden-VpazZn{visibility:hidden}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .buy-box--BfROl .subscription-Pdf-9i5o2N a{color:#f2d6b8!important}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .coupon-box-4IprhF{margin-top:12px;width:212px;height:35px;background:rgba(254,243,221,.1);border-radius:9px;padding:0 10px;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:space-between}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .coupon-box-4IprhF .coupon-info-qPmtiK{width:100%;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:space-between}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .coupon-box-4IprhF.enable-fstoo-{cursor:pointer}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .coupon-box-4IprhF.enable-fstoo- .left-tGJQ6H{color:#fbdebe}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .coupon-box-4IprhF .right-VzAHDH{font-weight:400;font-size:13px;color:#ff834e;display:flex;flex-direction:row;justify-content:center;align-items:center}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .coupon-box-4IprhF .right-VzAHDH img{width:12px;margin-left:2px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .coupon-box-4IprhF .left-tGJQ6H{display:flex;flex-direction:row;justify-content:center;align-items:center;font-weight:400;font-size:13px;color:#fbdebe}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .coupon-box-4IprhF .left-tGJQ6H img{width:18px;margin-right:5px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .user-comment-box-sXgoAj{margin-top:23px;display:flex;justify-content:center;align-items:center;flex-direction:column}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .user-comment-box-sXgoAj .text-img-nShXqM{height:25px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .user-comment-box-sXgoAj .comment-list-LbB04a{width:214px;height:146px;overflow:hidden;margin-top:13px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .user-comment-box-sXgoAj .comment-list-LbB04a.with-coupon--vuWDP{height:99px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .user-comment-box-sXgoAj .comment-list-LbB04a .ant-carousel,.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .user-comment-box-sXgoAj .comment-list-LbB04a .slick-slider,.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .user-comment-box-sXgoAj .comment-list-LbB04a .slick-list{height:100%!important}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .user-comment-box-sXgoAj .comment-list-LbB04a .comment-item-X8YUdx{padding:8px 10px;width:214px;position:relative;z-index:2;margin-bottom:8px;border-radius:10px;overflow:hidden}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .user-comment-box-sXgoAj .comment-list-LbB04a .comment-content-UKSU6r{font-weight:400;font-size:13px;color:#d9c2a8;line-height:18px;padding-left:25px}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .user-comment-box-sXgoAj .comment-list-LbB04a .comment-user-zucvGM{display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;font-weight:400;font-size:12px;color:#d9c2a8}.buy-vip-dialog-new-Oh4Wbm .content-nseJ6B>.right-VzAHDH .user-comment-box-sXgoAj .comment-list-LbB04a .comment-user-zucvGM .avatar-9KVapB{width:20px;height:20px;border-radius:20px;margin-right:5px;background:#e0c8ac;font-weight:600;font-size:12px;color:#fff;display:flex;flex-direction:row;justify-content:center;align-items:center}.banner-box-pkN6pz{width:100%}.banner-box-pkN6pz.allow-click-1i5Ycw{cursor:pointer}.banner-box-pkN6pz>div{width:100%;position:relative}.banner-box-pkN6pz>div .banner-box-img-einMyr{width:100%}.banner-box-pkN6pz>div .bubble-activity-box-btn-ZXzQdf{position:absolute;width:69px;height:25px;background:linear-gradient(177deg,#7B6EFC 0%,#5657F7 100%);border-radius:13px;border:1px solid #7A6EFC;font-size:14px;color:#fff}.banner-box-pkN6pz>div .bubble-activity-box-btn-ZXzQdf:hover{color:#fff!important;background:linear-gradient(177deg,#7366FA 0%,#4849F4 100%)!important;border:1px solid #7A6EFC}.banner-box-pkN6pz>div .bubble-activity-box-btn-img-SvfU6h{position:absolute;cursor:pointer}.banner-box-pkN6pz>div .bubble-activity-box-btn-img-SvfU6h img{width:100%}.banner-box-pkN6pz>div .bubble-activity-box-btn-img-SvfU6h:hover .bubble-activity-box-btn-img-hover-e11hqO{display:block}.banner-box-pkN6pz>div .bubble-activity-box-btn-img-SvfU6h:hover .bubble-activity-box-btn-img-normal-5r-UMe{display:none}.banner-box-pkN6pz>div .bubble-activity-box-btn-img-SvfU6h .bubble-activity-box-btn-img-hover-e11hqO{display:none}.countdown-box-Z116Z8.from-bubble-2pmuWg{position:absolute;width:211px;height:32px;background:linear-gradient(301deg,rgba(202,179,246,.8) 0%,rgba(199,216,255,.8) 100%);border-radius:8px;display:flex;flex-direction:row;justify-content:center;align-items:center;font-weight:400;font-size:12px;color:#333}.countdown-box-Z116Z8.from-bubble-2pmuWg span{width:20px;height:20px;background:linear-gradient(180deg,#FFF5D3 0%,#FFE7A8 100%);border-radius:4px;border:1px solid #FFF6E0;font-weight:600;font-size:13px;color:#e87b29;display:flex;flex-direction:row;justify-content:center;align-items:center;margin:0 2px}.countdown-box-Z116Z8.from-banner-r67jOp{position:absolute;display:flex;flex-direction:row;justify-content:center;align-items:center;font-weight:400;font-size:12px;color:#666}.countdown-box-Z116Z8.from-banner-r67jOp.with-pay-modal--oDFOm.only-d-OtksB2 span{width:18px;height:18px}.countdown-box-Z116Z8.from-banner-r67jOp.with-pay-modal--oDFOm span{border-radius:7px;width:29px;height:29px;font-size:18px}.countdown-box-Z116Z8.from-banner-r67jOp.only-d-OtksB2 span{width:18px;height:18px;background:none;border:none;font-weight:600;font-size:16px;color:#fff;display:flex;flex-direction:row;justify-content:center;align-items:center}.countdown-box-Z116Z8.from-banner-r67jOp span{width:19px;height:19px;background:linear-gradient(180deg,#FFF5D3 0%,#FFE7A8 100%);border-radius:4px;border:1px solid #FFF6E0;font-weight:600;font-size:13px;color:#e87b29;display:flex;flex-direction:row;justify-content:center;align-items:center;margin:0 2px}.countdown-box-Z116Z8.from-banner-r67jOp span img+img{margin-left:-1px}.coupon-modal-on4eg4 .ant-modal{line-height:unset!important}.coupon-modal-on4eg4 .ant-modal-content{padding:24px 40px!important;border-radius:12px!important;background:linear-gradient(180deg,#EBEEFF 0%,#FFFFFF 100%);box-shadow:0 5px 32px 2px #0000001f}.coupon-modal-on4eg4 .ant-modal-content .ant-modal-header{background-color:unset}.coupon-modal-on4eg4 .ant-modal-content .ant-modal-title{text-align:center}.coupon-modal-on4eg4 .ant-modal-content .ant-modal-body{line-height:unset!important}.coupon-modal-on4eg4 .ok-button-gXQUVA,.coupon-modal-on4eg4 .cancel-button-HwFpzZ{width:120px;height:44px;margin-inline-start:16px!important;font-weight:600;font-size:16px}.coupon-modal-on4eg4 .content-moDV2f{margin-top:16px;height:443px;overflow-y:auto;overflow-y:auto!important;overscroll-behavior:contain;scrollbar-width:thin;scrollbar-color:#0000002f transparent;margin-right:-28px;padding-right:28px}.coupon-modal-on4eg4 .content-moDV2f::-webkit-scrollbar{height:6px;width:6px;margin-right:10px}.coupon-modal-on4eg4 .content-moDV2f::-webkit-scrollbar-track{background:transparent}.coupon-modal-on4eg4 .content-moDV2f::-webkit-scrollbar-thumb{background:#0000002f;border-radius:4px;cursor:default}.coupon-modal-on4eg4 .content-moDV2f::-webkit-scrollbar-thumb:hover{background:#00000062}.coupon-modal-on4eg4 .content-moDV2f.with-footer-d2LsIs{height:419px}.coupon-modal-on4eg4 .content-moDV2f .coupon-tips-MI-WDd{background:linear-gradient(136deg,#FEFDE0 0%,#FFFEEA 15%,#FEFDE0 100%);border-radius:8px;border:1px solid #FFF7C6;width:100%;padding:12px 0 20px 20px;font-weight:400;font-size:14px;color:#723d15;line-height:20px}.coupon-modal-on4eg4 .content-moDV2f .tab-box-2pHOx4{width:168px;background:#F8F8F8;border-radius:10px;border:1px solid #E9E9E9;display:flex;margin-top:16px}.coupon-modal-on4eg4 .content-moDV2f .tab-box-2pHOx4 .tab-item-5r7ZsK{width:50%;font-weight:400;font-size:14px;color:#666;height:36px;display:flex;flex-direction:row;justify-content:center;align-items:center;cursor:pointer;border-radius:8px}.coupon-modal-on4eg4 .content-moDV2f .tab-box-2pHOx4 .tab-item-5r7ZsK.active-VROKLY{background:#FFFFFF;box-shadow:0 0 7px #5c5c5c14;color:#333;font-weight:600}.coupon-modal-on4eg4 .content-moDV2f .coupon-list-krK1bH{margin-top:16px;display:flex;flex-wrap:wrap;row-gap:16px;column-gap:20px}.coupon-modal-on4eg4 .content-moDV2f .coupon-list-krK1bH .empty-DwinsF{width:100%;display:flex;justify-content:center;align-items:center;flex-direction:column;margin-top:40px}.coupon-modal-on4eg4 .content-moDV2f .coupon-list-krK1bH .empty-DwinsF img{width:169px;height:105px;margin-bottom:24px}.coupon-modal-on4eg4 .content-moDV2f .coupon-list-krK1bH .empty-DwinsF p{font-weight:400;font-size:14px;color:#666;line-height:20px}.coupon-modal-on4eg4 .content-moDV2f .coupon-list-krK1bH .coupon-item-nMs3Xr{width:405px;position:relative;z-index:2;display:flex;flex-direction:row;justify-content:center;align-items:center;cursor:pointer}.coupon-modal-on4eg4 .content-moDV2f .coupon-list-krK1bH .coupon-item-nMs3Xr.disabled-6zfNhE{opacity:.5;cursor:unset}.coupon-modal-on4eg4 .content-moDV2f .coupon-list-krK1bH .coupon-item-nMs3Xr .bg-6BE-CP{width:412px;position:absolute;top:-4px;left:0;z-index:-1}.coupon-modal-on4eg4 .content-moDV2f .coupon-list-krK1bH .coupon-item-nMs3Xr .price-box-kxDliv{width:90px;height:80px;display:flex;flex-direction:row;justify-content:center;align-items:center;font-size:34px;color:#fff;line-height:42px}.coupon-modal-on4eg4 .content-moDV2f .coupon-list-krK1bH .coupon-item-nMs3Xr .price-box-kxDliv p{display:flex;align-items:baseline}.coupon-modal-on4eg4 .content-moDV2f .coupon-list-krK1bH .coupon-item-nMs3Xr .price-box-kxDliv span{font-weight:400;font-size:14px;color:#fff;line-height:20px}.coupon-modal-on4eg4 .content-moDV2f .coupon-list-krK1bH .coupon-item-nMs3Xr .coupon-right-SQl2hF{width:312px;height:80px;padding:0 16px 0 20px;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:space-between}.coupon-modal-on4eg4 .content-moDV2f .coupon-list-krK1bH .coupon-item-nMs3Xr .coupon-right-SQl2hF .coupon-info-BqnXxK .title-zoqsEJ{font-weight:600;font-size:16px;color:#222;line-height:22px}.coupon-modal-on4eg4 .content-moDV2f .coupon-list-krK1bH .coupon-item-nMs3Xr .coupon-right-SQl2hF .coupon-info-BqnXxK .expired-i67Bu2{font-weight:400;font-size:12px;color:#666;line-height:17px;margin-top:4px}.coupon-modal-on4eg4 .content-moDV2f .coupon-list-krK1bH .coupon-item-nMs3Xr .coupon-right-SQl2hF .radio-box-C-5YwU img{width:16px;height:16px}.coupon-modal-on4eg4 .content-moDV2f .coupon-list-krK1bH .coupon-item-nMs3Xr .coupon-right-SQl2hF .radio-box-C-5YwU .hover-YSIdqM,.coupon-modal-on4eg4 .content-moDV2f .coupon-list-krK1bH .coupon-item-nMs3Xr .coupon-right-SQl2hF .radio-box-C-5YwU .checked-AoTIoR,.coupon-modal-on4eg4 .content-moDV2f .coupon-list-krK1bH .coupon-item-nMs3Xr .coupon-right-SQl2hF .radio-box-C-5YwU.active-VROKLY .hover-YSIdqM,.coupon-modal-on4eg4 .content-moDV2f .coupon-list-krK1bH .coupon-item-nMs3Xr .coupon-right-SQl2hF .radio-box-C-5YwU.active-VROKLY .default-kfLCaD{display:none}.coupon-modal-on4eg4 .content-moDV2f .coupon-list-krK1bH .coupon-item-nMs3Xr .coupon-right-SQl2hF .radio-box-C-5YwU.active-VROKLY .checked-AoTIoR{display:block}.coupon-modal-on4eg4 .content-moDV2f .coupon-list-krK1bH .coupon-item-nMs3Xr .coupon-right-SQl2hF .radio-box-C-5YwU:not(.active-VROKLY):hover .default-kfLCaD{display:none}.coupon-modal-on4eg4 .content-moDV2f .coupon-list-krK1bH .coupon-item-nMs3Xr .coupon-right-SQl2hF .radio-box-C-5YwU:not(.active-VROKLY):hover .hover-YSIdqM{display:block}.retain-modal-R4XBM2 .ant-modal{line-height:unset!important}.retain-modal-R4XBM2 .ant-modal-content{padding:0!important;border-radius:12px!important}.retain-modal-R4XBM2 .ant-modal-content .ant-modal-body{line-height:unset!important}.retain-modal-R4XBM2 .retain-content-4duvBx{background:linear-gradient(180deg,#EBEEFF 0%,#FFFFFF 100%);height:370px;border-radius:12px!important;display:flex;justify-content:center;align-items:center;flex-direction:column;justify-content:flex-start;padding-top:26px}.retain-modal-R4XBM2 .retain-content-4duvBx .retain-title-eKLDSh{font-size:18px;color:#000;font-weight:600}.retain-modal-R4XBM2 .retain-content-4duvBx .retain-title-eKLDSh .icon-5NGUZ2{width:19px;margin-right:4px}.retain-modal-R4XBM2 .retain-content-4duvBx .retain-title-eKLDSh span{color:#6165f7}.retain-modal-R4XBM2 .retain-content-4duvBx p.retain-title-eKLDSh{margin-top:8px}.retain-modal-R4XBM2 .retain-content-4duvBx .retain-image-pOe1ze{width:367px;position:relative;top:-40px}.retain-modal-R4XBM2 .retain-content-4duvBx .receive-btn-oGSEH4{width:192px;height:44px;background:#6165f7;border-radius:8px;color:#fff;font-size:16px;font-weight:600;border:none}.retain-modal-R4XBM2 .retain-content-4duvBx .receive-btn-oGSEH4:hover{background:#595DE3;color:#fff}.retain-modal-R4XBM2 .retain-content-4duvBx .close-btn-imlTrX{font-weight:400;font-size:13px;color:#90909a;line-height:18px;cursor:pointer;position:absolute;right:24px;bottom:20px}.retain-modal-R4XBM2 .retain-content-4duvBx .close-btn-imlTrX:hover{color:#6d6c75}.pay-qr-dialog-xGQAX5 .ant-modal{line-height:unset!important}.pay-qr-dialog-xGQAX5 .ant-modal-content{padding:0!important;border-radius:28px!important}.pay-qr-dialog-xGQAX5 .ant-modal-content .ant-modal-body{line-height:unset!important}.pay-qr-dialog-xGQAX5 .pay-qr-dialog-content-liOvv1{padding:24px 0;height:431px;display:flex;justify-content:center;align-items:center;flex-direction:column;justify-content:flex-start;background:linear-gradient(180deg,#EBEEFF 0%,#FFFFFF 100%);box-shadow:0 5px 32px 2px #0000001f;border-radius:12px}.pay-qr-dialog-xGQAX5 .pay-qr-dialog-content-liOvv1>.title-ei3zsp{font-size:20px;font-weight:600;color:#000;line-height:28px}.pay-qr-dialog-xGQAX5 .pay-qr-dialog-content-liOvv1>.plan-title-DYTMyC{font-weight:600;font-size:18px;color:#333;line-height:25px;margin-top:20px;text-align:center}.pay-qr-dialog-xGQAX5 .pay-qr-dialog-content-liOvv1 .plan-desc-ANoABf{font-weight:400;font-size:14px;color:#666;line-height:20px;margin-top:4px}.pay-qr-dialog-xGQAX5 .pay-qr-dialog-content-liOvv1 .plan-desc-ANoABf+.qr-box-Z3RmeR{margin-top:8px}.pay-qr-dialog-xGQAX5 .pay-qr-dialog-content-liOvv1 .qr-box-Z3RmeR{width:200px;height:200px;margin-top:16px;display:flex;justify-content:center;align-items:center;flex-direction:column;position:relative}.pay-qr-dialog-xGQAX5 .pay-qr-dialog-content-liOvv1 .qr-box-Z3RmeR>img{width:100%;position:absolute;left:0;top:0}.pay-qr-dialog-xGQAX5 .pay-qr-dialog-content-liOvv1 .qr-box-Z3RmeR .reload-box-GjyqS9{width:100%;height:100%;position:absolute;left:0;top:0;background:rgba(255,255,255,.94);justify-content:center;cursor:pointer}.pay-qr-dialog-xGQAX5 .pay-qr-dialog-content-liOvv1 .qr-box-Z3RmeR .reload-box-GjyqS9 img{width:16px;margin-bottom:4px}.pay-qr-dialog-xGQAX5 .pay-qr-dialog-content-liOvv1 .qr-box-Z3RmeR .reload-box-GjyqS9 span{font-size:13px;font-family:PingFangSC-Regular,PingFang SC;font-weight:400;color:#999;line-height:18px}.pay-qr-dialog-xGQAX5 .pay-qr-dialog-content-liOvv1>.pay-method-yqvXSX{display:flex;flex-direction:row;justify-content:center;align-items:center;font-weight:400;font-size:14px;color:#666;margin-top:16px}.pay-qr-dialog-xGQAX5 .pay-qr-dialog-content-liOvv1>.pay-method-yqvXSX img{width:18px;margin:0 4px}.pay-qr-dialog-xGQAX5 .pay-qr-dialog-content-liOvv1 .invoice-box-dlwKJB{display:flex;flex-direction:row;justify-content:center;align-items:center;font-weight:400;font-size:13px;color:#999;margin-top:8px}.pay-qr-dialog-xGQAX5 .pay-qr-dialog-content-liOvv1 .invoice-box-dlwKJB img{width:13px;margin-right:8px}.upgrade-alert-modal-8QkggP .ant-modal-content{padding:0;border-radius:12px}.upgrade-alert-modal-8QkggP .content-6fTbG1{border-radius:12px;overflow:hidden;line-height:normal}.upgrade-alert-modal-8QkggP .content-6fTbG1 .top-ZTTp3a{width:100%}.upgrade-alert-modal-8QkggP .content-6fTbG1 .info-lcnktq{width:530px;background:#ffffff;padding:22px 32px}.upgrade-alert-modal-8QkggP .content-6fTbG1 .info-lcnktq .title-T00Uvx{display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;gap:2px;font-family:PingFangSC,PingFang SC;font-weight:600;font-size:14px;color:#333;text-align:left;font-style:normal;line-height:normal}.upgrade-alert-modal-8QkggP .content-6fTbG1 .info-lcnktq .title-T00Uvx .icon-ibMXUe{width:17px}.upgrade-alert-modal-8QkggP .content-6fTbG1 .info-lcnktq .text-box-VgpBhT{width:466px;background:#f7f9fa;border-radius:12px;padding:15px;margin-top:12px}.upgrade-alert-modal-8QkggP .content-6fTbG1 .info-lcnktq .text-box-VgpBhT.bg-transparent-x2sJTx{background:transparent}.upgrade-alert-modal-8QkggP .content-6fTbG1 .info-lcnktq .text-box-VgpBhT .text-1f7qK-{font-family:PingFangSC,PingFang SC;font-weight:400;font-size:14px;color:#333;text-align:left;font-style:normal;line-height:22px}.upgrade-alert-modal-8QkggP .content-6fTbG1 .info-lcnktq .text-box-VgpBhT .pdf-btn-kaPSko{margin-top:8px;width:102px;height:28px;background:#fcfdfd;border-radius:14px;border:1px solid #dad6fa;display:flex;flex-direction:row;justify-content:center;align-items:center;font-weight:400;font-size:13px;color:#6165f7;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;gap:2px}.upgrade-alert-modal-8QkggP .content-6fTbG1 .info-lcnktq .text-box-VgpBhT .pdf-btn-kaPSko .arrow-ecc5t9{width:12px;height:12px}.upgrade-alert-modal-8QkggP .content-6fTbG1 .info-lcnktq .text-box-VgpBhT .pdf-btn-kaPSko:hover{background:#6165f7;border-radius:14px;color:#fff}.language-wrap-QLu-fg{padding:12px;display:flex;flex-direction:column;justify-content:flex-start;align-items:normal;width:280px;height:326px}.language-wrap-QLu-fg.single-line-dLHF5g{height:296px}.language-wrap-QLu-fg .search-box-wEi6YY{position:relative}.language-wrap-QLu-fg .search-box-wEi6YY .input-Z-n8X3{width:100%;height:36px;background:#f7f9fa;border-radius:6px;border:1px solid #f2f2f2;padding:8px 12px;outline:none;font-weight:500;font-size:14px;color:#1c1e22;text-align:left;font-style:normal}.language-wrap-QLu-fg .search-box-wEi6YY .input-Z-n8X3::placeholder{font-weight:400;font-size:14px;color:#999;text-align:left;font-style:normal}.language-wrap-QLu-fg .search-box-wEi6YY .icon-box-jYatbM{width:16px;height:16px;position:absolute;right:12px;top:9px;display:flex;flex-direction:row;justify-content:center;align-items:center}.language-wrap-QLu-fg .search-box-wEi6YY .icon-box-jYatbM img{width:100%}.language-wrap-QLu-fg .search-box-wEi6YY .icon-box-jYatbM .close-icon-GhovDq{cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.language-wrap-QLu-fg .language-list-XepGgw{flex:1;overflow-y:auto;overflow-y:auto!important;overscroll-behavior:contain;scrollbar-width:thin;scrollbar-color:#0000002f transparent;width:100%;margin-top:10px;position:relative}.language-wrap-QLu-fg .language-list-XepGgw::-webkit-scrollbar{height:6px;width:6px;margin-right:10px}.language-wrap-QLu-fg .language-list-XepGgw::-webkit-scrollbar-track{background:transparent}.language-wrap-QLu-fg .language-list-XepGgw::-webkit-scrollbar-thumb{background:#0000002f;border-radius:4px;cursor:default}.language-wrap-QLu-fg .language-list-XepGgw::-webkit-scrollbar-thumb:hover{background:#00000062}.language-wrap-QLu-fg .language-list-XepGgw .language-item-9oldO4{cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.language-wrap-QLu-fg .language-list-XepGgw .language-item-9oldO4.active-HDIB-h .main-pcrv6q{color:#6165f7}.language-wrap-QLu-fg .language-list-XepGgw .language-item-9oldO4:hover{background:#f7f9fa;border-radius:8px}.language-wrap-QLu-fg .language-list-XepGgw .language-item-9oldO4 .main-pcrv6q{font-weight:500;font-size:14px;color:#1c1e22;text-align:left;line-height:20px;font-style:normal}.language-wrap-QLu-fg .language-list-XepGgw .language-item-9oldO4 .secondary-OsE4Fz{font-weight:400;font-size:12px;color:#666;text-align:left;line-height:20px;font-style:normal}.language-wrap-QLu-fg .language-list-XepGgw .language-item-9oldO4.single-line-dLHF5g{padding:12px}.language-wrap-QLu-fg .language-list-XepGgw .language-item-9oldO4.double-line-94CM-Y{padding:6px 12px}.language-wrap-QLu-fg .language-list-XepGgw .empty-box-Y13fRK{display:flex;justify-content:center;align-items:center;flex-direction:column;font-size:12px;color:#1c1e22;text-align:center;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%)}.language-wrap-QLu-fg .language-list-XepGgw .empty-box-Y13fRK .empty-icon-MzEB32{width:138px}.language-wrap-QLu-fg .language-list-XepGgw .empty-box-Y13fRK .empty-text-xl00qb{margin-top:24px}.radio-item-qq1H5j{display:flex;align-items:center;cursor:pointer}.radio-item-qq1H5j>img{width:14px;margin-right:4px}.radio-item-qq1H5j>img.checked-WFk1lh{display:none}.radio-item-qq1H5j>img.hover-QfGjDc{display:none}.radio-item-qq1H5j:not(.checked-WFk1lh):hover>img.hover-QfGjDc{display:unset}.radio-item-qq1H5j:not(.checked-WFk1lh):hover>img.default-aJjOQr{display:none}.radio-item-qq1H5j.checked-WFk1lh>img.checked-WFk1lh{display:unset}.radio-item-qq1H5j.checked-WFk1lh>img.default-aJjOQr{display:none}.radio-item-qq1H5j.checked-WFk1lh>img.hover-QfGjDc{display:none}.radio-item-qq1H5j>span{font-size:14px;font-weight:400;color:#1c1e22;display:flex;align-items:center}.web-translation-top-bar-lHrWlL{width:100vw;background:#ffffff;box-shadow:0 2px 20px #33333314;padding:0 24px;height:50px;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:space-between;position:fixed;top:0;left:0;z-index:2147483646}.web-translation-top-bar-lHrWlL>.left-RtjCCH{display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start}.web-translation-top-bar-lHrWlL>.left-RtjCCH .logo-i-uoV8{height:32px}.web-translation-top-bar-lHrWlL>.left-RtjCCH>span{font-weight:400;font-size:13px;color:#333;display:flex;flex-direction:row;justify-content:center;align-items:center}.web-translation-top-bar-lHrWlL>.left-RtjCCH>span img{width:14px;margin-right:6px}.web-translation-top-bar-lHrWlL>.left-RtjCCH>span.topbar-guide-text--yoqxt img{width:19px;margin-right:0;margin-left:6px}.web-translation-top-bar-lHrWlL>.left-RtjCCH .target-lang-item-a-mWv-{display:flex;align-items:center;justify-content:space-between;width:128px;height:32px;padding:0 12px;background:#f7f9fa;border-radius:8px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.web-translation-top-bar-lHrWlL>.left-RtjCCH .target-lang-item-a-mWv- .name-i5kS5p{font-size:13px;color:#2c2c2c;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;word-break:break-all}.web-translation-top-bar-lHrWlL>.left-RtjCCH .target-lang-item-a-mWv- .arrow-xtlcY-{font-size:12px;color:#00000040}.web-translation-top-bar-lHrWlL>.left-RtjCCH .translate-btn-9aUbGs{padding:0 20px;height:32px;background:#6165f7;color:#fff;margin-left:20px;border:none;font-size:13px;line-height:normal}.web-translation-top-bar-lHrWlL>.left-RtjCCH .translate-btn-9aUbGs.translated-btn--gqEN8{background:#ffffff;border-radius:8px;border:1px solid #6165f7;color:#6165f7}.web-translation-top-bar-lHrWlL>.left-RtjCCH .translate-btn-9aUbGs img{width:18px}.web-translation-top-bar-lHrWlL>.left-RtjCCH .translate-btn-9aUbGs:not(.translated-btn--gqEN8):hover{background:#595DE3!important;color:#fff!important}.web-translation-top-bar-lHrWlL>.left-RtjCCH .free-translate-tips-ExIAku{font-size:14px;color:#6165f7;margin-left:20px}.web-translation-top-bar-lHrWlL>.left-RtjCCH .select-btn-av5JSg{margin-left:20px}.web-translation-top-bar-lHrWlL>.left-RtjCCH .select-btn-av5JSg .translation-type-lhtfXB{font-size:13px;line-height:normal}.web-translation-top-bar-lHrWlL>.left-RtjCCH .select-btn-av5JSg .translation-type-lhtfXB button{font-size:13px;line-height:normal}.web-translation-top-bar-lHrWlL>.left-RtjCCH .select-btn-av5JSg .vip-icon-umRhw8{width:37px;margin-left:4px}.web-translation-top-bar-lHrWlL>.right--I1N6k{display:flex;flex-direction:row;justify-content:center;align-items:center;position:relative;padding-left:6px;margin-left:24px}.web-translation-top-bar-lHrWlL>.right--I1N6k.with-border-ibzxvP:before{content:"";display:block;width:3px;height:12px;background:linear-gradient(157deg,#6e72fc 0%,#5657f7 100%);border-radius:2px;position:absolute;left:-3px;top:50%;transform:translateY(-50%)}.web-translation-top-bar-lHrWlL>.right--I1N6k .translate-model-d0sgJu{display:flex;flex-direction:row;justify-content:center;align-items:center}.web-translation-top-bar-lHrWlL>.right--I1N6k .translate-model-d0sgJu .label-tJVVaR{font-family:PingFangSC,PingFang SC;font-weight:400;font-size:13px;color:#333}.web-translation-top-bar-lHrWlL>.right--I1N6k .translate-model-d0sgJu .content-hKfpIZ{min-width:156px;height:32px;background:#f7f9fa;border-radius:8px;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;padding:6px 12px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.web-translation-top-bar-lHrWlL>.right--I1N6k .translate-model-d0sgJu .content-hKfpIZ .name-i5kS5p{flex:1;font-size:13px}.web-translation-top-bar-lHrWlL>.right--I1N6k .translate-model-d0sgJu .content-hKfpIZ .arrow-xtlcY-{font-size:12px;color:#00000040}.web-translation-top-bar-lHrWlL>.right--I1N6k .icon-BBfi9Q{width:20px;height:20px;padding:2px;margin-left:16px;cursor:pointer;user-select:none}.web-translation-top-bar-lHrWlL>.right--I1N6k .auto-translate-setting-3xkgR6{margin-left:24px}.web-translation-top-bar-lHrWlL>.right--I1N6k .auto-translate-setting-3xkgR6 .auto-translate-setting-label-ghoXVv{font-size:13px;color:#666}.web-translation-top-bar-lHrWlL .close-setting-confirm-modal-pqTQ3z{width:386px;position:absolute;padding:24px 28px;top:60px;right:24px;z-index:3;background:#ffffff;box-shadow:0 5px 32px 2px #0000001f;border-radius:12px;border:1px solid #efeff0}.web-translation-top-bar-lHrWlL .close-setting-confirm-modal-pqTQ3z .close-i8qIiL{position:absolute;user-select:none;cursor:pointer;right:18px;top:18px;width:20px;height:20px;padding:2px}.web-translation-top-bar-lHrWlL .close-setting-confirm-modal-pqTQ3z .title-mkcp0y{display:flex;align-items:center}.web-translation-top-bar-lHrWlL .close-setting-confirm-modal-pqTQ3z .title-mkcp0y .bell-icon-2SQLQd{width:16px;margin-right:4px}.web-translation-top-bar-lHrWlL .close-setting-confirm-modal-pqTQ3z .title-mkcp0y span{font-size:13px;font-weight:600;color:#2c2c2c}.web-translation-top-bar-lHrWlL .close-setting-confirm-modal-pqTQ3z>.content-hKfpIZ{margin-top:12px}.web-translation-top-bar-lHrWlL .close-setting-confirm-modal-pqTQ3z>.content-hKfpIZ .box-0AGNjq{background:#f4f7f8;border-radius:10px}.web-translation-top-bar-lHrWlL .close-setting-confirm-modal-pqTQ3z>.content-hKfpIZ .radio-box-KD7aCe{margin-top:12px;padding:20px 16px}.web-translation-top-bar-lHrWlL .close-setting-confirm-modal-pqTQ3z>.content-hKfpIZ .radio-box-KD7aCe .close-radio-item--aodtZ:not(:last-child){margin-bottom:16px}.web-translation-top-bar-lHrWlL .close-setting-confirm-modal-pqTQ3z>.content-hKfpIZ .radio-box-KD7aCe .close-radio-item--aodtZ>span{display:flex;align-items:center}.web-translation-top-bar-lHrWlL .close-setting-confirm-modal-pqTQ3z>.content-hKfpIZ .radio-box-KD7aCe .close-radio-item--aodtZ>span .desc-DVrMeo{font-size:13px;font-family:PingFangSC-Regular,PingFang SC;font-weight:400;color:#666;line-height:18px}.web-translation-top-bar-lHrWlL .close-setting-confirm-modal-pqTQ3z>.content-hKfpIZ .radio-box-KD7aCe .close-radio-item--aodtZ>span .desc-DVrMeo a{color:#6165f7}.web-translation-top-bar-lHrWlL .close-setting-confirm-modal-pqTQ3z .footer-box-JCm1s0{display:flex;align-items:center;justify-content:flex-start;margin-top:20px}.web-translation-top-bar-lHrWlL .close-setting-confirm-modal-pqTQ3z .footer-box-JCm1s0 .btn-lXyK0I{width:58px;height:28px;background:#ffffff;border-radius:8px;border:1px solid #dddddd;font-size:13px;font-weight:400;color:#333;line-height:18px;margin-right:8px;cursor:pointer}.web-translation-top-bar-lHrWlL .close-setting-confirm-modal-pqTQ3z .footer-box-JCm1s0 .btn-lXyK0I:hover{border:1px solid #cacaca;background:#ffffff;color:#2e2e2e}.translate-model-popover-yPVL3i{position:relative;width:205px;background:#ffffff;box-shadow:0 2px 16px #5d5d5d26;border-radius:10px}.translate-model-popover-yPVL3i .translate-model-popover-item-gHNulz{display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;padding:12px 0 12px 24px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;gap:10px}.translate-model-popover-yPVL3i .translate-model-popover-item-gHNulz.active-V83EDi .name-NE2Mbp{color:#6165f7}.translate-model-popover-yPVL3i .translate-model-popover-item-gHNulz:hover{background:#f5f5f5}.translate-model-popover-yPVL3i .translate-model-popover-item-gHNulz .name-NE2Mbp{font-family:PingFangSC,PingFang SC;font-weight:500;font-size:14px;color:#1c1e22;text-align:left;font-style:normal;line-height:normal}.translate-model-popover-yPVL3i .translate-model-popover-item-gHNulz .icon-T-JX46{width:37px}.loading-dot--Rwits{display:inline-block}.loading-dot--Rwits .dot-Phoa6-{color:#000;display:inline-block;margin-left:3px}.loading-dot--Rwits .dot-Phoa6-.small-2Nu7SD{width:1px;height:1px}.loading-dot--Rwits .dot-Phoa6-.normal-PCo2aD{font-size:12px}.loading-dot--Rwits .dot-Phoa6-.large-TWDAgj{font-size:16px}.loading-dot--Rwits .dot-Phoa6-:nth-child(1){animation:1s ease-in-out 0s infinite jump-kpIUFO}.loading-dot--Rwits .dot-Phoa6-:nth-child(2){animation:1s ease-in-out .25s infinite jump-kpIUFO}.loading-dot--Rwits .dot-Phoa6-:nth-child(3){animation:1s ease-in-out .5s infinite jump-kpIUFO}@keyframes jump-kpIUFO{0%{transform:translateY(0)}50%{transform:translateY(3px)}to{transform:translateY(0)}}.cropper-LG8iI8{position:fixed;left:0;top:0;width:100%;height:100%;overflow:hidden;z-index:2147483646}.cropper-LG8iI8 *{box-sizing:content-box}.cropper-LG8iI8.is-dragged-QtkAT8{background:none;cursor:default}.cropper-LG8iI8.moving-mDcRFX .modifiers-wrap-6SRV9j,.cropper-LG8iI8.moving-mDcRFX .dragline-eO7Mb-{cursor:-webkit-grabbing}.cropper-LG8iI8 .cover-6kC7QB{position:absolute;background:rgba(0,0,0,.5);display:block}.cropper-LG8iI8 .cover-6kC7QB.top-YK9Z26{top:0;left:0;width:100%}.cropper-LG8iI8 .cover-6kC7QB.bottom-sEqDQS{bottom:0;left:0;width:100%;height:100%}.cropper-LG8iI8 .cover-6kC7QB.left-OA80tI{left:0}.cropper-LG8iI8 .cover-6kC7QB.right-Q6-F6w{right:0}.cropper-LG8iI8 .visible-section-L33uJX{position:absolute}.cropper-LG8iI8 .visible-section-L33uJX .modifiers-wrap-6SRV9j{position:absolute;left:0;top:0;width:100%;height:100%;cursor:move}.cropper-LG8iI8 .border-e9WQka{opacity:.5;font-size:0px;background-color:#6165f7;background-image:url(data:image/gif;base64,R0lGODlhCAAIAJEAAKqqqv///wAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh+QQJCgAAACwAAAAACAAIAAACDZQFCadrzVRMB9FZ5SwAIfkECQoAAAAsAAAAAAgACAAAAg+ELqCYaudeW9ChyOyltQAAIfkECQoAAAAsAAAAAAgACAAAAg8EhGKXm+rQYtC0WGl9oAAAIfkECQoAAAAsAAAAAAgACAAAAg+EhWKQernaYmjCWLF7qAAAIfkECQoAAAAsAAAAAAgACAAAAg2EISmna81UTAfRWeUsACH5BAkKAAAALAAAAAAIAAgAAAIPFA6imGrnXlvQocjspbUAACH5BAkKAAAALAAAAAAIAAgAAAIPlIBgl5vq0GLQtFhpfaIAACH5BAUKAAAALAAAAAAIAAgAAAIPlIFgknq52mJowlixe6gAADs=);position:absolute;width:1px;height:1px;display:block}.cropper-LG8iI8 .dragline-eO7Mb-{width:16px;height:16px;display:block;position:absolute;cursor:-webkit-grab}.cropper-LG8iI8 .dragline-eO7Mb-.top-YK9Z26{margin-top:-8px;cursor:ns-resize}.cropper-LG8iI8 .dragline-eO7Mb-.left-OA80tI{margin-left:-8px;cursor:ew-resize}.cropper-LG8iI8 .dragline-eO7Mb-.right-Q6-F6w{margin-right:-8px;cursor:ew-resize}.cropper-LG8iI8 .dragline-eO7Mb-.bottom-sEqDQS{margin-bottom:-8px;cursor:ns-resize}.cropper-LG8iI8 .border-e9WQka.left-OA80tI,.cropper-LG8iI8 .dragline-eO7Mb-.left-OA80tI{left:0;top:0;height:100%}.cropper-LG8iI8 .border-e9WQka.right-Q6-F6w,.cropper-LG8iI8 .dragline-eO7Mb-.right-Q6-F6w{right:0;top:0;height:100%}.cropper-LG8iI8 .border-e9WQka.top-YK9Z26,.cropper-LG8iI8 .dragline-eO7Mb-.top-YK9Z26{top:0;left:0;width:100%}.cropper-LG8iI8 .border-e9WQka.bottom-sEqDQS,.cropper-LG8iI8 .dragline-eO7Mb-.bottom-sEqDQS{bottom:0;left:0;width:100%}.cropper-LG8iI8 .tips-panel-Gr2lzF{width:195px}.cropper-LG8iI8 .size-panel-8Uh0Ap{min-width:110px}.cropper-LG8iI8 .dragdot-f6twWN{width:10px;height:10px;position:absolute;display:block;border-radius:10px;border:1px solid white;background:#6165f7;transition:all .1s ease-out}.cropper-LG8iI8 .dragdot-f6twWN:hover{transform:scale(1.4)}.cropper-LG8iI8 .dragdot-f6twWN.top-YK9Z26{left:50%;top:0;margin-left:-5px;margin-top:-5px}.cropper-LG8iI8 .dragdot-f6twWN.left-OA80tI{left:0;top:50%;margin-top:-5px;margin-left:-5px}.cropper-LG8iI8 .dragdot-f6twWN.right-Q6-F6w{right:0;top:50%;margin-top:-5px;margin-right:-5px}.cropper-LG8iI8 .dragdot-f6twWN.bottom-sEqDQS{left:50%;bottom:0;margin-left:-5px;margin-bottom:-5px}.cropper-LG8iI8 .dragdot-f6twWN.top-left-bWVC-a{left:0;top:0;margin-left:-5px;margin-top:-5px;cursor:nwse-resize}.cropper-LG8iI8 .dragdot-f6twWN.top-right-FpP8wX{right:0;top:0;margin-right:-5px;margin-top:-5px;cursor:nesw-resize}.cropper-LG8iI8 .dragdot-f6twWN.bottom-left-TQPvM1{left:0;bottom:0;margin-left:-5px;margin-bottom:-5px;cursor:nesw-resize}.cropper-LG8iI8 .dragdot-f6twWN.bottom-right-vkpRco{right:0;bottom:0;margin-right:-5px;margin-bottom:-5px;cursor:nwse-resize}.screenshotTranslate-JCg-62 .footer-94HdXl{z-index:2;position:fixed;padding:0 16px 0 10px;height:40px;background:#FFFFFF;border-radius:8px;gap:0!important;box-shadow:0 2px 8px #00000026}.screenshotTranslate-JCg-62 .footer-94HdXl .translate-btn-YA1YDg{display:flex;flex-direction:row;justify-content:center;align-items:center;color:#6165f7;padding-right:0}.screenshotTranslate-JCg-62 .footer-94HdXl .translate-btn-YA1YDg:hover{color:#595de3}.screenshotTranslate-JCg-62 .footer-94HdXl .translate-btn-YA1YDg .icon-BVqN1B{width:18px;height:18px}.screenshotTranslate-JCg-62 .translate-modal-0mIbaO{width:1200px!important}.screenshotTranslate-JCg-62 .translate-modal-0mIbaO .ant-modal-content{height:750px;overflow:hidden}@media (max-height: 850px){.screenshotTranslate-JCg-62 .translate-modal-0mIbaO .ant-modal-content{height:calc(100vh - 100px)}}.screenshotTranslate-JCg-62 .translate-modal-0mIbaO .ant-modal-content>.ant-modal-body{height:calc(100% - 64px)}.screenshotTranslate-JCg-62 .translate-modal-0mIbaO .ant-modal-content>.ant-modal-body>div{height:100%}.screenshotTranslate-JCg-62 .translate-modal-0mIbaO .ant-modal-content>.ant-modal-body>div .ant-spin-nested-loading,.screenshotTranslate-JCg-62 .translate-modal-0mIbaO .ant-modal-content>.ant-modal-body>div .ant-spin-container{height:100%}.screenshotTranslate-JCg-62 .translate-modal-0mIbaO .header-DD9a3T{margin-bottom:16px;color:#1c1e22;font-size:14px}.screenshotTranslate-JCg-62 .translate-modal-0mIbaO .header-DD9a3T .buy-btn-rZbI-9{color:#6165f7}.screenshotTranslate-JCg-62 .translate-modal-0mIbaO .header-DD9a3T .buy-btn-rZbI-9:hover{color:#595de3}.screenshotTranslate-JCg-62 .translate-modal-0mIbaO .language-oMf2ym{height:44px;background:#F7F9FA;border-radius:6px;border:1px solid #FCFDFD}.screenshotTranslate-JCg-62 .translate-modal-0mIbaO .language-oMf2ym .language-item-U9Vvrj{display:flex;align-items:center;justify-content:space-between;gap:4px;padding:0 10px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.screenshotTranslate-JCg-62 .translate-modal-0mIbaO .language-oMf2ym .language-item-U9Vvrj .name-NI8Bs1{font-size:14px;color:#1c1e22;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;word-break:break-all}.screenshotTranslate-JCg-62 .translate-modal-0mIbaO .language-oMf2ym .language-item-U9Vvrj .arrow-DJ-zPb{font-size:12px;color:#00000040}.screenshotTranslate-JCg-62 .translate-modal-0mIbaO .language-oMf2ym .switch-icon-4TYyzX{margin:0 10px;width:10px;height:10px}.screenshotTranslate-JCg-62 .translate-modal-0mIbaO .btn-EgrtEr{min-width:120px;display:flex;flex-direction:row;justify-content:center;align-items:center;margin-inline-start:16px!important;height:40px;line-height:40px}.screenshotTranslate-JCg-62 .translate-modal-0mIbaO .btn-EgrtEr .icon-BVqN1B{width:16px;height:16px}.screenshotTranslate-JCg-62 .translate-modal-0mIbaO .btn-EgrtEr:hover{background:#FDFDFF;border:1px solid #D6D6D6;color:#333}.screenshotTranslate-JCg-62 .translate-modal-0mIbaO .btn-EgrtEr.primary-jfOF12:hover{background:#595DE3;border:1px solid #595DE3;color:#fff}.screenshotTranslate-JCg-62 .translate-modal-0mIbaO .result-box-RR--vd{background:#F7F9FA;border-radius:8px;padding:20px}.screenshotTranslate-JCg-62 .translate-modal-0mIbaO .img-box-6toM3h,.screenshotTranslate-JCg-62 .translate-modal-0mIbaO .result-box-RR--vd{display:flex;justify-content:center;align-items:center;flex-direction:column}.screenshotTranslate-JCg-62 .ant-modal-footer{margin-top:24px;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-end}.tooltip-YzL82R{font-weight:400;font-size:13px;z-index:1001}.settings-row-item-JrRzvW{display:flex;flex-direction:row;justify-content:center;align-items:center;width:100%;height:44px;padding-left:16px;justify-content:flex-start;background:#f7f9fa;border-radius:10px;margin-bottom:10px}.settings-row-item-JrRzvW:last-child{margin-bottom:0}.settings-row-item-JrRzvW .icon-CgNk2P{width:16px;height:16px}.settings-row-item-JrRzvW .label-PpIJ8x{margin-left:6px;font-size:13px;font-weight:400;color:#666;display:flex;align-items:center}.settings-row-item-JrRzvW .children-6V3EE8{flex:1;height:100%}.settings-row-item-JrRzvW .children-6V3EE8 .huiyi-select{height:100%}.settings-row-item-JrRzvW .children-6V3EE8 .ant-select-selector{height:100%!important;padding:0!important;border:none!important;background:transparent!important}.settings-row-item-JrRzvW .children-6V3EE8 .ant-select-selection-item,.settings-row-item-JrRzvW .children-6V3EE8 .ant-select-selection-item *{text-align:left;text-indent:6px;font-size:13px;font-weight:400;color:#1c1e22;line-height:normal!important}.url-settings-confirm-modal-gcxRP2{width:324px;background:#FFFFFF;box-shadow:0 5px 32px 2px #0000001f;border-radius:20px;border:1px solid #EFEFF0;position:relative;padding:24px 28px}.url-settings-confirm-modal-gcxRP2 .close-w7U3UK{position:absolute;user-select:none;cursor:pointer;right:18px;top:18px;width:20px;height:20px;padding:2px}.url-settings-confirm-modal-gcxRP2 .title-0hEXjW{display:flex;align-items:center;margin-bottom:10px}.url-settings-confirm-modal-gcxRP2 .title-0hEXjW .bell-icon-OId0yT{width:16px;margin-right:4px}.url-settings-confirm-modal-gcxRP2 .title-0hEXjW span{font-size:14px;font-weight:600;color:#2c2c2c}.url-settings-confirm-modal-gcxRP2 .desc-SLlUQ-{font-size:13px;font-family:PingFangSC-Regular,PingFang SC;font-weight:400;color:#666;line-height:18px}.url-settings-confirm-modal-gcxRP2 .url-list-FUDE0m{width:100%;background:#F7F9FA;border-radius:10px;padding:12px 16px;margin-top:8px}.url-settings-confirm-modal-gcxRP2 .url-list-FUDE0m>div{word-break:break-all}.url-settings-confirm-modal-gcxRP2 .footer-box-9ser-5{display:flex;align-items:center;justify-content:flex-end;margin-top:20px}.url-settings-confirm-modal-gcxRP2 .footer-box-9ser-5 .btn-7SNWlP{width:76px;height:36px;background:#FFFFFF;border-radius:8px;border:1px solid #DDDDDD;font-size:14px;font-family:PingFangSC-Regular,PingFang SC;font-weight:400;color:#333;line-height:20px;margin-left:16px;cursor:pointer}.url-settings-confirm-modal-gcxRP2 .footer-box-9ser-5 .btn-7SNWlP:hover{border:1px solid #CACACA;background:#FFFFFF;color:#2e2e2e}.url-settings-confirm-modal-gcxRP2 .footer-box-9ser-5 .btn-7SNWlP.confirm-btn-VgOAz5{background:#6165f7;border:none;color:#fff}.url-settings-confirm-modal-gcxRP2 .footer-box-9ser-5 .btn-7SNWlP.confirm-btn-VgOAz5:hover{background:#595DE3;border:1px solid #595DE3;color:#fff}.video-summary-content-hmtvgp{background:linear-gradient(180deg,#f5eeff 0%,#f7f2ff 100%);border-radius:12px;border:1px solid #f7f0ff;padding:14px 0;margin-bottom:10px}.video-summary-content-hmtvgp .plr-NiHndF{padding-left:14px;padding-right:14px}.video-summary-content-hmtvgp .header-S-cuy0{display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start}.video-summary-content-hmtvgp .header-S-cuy0 .logo--QxxOb{width:24px;height:18px}.video-summary-content-hmtvgp .header-S-cuy0 .logo-name-s-49cw{margin-top:2px;margin-left:6px;width:30px;height:16px}.video-summary-content-hmtvgp .header-S-cuy0 .summaryBtn-68-MNm{width:150px;height:30px;background:linear-gradient(303deg,#cd8fff 0%,#9f56ff 100%);border-radius:8px;display:flex;flex-direction:row;justify-content:center;align-items:center;gap:2px;margin-left:20px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.video-summary-content-hmtvgp .header-S-cuy0 .summaryBtn-68-MNm:hover{opacity:.9}.video-summary-content-hmtvgp .header-S-cuy0 .summaryBtn-68-MNm .stars-EgXPxF{width:17px;height:16px}.video-summary-content-hmtvgp .header-S-cuy0 .summaryBtn-68-MNm .text-zxX-Gs{width:95px;height:14px}.video-summary-content-hmtvgp .header-S-cuy0 .right-xhEf1y{margin-left:auto;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;gap:24px}.video-summary-content-hmtvgp .header-S-cuy0 .right-xhEf1y .setting-v6k-r5{cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;width:15px;height:15px}.video-summary-content-hmtvgp .header-S-cuy0 .right-xhEf1y .setting-v6k-r5:hover{opacity:.9}.video-summary-content-hmtvgp .header-S-cuy0 .right-xhEf1y .tool-F9KGY-{padding:6px 11px;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;background:linear-gradient(333deg,#f3efff 0%,#f7f4ff 100%);border-radius:16px;border:1px solid #ffffff;line-height:normal}.video-summary-content-hmtvgp .header-S-cuy0 .right-xhEf1y .tool-F9KGY- .line-Tn-muG{width:1px;height:14px;opacity:.64;background-color:#e2e2e2;margin:0 8px}.video-summary-content-hmtvgp .header-S-cuy0 .right-xhEf1y .tool-F9KGY- .btn-BhXhK8{display:flex;flex-direction:row;justify-content:center;align-items:center;gap:2px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.video-summary-content-hmtvgp .header-S-cuy0 .right-xhEf1y .tool-F9KGY- .btn-BhXhK8:hover{opacity:.9}.video-summary-content-hmtvgp .header-S-cuy0 .right-xhEf1y .tool-F9KGY- .btn-BhXhK8 .text-zxX-Gs{font-size:13px;font-family:PingFangSC,PingFang SC;font-weight:400;color:#8c5ad7eb}.video-summary-content-hmtvgp .header-S-cuy0 .right-xhEf1y .tool-F9KGY- .btn-BhXhK8 .icon-7lMTRy{width:16px;height:16px}.video-summary-content-hmtvgp .header-S-cuy0 .right-xhEf1y .collapse-3h7MWq{cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;width:14px;height:11px}.video-summary-content-hmtvgp .header-S-cuy0 .right-xhEf1y .collapse-3h7MWq:hover{opacity:.9}.video-summary-content-hmtvgp .content-RCNHdY{margin-top:18px;padding-top:18px;border-top:1px solid rgba(191,186,219,.18);display:none}.video-summary-content-hmtvgp .content-RCNHdY.open-Mwj1U6{display:block}.video-summary-content-hmtvgp .content-RCNHdY .loading-wrap-VRyZ3e{padding-top:69px;padding-bottom:280px;text-align:center;font-size:14px;font-family:PingFangSC,PingFang SC;font-weight:400;color:#666}.video-summary-content-hmtvgp .content-RCNHdY .loading-wrap-VRyZ3e .dots-2vPJy-{display:inline-block;width:11px;text-align:left}.video-summary-content-hmtvgp .content-RCNHdY .summary-iif6U3 .toolbar-mkFc9R{margin-bottom:28px;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:space-between}.video-summary-content-hmtvgp .content-RCNHdY .summary-iif6U3 .toolbar-mkFc9R .text-zxX-Gs{font-size:16px;font-family:PingFangSC,PingFang SC;font-weight:600;color:#000000d9}.video-summary-content-hmtvgp .content-RCNHdY .summary-iif6U3 .card-wrap-FgjWqG{max-height:500px;overflow-y:auto!important;overscroll-behavior:contain;scrollbar-width:thin;scrollbar-color:#0000002f transparent}.video-summary-content-hmtvgp .content-RCNHdY .summary-iif6U3 .card-wrap-FgjWqG::-webkit-scrollbar{height:6px;width:3px;margin-right:10px}.video-summary-content-hmtvgp .content-RCNHdY .summary-iif6U3 .card-wrap-FgjWqG::-webkit-scrollbar-track{background:transparent}.video-summary-content-hmtvgp .content-RCNHdY .summary-iif6U3 .card-wrap-FgjWqG::-webkit-scrollbar-thumb{background:#0000002f;border-radius:4px;cursor:default}.video-summary-content-hmtvgp .content-RCNHdY .summary-iif6U3 .card-wrap-FgjWqG::-webkit-scrollbar-thumb:hover{background:#00000062}.video-summary-content-hmtvgp .content-RCNHdY .summary-iif6U3 .card-wrap-FgjWqG .card-tYOefL .title-anC4L-{display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:space-between}.video-summary-content-hmtvgp .content-RCNHdY .summary-iif6U3 .card-wrap-FgjWqG .card-tYOefL .title-anC4L- .name-d0g6bc{display:flex;flex-direction:row;justify-content:center;align-items:center;gap:6px}.video-summary-content-hmtvgp .content-RCNHdY .summary-iif6U3 .card-wrap-FgjWqG .card-tYOefL .title-anC4L- .name-d0g6bc .icon-7lMTRy{width:14px;height:16px}.video-summary-content-hmtvgp .content-RCNHdY .summary-iif6U3 .card-wrap-FgjWqG .card-tYOefL .title-anC4L- .name-d0g6bc .text-zxX-Gs{font-size:15px;font-family:PingFangSC,PingFang SC;font-weight:600;color:#645d81}.video-summary-content-hmtvgp .content-RCNHdY .summary-iif6U3 .card-wrap-FgjWqG .card-tYOefL .title-anC4L- .right-xhEf1y .btn-BhXhK8{cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;display:flex;flex-direction:row;justify-content:center;align-items:center;gap:2px}.video-summary-content-hmtvgp .content-RCNHdY .summary-iif6U3 .card-wrap-FgjWqG .card-tYOefL .title-anC4L- .right-xhEf1y .btn-BhXhK8 .text-zxX-Gs{font-size:13px;font-family:PingFangSC,PingFang SC;font-weight:400;color:#403d8073;line-height:0px}.video-summary-content-hmtvgp .content-RCNHdY .summary-iif6U3 .card-wrap-FgjWqG .card-tYOefL .title-anC4L- .right-xhEf1y .btn-BhXhK8 .icon-7lMTRy{width:13px;height:13px}.video-summary-content-hmtvgp .content-RCNHdY .summary-iif6U3 .card-wrap-FgjWqG .card-tYOefL .content-text-wZBrrJ{margin-top:11px;padding:12px 16px;background:#ffffff;box-shadow:0 2px 21px #9747f61a;border-radius:8px;opacity:.85;border:1px solid #f8f4ff;font-size:14px;font-family:PingFangSC,PingFang SC;font-weight:400;color:#4b417f;line-height:24px;white-space:pre-wrap}.video-summary-content-hmtvgp .content-RCNHdY .token-wrap-tPXZST{padding-top:75px;padding-bottom:63px;display:flex;justify-content:center;align-items:center;flex-direction:column}.video-summary-content-hmtvgp .content-RCNHdY .token-wrap-tPXZST .token-icon-HsGqi1{width:162px;height:109px}.video-summary-content-hmtvgp .content-RCNHdY .token-wrap-tPXZST .no-token-C79JQN{margin-top:41px;font-size:15px;font-family:PingFangSC,PingFang SC;font-weight:600;color:#000000d9}.video-summary-content-hmtvgp .content-RCNHdY .token-wrap-tPXZST .text-zxX-Gs{margin-top:5px;font-size:14px;font-family:PingFangSC,PingFang SC;font-weight:400;color:#666}.video-summary-content-hmtvgp .content-RCNHdY .token-wrap-tPXZST .btn-BhXhK8{display:flex;flex-direction:row;justify-content:center;align-items:center;margin-top:25px;width:100px;height:32px;background:linear-gradient(117deg,#b358ff 0%,#8f44ff 100%);border-radius:8px;font-size:14px;font-family:PingFangSC,PingFang SC;font-weight:400;color:#fff;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.video-summary-content-hmtvgp .content-RCNHdY .token-wrap-tPXZST .btn-BhXhK8:hover{opacity:.9}.video-summary-content-hmtvgp .content-RCNHdY .login-wrap-ziTT-A{padding-top:80px;padding-bottom:129px;display:flex;justify-content:center;align-items:center;flex-direction:column}.video-summary-content-hmtvgp .content-RCNHdY .login-wrap-ziTT-A .icon-7lMTRy{width:205px;height:146px}.video-summary-content-hmtvgp .content-RCNHdY .login-wrap-ziTT-A .btn-BhXhK8{display:flex;flex-direction:row;justify-content:center;align-items:center;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;width:114px;height:32px;background:linear-gradient(117deg,#b358ff 0%,#8f44ff 100%);border-radius:8px;font-size:14px;font-family:PingFangSC,PingFang SC;font-weight:400;color:#fff}.video-summary-content-hmtvgp .content-RCNHdY .login-wrap-ziTT-A .btn-BhXhK8:hover{opacity:.9}.video-summary-content-hmtvgp .content-RCNHdY .caption-wrap-cirjB-{padding-top:80px;padding-bottom:125px;display:flex;justify-content:center;align-items:center;flex-direction:column}.video-summary-content-hmtvgp .content-RCNHdY .caption-wrap-cirjB- .icon-7lMTRy{width:169px;height:121px}.video-summary-content-hmtvgp .content-RCNHdY .caption-wrap-cirjB- .text-zxX-Gs{margin-top:24px;text-align:center;width:234px;height:44px;font-size:14px;font-family:PingFangSC,PingFang SC;font-weight:400;color:#666}.video-summary-content-hmtvgp .loading-line-hN8Ni5{-webkit-animation:blink-aR9Rqk 1s steps(5,start) infinite;animation:blink-aR9Rqk 1s steps(5,start) infinite;vertical-align:baseline;opacity:.6;position:relative;top:-2px}@keyframes blink-aR9Rqk{to{visibility:hidden}}.focus-vgZP1N{width:100%;background:#ffffff;box-shadow:0 2px 20px #0000001a;border-radius:16px;overflow:hidden;display:block;color:#222;text-align:left;padding-bottom:12px;display:flex;flex-direction:column}.focus-vgZP1N .head-4DO9lP{display:flex;align-items:center;justify-content:space-between;padding:7px 10px 7px 20px;border-bottom:1px solid #f8f8f8;background-color:#f6f7ff;height:40px}.focus-vgZP1N .head-4DO9lP .brand-icon-dBeuFZ{width:56px;height:16px}.focus-vgZP1N .head-4DO9lP .right-bzMrGD{display:flex;align-items:center;justify-content:end}.focus-vgZP1N .head-4DO9lP .right-bzMrGD .tool-XQZguo{display:flex;align-items:center;padding:5px 7px;background:rgba(255,255,255,.65);border-radius:13px;border:1px solid #ffffff;margin-right:12px;height:26px}.focus-vgZP1N .head-4DO9lP .right-bzMrGD .tool-XQZguo .line-AgG6Xh{margin:0 8px;width:1px;height:11px;background:#e4e4e4}.focus-vgZP1N .head-4DO9lP .right-bzMrGD .tool-XQZguo .icon-weH6Hz{width:16px;height:16px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.focus-vgZP1N .head-4DO9lP .right-bzMrGD .close-icon-i15pSf{width:14px;height:14px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.focus-vgZP1N .switch-tab-s-rZ8M{padding-top:12px;display:flex;align-items:center}.focus-vgZP1N .switch-tab-s-rZ8M .tab-t2x8Rx{font-size:13px;font-weight:400;color:#555;display:flex;background:#f8f8f8;border:1px solid #f8f8f8;border-radius:8px;padding:5px 10px;margin-right:8px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.focus-vgZP1N .switch-tab-s-rZ8M .tab-t2x8Rx.active-5QwYjk{color:#fff;background:#f4f0ff;border:1px solid #e6deff;font-weight:600;color:#333}.focus-vgZP1N .switch-tab-s-rZ8M .tab-t2x8Rx>img{width:20px;height:20px;margin-right:4px}.focus-vgZP1N .summary-VkJ-y2{margin-left:20px;padding-right:20px;overflow-y:scroll;scroll-behavior:smooth;overflow-y:auto!important;overscroll-behavior:contain;scrollbar-width:thin;scrollbar-color:#0000002f transparent}.focus-vgZP1N .summary-VkJ-y2::-webkit-scrollbar{height:6px;width:2px;margin-right:10px}.focus-vgZP1N .summary-VkJ-y2::-webkit-scrollbar-track{background:transparent}.focus-vgZP1N .summary-VkJ-y2::-webkit-scrollbar-thumb{background:#0000002f;border-radius:4px;cursor:default}.focus-vgZP1N .summary-VkJ-y2::-webkit-scrollbar-thumb:hover{background:#00000062}.focus-vgZP1N .summary-VkJ-y2 .summary-inner-4BWIl-{margin-top:12px;font-size:14px;font-weight:400;color:#000;line-height:22px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;overflow:hidden}.focus-vgZP1N .result-U4mZWN{border-top:1px dashed #f2f2f2;margin-top:16px;margin-left:24px;margin-right:24px;padding-top:12px}.focus-vgZP1N .result-U4mZWN .result-title-8jkXbY{display:flex;align-items:center;font-size:13px;font-weight:400;color:#666;line-height:20px}.focus-vgZP1N .result-U4mZWN .result-title-8jkXbY .search-icon-7rLibZ{width:14px;height:14px;margin-right:3px}.focus-vgZP1N .result-U4mZWN .result-item-list-CqHBZq{margin-top:6px;margin-bottom:12px;display:flex;flex-wrap:wrap}.focus-vgZP1N .result-U4mZWN .result-item-list-CqHBZq .result-item-Pzu8NY{width:228px;padding:10px 16px;background:#f7f9fa;border-radius:8px;position:relative;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;margin-left:11px;margin-top:8px}.focus-vgZP1N .result-U4mZWN .result-item-list-CqHBZq .result-item-Pzu8NY:hover{box-shadow:0 2px 6px #0000000f}.focus-vgZP1N .result-U4mZWN .result-item-list-CqHBZq .result-item-Pzu8NY:nth-child(1),.focus-vgZP1N .result-U4mZWN .result-item-list-CqHBZq .result-item-Pzu8NY:nth-child(2){margin-top:0}.focus-vgZP1N .result-U4mZWN .result-item-list-CqHBZq .result-item-Pzu8NY:nth-child(2n + 1){margin-left:0}.focus-vgZP1N .result-U4mZWN .result-item-list-CqHBZq .result-item-Pzu8NY:before{position:absolute;display:flex;align-items:center;justify-content:center;content:attr(data-rank);left:0;top:0;z-index:1;width:18px;height:14px;background:#e6eaf7;border-radius:8px 0;border:1px solid #ffffff;font-size:12px;font-weight:400;color:#777;line-height:17px}.focus-vgZP1N .result-U4mZWN .result-item-list-CqHBZq .result-item-title-e3RKFB{width:100%;overflow:hidden;text-overflow:ellipsis;font-size:14px;font-weight:400;color:#333;line-height:20px;word-break:keep-all;white-space:nowrap}.focus-vgZP1N .result-U4mZWN .result-item-list-CqHBZq .result-item-source-sotQCo{margin-top:4px;font-size:12px;font-weight:400;color:#999;line-height:17px;display:flex;align-items:center}.focus-vgZP1N .result-U4mZWN .result-item-list-CqHBZq .result-item-source-sotQCo>img{width:11px;height:11px;border-radius:50%;margin-left:8px}.focus-vgZP1N .result-U4mZWN .result-item-list-CqHBZq .result-item-source-sotQCo>.empty-icon-VOETak{width:11px;height:11px;border-radius:50%;margin-right:7px;display:inline-block;background-color:#e6e6e6}.focus-vgZP1N .result-U4mZWN .result-item-list-CqHBZq .result-item-source-sotQCo .source-url-A3spsX{flex:1;overflow:hidden;text-overflow:ellipsis;word-break:keep-all;white-space:nowrap}.sidebar-btn-BAbyws{position:fixed;z-index:2147483646;display:flex;justify-content:center;align-items:center;flex-direction:column;right:-19px;left:unset;transition:left .2s ease-in-out,right .2s ease-in-out,transform .2s ease-in-out;padding-top:20px}.sidebar-btn-BAbyws.hover-show-E9wsMI:not(.expand-s7tAsS){transform:translate(36px)}.sidebar-btn-BAbyws.hover-show-E9wsMI:not(.expand-s7tAsS).hover-show-active-iFhenA{transform:translate(0)}.sidebar-btn-BAbyws.btn-rotate-0YTZiA>.sidebar-content-HRClxM .entry-btn-dboHMJ{padding-left:4px}.sidebar-btn-BAbyws.btn-rotate-0YTZiA>.sidebar-content-HRClxM .entry-btn-dboHMJ .logo-B7vGN7{user-select:none;transform:rotate(-90deg)}.sidebar-btn-BAbyws.btn-rotate-0YTZiA.expand-s7tAsS>.sidebar-content-HRClxM .entry-btn-dboHMJ .logo-B7vGN7{transform:unset}.sidebar-btn-BAbyws.near-left-iWFPNd{left:-38px;right:unset}.sidebar-btn-BAbyws.near-left-iWFPNd .tool-list-5Wpfev{left:8px;right:unset}.sidebar-btn-BAbyws.near-left-iWFPNd>.sidebar-content-HRClxM .entry-btn-dboHMJ{border-radius:0 29px 29px 0;border-left:none}.sidebar-btn-BAbyws.near-left-iWFPNd .settings-panel-BVl1wS{right:unset;left:56px}.sidebar-btn-BAbyws.near-bottom-2DPO7K{flex-direction:column-reverse}.sidebar-btn-BAbyws.near-bottom-2DPO7K>.sidebar-content-HRClxM .tool-list-5Wpfev{flex-direction:column-reverse;top:unset;bottom:58px}.sidebar-btn-BAbyws.near-bottom-2DPO7K>.sidebar-content-HRClxM .tool-list-5Wpfev .tool-item-23-jbD{margin-top:12px}.sidebar-btn-BAbyws.near-bottom-2DPO7K>.sidebar-content-HRClxM .tool-list-5Wpfev .summary-setting-AczllN{margin-top:unset}.sidebar-btn-BAbyws.near-bottom-2DPO7K .confirm-box-zhMbNj,.sidebar-btn-BAbyws.near-bottom-2DPO7K .close-setting-confirm-modal-xxLWRP{top:unset;bottom:0}.sidebar-btn-BAbyws.expand-s7tAsS{right:0}.sidebar-btn-BAbyws.expand-s7tAsS>.sidebar-content-HRClxM .entry-btn-dboHMJ{padding-left:16px}.sidebar-btn-BAbyws.expand-s7tAsS.near-left-iWFPNd{left:0;right:unset}.sidebar-btn-BAbyws.with-screenshot-juIrXC{transform:none!important;right:-58px!important}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .entry-btn-dboHMJ{cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;height:38px;padding:0 16px 0 6px;border-right:none;display:flex;flex-direction:row;justify-content:center;align-items:center;transition:all .2s ease-in-out;background:#ffffff;box-shadow:0 4px 26px 2px #33333329;border-radius:29px 0 0 29px;border:1px solid #ffffff}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .entry-btn-dboHMJ .logo-B7vGN7{width:30px;object-fit:cover;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;transition:all .2s ease-in-out}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .entry-btn-dboHMJ .close-ywC13y{display:none;width:46px;position:absolute;padding:6px 4px 6px 26px;top:-4px;right:0}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .entry-btn-dboHMJ:hover .close-ywC13y{display:unset}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .tool-list-5Wpfev{justify-content:center;align-items:center;flex-direction:column;display:flex;position:absolute;right:8px;top:58px}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .tool-list-5Wpfev .tool-item-23-jbD{width:40px;height:40px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;position:relative;background:#ffffff;box-shadow:0 2px 19px 2px #33333314;border-radius:29px;margin-top:16px;display:none}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .tool-list-5Wpfev .tool-item-23-jbD.visibility-NW9ymd{display:block}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .tool-list-5Wpfev .tool-item-23-jbD:hover .icon-3onPpM{opacity:0}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .tool-list-5Wpfev .tool-item-23-jbD:hover .icon-hover-5mAT2F{opacity:1}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .tool-list-5Wpfev .tool-item-23-jbD .icon-3onPpM{width:100%;height:100%;object-fit:cover;transition:opacity .2s ease-in-out;left:0;top:0;position:absolute}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .tool-list-5Wpfev .tool-item-23-jbD .icon-hover-5mAT2F{opacity:0}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .tool-list-5Wpfev .summary-setting-AczllN{margin-top:16px;display:flex;justify-content:center;align-items:center;flex-direction:column;width:40px;padding:18px 0;box-shadow:0 2px 19px 2px #33333314;border-radius:29px;background-color:#fbfbfb;gap:18px;display:none;position:relative}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .tool-list-5Wpfev .summary-setting-AczllN:hover{background-color:#fff}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .tool-list-5Wpfev .summary-setting-AczllN.visibility-NW9ymd{display:flex}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .tool-list-5Wpfev .summary-setting-AczllN .icon-3onPpM{cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;width:20px;height:20px;opacity:.8}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .tool-list-5Wpfev .summary-setting-AczllN .icon-3onPpM:hover{opacity:1}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .tool-list-5Wpfev .summary-setting-AczllN .summary-tip-yk7ie8{user-select:none;position:absolute;left:-421px;top:-42px;width:461px;height:212px;z-index:-1}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .tool-list-5Wpfev .summary-setting-AczllN .summary-tip-yk7ie8 .bg-a4tnVw{position:absolute;width:100%;height:100%}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .tool-list-5Wpfev .summary-setting-AczllN .summary-tip-yk7ie8 .title-ZUz6x6{position:relative;z-index:1;display:flex;flex-direction:row;justify-content:center;align-items:center;top:65px;left:65px;justify-content:start}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .tool-list-5Wpfev .summary-setting-AczllN .summary-tip-yk7ie8 .title-ZUz6x6 .new-bepIxZ{display:flex;flex-direction:row;justify-content:center;align-items:center;width:41px;height:20px;background:linear-gradient(186deg,#ff8ee1 0%,#ff6cd8 100%);border-radius:5px;font-size:14px;font-family:AlibabaPuHuiTi_2_75_SemiBold;color:#fff}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .tool-list-5Wpfev .summary-setting-AczllN .summary-tip-yk7ie8 .title-ZUz6x6 .normal-S4AI4m{margin-left:8px;font-size:16px;font-family:PingFangSC,PingFang SC;font-weight:600;color:#000}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .tool-list-5Wpfev .summary-setting-AczllN .summary-tip-yk7ie8 .title-ZUz6x6 .focus-biyF2r{font-size:16px;font-family:PingFangSC,PingFang SC;font-weight:600;color:#ff6cd8}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .tool-list-5Wpfev .summary-setting-AczllN .summary-tip-yk7ie8 .desc-jEkGYy{width:310px;height:40px;font-size:14px;font-family:PingFangSC,PingFang SC;font-weight:400;color:#555;position:relative;z-index:1;left:64px;top:73px}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .tool-list-5Wpfev .summary-setting-AczllN .summary-tip-yk7ie8 .close-ywC13y{width:12px;height:12px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;position:absolute;z-index:1;right:70px;top:51px}.sidebar-btn-BAbyws>.sidebar-content-HRClxM .tool-list-5Wpfev .summary-setting-AczllN .summary-tip-yk7ie8 .close-ywC13y:hover{opacity:.9}.sidebar-btn-BAbyws>.settings-panel-BVl1wS{width:378px;background:#ffffff;box-shadow:0 5px 32px 2px #0000001f;border-radius:20px;border:1px solid #efeff0;position:absolute;right:68px}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .close-btn-vXvybq{width:22px;height:22px;position:absolute;right:-9px;top:-9px;cursor:pointer}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .auto-translate-2bivcZ{border-top-left-radius:20px;border-top-right-radius:20px;height:66px;padding:13px 24px 35px;background:linear-gradient(180deg,#ffffff 0%,#f7f9fa 100%)}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .auto-translate-2bivcZ .header-xoJQ3V{display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;font-size:13px;font-family:PingFangSC,PingFang SC;font-weight:400;color:#666;line-height:normal;gap:3px}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .auto-translate-2bivcZ .header-xoJQ3V .ant-switch.ant-switch-small{min-width:21px;height:12px;line-height:12px}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .auto-translate-2bivcZ .header-xoJQ3V .ant-switch.ant-switch-small .ant-switch-handle{width:8px;height:8px}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .auto-translate-2bivcZ .header-xoJQ3V .ant-switch.ant-switch-small.ant-switch-checked .ant-switch-handle{inset-inline-start:calc(100% - 11px)}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .auto-translate-2bivcZ .link-EFBd32{margin-top:4px;font-size:13px;font-family:PingFangSC,PingFang SC;font-weight:600;color:#333;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw{padding:20px 28px 24px}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw>.label-gpRAEK{display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:space-between}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw>.label-gpRAEK>div{display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;padding-left:4px}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw>.label-gpRAEK .icon-3onPpM{width:16px;height:16px}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw>.label-gpRAEK .text-RhWbvP{font-size:14px;font-weight:600;color:#2c2c2c;line-height:20px;margin-left:8px}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw>.label-gpRAEK .more-btn-U3ImIO{cursor:pointer;user-select:none;float:right;font-size:13px;font-weight:400;color:#666;line-height:18px}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw>.setting-list-cIyAHF{width:100%}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw>.setting-list-cIyAHF .language-item-N00ZGW{display:flex;align-items:center;justify-content:space-between;height:44px;padding-left:8px;padding-right:13px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw>.setting-list-cIyAHF .language-item-N00ZGW .name--Q9kbM{max-width:180px;font-size:13px;color:#1c1e22;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;word-break:break-all}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw>.setting-list-cIyAHF .language-item-N00ZGW .arrow-n1Ac-7{font-size:12px;color:#00000040}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw .card-wrap-RXgF1p{margin-top:20px;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:space-between}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw .card-wrap-RXgF1p .card-fTcT7H{cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;display:flex;justify-content:center;align-items:center;flex-direction:column;width:94px;height:86px;background:#ffffff;box-shadow:0 6px 32px 2px #3333330f;border-radius:10px;gap:4px}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw .card-wrap-RXgF1p .card-fTcT7H:hover{box-shadow:0 8px 36px 4px #33333314}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw .card-wrap-RXgF1p .card-fTcT7H:hover .text-RhWbvP{opacity:.9}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw .card-wrap-RXgF1p .card-fTcT7H .img-wrap--UrAL0{display:flex;justify-content:center;align-items:center;flex-direction:column;width:40px;height:40px;background:#f8f5ff;border-radius:36px;opacity:.95;border:1px solid #f7f3ff}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw .card-wrap-RXgF1p .card-fTcT7H .img-wrap--UrAL0 .icon-3onPpM{width:25px;height:25px}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw .card-wrap-RXgF1p .card-fTcT7H .text-RhWbvP{font-size:13px;font-family:PingFangSC,PingFang SC;font-weight:400;color:#1c1e22}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw .auto-translate-setting-Ay7-Kz{display:flex;justify-content:space-between;flex:1}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw>.contact-btn-zbqkN1{margin-top:18px;position:relative;display:flex;align-items:center;justify-content:space-between}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw>.contact-btn-zbqkN1 .item-WnfHC4{width:147px;height:60px;background:#ffffff;box-shadow:0 6px 32px 2px #3333330f;border-radius:10px;font-family:PingFangSC,PingFang SC;font-weight:400;font-size:13px;color:#1c1e22;font-style:normal;cursor:pointer;user-select:none;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;gap:13px;padding-left:16px}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw>.contact-btn-zbqkN1 .item-WnfHC4 .icon-wrap-CwcWSl{width:36px;height:36px;background:#f5f5ff;border-radius:36px;border:1px solid #f3f6ff;display:flex;flex-direction:row;justify-content:center;align-items:center}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw>.contact-btn-zbqkN1 .item-WnfHC4 .icon-wrap-CwcWSl .icon-3onPpM{width:25px;height:25px}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw>.contact-btn-zbqkN1>.content-box-flmt4H{width:262px;height:297px;background:linear-gradient(180deg,#ebeeff 0%,#ffffff 100%);box-shadow:0 3px 28px 2px #0000001f;border-radius:20px;border:1px solid #ffffff;display:flex;justify-content:center;align-items:center;flex-direction:column;position:absolute;bottom:60px;left:-25px;padding:24px 0 32px;z-index:1}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw>.contact-btn-zbqkN1>.content-box-flmt4H .title-ZUz6x6{font-size:16px;font-weight:600;color:#2c2c2c;line-height:22px}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw>.contact-btn-zbqkN1>.content-box-flmt4H .sub-title-EqT57u{margin-top:4px;font-size:13px;font-weight:400;color:#666;line-height:18px}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw>.contact-btn-zbqkN1>.content-box-flmt4H .qr-box-Kz8GWA{width:181px;height:179px;margin-top:16px;position:relative;display:flex;justify-content:center;align-items:center;flex-direction:column}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw>.contact-btn-zbqkN1>.content-box-flmt4H .qr-box-Kz8GWA .qr-bg-8TfRUL{position:absolute;width:181px;left:0;top:0}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .panel-wrap-2jvGBw>.contact-btn-zbqkN1>.content-box-flmt4H .qr-box-Kz8GWA .qr-code-7meIX8{width:173px;height:173px;object-fit:cover;position:relative;z-index:1}.sidebar-btn-BAbyws>.settings-panel-BVl1wS .close-setting-Hk8KoO{cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;width:22px;height:22px;position:absolute;right:-6px;top:-8px}.sidebar-btn-BAbyws .confirm-box-zhMbNj{position:absolute;top:0;right:71px}.sidebar-btn-BAbyws .wake-up-inactive-user-modal-ju4wAj{position:absolute;top:20px;right:71px}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP{width:386px;background:#ffffff;box-shadow:0 5px 32px 2px #0000001f;border-radius:20px;border:1px solid #efeff0;position:absolute;padding:24px 28px;top:0;right:71px;z-index:3}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP .close-ywC13y{position:absolute;user-select:none;cursor:pointer;right:18px;top:18px;width:20px;height:20px;padding:2px}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP .title-ZUz6x6{display:flex;align-items:center}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP .title-ZUz6x6 .bell-icon-NuCudi{width:16px;margin-right:4px}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP .title-ZUz6x6 span{font-size:14px;font-weight:600;color:#2c2c2c}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP .switch-box-K2-17l{padding-bottom:16px;border-bottom:1px dashed #f2f2f2;margin-bottom:16px}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP .switch-box-K2-17l .row-two-86BeWf{word-break:keep-all;position:relative}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP .switch-box-K2-17l .row-two-86BeWf .desc-jEkGYy,.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP .switch-box-K2-17l .row-two-86BeWf a{font-size:13px;font-family:PingFangSC,PingFang SC;font-weight:400;color:#999;line-height:18px;word-break:keep-all;white-space:nowrap}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP .switch-box-K2-17l .row-two-86BeWf a{margin-left:4px;color:#6165f7;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP .switch-box-K2-17l .row-two-86BeWf a:hover+.img-box-c2yCVW{display:flex}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP .switch-box-K2-17l .row-two-86BeWf .img-box-c2yCVW{width:526px;height:320px;background:#ffffff;box-shadow:0 4px 20px #8686861f;border-radius:12px;border:1px solid #ffffff;overflow:hidden;position:absolute;bottom:-324px;right:0;display:flex;flex-direction:row;justify-content:center;align-items:center;display:none}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP .switch-box-K2-17l .row-ESEQ0-{display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;position:relative}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP .switch-box-K2-17l .row-ESEQ0-:first-child{margin-bottom:4px}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP .switch-box-K2-17l .row-ESEQ0- .switch-desc-QN0VCF{font-size:14px;font-weight:400;color:#666;line-height:20px;margin-left:4px}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP .switch-box-K2-17l .row-ESEQ0- .label-gpRAEK{color:#333}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP>.content-2LzlnZ{margin-top:12px}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP>.content-2LzlnZ .box-38tphc{background:#f4f7f8;border-radius:10px}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP>.content-2LzlnZ .radio-box-29yGM6{margin-top:12px;padding:20px 16px}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP>.content-2LzlnZ .radio-box-29yGM6 .close-radio-item-ZXP1-A:not(:last-child){margin-bottom:16px}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP>.content-2LzlnZ .radio-box-29yGM6 .close-radio-item-ZXP1-A>span{display:flex;align-items:center}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP>.content-2LzlnZ .radio-box-29yGM6 .close-radio-item-ZXP1-A>span .desc-jEkGYy{font-size:13px;font-family:PingFangSC-Regular,PingFang SC;font-weight:400;color:#666;line-height:18px}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP>.content-2LzlnZ .radio-box-29yGM6 .close-radio-item-ZXP1-A>span .desc-jEkGYy a{color:#6165f7}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP .footer-box-ocZ-og{display:flex;align-items:center;justify-content:flex-start;margin-top:20px}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP .footer-box-ocZ-og .btn-TN8zFx{width:58px;height:28px;background:#ffffff;border-radius:8px;border:1px solid #dddddd;font-size:13px;font-weight:400;color:#333;line-height:18px;margin-right:8px;cursor:pointer}.sidebar-btn-BAbyws .close-setting-confirm-modal-xxLWRP .footer-box-ocZ-og .btn-TN8zFx:hover{border:1px solid #cacaca;background:#ffffff;color:#2e2e2e}.sidebar-btn-BAbyws>.web-summary-panel-MGLdKa{width:379px;height:364px;background:#ffffff;box-shadow:0 5px 32px 2px #0000001f;border-radius:20px;border:1px solid #efeff0;position:absolute;right:68px}.sidebar-btn-BAbyws>.web-summary-panel-MGLdKa .content-2LzlnZ{max-height:100%;overflow-y:auto!important;overscroll-behavior:contain;scrollbar-width:thin;scrollbar-color:#0000002f transparent;padding:24px 25px 45px;position:relative}.sidebar-btn-BAbyws>.web-summary-panel-MGLdKa .content-2LzlnZ::-webkit-scrollbar{height:6px;width:6px;margin-right:10px}.sidebar-btn-BAbyws>.web-summary-panel-MGLdKa .content-2LzlnZ::-webkit-scrollbar-track{background:transparent}.sidebar-btn-BAbyws>.web-summary-panel-MGLdKa .content-2LzlnZ::-webkit-scrollbar-thumb{background:#0000002f;border-radius:4px;cursor:default}.sidebar-btn-BAbyws>.web-summary-panel-MGLdKa .content-2LzlnZ::-webkit-scrollbar-thumb:hover{background:#00000062}.sidebar-btn-BAbyws>.web-summary-panel-MGLdKa .content-2LzlnZ .card-fTcT7H .title-ZUz6x6{display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start}.sidebar-btn-BAbyws>.web-summary-panel-MGLdKa .content-2LzlnZ .card-fTcT7H .title-ZUz6x6 .icon-3onPpM{width:22px;height:22px}.sidebar-btn-BAbyws>.web-summary-panel-MGLdKa .content-2LzlnZ .card-fTcT7H .title-ZUz6x6 .text-RhWbvP{margin-left:5px;font-family:PingFangSC,PingFang SC;font-weight:600;font-size:14px;color:#2c2c2c;text-align:left}.sidebar-btn-BAbyws>.web-summary-panel-MGLdKa .content-2LzlnZ .card-fTcT7H .title-ZUz6x6 .copy-V1LR-9{margin-left:8px;width:11px;height:12px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.sidebar-btn-BAbyws>.web-summary-panel-MGLdKa .content-2LzlnZ .card-fTcT7H .title-ZUz6x6 .copy-V1LR-9:hover{opacity:.9}.sidebar-btn-BAbyws>.web-summary-panel-MGLdKa .content-2LzlnZ .card-fTcT7H .summary-text-17PGTB{margin-top:10px;font-family:PingFangSC,PingFang SC;font-weight:400;font-size:13px;color:#333;line-height:22px;text-align:left;font-style:normal;white-space:pre-wrap}.sidebar-btn-BAbyws>.web-summary-panel-MGLdKa .content-2LzlnZ .line-c0-FId{margin-top:14px;margin-bottom:16px;height:1px;background:#eeeeee}.sidebar-btn-BAbyws>.web-summary-panel-MGLdKa .collect-btn-fBBO1h{width:fit-content;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;display:flex;flex-direction:row;justify-content:center;align-items:center;gap:3px;padding:5px 16px;background:linear-gradient(343deg,#f0ecfc 0%,#f7f4ff 100%);box-shadow:0 2px 20px 2px #0000001a;border-radius:16px;border:1px solid #ffffff;position:absolute;right:10px;bottom:10px}.sidebar-btn-BAbyws>.web-summary-panel-MGLdKa .collect-btn-fBBO1h .star-nAvA87{width:16px;height:16px}.sidebar-btn-BAbyws>.web-summary-panel-MGLdKa .collect-btn-fBBO1h .text-RhWbvP{font-family:PingFangSC,PingFang SC;font-weight:400;font-size:13px;color:#773ad0;line-height:normal;text-align:left;font-style:normal}.sidebar-btn-BAbyws>.web-summary-panel-MGLdKa .refresh-btn-taHYia{width:24px;height:24px;background:#f7f9fa;border-radius:4px;display:flex;justify-content:center;align-items:center;flex-direction:column;position:absolute;right:12px;top:12px;z-index:1;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;opacity:.8}.sidebar-btn-BAbyws>.web-summary-panel-MGLdKa .refresh-btn-taHYia:hover{opacity:1}.sidebar-btn-BAbyws>.web-summary-panel-MGLdKa .refresh-btn-taHYia .icon-3onPpM{width:14px;height:15px}.sidebar-btn-BAbyws>.web-summary-panel-MGLdKa .loading-line-jSdAgM{-webkit-animation:blink-ubugTk 1s steps(5,start) infinite;animation:blink-ubugTk 1s steps(5,start) infinite;vertical-align:baseline;opacity:.6;position:relative;top:0}@keyframes blink-ubugTk{to{visibility:hidden}}.sidebar-btn-BAbyws .screenshot-guide-zZXgdd{width:386px;height:128px;position:fixed;top:0;right:44px;z-index:3}.sidebar-btn-BAbyws .screenshot-guide-zZXgdd .close-ywC13y{position:absolute;right:35px;top:10px;z-index:1;width:16px;height:16px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.sidebar-btn-BAbyws .screenshot-guide-zZXgdd .bg-a4tnVw{position:absolute;left:0;top:0;width:376px;height:128px}.sidebar-btn-BAbyws .screenshot-guide-zZXgdd .shadow-Y-WDpv{width:94%;height:100%;box-shadow:0 5px 32px 2px #0000001f;background:transparent;border-radius:23px}.sidebar-btn-BAbyws .screenshot-guide-zZXgdd .title-ZUz6x6{position:absolute;top:26px;left:75px;width:214px;height:22px;font-family:PingFangSC,PingFang SC;font-weight:600;font-size:16px;line-height:22px;text-align:left;font-style:normal}.sidebar-btn-BAbyws .screenshot-guide-zZXgdd .title-ZUz6x6 .span-ZPZB7O{color:#6165f7;font-weight:600}.sidebar-btn-BAbyws .screenshot-guide-zZXgdd .desc-jEkGYy{position:absolute;top:58px;left:26px;width:310px;height:40px;font-family:PingFangSC,PingFang SC;font-weight:400;font-size:14px;color:#555;line-height:20px;text-align:left;font-style:normal}.sidebar-btn-BAbyws .contact-panel-Wh-0s1{width:225px;height:244px;background:#fdfefd;box-shadow:0 5px 32px #00000029;border-radius:12px;border:1px solid #ffffff;position:absolute;right:68px;top:110px}.sidebar-btn-BAbyws .contact-panel-Wh-0s1 .title-ZUz6x6{margin:20px auto auto;display:flex;flex-direction:row;justify-content:center;align-items:center;gap:3px}.sidebar-btn-BAbyws .contact-panel-Wh-0s1 .title-ZUz6x6 .icon-3onPpM{width:20px;height:20px}.sidebar-btn-BAbyws .contact-panel-Wh-0s1 .title-ZUz6x6 .text-RhWbvP{font-family:PingFangSC,PingFang SC;font-weight:600;font-size:14px;color:#333;text-align:left;font-style:normal}.sidebar-btn-BAbyws .contact-panel-Wh-0s1 .qr-code-7meIX8{width:161px;height:161px;position:relative;margin:10px auto 0}.sidebar-btn-BAbyws .contact-panel-Wh-0s1 .qr-code-7meIX8 .qr-code-img-va9PbG{width:100%;height:100%}.sidebar-btn-BAbyws .contact-panel-Wh-0s1 .qr-code-7meIX8 .logo-B7vGN7{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:38px;height:38px}.enhanced-input-box-XwZHM-{position:fixed;border-radius:50%;position:relative}.enhanced-input-box-XwZHM- .shadow-entry-btn--aL0H5{position:absolute;width:20px;height:10px;background:transparent;right:0;top:50%;transform:translateY(-50%)}.enhanced-input-box-XwZHM- .entry-btn-knW0PP{width:6px;height:6px;background:#6165f7;border-radius:50%;position:relative;display:flex;flex-direction:row;justify-content:center;align-items:center}.enhanced-input-box-XwZHM- .entry-btn-knW0PP .icon-Q9JZgB{width:14px;height:14px;cursor:pointer}.enhanced-input-box-XwZHM- .entry-btn-knW0PP .divider-2XATDC{width:1px;height:12px;background:#e2e2e2;margin:0 4px}.enhanced-input-box-XwZHM- .entry-btn-knW0PP.active-jtPLEA{width:45px;height:20px;background:#f5f5ff;box-shadow:0 2px 8px 2px #3319511c;border-radius:10px;border:1px solid #ffffff}.enhanced-input-box-XwZHM- .entry-btn-knW0PP .line-Ak-up9{content:"";position:absolute;width:4px;height:18px;background:#ffffff;box-shadow:0 4px 20px #00000029;right:9px;top:18px}.enhanced-input-box-XwZHM- .upgrade-box-xBkMWV{position:absolute;top:28px;left:calc(50% + 20px);transform:translate(-50%);display:flex;align-items:center;justify-content:center;background:#ffffff;box-shadow:0 5px 32px 2px #0000001f;border:1px solid #efeff0;border-radius:20px}.enhanced-input-box-XwZHM- .upgrade-box-xBkMWV .triangle-s6ATox{position:absolute;top:-2px;right:50%;z-index:100;width:10px;height:10px;border-right:none;border-bottom:none;border-left:1px solid #efeff0;border-top:1px solid #efeff0;transform:rotate(45deg) translate(-50%);background:#ffffff}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW{position:absolute;width:325px;background:#ffffff;box-shadow:0 2px 16px #5d5d5d26;border-radius:18px;padding:24px 28px 18px;top:28px;right:-20px}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .switch-box-Wr5dEu{padding-bottom:16px;border-bottom:1px dashed #f2f2f2;margin-bottom:16px}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .switch-box-Wr5dEu .row-two-oVisxm{word-break:keep-all;position:relative}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .switch-box-Wr5dEu .row-two-oVisxm .desc-rX7uX7,.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .switch-box-Wr5dEu .row-two-oVisxm a{font-size:13px;font-family:PingFangSC,PingFang SC;font-weight:400;color:#999;line-height:18px;word-break:keep-all;white-space:nowrap}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .switch-box-Wr5dEu .row-two-oVisxm a{margin-left:4px;color:#6165f7;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .switch-box-Wr5dEu .row-two-oVisxm a:hover+.img-box-sSSSZc{display:block}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .switch-box-Wr5dEu .row-two-oVisxm .img-box-sSSSZc{width:526px;height:320px;background:#ffffff;box-shadow:0 4px 20px #8686861f;border-radius:12px;border:1px solid #ffffff;overflow:hidden;display:none;position:absolute;bottom:-324px;right:0}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .switch-box-Wr5dEu .row-two-oVisxm .img-box-sSSSZc img{width:100%;height:100%;object-fit:cover}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .switch-box-Wr5dEu .row-nyCgYK{display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;position:relative}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .switch-box-Wr5dEu .row-nyCgYK:first-child{margin-bottom:4px}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .switch-box-Wr5dEu .row-nyCgYK .switch-desc-B-J-O6{font-size:14px;font-weight:400;color:#666;line-height:20px;margin-left:4px}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .switch-box-Wr5dEu .row-nyCgYK .label-Tf6DRC{color:#333}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .header-HTK3h0{width:100%;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:space-between}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .header-HTK3h0 .left-SlHF3C{display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .header-HTK3h0 .left-SlHF3C .icon-Q9JZgB{width:16px;height:16px;object-fit:contain;margin-right:5px}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .header-HTK3h0 .left-SlHF3C .text-1n4hNh{font-weight:600;font-size:14px;color:#2c2c2c;line-height:20px;text-align:left}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .header-HTK3h0 .right-OJrRn9 .icon-Q9JZgB{width:16px;height:16px;cursor:pointer;object-fit:contain;position:absolute;top:14px;right:18px}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .language-Q2O0Kz{margin-top:12px;display:flex;flex-direction:row;justify-content:center;align-items:center;padding:0 16px;height:48px;background:#f7f9fa;border-radius:10px}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .language-item-ur9TOk{display:flex;align-items:center;justify-content:space-between;width:100%;gap:4px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .language-item-ur9TOk .name-y7kvJm{max-width:200px;font-size:14px;color:#1c1e22;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;word-break:break-all}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .language-item-ur9TOk .arrow-fvh08D{font-size:12px;color:#00000040}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .footer-eDeNDq{margin-top:16px;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:space-between}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .footer-eDeNDq .link-btn-nlmCZC{display:flex;flex-direction:row;justify-content:center;align-items:center;cursor:pointer;font-weight:400;font-size:12px;color:#666;line-height:17px;text-align:center}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .footer-eDeNDq .link-btn-nlmCZC .icon-Q9JZgB{width:13px;height:9px;margin-left:3px}.enhanced-input-box-XwZHM- .settings-panel-YjRlAW .footer-eDeNDq .link-btn-nlmCZC:hover{text-decoration:underline}.enhanced-input-box-XwZHM- .guide-box-IhDC8j{position:absolute;width:432px;height:151px;background:linear-gradient(180deg,#e6ebff 0%,#ffffff 100%);box-shadow:0 8px 56px #0000001a;border-radius:20px;border:2px solid #ffffff;right:-56px;top:34px;z-index:1}.enhanced-input-box-XwZHM- .guide-box-IhDC8j .guide-v1-O-SxL2{position:absolute;z-index:1;width:132px;height:89px;object-fit:contain;top:14px;right:9px}.enhanced-input-box-XwZHM- .guide-box-IhDC8j .guide-v2-K5g6og{position:absolute;z-index:1;width:24px;height:33px;object-fit:contain;top:9px;left:11px}.enhanced-input-box-XwZHM- .guide-box-IhDC8j .guide-v3-rc0D-R{position:absolute;z-index:1;width:16px;height:17px;object-fit:contain;top:24px;left:33px}.enhanced-input-box-XwZHM- .guide-box-IhDC8j .title-EozL7n{font-weight:600;font-size:15px;color:#242226;line-height:27px;text-align:left;font-style:normal;top:20px;left:56px;position:absolute}.enhanced-input-box-XwZHM- .guide-box-IhDC8j .desc-rX7uX7{font-weight:400;font-size:14px;color:#000000d9;line-height:20px;text-align:left;font-style:normal;position:absolute;top:51px;left:30px}.enhanced-input-box-XwZHM- .guide-box-IhDC8j .footer-eDeNDq{width:100%;top:95px;position:absolute;padding:0 32px;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:space-between}.enhanced-input-box-XwZHM- .guide-box-IhDC8j .footer-eDeNDq .btn-ykUZbi{width:90px;height:36px;line-height:36px;background:#6165f7;border-radius:8px;font-weight:400;font-size:14px;color:#fff;line-height:20px;cursor:pointer;user-select:none;display:flex;flex-direction:row;justify-content:center;align-items:center}.enhanced-input-box-XwZHM- .guide-box-IhDC8j .footer-eDeNDq .btn-ykUZbi:hover{background:#595DE3}.enhanced-input-box-XwZHM- .guide-box-IhDC8j .footer-eDeNDq .intro-9jUkRz{font-weight:400;font-size:13px;color:#999;line-height:18px;text-align:right;font-style:normal;user-select:none}.enhanced-input-box-XwZHM- .guide-box-IhDC8j .footer-eDeNDq .intro-9jUkRz span{text-decoration:underline;cursor:pointer}.image-translate-entry-nKfWZD{position:absolute;z-index:2147483646;display:flex;flex-direction:row;justify-content:center;align-items:center;left:0;top:0}.image-translate-entry-nKfWZD .wrap-Pki9LU{display:flex;flex-direction:row;justify-content:center;align-items:center;width:26px;height:26px}.image-translate-entry-nKfWZD .wrap-Pki9LU .spin-LU01D-{width:100%;height:100%;display:flex;flex-direction:row;justify-content:center;align-items:center}.image-translate-entry-nKfWZD .wrap-Pki9LU .image-btn-aZuBTg{width:100%;height:100%;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.upgrade-qr-box-N9BF7L{width:307px;height:353px;background:linear-gradient(180deg,#f3effa 0%,#ffffff 100%);box-shadow:0 5px 32px 2px #0000001f;border-radius:20px;border:1px solid #ffffff;position:absolute;right:0;top:0;display:flex;justify-content:center;align-items:center;flex-direction:column;justify-content:flex-start;padding-top:32px;z-index:2147483646}.upgrade-qr-box-N9BF7L .icon-UbcnYS{cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;width:16px;height:16px;position:absolute;right:14px;top:10px}.upgrade-qr-box-N9BF7L .title-4RiJKD{font-size:16px;font-weight:600;color:#2c2c2c;line-height:22px}.upgrade-qr-box-N9BF7L .sub-title--Ci4vg{font-size:13px;font-weight:400;color:#666;line-height:18px;margin-top:8px;white-space:nowrap}.upgrade-qr-box-N9BF7L .qr-code-McQKnO{width:182px;height:182px;object-fit:cover;margin-top:24px}.phonetics-bO5TBR{display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;opacity:.85;flex-wrap:wrap}.phonetics-bO5TBR .phonetic-T4XV9l{display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;word-break:break-all;font-size:13px}.phonetics-bO5TBR .phonetic-T4XV9l:first-child{margin-right:18px}.phonetics-bO5TBR .speak-icon-oDRAI5{cursor:pointer;width:16px;height:16px;margin-left:8px;object-fit:contain}.phonetics-bO5TBR .speak-icon-oDRAI5:hover{opacity:1}.phonetics-bO5TBR .speaking-IcXvdp{cursor:pointer;width:16px;height:16px}.search-popover-sQ4ZQh{padding:12px;display:flex;flex-direction:column;justify-content:flex-start;align-items:normal;width:280px;max-height:326px}.search-popover-sQ4ZQh .search-box-Bw6aGD{position:relative}.search-popover-sQ4ZQh .search-box-Bw6aGD .input-6KY2lI{width:100%;height:36px;background:#f7f9fa;border-radius:6px;border:1px solid #f2f2f2;padding:8px 12px;outline:none;font-weight:500;font-size:14px;color:#1c1e22;text-align:left;font-style:normal}.search-popover-sQ4ZQh .search-box-Bw6aGD .input-6KY2lI::placeholder{font-weight:400;font-size:14px;color:#999;text-align:left;font-style:normal}.search-popover-sQ4ZQh .search-box-Bw6aGD .icon-box-lDoDiO{width:16px;height:16px;position:absolute;right:12px;top:9px;display:flex;flex-direction:row;justify-content:center;align-items:center}.search-popover-sQ4ZQh .search-box-Bw6aGD .icon-box-lDoDiO img{width:100%}.search-popover-sQ4ZQh .search-box-Bw6aGD .icon-box-lDoDiO .close-icon-FlABT3{cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.search-popover-sQ4ZQh .content-list-eQ-Okq{flex:1;overflow-y:auto;overflow-y:auto!important;overscroll-behavior:contain;scrollbar-width:thin;scrollbar-color:#0000002f transparent;width:100%;position:relative}.search-popover-sQ4ZQh .content-list-eQ-Okq::-webkit-scrollbar{height:6px;width:6px;margin-right:10px}.search-popover-sQ4ZQh .content-list-eQ-Okq::-webkit-scrollbar-track{background:transparent}.search-popover-sQ4ZQh .content-list-eQ-Okq::-webkit-scrollbar-thumb{background:#0000002f;border-radius:4px;cursor:default}.search-popover-sQ4ZQh .content-list-eQ-Okq::-webkit-scrollbar-thumb:hover{background:#00000062}.search-popover-sQ4ZQh .content-list-eQ-Okq .content-item-nkrqvM{cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;padding:12px;color:#1c1e22}.search-popover-sQ4ZQh .content-list-eQ-Okq .content-item-nkrqvM.active-TT7mb9{color:#6165f7}.search-popover-sQ4ZQh .content-list-eQ-Okq .content-item-nkrqvM:hover{background:#f7f9fa;border-radius:8px}.search-popover-sQ4ZQh .content-list-eQ-Okq .content-item-nkrqvM .main-BojrQr{font-weight:500;font-size:14px;color:#1c1e22;text-align:left;line-height:20px;font-style:normal}.search-popover-sQ4ZQh .content-list-eQ-Okq .content-item-nkrqvM .secondary-y5Wijn{font-weight:400;font-size:12px;color:#666;text-align:left;line-height:20px;font-style:normal}.search-popover-sQ4ZQh .content-list-eQ-Okq .empty-box-OYhXb6{display:flex;justify-content:center;align-items:center;flex-direction:column;font-size:12px;color:#1c1e22;text-align:center;position:absolute;left:50%;top:36%;transform:translate(-50%,-50%)}.search-popover-sQ4ZQh .content-list-eQ-Okq .empty-box-OYhXb6 .empty-icon-4TQ312{width:138px}.search-popover-sQ4ZQh .content-list-eQ-Okq .empty-box-OYhXb6 .empty-text-ZS-1TO{margin-top:24px}.learning-content-u3s4ey{position:relative}.learning-content-u3s4ey .count-info-Y6HH5J{display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:space-between}.learning-content-u3s4ey .count-info-Y6HH5J .item-4RHRVh{padding-top:12px;padding-left:15px;padding-bottom:12px;position:relative;width:164px;height:67px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.learning-content-u3s4ey .count-info-Y6HH5J .item-4RHRVh .bg-InRawC{position:absolute;left:0;top:0;z-index:-1;width:100%;height:100%}.learning-content-u3s4ey .count-info-Y6HH5J .item-4RHRVh .content-ZIkYex{display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;gap:14px}.learning-content-u3s4ey .count-info-Y6HH5J .item-4RHRVh .content-ZIkYex .icon-IU2fwm{width:50px;height:44px}.learning-content-u3s4ey .count-info-Y6HH5J .item-4RHRVh .content-ZIkYex .text-ssVatR .num-MRjX1E{font-family:PingFangSC,PingFang SC;font-weight:600;font-size:17px;height:24px;color:#2c2c2c;line-height:24px;text-align:left;font-style:normal}.learning-content-u3s4ey .count-info-Y6HH5J .item-4RHRVh .content-ZIkYex .text-ssVatR .desc-on2kPt{font-family:PingFangSC,PingFang SC;font-weight:400;font-size:12px;color:#666;line-height:17px;text-align:left;font-style:normal}.learning-content-u3s4ey .status-mSValF{margin-top:19px;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;position:relative}.learning-content-u3s4ey .status-mSValF .pointer-lFPAA-{position:absolute;left:75px;top:9px;width:48px;height:48px;pointer-events:none}.learning-content-u3s4ey .status-mSValF .line-BG8fzE{position:relative;top:.5px;width:4px;height:12px;background:linear-gradient(315deg,#878efb 0%,#6d63ff 100%);border-radius:2px}.learning-content-u3s4ey .status-mSValF .label-ggmZFL{margin-left:4px;font-family:PingFangSC,PingFang SC;font-weight:600;font-size:14px;color:#333;line-height:normal;text-align:left;font-style:normal}.learning-content-u3s4ey .status-mSValF .switch-PCGh9u{width:23px;height:14px;min-width:23px;min-height:14px;line-height:14px}.learning-content-u3s4ey .status-mSValF .ant-switch-handle{width:10px;height:10px}.learning-content-u3s4ey .status-mSValF .ant-switch.ant-switch-small.ant-switch-checked .ant-switch-handle{inset-inline-start:calc(100% - 12px)!important}.learning-content-u3s4ey .status-mSValF .enable-2jn9ZV{margin-left:4px;font-family:PingFangSC,PingFang SC;font-weight:400;font-size:14px;color:#666;line-height:normal;text-align:left;font-style:normal}.learning-content-u3s4ey .tip-qZIg6E{margin-top:7px;font-family:PingFangSC,PingFang SC;font-weight:400;font-size:13px;color:#999;line-height:18px;text-align:left;font-style:normal}.learning-content-u3s4ey .manage-R0JkKI{margin-top:7px;height:102px;background:#f7f9fa;border-radius:10px;padding:0 12px;display:flex;justify-content:center;align-items:center;flex-direction:column;justify-content:space-evenly;align-items:flex-start}.learning-content-u3s4ey .manage-R0JkKI .split-tnboLQ{width:278px;margin:0 auto;height:1px;background-image:linear-gradient(to right,#eeeeee 0%,#eeeeee 50%,transparent 0%);background-size:14px 1px;background-repeat:repeat-x}.learning-content-u3s4ey .manage-R0JkKI .item-4RHRVh{width:100%;padding:14px 0;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.learning-content-u3s4ey .manage-R0JkKI .item-4RHRVh .icon-IU2fwm{width:18px;height:18px}.learning-content-u3s4ey .manage-R0JkKI .item-4RHRVh .label-ggmZFL{margin-left:7px;font-family:PingFangSC,PingFang SC;font-weight:400;font-size:13px;color:#666;line-height:18px;text-align:left;font-style:normal}.learning-content-u3s4ey .manage-R0JkKI .item-4RHRVh .result-9ewFHi{height:18px;font-family:PingFangSC,PingFang SC;font-weight:400;font-size:13px;color:#1c1e22;line-height:18px;text-align:left;font-style:normal}.learning-content-u3s4ey .manage-R0JkKI .item-4RHRVh .arrow-18Up-g{margin-left:auto;width:14px;height:14px}.learning-content-u3s4ey .words-count-JNms0H{margin-top:20px;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start}.learning-content-u3s4ey .words-count-JNms0H.pd-0e2Ndv{padding-top:12px;padding-bottom:12px}.learning-content-u3s4ey .words-count-JNms0H.sticky-5aTVk2{position:sticky;left:0;top:-20px;z-index:100;background:#fff}.learning-content-u3s4ey .words-count-JNms0H .line-BG8fzE{position:relative;top:1px;width:4px;height:12px;background:linear-gradient(315deg,#878efb 0%,#6d63ff 100%);border-radius:2px}.learning-content-u3s4ey .words-count-JNms0H .count-ncaiq-{margin-left:4px;font-family:PingFangSC,PingFang SC;font-weight:600;font-size:14px;color:#2c2c2c;text-align:left;font-style:normal;line-height:normal}.learning-content-u3s4ey .words-list-gT7z5-{margin-top:12px}.learning-content-u3s4ey .words-list-gT7z5- .empty-c9KMFs{margin-top:44px;display:flex;justify-content:center;align-items:center;flex-direction:column}.learning-content-u3s4ey .words-list-gT7z5- .empty-c9KMFs .icon-IU2fwm{width:128px}.learning-content-u3s4ey .words-list-gT7z5- .empty-c9KMFs .text-ssVatR{font-family:PingFangSC,PingFang SC;font-size:13px;color:#666;margin-top:24px}.learning-content-u3s4ey .words-list-gT7z5- .loading-MYpVlZ{display:flex;flex-direction:row;justify-content:center;align-items:center}.learning-content-u3s4ey .words-list-gT7z5- .word-item-dkdB9E{position:relative;width:100%;min-height:78px;background:linear-gradient(134deg,rgba(220,228,255,.25) 0%,rgba(239,243,253,.25) 100%);box-shadow:inset 0 -1px #d0d0d01a;border-radius:10px;padding:14px 0 15px 13px;margin-bottom:12px}.learning-content-u3s4ey .words-list-gT7z5- .word-item-dkdB9E:last-child{margin-bottom:0}.learning-content-u3s4ey .words-list-gT7z5- .word-item-dkdB9E .title-bcs3Jt{width:calc(100% - 51px);margin-bottom:6px;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start}.learning-content-u3s4ey .words-list-gT7z5- .word-item-dkdB9E .title-bcs3Jt .word-dSsJnn{font-family:PingFangSC,PingFang SC;font-weight:600;font-size:16px;color:#222;line-height:22px;text-align:left;font-style:normal}.learning-content-u3s4ey .words-list-gT7z5- .word-item-dkdB9E .phonetics-zlntdZ{width:calc(100% - 51px)}.learning-content-u3s4ey .words-list-gT7z5- .word-item-dkdB9E .translate-content-IhRvLW{width:calc(100% - 51px);font-size:14px;color:#444;line-height:20px}.learning-content-u3s4ey .words-list-gT7z5- .word-item-dkdB9E .icon-wrap-QgDtwB{position:absolute;right:0;top:0;width:51px;height:100%;background:linear-gradient(134deg,rgba(220,228,255,.25) 0%,rgba(239,243,253,.25) 100%);box-shadow:inset 0 -1px #d0d0d000;border-radius:10px;display:flex;justify-content:center;align-items:center;flex-direction:column;justify-content:space-evenly}.learning-content-u3s4ey .words-list-gT7z5- .word-item-dkdB9E .icon-wrap-QgDtwB .learn-MDrwvT,.learning-content-u3s4ey .words-list-gT7z5- .word-item-dkdB9E .icon-wrap-QgDtwB .collect-IUnpOB{width:28px;height:28px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.word-card-pLlStf{position:fixed;z-index:2147483640;width:317px;background:#ffffff;box-shadow:0 5px 32px 2px #0000001f;border-radius:16px;border:1px solid #efeff0;left:-99999999999px;top:-999999999999px}.word-card-pLlStf.word-card-with-upgrade-6BMPJd{display:flex;flex-direction:row;justify-content:center;align-items:center}.word-card-pLlStf .header-d3Jxq4{background:#f6f7ff;height:40px;display:flex;flex-direction:row;justify-content:center;align-items:center;padding-left:16px;padding-right:16px;justify-content:flex-start;border-top-left-radius:12px;border-top-right-radius:12px}.word-card-pLlStf .header-d3Jxq4 .left-adefYD{display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;gap:4px}.word-card-pLlStf .header-d3Jxq4 .left-adefYD .logo-7Bs7Sa{width:22px}.word-card-pLlStf .header-d3Jxq4 .left-adefYD .name-0Kx658{height:16px;font-family:AlimamaShuHeiTi,AlimamaShuHeiTi;font-weight:700;font-size:13px;color:#000000d9;line-height:18px;text-align:left;font-style:normal}.word-card-pLlStf .header-d3Jxq4 .right-zjmxHg{position:relative;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;gap:10px;margin-left:auto}.word-card-pLlStf .header-d3Jxq4 .right-zjmxHg .study-mY7BLi{width:26px;height:26px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.word-card-pLlStf .header-d3Jxq4 .right-zjmxHg .more-D4tlxc{width:16px;height:16px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.word-card-pLlStf .header-d3Jxq4 .right-zjmxHg .close-iLBqEm{width:14px;height:14px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.word-card-pLlStf .header-d3Jxq4 .right-zjmxHg .dropdown-KphxXa{background:#ffffff;box-shadow:0 2px 16px #5d5d5d26;border-radius:10px;padding:4px}.word-card-pLlStf .header-d3Jxq4 .right-zjmxHg .dropdown-KphxXa .item-RHvRqs{height:44px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;border-radius:8px;padding-left:12px}.word-card-pLlStf .header-d3Jxq4 .right-zjmxHg .dropdown-KphxXa .item-RHvRqs:hover{background:#f7f9fa;color:#6165f7}.word-card-pLlStf .header-d3Jxq4 .right-zjmxHg .ant-dropdown-menu-item{height:44px}.word-card-pLlStf .header-d3Jxq4 .right-zjmxHg .ant-dropdown-menu-item:hover{color:#6165f7}.word-card-pLlStf .content-Czh3eT{padding:14px 21px 20px;background:#fff;border-bottom-left-radius:12px;border-bottom-right-radius:12px}.word-card-pLlStf .content-Czh3eT .word-5xik7b{font-family:PingFangSC,PingFang SC;font-weight:600;font-size:16px;color:#222;line-height:22px;text-align:left;font-style:normal;margin-bottom:4px}.word-card-pLlStf .content-Czh3eT .translate-content-GrI4QK{font-size:14px;line-height:20px;color:#444}.learn-mode-panel-qFMgRS{position:fixed;right:73px;top:100px;width:378px;height:600px;background:#ffffff;box-shadow:0 5px 32px 2px #0000001f;border-radius:20px;border:1px solid #efeff0}.learn-mode-panel-qFMgRS .wrap-vqqCQr{overflow-y:auto!important;overscroll-behavior:contain;scrollbar-width:thin;scrollbar-color:#0000002f transparent;height:100%;padding:20px}.learn-mode-panel-qFMgRS .wrap-vqqCQr::-webkit-scrollbar{height:2px;width:2px;margin-right:10px}.learn-mode-panel-qFMgRS .wrap-vqqCQr::-webkit-scrollbar-track{background:transparent}.learn-mode-panel-qFMgRS .wrap-vqqCQr::-webkit-scrollbar-thumb{background:#0000002f;border-radius:4px;cursor:default}.learn-mode-panel-qFMgRS .wrap-vqqCQr::-webkit-scrollbar-thumb:hover{background:#00000062}.learn-mode-panel-qFMgRS .close-iLBqEm{position:absolute;right:6px;top:6px;width:16px;height:16px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.learn-mode-panel-qFMgRS .count-info-rJDyRl{display:flex;flex-direction:row;justify-content:center;align-items:center;gap:11px}.learn-mode-panel-qFMgRS .count-info-rJDyRl .item-RHvRqs{padding:10px;position:relative;width:151px;height:58px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.learn-mode-panel-qFMgRS .count-info-rJDyRl .item-RHvRqs .bg-veuBlz{position:absolute;left:0;top:0;z-index:-1;width:100%;height:100%}.learn-mode-panel-qFMgRS .count-info-rJDyRl .item-RHvRqs .content-Czh3eT{display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;gap:14px}.learn-mode-panel-qFMgRS .count-info-rJDyRl .item-RHvRqs .content-Czh3eT .icon-hKfI96{width:45px;height:39px}.learn-mode-panel-qFMgRS .count-info-rJDyRl .item-RHvRqs .content-Czh3eT .text-zdVnpo .num-BW8iFp{font-family:PingFangSC,PingFang SC;font-weight:600;font-size:17px;height:24px;color:#2c2c2c;line-height:24px;text-align:left;font-style:normal}.learn-mode-panel-qFMgRS .count-info-rJDyRl .item-RHvRqs .content-Czh3eT .text-zdVnpo .desc-MRoqEf{font-family:PingFangSC,PingFang SC;font-weight:400;font-size:12px;color:#666;line-height:17px;text-align:left;font-style:normal}.learn-mode-panel-qFMgRS .status-LLscTH{margin-top:24px;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;position:relative}.learn-mode-panel-qFMgRS .status-LLscTH .pointer-SIuJ3Y{position:absolute;left:75px;top:9px;width:48px;height:48px;pointer-events:none}.learn-mode-panel-qFMgRS .status-LLscTH .line-aiOX7T{position:relative;top:.5px;width:4px;height:12px;background:linear-gradient(180deg,#b369ea 0%,#832fff 100%)}.learn-mode-panel-qFMgRS .status-LLscTH .label-WFX3Sc{margin-left:4px;font-family:PingFangSC,PingFang SC;font-weight:600;font-size:14px;color:#333;line-height:normal;text-align:left;font-style:normal}.learn-mode-panel-qFMgRS .status-LLscTH .switch-C5dLBM{width:23px;height:14px;min-width:23px;min-height:14px;line-height:14px}.learn-mode-panel-qFMgRS .status-LLscTH .ant-switch-handle{width:10px;height:10px}.learn-mode-panel-qFMgRS .status-LLscTH .ant-switch.ant-switch-small.ant-switch-checked .ant-switch-handle{inset-inline-start:calc(100% - 12px)!important}.learn-mode-panel-qFMgRS .status-LLscTH .enable-VMW3-c{margin-left:4px;font-family:PingFangSC,PingFang SC;font-weight:400;font-size:14px;color:#666;line-height:normal;text-align:left;font-style:normal}.learn-mode-panel-qFMgRS .tip-E66PWX{margin-top:4px;font-family:PingFangSC,PingFang SC;font-weight:400;font-size:13px;color:#999;line-height:18px;text-align:left;font-style:normal}.learn-mode-panel-qFMgRS .manage-vCUW8w{margin-top:7px;width:314px;height:90px;background:#f7f9fa;border-radius:10px;padding:0 12px}.learn-mode-panel-qFMgRS .manage-vCUW8w .main-CRxURE{font-family:PingFangSC,PingFang SC;font-weight:400;font-size:14px;line-height:20px;text-align:left;font-style:normal}.learn-mode-panel-qFMgRS .manage-vCUW8w .split-RWAeMA{width:278px;margin:0 auto;height:1px;background-image:linear-gradient(to right,#eeeeee 0%,#eeeeee 50%,transparent 0%);background-size:14px 1px;background-repeat:repeat-x}.learn-mode-panel-qFMgRS .manage-vCUW8w .item-RHvRqs{padding:14px 0;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.learn-mode-panel-qFMgRS .manage-vCUW8w .item-RHvRqs .icon-hKfI96{width:18px;height:18px}.learn-mode-panel-qFMgRS .manage-vCUW8w .item-RHvRqs .label-WFX3Sc{margin-left:7px;font-family:PingFangSC,PingFang SC;font-weight:400;font-size:13px;color:#666;line-height:18px;text-align:left;font-style:normal}.learn-mode-panel-qFMgRS .manage-vCUW8w .item-RHvRqs .result-jiNDrH{height:18px;font-family:PingFangSC,PingFang SC;font-weight:400;font-size:13px;color:#1c1e22;line-height:18px;text-align:left;font-style:normal}.learn-mode-panel-qFMgRS .manage-vCUW8w .item-RHvRqs .arrow-yAzXHa{margin-left:auto;width:14px;height:14px}.learn-mode-panel-qFMgRS .words-count-o9IPxD{margin-top:24px;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start}.learn-mode-panel-qFMgRS .words-count-o9IPxD .line-aiOX7T{position:relative;top:0;width:4px;height:12px;background:linear-gradient(180deg,#b369ea 0%,#832fff 100%)}.learn-mode-panel-qFMgRS .words-count-o9IPxD .count-Rn1pWb{margin-left:4px;font-family:PingFangSC,PingFang SC;font-weight:600;font-size:14px;color:#2c2c2c;line-height:20px;text-align:left;font-style:normal}.learn-mode-panel-qFMgRS .words-list-jClOp3{margin-top:12px;height:263px;overflow-y:auto!important;overscroll-behavior:contain;scrollbar-width:thin;scrollbar-color:#0000002f transparent}.learn-mode-panel-qFMgRS .words-list-jClOp3::-webkit-scrollbar{height:3px;width:3px;margin-right:10px}.learn-mode-panel-qFMgRS .words-list-jClOp3::-webkit-scrollbar-track{background:transparent}.learn-mode-panel-qFMgRS .words-list-jClOp3::-webkit-scrollbar-thumb{background:#0000002f;border-radius:4px;cursor:default}.learn-mode-panel-qFMgRS .words-list-jClOp3::-webkit-scrollbar-thumb:hover{background:#00000062}.learn-mode-panel-qFMgRS .words-list-jClOp3 .empty-Vh6AJQ{margin-top:44px;display:flex;justify-content:center;align-items:center;flex-direction:column}.learn-mode-panel-qFMgRS .words-list-jClOp3 .empty-Vh6AJQ .icon-hKfI96{width:168px;height:119px}.learn-mode-panel-qFMgRS .words-list-jClOp3 .empty-Vh6AJQ .text-zdVnpo{font-family:PingFangSC,PingFang SC;font-size:14px;color:#666;margin-top:24px}.learn-mode-panel-qFMgRS .words-list-jClOp3 .word-item-tXs2UC{position:relative;width:100%;min-height:78px;background:linear-gradient(134deg,rgba(220,228,255,.25) 0%,rgba(239,243,253,.25) 100%);box-shadow:inset 0 -1px #d0d0d01a;border-radius:10px;padding:12px 0 12px 12px;margin-bottom:12px}.learn-mode-panel-qFMgRS .words-list-jClOp3 .word-item-tXs2UC:last-child{margin-bottom:0}.learn-mode-panel-qFMgRS .words-list-jClOp3 .word-item-tXs2UC .title-REUDs-{margin-bottom:12px;display:flex;flex-direction:row;justify-content:center;align-items:center;justify-content:flex-start}.learn-mode-panel-qFMgRS .words-list-jClOp3 .word-item-tXs2UC .title-REUDs- .word-5xik7b{font-family:PingFangSC,PingFang SC;font-weight:600;font-size:16px;color:#222;line-height:22px;text-align:left;font-style:normal}.learn-mode-panel-qFMgRS .words-list-jClOp3 .word-item-tXs2UC .title-REUDs- .sound-PFBjv5{margin-left:16px;width:14px;height:13px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.learn-mode-panel-qFMgRS .words-list-jClOp3 .word-item-tXs2UC .pos-xh8-MR{font-family:PingFangSC,PingFang SC;font-weight:400;font-size:14px;color:#444;line-height:20px;text-align:left;font-style:normal;padding-right:56px;margin-bottom:1px}.learn-mode-panel-qFMgRS .words-list-jClOp3 .word-item-tXs2UC .pos-xh8-MR:last-child{margin-bottom:0}.learn-mode-panel-qFMgRS .words-list-jClOp3 .word-item-tXs2UC .icon-wrap-5jUCtg{position:absolute;right:0;top:0;width:48px;height:100%;background:linear-gradient(134deg,rgba(220,228,255,.25) 0%,rgba(239,243,253,.25) 100%);box-shadow:inset 0 -1px #d0d0d000;border-radius:10px;display:flex;justify-content:center;align-items:center;flex-direction:column;justify-content:space-evenly}.learn-mode-panel-qFMgRS .words-list-jClOp3 .word-item-tXs2UC .icon-wrap-5jUCtg .learn-Dg9y7A,.learn-mode-panel-qFMgRS .words-list-jClOp3 .word-item-tXs2UC .icon-wrap-5jUCtg .collect-usKZ69{width:26px;height:26px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.learn-mode-tip-rsPrji{position:fixed;right:70px;top:200px;z-index:99999;width:518px;height:556px;background:linear-gradient(180deg,#f4ecff 0%,#f2e9ff 19%,#ffffff 100%);box-shadow:0 0 20px #cbcbcb;border-radius:28px;border:2px solid #ffffff;padding:50px 24px 32px}.learn-mode-tip-rsPrji .star-myvshb{position:absolute;left:6px;top:22px;width:37px;height:38px}.learn-mode-tip-rsPrji .bg-veuBlz{width:220px;height:115px;position:absolute;right:6px;top:0}.learn-mode-tip-rsPrji .underline-2H8YZ4{width:96px;height:6px;position:absolute;left:36px;top:80px}.learn-mode-tip-rsPrji .close-iLBqEm{width:16px;height:16px;position:absolute;right:20px;top:20px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.learn-mode-tip-rsPrji .title-REUDs-{font-family:PingFangSC,PingFang SC;font-weight:600;font-size:24px;color:#333;line-height:20px;text-align:left;font-style:normal;padding-left:11px}.learn-mode-tip-rsPrji .text-wrap-LHbysV{margin-top:37px;width:470px;height:362px;background:#ffffff;box-shadow:0 2px 4px #f4ebff;border-radius:16px;padding:16px;position:relative;z-index:1}.learn-mode-tip-rsPrji .text-wrap-LHbysV .bell-xieJfR{display:inline-block;width:15px;height:16px;position:relative;top:-2px;margin-right:6px}.learn-mode-tip-rsPrji .text-wrap-LHbysV .desc-MRoqEf{width:438px;padding:12px 20px;background:linear-gradient(136deg,#fefde0 0%,#fffeea 15%,#fefde0 100%);border-radius:8px;border:1px solid #fff7c6;font-family:PingFangSC,PingFang SC;font-weight:400;font-size:14px;color:#723d15;line-height:20px;text-align:left;font-style:normal}.learn-mode-tip-rsPrji .btn-UPlZuS{margin-top:24px;margin-left:auto;display:flex;flex-direction:row;justify-content:center;align-items:center;width:215px;height:40px;background:linear-gradient(157deg,#b369ea 0%,#832fff 100%);border-radius:12px;gap:11px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;opacity:1}.learn-mode-tip-rsPrji .btn-UPlZuS:hover{opacity:.9}.learn-mode-tip-rsPrji .btn-UPlZuS .text-zdVnpo{font-family:PingFangSC,PingFang SC;font-weight:600;font-size:15px;color:#fff;line-height:21px;text-align:right;font-style:normal}.learn-mode-tip-rsPrji .btn-UPlZuS .arrow-yAzXHa{width:14px;height:6px}.free-time-end-uRWTbr{position:fixed;right:70px;top:200px;z-index:99999;width:456px;height:219px;background:linear-gradient(180deg,#f4ecff 0%,#f2e9ff 19%,#ffffff 100%);box-shadow:0 0 20px #cbcbcb;border-radius:28px;border:2px solid #ffffff;padding:52px 20px 24px}.free-time-end-uRWTbr .star-myvshb{position:absolute;left:2px;top:12px;width:37px;height:38px}.free-time-end-uRWTbr .bg-veuBlz{width:188px;height:88px;position:absolute;right:39px;top:0}.free-time-end-uRWTbr .close-iLBqEm{width:16px;height:16px;position:absolute;right:20px;top:19px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.free-time-end-uRWTbr .title-REUDs-{font-family:PingFangSC,PingFang SC;font-weight:600;font-size:18px;color:#333;line-height:20px;text-align:left;font-style:normal}.free-time-end-uRWTbr .title-REUDs- .bell-xieJfR{width:17px;height:18px;display:inline-block;position:relative;top:-3px;margin-right:4px}.free-time-end-uRWTbr .desc-MRoqEf{margin-top:21px;font-family:PingFangSC,PingFang SC;font-weight:400;font-size:13px;color:#39393a;line-height:23px;text-align:left;font-style:normal}.free-time-end-uRWTbr .btn-UPlZuS{margin-top:18px;margin-left:auto;display:flex;flex-direction:row;justify-content:center;align-items:center;width:153px;height:40px;background:linear-gradient(157deg,#b369ea 0%,#832fff 100%);border-radius:12px;gap:11px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;opacity:1}.free-time-end-uRWTbr .btn-UPlZuS:hover{opacity:.9}.free-time-end-uRWTbr .btn-UPlZuS .text-zdVnpo{font-family:PingFangSC,PingFang SC;font-weight:600;font-size:15px;color:#fff;line-height:21px;text-align:right;font-style:normal}.free-time-end-uRWTbr .btn-UPlZuS .arrow-yAzXHa{width:14px;height:6px}*{box-sizing:border-box;font-weight:400;direction:ltr}ul,ol{list-style-type:none}img{vertical-align:middle;border-style:none}a{cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent;text-decoration:none;color:#6165f7;background-color:transparent}a:hover,a:active{color:#595de3}textarea{color:#333}b,strong{font-weight:bolder}div,dl,dt,dd,ul,ol,li,h1,h2,h3,h4,h5,h6,pre,code,form,fieldset,legend,input,textarea,p,blockquote,th,td,hr,button,article,aside,details,figcaption,figure,footer,header,hgroup,menu,nav,section{margin:0;padding:0}.ant-switch{background:#c9c9c9}.ant-switch:hover:not(.ant-switch-disabled){background:#8a8a8a}.content-root-WCIiJJ{font-size:14px;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,Noto Sans JP,Noto Sans KR,sans-serif,"Apple Color Emoji","Segoe UI Emoji";position:absolute;left:0;top:0;z-index:2147483646}.content-root-rb-FdpxmT{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,Noto Sans JP,Noto Sans KR,sans-serif,"Apple Color Emoji","Segoe UI Emoji";position:absolute;right:0;bottom:0;z-index:2147483646}.content-root-rt-f0WptO{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,Noto Sans JP,Noto Sans KR,sans-serif,"Apple Color Emoji","Segoe UI Emoji";position:absolute;right:0;top:0;z-index:2147483646}.bubble-activity-box-UGsRhH{position:fixed;z-index:2147483646;right:0;bottom:-30px}.bubble-activity-box-UGsRhH .bubble-activity-box-img-1tUR-4{width:368px;height:420px}.bubble-activity-box-UGsRhH .bubble-activity-box-close-j4sd7i{position:absolute;bottom:300px;right:33px;width:20px;height:20px;border-radius:20px;background:#F7F8FF;border:2px solid #D7D1FA;display:flex;justify-content:center;align-items:center;flex-direction:column;cursor:pointer}.bubble-activity-box-UGsRhH .bubble-activity-box-close-j4sd7i img{width:12px}.bubble-activity-box-UGsRhH .bubble-activity-box-btn-NltLEf{position:absolute;width:149px;height:34px;border-radius:17px;background:linear-gradient(177deg,#7B6EFC 0%,#5657F7 100%);border:2px solid #6560F9;color:#fefefe;font-weight:600;font-size:16px}.bubble-activity-box-UGsRhH .bubble-activity-box-btn-NltLEf:hover{background:linear-gradient(177deg,#7B6EFC 0%,#5657F7 100%)!important;border:2px solid #6560F9;color:#fefefe!important}.bubble-activity-box-UGsRhH .bubble-activity-box-btn-img-NbSbLL{position:absolute;height:34px;cursor:pointer}.bubble-activity-box-UGsRhH .bubble-activity-box-btn-img-NbSbLL img{height:100%}.bubble-activity-box-UGsRhH .bubble-activity-box-btn-img-NbSbLL:hover .bubble-activity-box-btn-img-hover-1E3JHP{display:block}.bubble-activity-box-UGsRhH .bubble-activity-box-btn-img-NbSbLL:hover .bubble-activity-box-btn-img-normal-bMv6h-,.bubble-activity-box-UGsRhH .bubble-activity-box-btn-img-NbSbLL .bubble-activity-box-btn-img-hover-1E3JHP{display:none}.sentence-card-QtgxI1{background:#ffffff;box-shadow:0 2px 20px #0000001a;border-radius:16px;display:block;color:#222;text-align:left;position:fixed;left:-9999999999px;top:-9999999999px;width:423px;z-index:2147483646}.sentence-card-QtgxI1 .sentence-content--anQKs{padding:16px 16px 16px 20px;overflow-y:auto!important;overscroll-behavior:contain;scrollbar-width:thin;scrollbar-color:#0000002f transparent}.sentence-card-QtgxI1 .sentence-content--anQKs::-webkit-scrollbar{height:6px;width:6px;margin-right:10px}.sentence-card-QtgxI1 .sentence-content--anQKs::-webkit-scrollbar-track{background:transparent}.sentence-card-QtgxI1 .sentence-content--anQKs::-webkit-scrollbar-thumb{background:#0000002f;border-radius:4px;cursor:default}.sentence-card-QtgxI1 .sentence-content--anQKs::-webkit-scrollbar-thumb:hover{background:#00000062}.sentence-card-QtgxI1 .sentence-content--anQKs.with-upgrade-box-VTSfyM{padding:0;display:flex;justify-content:center;align-items:center;flex-direction:column}.sentence-card-QtgxI1 .sentence-content--anQKs .originalText-wrap-6tkzt8{display:flex;flex-wrap:wrap}.sentence-card-QtgxI1 .sentence-content--anQKs .originalText-wrap-6tkzt8 .original-text-9IFyeq{font-size:14px;line-height:20px;border-bottom:1px solid #f4f4f4;padding-bottom:12px;flex:1}.sentence-card-QtgxI1 .sentence-content--anQKs .originalText-wrap-6tkzt8 .readText-3Jhi3p{margin-left:3px;margin-top:1px;width:16px;height:16px;cursor:pointer;opacity:.8}.sentence-card-QtgxI1 .sentence-content--anQKs .originalText-wrap-6tkzt8 .readText-3Jhi3p:hover{opacity:1}.sentence-card-QtgxI1 .sentence-content--anQKs .originalText-wrap-6tkzt8 .reading-Np0d1t{margin-left:3px;margin-top:1px;width:16px;height:16px;cursor:pointer;opacity:.8}.sentence-card-QtgxI1 .sentence-content--anQKs .translate-content-j-Pgon{font-size:14px;line-height:20px;padding-top:12px;color:#444}.card-header-6-r-ND{display:flex;align-items:center;height:40px;background:#f6f7ff;border-top-left-radius:16px;border-top-right-radius:16px;padding-left:20px;padding-right:10px}.card-header-6-r-ND .logo-2uwoxE{width:22px}.card-header-6-r-ND .language-YSAIlF{display:flex;align-items:center;justify-content:space-around;padding:0 5px;height:26px;margin-left:11px;background:rgba(255,255,255,.65);border-radius:6px;border:1px solid #ffffff}.card-header-6-r-ND .language-YSAIlF .language-item-xqNnxW{display:flex;align-items:center;justify-content:space-between;width:62px;gap:4px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.card-header-6-r-ND .language-YSAIlF .language-item-xqNnxW .name-90hUwN{max-width:70px;font-size:12px;color:#666;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;word-break:break-all}.card-header-6-r-ND .language-YSAIlF .language-item-xqNnxW .arrow-eru1Qb{font-size:10px;color:#00000040}.card-header-6-r-ND .language-YSAIlF .switch-icon-92sTW9{margin:0 10px;width:10px;height:10px}.card-header-6-r-ND .setting-wrap-vLpWZb{margin-left:auto;display:flex;align-items:center}.card-header-6-r-ND .setting-wrap-vLpWZb .tool-kq7eR5{display:flex;align-items:center;padding:5px 7px;background:rgba(255,255,255,.65);border-radius:13px;border:1px solid #ffffff;margin-right:12px;height:26px}.card-header-6-r-ND .setting-wrap-vLpWZb .tool-kq7eR5 .line--fjWWV{margin:0 8px;width:1px;height:11px;background:#e4e4e4}.card-header-6-r-ND .setting-wrap-vLpWZb .tool-kq7eR5 .icon-3Ar25g{width:16px;height:16px;cursor:pointer;user-select:none;-webkit-user-drag:none;-webkit-tap-highlight-color:transparent}.card-header-6-r-ND .setting-wrap-vLpWZb .close-aMqLZO{width:16px;height:16px;cursor:pointer;opacity:.8}.card-header-6-r-ND .setting-wrap-vLpWZb .close-aMqLZO:hover{opacity:1}.card-header-6-r-ND .card-select .rc-virtual-list-holder{overflow-y:auto!important;overscroll-behavior:contain;scrollbar-width:thin;scrollbar-color:#0000002f transparent}.card-header-6-r-ND .card-select .rc-virtual-list-holder::-webkit-scrollbar{height:6px;width:6px;margin-right:10px}.card-header-6-r-ND .card-select .rc-virtual-list-holder::-webkit-scrollbar-track{background:transparent}.card-header-6-r-ND .card-select .rc-virtual-list-holder::-webkit-scrollbar-thumb{background:#0000002f;border-radius:4px;cursor:default}.card-header-6-r-ND .card-select .rc-virtual-list-holder::-webkit-scrollbar-thumb:hover{background:#00000062}.card-header-6-r-ND .ant-select-selector{padding:0!important;height:28px!important}.card-header-6-r-ND .ant-select-arrow{inset-inline-end:0!important}.card-header-6-r-ND .ant-select-selection-item{font-size:12px!important;color:#666!important;padding-inline-end:10px!important;line-height:28px!important}.card-header-6-r-ND .ant-select-arrow{font-size:10px!important}.card-header-6-r-ND .ant-select-dropdown .ant-select-item{font-size:12px!important;color:#666}
</style><div><div><div class="content-root-WCIiJJ"><div class="sentence-card-QtgxI1" style="left: -1e+11px; top: -1e+11px; visibility: hidden; transition: none 0s ease 0s;"><div class="card-header-6-r-ND"><img class="logo-2uwoxE" src="chrome-extension://dkmejdpchbkcihdlengmhifgnigdjmba/static/lenovo/logo-transparent-with-blank.png"><div class="language-YSAIlF"><div class="language-item-xqNnxW"><p class="name-90hUwN" title=""></p><span role="img" aria-label="down" class="anticon anticon-down arrow-eru1Qb"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></span></div><img class="switch-icon-92sTW9" src="chrome-extension://dkmejdpchbkcihdlengmhifgnigdjmba/static/lenovo/switch-icon.png"><div class="language-item-xqNnxW"><p class="name-90hUwN" title=""></p><span role="img" aria-label="down" class="anticon anticon-down arrow-eru1Qb"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></span></div></div><div class="setting-wrap-vLpWZb"><div class="common-func-use-count-tips-itjNEY" style="margin-right: 12px;"><span class="text-yrxQRw">5</span><span class="btn-g4fGRt"></span></div><div class="tool-kq7eR5"><img class="icon-3Ar25g" src="chrome-extension://dkmejdpchbkcihdlengmhifgnigdjmba/static/lenovo/icon__settings-v1.png"></div><img class="close-aMqLZO" src="chrome-extension://dkmejdpchbkcihdlengmhifgnigdjmba/static/lenovo/card-close.png"></div></div><div class="sentence-content--anQKs" style="max-height: 815px; overflow-y: scroll;"><div class="originalText-wrap-6tkzt8"></div><div class="translate-content-j-Pgon"></div></div></div><div></div><div class="image-translate-entry-nKfWZD" style="left: -100000px; top: -100000px;"><div class="wrap-Pki9LU"><img class="image-btn-aZuBTg" src="chrome-extension://dkmejdpchbkcihdlengmhifgnigdjmba/static/lenovo/image-t.png"></div></div><div class="word-card-pLlStf" style="left: -1e+09px; top: -1e+09px;"><div class="header-d3Jxq4"><div class="left-adefYD"><img class="logo-7Bs7Sa" src="chrome-extension://dkmejdpchbkcihdlengmhifgnigdjmba/static/lenovo/logo-transparent-with-blank.png"><p class="name-0Kx658">AI</p></div><div class="right-zjmxHg"><img class="study-mY7BLi" src="chrome-extension://dkmejdpchbkcihdlengmhifgnigdjmba/static/lenovo/mode_learn.png"><img class="study-mY7BLi" src="chrome-extension://dkmejdpchbkcihdlengmhifgnigdjmba/static/lenovo/mode_book.png"><img class="ant-dropdown-trigger more-D4tlxc" src="chrome-extension://dkmejdpchbkcihdlengmhifgnigdjmba/static/lenovo/icon__more.png"><img class="more-D4tlxc" src="chrome-extension://dkmejdpchbkcihdlengmhifgnigdjmba/static/lenovo/card-close.png"><div class="ant-dropdown hy-card-dropdown css-1dmvnh0 css-var-r0 ant-dropdown-css-var ant-dropdown-placement-bottomLeft" style="--arrow-x: 0px; --arrow-y: 0px; inset: 0px auto auto 0px; pointer-events: none; display: none; box-sizing: border-box; width: 128px;"><div class="dropdown-KphxXa"><p class="item-RHvRqs"></p><p class="item-RHvRqs"></p><p class="item-RHvRqs"></p></div></div></div></div><div class="content-Czh3eT"><p class="word-5xik7b"></p><div class="translate-content-GrI4QK"><div class="text-zdVnpo"></div></div></div></div><div class="sidebar-btn-BAbyws hover-show-E9wsMI" style="top: 183px;"><div class="sidebar-content-HRClxM"><div class="entry-btn-dboHMJ"><img class="logo-B7vGN7" src="chrome-extension://dkmejdpchbkcihdlengmhifgnigdjmba/static/lenovo/logo.png"><img src="chrome-extension://dkmejdpchbkcihdlengmhifgnigdjmba/static/lenovo/icon__close-with-border.png" class="close-ywC13y"></div><div class="tool-list-5Wpfev"><div class="tool-item-23-jbD"><img class="icon-3onPpM" src="chrome-extension://dkmejdpchbkcihdlengmhifgnigdjmba/static/lenovo/icon__original.png"><img class="icon-3onPpM icon-hover-5mAT2F" src="chrome-extension://dkmejdpchbkcihdlengmhifgnigdjmba/static/lenovo/icon__original-hover.png"></div><div class="summary-setting-AczllN"><img class="icon-3onPpM" src="chrome-extension://dkmejdpchbkcihdlengmhifgnigdjmba/static/lenovo/sidebar/icon__screenshot.png"><img class="icon-3onPpM" src="chrome-extension://dkmejdpchbkcihdlengmhifgnigdjmba/static/lenovo/learn_mode_default.png"><img class="icon-3onPpM" src="chrome-extension://dkmejdpchbkcihdlengmhifgnigdjmba/static/lenovo/side_pdf.png"><img class="icon-3onPpM" src="chrome-extension://dkmejdpchbkcihdlengmhifgnigdjmba/static/lenovo/sidebar/icon__sidebar-setting.png"></div></div></div></div></div></div></div></template></div></html>